<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Audio实现音频文本同步</title>
      <link href="/2020/06/17/audio-shi-xian-yin-pin-wen-ben-tong-bu/"/>
      <url>/2020/06/17/audio-shi-xian-yin-pin-wen-ben-tong-bu/</url>
      
        <content type="html"><![CDATA[<p>最近公司项目接到一个需求，要实现录音播放时和文本同步，类似于音乐播放器播放歌曲时，歌词和声音同步的效果。要实现这个功能需要监听<code>audio</code>标签的实时播放时间，然后在监听事件中处理文本，通过当前时间定位到对应的文本数据，并展示在页面。</p><h2 id="原生实现"><a href="#原生实现" class="headerlink" title="原生实现"></a>原生实现</h2><p>使用原生的<code>audio</code>标签时，需要获取<code>audio</code>标签dom对象，并给它添加<code>timeupdate</code>事件，在事件中就可以实时处理文本了，代码步骤如下</p><pre><code>// audio标签&lt;audio src=&quot;test.mp3&quot; id=&quot;myAudio&quot; /&gt;// 1.获取 aduio 对象var audio = document.querySelector(&quot;#myAudio&quot;);// 2.注册事件audio.addEventListener(&quot;timeupdate&quot;,function(){    // 当前播放时间,单位秒    var nowTime = audio.currentTime;    // ...其他处理});</code></pre><p>在事件中获取当前时间，然后定位到文本数据，再把文本颜色设置为红色，这样就实现了一个简单的播放器音频和文本同步的效果，最终效果图如下</p><p><img src="/2020/06/17/audio-shi-xian-yin-pin-wen-ben-tong-bu/6.gif" alt></p><h2 id="React中实现"><a href="#React中实现" class="headerlink" title="React中实现"></a>React中实现</h2><p>上面所说的是原生实现，但目前主流的一般会使用React或者Vue，当然也可以在React或Vue组件中操作Dom，但这个不符合框架的设计思想。另外还有一个问题，歌词很长的情况下，播放到滚动条下面时，文本会被遮住，这就要求当播放到滚动条下面，歌词被遮住时，滚动条需要自动往下滚动。</p><h3 id="滚动条自动下滑"><a href="#滚动条自动下滑" class="headerlink" title="滚动条自动下滑"></a>滚动条自动下滑</h3><p>要实现滚动条自动下滑，有三个步骤</p><ol><li>获取当前文本标签的Dom对象，相对于父容器(有滚动条的容器)顶部的距离：<code>sTopHeight</code></li><li>获取父容器上方被滚动条遮住的高度：<code>zHeight</code></li><li>获取父容器的可视高度，这个高度一般设置是固定高度：<code>xHeight</code>。计算公式当 <code>sTopHeight &gt; zHeight + xHeight</code> 为真时，说明文本已经超出可视高度，被遮住了，这时就需要向下滑动滚动条了</li></ol><p>以下是实现代码，这时React中直接操作Dom方式的实现</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      txtList<span class="token punctuation">:</span><span class="token punctuation">[</span>        <span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:24"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"月色烙印在城墙"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:26"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"风声呼啸过苍莽"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:29"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"有双眸如炬般明亮"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">35</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:35"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"将生死握于手掌"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">38</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:38"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"待尘沙磨砺翅膀"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:41"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"褪变出崭新模样"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:46"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"那团火在何处绽放"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:49"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"开始侵袭六腑五脏"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">51</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:51"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"却使我全身的血脉都膨胀"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:57"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"有太多的相识背叛"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:00"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"不必谁原谅"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">63</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:03"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"只恨这英雄年少不轻狂"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">68</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"00:26"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"我乘风而下"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:10"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"要在破晓处羽化"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">73</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:13"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"要让满座的喧哗 屏息惊诧"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:20"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"凭誓约回答"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">82</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:26"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"两人的命运交叉"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:25"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"跃再多悬壁陡崖"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>          start<span class="token punctuation">:</span><span class="token number">93</span><span class="token punctuation">,</span>          time<span class="token punctuation">:</span><span class="token string">"01:33"</span><span class="token punctuation">,</span>          txt<span class="token punctuation">:</span><span class="token string">"我不怕"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">const</span> audio <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".myAudio>audio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>txtList<span class="token punctuation">;</span>    <span class="token keyword">const</span> txtContain <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#txtContain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    audio<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"timeupdate"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>list<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">let</span> item <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        item<span class="token punctuation">.</span>chose<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>list<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">let</span> item <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>start <span class="token operator">===</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>audio<span class="token punctuation">.</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          item<span class="token punctuation">.</span>chose<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">;</span>          <span class="token keyword">let</span> txtDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#txtContain > #txt'</span><span class="token operator">+</span>item<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//可见窗体高度的一半(歌词正好在中间)+被覆盖的高度</span>          <span class="token keyword">let</span> zHeight<span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token operator">+</span>txtContain<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 如果相对父容器偏移量大于(可见窗体高度+被覆盖的高度)，则滚动条下移100px</span>          <span class="token keyword">if</span><span class="token punctuation">(</span>txtDiv<span class="token punctuation">.</span>offsetTop<span class="token operator">></span>zHeight<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//this.myScrollTop(txtContain,22,220);</span>            txtContain<span class="token punctuation">.</span>scrollTop<span class="token operator">=</span>txtContain<span class="token punctuation">.</span>scrollTop<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>txtList<span class="token punctuation">:</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> txtContains <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#txtContains'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>txtContains<span class="token punctuation">:</span>txtContains<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> choseStyle<span class="token operator">=</span><span class="token punctuation">{</span>      color<span class="token punctuation">:</span><span class="token string">'red'</span><span class="token punctuation">,</span>      height<span class="token punctuation">:</span><span class="token string">'22px'</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> noStyle<span class="token operator">=</span><span class="token punctuation">{</span>      color<span class="token punctuation">:</span><span class="token string">'black'</span><span class="token punctuation">,</span>      height<span class="token punctuation">:</span><span class="token string">'22px'</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>PageHeaderWrapper<span class="token operator">></span>        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginTop<span class="token punctuation">:</span><span class="token string">'30px'</span><span class="token punctuation">,</span>width<span class="token punctuation">:</span><span class="token string">'600px'</span><span class="token punctuation">,</span>display<span class="token punctuation">:</span><span class="token string">'inline-block'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"site-card-border-less-wrapper"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>Card title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>fieldId<span class="token punctuation">}</span> bordered<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> width<span class="token punctuation">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>              <span class="token operator">&lt;</span>div<span class="token operator">></span> <span class="token operator">&lt;</span>AudioPlayer src<span class="token operator">=</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"myAudio"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>Card<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>Card size<span class="token operator">=</span><span class="token string">"small"</span> title<span class="token operator">=</span><span class="token string">"歌词"</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>width<span class="token punctuation">:</span><span class="token string">'500px'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>height<span class="token punctuation">:</span><span class="token string">'250px'</span><span class="token punctuation">,</span>overflow<span class="token punctuation">:</span><span class="token string">'auto'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> id<span class="token operator">=</span><span class="token string">"txtContain"</span><span class="token operator">></span>              <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>txtList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>start<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>chose <span class="token operator">===</span> <span class="token string">'Y'</span> <span class="token operator">?</span> choseStyle<span class="token punctuation">:</span>noStyle<span class="token punctuation">}</span>                     id<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'txt'</span><span class="token operator">+</span>item<span class="token punctuation">.</span>start<span class="token punctuation">}</span><span class="token operator">></span>                    <span class="token punctuation">[</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>time<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>txt<span class="token punctuation">}</span>                  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token punctuation">)</span><span class="token punctuation">}</span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>Card<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>PageHeaderWrapper<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><p>最终效果如下</p><p><img src="/2020/06/17/audio-shi-xian-yin-pin-wen-ben-tong-bu/7.gif" alt></p><h3 id="效果美化"><a href="#效果美化" class="headerlink" title="效果美化"></a>效果美化</h3><p>在React中直接操作Dom虽然可以实现效果，但看起来都不怎么优雅。由于我使用了React的组件<code>react-h5-audio-player</code>，这个组件提供了timeupdate事件，所以优化以下代码，顺便把效果美化以下，播放行时加粗文本字体和行的阴影效果，哈哈。</p><pre class=" language-javascript"><code class="language-javascript"></code></pre><p>最终效果如下</p><p><img src="/2020/06/17/audio-shi-xian-yin-pin-wen-ben-tong-bu/8.gif" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在开发过程中遇到的问题，当我通过元素的<code>offsetTop</code>属性获取元素相对于父容器的距离时，会出现距离不符合预期的情况，这实际上是<code>offsetTop</code>定位机制的问题，与它类似的属性还有<code>offsetLeft</code>，需要注意的是<code>offsetTop</code>和<code>offsetLeft</code>定位机制是相对于最近的祖先定位元素（即父元素的 position 属性被设置为 <code>relative</code>、<code>absolute</code>或 <code>fixed</code>的元素）的向上或向左偏移值。如果父元素的 position 属性非 <code>relative</code>、<code>absolute</code>或 <code>fixed</code>，则都是相对于body定位。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> H5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React中使用Dva</title>
      <link href="/2020/06/14/react-zhong-shi-yong-dva/"/>
      <url>/2020/06/14/react-zhong-shi-yong-dva/</url>
      
        <content type="html"><![CDATA[<p>在公司使用Antd时接触到了dva，它是由阿里架构师 sorrycc 带领 team 完成的一套前端框架，在作者的 github 里是这么描述它的：“dva 是 react 和 redux 的最佳实践”。dva 是一个基于 <a href="https://github.com/reduxjs/redux" target="_blank" rel="noopener">redux</a> 和 <a href="https://github.com/redux-saga/redux-saga" target="_blank" rel="noopener">redux-saga</a> 的数据流方案，然后为了简化开发体验，dva 还额外内置了 <a href="https://github.com/ReactTraining/react-router" target="_blank" rel="noopener">react-router</a> 和 <a href="https://github.com/github/fetch" target="_blank" rel="noopener">fetch</a>，所以也可以理解为一个轻量级的应用框架。简单的说 dva 是基于现有应用架构 (redux + react-router + redux-saga 等)的一层轻量封装。dva 是 react 和 redux 的最佳实践。最核心的是提供了 app.model 方法，用于把 reducer, initialState, action, saga 封装到一起。<strong>Dva = React-Router + Redux + Redux-saga</strong>。<a href="https://dvajs.com/guide/concepts.html#%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91" target="_blank" rel="noopener">Dva官网地址</a></p><h2 id="Dva快速上手"><a href="#Dva快速上手" class="headerlink" title="Dva快速上手"></a>Dva快速上手</h2><p>dva的安装和启动只需四个步骤，整合antd<a href="https://dvajs.com/guide/getting-started.html#connect-%E8%B5%B7%E6%9D%A5" target="_blank" rel="noopener">地址</a></p><pre class=" language-bash"><code class="language-bash">// 1.安装dva-cli<span class="token function">npm</span> <span class="token function">install</span> dva-cli -g// 2.创建项目：dva-test项目名dva new dva-test// 3.进入dva-test目录<span class="token function">cd</span> dva-quickstart// 4.启动项目<span class="token function">npm</span> start</code></pre><p>启动成功后访问 <a href="http://localhost:8000/，" target="_blank" rel="noopener">http://localhost:8000/，</a> 会出现如下界面</p><p><img src="/2020/06/14/react-zhong-shi-yong-dva/2.png" alt></p><p>react项目的推荐目录结构，如果使用dva脚手架创建，则自动生成如下</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">|</span>── /mock/             <span class="token comment" spellcheck="true"># 数据mock的接口文件  </span><span class="token operator">|</span>── /src/              <span class="token comment" spellcheck="true"># 项目源码目录（我们开发的主要工作区域）   </span><span class="token operator">|</span>   <span class="token operator">|</span>── /components/   <span class="token comment" spellcheck="true"># 项目组件（用于路由组件内引用的可复用组件）   </span><span class="token operator">|</span>   <span class="token operator">|</span>── /routes/       <span class="token comment" spellcheck="true"># 路由组件（页面维度） </span><span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>── route1.js  <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>── route2.js   <span class="token comment" spellcheck="true"># 根据router.js中的映射，在不同的url下，挂载不同的路由组件</span><span class="token operator">|</span>   <span class="token operator">|</span>  └── route3.js    <span class="token operator">|</span>   <span class="token operator">|</span>── /models/       <span class="token comment" spellcheck="true"># 数据模型（可以理解为store，用于存储数据与方法）  </span><span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>── model1.js  <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>── model2.js   <span class="token comment" spellcheck="true"># 选择分离为多个model模型，是根据业务实体进行划分</span><span class="token operator">|</span>   <span class="token operator">|</span>  └── model3.js  <span class="token operator">|</span>   <span class="token operator">|</span>── /services/     <span class="token comment" spellcheck="true"># 数据接口（处理前台页面的ajax请求，转发到后台）   </span><span class="token operator">|</span>   <span class="token operator">|</span>── /utils/        <span class="token comment" spellcheck="true"># 工具函数（工具库，存储通用函数与配置参数）     </span><span class="token operator">|</span>   <span class="token operator">|</span>── router.js       <span class="token comment" spellcheck="true"># 路由配置（定义路由与对应的路由组件）  </span><span class="token operator">|</span>   <span class="token operator">|</span>── index.js       <span class="token comment" spellcheck="true"># 入口文件  </span><span class="token operator">|</span>   <span class="token operator">|</span>── index.less      <span class="token operator">|</span>   └── index.html     <span class="token operator">|</span>── package.json       <span class="token comment" spellcheck="true"># 项目信息  </span>└── proxy.config.js    <span class="token comment" spellcheck="true"># 数据mock配置  </span></code></pre><h2 id="Dva-概念"><a href="#Dva-概念" class="headerlink" title="Dva 概念"></a>Dva 概念</h2><h3 id="数据流向"><a href="#数据流向" class="headerlink" title="数据流向"></a>数据流向</h3><p>数据的改变发生通常是通过用户交互行为或者浏览器行为（如路由跳转等）触发的，当此类行为会改变数据的时候可以通过 <code>dispatch</code> 发起一个 action，如果是同步行为会直接通过 <code>Reducers</code> 改变 <code>State</code> ，如果是异步行为（副作用）会先触发 <code>Effects</code> 然后流向 <code>Reducers</code> 最终改变 <code>State</code>，所以在 dva 中，数据流向非常清晰简明，并且思路基本跟开源社区保持一致（也是来自于开源社区）。</p><p><img src="/2020/06/14/react-zhong-shi-yong-dva/1.png" alt></p><p>从图中可以看出dva是设计理念是把数据层和组件层剥离开来，实现完全解耦</p><h2 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h2><h3 id="State"><a href="#State" class="headerlink" title="State"></a>State</h3><p>State 表示 Model 的状态数据，通常表现为一个 javascript 对象（当然它可以是任何值）；操作的时候每次都要当作不可变数据（immutable data）来对待，保证每次都是全新对象，没有引用关系，这样才能保证 State 的独立性，便于测试和追踪变化。在 dva 中你可以通过 dva 的实例属性 <code>_store</code> 看到顶部的 state 数据，但是通常你很少会用到:</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">dva</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_store<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 顶部的 state 数据</span></code></pre><h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>Action 是一个普通 javascript 对象，它是改变 State 的唯一途径。无论是从 UI 事件、网络回调，还是 WebSocket 等数据源所获得的数据，最终都会通过 dispatch 函数调用一个 action，从而改变对应的数据。action 必须带有 <code>type</code> 属性指明具体的行为，其它字段可以自定义，如果要发起一个 action 需要使用 <code>dispatch</code> 函数；需要注意的是 <code>dispatch</code> 是在组件 connect Models以后，通过 props 传入的。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  type<span class="token punctuation">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="dispatch-函数"><a href="#dispatch-函数" class="headerlink" title="dispatch 函数"></a>dispatch 函数</h3><p>dispatching function 是一个用于触发 action 的函数，action 是改变 State 的唯一途径，但是它只描述了一个行为，而 dipatch 可以看作是触发这个行为的方式，而 Reducer 则是描述如何改变数据的。在 dva 中，connect Model 的组件通过 props 可以访问到 dispatch，可以调用 Model 中的 Reducer 或者 Effects，常见的形式如：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  type<span class="token punctuation">:</span> <span class="token string">'user/add'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 如果在 model 外调用，需要添加 namespace</span>  payload<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 需要传递的信息</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h3><p>Reducer（也称为 reducing function）函数接受两个参数：之前已经累积运算的结果和当前要被累积的值，返回的是一个新的累积结果。该函数把一个集合归并成一个单值。Reducer 的概念来自于是函数式编程，很多语言中都有 reduce API。如在 javascript 中：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token punctuation">{</span>x<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>y<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>z<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//return {x:1, y:2, z:3}</span></code></pre><p>在 dva 中，reducers 聚合积累的结果是当前 model 的 state 对象。通过 actions 中传入的值，与当前 reducers 中的值进行运算获得新的值（也就是新的 state）。需要注意的是 Reducer 必须是<a href="https://github.com/MostlyAdequate/mostly-adequate-guide/blob/master/ch3.md" target="_blank" rel="noopener">纯函数</a>，所以同样的输入必然得到同样的输出，它们不应该产生任何副作用。并且，每一次的计算都应该使用<a href="https://github.com/MostlyAdequate/mostly-adequate-guide/blob/master/ch3.md#reasonable" target="_blank" rel="noopener">immutable data</a>，这种特性简单理解就是每次操作都是返回一个全新的数据（独立，纯净），所以热重载和时间旅行这些功能才能够使用。</p><h3 id="Effect"><a href="#Effect" class="headerlink" title="#Effect"></a><a href="https://dvajs.com/guide/concepts.html#effect" target="_blank" rel="noopener">#</a>Effect</h3><h3 id="Effect-1"><a href="#Effect-1" class="headerlink" title="Effect"></a>Effect</h3><p>Effect 被称为副作用，在我们的应用中，最常见的就是异步操作。它来自于函数编程的概念，之所以叫副作用是因为它使得我们的函数变得不纯，同样的输入不一定获得同样的输出。</p><p>dva 为了控制副作用的操作，底层引入了<a href="http://superraytin.github.io/redux-saga-in-chinese" target="_blank" rel="noopener">redux-sagas</a>做异步流程控制，由于采用了<a href="http://www.ruanyifeng.com/blog/2015/04/generator.html" target="_blank" rel="noopener">generator的相关概念</a>，所以将异步转成同步写法，从而将effects转为纯函数。至于为什么我们这么纠结于 <strong>纯函数</strong>，如果你想了解更多可以阅读<a href="https://github.com/MostlyAdequate/mostly-adequate-guide" target="_blank" rel="noopener">Mostly adequate guide to FP</a>，或者它的中文译本<a href="https://www.gitbook.com/book/llh911001/mostly-adequate-guide-chinese/details" target="_blank" rel="noopener">JS函数式编程指南</a>。</p><h2 id="简单使用例子"><a href="#简单使用例子" class="headerlink" title="简单使用例子"></a>简单使用例子</h2><h3 id="构建service"><a href="#构建service" class="headerlink" title="构建service"></a>构建service</h3><p>新增文件 <code>src/services/users.js</code>，内容如下，这里写了用户的api接口列表，即用户增删改查</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'../utils/request'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//查询</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> page <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/users?_page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;_limit=$5`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//删除</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    method<span class="token punctuation">:</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//修改</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    method<span class="token punctuation">:</span> <span class="token string">'PATCH'</span><span class="token punctuation">,</span>    body<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span>    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>      <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//新增</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'/api/users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>       method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        body<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><h3 id="构建model"><a href="#构建model" class="headerlink" title="构建model"></a>构建model</h3><p>可在终端通过命令 <code>dva g model users</code>生成文件，然后修改 <code>src/models/users.js</code></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> usersService <span class="token keyword">from</span> <span class="token string">'../services/users'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  namespace<span class="token punctuation">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>    list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    total<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// state中的状态修改只能在reducers中</span>  reducers<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">save</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload<span class="token punctuation">:</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> list<span class="token punctuation">,</span> total <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> list<span class="token punctuation">,</span> total <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 副作用域，一般与后端的交互都放在effects中，每个方法前面带 * 号</span>  <span class="token comment" spellcheck="true">// 副作用是与函数式编程对应的概念，函数式编程中纯函数没有副作用，而涉及到后端交互的肯定有副作用</span>  effects<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token operator">*</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload<span class="token punctuation">:</span> <span class="token punctuation">{</span> page <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> call<span class="token punctuation">,</span> put <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> headers <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>usersService<span class="token punctuation">.</span>fetch<span class="token punctuation">,</span> <span class="token punctuation">{</span> page <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'save'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> total<span class="token punctuation">:</span> headers<span class="token punctuation">[</span><span class="token string">'x-total-count'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  subscriptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> history <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname <span class="token operator">===</span> <span class="token string">'/users'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="构建components"><a href="#构建components" class="headerlink" title="构建components"></a>构建components</h3><p>修改 src/components/Users/Users.js</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dva'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Table<span class="token punctuation">,</span> Pagination<span class="token punctuation">,</span> Popconfirm<span class="token punctuation">,</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> routerRedux <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dva/router'</span><span class="token punctuation">;</span><span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">'./Users.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> UserModal <span class="token keyword">from</span> <span class="token string">'./UserModal'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Users</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> list<span class="token punctuation">:</span> dataSource<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> total<span class="token punctuation">,</span> page<span class="token punctuation">:</span> current <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//删除</span>  <span class="token keyword">function</span> <span class="token function">deleteHandler</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      type<span class="token punctuation">:</span> <span class="token string">'users/remove'</span><span class="token punctuation">,</span>      payload<span class="token punctuation">:</span> id<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//修改</span>  <span class="token keyword">function</span> <span class="token function">editHandler</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            type<span class="token punctuation">:</span> <span class="token string">'users/patch'</span><span class="token punctuation">,</span>            payload<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> values <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//分页</span>  <span class="token keyword">function</span> <span class="token function">pageChangeHandler</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">dispatch</span><span class="token punctuation">(</span>routerRedux<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    pathname<span class="token punctuation">:</span> <span class="token string">'/users'</span><span class="token punctuation">,</span>    query<span class="token punctuation">:</span> <span class="token punctuation">{</span> page <span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//新增</span>  <span class="token keyword">function</span> <span class="token function">createHandler</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            type<span class="token punctuation">:</span> <span class="token string">'users/create'</span><span class="token punctuation">,</span>            payload<span class="token punctuation">:</span> values<span class="token punctuation">,</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token keyword">const</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      title<span class="token punctuation">:</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span>      dataIndex<span class="token punctuation">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>      key<span class="token punctuation">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>      render<span class="token punctuation">:</span> text <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token punctuation">{</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      title<span class="token punctuation">:</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>      dataIndex<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>      key<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      title<span class="token punctuation">:</span> <span class="token string">'地址'</span><span class="token punctuation">,</span>      dataIndex<span class="token punctuation">:</span> <span class="token string">'website'</span><span class="token punctuation">,</span>      key<span class="token punctuation">:</span> <span class="token string">'website'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      title<span class="token punctuation">:</span> <span class="token string">'操作'</span><span class="token punctuation">,</span>      key<span class="token punctuation">:</span> <span class="token string">'operation'</span><span class="token punctuation">,</span>      render<span class="token punctuation">:</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> record<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>operation<span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>UserModal record<span class="token operator">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span> onOk<span class="token operator">=</span><span class="token punctuation">{</span>editHandler<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>a<span class="token operator">></span>修改<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>              <span class="token operator">&lt;</span><span class="token operator">/</span>UserModal<span class="token operator">></span>            <span class="token operator">&lt;</span>Popconfirm title<span class="token operator">=</span><span class="token string">"Confirm to delete?"</span> onConfirm<span class="token operator">=</span><span class="token punctuation">{</span>deleteHandler<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span>删除<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>Popconfirm<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>      <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>normal<span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>create<span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>UserModal record<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> onOk<span class="token operator">=</span><span class="token punctuation">{</span>createHandler<span class="token punctuation">}</span><span class="token operator">></span>                <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">"primary"</span><span class="token operator">></span>增加用户<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>UserModal<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>Table          columns<span class="token operator">=</span><span class="token punctuation">{</span>columns<span class="token punctuation">}</span>          dataSource<span class="token operator">=</span><span class="token punctuation">{</span>dataSource<span class="token punctuation">}</span>          loading<span class="token operator">=</span><span class="token punctuation">{</span>loading<span class="token punctuation">}</span>          rowKey<span class="token operator">=</span><span class="token punctuation">{</span>record <span class="token operator">=</span><span class="token operator">></span> record<span class="token punctuation">.</span>id<span class="token punctuation">}</span>          pagination<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>        <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>Pagination          className<span class="token operator">=</span><span class="token string">"ant-table-pagination"</span>          total<span class="token operator">=</span><span class="token punctuation">{</span>total<span class="token punctuation">}</span>          current<span class="token operator">=</span><span class="token punctuation">{</span>current<span class="token punctuation">}</span>          pageSize<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span>          onChange<span class="token operator">=</span><span class="token punctuation">{</span>pageChangeHandler<span class="token punctuation">}</span>        <span class="token operator">/</span><span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">mapStateToProps</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> list<span class="token punctuation">,</span> total<span class="token punctuation">,</span> page <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>users<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    loading<span class="token punctuation">:</span> state<span class="token punctuation">.</span>loading<span class="token punctuation">.</span>models<span class="token punctuation">.</span>users<span class="token punctuation">,</span>    list<span class="token punctuation">,</span>    total<span class="token punctuation">,</span>    page<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">)</span><span class="token punctuation">(</span>Users<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReactNative对比Cordova</title>
      <link href="/2020/06/13/reactnative-dui-bi-cordova/"/>
      <url>/2020/06/13/reactnative-dui-bi-cordova/</url>
      
        <content type="html"><![CDATA[<p>事实上对于移动端，支持HTML，JS和Css的框架并不只有ReactNative，还有诸如Cordova，Fultter等。Cordova 是 Apache 旗下的。 React-Native 是 Facebook 旗下的在2013年发布的一个前端框架，两者皆开源。Cordova的基础是html和js运行在webview容器里面，通过Cordova提供的接口与硬件通讯；所以它的效率天生收到限制，而且也受到了各个厂商对webkit内核的好坏；比如之前基于国产某Cloud的程序,在华为手机上显示就不正常,花费了不少精力修改；RN的效率由于是将View编译成了原生View，所以效率上要比基于Cordova的HTML5高很多，但是它也有效率问题，RN的渲染机制是基于前端框架的考虑,复杂的UI渲染是需要依赖多个view叠加</p><table><thead><tr><th></th><th>React Native</th><th>Cordova</th></tr></thead><tbody><tr><td><strong>跨平台特性</strong></td><td>一次学习，随处开发</td><td>一次开发，随处运行</td></tr><tr><td><strong>功能支持</strong></td><td>完全支持。 Android 端不是很完善</td><td>基本功能完全具备，对于底层，如摄像头之类的，需要插件</td></tr><tr><td><strong>运行速度</strong></td><td>跟 Native 基本相当</td><td>相对较慢</td></tr></tbody></table><p><strong>Cordova</strong> 是用于使用HTML，CSS和JS构建移动应用的平台。我们可以认为Cordova是一个容器，用于将我们的网络应用程序与本机移动功能连接。默认情况下，Web应用程序不能使用本机移动功能。这就是Cordova进来的地方。它为网络应用和移动设备之间的连接提供了桥梁。 通过使用cordova，我们可以使混合移动应用程序，可以使用摄像头，地理位置，文件系统和其他本地移动功能。</p><h2 id="译-React-Native-vs-Cordova-PhoneGap"><a href="#译-React-Native-vs-Cordova-PhoneGap" class="headerlink" title="[译]React Native vs. Cordova, PhoneGap"></a>[译]React Native vs. Cordova, PhoneGap</h2><p>在上一篇文章中，我告诉过你React Native非常棒，因为它允许我们使用Native UI构建应用程序。React本机应用程序的用户体验比使用WebView UI的应用程序要好得多。但“native”到底是什么意思？什么是WebView UI？为什么本地UI比WebView UI好？React Native与其他移动框架（如PhoneGap、Cordova和Ionic）相比如何？现在让我们来深入研究这些问题。坐好！<a href="https://learnreact.design/2018/02/14/react-native-vs-cordova-phone-gap-ionic-etc#fnref-3" target="_blank" rel="noopener">原文地址</a></p><h3 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h3><p>读完这篇文章，希望你能轻松地回答这些问题</p><ul><li>什么是Native App?</li><li>什么是WebView UI?</li><li>一个更接近原生的框架有哪些优点和缺点？一个不那么原生的框架呢？</li><li>React Native与Cordova对比怎么样</li></ul><h3 id="什么是原生应用？"><a href="#什么是原生应用？" class="headerlink" title="什么是原生应用？"></a>什么是原生应用？</h3><p>为了理解“原生性”的真正含义，让我向你们介绍一下这个：</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/1.jpg" alt></p><p>我是《黑客帝国》的忠实粉丝。你知道，我们所知道的现实世界实际上是模拟的。有迹象表明，即使是锡安，人类曾经认为自己自由的最后一个城市，也是一个模拟的。多层模拟现实的想法一直吸引着我 —— 一个虚拟世界在另一个虚拟世界里运行，它在第三世界里运行，这很像我们电脑（或手机）中的软件结构。</p><p>软件是用来说明大规模晶体管和电路是如何工作运行的，统称为硬件。直接在硬件上运行的原始指令对我们人类来说几乎是不可理解的，特别是考虑到当今计算机的复杂性和规模。为了使软件易于理解和操作，计算机科学家把它分成多个层次，由运行在另一个框架之上的框架组成。在所有这些框架中，框架离硬件越近，我们说它更“原生”。</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/2.png" alt></p><p>因此，应用程序的“原生性”实际上是一个相对的术语。严格地说，我们不能说一个应用程序是原生的还是非原生的。我们只能说，与其他应用程序相比，此应用程序更为原生。例如，你可以在C++、java（或KOTLIN）或Cordova中构建Android应用程序。C++应用程序是最原生的，Cordova应用程序是最不原生的。Java/Kotlin应用程序介于两者之间。</p><h3 id="原生App有哪些好处"><a href="#原生App有哪些好处" class="headerlink" title="原生App有哪些好处"></a>原生App有哪些好处</h3><p>更接近原生或更远离原生二者都有好处。更接近原生意味有着更多的自由，而更远离原生的模拟得到更多的舒适。</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/3.png" alt></p><p>在一个更原生的框架中的程序通常有更多的硬件功能，以及更多使用它们的自由。由于不同语言之间的模拟和翻译开销较低，因此它通常运行得更高效。但基本现实中的生活可能会很艰苦——代码通常很难编写和理解。</p><p>另一方面，我们人类通常更容易在一个不太原生的框架中编写代码。编码语言更容易理解和更简洁（需要更少的类型）。它的语言更接近我们的自然语言。它不需要了解硬件是由什么组成的，以及如何在引擎盖下工作。作为一个附加的好处，一个不太原生的框架中的程序通常更容易移植——该程序可以在完全不同的硬件平台上运行，而无需修改，因为它的语法和底层概念不包含任何特定于原始硬件的指令。然而，所有这些便利的代价是你通常会牺牲一些效率和自由。</p><h3 id="移动端框架"><a href="#移动端框架" class="headerlink" title="移动端框架"></a>移动端框架</h3><p>在React Native之前，移动框架通常分为两个阵营。</p><p>第一个是原生阵营，例如用于Android的Java/Kotlin和用于iOS的Objective-C/Swift。在原生阵营中，应用程序速度很快，可以访问丰富的硬件功能。用户界面是为目标平台（Android或iOS）定制的，因此很流畅，使用起来很愉快。然而，所有这些都被限制在一个平台上。要构建应用程序运行于不同平台，必须学习两种不同的框架，这使得学习曲线变陡了一倍。这尤其让数百万的web开发人员落在了后面。</p><p>接着又出现了另一个移动框架阵营，例如Cordova/PhoneGap和Ionic。这些框架允许web开发人员使用他们现有的HTML、CSS和JavaScript技能构建移动应用程序。这些应用程序可以在Android和iOS上运行。然而，它们的速度更慢，对硬件功能的访问也有限。最重要的是，这些应用的用户界面太差了！由于这些框架使用一个名为WebView的关键组件来呈现UI，我们称它们为WebView框架。</p><p>WebView框架构建在原生框架之上。我们可以将前者视为在后者内部运行的模拟世界。这就是为什么他们有上述的好处和局限性。</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/4.png" alt></p><p>为什么我们不能将二者的优点兼顾呢？这就是React Native要做的。React Native代表了移动框架的第三个阵营。它的UI层比WebView框架更为原生，而其余的则处于相同的模拟级别，以实现其易用性。</p><h3 id="React-Native-UI-比-WebView-UI-更原生"><a href="#React-Native-UI-比-WebView-UI-更原生" class="headerlink" title="React Native UI 比 WebView UI 更原生"></a>React Native UI 比 WebView UI 更原生</h3><p>Cordova等框架使得使用web技术构建移动UI成为可能。他们是怎么做到的？他们在每一个应用程序中嵌入了一个网络浏览器，称之为WebView！在用户界面中看到的所有东西，按钮、菜单和动画，都在浏览器的网页中运行。在模拟方面，Cordova应用程序的UI是在web浏览器中运行的模拟世界，它是在原生框架中运行的模拟世界。相比之下，React Native的UI比WebView框架多一层，它直接在原生框架中运行</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/7.png" alt></p><p>这种结构决定了React原生UI的优势。React Native直接使用原生UI小部件，而WebView框架试图用HTML/CSS中的web UI模拟本机UI的外观。原生和模拟，你喜欢哪一个？</p><p>从经验上讲，要识别一个使用WebView框架构建的应用并不困难。有一些控件，比如滚动加速、键盘行为、导航和用户界面的总体平滑度。如果他们的行为不完全是原生的，模拟的副作用会累积起来，给用户带来令人沮丧的体验。</p><h3 id="React-Native使用JavaScript简化操作"><a href="#React-Native使用JavaScript简化操作" class="headerlink" title="React Native使用JavaScript简化操作"></a>React Native使用JavaScript简化操作</h3><p>另一方面，React Native仍然允许我们用JavaScript编写应用程序，并使用类似于HTML和CSS的语法来构建UI。这无疑降低了网页设计师和开发人员的进入门槛。必要时，React Native提供了一种渗透到原生框架的方法，以实现我们希望在应用程序中实现的任何本机功能。这有点像在黑客帝国母体中打电话。</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/5.png" alt></p><h3 id="那WebView框架是否一文不值呢"><a href="#那WebView框架是否一文不值呢" class="headerlink" title="那WebView框架是否一文不值呢"></a>那WebView框架是否一文不值呢</h3><p>不，绝对不是。例如，如果您已经有一个web应用程序，并且希望尽快将其发布到应用程序商店。您愿意牺牲用户体验，以最短的上市时间。另一种情况是，如果应用程序中呈现的内容大多是交互性不强的内容，那么将其放在WebView中也不会太糟。但是，如果你的应用程序的用户体验很重要，如果应用程序中有一些交互性，比如接受用户输入、拖放、滑动屏幕等，一定要考虑React Native。因为您最不想做的就是用WebView UI模拟本机原生UI。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>我们已经了解了“原生”的真正含义，什么是WebView UI，为什么React native UI更好，React native与其他WebView框架（如Cordova/PhoneGap和Ionic）相比如何。你怎么认为？您将使用哪个框架来构建下一代应用程序？</p><p><img src="/2020/06/13/reactnative-dui-bi-cordova/6.png" alt></p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>在《黑客帝国》重装上阵的最后，尼欧展示了控制和击落哨兵的能力，即使是在锡安。尽管这在随后的《黑客帝国革命》中没有得到明确的解释，但当时许多粉丝甚至认为锡安是模拟的。毕竟，正如埃隆·马斯克所说，我们有几十亿分之一的机会处于基本现实中。我们在这篇文章中使用术语“框架”来指代具有某种结构的软件</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react-native </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>图解ReactNative</title>
      <link href="/2020/06/13/tu-jie-reactnative/"/>
      <url>/2020/06/13/tu-jie-reactnative/</url>
      
        <content type="html"><![CDATA[<p>随着React的火热，FaceBook又再推出ReactNative，与React不同的是ReactNative是一个专注于移动端的框架，React Native使你只使用JavaScript也能编写原生移动应用。 它在设计原理上和React一致，通过声明式的组件机制来搭建丰富多彩的用户界面。React Native产出的并不是“网页应用”， 或者说“HTML5应用”，又或者“混合应用”。 最终产品是一个真正的移动应用，从使用感受上和用Objective-C或Java编写的应用相比几乎是无法区分的。 React Native所使用的基础UI组件和原生应用完全一致。 你要做的就是把这些基础组件使用JavaScript和React的方式组合起来。那么React Native是如何做到兼容安卓和IOS平台的呢，看完本文会有所有答案，以下内容来自国外博客翻译</p><h2 id="译-图解ReactNative"><a href="#译-图解ReactNative" class="headerlink" title="[译]图解ReactNative"></a>[译]图解ReactNative</h2><p>在上一篇文章中，我们介绍了什么是 React 以及是什么使得它如此特别。今天我们将介绍 React Native: 它是做什么的，它出自何处，它和 React 有哪些不同之处，以及它为何如此令人振奋。<a href="https://learnreact.design/2017/06/20/what-is-react-native" target="_blank" rel="noopener">原文地址</a></p><p><strong>学习目标</strong></p><ul><li>什么是 React Native ？为什么它的名字中有 “Native” 字样？</li><li>为什么 React Native 如此之酷？</li><li>我们可以分别使用 React Native 和 React 来开发什么？</li><li>为什么会出现 ReactDOM ？它是做什么的？</li><li>React 渲染器 ( renderer )是用来做什么的？</li><li>React Sketch.app 工作原理是什么？</li><li>ReactVR 的工作原理是什么？</li><li>什么是 ReactJS ？React.js 又是什么？</li></ul><h3 id="不仅仅是-Web"><a href="#不仅仅是-Web" class="headerlink" title="不仅仅是 Web"></a>不仅仅是 Web</h3><p>学完上一篇文章的你现在脑海中的画面应该是这样的:</p><p><img src="/2020/06/13/tu-jie-reactnative/1.jpg" alt></p><p>你也知道，React 是在 Web 上开发用户界面的利器。使用 React 来开发 UI 的话，就能够描述你想要什么，而不是告诉 UI 如何更新 (响应式 UI)，还可以在可重用组件中组织代码，并创建高性能用户界面，而无需担心 DOM 超慢的速度 (虚拟 DOM)。越来越多的开发者选择 React 是因为它可以使得开发者更专注于上层业务，而不是底层 DOM 更新的细节。我们将这种开发 UI 的方式称之为 React 范式。范式基本上就是你思考一个问题的方式，以及这个问题的描述方式和解决方案。</p><p>对于 Web 应用来说这无疑很棒。那对于其他平台呢，比如 iOS 和 安卓？如果能将 React 范式应用于原生应用的开发，岂不是很棒？</p><p>在某种程度上来说，移动端的工作方式与 Web 端是相同的。比方说，有一个模特(树人)，还有一个根据模特来创建视觉元素的艺术家。没什么可惊讶的，构建原生应用 UI 的传统方式就是直接操纵树人并告诉他如何更新(直接跟树人交谈)。这与在 Web 浏览器中直接操纵 DOM 有类似的缺点。React 绝对有助于解决此类问题。除了相似之处外，移动端还有与 Web 端不同的地方，不同系统之间都是完全不同的。在过去，要开发原生应用的话，开发者需要学习特定的语言和平台工具链。这有点像在国外的工作室上班，员工需要说不同的语言。你需要精通所有语言才能跟所有模特进行交流。这听上去就很麻烦，你说是吧？</p><p><img src="/2020/06/13/tu-jie-reactnative/2.jpg" alt></p><p>所以，如果想要你开发出的原生应用能运行在 iOS 和安卓两个平台上的话，你需要创建两套完全分离的代码库，同样的业务逻辑需要写两遍。开发应用既困难、成本又高，从长期的维护来看的话更是如此。这正是 React Native 诞生的原因。我们来一起看看它是如何将开发过程大大简化的。</p><h2 id="React-Native"><a href="#React-Native" class="headerlink" title="React Native"></a>React Native</h2><h3 id="渲染器-renderer-和全新的-React"><a href="#渲染器-renderer-和全新的-React" class="headerlink" title="渲染器 ( renderer ) 和全新的 React"></a>渲染器 ( renderer ) 和全新的 React</h3><p>对于 Web 应用来说，React 负责启用 React 范式 (管理响应式 UI、组件和虚拟 DOM)，以及实际更新浏览器中的 DOM (与 Domo 交流)。当 DOM 是唯一需要交互的对象时，React 可以轻松处理好这两项任务。但是，对于原生应用的话，当需要管理不同平台上的各种“树人”时，事情就变得有挑战了。如果我们将更多的重担压在 React 肩上的话，那我们可怜的超级英雄将会为此抓狂。</p><p><img src="/2020/06/13/tu-jie-reactnative/3.jpg" alt></p><p>为了解决此问题，React 创建者们将原来的 React 拆分成两部分。第一部分是全新的 React ，它只负责启用 React 范式。第二部分叫做 ReactDOM ，它唯一的任务就是与浏览器中的 DOM 进行交互。因为 ReactDOM 负责更新 DOM ，而 DOM 又决定了浏览器渲染的内容，所以我们将 ReactDOM 称之为渲染器。想象一下，我们的超级英雄脱下了他的斗篷，并在上面洒了一些魔法之尘。</p><p><img src="/2020/06/13/tu-jie-reactnative/4.jpg" alt></p><p>斗篷立刻就有了生命，并成为了超级英雄的小助手。从负责与 Domo 沟通的枷锁中释放后，React 现在可以专注于做他最擅长的事。</p><p><img src="/2020/06/13/tu-jie-reactnative/5.jpg" alt></p><p>这种角色分离的理念非常之强大。现在我们只需要维护一个共享的核心库，同时编写全新的渲染器来适应新平台。这种方式要比之前简单多了。由于有了 iOS 和安卓渲染器的强力支撑，现在你可以<strong>只使用一种语言和相同的 React 范式</strong>来同时为两个平台开发应用。</p><p><img src="/2020/06/13/tu-jie-reactnative/6.png" alt="React 只需要专注于他擅长的领域即可。渲染器来负责沟通"></p><h3 id="一个完整的平台"><a href="#一个完整的平台" class="headerlink" title="一个完整的平台"></a>一个完整的平台</h3><p>React 的官网定义是: 用来开发用户界面的 JavaScript 库。它的含义有两层: 首先它是 UI 开发的利器，其次它不涉及除 UI 开发以外的任何其他领域。实际上，<strong>你无法单独使用 React 开发出一个完整的应用</strong>。例如，你需要 CSS 来写外观样式，你需要 webpack 来打包，你需要 Firebase 来做数据持久化，等等。</p><p><img src="/2020/06/13/tu-jie-reactnative/8.png" alt="&quot;网络浏览器&quot; 工作室里的实际景象要你比之前所见到的要忙碌得多"></p><p>这在 Web 开发环境下还好，因为 React 是一个 JavaScript 库，所以它能自然地适应 Web 环境下的其他部件。这些部件要么本身就是 JavaScript 库，要么能很容易地与 JavaScript 适配。毕竟 JavaScript 是 Web 上的标准语言。</p><p>但是，对于移动端来说就比较困难了，因为那里需要支持多种语言和技术。这个时候，我们就需要包含一整套部件，而且这些部件的使用方法要跟 React 类似，至少是能用 JavaScript 来调用。这样，React Native 诞生了。</p><p>相比于 Web 上的 React ，React Native 包括更多东西:</p><ul><li>全新的 React 作为核心库 (我们的超级英雄，只不过没穿斗篷)</li><li>iOS 和安卓的渲染器</li><li>将代码转换成可安装应用的工具</li><li>原生 UI 组件 (状态栏、列表等等)和动画</li><li>UI 的样式和布局工具箱 (flexbox)</li><li>构建大多数应用的基础部分 (比如网络)</li><li>提供原生功能的部分，比如粘贴板、加速计和存储</li><li>…</li></ul><p>我们说 React Native 本身是一个完整的平台是因为<strong>它包含开发完整应用所需的一切</strong>。相比之下，原本的 React 只负责 Web UI ，你需要去自己引用其他部分才能创建出一个 Web 应用。</p><p><img src="/2020/06/13/tu-jie-reactnative/9.png" alt="React Native 的组成"></p><h2 id="原生-UI"><a href="#原生-UI" class="headerlink" title="原生 UI"></a>原生 UI</h2><p>为什么 React Native 的名字里有 Native 字样？这实际上是它的标志性特征: React Native 的内置 UI 是由<strong>原生 UI 组件</strong>组成的，这些组件表现良好，外观/感觉一致，并非 WebView 中所包含的一些垃圾模拟。用 React Native 开发的应用与用像 Swift 和 Java 开发的原生应用放在一起，通常是难以区分的。你也知道，像滚动加速、动画、键盘行为和阴影这些细节，实际上在应用程序的用户体验中扮演了非常重要的角色。如果这些东西不能与你手机中其他应用保持统一的话，那么用户很快就会觉得不爽。</p><p>我原本的目的就是想在这里解释清楚 “native” 的真正含义以及为何 React Native 的性能更好。但我发现在几次头脑风暴之后，我的一整页笔记很快就写满了。还是在后面的文章中再来单独讲它吧。到目前为止，我只需要你记住原生 UI 是让 React Native 大放异彩的原因之一。看到这里，你应该了解到 React Native 是一个完整的平台，它可以让你使用 JavaScript 来开发真正的原生应用，而且还是用 React 的路子来写（React 范式）。</p><p><img src="/2020/06/13/tu-jie-reactnative/10.png" alt></p><h3 id="React-Sketch-app、ReactVR、React-XYZ…"><a href="#React-Sketch-app、ReactVR、React-XYZ…" class="headerlink" title="React Sketch.app、ReactVR、React XYZ…"></a>React Sketch.app、ReactVR、React XYZ…</h3><p>Airbnb 最近发布了一款十分有趣的工具，叫做 <a href="https://link.zhihu.com/?target=https%3A//airbnb.design/painting-with-code/">React Sketch.app</a> ，它可以将 React 代码转换成 Sketch 里的图层。你能猜出它的工作原理吗？没错！从本质上来说，它就是使用了特殊渲染器的 React Native ，这个渲染器能与 Sketch 中的树人进行交流！</p><p><img src="/2020/06/13/tu-jie-reactnative/11.png" alt></p><p>因为 React Sketch.app 是基于 React Native 的，它也是一个完整的平台，所以可以直接使用它来从远程 API 来获取数据并在 Sketch 中进行渲染。与此同时，许多 React Native 的其他变种纷纷问世，用来支持在 <a href="https://link.zhihu.com/?target=https%3A//github.com/Microsoft/react-native-windows">Windows</a>、 <a href="https://link.zhihu.com/?target=https%3A//github.com/ptmt/react-native-macos">macOS</a>、<a href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react-360">VR</a> 等平台上创建应用。</p><p>这意味着只要你掌握了 React ，就可以在大量的平台上使用 JavaScript 来创建应用，而且对新平台的支持还在不断涌现。不同的平台，同样的思维模式。正如 React Native 的创建者们所倡导的: “<strong>一次学习，随处编写</strong>”。</p><h3 id="动手时刻！"><a href="#动手时刻！" class="headerlink" title="动手时刻！"></a>动手时刻！</h3><p>说了这么多！你是否想在自己的手机上也尝试一番？我也很兴奋！拿起你的手机跟我一起动起来！</p><ol><li>在手机上下载 Expo 应用。你可以点击这里下载: <a href="https://link.zhihu.com/?target=https%3A//itunes.apple.com/app/apple-store/id982107779%3Fmt%3D8">iOS</a>、<a href="https://link.zhihu.com/?target=https%3A//play.google.com/store/apps/details%3Fid%3Dhost.exp.exponent">安卓</a>，或者在 App Store 中搜索 “Expo” 。</li><li>在电脑上打开网页: <a href="https://link.zhihu.com/?target=https%3A//snack.expo.io/">https://snack.expo.io/</a> 。</li><li>在手机上启动 Expo 应用并点击 “Scan QR Code” 。</li><li>扫描电脑上显示的二维码。如果一些正常，你应该可以看见一条绿色的信息 “Device connected” 。</li><li>如果二维码无法自动消失的话，可以点击页面右上角的小叉关闭。关闭后应该可以看见代码编辑器。</li><li>删除编辑器中的所有代码，然后将<a href="https://link.zhihu.com/?target=https%3A//gist.githubusercontent.com/lintonye/5cb3c11349591bf475b91573682fe688/raw/4ea0d4562ce45c1ba3867a1759359e1f86bb590a/domohat.jsx">此代码</a>粘贴进去。</li><li>你在手机上看到了什么？</li><li>你可以随意更改编辑器中的代码，然后立即在手机中查看结果！</li></ol><p>在后面的文章中我会对开发环境进行详细地解释。你暂时只需记住它就是 React Native 的 Codepen (在上篇文章中我曾使用它来展示示例 Domo 的帽子)。如果你将 <a href="https://link.zhihu.com/?target=https%3A//gist.github.com/lintonye/5cb3c11349591bf475b91573682fe688">React Native 版本</a> 和 <a href="https://link.zhihu.com/?target=https%3A//codepen.io/focuser/pen/gROrXx">React (Web) 版本</a>进行对比的话，你会发现它们的代码十分相似，都是这样的:</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> Hat <span class="token operator">=</span> <span class="token operator">...</span><span class="token keyword">const</span> Thinker <span class="token operator">=</span> <span class="token operator">...</span><span class="token comment" spellcheck="true">// 下面的代码是 React Native 版本的</span><span class="token comment" spellcheck="true">// Web 版本的话，只需将 “View” 替换成 “div”</span><span class="token keyword">const</span> ThinkerWithHat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>hat<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token operator">&lt;</span>View<span class="token operator">></span>    <span class="token operator">&lt;</span>Thinker <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Hat type<span class="token operator">=</span><span class="token punctuation">{</span>hat<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HatSwitcher <span class="token operator">=</span> <span class="token operator">...</span><span class="token operator">...</span></code></pre><p>“一次学习，随处编写”！还记得吗？</p><h3 id="什么是-ReactJS-？什么是-React-js-？"><a href="#什么是-ReactJS-？什么是-React-js-？" class="headerlink" title="什么是 ReactJS ？什么是 React.js ？"></a>什么是 ReactJS ？什么是 React.js ？</h3><p>你可能无数次地听到 ReactJS (或 React.js) ，我也是这么叫的。实际上这并非官方名称。自从<a href="https://link.zhihu.com/?target=https%3A//web.archive.org/web/20130529213355/https%3A//facebook.github.io/react/">诞生之日</a>起，官方名称一直都是 “React” ，从未改过。因为一般 JavaScript 库的名字都趋向于叫 “XyzJS” 或 “Xyz.js” ，React 也不例外，或许开发者们都已经习惯给库的名称加上 “JS” 或 “.js” 的后缀了。因为 React 最开始是作为 Web 库的身份出现的，所以很多开发者都习惯于实用 ReactJS 或 React.js 来泛指 Web 上的 React ，即 React 和 ReactDOM 的集合。</p><p>按照惯例，当我提到 ReactJS 时，其实我想表达的也是 Web 上的 React 。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>好了，到目前为止，我们已经介绍了不少内容。我们了解了一些 React 的历史以及 React Native 的组成。作为一个完整的平台，React Native 包含开发原生应用所需的一切，并且它使用的是 JavaScript 语言和 React 范式。React Native 现在支持多个平台，其中包括 iOS、Android、Windows、macOS、Sketch.app ，甚至还有 VR 。“一次学习，随处编写”！</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react-native </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>图解React</title>
      <link href="/2020/06/13/tu-jie-react/"/>
      <url>/2020/06/13/tu-jie-react/</url>
      
        <content type="html"><![CDATA[<p>React是一个强大的前端视图层框架，并以其强大的设计理念获得了众多前端工程师的喜爱。本文主要阐述React的心智模型，即为什么我们会这样设计 React，站在更高的角度审视React，汲取它的优秀的设计理念。设计 React 的核心前提是认为 UI 只是把数据通过映射关系变换成另一种形式的数据。大白话说就是UI只是数据的另一种表现形式，它本质上还是数据。我理解的React核心理念是通过数据改变驱动视图改变，并且这个改变是单向的。React和Vue都是通过数据驱动视图改变的框架，也叫VMMV模型。但两者在实现和使用上有一定的区别。</p><h2 id="React的函数式编程"><a href="#React的函数式编程" class="headerlink" title="React的函数式编程"></a>React的函数式编程</h2><p>React是比较遵循函数式编程设计模式的框架，从函数式编程的特性，我们可以从很多方面想到React中具有的函数式编程的特征</p><ol><li>React的组件就是一个函数生成，React中的高阶组件就是函数中的高阶函数，如redux中的connect和react-router其实就是放在App外层的高阶函数。原理是相同的，就是将子组件传入父组件中，然后返回一个新的组件，可以复用夫父组件逻辑，这本身也是一种解耦。React页面的渲染过程本质就是函数的嵌套调用过程</li><li>React中子组件受父组件传入的props控制，但是子组件不能直接修改props，也就是单项数据流，这样就有点类似于纯函数的特性，不改变外部状态。所以我们在开发组件是，应当尽量将具有副作用的操作交给外部控制，这样的组件才是独立的，也具有高度的适应性。</li><li>在Redux中这种函数是编程的思想更为明显，Reducer命名来源就是来组员方法reduce，两者都是将一些固定的运算抽象出来，每次都执行相同的任务。所以Reducer内部必须是一个纯函数，而一些请求异步等具有副作用effect的操作都交给中间件来完成。且每次调用完成都返回一个新的对象，不直接修改状态。这样的数据的操作更为清楚，你不需要考虑运行的结果因为其他的原因产生影响</li></ol><p>国外有一篇关于React的设计将的比较好，形象生动，它阐述了在开发者与浏览器之间，React扮演了怎么样的角色，起到了什么作用。</p><h2 id="译文-图解React"><a href="#译文-图解React" class="headerlink" title="[译文] 图解React"></a>[译文] 图解React</h2><p>在React、ReactJS、React.js、React Native… 这些有些相似的名词你最近听过多少遍了？对于它们究竟是什么你是否感到困惑？如果你是一名设计师，你所在的团队使用(或正在考虑使用)的技术是 React ，或者你只是单纯对 “React” 比较好奇的话，那么本文就是为你而准备的。在文本中，我只使用朴实的语言和插图来解释 React 家族中的各种术语，并深入探索究竟是什么使得 React 如此特别。本文中并不需要任何代码知识便可阅读。我希望你先熟悉一些概念，从而不至于在后面的学习过程中感到绝望。如果后面需要温故而知新的话，欢迎随时回来阅读。准备好了吗？我们开始了！<a href="https://learnreact.design/2017/06/08/what-is-react" target="_blank" rel="noopener">原文地址</a></p><p><strong>学习目标</strong></p><ul><li>什么是 DOM ？</li><li>什么是 React ？它的哪些方面比较适合应用开发？</li><li>React 与 jQuery 的不同之处？</li><li>React 的核心概念是什么？</li><li>什么是响应式 UI ？</li><li>组件有哪些好处？</li></ul><h3 id="关于-Web-你需要了解的"><a href="#关于-Web-你需要了解的" class="headerlink" title="关于 Web 你需要了解的"></a>关于 Web 你需要了解的</h3><p>我们先来介绍一些你可能听过很多年的术语。首先是 DOM 。</p><p><strong>DOM</strong></p><p>DOM 的全称是 Document Object Model (文档对象模型)。很简单吧？它就是文档对应的对象模型。先暂时忘掉它的概念。我们先来看看大名鼎鼎的 “Web Browser” 工作室！你能在下面的插图中找到 DOM 吗？</p><p><img src="/2020/06/13/tu-jie-react/2.jpg" alt></p><p>难道 DOM 是……一棵树？对，就是一棵树！奇怪的是，计算机相关的很多东西其实都像是一棵树。我们来给 DOM 起个昵称……就叫 Domo 如何？Domo 是 “Web Browser” 工作室的御用模特，他的工作就是在肖像画家(也可能是数百万个画家)面前摆 pose 。肖像就是在浏览器中浏览网站时所看见的内容。开发者的职责就好比是导演，他来告诉 Domo 该穿什么衣服，摆什么 pose 。这将决定肖像最终画出来的样子。jQuery 和 React 都是库，开发者使用它们作为与 Domo 交流的工具。</p><p><strong>JQuery</strong></p><p>JQuery 是一个 JavaScript 库，它可以使开发者操纵 DOM 变得简单得多。那他在 Domo 的故事中又扮演什么角色呢？它是一个工具，可以简化开发者与 Domo 沟通的过程，就像是一部手机。无论何时何地都可以轻松呼叫 Domo 。相比于之前(使用原生 JavaScript)，它要方便得多，还记得在电话发明出来之前人跟人连简单交流都要走得足够近才行。</p><p><img src="/2020/06/13/tu-jie-react/3.jpg" alt></p><p>多年以来，我们一直都在使用 jQuery 来直接与 Domo 沟通。是很方便，但并非没有问题。</p><h3 id="React"><a href="#React" class="headerlink" title="React"></a>React</h3><p>下面请允许我来为你介绍一个全新的超级英雄: React 。使用 React 的话，开发者不再需要直接跟 Domo 沟通。React 扮演在开发者和 Domo 之间的中间人角色。他降低了两者之间的沟通成本，同时简化了肖像创建的过程。</p><p><img src="/2020/06/13/tu-jie-react/4.jpg" alt></p><p>React 使用了一些技术来解决 jQuery 和其他工具中所存在的问题。下面是它的三项核心技术:</p><ul><li>响应式 UI</li><li>虚拟 DOM</li><li>组件</li></ul><p><strong>响应式 UI</strong></p><p>使用 jQuery 来更新 DOM 的话，你需要在适当的时机以正确的顺序来指定要更改的元素。这等同于给 Domo 一步步讲述头怎么摆、胳膊放在哪、腿什么姿势，等等，并且每张肖像都是如此。</p><p><img src="/2020/06/13/tu-jie-react/5.jpg" alt></p><p>我靠，这听起来太乏味了，并且容易出错！为什么不直接告诉 Domo 你想要的效果，而不是现在这样一步步地告诉他怎么摆 pose ?</p><p><img src="/2020/06/13/tu-jie-react/6.jpg" alt></p><p>还有更酷的，想象一下如果可以在要求过程中保留一个占位符来表示相同姿势的不同变体。React 就能做到！这种方式的话，当画家要求 Domo 穿戴不用的帽子作画时，你不需要每次都告诉 Domo 戴哪顶帽子。你尽管坐在一旁让他自己换帽子即可。</p><p><img src="/2020/06/13/tu-jie-react/7.jpg" alt></p><p>这项技术正是 React 名字的由来。使用 React 构建的 UI 是<strong>响应式</strong>的。作为开发者，你只需编写你想要的是<strong>什么</strong>，React 自己会弄清楚该<strong>怎么</strong>做。当数据变化时，UI 会相应地发生改变。你无需再关心 DOM 的更新，React 会自动帮你完成。响应式 UI 的理念大大地简化了 UI 开发。</p><p>我知道我说过你不需要任何编码知识，但只是为了帮助你正确地看待问题，我还是用代码把它写了出来。请查看下面的示例(尝试更换 Domo 的帽子，Codepen 在线 Demo: <a href="https://link.zhihu.com/?target=https%3A//codepen.io/focuser/pen/gROrXx">Domo 的帽子</a> 。在后面的文章中我会来讲解完整的代码，但此时你只需简单看一眼关键代码即可:</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> ThinkerWithHat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> hat <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token operator">&lt;</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>Hat type<span class="token operator">=</span><span class="token punctuation">{</span>hat<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Thinker <span class="token operator">/</span><span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>注意，你只需定义你想要的 (戴帽子的思想者)，并“连接”上数据 (<code>“type = {hat}”</code>) 。当数据发生变化时 (用户选择一顶帽子)，UI 会自动更新。</p><p><strong>虚拟 DOM</strong></p><p>JQuery 的另一个问题就是它的运行速度。作为一个严苛的导演，你讨厌等待。你想要肖像画尽可能快地完成。但是，Domo 和画家都比较慢，并非是树濑那种慢，只是 Domo 需要时间来换装和摆 pose ，并且画家作画也需要时间。更糟糕的是，在画家完成一幅肖像画之前，你无法与 Domo 进行沟通。事实上，你什么也做不了，除了等待。真浪费时间！</p><p><img src="/2020/06/13/tu-jie-react/8.jpg" alt></p><p>React 采用了另一项技术来解决此问题。React 画草稿的速度超级快。是当你告诉他你的要求后，他几乎就能立即将草稿完成并准备画下一张。现在就无需等待了！你可以不停地告诉 React 你想的肖像。React 将会纪录草稿的所有细节，并在适当的时候展示给 Domo 看。</p><p><img src="/2020/06/13/tu-jie-react/9.jpg" alt></p><p>更重要的一点是 React 十分聪明。他还会对所有草稿进行整理，拿掉重复的并确保 Domo 和画家的工作量维持在最低水平。</p><p><img src="/2020/06/13/tu-jie-react/10.jpg" alt></p><p>这些草稿就是 “虚拟 DOM” 。虚拟 DOM 要比操纵 DOM 快得多得多。开发者绝大部分时间里其实都是在操纵虚拟 DOM ，而不是直接操纵真实的 DOM 。React 负责管理 DOM 的这部分脏活。</p><p><strong>组件</strong></p><p>React 中第三项技术就是组件的概念。组件应该很容易理解，因为我们所生活的现实世界就是由组件组成的。我们的车、房，甚至是身体都是由不同的组件所组合而成的。这些组件又是由一些更小的组件组合而成，以此类推，直至分解成原子。如果你熟悉 <a href="https://link.zhihu.com/?target=https%3A//www.sketchapp.com/">Sketch</a> (译者注: 著名的设计软件，与 PhotoShop 齐名) 的话，组件与 Sketch 中的 <a href="https://link.zhihu.com/?target=https%3A//www.sketchapp.com/docs/symbols/">symbols</a> 十分类似。构建 React 应用几乎都是在同组件打交道: 寻找最适合的组件、融合两个组件、在现有组件的基础上创建新组件，等等。</p><p>回到 “Web Browser” 工作室，你将肖像的需求描述成一个个组件，React 将这些组件翻译成 Domo 所能理解的内容。这将为你节省大量时间，因为你无需再一次次地重复描述需求中的通用部分。</p><p><img src="/2020/06/13/tu-jie-react/11.jpg" alt></p><p>组件另外很酷的一点是如果你改变了某个组件，那么所有使用此组件的地方都将自动更新。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>好了。希望你能学会一些 React 的知识。本质上，它还是一个工具，用来帮助开发者操纵 DOM ，从而构建出页面。响应式 UI 、虚拟 DOM 和组件是 React 的三大核心概念，正是有了它们才使得 React 如此特别。当然，React 还有一些其他有趣的概念，比如单向数据流，我会在后面的文章中介绍。</p><p>译文到此就结束了，不知看完此文的你能否回答出文章开头提出的问题。React的作用归根结底是为了简化前端的开发工作，那么与JQuery或者是EasyUI这类框架相比，React的优点是什么</p><ul><li>JQuery：与它相比，React屏蔽了真实的Dom节点操作，使得开发者从为了视图效果而需要编写繁杂的Dom操作逻辑中解脱出来，专注于数据逻辑的处理。</li><li>EasyUI：我早些年使用过EasyUI，这个UI框架实际上也屏蔽了很多Dom操作的逻辑处理，只需从后端获取数据，然后把数据赋值到EasyUI的JS组件中，调用组件的刷新方法，视图也会跟着改变。React中的组件与EasyUI组件完全是两个概念，EasyUI不支持自定义组件，不支持虚拟Dom（注意，目前EasyUI也有基于React和Vue的，这里说的EasyUI是基于JS的EasyUI）</li></ul><p>总之一句话，React与Vue这类框架的核心理念是通过数据驱动视图改变，使得开发者更多关注于业务数据处理，而不是Dom操作。二者在实现上也有很多类似的地方，例如都使用了虚拟Dom，都支持组件化。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2日志框架配置详解</title>
      <link href="/2020/06/06/log4j2-ri-zhi-kuang-jia-pei-zhi-xiang-jie/"/>
      <url>/2020/06/06/log4j2-ri-zhi-kuang-jia-pei-zhi-xiang-jie/</url>
      
        <content type="html"><![CDATA[<p>在Java世界里， 日志框架通常有 <code>logback</code> 和 <code>log4j</code> 。它们两个的关系我也不多说了，通常一些老的项目使用的是log4j。Log4j是Apache的一个日志框架，且目前官方已经停止对它的维护。这些年 Log4j 发布了很多个版本，现在正在开发和维护 Log4j 2.x 系列，建议 Log4j 1.x 用户升级到最新版本。也是本文的主角，可以说log4j2是log4j的重写的二代框架，在多线程写日志的解决了死锁问题，在速度上快了10倍甚至更高。并且在springboot的版本上，spring boot 1.3版本支持log4j，在spring boot 1.4的版本中，就需要使用log4j2，否则会出现如下错误：Project build error: ‘dependencies.dependency.version’ for org.springframework.boot:spring-boot-starter-log4j:jar is missing.所以现在常用的日志基本上是logback和log4j2。<code>logback</code>和<code>log4j2</code>二者比较：</p><ul><li>性能比较：<code>Log4J2</code> 和 <code>Logback</code> 都优于 <code>log4j</code></li><li>配置方式：<code>Logback</code>最简洁，spring boot默认</li></ul><h2 id="log4j2的引入"><a href="#log4j2的引入" class="headerlink" title="log4j2的引入"></a>log4j2的引入</h2><p>在maven的pom.xml中加入</p><pre class=" language-xml"><code class="language-xml">       <span class="token comment" spellcheck="true">&lt;!--使用log4j2--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h2 id="log4j2-xml配置详解"><a href="#log4j2-xml配置详解" class="headerlink" title="log4j2.xml配置详解"></a>log4j2.xml配置详解</h2><p>在resources里新建一个文件 log4j2.xml，同时在spring boot的application.yml中指定日志配置文件路径，如下</p><pre class=" language-yml"><code class="language-yml">logging:  config: classpath:log4j2.xml</code></pre><p>log4j2.xml配置内容如下</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token comment" spellcheck="true">&lt;!--设置log4j2的自身log级别为warn--></span><span class="token comment" spellcheck="true">&lt;!--日志级别以及优先级排序: OFF > FATAL > ERROR > WARN > INFO > DEBUG > TRACE > ALL --></span><span class="token comment" spellcheck="true">&lt;!--Configuration后面的status，这个用于设置log4j2自身内部的信息输出，可以不设置，    当设置成trace时，你会看到log4j2内部各种详细输出--></span><span class="token comment" spellcheck="true">&lt;!--monitorInterval：Log4j能够自动检测修改配置 文件和重新配置本身，设置间隔秒数--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>warn<span class="token punctuation">"</span></span> <span class="token attr-name">monitorInterval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--先定义所有的appender--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appenders</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--这个输出控制台的配置--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>console</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SYSTEM_OUT<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!--输出日志的格式--></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[%d{HH:mm:ss:SSS}] [%p] - %l - %m%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>console</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>File</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>log<span class="token punctuation">"</span></span> <span class="token attr-name">fileName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>log/test.log<span class="token punctuation">"</span></span> <span class="token attr-name">append</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%d{HH:mm:ss.SSS} %-5level %class{36} %L %M - %msg%xEx%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>File</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 这个会打印出所有的info及以下级别的信息，每次大小超过size，        则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RollingFile</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileInfo<span class="token punctuation">"</span></span> <span class="token attr-name">fileName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/info.log<span class="token punctuation">"</span></span>                     <span class="token attr-name">filePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/$${date:yyyy-MM}/info-%d{yyyy-MM-dd}-%i.log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Filters</span><span class="token punctuation">></span></span>                <span class="token comment" spellcheck="true">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span> <span class="token attr-name">onMatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ACCEPT<span class="token punctuation">"</span></span> <span class="token attr-name">onMismatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DENY<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>WARN<span class="token punctuation">"</span></span> <span class="token attr-name">onMatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DENY<span class="token punctuation">"</span></span> <span class="token attr-name">onMismatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>NEUTRAL<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Filters</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[%d{HH:mm:ss:SSS}] [%p] - %l - %m%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Policies</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TimeBasedTriggeringPolicy</span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SizeBasedTriggeringPolicy</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100 MB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Policies</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RollingFile</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RollingFile</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileWarn<span class="token punctuation">"</span></span> <span class="token attr-name">fileName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/warn.log<span class="token punctuation">"</span></span>                     <span class="token attr-name">filePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/$${date:yyyy-MM}/warn-%d{yyyy-MM-dd}-%i.log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Filters</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>WARN<span class="token punctuation">"</span></span> <span class="token attr-name">onMatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ACCEPT<span class="token punctuation">"</span></span> <span class="token attr-name">onMismatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DENY<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ERROR<span class="token punctuation">"</span></span> <span class="token attr-name">onMatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DENY<span class="token punctuation">"</span></span> <span class="token attr-name">onMismatch</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>NEUTRAL<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Filters</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[%d{HH:mm:ss:SSS}] [%p] - %l - %m%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Policies</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TimeBasedTriggeringPolicy</span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SizeBasedTriggeringPolicy</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100 MB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Policies</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- DefaultRolloverStrategy属性如不设置，则默认为最多同一文件夹下7个文件，这里设置了20 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DefaultRolloverStrategy</span> <span class="token attr-name">max</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RollingFile</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RollingFile</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileError<span class="token punctuation">"</span></span> <span class="token attr-name">fileName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/error.log<span class="token punctuation">"</span></span>                     <span class="token attr-name">filePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${sys:user.home}/logs/yyw/$${date:yyyy-MM}/error-%d{yyyy-MM-dd}-%i.log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ERROR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[%d{HH:mm:ss:SSS}] [%p] - %l - %m%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Policies</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TimeBasedTriggeringPolicy</span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SizeBasedTriggeringPolicy</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100 MB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Policies</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RollingFile</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- mybatis的sql输出日志配置 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RollingFile</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sql_appender<span class="token punctuation">"</span></span> <span class="token attr-name">fileName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs/log-sql.log<span class="token punctuation">"</span></span> <span class="token attr-name">filePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs/%d{yyyy-MM-dd}/log_sql_%i.log.gz<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Filters</span><span class="token punctuation">></span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThresholdFilter</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>debug<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Filters</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %l - %m%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Policies</span><span class="token punctuation">></span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TimeBasedTriggeringPolicy</span> <span class="token attr-name">interval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">modulate</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SizeBasedTriggeringPolicy</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100 MB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Policies</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DefaultRolloverStrategy</span> <span class="token attr-name">max</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RollingFile</span><span class="token punctuation">></span></span>                                             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appenders</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--然后定义logger，只有定义了logger并引入的appender，appender才会生效--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loggers</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--过滤掉spring和hibernate的一些无用的debug信息--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.eclipse.jetty<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.mybatis<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token comment" spellcheck="true">&lt;!--指定mybatis的接口路径--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.test.crud.dao<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span> <span class="token attr-name">additivity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AppenderRef</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sql_appender<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>all<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileInfo<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileWarn<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RollingFileError<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loggers</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logger </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Logback日志框架配置详解</title>
      <link href="/2020/06/04/logback-ri-zhi-kuang-jia-pei-zhi-xiang-jie/"/>
      <url>/2020/06/04/logback-ri-zhi-kuang-jia-pei-zhi-xiang-jie/</url>
      
        <content type="html"><![CDATA[<p>在Java世界里， 日志框架通常有 <code>logback</code> 和 <code>log4j</code> 。两个日志框架都是同一个作者写的，其中 logback 是后浪，可以看作是 log4j 的改良版本，因此在性能上 logback 要好过 log4j 。目前主要分为3个模块</p><ol><li><code>logback-core</code>:核心代码模块</li><li><code>logback-classic</code>:log4j的一个改良版本，同时实现了<code>slf4j</code>的接口，这样你如果之后要切换其他日志组件也是一件很容易的事</li><li><code>logback-access</code>:访问模块与Servlet容器集成提供通过Http来访问日志的功能</li></ol><p>平时在搭建项目时少不了要配置日志框架，xml配置文件一时难以找到一个可用的模板，故本文会介绍logback的使用、配置属性详解、以及logback简单原理，最后提供一个详细的配置文件模板。这里简单讲一下 <strong>logback</strong>，<strong>log4j</strong> 和 <strong>slf4j</strong> 的关系，我在一开始使用日志框架的时候不清楚它们的关系，所以当别人问我用什么日志框架时，我说用 slf4j （哈哈，这就出洋相了。。），slf4j 全称 Simple Logging Facade for Java，是日志框架的一种抽象。简单理解为，slf4j 定义了日志框架的标准接口，logback和log4j都是slf4j的实现，我们在使用日志框架时是可以随意切换log4j和logback的，因为对外的接口都是slf4j提供的。在slf4j中，从小到大的日志级别依旧是<code>trace、debug、info、warn、error</code>。</p><h2 id="logback的引入"><a href="#logback的引入" class="headerlink" title="logback的引入"></a>logback的引入</h2><p>maven依赖</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--这个依赖直接包含了 logback-core 以及 slf4j-api的依赖--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ch.qos.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>logback-classic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>然后就可以直接在代码中使用slf4j的接口获取Logger输出日志了。下面是一个简单的使用demo</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//这是slf4j的接口，由于我们引入了logback-classic依赖，所以底层实现是logback</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger LOGGER <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>Test<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="logback-xml配置详解"><a href="#logback-xml配置详解" class="headerlink" title="logback.xml配置详解"></a>logback.xml配置详解</h2><p>下面是配置的模板，每一项配置有详细说明，拿过去根据自己的需求删删改改就能用，对于spring boot 我们需要在resources目录下建立一个xml文件，叫做<code>logback-spring.xml</code>，为什么要起这个名字呢，因为起这个名字springboot会自己去找该文件。如果不叫<code>logback-spring.xml</code>，那么需要在 spring boot 的 application.yml中指定自定义的日志配置文件的路径</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>my<span class="token punctuation">-</span>logback.xml</code></pre><p>logback.xml配置内容如下</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 文件输出格式 --></span>    <span class="token comment" spellcheck="true">&lt;!-- 1格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILE_PATTERN<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50}:  %msg%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 日志最大保存数量 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MAX_HISTORY<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 日志文件大小 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILE_SIZE<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10MB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 日志文件存放路径 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILE_PATH<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${log.path}/log_file/<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- audit文件，记录info级别日志 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AUDIT-FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 实时输出的日志文件 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>${FILE_PATH}/audit.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>append</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>append</span><span class="token punctuation">></span></span>         <span class="token comment" spellcheck="true">&lt;!-- 历史日志分块，配置滚动的策略 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 日志名称的格式 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">></span></span>${LOG_HOME}/audit.%d{yyyy-MM-dd}.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 保存的最长时间：天数 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxHistory</span><span class="token punctuation">></span></span>${MAX_HISTORY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxHistory</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>${FILE_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--日志文件最大的大小--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>triggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxFileSize</span><span class="token punctuation">></span></span>${FILE_SIZE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxFileSize</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>triggeringPolicy</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 过滤掉非info的日志,即此日志文件中只会输出info日志 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>INFO<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">></span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMissmatch</span><span class="token punctuation">></span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMissmatch</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- error文件，记录error级别日志 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ERROR-FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 实时输出的日志文件 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>${FILE_PATH}/audit.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>append</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>append</span><span class="token punctuation">></span></span>         <span class="token comment" spellcheck="true">&lt;!-- 历史日志分块，配置滚动的策略 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 日志名称的格式 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">></span></span>${LOG_HOME}/error.%d{yyyy-MM-dd}.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 保存的最长时间：天数 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxHistory</span><span class="token punctuation">></span></span>${MAX_HISTORY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxHistory</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>${FILE_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--日志文件最大的大小--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>triggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxFileSize</span><span class="token punctuation">></span></span>${FILE_SIZE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxFileSize</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>triggeringPolicy</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 过滤掉非error的日志,即此日志文件中只会输出error日志 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>ERROR<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">></span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMissmatch</span><span class="token punctuation">></span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMissmatch</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- debug文件，记录debug级别日志 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG-FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 实时输出的日志文件 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>${FILE_PATH}/debug.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>append</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>append</span><span class="token punctuation">></span></span>         <span class="token comment" spellcheck="true">&lt;!-- 历史日志分块，配置滚动的策略 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 日志名称的格式 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">></span></span>${LOG_HOME}/debug.%d{yyyy-MM-dd}.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 保存的最长时间：天数 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxHistory</span><span class="token punctuation">></span></span>${MAX_HISTORY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxHistory</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>${FILE_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--日志文件最大的大小--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>triggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxFileSize</span><span class="token punctuation">></span></span>${FILE_SIZE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxFileSize</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>triggeringPolicy</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- 过滤掉非debug的日志,即此日志文件中只会输出debug日志 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>DEBUG<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">></span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMissmatch</span><span class="token punctuation">></span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMissmatch</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 控制台输出 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>${FILE_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 打印 Spring 在启动的时候初始化各个 Bean 的信息 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.web<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!--mybatis日志 mapper包所在路径--></span>    <span class="token comment" spellcheck="true">&lt;!-- 以下这一句至关重要如果没有，就无法输出 sql 语句 --></span>    <span class="token comment" spellcheck="true">&lt;!--注意：在 spring boot 中，想在控制台打印 mybatis 的 sql 语句，只需要配置下边这一句就好了。--></span>    <span class="token comment" spellcheck="true">&lt;!--如果想要记录更详细的 SQL 日志，只需要把下面的日志级别改成 TRACE 就可以了--></span>    <span class="token comment" spellcheck="true">&lt;!--即将 mapper 接口打入 logger 就行。--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.test.dao<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--mybatis 日志打印如果在 ssm 中，可能就需要下面的配置--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="jdbc.sqltiming" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="com.ibatis" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="com.ibatis.common.jdbc.SimpleDataSource" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="com.ibatis.common.jdbc.ScriptRunner" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="java.sql.Connection" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="java.sql.Statement" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="java.sql.PreparedStatement" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!--&lt;logger name="java.sql.ResultSet" level="debug"/>--></span>    <span class="token comment" spellcheck="true">&lt;!-- 相当于logger元素，只是name值已经确定为root了 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AUDIT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ERROR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logger </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对Docker的理解</title>
      <link href="/2020/05/31/dui-docker-de-li-jie/"/>
      <url>/2020/05/31/dui-docker-de-li-jie/</url>
      
        <content type="html"><![CDATA[<p>在工作中有接触过docker部署，但只限于简单的使用，对于docker不甚了解，只是大致知道它是一种进程级别的虚拟化技术，因此本文是我对Docker技术的整理和总结。Docker是时下热门的容器技术，相信作为一名开发人员，你也一定听说过或者使用过，很多人会把Docker理解为一个轻量级虚拟机，但其实Docker与虚拟机（例如VMware）是两种不同的计算机虚拟化技术，也有很多人会觉得，有了虚拟机，那为什么还要使用Docker呢？Docker和VMware 有什么区别呢？这些问题也是我开始接触Docker时所疑惑的。带着心里的一点点疑问，让我们一起来学习Docker吧。</p><p><img src="/2020/05/31/dui-docker-de-li-jie/1.jpg" alt></p><h2 id="什么是Docker"><a href="#什么是Docker" class="headerlink" title="什么是Docker"></a>什么是Docker</h2><p>docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的Linux机器上，也可以实现虚拟化，容器是完全使用沙箱机制，相互之间不会有任何接口。简言之，就是可以在Linux上镜像使用的这么一个容器。说这么多，还是些官话，如果对虚拟化，沙箱之类的技术不是很了解的话，还是难以理解。不用着急，继续往下看。我会从硬件层面，逻辑层面，以及历史来阐明Docker到底是个啥东西，它解决了什么问题（既然它能替代VMware ，那肯定是解决了VMware解决不了的问题）</p><h3 id="理解特点"><a href="#理解特点" class="headerlink" title="理解特点"></a>理解特点</h3><p>首先明确技术要点，Docker技术就是基于容器的虚拟化技术，相对于其它虚拟化技术，它的特点是：</p><ul><li>轻量级：单机可以轻松支持上百Container，让各种个位数虚拟化的方案相形见绌。</li><li>快速就绪：一秒以内启动，即使是以资源快速就绪著称的青云IAAS也无法相比。</li><li>弱安全（容器隔离）：Docker能够对多种OS资源进行隔离，但是它本质上依托于内核，因此所有的内核漏洞都是Docker的致命伤。VMware就不存在这个问题。</li><li>简化配置：构建一次后打包后就可以用作测试环境，也可以用作生产环境或与预生产环境，可以省去很多测试环节。比如一台服务器可以进行测试多个版本的测试，不用等待</li><li>动态扩容：对与运维来说，可以快速的进行扩容，减少原利用率</li></ul><p>从这几个特点可以看出Dcoker解决的问题，并不是某个技术问题。而是开发测试部署各个环境之间的交付的优化，主要偏向于运维部署方面的解决方案。如果是这样，那么回顾一下在没有Docker之前，项目从开发到上线的流程是怎么样的。两者做一个对比就能明白Docker所起的作用了。</p><h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2><h3 id="没有虚拟化技术的原始年代"><a href="#没有虚拟化技术的原始年代" class="headerlink" title="没有虚拟化技术的原始年代"></a>没有虚拟化技术的原始年代</h3><p>在没有虚拟化技术的“远古”年代，如果我们要部署一个应用程序（Application），一般的步骤是怎么样的？我们得把项目打好包，然后准备一台物理服务器，然后在物理服务器上安装一个操作系统（Operating System）。然后把项目打好的包上传到服务器的某个目录，一般项目有自己需要的运行环境，例如数据库，Java的JRE，MQ等，还要把这些附带的中间件也要安装好，服务才能正常运行</p><p><img src="/2020/05/31/dui-docker-de-li-jie/2.png" alt="物理服务器部署应用示意图"></p><p>在物理机上部署应用有以下几个缺点：</p><ul><li>部署非常慢：因为我们得先准备硬件服务器，接着还要安装操作系统，然后再部署应用程序，而且应用程序还有很多的依赖软件，所以这个过程是比较慢的。当然你可以与其他服务共用已有的服务器</li><li>迁移和扩展太慢：当服务用户量增大需要迁移到新的服务器上，或者扩展应用，都要再准备其他的物理服务器，过程很麻烦，也很慢。</li><li>资源不可分配：我们把服务直接运行在OS之上时，是没办法对服务占用的CPU和内存做限制的，这就会导致当服务出现异常，例如CPU或内存飙升时，会影响到其它正常运行的服务</li></ul><p>那么有什么办法可以解决这些问题吗？答案就是虚拟化技术</p><h3 id="用虚拟机部署应用程序的年代"><a href="#用虚拟机部署应用程序的年代" class="headerlink" title="用虚拟机部署应用程序的年代"></a>用虚拟机部署应用程序的年代</h3><p>所谓虚拟化技术，就是在一台物理机计算机上，模拟出多台机器。它是通过操作系统的Hypervisor 技术实现，我们不用深究它是什么原理，但需要有一个大致的认识，虚拟机的虚拟化是硬件级别的虚拟化，它与宿主机不共享磁盘，内存和操作系统。虚拟机中需要安装自己的操作系统，如宿主机是Windows系统或Linux系统，虚拟机也可以安装Windows或Linux。宿主机和虚拟机逻辑上已经是两个个体了，只不过寄存在一台物理机上，共用同一台计算机的硬件设备。示意图如下</p><p><img src="/2020/05/31/dui-docker-de-li-jie/3.png" alt></p><p><strong>虚拟机的优点</strong></p><ul><li>可以把资源分配到不同的虚拟机，达到硬件资源的最大化利用</li><li>与直接在物理机上部署应用，虚拟更容易扩展应用。</li><li>云服务：通过虚拟机虚拟出不同的物理资源，可以快速搭建云服务。</li></ul><p><strong>虚拟机的缺点</strong></p><ul><li>虚拟机对物理服务器资源的消耗比较大，因为需要安装一个额外的操作系统，每台虚拟机都占用许多的服务器资源</li><li>虚拟机启动很慢，虚拟机和正常操作系统开关机一样是个耗时的操作</li><li>虚拟机部署并没有很好的解决物理机部署移植性的问题，当我们需要把服务移植到一个新的虚拟机上时，同样需要在新的虚拟机上安装服务运行环境，如数据库，JRE等。当然你也可以直接把原来的虚拟机做一份镜像拷贝过来。但虚拟机镜像比较大，也不是很方便</li></ul><h3 id="用Docker部署应用程序的年代"><a href="#用Docker部署应用程序的年代" class="headerlink" title="用Docker部署应用程序的年代"></a>用Docker部署应用程序的年代</h3><p>相对于虚拟机的笨重，Docker则更显得轻量化。Docker相比虚拟机为什么会这么轻？本质原因是虚拟机与Docker的虚拟化程度不一样。Docker是使用时下很火的Golang语言进行开发的，其技术核心是Linux内核的Cgroup，Namespace和AUFS类的Union FS等技术，这些技术都是Linux内核中早已存在很多年的技术，所以严格来说并不是一个完全创新的技术，Docker通过这些底层的Linux技术，对Linux进程进行封装隔离，而被隔离的进程也被称为容器，完全独立于宿主机的进程。所以Docker是容器技术的一种实现，也是操作系统层面的一种虚拟化，与虚拟机的通过一套硬件再安装操作系统完全不同。容器仅仅只在进程级别隔离硬件，也就是说Docker虚拟化技术它没有自己的OS，它本身只是操作系统上的一个进程，在这个进程中可以运行多个容器，每个容器相互隔离，容器和宿主机是共享操作系统。</p><p><img src="/2020/05/31/dui-docker-de-li-jie/4.png" alt></p><p>这个结构跟虚拟机有些类似，但是实现上是有很大区别的，下面是物理机，虚拟机和Docker容器三种部署方式，服务器上架构的演进图，更加直观</p><p><img src="/2020/05/31/dui-docker-de-li-jie/5.jpg" alt></p><h2 id="虚拟机-VS-容器"><a href="#虚拟机-VS-容器" class="headerlink" title="虚拟机 VS 容器"></a>虚拟机 VS 容器</h2><p>传统物理机部署就不多说了，着重对比一下虚拟机和容器化的区别，简单来说： <strong>容器和虚拟机具有相似的资源隔离和分配优势，但功能有所不同，因为容器虚拟化的是操作系统，而不是硬件，因此容器更容易移植，效率也更高。</strong>下面是一个详细的对比表格</p><table><thead><tr><th>特性</th><th>虚拟机</th><th>容器</th></tr></thead><tbody><tr><td>启动</td><td>分钟级</td><td>秒级</td></tr><tr><td>硬盘</td><td>一般为GB</td><td>一般为MB</td></tr><tr><td>性能</td><td>弱于容器</td><td>接近原生</td></tr><tr><td>支持量</td><td>一般为几十个</td><td>单机支持上千个容器</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>结构对比</p><p><img src="/2020/05/31/dui-docker-de-li-jie/7.png" alt></p><p>通过Docker官网，我们知道了这么多Docker的优势，但是大家也没有必要完全否定虚拟机技术，因为两者有不同的使用场景。<strong>虚拟机更擅长于彻底隔离整个运行环境</strong>。例如，云服务提供商通常采用虚拟机技术隔离不同的用户。而 <strong>Docker通常用于隔离不同的应用</strong> ，例如前端，后端以及数据库。对于两者无所谓谁会取代谁，而是两者可以和谐共存。</p><p><img src="/2020/05/31/dui-docker-de-li-jie/8.png" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从上面的容器结构图中，每一个App和Lib的组合，就是一个容器，所有和应用相关的依赖都会在容器中，因此移植非常方便。也就是Docker图标里面的一个集装箱。和虚拟机相比，容器有以下优点：</p><ul><li><code>迅速启动</code>：没有虚拟机硬件的初始化，没有Guest OS的启动过程，可以节约很多启动时间，这就是容器的“开箱即用”。</li><li><code>占用资源少</code>：没有运行Guest OS所需的内存开销，无需为虚拟机预留运行内存，无需安装、运行App不需要的运行库/操作系统服务，内存占用、存储空间占用都小的多。相同配置的服务器，如果运行虚拟机只能运行十多台的，通常可以运行上百个容器毫无压力——当然前提是单个容器应用本身不会消耗太多资源。</li></ul><p>当然，和虚拟机相比，因为共用内核，只靠cgroup隔离，应用之间的隔离是不如虚拟机彻底的，如果某个应用运行时导致内核崩溃，所有的容器都会崩溃。而虚拟机内的应用崩溃，理论上是不会影响其它虚拟机以及上面运行的应用的，除非是硬件或者Hypervisor有Bug。Docker把App和Lib的文件打包成为一个镜像，并且采用类似多次快照的存储技术，例如aufs/device mapper/btrfs/zfs等，可以实现：</p><ol><li>多个App可以共用相同的底层镜像（初始的操作系统镜像）</li><li>App运行时的IO操作和镜像文件隔离；</li><li>通过挂载包含不同配置/数据文件的目录或者卷（Volume），单个App镜像可以同时用来运行无数个不同业务的容器。</li></ol><pre class=" language-bash"><code class="language-bash">出处：https://www.zhihu.com/question/28300645/answer/585166942+---------+  +---------+  +---------+    +-----+ +-----+ +-----+<span class="token operator">|</span> abc.com <span class="token operator">|</span>  <span class="token operator">|</span> def.com <span class="token operator">|</span>  <span class="token operator">|</span> xyz.com <span class="token operator">|</span>    <span class="token operator">|</span> DB1 <span class="token operator">|</span> <span class="token operator">|</span> DB2 <span class="token operator">|</span> <span class="token operator">|</span> DB3 <span class="token operator">|</span>    +----+----+  +----+----+  +----+----+    +--+--+ +--+--+ +--+--+         <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span>       <span class="token operator">|</span>       <span class="token operator">|</span>+----+----+  +----+----+  +----+----+    +--+--+ +--+--+ +--+--+    <span class="token operator">|</span>   abc   <span class="token operator">|</span>  <span class="token operator">|</span> def.com <span class="token operator">|</span>  <span class="token operator">|</span> xyz.com <span class="token operator">|</span>    <span class="token operator">|</span> DB1 <span class="token operator">|</span> <span class="token operator">|</span> DB2 <span class="token operator">|</span> <span class="token operator">|</span> DB3 <span class="token operator">|</span><span class="token operator">|</span> config  <span class="token operator">|</span>  <span class="token operator">|</span> config  <span class="token operator">|</span>  <span class="token operator">|</span> config  <span class="token operator">|</span>    <span class="token operator">|</span> conf<span class="token operator">|</span> <span class="token operator">|</span> conf<span class="token operator">|</span> <span class="token operator">|</span> conf<span class="token operator">|</span><span class="token operator">|</span>  data   <span class="token operator">|</span>  <span class="token operator">|</span>  data   <span class="token operator">|</span>  <span class="token operator">|</span>  data   <span class="token operator">|</span>    <span class="token operator">|</span> data<span class="token operator">|</span> <span class="token operator">|</span> data<span class="token operator">|</span> <span class="token operator">|</span> data<span class="token operator">|</span>+----+----+  +----+----+  +----+----+    +--+--+ +--+--+ +--+--+     <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span>            <span class="token operator">|</span>       <span class="token operator">|</span>       <span class="token operator">|</span>     +------------+------------+            +-------+-------+                  <span class="token operator">|</span>                                 <span class="token operator">|</span>           +------+------+                   +------+------+                     <span class="token operator">|</span> Nginx Image <span class="token operator">|</span>                   <span class="token operator">|</span> MySQL Image <span class="token operator">|</span>           +------+------+                   +------+------+                  <span class="token operator">|</span>                                 <span class="token operator">|</span>                  +----------------+----------------+                                   <span class="token operator">|</span>                            +------+-------+                             <span class="token operator">|</span> Alpine Image <span class="token operator">|</span>                            +------+-------+</code></pre><p>上图是基于一个Alpine Linux的镜像，分别建立了Nginx和MySQL的镜像，并且挂载不同的配置/数据同时运行3个网站应用3个数据库应用的示意图。此外，Docker公司提供公共的镜像仓库（Docker称之为Repository），Github connect，自动构建镜像，大大简化了应用分发、部署、升级流程。加上Docker可以非常方便的建立各种自定义的镜像文件，这些都是Docker成为最流行的容器技术的重要因素。<strong>通过以上这些技术的组合，最后的结果就是，绝大部分应用，开发者都可以通过docker build创建镜像，通过docker push上传镜像，用户通过docker pull下载镜像，用docker run运行应用。用户不需要再去关心如何搭建环境，如何安装，如何解决不同发行版的库冲突——而且通常不会需要消耗更多的硬件资源，不会明显降低性能。这就实现了各个环境的标准化、这也是docker的图标为什么是集装箱的原因所在。</strong> 容器就是一个不错的解决方案，容器能成为开发与运维之间沟通的语言，因为容器就像一个集装箱一样，提供了软件运行的最小化环境，将应用与其需要的环境一起打包成为镜像，便可以在开发与运维之间沟通与传输。</p><h2 id="Docker名词术语"><a href="#Docker名词术语" class="headerlink" title="Docker名词术语"></a>Docker名词术语</h2><ul><li><code>Docker Client</code> : Docker提供给用户的客户端。Docker Client提供给用户一个终端，用户输入Docker提供的命令来管理本地或者远程的服务器。</li><li><code>Docker Daemon</code> : Docker服务的守护进程。每台服务器（物理机或虚机）上只要安装了Docker的环境，基本上就跑了一个后台程序Docker Daemon，Docker Daemon会接收Docker Client发过来的指令,并对服务器的进行具体操作。</li><li><code>Docker Images</code> : 俗称Docker的镜像，这个可难懂了。你暂时可以认为这个就像我们要给电脑装系统用的系统CD盘，里面有操作系统的程序，并且还有一些CD盘在系统的基础上安装了必要的软件，做成的一张 “只读” 的CD。</li><li><code>Docker Registry</code> : 这个可认为是Docker Images的仓库，就像git的仓库一样，用来管理Docker镜像的，提供了Docker镜像的上传、下载和浏览等功能，并且提供安全的账号管理可以管理只有自己可见的私人image。就像git的仓库一样，docker也提供了官方的Registry，叫做<a href="[http://hub.Docker.com](http://hub.docker.com/)">Dock Hub</a></li><li><code>Docker Container</code> : 俗称Docker的容器，这个是最关键的东西了。Docker Container是真正跑项目程序、消耗机器资源、提供服务的地方，Docker Container通过Docker Images启动，在Docker Images的基础上运行你需要的代码。你可以认为Docker Container提供了系统硬件环境，然后使用了Docker Images这些制作好的系统盘，再加上你的项目代码，跑起来就可以提供服务了。 听到这里，可能你会觉得是不是有点像一个VM利用保存的备份或者快照跑起来环境一样，其实是挺像的，但是实际上是有本质的区别，后面我会细说。</li></ul><h2 id="Docker发展历史"><a href="#Docker发展历史" class="headerlink" title="Docker发展历史"></a>Docker发展历史</h2><p>2010年，几个搞IT的年轻人，在美国旧金山成立了一家名叫“dotCloud”的公司。这家公司主要提供基于PaaS的云计算技术服务。具体来说，是和LXC有关的容器技术。后来，dotCloud公司将自己的容器技术进行了简化和标准化，并命名为——<strong>Docker</strong>。Docker技术诞生之后，并没有引起行业的关注。而dotCloud公司，作为一家小型创业企业，在激烈的竞争之下，也步履维艰。正当他们快要坚持不下去的时候，脑子里蹦出了“开源”的想法。2013年3月，dotCloud公司的创始人之一，Docker之父，28岁的<strong>Solomon Hykes</strong>正式决定，将Docker项目开源。不开则已，一开惊人。越来越多的IT工程师发现了Docker的优点，然后蜂拥而至，加入Docker开源社区。Docker的人气迅速攀升，速度之快，令人瞠目结舌。开源当月，Docker 0.1 版本发布。此后的每一个月，Docker都会发布一个版本。到2014年6月9日，Docker 1.0 版本正式发布。这也意味着Docker的稳定性和可靠性已经基本满足了生产环境的运行需求。会议上同时发布Docker Image的镜像仓库Docker Hub，并指出已经有超过14,000个Docker化的应用存储在他们的publc registry中。此时的Docker，已经成为行业里人气最火爆的开源技术，没有之一。甚至像Google、微软、Amazon、VMware这样的巨头，都对它青睐有加，表示将全力支持。也是同样的2014年6月，基于谷歌内部强大的Borg系统而开发出来的kubernetes横空处世，刷新了人们对容器的理解。</p><p><img src="/2020/05/31/dui-docker-de-li-jie/10.jpg" alt="Docker创始人 Solomon Hykes"></p><h2 id="其他容器技术"><a href="#其他容器技术" class="headerlink" title="其他容器技术"></a>其他容器技术</h2><p>虽然 docker 把容器技术推向了巅峰，但容器技术却不是从 docker 诞生的。实际上，容器技术连新技术都算不上，因为它的诞生和使用确实有些年头了。下面的一串名称肯能有的你都没有听说过，但它们的确都是容器技术的应用。</p><ul><li><strong>Chroot Jail</strong>：就是我们常见的 chroot 命令的用法。它在 1979 年的时候就出现了，被认为是最早的容器化技术之一。它可以把一个进程的文件系统隔离起来。</li><li><strong>FreeBSD Jails</strong>：Freebsd Jail 实现了操作系统级别的虚拟化，它是操作系统级别虚拟化技术的先驱之一。</li><li><strong>Linux VServer</strong>：使用添加到 Linux 内核的系统级别的虚拟化功能实现的专用虚拟服务器。</li><li><strong>Solaris Containers</strong>：它也是操作系统级别的虚拟化技术，专为 X86 和 SPARC 系统设计。Solaris 容器是系统资源控制和通过 “区域” 提供边界隔离的组合。</li><li><strong>OpenVZ</strong>：OpenVZ 是一种 Linux 中操作系统级别的虚拟化技术。 它允许创建多个安全隔离的 Linux 容器，即 VPS。</li><li><strong>Process Containers</strong>：Process 容器由 Google 的工程师开发，一般被称为 cgroups。</li><li><strong>LXC</strong>：LXC 又叫 Linux 容器，这也是一种操作系统级别的虚拟化技术，允许使用单个 Linux 内核在宿主机上运行多个独立的系统。</li><li><strong>Warden</strong>：在最初阶段，Warden 使用 LXC 作为容器。 如今已被 CloudFoundy 取代。</li><li><strong>LMCTFY</strong>：LMCTY 是 Let me contain that for you 的缩写。它是 Google 的容器技术栈的开源版本。Google 的工程师一直在与 docker 的 libertainer 团队合作，并将 libertainer 的核心概念进行抽象并移植到此项目中。该项目的进展不明，估计会被 libcontainer 取代。</li><li><strong>Docker</strong>：Docker 是一个可以将应用程序及其依赖打包到几乎可以在任何服务器上运行的容器的工具。</li><li><strong>RKT</strong>：RKT 是 Rocket 的缩写，它是一个专注于安全和开放标准的应用程序容器引擎。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode-迷宫问题</title>
      <link href="/2020/05/28/leetcode-mi-gong-wen-ti/"/>
      <url>/2020/05/28/leetcode-mi-gong-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>上篇说到广度优先搜索算法，今天就来做一个应用广度优先算法的力扣算法题吧。这个题是力扣上很常见的求最短路径类型的算法题，对于这种题如果没有解题的算法思路，看到题基本就是脑子一片空白，无从下手的关键。但是使用广度优先搜索算法去求解它时，代码实现却非常简单。</p><p><img src="/2020/05/28/leetcode-mi-gong-wen-ti/1.jpg" alt></p><h2 id="迷宫"><a href="#迷宫" class="headerlink" title="迷宫"></a>迷宫</h2><p>题目：给一个二维列表，表示迷宫（0表示通道，1表示围墙）。起点坐标<code>[x=1,y=0]</code>；终点坐标<code>[x=9,y=8]</code>。给出算法，求一条走出迷宫的最短路径。其中x表示横坐标，y表示纵坐标。</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> maze <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>为了更好理解，对应的迷宫的图如下，其中黑色代表墙，白色代表通道。红色是一条最短路径</p><p><img src="/2020/05/28/leetcode-mi-gong-wen-ti/2.png" alt="迷宫"></p><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>解题思路不多说了，使用广度优先搜索算法即可找到最短迷宫路径。</p><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="Java版本"><a href="#Java版本" class="headerlink" title="Java版本"></a>Java版本</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>maze<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2020/5/28 22:12 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MazeTest</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> maze <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Node startNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Node endNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 1:墙   0:路   10*10 = x*y</span>    <span class="token comment" spellcheck="true">/**     * 上：maze[x-1][y]     * 下：maze[x+1][y]     * 左：maze[x][y-1]     * 右：maze[x][y+1]     * */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Node<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>startNode<span class="token punctuation">)</span><span class="token punctuation">;</span>        Node node <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"x:"</span><span class="token operator">+</span>node<span class="token punctuation">.</span><span class="token function">getCoX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"--y:"</span><span class="token operator">+</span>node<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getPreNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Node <span class="token function">getPath</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Node<span class="token operator">></span> nodeList<span class="token punctuation">)</span><span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Node<span class="token operator">></span> nextNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Node node <span class="token operator">:</span> nodeList<span class="token punctuation">)</span><span class="token punctuation">{</span>            maze<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">getCoX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            nextNodes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">getNextNodes</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Node node <span class="token operator">:</span> nextNodes<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getCoX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> endNode<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> endNode<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> node<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">getPath</span><span class="token punctuation">(</span>nextNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 返回节点的下一个可达节点集合</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Node<span class="token operator">></span> <span class="token function">getNextNodes</span><span class="token punctuation">(</span>Node node<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> x <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getCoX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> y <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Node<span class="token operator">></span> nextNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果向下不越界，且下方不是墙</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">&lt;</span>maze<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> maze<span class="token punctuation">[</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>            nextNodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>maze<span class="token punctuation">[</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&lt;</span>maze<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> maze<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            nextNodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>maze<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> maze<span class="token punctuation">[</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            nextNodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>maze<span class="token punctuation">[</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> maze<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>            nextNodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>maze<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> nextNodes<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> Node preNode<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> coX<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> coY<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">Node</span><span class="token punctuation">(</span>Node preNode<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> coX<span class="token punctuation">,</span> <span class="token keyword">int</span> coY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>preNode <span class="token operator">=</span> preNode<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>coX <span class="token operator">=</span> coX<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>coY <span class="token operator">=</span> coY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> Node <span class="token function">getPreNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> preNode<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPreNode</span><span class="token punctuation">(</span>Node preNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>preNode <span class="token operator">=</span> preNode<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> value<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCoX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> coX<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCoX</span><span class="token punctuation">(</span><span class="token keyword">int</span> coX<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>coX <span class="token operator">=</span> coX<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCoY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> coY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCoY</span><span class="token punctuation">(</span><span class="token keyword">int</span> coY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>coY <span class="token operator">=</span> coY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>广度优先搜索算法BFS</title>
      <link href="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/"/>
      <url>/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/</url>
      
        <content type="html"><![CDATA[<p>最近在看到力扣上一道推箱子算法题时，思考了很久也想不到解题思路。于是查了一下推箱子的解题思路，便查到了广度优先搜索算法（BFS），广度优先搜索算法专门用于解决最短路径问题，其算法思路也很简单。而推箱子问题就可以用广度搜索算法解决，与它类似的问题还有，迷宫出口问题，最佳距离问题等。与广度优先搜索算法对应的还有深度优先搜索算法，深度优先搜索算法主要解决广度搜索算法空间复杂度高的问题，但是深度优先搜索算法它只能找到有解，无法找到最短路径。本文主要总结一下广度优先搜索算法</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/1.jpg" alt></p><h2 id="推箱子"><a href="#推箱子" class="headerlink" title="推箱子"></a>推箱子</h2><p>我以推箱子问题开始吧，推箱子相信大家都玩过，小时候电视机上或者手机上都有内置游戏，一般就有推箱子。推箱子问题如下，游戏地图用大小为 n * m 的网格 grid 表示，其中每个元素可以是墙、地板或者是箱子。现在你将作为玩家参与游戏，按规则将箱子 <code>B</code> 移动到目标位置  <code>T</code>，板用字符 <code>&#39;.&#39;</code> 表示，意味着可以自由行走，墙用字符 <code>&#39;#&#39;</code> 表示，意味着障碍物，不能通行。地图如下</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"T"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"S"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">,</span><span class="token string">"#"</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><p>问箱子推到目标地点的最小推动次数。当我看到这个题时，我是懵的，脑海中完全想不出一种可以用代码表示出来的思路去解决这个问题。</p><h2 id="广度优先搜索"><a href="#广度优先搜索" class="headerlink" title="广度优先搜索"></a>广度优先搜索</h2><p>广度优先搜索（也称宽度优先搜索，缩写BFS，以下采用广度来描述）是<a href="http://baike.baidu.com/view/3148644.htm" target="_blank" rel="noopener">连通图</a>的一种遍历策略。因为它的思想是从一个顶点V0开始，辐射状地优先遍历其周围较广的区域，故而得名。 一般可以用它做什么呢？一个最直观经典的例子就是走迷宫，我们从起点开始，找出到终点的最短路程，很多最短路径算法就是基于广度优先的思想成立的。算法导论里边会给出不少严格的证明，证明过程虽然严谨，但晦涩难懂。不如用大白话讲的清楚明白。在讲广度优先搜索算法之前，需要明白另一件事情，连通图。</p><h2 id="连通图的概念"><a href="#连通图的概念" class="headerlink" title="连通图的概念"></a>连通图的概念</h2><p>刚刚说的广度优先搜索是连通图的一种遍历策略，那么什么是连通图。在图论中，连通图基于连通的概念。在一个无向图G 中，若从顶点i到顶点j有路径相连（当然从j到i也一定有路径），则称i和j是连通的。如下图</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/2.png" alt="连通图"></p><p>这就是我们所说的连通图，这里展示的是一个无向图，连通即每2个点都有至少一条路径相连。例如V0到V9的其中一条路径就是V0 -&gt; V2 -&gt; V7 -&gt; V9。一般我们把顶点用V缩写，把边用E缩写。</p><h2 id="算法的基本思路"><a href="#算法的基本思路" class="headerlink" title="算法的基本思路"></a>算法的基本思路</h2><p>在搜索路径时，我们常常需要寻找最短路径，如上图中从 V0到V9一共有如下三条路径 <code>{ V0 -&gt; V2 -&gt; V7 -&gt; V9 }</code> , <code>{ V0 -&gt; V1 -&gt; V6 -&gt; V8 -&gt; V9 }</code> , <code>{ V0 -&gt; V3 -&gt; V6 -&gt; V8 -&gt; V9 }</code>。那么我该怎么找到最短路径 <code>{ V0 -&gt; V2 -&gt; V7 -&gt; V9 }</code> 呢。想一想刚刚你是怎么判断出最短路径的，是把到V9的三条路径都找出来了，再判断路径长度，找到最短的吗？看起来刚刚似乎是这么做的，能不能在边找终点的时候边把路径长度也判断了呢。是可以的，我们来看一下如果用广度优先搜索算法从V0到V9是怎么做的：</p><ol><li>从V0开始找下一个可以到达的节点，可以找到 <code>[ V2 , V1, V3 ]</code>，和这一个集合中不包含终点 V9，于是进行第二步</li><li>分别从第一步中找到的三个节点 V2，V1，V3开始找它们下一个可到达的节点，于是 V2可到达 <code>[ V7 ]</code>，V1可到达 <code>[ V4，V6 ]</code>，V3可到达 <code>[ V6 ]</code>。在三个集合中都不包含终点V9，于是进行第三步</li><li>在第二步中找到节点 V7，V4，V6继续寻找下一个可到达节点，V7可到达 <code>[ V9 ]</code> ，V4没有可到达的节点，V6可到达 <code>[ V8 ]</code>。在找到的可到达节点中找到了终点 V9，于是搜索结束</li></ol><p>通过刚刚这个搜索过程，其实发现第一二三步操作都是类似的，就是从起始节点开始寻找它下一个可到达节点，有点像辐射形状的搜索方式，从一个节点，向其旁边节点传递病毒，就这样一层一层的传递辐射下去，知道目标节点被辐射中了，此时就已经找到了从起点到终点的路径。这就是广度优先搜索的算法思路，很简单吧，就是这个简单的算法思想能解决大部分求最短路径问题，大道至简。下面用图再画一下算法的思路过程</p><h2 id="图解广度搜索算法"><a href="#图解广度搜索算法" class="headerlink" title="图解广度搜索算法"></a>图解广度搜索算法</h2><p>我用图来演示广度优先搜索的算法过程，设已走过的节点颜色为黑色，下一个可达节点的颜色为灰色，未走过的节点颜色为白色，已知搜索的起始节点为V0，终止节点为V9。求V0到V9的最短路径。最终最短路径我会用红色表示出来。初始化状态如下图</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/4.png" alt></p><ol><li><p>从V0开始搜索，V0置为灰色</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/5.png" alt></p></li><li><p>V0节点的下一个可达节点集合为 <code>[ V2, V1 , V3 ]</code>，故图下一步操作如下</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/6.png" alt></p></li><li><p>V1，V2，V3节点的下一个可达节点集合为 <code>[ V4，V6，V7 ]</code></p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/7.png" alt></p></li><li><p>V4，V6，V7节点的下一个可达节点集合为 <code>[ V8 , V9 ]</code></p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/8.png" alt></p></li><li><p>这个集合中已经包含终止节点V9，因此搜索结束，最终找到最短路径</p><p><img src="/2020/05/27/guang-du-you-xian-sou-suo-suan-fa-bfs/9.png" alt></p></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>广度优先搜索算法思路很简单，就是从当前节点向外辐射可到达的节点，如此往复，直到辐射到目标节点。对于节点较多的情况，广度优先搜算法会有占内存多的缺点，但速度较快。因此可理解为广度优先算法是以牺牲空间复杂度来换取较快的时间复杂度</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript中的this指向</title>
      <link href="/2020/05/26/js-zhong-de-this-zhi-xiang/"/>
      <url>/2020/05/26/js-zhong-de-this-zhi-xiang/</url>
      
        <content type="html"><![CDATA[<p>this 是JavaScript中很重要的一个指针，但是往往也是最容易产生bug 的地方，因为稍不留神this的指向就和你以为的指向根本不是一个对象，让多数新手懵逼，部分老手觉得恶心，这是因为this的绑定 [难以捉摸]，出错的时候还往往不知道为什么，相当反逻辑。熟悉Java的对this应该很熟悉，在Java中tthis在编码阶段不能确定出它指向谁，而是在运行时确定，指向的是当前调用它的对象。那么在JavaScript中这句话同样适用，记住一句话。<strong>在JavaSript中this指向的是最后调用它的那个对象</strong>，这句话在大部分场景是对的，但是还有几种特殊情况会改变this的指向。本文对this指向的所有情况做一个总结</p><p><img src="/2020/05/26/js-zhong-de-this-zhi-xiang/1.jpg" alt></p><h2 id="默认绑定"><a href="#默认绑定" class="headerlink" title="默认绑定"></a>默认绑定</h2><p>分几种情况谈论下</p><h3 id="普通函数调用"><a href="#普通函数调用" class="headerlink" title="普通函数调用"></a>普通函数调用</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>    a <span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    foo <span class="token punctuation">:</span> foo<span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 结果</span>undefined</code></pre><p><code>foo()</code>的这个写法熟悉吗，就是我们刚刚写的默认绑定，代码中直接调用了<code>foo()</code>其等价于 <code>window.foo()</code>调用，因此foo方法中的this指向的是window对象，等价于打印<code>window.a</code>，而代码中没有定义全局变量a，故输出<code>undefined</code>，如果写成下面这样。就会输出全局变量5</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>    a<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    foo<span class="token punctuation">:</span> foo<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> bar <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 函数别名！</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// a是全局对象的属性</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 5</span>obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 10</span><span class="token comment" spellcheck="true">//等价的两个函数，输出不一样的结果。为什么？</span><span class="token comment" spellcheck="true">//其实var bar === window.bar; 它隐式绑定了window 对象，所以它访问到的自然是 window.a</span></code></pre><p>对于普通调用有一种情况会存在this指向丢失，那就是回调，看下面这个例子</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">doFoo</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// fn其实引用的是foo</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt;-- 调用位置！</span><span class="token punctuation">}</span> <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    foo<span class="token punctuation">:</span> foo<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">"oops, global"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// a是全局对象的属性</span><span class="token function">doFoo</span><span class="token punctuation">(</span> obj<span class="token punctuation">.</span>foo <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "oops, global"</span></code></pre><p>注意function有自己的函数作用域，function默认绑定的父级作用域，而在这个例子中传入的是<code>foo()方法</code>，foo()此时属于window作用域的方法，因此调用它的是window对象</p><p>总结：对于普通的函数调用，实际上等价于window.foo()。在浏览器中最外层的对象就只能是window，因此可以简写成foo()调用。对于回调函数则要注意找到回调函数的父级作用域</p><h3 id="对象函数调用"><a href="#对象函数调用" class="headerlink" title="对象函数调用"></a>对象函数调用</h3><p><em>情况一</em>：如果一个函数中有this，这个函数有被上一级的对象所调用，那么this指向的就是上一级的对象。如下情况，o.fn()调用时，fn()指向对象o。因此输出对象o中的user变量值</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>    user<span class="token punctuation">:</span><span class="token string">"追梦子"</span><span class="token punctuation">,</span>    fn<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">}</span>o<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结果</span>追梦子<span class="token punctuation">{</span>user<span class="token punctuation">:</span> <span class="token string">"追梦子"</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> ƒ<span class="token punctuation">}</span></code></pre><p><em>情况二</em>：如果一个函数中有this，这个函数中包含多个对象，尽管这个函数是被最外层的对象所调用，形成调用链，this指向的是最后一个调用它的对象，如下情况，o.b.fn()尽管fn调用链有两个对象o和b，但是fn指向的是最后一个调用它的对象，因此fn指向对象b，而在对象b中没有变量a，因此输出undefined</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>    a<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>    b<span class="token punctuation">:</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//a:12,</span>        fn<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//undefind  有两个对象b和o,所以此this.a指向它的上一级</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    fn1<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//10 </span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>o<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 结果</span>undefined</code></pre><h3 id="构造函数调用"><a href="#构造函数调用" class="headerlink" title="构造函数调用"></a>构造函数调用</h3><p>对于普通调用和对象调用，都可以总结成一句话 <code>this指向的是最后调用它的那个对象</code>。但在JS中还有一种特殊的调用，学过面向对象的小伙伴对new肯定不陌生，JS的new和传统的面向对象语言的new的作用都是创建一个新的对象，但是他们的机制完全不同。创建一个新对象少不了一个概念，那就是<code>构造函数</code>，传统的面向对象 构造函数 是类里的一种特殊函数，要创建对象时使用<code>new 类名()</code>的形式去调用类中的构造函数，而JS中就不一样了。<strong>在JS中的只要用new修饰的 函数就是’构造函数’</strong>，准确来说是 <strong>函数的构造调用</strong>，因为在JS中并不存在所谓的 [构造函数]。那么用new 做到函数的<code>构造调用</code>后，JS做了什么呢</p><ol><li>创建一个新对象。</li><li>把这个新对象的<code>__proto__</code>属性指向 原函数的<code>prototype</code>属性。(即继承原函数的原型)</li><li><strong>将这个新对象绑定到 此函数的this上</strong> 。</li><li>返回新对象，如果这个函数没有返回其他<strong>对象</strong>。</li></ol><p>对于函数通过构造调用this的指向问题，分为两种情况。</p><p><em>情况一</em>：这种情况仍然适用于this指向的是最后调用它的那个对象，这种方式也是new方式的常规用法，代码如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// window对象</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 10   默认绑定</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// foo{ a : 10 }  创建的新对象的默认名为函数名</span>                          <span class="token comment" spellcheck="true">// 然后等价于 foo { a : 10 };  var obj = foo;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 10    new绑定</span></code></pre><p><em>情况二</em>：如果返回值是一个对象，那么this指向的就是那个返回的对象，如果返回值不是一个对象那么this还是指向函数的实例。还有一点就是虽然null也是对象，但是在这里this还是指向那个函数的实例，因为null比较特殊。下面列举了五种返回对象和返回值的情况</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 1.</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">'追梦子'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//undefined</span><span class="token comment" spellcheck="true">// 2.</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">'追梦子'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//undefined</span><span class="token comment" spellcheck="true">// 3.</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">'追梦子'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//追梦子</span><span class="token comment" spellcheck="true">// 4.</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">'追梦子'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> undefined<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//追梦子</span><span class="token comment" spellcheck="true">// 5.</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">'追梦子'</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fn</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//追梦子</span></code></pre><h2 id="显示绑定"><a href="#显示绑定" class="headerlink" title="显示绑定"></a>显示绑定</h2><p>在JS中提供了几个方法可以<strong>给函数强制性绑定this</strong>。它们就是<code>call</code> ，<code>apply</code> ，<code>bind</code>三个方法。这里我们就要用到 js 给我们提供的函数 call 和 apply，<strong>它们的作用都是改变函数的this指向</strong>，<strong>第一个参数都是 设置this对象</strong>。两个函数的区别：</p><ol><li>call从第二个参数开始所有的参数都是 原函数的参数。</li><li>apply只接受两个参数，且第二个参数必须是数组，这个数组代表原函数的参数列表。</li></ol><p>举个例子</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>foo<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">'海洋'</span><span class="token punctuation">,</span><span class="token string">'饼干'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 海洋饼干  这里this指向不重要就写null了</span>foo<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'海洋'</span><span class="token punctuation">,</span><span class="token string">'饼干'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 海洋饼干</span></code></pre><p>bind函数有点特殊，在React中常常用bind方法为组件绑定事件 ，它和call,apply都不同。<strong>使用bind函数为对象绑定方法时，不会立刻执行，只是将一个值绑定到函数的this上,并将绑定好的函数返回</strong>，例如</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>foo <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 10</span></code></pre><p><strong>总结：</strong> call和apply都是改变上下文中的this并立即执行这个函数，bind方法可以让对应的函数想什么时候调就什么时候调用，并且可以将参数在执行的时候添加，这是它们的区别</p><h2 id="箭头函数绑定"><a href="#箭头函数绑定" class="headerlink" title="箭头函数绑定"></a>箭头函数绑定</h2><p>ES6 提供了箭头函数，增加了我们的开发效率，但是在箭头函数里面，没有 <code>this</code> ，箭头函数里面的 <code>this</code> 是继承外面的环境，即<strong>箭头函数绑定规则不是上面介绍的规则，而是完全根据外部作用域来决定this，且绑定无法被修改</strong>。因此箭头函数的this对象判断比较简单也比较特殊，举个例子</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>    a<span class="token punctuation">:</span><span class="token number">222</span><span class="token punctuation">,</span>    fn<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//undefined</span></code></pre><p>不难发现，虽然 fn() 里面的 this是指向 obj ，但是，传给 <strong>setTimeout</strong> 的是普通函数， <strong>this</strong> 指向是 window ， 但是window下面没有 <strong>a</strong> ，所以这里输出 <strong>undefined</strong>。换成箭头函数</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>    a<span class="token punctuation">:</span><span class="token number">222</span><span class="token punctuation">,</span>    fn<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//222</span></code></pre><p>这次输出 222 是因为，传给 setTimeout 的是箭头函数，然后箭头函数里面没有 this ，所以要向上一层作用域查找，在这个例子上， setTimeout 的上层作用域是 fn。而 fn 里面的 this 指向 obj ，所以 setTimeout 里面的箭头函数的 this ，指向 obj 。所以输出 222</p><p>再举个例子，使用普通调用函数和箭头函数对比一下。下面是普通调用</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> people <span class="token operator">=</span> <span class="token punctuation">{</span>    Name<span class="token punctuation">:</span> <span class="token string">"海洋饼干"</span><span class="token punctuation">,</span>    getName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> bar <span class="token operator">=</span> people<span class="token punctuation">.</span>getName<span class="token punctuation">;</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// undefined</span></code></pre><p>很明显调用bar的是window，而window中没有Name变量，故输出undefined，如果改成箭头函数，如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> people <span class="token operator">=</span> <span class="token punctuation">{</span>    Name<span class="token punctuation">:</span> <span class="token string">"海洋饼干"</span><span class="token punctuation">,</span>    getName <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> bar <span class="token operator">=</span> people<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获得一个永远指向people的函数，不用想this了,岂不是美滋滋？</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 海洋饼干 </span></code></pre><p><code>getName()</code>方法永远指向外一层对象<code>people</code>（箭头函数比较特殊，并不需要在运行时判断是谁调用它，而是在代码阶段就能判断出this指向一定是外一层调用对象），可能会有人不解为什么在箭头函数外面再套一层，直接写不就行了吗，搞这么麻烦干嘛，其实这<strong>也是箭头函数很多人用不好的地方</strong>。改成如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> obj<span class="token operator">=</span> <span class="token punctuation">{</span>    bar <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    baz <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>obj<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// obj</span>obj<span class="token punctuation">.</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// window</span></code></pre><p>为什么<code>obj.baz()</code>方法输出的是window</p><ol><li>我们先要搞清楚一点，obj的当前作用域是window</li><li>如果不用function（function有自己的函数作用域）将其包裹起来，那么<code>baz()</code>是箭头函数，寻找外一层调用对象，那就只能是window了。（箭头函数不会绑定函数所在的作用对象，而是向上找一层调用对象）</li><li>用function包裹的目的就是将箭头函数绑定到当前的对象上。函数的作用域是当前这个对象，然后箭头函数会自动绑定函数所在作用域的this，即obj。</li></ol><h2 id="最终总结"><a href="#最终总结" class="headerlink" title="最终总结"></a>最终总结</h2><p>对于this的指向问题，大部分情况可以用文章开头那句话适用<strong>this指向的是最后调用它的那个对象</strong>。对于少部分几种情况，就是使用new调用方法时，方法存在返回值需特别注意一下，还有就是箭头函数中不存在this对象，需要继续向外面一层的上下文寻找this指向，最后一点就是函数的回调会改变this的执行。</p><p>其实最终所有的this指向的还是最后调用它的那个对象，只不过这个调用对象在有些情况下和我们预期的不一致，让我们摸不着头脑。所以还是把JS的基础打扎实就不会有这些疑惑了，哈哈。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大前端跨平台技术</title>
      <link href="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/"/>
      <url>/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/</url>
      
        <content type="html"><![CDATA[<p>在移动互联网时代，任何一个公司的产品都少不了APP，这是人们生活水平提高的结果。随着智能手机越来越普及，移动端成为兵家必争之地。正所谓“得移动端者得天下”，移动端已成为互联网领域最大的流量分发入口，一大批互联网公司正是在这大趋势下崛起。但在移动端刚出来那会儿，Android、iOS都是各自为营，分开开发的，团队之间是独立的，从需求调研，研发，测试，上线一整套流程需要的周期很长，少则几个月，多达1年甚至更长。这样的项目周期满足不了高速迭代发展的需求，伴随着移动互联网的高速发展，公司间竞争越来越激烈，如何将好想法快速落地、快速试错，成为备受关注的问题。因为只有尽快占领市场，才能在移动互联网中分得一杯羹。在这种场景下，跨平台框架应运而生</p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/1.jpg" alt></p><p>众所周知，Android 应用采用 Java 或 Kotlin 编写，iOS 应用采用 Objective-C 或 Swift 编写，Web 端采用 HTML /CSS/JavaScript 编写。当需要开发支持多端的应用，每一端都需要独立研发、测试，一直到上线，以及后续的维护工作，工作量成倍增涨，势必延长研发周期。因此跨平台框架的出现是为了解决多端独立开发，开发维护成本高，项目周期长的问题。</p><h2 id="几种APP开发模式"><a href="#几种APP开发模式" class="headerlink" title="几种APP开发模式"></a>几种APP开发模式</h2><p>主流应用程序大体分为四大类型：Native App、Hybrid App 、Web App，随着大前端的流行又衍生出很多跨平台解决方案和框架。什么是大前端：大前端是指移动端（主要是安卓和IOS），PC端（主要是网页web），小程序，也包括车载终端等客户端。随着终端越来越多于是出现了跨平台应用，跨平台应用就是实现一套前端代码，可以在PC端，IOS端，安卓端，还有其他终端（如果车载终端等）完美运行的应用，人们称之为跨平台应用。</p><h3 id="Native-App"><a href="#Native-App" class="headerlink" title="Native App"></a>Native App</h3><p>只用平台原生的开发语言，开发框架来做开发APP。是一种基于智能手机本地操作系统如iOS、Android、WP并使用原生程式编写运行的应用程序。由于是原生开发，性能比较好可以直接调用摄像头，蓝牙等硬件。 这种原生程序一般依托于操作系统，有很强的交互，是一个完整的App，可拓展性强。缺点是对于不同的操作系统需要使用特定的语言开发，不具备移植性，IOS系统开发语言：<code>Objective-C / Swift</code>。Android系统 开发语言：<code>Java / Kotlin</code></p><p><strong>优点</strong>：</p><ol><li>直接依托于操作系统，交互性最强，性能最好，体验是最优。</li><li>功能最为强大，特别是在与系统交互中，几乎所有功能都能实现</li></ol><p><strong>缺点</strong>：</p><ol><li>开发成本高,无法跨平台，不同平台Android和iOS上都要各自独立开发</li><li>门槛较高,原生人员有一定的入门门槛。相比广大的前端人员而言，较少</li><li>更新缓慢,特别是发布应用商店后，需要等到审核周期。原生应用更新是一个很大的问题，Android中还能直接下载整包APK进行更新，但在IOS中，如果是发布AppStore,必须通过AppStore地址更新,而每次更新都需要审核,所以无法达到及时更新</li><li>维护成本高</li></ol><h3 id="Hybrid-App"><a href="#Hybrid-App" class="headerlink" title="Hybrid App"></a>Hybrid App</h3><p>用 JS+H5 开发应用的技术，可以通过某种手段调用系统能力。从原生开发者的角度，混合应用其实就是一个原生开发的 App 外壳，这个外壳将原生功能封装成很多 API 并注入到 WebView 里，然后将前端页面打包进 App，App 启动时用 WebView 加载前端页面，剩下的就全交给前端了。混合应用框架的本质就是这个原生 App 外壳，这个外壳重点实现三件事，只要做到这三件事，基本上就可以被称为混合开发通用框架。</p><ol><li>实现原生与前端（Javascript）的交互</li><li>封装基本的原生功能，供前端调用</li><li>实现原生插件机制，供原生开发者扩展功能</li></ol><p>简而言之，在Hybrid模式下，由原生提供统一的API给JS调用，实际的主要逻辑有Html和JS来完成,而由于最终是放在webview中显示的，所以只需要写一套代码即可。</p><p><strong>优点</strong>：</p><ol><li>开发成本较低,可以跨平台,调试方便，前端人员稍微学习下JS api的调用即可,无需两个独立的原生人员。一般Hybrid中的跨平台最少可以跨三个平台:Android App,iOS App,普通webkit浏览器</li><li>维护成本低,功能可复用，如果代码合理，只需要一名前端就可以维护多个app,而且很多功能还可以互相复用</li><li>更新较为自由，虽然没有Web App更新那么快速,但是Hybrid中也可以通过原生提供api，进行资源主动下载，达到只更新资源文件，不更新apk(ipa)的效果</li><li>针对新手友好，学习成本较低。这种开发模式下，只需要前端人员关注一些原生提供的API，具体的实现无需关心，没有新的学习内容，只需要前端人员即可开发</li><li>功能更加完善，性能和体验要比起web app好太多。因为可以调用原生api，所以很多功能只要原生提供出就可以实现，另外性能也比较接近原生了</li><li>部分性能要求的页面可用原生实现。这应该是Hybrid模式的最多一个好处了，因为这种模式是原生混合web，所以我们完全可以将交互强，性能要求高的页面用原生写，然后一些其它页面用JS写，嵌入webview中以达到最佳体验</li></ol><p><strong>缺点</strong>：</p><ol><li>相比原生，性能仍然有较大损耗。这种模式受限于webview的性能桎梏，相比原生而言有不少损耗，体验无法和原生相比。不过相比于原生的诸多优点，这个缺点显然可以接受</li><li>不适用于交互性较强的App，这种模式的主要使用一些新闻阅读类，信息展示类的App。但是不适用于一些交互较强或者性能要求较高的App</li></ol><h3 id="Web-App"><a href="#Web-App" class="headerlink" title="Web App"></a>Web App</h3><p>指采用H5语言写出的App，不需要下载安装。类似于现在所说的轻应用，生存在浏览器中的应用，可以说是触屏版的网页应用。类比于电脑网页中的应用，只是移动端有触屏和手势。Web App生存于浏览器里，宿主是浏览器。对比与原生应用缺点也很明显，因为web App实际上就是手机上的网页，依赖于浏览器内核，无法调用系统权限如地理信息，通讯录，语音，摄像头等等。而且由于不同的浏览器身的属性不尽相同，如浏览器自带的手势，页面切换方式，链接跳转方式，存在版本兼容问题等等</p><p><strong>优点</strong>：</p><ol><li>开发成本低,可以跨平台，调试方便。Web App一般只需要一个前端人员开发出一套代码，然后即可应用于各大主流浏览器(特殊情况可以代码进行下兼容)。没有新的学习成本，而且可以直接在浏览器中调试。</li><li>维护成本低</li><li>更新最为快速，由于web app资源是直接部署在服务器端的，所以只需要替换服务器端的文件，用户访问是就已经更新了(当然需要解决一些缓存问题)</li><li>无需安装App,不会占用手机内存，通过浏览器即可访问,无需安装,用户就会比较愿意去用</li></ol><p><strong>缺点</strong>：</p><ol><li>性能低，用户体验差，由于是直接通过的浏览器访问，所以无法使用原生的API，操作体验不好。而且由于依赖于浏览器，部分手势还可能和浏览器的手势冲突</li><li>依赖于网络,页面访问速度慢，耗费流量。Web App每次访问都需要去服务端加载资源访问，所以必须依赖于网络。而且网速慢时访问速度很不理想，特别是在移动端，如果网站优化不好会无故消耗大量流量</li><li>功能受限，大量功能无法实现。只能使用Html5的一些特殊api，无法调用原生API，所以很多功能存在无法实现情况</li><li>临时性入口，用户留存率低。这既是它的优点，也是缺点，优点是无需安装。确定是用完后有时候很难再找到，或者说很难专门为某个web app留存一个入口，导致用户很难再次使用</li></ol><h3 id="React-Native-App"><a href="#React-Native-App" class="headerlink" title="React Native App"></a>React Native App</h3><p> Facebook发起的开源的一套新的APP开发方案，Facebook在当初深入研究Hybrid开发后，觉得这种模式有先天的缺陷，所以果断放弃，转而自行研究，后来推出了自己的“React Native”方案，不同于H5，也不同于原生，更像是用JS写出原生应用。用 javascript语言就能同时编写 ios，android，以及后台的一项技术。用React Native 就是真正意义上的全栈，一个项目从头到尾可以一个人搞定。一开始我以为React Native App属于Hybrid App。因为它们都使用JS写应用，只不过Hybrid App用WebView 实现，而React Native App自己写了一个引擎实现。但其实不是，在开发的角度来说，两者使用起来差不太多，都可以用JS写App，但是React Native App编译之后生成的是原生的控件，所以是原生应用。但开发模式上与原生App差别又很大，应该说是一种跨平台解决方案的新思路，其实很多大公司都已经在使用React Native开发了</p><p><strong>优点</strong>：</p><ol><li>开发人员单一技术栈，一次学习，跨平台开发。这种模式是统一由JS编写，有着独特的语法，所以只需要学习一次，即可同时开发Android和iOS</li><li>相对Hybird app或者Webapp。不用Webview，彻底摆脱了Webview让人不爽的交互和性能问题，有较强的扩展性，这是因为Native端提供的是基本控件，JS可以自由组合使用可以直接使用Native原生的动画（在FB Group这个app里面，面板滑出带一点果冻弹动，面板基于某个点展开这种动画随处可见，这种动画用Native code来做小菜一碟，但是用Web来做就难上加难）。</li><li>相对于Native App。可以通过更新远端JS，直接更新app，不过这快成为各家大型Native app的标配了</li><li>社区繁荣，遇到问题容易解决。这应该是React Native的很大一个优势,不像Hybrid模式和原生模式一样各自为营，这种模式是Facebook统一发起的,所以有一个统一的社区，里面有大量资源和活跃的人员，对开发者很友好</li><li>性能体验高于Hybrid，不逊色与原生。这种模式和Hybrid不一样，Hybrid中的view层实际上还是dom，但是这种模式的view层是虚拟dom，所以性能要高于Hybrid，距离原生差距不大。这种模式可以认为是用JS写原生，即页面用JS写，然后原生通过Bridge技术分析JS,将JS内容单独渲染成原生Android和iOS，所以也就是为什么性能不逊色原生</li></ol><p><strong>缺点</strong>：</p><ol><li>从Native到Web，要做很多概念转换，势必造成双方都要妥协。最终web要用一套CSS的阉割版，Native要费劲地把这个阉割版转换成native原生的表达方式（比如iOS的Constraint\origin\Center等属性），两边都会不爽</li><li>虽然可以部分跨平台，但并不是Hybrid中的一次编写，两次运行那种，而是不同平台代码有所区别。这种模式实际上还是JS来写原生，所以Android和iOS中的原生代码会有所区别，如果需要跨平台，对开发人员有一定要求。</li></ol><h2 id="WebView简介"><a href="#WebView简介" class="headerlink" title="WebView简介"></a>WebView简介</h2><p>为了理解Hybrid App与React Native App的区别，你不得不知道的组件就是WebView。Android WebView在Android平台上是一个特殊的View， 基于webkit引擎、展现web页面的控件，这个类可以被用来在你的app中仅仅显示一张在线的网页，还可以用来开发浏览器。WebView内部实现是采用渲染引擎来展示view的内容，提供网页前进后退，网页放大，缩小，搜索。现在很多<code>App</code>里都内置了Web网页（<code>Hybrid App</code>），比如说很多电商平台，淘宝、京东、聚划算等等，如下图</p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/2.jpg" alt="京东首页"></p><p>Android的Webview在低版本和高版本采用了不同的webkit版本内核，4.4后直接使用了Chrome。WebView控件功能强大，除了具有一般View的属性和设置外，还可以对url请求、页面加载、渲染、页面交互进行强大的处理。</p><h3 id="Webview类常用方法"><a href="#Webview类常用方法" class="headerlink" title="Webview类常用方法"></a>Webview类常用方法</h3><p>加载url，加载方式根据资源分为三种，如下</p><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">//方式1. 加载一个网页：</span>  webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"http://www.google.com/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//方式2：加载apk包中的html页面</span>  webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"file:///android_asset/test.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//方式3：加载手机本地的html页面</span>   webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"content://com.android.htmlfileprovider/sdcard/test.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 方式4： 加载 HTML 页面的一小段内容</span>  WebView<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>String data<span class="token punctuation">,</span> String mimeType<span class="token punctuation">,</span> String encoding<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 参数说明：</span><span class="token comment" spellcheck="true">// 参数1：需要截取展示的内容</span><span class="token comment" spellcheck="true">// 内容里不能出现 ’#’, ‘%’, ‘\’ , ‘?’ 这四个字符，若出现了需用 %23, %25, %27, %3f 对应来替代，否则会出现异常</span><span class="token comment" spellcheck="true">// 参数2：展示内容的类型</span><span class="token comment" spellcheck="true">// 参数3：字节码</span></code></pre><p>WebView的状态</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//激活WebView为活跃状态，能正常执行网页的响应</span>webView<span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ；<span class="token comment" spellcheck="true">//当页面被失去焦点被切换到后台不可见状态，需要执行onPause</span><span class="token comment" spellcheck="true">//通过onPause动作通知内核暂停所有的动作，比如DOM的解析、plugin的执行、JavaScript执行。</span>webView<span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；<span class="token comment" spellcheck="true">//当应用程序(存在webview)被切换到后台时，这个方法不仅仅针对当前的webview而是全局的全应用程序的webview</span><span class="token comment" spellcheck="true">//它会暂停所有webview的layout，parsing，javascripttimer。降低CPU功耗。</span>webView<span class="token punctuation">.</span><span class="token function">pauseTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//恢复pauseTimers状态</span>webView<span class="token punctuation">.</span><span class="token function">resumeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；<span class="token comment" spellcheck="true">//销毁Webview</span><span class="token comment" spellcheck="true">//在关闭了Activity时，如果Webview的音乐或视频，还在播放。就必须销毁Webview</span><span class="token comment" spellcheck="true">//但是注意：webview调用destory时,webview仍绑定在Activity上</span><span class="token comment" spellcheck="true">//这是由于自定义webview构建时传入了该Activity的context对象</span><span class="token comment" spellcheck="true">//因此需要先从父容器中移除webview,然后再销毁webview:</span>rootLayout<span class="token punctuation">.</span><span class="token function">removeView</span><span class="token punctuation">(</span>webView<span class="token punctuation">)</span><span class="token punctuation">;</span> webView<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="Webview与-Js的交互"><a href="#Webview与-Js的交互" class="headerlink" title="Webview与 Js的交互"></a>Webview与 Js的交互</h3><p>Webview既然能够嵌套HTML页面，而HTML中最重要的就是JS事件了，那么Webview与JS事件的交互就是开发中经常需要面对的问题，这里介绍一种比较通用的方式，通过 <code>WebChromeClient</code> 的<code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code>方法回调拦截JS对话框<code>alert()</code>、<code>confirm()</code>、<code>prompt（）</code> 消息。</p><p><em>javascript.html</em>：以.html格式放到src/main/assets文件夹里</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Carson_Ho<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">function</span> <span class="token function">clickprompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 调用prompt（）</span>    <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">"js://demo?arg1=111&amp;arg2=222"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"demo "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- 点击按钮则调用clickprompt()  --></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button1<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clickprompt()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>点击调用Android代码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>当使用<code>mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;)</code>加载了上述JS代码后，就会触发回调<code>onJsPrompt（）</code>，具体如下：</p><ol><li>如果是拦截警告框（即<code>alert()</code>），则触发回调<code>onJsAlert（）</code>；</li><li>如果是拦截确认框（即<code>confirm()</code>），则触发回调<code>onJsConfirm（）</code>；</li></ol><p><em>Webview</em>：在Android通过WebChromeClient复写onJsPrompt（）</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    WebView mWebView<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//    Button button;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        mWebView <span class="token operator">=</span> <span class="token punctuation">(</span>WebView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>webview<span class="token punctuation">)</span><span class="token punctuation">;</span>        WebSettings webSettings <span class="token operator">=</span> mWebView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 设置与Js交互的权限</span>        webSettings<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 设置允许JS弹窗</span>        webSettings<span class="token punctuation">.</span><span class="token function">setJavaScriptCanOpenWindowsAutomatically</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 先加载JS代码</span>        <span class="token comment" spellcheck="true">// 格式规定为:file:///android_asset/文件名.html</span>        mWebView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"file:///android_asset/javascript.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mWebView<span class="token punctuation">.</span><span class="token function">setWebChromeClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebChromeClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                        <span class="token comment" spellcheck="true">// 拦截输入框(原理同方式2)</span>                                        <span class="token comment" spellcheck="true">// 参数message:代表promt（）的内容（不是url）</span>                                        <span class="token comment" spellcheck="true">// 参数result:代表输入框的返回值</span>                                        <span class="token annotation punctuation">@Override</span>                                        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onJsPrompt</span><span class="token punctuation">(</span>WebView view<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> String message<span class="token punctuation">,</span> String defaultValue<span class="token punctuation">,</span> JsPromptResult result<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                            <span class="token comment" spellcheck="true">// 根据协议的参数，判断是否是所需要的url(原理同方式2)</span>                                            <span class="token comment" spellcheck="true">// 一般根据scheme（协议格式） &amp; authority（协议名）判断（前两个参数）</span>                                            <span class="token comment" spellcheck="true">//假定传入进来的 url = "js://webview?arg1=111&amp;arg2=222"（同时也是约定好的需要拦截的）</span>                                            Uri uri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment" spellcheck="true">// 如果url的协议 = 预先约定的 js 协议</span>                                            <span class="token comment" spellcheck="true">// 就解析往下解析参数</span>                                            <span class="token keyword">if</span> <span class="token punctuation">(</span> uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                <span class="token comment" spellcheck="true">// 如果 authority  = 预先约定协议里的 webview，即代表都符合约定的协议</span>                                                <span class="token comment" spellcheck="true">// 所以拦截url,下面JS开始调用Android需要的方法</span>                                                <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"webview"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                    <span class="token comment" spellcheck="true">//</span>                                                    <span class="token comment" spellcheck="true">// 执行JS所需要调用的逻辑</span>                                                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"js调用了Android的方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                    <span class="token comment" spellcheck="true">// 可以在协议上带有参数并传递到Android上</span>                                                    HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                    Set<span class="token operator">&lt;</span>String<span class="token operator">></span> collection <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getQueryParameterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                    <span class="token comment" spellcheck="true">//参数result:代表消息框的返回值(输入值)</span>                                                    result<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">"js调用了Android的方法成功啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                <span class="token punctuation">}</span>                                                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                                            <span class="token punctuation">}</span>                                            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onJsPrompt</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> url<span class="token punctuation">,</span> message<span class="token punctuation">,</span> defaultValue<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 通过alert()和confirm()拦截的原理相同，此处不作过多讲述</span>                                        <span class="token comment" spellcheck="true">// 拦截JS的警告框</span>                                        <span class="token annotation punctuation">@Override</span>                                        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onJsAlert</span><span class="token punctuation">(</span>WebView view<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> String message<span class="token punctuation">,</span> JsResult result<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onJsAlert</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> url<span class="token punctuation">,</span> message<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token punctuation">}</span>                                        <span class="token comment" spellcheck="true">// 拦截JS的确认框</span>                                        <span class="token annotation punctuation">@Override</span>                                        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onJsConfirm</span><span class="token punctuation">(</span>WebView view<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> String message<span class="token punctuation">,</span> JsResult result<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onJsConfirm</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> url<span class="token punctuation">,</span> message<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token punctuation">}</span>                                    <span class="token punctuation">}</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><p>最终结果展示</p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/3.jpg" alt></p><p>通过刚刚的代码，对Webview的作用应该理解了，借此对刚刚说的几种App类型用大白话做一个总结吧。</p><table><thead><tr><th>App</th><th>解释</th></tr></thead><tbody><tr><td>Native App</td><td>原生应用。类比于windows系统上的桌面应用，可以轻松的调用系统提供的API<br>但移植性差，例如windows上的桌面应用不能直接在Linux上使用</td></tr><tr><td>Web App</td><td>Web 应用。严格来说，我觉得它不能称之为App，它的实现类比于windows上的网页<br>其实就可以理解为它是移动端的网页应用。而我理解的App是安装在操作系统上的App</td></tr><tr><td>Hybrid App</td><td>混合应用。它实际上可以说是原生组件提供的功能，在系统原生组件中提供了WebView组件<br>这个组件特殊的地方在于，可以在这个组件中展示HTML页面。因此很多人说<br>现在的App开发就是用H5开发，然后套了个外壳，这个壳指的就是WebView</td></tr><tr><td>React Native App</td><td>原生应用。虽然开发的时候是用JS开发，但是编译后是原生组件。可以这么理解<br>React Native框架提供了React组件到原生组件的映射，每个JS事件可以对应到原生组件的事件<br>最终编译后把React组件和对应的JS事件代码翻译成原生组件和事件代码</td></tr></tbody></table><p>以上是个人理解。可能会有类比不恰当的地方，但大概就是这么个意思吧</p><h2 id="APP对比"><a href="#APP对比" class="headerlink" title="APP对比"></a>APP对比</h2><table><thead><tr><th></th><th>Native App</th><th>Hybrid App</th><th>Web App</th><th>React Native App</th></tr></thead><tbody><tr><td><strong>App特性比较</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>图像渲染</td><td>本地API渲染</td><td>混合</td><td>H5</td><td>本地API渲染</td></tr><tr><td>性能</td><td>最快</td><td>慢</td><td>快</td><td>快</td></tr><tr><td>界面</td><td>原生</td><td>模仿</td><td>模仿</td><td></td></tr><tr><td>发布</td><td>App Store</td><td>App Store</td><td>Web</td><td>App Store</td></tr><tr><td><strong>本机设备访问</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>照相机</td><td>支持</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>系统通知</td><td>支持</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>定位</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>蓝牙</td><td>支持</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td><strong>其他比较</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>开发成本</td><td>高</td><td>中</td><td>低</td><td>中</td></tr><tr><td>维护更新</td><td>复杂</td><td>简单</td><td>简单</td><td>简单</td></tr><tr><td>体验</td><td>优</td><td>优</td><td>差</td><td>优</td></tr><tr><td>Store或Market</td><td>认可</td><td>认可</td><td>不认可</td><td>认可</td></tr><tr><td>安装</td><td>需要</td><td>需要</td><td>不需要</td><td>需要</td></tr><tr><td>跨平台</td><td>差</td><td>优</td><td>优</td><td>优</td></tr><tr><td>网络要求</td><td>支持离线</td><td>依赖网络</td><td>依赖网络</td><td>支持离线</td></tr><tr><td>资源存储</td><td>本地</td><td>本地和服务器</td><td>服务器</td><td>本地</td></tr><tr><td>适用场景</td><td>1.偏操作互动多的工具类应用<br>2.需要访问特定的原生API<br>3.对速度要求较高</td><td>1.同Native App中提到的适用场景<br>2.需要频繁小幅度更新</td><td>1.作为对非核心业务在移动端的入口补足<br>2.作为用户轻量、低频使用的体验增强<br>3.作为吸引用户安装Native App的引导页</td><td>1.适用于快速迭代不同平台的App应用<br>2.绝大部分功能在不同系统上可以使用一套代码解决，成本低</td></tr></tbody></table><h2 id="其他类似React-Native-App框架"><a href="#其他类似React-Native-App框架" class="headerlink" title="其他类似React Native App框架"></a>其他类似React Native App框架</h2><p>React Native App的实现原理最主要的就是在编译时，把JS组件转换为原生组件。市面上还有一些实现了这种转换功能的跨平台框架。</p><h3 id="Weex"><a href="#Weex" class="headerlink" title="Weex"></a>Weex</h3><p>Weex 是阿里开源的一款跨平台移动开发工具，是阿里巴巴开发团队在RN的成功案例上，重新设计出的一套开发模式，站在了巨人肩膀上并有淘宝团队项目做养料，广受关注，2016年4月正式开源，并在v2.0版本官方支持Vue.js，与RN分庭抗礼。Weex 这个名字是取得 weeks 的谐音。Weex能够完美兼顾性能与动态性，让移动开发者通过简捷的前端语法写出Native级别的性能体验，并支持iOS、安卓、YunOS及Web等多端部署。<strong>Weex</strong> 是一个使用 Web 开发体验来开发高性能原生应用的框架。使用同一套代码就可以构建 Android、iOS 和 Web 应用。Weex 的结构是解耦的，渲染引擎与语法层是分开的，目前主要支持 Vue.js 和 Rax 这两个前端框架。Weex 在 iOS 和 Android 上都实现了一个渲染引擎，并提供了一套基础的内置组件。基于这些组件，你可以用JS封装更多的上层组件。</p><p><em>Weex于2016年6月开始发布版本，第一个版本号为v0.5.0。</em></p><h3 id="Flutter"><a href="#Flutter" class="headerlink" title="Flutter"></a>Flutter</h3><p>Flutter是谷歌推出的跨平台项目，它的前身是Sky项目，起源于2015年。Sky项目一开始就定位Dart作为开发语言，使用Dart语言开发移动端项目，Sky它不依赖于平台，它的代码可以运行在Android、iOS设备上，真正做到了“一次代码，处处运行”，让你在Android、iOS设备上拥有接近原生的体验。主要特点是跨平台、高保真、有些性能。Flutter提供了丰富的组件、接口，开发者可以很快地为 Flutter添加 Native扩展。同时Flutter还可以使用 Native引擎渲染视图，这无疑能为用户提供良好的体验。</p><p><em>Flutter在2017年5月发布了第一个版本v0.0.6。</em></p><h2 id="其他跨平台框架"><a href="#其他跨平台框架" class="headerlink" title="其他跨平台框架"></a>其他跨平台框架</h2><p>市面有很多实现了跨平台的框架，其实现原理基本属于上面四大类App中的一种，下面分别介绍一下它们</p><h3 id="Taro"><a href="#Taro" class="headerlink" title="Taro"></a>Taro</h3><p>小程序跨平台开发，一款可以用TSX、JSX和React语法开发小程序的框架，内置了一些UI组件，还有物料市场，目前看势头很好。还可以集成React-native,真正做到一套代码多处运行，不仅能编译成各种平台小程序，还可以是RN的应用，还支持<strong>快应用</strong>。官网地址<a href="https://taro.aotu.io/" target="_blank" rel="noopener">点这里</a>。现如今市面上端的形态多种多样，Web、React-Native、微信小程序等各种端大行其道，当业务要求同时在不同的端都要求有所表现的时候，针对不同的端去编写多套代码的成本显然非常高，这时候只编写一套代码就能够适配到多端的能力就显得极为需要。</p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/4.png" alt></p><p>使用 Taro，我们可以只书写一套代码，再通过 Taro 的编译工具，将源代码分别编译出可以在不同端（微信/百度/支付宝/字节跳动/QQ/京东小程序、快应用、H5、React-Native 等）运行的代码。</p><p>Taro的源码我没看过，但是我看里面用了很多他们自己写的babel包，应该是JIT模式，加入了中间层，把你写的东西，编译成了小程序可以执行的代码，个人认为小程序不要做得太复杂，不然你还不如做个APP，轻量跨平台，自然是最快速的，而且可以使用TSX语法，React，太好了。</p><h3 id="快应用"><a href="#快应用" class="headerlink" title="快应用"></a>快应用</h3><p>华为、小米等九大手机厂商为了跟小程序竞争搞出来的，基于硬件平台共同推出的新型应用生态。像RN这些框架，会内置一些渲染/排版引擎，那么打包出来提交比较大，快应用是集成到安卓手机的ROM中，所以只有源码那部分，安装体积比较小，这样就叫快应用。快应用使用原生js开发，框架跟原生微信小程序很像（写着不舒服，<strong>Taro</strong>支持快应用），官网地址<a href="https://www.quickapp.cn/" target="_blank" rel="noopener">点这里</a></p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/5.png" alt></p><h3 id="Electron"><a href="#Electron" class="headerlink" title="Electron"></a>Electron</h3><p>Electron就是把Node.js的运行环境和谷歌浏览器内核一起打包了，于是就拥有了Node.js和H5技术的融合能力，又因为是基于C++编写，于是可以跨平台。Mac、windows、Linux。所以Electron是一个用 <code>HTML</code>，<code>CSS</code> 和 <code>JavaScript</code> 来构建跨平台桌面应用程序的一个开源库，没错，你可以用写网页的知识来写一个桌面应用程序！Electron开发出来的东西是软件，是一个安装在电脑上的软件！是不是发现了新大陆，前端开发不仅仅只能写web页面了，可以做的事情很多了。官网地址<a href="http://www.electronjs.org/" target="_blank" rel="noopener">点这里</a></p><p><img src="/2020/05/23/da-qian-duan-kua-ping-tai-ji-zhu/6.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React使用总结</title>
      <link href="/2020/05/17/react-shi-yong-zong-jie/"/>
      <url>/2020/05/17/react-shi-yong-zong-jie/</url>
      
        <content type="html"><![CDATA[<p>使用了一段时间React，从最开始的排斥到习惯，然后再到逐渐喜欢上它，在此做一个总结。我在之前使用过一段时间的Vue，并通过Vue把公司的风控项目重构成了一个前后端分离项目。由于参与另一个项目便开始使用React。说实话，在使用Vue后再使用React，很不习惯，无论是语法上还是设计思想上，Vue和React区别都挺大。Vue支持数据的双向绑定，而React是单向的，它的组件是一个单向数据流，数据改变会导致视图改变，但视图改变不会导致数据改变。因此在做一些输入框，下拉框时不得不写很多 change 事件来主动改变数据，这是我觉得React不好用的地方之一，还有就是JSX语法一开始我也不习惯，因为在Vue中，模板语法就是Html语法，而JSX则不是增加了一些学习成本，好在JSX语法并不复杂。虽然有诸多槽点，不过在使用一段时间React后，我就改变了我的想法，这些一开始我吐槽的槽点，我反倒觉得设计有它的合理性。</p><p><img src="/2020/05/17/react-shi-yong-zong-jie/1.jpg" alt></p><p>由于我本身是一个Java开发，而React中使用了Typescript使得JS支持继承，因此在React的组件中，自定义的组件都需要继承React的Component组件，模型层的数据变量像极了JavaBean中的私有属性，而页面的事件方法可以和Java类中的方法对应上。至于<code>render()</code>方法，它是组件类里面的一个特殊方法，用于返回模板，<code>render()</code>是父类 Component 中的方法。因此当你写完一个React组件时，怎么看它都像一个Java类。和Java中的封装继承非常类似。前面说到了数据单向流也好理解了，为了不破坏组件的封装特性，就像Java中的私有变量，对别人不可见一样。所以我用着用着就开始喜欢上React了，因为它组件的设计思想和Java的封装有相通性，对我来说有种熟悉的感觉。</p><h2 id="React的起源"><a href="#React的起源" class="headerlink" title="React的起源"></a>React的起源</h2><p>学一样新东西就从它的历史开始吧，了解它的背景，才知道来龙去脉。React 起源于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设Instagram 的网站。做出来以后，发现这套东西很好用，就在2013年5月开源了。大厂就是很任性啊，不爽就自己搞一套，结果一不小心还成了行业标准了。准确来说，React不是一个完整的MVC框架，而是一个轻量级的视图层库。最多可以认为是MVC中的V（View），甚至React并不非常认可MVC开发模式。React 构建页面 UI 的库。可以简单地理解为，React 将将界面分成了各个独立的小块，每一个块就是组件，这些组件之间可以组合、嵌套，就成了我们的页面，似乎Vue也是这样。</p><h2 id="react-的特点"><a href="#react-的特点" class="headerlink" title="react 的特点"></a>react 的特点</h2><ol><li><strong>虚拟DOM</strong>: React是以数据驱动的，每次数据变化React都会扫描整个虚拟DOM树，自动计算与上次虚拟DOM的差异变化，然后针对需要变化的部分进行实际的浏览器DOM更新。</li><li><strong>组件化</strong>： react最核心的思想是将页面中任何一个区域或者元素都可以看做一个组件 component，那么什么是组件呢？组件指的就是同时包含了Html、Css、Js元素的聚合体。使用react开发的核心就是将页面拆分成若干个组件，并且react一个组件中同时耦合了Css、Js。可以理解为封装。这种模式整个颠覆了过去的传统的方式</li><li><strong>单项数据流</strong>：React只有单向数据流动-从父节点传递到子节点，其实reactjs的核心内容就是数据绑定，所谓数据绑定指的是只要将一些服务端的数据和前端页面绑定好，开发者只关注实现业务就行了</li><li><strong>JSX 语法</strong>：在React中，我们使用render函数来构建组件的dom结构性能较高，因为省去了查找和编译模板的过程，但是在render中利用createElement创建结构的时候代码可读性较低，较为复杂，此时可以利用jsx语法来在render中创建dom，解决这个问题，但是前提是需要使用工具来编译jsx</li></ol><h2 id="React的生态"><a href="#React的生态" class="headerlink" title="React的生态"></a>React的生态</h2><p>React不仅仅只是在PC端开发网页，在移动端也有React的身影，React Native可以像开发网页一样开发APP，由于它的跨平台性还挺火的。但当我去扒一扒它的生态圈时，会发现React远比我想象的强大</p><ul><li><code>Web端</code>: <strong>React-dom + React-router</strong></li><li><code>App</code>: <strong>React-native + React-navigation</strong>，让你像开发网页一样，开发App，这对于前端开发来说是好事，意味着一个写网页的开发，只需要很低的学习成本就能开发App了</li><li><code>VR</code>: <strong>React-360</strong>，它有什么用，React 360是一个创建3D和VR用户交互的框架.构建在React的基础之上，React是一个简化复杂UI创建的库，React 360可以让你用相似的工具和概念在网页上创建沉浸式的360度的内容。</li><li><code>多端统一解决方案</code>: <strong>Taro</strong>，这又是个啥呢？<strong>Taro</strong> 遵循 React 语法规范，它采用与 React 一致的组件化思想，组件生命周期与 React 保持一致，同时支持使用 JSX 语法，让代码具有更丰富的表现力，使用 <strong>Taro</strong> 进行开发可以获得和 React 一致的开发体验。<a href="https://taro.aotu.io/" target="_blank" rel="noopener">taro官网</a></li><li><code>状态管理</code>: redux/mobx…</li><li><code>UI框架</code>: antd/material，<strong>Antd</strong>是蚂蚁金服开源的基于React的UI框架</li><li><code>相关脚手架</code>: create-react-app/react-native-cli/umi…</li><li><code>调试工具</code>: react-devtools</li></ul><h2 id="JSX组件模板"><a href="#JSX组件模板" class="headerlink" title="JSX组件模板"></a>JSX组件模板</h2><p>JSX 是 JavaScript 语法的扩展。React 开发不一定使用 JSX ，但通常建议使用它，下面是一个常规的使用JSX定义的React组件</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 类构造方法</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>            test<span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">,</span>            strTest<span class="token punctuation">:</span><span class="token string">"测试"</span>      <span class="token comment" spellcheck="true">//初始化state中strTest值</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//点击事件方法，修改state域中的值，要使用setState方法</span>    handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> prestrTest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>strTest<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            test<span class="token punctuation">:</span>prestrTest        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// render方法返回模板</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">(</span>            <span class="token operator">&lt;</span>h1 onClick <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>strTest<span class="token punctuation">}</span>            <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 导出当前组件</span><span class="token keyword">export</span> <span class="token keyword">default</span> Test<span class="token punctuation">;</span></code></pre><p>React组件定义方式有两种，上面举例的组件定义方式叫类组件，还有一种定义方式叫函数组件，顾名思义就是通过函数还定义声明一个组件，定义组件有两个原则：</p><ol><li>组件名称必须以大写字母开头</li><li>组件的返回值只能有一个根元素</li></ol><p>无论是函数组件还是类组件都遵循这个原则，那么函数组件和类组件有什么区别呢</p><h3 id="函数组件"><a href="#函数组件" class="headerlink" title="函数组件"></a>函数组件</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">ProfilePage</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> showMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Followed '</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>showMessage<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>Follow<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="类组件"><a href="#类组件" class="headerlink" title="类组件"></a>类组件</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ProfilePage</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  showMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Followed '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>showMessage<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>Follow<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="组件的特点"><a href="#组件的特点" class="headerlink" title="组件的特点"></a>组件的特点</h3><ul><li>无论是使用函数或是类来声明一个组件，它决不能修改它自己的 <code>props</code>。</li><li>所有 React 组件都必须是纯函数，并禁止修改其自身 <code>props</code> 。</li><li>React是单项数据流，父组件改变了属性，那么子组件视图会更新。</li><li>属性 <code>props</code> 是外界传递过来的，状态 <code>state</code> 是组件本身的，状态可以在组件中任意修改</li><li>组件的属性和状态改变都会更新视图。</li></ul><h3 id="两种组件区别"><a href="#两种组件区别" class="headerlink" title="两种组件区别"></a>两种组件区别</h3><table><thead><tr><th>区别</th><th>函数组件</th><th>类组件</th></tr></thead><tbody><tr><td>是否有 <code>this</code></td><td>没有</td><td>有</td></tr><tr><td>是否有生命周期</td><td>没有</td><td>有</td></tr><tr><td>是否有状态 <code>state</code></td><td>没有</td><td>有</td></tr><tr><td>性能</td><td>高</td><td>低</td></tr></tbody></table><p>函数组件的性能比类组件的性能要高， 因为类组件使用的时候要实例化，而函数组件直接执行函数取返回结果即可</p><h3 id="导入外部样式"><a href="#导入外部样式" class="headerlink" title="导入外部样式"></a>导入外部样式</h3><p>在使用组件过程中，难免需要个性化一些开源组件的样式，这时就需要用到外部样式了，在React组件中怎么像Html引入<code>&lt;link rel=&quot;stylesheet&quot; href=&quot;&quot;&gt;</code>标签那样引入外部样式呢，我们定义的组件如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> TestChild <span class="token keyword">from</span> <span class="token string">"./TestChild"</span><span class="token punctuation">;</span><span class="token keyword">import</span> moduleCss <span class="token keyword">from</span> <span class="token string">"./test.css"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>     <span class="token operator">&lt;</span>div<span class="token operator">></span>       <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>moduleCss<span class="token punctuation">.</span>normal<span class="token punctuation">}</span><span class="token operator">></span><span class="token number">321321</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>       <span class="token operator">&lt;</span>TestChild<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>TestChild<span class="token operator">></span>     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Test<span class="token punctuation">;</span></code></pre><p>test.css内容如下</p><pre><code>:global(.btn) {    …}// more than one syle in gloabl:global {    .normal{      width:&#39;200px&#39;    }    .danger{      ...    }}</code></pre><h3 id="JSX中使用条件判断"><a href="#JSX中使用条件判断" class="headerlink" title="JSX中使用条件判断"></a>JSX中使用条件判断</h3><p>在react中用jsx渲染dom的时候经常会遇到if条件判断，然而在jsx中是不允许 if 条件判断的。以下有几种判断方式，可以根据自己的应用场景，挑选适合的。</p><h5 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h5><p>在 render 定义一个变量，然后写具体的逻辑，再把Html模板赋值给这个变量。最后在 return 方法中引用这个变量</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloMessage</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">let</span> userMessage<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>loggedIn<span class="token punctuation">)</span> <span class="token punctuation">{</span>      userMessage <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>span<span class="token operator">></span>          <span class="token operator">&lt;</span>h2<span class="token operator">></span><span class="token punctuation">{</span> <span class="token template-string"><span class="token string">`Welcome Back </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>          <span class="token operator">&lt;</span>p<span class="token operator">></span>You can visit settings to reset your password<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>      <span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      userMessage <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>h2<span class="token operator">></span>Hey man<span class="token operator">!</span> Sign <span class="token keyword">in</span> to see <span class="token keyword">this</span> section<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>      <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>h1<span class="token operator">></span>My Super React App<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>        <span class="token punctuation">{</span>userMessage<span class="token punctuation">}</span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h5><p>在render 定义一个函数，在函数中写具体逻辑，在 return 方法中调用刚刚定义的函数</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloMessage</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">renderUserMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>loggedIn<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>span<span class="token operator">></span>          <span class="token operator">&lt;</span>h2<span class="token operator">></span><span class="token punctuation">{</span> <span class="token template-string"><span class="token string">`Welcome Back </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>          <span class="token operator">&lt;</span>p<span class="token operator">></span>You can visit settings to reset your password<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>h2<span class="token operator">></span>Hey man<span class="token operator">!</span> Log <span class="token keyword">in</span> to see <span class="token keyword">this</span> section<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>h1<span class="token operator">></span>My Super React App<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>        <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderUserMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h5><p>JSX中虽然不能直接用 if 条件，但可以使用三元运算符，对于一些非黑即白的逻辑可以直接用三元运算符实现</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloMessage</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>h1<span class="token operator">></span>          <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>loggedIn <span class="token operator">?</span>  <span class="token string">'You are logged In'</span> <span class="token punctuation">:</span> <span class="token string">'You are not logged In'</span> <span class="token punctuation">}</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span></code></pre><h5 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a>方案四</h5><p>JSX中三元运算符不仅可以返回字符串，也可以返回Html模板</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloMessage</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  render <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span><span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>h1<span class="token operator">></span>My Super React App<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>        <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>loggedIn <span class="token operator">?</span>            <span class="token operator">&lt;</span>span<span class="token operator">></span>              <span class="token operator">&lt;</span>h2<span class="token operator">></span><span class="token punctuation">{</span> <span class="token template-string"><span class="token string">`Welcome Back </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>              <span class="token operator">&lt;</span>p<span class="token operator">></span>You can visit settings to reset your password<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>            <span class="token punctuation">:</span>            <span class="token operator">&lt;</span>h2<span class="token operator">></span>Hey man<span class="token operator">!</span> Log <span class="token keyword">in</span> to see <span class="token keyword">this</span> section<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>        <span class="token punctuation">}</span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="方案五"><a href="#方案五" class="headerlink" title="方案五"></a>方案五</h5><p>使用do表达式，关于do表达式的<a href="https://babeljs.io/docs/en/babel-plugin-proposal-do-expressions" target="_blank" rel="noopener">文档</a></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> Component <span class="token operator">=</span> props <span class="token operator">=</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'myComponent'</span><span class="token operator">></span>    <span class="token punctuation">{</span><span class="token keyword">do</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>color <span class="token operator">===</span> <span class="token string">'blue'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>BlueComponent<span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">}</span>      <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>color <span class="token operator">===</span> <span class="token string">'red'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>RedComponent<span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">}</span>      <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>color <span class="token operator">===</span> <span class="token string">'green'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>GreenComponent<span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span></code></pre><h3 id="JSX中使用循环"><a href="#JSX中使用循环" class="headerlink" title="JSX中使用循环"></a>JSX中使用循环</h3><p>JSX中使用循环生成标签，比如列表数据，自定义卡片等，循环有两种方式。需要注意的是，主流循环写法是 map，<code>JSX里面不能用for循环，因为for循环不是表达式</code>。</p><h4 id="forEach-for方式"><a href="#forEach-for方式" class="headerlink" title="forEach / for方式"></a>forEach / for方式</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">let</span> list<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token punctuation">{</span>    name<span class="token punctuation">:</span><span class="token string">"百度"</span><span class="token punctuation">,</span>    address<span class="token punctuation">:</span><span class="token string">"http://www.baidu.com"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    name<span class="token punctuation">:</span><span class="token string">"google"</span><span class="token punctuation">,</span>    address<span class="token punctuation">:</span><span class="token string">"http://www.google.cn"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    name<span class="token punctuation">:</span><span class="token string">"firefox"</span><span class="token punctuation">,</span>    address<span class="token punctuation">:</span><span class="token string">"https://home.firefoxchina.cn"</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ForEach</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//定义数组，将数据存入数组</span>    <span class="token keyword">const</span> elements1<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> elements2<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// forEach循环</span>    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>      elements1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>        <span class="token operator">&lt;</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>          <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>item<span class="token punctuation">.</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// for循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>list<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        elements1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token operator">></span>              <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>              <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>          <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token punctuation">{</span>elements1<span class="token punctuation">}</span>        <span class="token punctuation">{</span>elements2<span class="token punctuation">}</span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ForEach<span class="token punctuation">;</span></code></pre><h4 id="map方式"><a href="#map方式" class="headerlink" title="map方式"></a>map方式</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 定义一个数组</span><span class="token keyword">var</span> bookArr<span class="token operator">=</span><span class="token punctuation">[</span>    <span class="token punctuation">{</span>        siteName<span class="token punctuation">:</span><span class="token string">"百度"</span><span class="token punctuation">,</span>        siteUrl<span class="token punctuation">:</span><span class="token string">"http://www.baidu.com"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        siteName<span class="token punctuation">:</span><span class="token string">"阿里巴巴"</span><span class="token punctuation">,</span>        siteUrl<span class="token punctuation">:</span><span class="token string">"http://www.alibaba.com"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        siteName<span class="token punctuation">:</span><span class="token string">"腾讯"</span><span class="token punctuation">,</span>        siteUrl<span class="token punctuation">:</span><span class="token string">"http://www.qq.com"</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div<span class="token operator">></span>                <span class="token punctuation">{</span>                    bookArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>                        <span class="token keyword">return</span><span class="token punctuation">(</span>                            <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">></span>                                <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>item<span class="token punctuation">.</span>siteName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>                                <span class="token operator">&lt;</span>p<span class="token operator">></span>网站：<span class="token punctuation">{</span>item<span class="token punctuation">.</span>siteUrl<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>                                <span class="token operator">&lt;</span>hr<span class="token operator">/</span><span class="token operator">></span>                            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>                        <span class="token punctuation">)</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Book<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java服务CPU飙到99%</title>
      <link href="/2020/05/16/java-fu-wu-cpu-biao-dao-99/"/>
      <url>/2020/05/16/java-fu-wu-cpu-biao-dao-99/</url>
      
        <content type="html"><![CDATA[<p>前两天测试找到我说风控系统压测时CPU飙高到了95%，询问一下我是可能什么原因。这个风控系统是我之前参与搭建和开发的，现在系统在进行上线前的压测。由于项目已经交接给另一个团队了，本着学习的精神，于是我去查了一下日志，但是日志太多了，并没有看出什么问题。于是便用上了jdk自带的监控工具，在此记录一下过程</p><p><img src="/2020/05/16/java-fu-wu-cpu-biao-dao-99/1.jpg" alt></p><h2 id="找到导致CPU飙升的线程"><a href="#找到导致CPU飙升的线程" class="headerlink" title="找到导致CPU飙升的线程"></a>找到导致CPU飙升的线程</h2><p>首先需要定位到是服务里的那些线程导致CPU飙升的，我们的服务是Java服务，只关注Java进程即可，命令如下</p><h3 id="1-执行top命令"><a href="#1-执行top命令" class="headerlink" title="1 执行top命令"></a>1 执行top命令</h3><p>在服务器上通过命令行输入 <strong>top</strong> 命令可以查到服务的进程号。一般CPU占用高的会排在最前面，由于公司的项目运行在内网，没有实际的cpu飙高信息，下面举个例子</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@VM_0_3_centos ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># top</span><span class="token function">top</span> - 22:56:02 up 228 days,  3:51,  1 user,  load average: 0.08, 0.14, 0.12Tasks:  75 total,   1 running,  74 sleeping,   0 stopped,   0 zombie%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  1.0 us,  1.3 sy,  0.0 ni, 97.3 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 stKiB Mem <span class="token keyword">:</span>  1015024 total,    69356 free,   513292 used,   432376 buff/cacheKiB Swap:        0 total,        0 free,        0 used.   334880 avail Mem   PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND11115 root      20   0 2299632 145836   3304 S  0.3 14.4 313:38.63 java    2 root      20   0       0      0      0 S  0.0  0.0   0:01.45 kthreadd                         3 root      20   0       0      0      0 S  0.0  0.0   8:38.85 ksoftirqd/0                 5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0       8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh            </code></pre><h3 id="2-执行-top-H-p-pid-命令"><a href="#2-执行-top-H-p-pid-命令" class="headerlink" title="2 执行 top -H -p $pid 命令"></a>2 执行 top -H -p $pid 命令</h3><p>通过此命令可以看到具体是哪个线程占用了CPU，如上面的是11115线程占用cpu最高，便执行<code>top -H -p 11115</code>，然后记下该占用cpu最高的线程的id，如下是 11116 占用了较高的cpu资源</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@VM_0_3_centos ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># top -H -p 11115</span><span class="token function">top</span> - 23:01:21 up 228 days,  3:56,  1 user,  load average: 0.01, 0.07, 0.11Threads:  26 total,   0 running,  26 sleeping,   0 stopped,   0 zombie%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  1.0 us,  0.3 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 stKiB Mem <span class="token keyword">:</span>  1015024 total,    70288 free,   510980 used,   433756 buff/cacheKiB Swap:        0 total,        0 free,        0 used.   337152 avail Mem   PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND 11116 root      20   0 2299632 145836   3304 S  0.2 14.4   0:03.08 java11117 root      20   0 2299632 145836   3304 S  0.0 14.4   9:41.75 java 11118 root      20   0 2299632 145836   3304 S  0.0 14.4   0:00.01 java 11119 root      20   0 2299632 145836   3304 S  0.0 14.4   0:00.00 java 11120 root      20   0 2299632 145836   3304 S  0.0 14.4   0:00.00 java11121 root      20   0 2299632 145836   3304 S  0.0 14.4   1:37.22 java11122 root      20   0 2299632 145836   3304 S  0.0 14.4   1:37.17 java11123 root      20   0 2299632 145836   3304 S  0.0 14.4   0:00.00 java11124 root      20   0 2299632 145836   3304 S  0.0 14.4 257:43.10 java 11150 root      20   0 2299632 145836   3304 S  0.0 14.4  11:57.31 java11152 root      20   0 2299632 145836   3304 S  0.0 14.4  12:32.29 java                                                                                                                   </code></pre><h2 id="查看对应线程的堆栈信息"><a href="#查看对应线程的堆栈信息" class="headerlink" title="查看对应线程的堆栈信息"></a>查看对应线程的堆栈信息</h2><p>找到了cpu飙高的线程后，最终要的是要查看线程的堆栈信息，不然你也不知道这个线程为什么飙高了，这个线程在干什么。需要要到jdk的监控工具</p><h3 id="执行-jstack-pid-gt-tmp-log-txt-命令"><a href="#执行-jstack-pid-gt-tmp-log-txt-命令" class="headerlink" title="执行  jstack pid  &gt; /tmp/log.txt 命令"></a>执行  jstack pid  &gt; /tmp/log.txt 命令</h3><p>如刚刚的例子中，执行 <code>jstack 11115  &gt; /tmp/log.txt</code> ，注意这里11115是进程的pid，而不是线程的。这个命令会把该进程的所有堆栈信息输出到文件</p><pre><code>[root@VM_0_3_centos ~]#  jstack 11115  &gt; /tmp/log.txt  [root@VM_0_3_centos ~]# </code></pre><h3 id="根据线程id-查看堆栈信息"><a href="#根据线程id-查看堆栈信息" class="headerlink" title="根据线程id 查看堆栈信息"></a>根据线程id 查看堆栈信息</h3><p>由于堆栈日志 线程id是16进制的，所以需要先将10进制的线程id转为16进制，如刚刚11116线程id要转为16进制数，再去生成的log.txt文件中根据16进制数搜索。我们来看一下输出的日志文件内容</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>root<span class="token annotation punctuation">@VM_0_3_centos</span> <span class="token operator">~</span><span class="token punctuation">]</span># tail <span class="token operator">-</span>f <span class="token operator">/</span>tmp<span class="token operator">/</span>log<span class="token punctuation">.</span>txt         at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>Reference<span class="token punctuation">.</span><span class="token function">tryHandlePending</span><span class="token punctuation">(</span>Reference<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>        <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x00000000f5b93448</span><span class="token operator">></span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>Reference$Lock<span class="token punctuation">)</span>        at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>Reference$ReferenceHandler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Reference<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">153</span><span class="token punctuation">)</span><span class="token string">"VM Thread"</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x00007f0b20095000</span> nid<span class="token operator">=</span><span class="token number">0x2b6d</span> runnable <span class="token string">"VM Periodic Task Thread"</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x00007f0b200de000</span> nid<span class="token operator">=</span><span class="token number">0x2b74</span> waiting on condition JNI global references<span class="token operator">:</span> <span class="token number">948</span></code></pre><p>其中nid就是线程id</p><h2 id="CPU飙高的原因总结"><a href="#CPU飙高的原因总结" class="headerlink" title="CPU飙高的原因总结"></a>CPU飙高的原因总结</h2><p>cpu飙高的可能原因无非是线程一直在占用cpu的资源。一般java服务有以下情况会出现cpu飙高的情况，在此总结一下</p><h3 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a><code>内存问题</code></h3><p>导致JVM频繁GC，此时服务占用CPU资源的主要是GC线程，而不是业务线程。多个线程的CPU都超过了100%，通过jstack命令可以看到这些线程主要是垃圾回收线程。通过jstat命令监控GC情况，可以看到Full GC次数非常多，并且次数在不断增加。</p><h3 id="死锁问题"><a href="#死锁问题" class="headerlink" title="死锁问题"></a><code>死锁问题</code></h3><p>多线程场景下出现死锁也会导致cpu飙高，直接在输入的堆栈日志文件中搜索关键字：deadlock.。会打印出业务死锁的位置。至于出现死锁的原因就不多说了，可以去查一下，然后把死锁解决</p><h3 id="代码问题"><a href="#代码问题" class="headerlink" title="代码问题"></a><code>代码问题</code></h3><p>这个说的有点笼统，如某些复杂算法，算法BUG，导致无限循环递归等等。这个是比较好定位的，日志文件中同一个线程的日志信息会反复出现，稍加排查基本就能定位到具体的代码位置了</p><h3 id="阻塞性操作"><a href="#阻塞性操作" class="headerlink" title="阻塞性操作"></a><code>阻塞性操作</code></h3><p>代码某个位置有阻塞性的操作，导致该功能调用整体比较耗时，但出现是比较随机的；平时消耗的CPU不多，而且占用的内存也不高。但在压测场景下出现CPU飙高。可通过压测工具不断加大访问力度，首先找到该代码位置，由于压测大量线程将阻塞于该阻塞点，例如出现</p><pre class=" language-java"><code class="language-java"><span class="token string">"http-nio-8080-exec-4"</span> #<span class="token number">31</span> daemon prio<span class="token operator">=</span><span class="token number">5</span> os_prio<span class="token operator">=</span><span class="token number">31</span> tid<span class="token operator">=</span><span class="token number">0x00007fd08d0fa000</span> nid<span class="token operator">=</span><span class="token number">0x6403</span> waiting on condition <span class="token punctuation">[</span><span class="token number">0x00007000033db000</span><span class="token punctuation">]</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>State<span class="token operator">:</span> <span class="token function">TIMED_WAITING</span> <span class="token punctuation">(</span>sleeping<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//期限等待</span> at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span> at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">340</span><span class="token punctuation">)</span> at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>TimeUnit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">386</span><span class="token punctuation">)</span> at com<span class="token punctuation">.</span>*<span class="token punctuation">.</span>user<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>UserController<span class="token punctuation">.</span><span class="token function">detail</span><span class="token punctuation">(</span>UserController<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//业务代码阻塞点</span></code></pre><p>找到业务代码阻塞点，这里业务代码使用了TimeUnit.sleep()方法，使线程进入了TIMED_WAITING(期限等待)状态。</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>红黑树原理</title>
      <link href="/2020/05/11/hong-hei-shu-yuan-li/"/>
      <url>/2020/05/11/hong-hei-shu-yuan-li/</url>
      
        <content type="html"><![CDATA[<p>说到红黑树，让人又爱又恨啊，真是一种令人头大的数据结构。我也没少被他折磨过，尽管在工作中，在网文中多次看到过关于它的原理解释，但大多都是一上来就是五条定义，然后紧跟着就是红黑树插入的代码实现，翻转代码实现，让人难以理解消化，搞的人云里雾里的。这是因为五条定义以及代码实现都是红黑树定义和实现的精炼结果了，如果连红黑树的设计思想，它的推演过程都不知道，就直接把一个研究成果丢过来，搁谁也难以通过结果反向去理解它的实现原理吧。本文介绍对红黑树推演过程，看完此文保证对红黑树的定义，翻转可以轻松理解了。网上也有很多类似的文章，不过我决定对红黑树这个老大难做一次全面彻底的总结。</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/1.jpg" alt></p><h2 id="红黑树的定义"><a href="#红黑树的定义" class="headerlink" title="红黑树的定义"></a>红黑树的定义</h2><p>先摆一下红黑树的官方定义吧，红黑树是每个节点都带有颜色属性的二叉查找树，颜色或红色或黑色。在二叉树强制一般要求以外，对于任何有效的红黑树我们增加了如下的额外要求，也叫红黑树的五大定义</p><ol><li>节点是红色或黑色。 </li><li>根节点是黑色</li><li>所有叶子都是黑色。（叶子是NUIL节点，也叫空节点）</li><li>如果一个节点是红色，则它的子节点必须是黑色</li><li>从一个节点到该节点的所有叶节点的路径包含相同数目的黑色节点</li></ol><p>这些约束强制了红黑树的关键性质: 从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的。因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的。因为红黑树是一种特化的二叉查找树，所以红黑树上的查找与普通二叉查找树相同。</p><h2 id="红黑树的用途"><a href="#红黑树的用途" class="headerlink" title="红黑树的用途"></a>红黑树的用途</h2><p>在推演红黑树之前，再来了解一下红黑树的用途吧，明白它在计算机科学中有多重要。</p><h3 id="JDK的Map"><a href="#JDK的Map" class="headerlink" title="JDK的Map"></a>JDK的Map</h3><p>在我们愉快的使用Java给我提供的集合类时，却很少会去想它们为什么这么好用吧（用就完事了，想那么多干嘛，是嫌头发太多了吗 ！）在Java的集合类中有两个使用到了红黑树数据结构，分别是 <code>TreeMap</code> 和 <code>HashMap</code>。其中 HashMap是JDK在1.8之后才使用的，用于提升HashMap的性能。</p><h3 id="Linux非实时任务调度"><a href="#Linux非实时任务调度" class="headerlink" title="Linux非实时任务调度"></a>Linux非实时任务调度</h3><p>Linux 的稳定内核版本在 2.6.24 之后，使用了新的调度程序 CFS，所有非实时可运行进程都以虚拟运行时间为 key 值挂在一棵红黑树上，以完成更公平高效地调度所有任务。CFS 弃用 active /expired 数组和动态计算优先级，不再跟踪任务的睡眠时间和区别是否交互任务，并且在调度中采用基于时间计算键值的红黑树来选取下一个任务，根据所有任务占用 CPU 时间的状态来确定调度任务优先级。</p><h3 id="Linux虚拟内存"><a href="#Linux虚拟内存" class="headerlink" title="Linux虚拟内存"></a>Linux虚拟内存</h3><p>32 位 Linux 内核虚拟地址空间划分 0－3G 为用户空间，3－4G 为内核空间，因此每个进程可以使用 4GB的虚拟空间。同时，Linux 定义了虚拟存储区域( VMA) 以便于更好表示进程所使用的虚拟空间，每个 VMA是某个进程的一段连续虚拟空间，其中的单元具有相同的特征，所有的虚拟区域按照地址排序由指针链接为一个链表。当发生缺页中断时搜索 VMA 到指定区域时，则需要频繁操作，因此选用了红黑树以减少查找时间。</p><h2 id="红黑树的推演过程"><a href="#红黑树的推演过程" class="headerlink" title="红黑树的推演过程"></a>红黑树的推演过程</h2><p>来到这里，就请耐心看完吧，因为真正精彩的才刚刚开始。红黑树的起源，自然是二叉查找树了，对于二叉树的概念就不说了非常简单。</p><h3 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h3><p>这种树结构从根节点开始，左子节点小于它，右子节点大于它。每个节点都符合这个特性，所以易于查找，是一种很好的数据结构。但是它有一个问题，就是容易偏向某一侧，这样就像一个链表结构了，失去了树结构的优点，查找时间会变坏。所以我们都希望树结构都是矮矮胖胖的，就像左边这样，而右边的就是极端情况的二叉树，已经退化成一个链表了</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/2.png" alt></p><p>基于这种需求，平衡树的概念就应运而生了。平衡树简单的意思就是当二叉树出现右边这种极端情况时，把这颗树重新构造成一颗新的有左右子树的二叉树，这样所有节点的数据查找效率就会相对均衡。例如把上图中右边极端情况下的二叉树重新构造成如下结构</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/4.png" alt></p><p>红黑树就是一种平衡树，它可以保证二叉树基本符合矮矮胖胖的结构，但是在理解红黑树之前，必须先了解另一种树，叫2-3树，红黑树背后的实现原理就是它。</p><h3 id="2-3树的概念"><a href="#2-3树的概念" class="headerlink" title="2-3树的概念"></a>2-3树的概念</h3><p>2-3树是二叉树的变种，它存在两种类型的节点，把这两种节点分别叫做2-节点和3-节点，树中的2和3分别代表节点有几个子节点。</p><ul><li><code>2-节点</code>：也叫普通节点，包含一个元素，拥有两个子节点</li><li><code>3-节点</code>：它是2-节点的扩充版，包含两个元素，拥有三个子节点。对于3-节点有这样一个排列约束，如下图中最左边的子节点3小于父节点5，中间的子节点7大小介于父节点5和10之间，最右边的11大于父节点10</li></ul><p><img src="/2020/05/11/hong-hei-shu-yuan-li/5.png" alt></p><p>在这两种节点的配合下，2-3树可以保证在插入值过程中，任意叶子节点到根节点的距离都是相同的。完美实现了矮胖矮胖的目标。怎么配合的呢，下面来看2-3树的构造过程。</p><h3 id="2-3树的构造"><a href="#2-3树的构造" class="headerlink" title="2-3树的构造"></a>2-3树的构造</h3><p>我们从零开始构造一颗2-3树，如果你的想象力足够强大，你可以边读边在脑海中形成一个构造树的动画过程，如果不行的话可以用笔在纸上画一画。我们知道在二叉查找树中，插入过程从根节点开始比较，小于节点值往右继续与左子节点比，大于则继续与右子节点比，直到某节点左或右子节点为空，把值插入进去。但在2-3树中，情况稍微有些变化，因为2-3树中存在两种不同的节点类型，插入思路大致如下：</p><ol><li>如果将值插入一个2-节点，则将2-节点扩充为一个3-节点。</li><li>如果将值插入一个3-节点，分为以下几种情况。下面会分别讨论这几种情况</li></ol><h4 id="3-节点没有父节点"><a href="#3-节点没有父节点" class="headerlink" title="3-节点没有父节点"></a>3-节点没有父节点</h4><p>即整棵树就只有它一个3-节点。此时，将3-节点扩充为一个4-节点，即包含三个元素的节点，这违背了2-3树的定义，因此将其分解重组，变成一棵二叉树。</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/6.png" alt></p><p>此时二叉树依然保持平衡。</p><h4 id="3-节点有一个2-节点的父节点"><a href="#3-节点有一个2-节点的父节点" class="headerlink" title="3-节点有一个2-节点的父节点"></a>3-节点有一个2-节点的父节点</h4><p>此时的操作是，3-节点扩充为4-节点，然后分解重组4-节点，然后将分解后的新树的父节点融入到原来2-节点的父节点中去，形成一个3-节点。这个过程稍微有点复杂，直接上图，跟着图中箭头走一遍。</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/8.png" alt></p><h4 id="3-节点有一个3-节点的父节点"><a href="#3-节点有一个3-节点的父节点" class="headerlink" title="3-节点有一个3-节点的父节点"></a>3-节点有一个3-节点的父节点</h4><p>3-节点有一个3-节点要插入时，就有点复杂了，因此3-节点插入一个节点后会变成4-节点，此时违背了2-3树的定义，3-节点会分解重组成2-节点，生成的新树的父节点会融入到原本的父级，而原本的父级也是一个3-节点，融入一个新节点后会变成4-节点，又违背了2-3树的定义，于是继续分解重组，整个树增加一层，仍然保持平衡。为了便于直观理解，直接上图吧，下图从零构建一颗2-3树</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/10.png" alt="2-3数构建过程"></p><p>图中最后构建出了一个有6个数据的2-3树，可以看出最后2-3树包含两个2-节点，最完美的地方在于，从根节点到每个叶子节点的路径长度是一样的。可以说是一颗完美的树。因此2-3树的设计完全可以保证二叉树保持矮矮胖胖的状态，保持其性能良好。但是，将这种直白的表述写成代码实现起来并不方便，因为要处理的情况太多。这样需要维护两种不同类型的节点，将链接和其他信息从一个节点复制到另一个节点，将节点从一种类型转换为另一种类型等等，因此红黑树登场了。</p><h3 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h3><p>红黑树的背后逻辑就是2-3树的逻辑，<code>红黑树使用了红色来标记2-节点（包含两个元素的节点）中左边的那个元素，黑色用于标记普通节点（包含一个元素的节点）和2-节点中右边的那个元素，总而言之，可以大致理解为用红色标记2-节点，用黑色标记普通节点</code>。如果要直接从红黑树的代码去理解它是如何工作的以及背后的道理，就比较困难了。所以你一定要理解它的演化过程，才能真正的理解红黑树。基于这个结论，我们可以非常简单的把刚刚得到的2-3树，转换成一颗红黑树</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/11.png" alt="2-3树转换成红黑树"></p><p>只需三步就可以把一颗2-3树变为红黑树，实际上2-3树已经是一颗红黑树了</p><ol><li>把2-3树中所有3-节点的两个元素分开</li><li>把3-节点中的左元素标记为红色，右元素标记为黑色，普通节点标记为黑色</li><li>把3-节点展开，注意3-节点展开时，两个左边的子节点要划给红元素。此外，展开时3-节点中的红元素总是向左下方倾斜，3-节点中的黑元素总是向右上方倾斜</li></ol><p>至此红黑树的构造过程就结束了，红色树的构造，插入就是2-3树的插入逻辑，至于左旋，右旋其实就对应于2-3树出现4-时分解重组成2-节点的过程。我再把刚刚得到的红黑树中的红节点摆平，又可以还原成一颗2-3树了，如下图</p><p><img src="/2020/05/11/hong-hei-shu-yuan-li/12.png" alt="红黑树还原成2-3树"></p><h2 id="Java实现红黑树"><a href="#Java实现红黑树" class="headerlink" title="Java实现红黑树"></a>Java实现红黑树</h2><p>如果能很好的理解2-3树，基本红黑树也就不是问题了，最后可以按照2-3树的思路，尝试去实现一下红黑树的插入，查找删除逻辑。这里我贴一份红黑树的Java实现，代码中有比较多的注释，方便理解查阅</p><h3 id="NodeColor-java"><a href="#NodeColor-java" class="headerlink" title="NodeColor.java"></a>NodeColor.java</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NodeColor</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String Red <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String Black <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="RedBlackTreeNode-java"><a href="#RedBlackTreeNode-java" class="headerlink" title="RedBlackTreeNode.java"></a>RedBlackTreeNode.java</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedBlackTreeNode</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String color<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> key<span class="token punctuation">;</span>    <span class="token keyword">private</span> RedBlackTreeNode left<span class="token punctuation">;</span>    <span class="token keyword">private</span> RedBlackTreeNode right<span class="token punctuation">;</span>    <span class="token keyword">private</span> RedBlackTreeNode parent<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//构造Nil结点</span>    <span class="token keyword">public</span> <span class="token function">RedBlackTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//构造结点</span>    <span class="token keyword">public</span> <span class="token function">RedBlackTreeNode</span><span class="token punctuation">(</span>String color<span class="token punctuation">,</span> <span class="token keyword">int</span> key<span class="token punctuation">,</span> RedBlackTreeNode left<span class="token punctuation">,</span> RedBlackTreeNode right<span class="token punctuation">,</span> RedBlackTreeNode parent<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取颜色</span>    <span class="token keyword">public</span> String <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置颜色</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span>String color<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取值</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> key<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置值</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取左子树</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> left<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置左子树</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLeft</span><span class="token punctuation">(</span>RedBlackTreeNode left<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取右子树</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> right<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置右子树</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRight</span><span class="token punctuation">(</span>RedBlackTreeNode right<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取父结点</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> parent<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置父结点</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParent</span><span class="token punctuation">(</span>RedBlackTreeNode parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="RedBlackTree-java"><a href="#RedBlackTree-java" class="headerlink" title="RedBlackTree.java"></a>RedBlackTree.java</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedBlackTree</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> RedBlackTreeNode nil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedBlackTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> RedBlackTreeNode root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedBlackTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//构造空红黑树</span>    <span class="token keyword">public</span> <span class="token function">RedBlackTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        root <span class="token operator">=</span> nil<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//创建结点</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">RB_NODE</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>        RedBlackTreeNode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedBlackTreeNode</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nil<span class="token punctuation">,</span> nil<span class="token punctuation">,</span> nil<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> node<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//判断是否为Nil结点</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>RedBlackTreeNode node<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> node <span class="token operator">==</span> nil<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>           <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取根结点</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//设置根结点</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRoot</span><span class="token punctuation">(</span>RedBlackTreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//插入结点</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RB_INSERT</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode z<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//临时变量结点y，存储临时结点，默认为Nil</span>        RedBlackTreeNode y <span class="token operator">=</span> T<span class="token punctuation">.</span>nil<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x初试为根结点</span>        RedBlackTreeNode x <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//循环二查找合适的插入点</span>        <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//保存当前结点，作为结果的根结点</span>            y <span class="token operator">=</span> x<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> z<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> x<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//查找左子树</span>                x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//查找右子树</span>                x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//临时结点y设置为插入点的父结点</span>        z<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>  <span class="token function">IsNil</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//空树时设置z为根结点        </span>            T<span class="token punctuation">.</span><span class="token function">setRoot</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> z<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> y<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//插入为左子树</span>            y<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//插入为右子树</span>            y<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//将插入结点的左右子树设为Nil，颜色为红色，已经在构造时设置过，可以省略</span>        z<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>nil<span class="token punctuation">)</span><span class="token punctuation">;</span>        z<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>nil<span class="token punctuation">)</span><span class="token punctuation">;</span>        z<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//插入调整</span>        <span class="token function">RB_INSERT_FIXUP</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//插入调整</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RB_INSERT_FIXUP</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode z<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//当z的父结点为红色时，插入结点和父结点同为红色，需要调整</span>        <span class="token keyword">while</span><span class="token punctuation">(</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//插入结点的父结点是祖父节点的左子树</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//y定义为叔叔结点</span>                RedBlackTreeNode y <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//case1：如果叔叔结点为红色，上层父结点和叔叔结点设为黑色，祖父节点设为红色</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> y<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">{</span>                    z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    y<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//祖父结点设为z</span>                    z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//case2：插入结点为父结点的右子树，（叔叔结点一定为黑色）,父结点设为z，对z左旋</span>                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> z <span class="token operator">==</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//对父结点左旋</span>                    z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//case3：插入结点为父结点的左子树，（叔叔结点一定为黑色），父结点设为黑色，祖父结点设为红色，对祖父结点右旋</span>                z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//插入结点的父结点是祖父节点的右子树，同理，方向交换</span>            <span class="token keyword">else</span><span class="token punctuation">{</span>                RedBlackTreeNode y <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> y<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">{</span>                    z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    y<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> z <span class="token operator">==</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>                    z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//删除结点子函数，把根结点为u的子树替换为根结点为v的子树</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RB_TRANSPLANT</span><span class="token punctuation">(</span> RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode u<span class="token punctuation">,</span> RedBlackTreeNode v<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//u为根结点</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            T<span class="token punctuation">.</span>root <span class="token operator">=</span> v<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//u为左子树</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> u <span class="token operator">==</span> u<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            u<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//u为右子树</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>            u<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//父结点交换</span>        v<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//查找后继</span>    <span class="token keyword">public</span> RedBlackTreeNode <span class="token function">TREE_MINIMUM</span><span class="token punctuation">(</span>RedBlackTreeNode x<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//不断查找左子树</span>        <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> x<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//删除结点</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RB_DELETE</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode z<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//临时结点y保存即将删除的结点z信息</span>        RedBlackTreeNode y <span class="token operator">=</span> z<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//在结点删除或者移动前必须保存结点的颜色</span>        String yOriginColor <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//临时结点x，用于记录y的位置</span>        RedBlackTreeNode x <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//case1：z无左子树，直接将右子树置于z位置</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            x <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">RB_TRANSPLANT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//case2：z无右子树，直接将左子树置于z位置</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            x <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">RB_TRANSPLANT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//case3：z有左右子树</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//找到右子树中最小的结点，即z的后继</span>            y <span class="token operator">=</span> <span class="token function">TREE_MINIMUM</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//删除的实际是y的位置的结点，要记录y的颜色</span>            yOriginColor <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//y可能有右孩子，一定无左孩子，保存右孩子</span>            x <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//若y为z的右孩子，直接相连</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> z <span class="token punctuation">)</span><span class="token punctuation">{</span>                x<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//若不相连</span>            <span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token function">RB_TRANSPLANT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> y<span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                y<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                y<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">RB_TRANSPLANT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> z<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>            y<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            y<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>            y<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//删除结点为黑色时需要调整</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> yOriginColor <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">RB_DELETE_FIXUP</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//删除调整</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RB_DELETE_FIXUP</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode x<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//临时结点</span>        RedBlackTreeNode w <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//非根结点且为黑色</span>        <span class="token keyword">while</span><span class="token punctuation">(</span> x <span class="token operator">!=</span> T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//x为父结点左孩子</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">==</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//w为兄弟结点</span>                w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//case1：w兄弟结点为红色</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//w设为黑色</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>  NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//被删结点的父结点设为黑色</span>                    x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//对x的父结点左旋</span>                    <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//更新x的兄弟结点</span>                    w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//case2：w兄弟结点和两个孩子结点都为黑</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//w设为黑色</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//重设x为x的父结点</span>                    x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//case3：w兄弟结点为黑，w的左孩子为红，右孩子为黑</span>                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//w的左孩子设为黑</span>                    w<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//w设为红</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//右旋</span>                    <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//更新w</span>                    w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//case4：w兄弟结点为黑，w的右孩子为红</span>                w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                w<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                x <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//x为父结点右孩子</span>            <span class="token keyword">else</span><span class="token punctuation">{</span>                w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">{</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>  NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">;</span>                    x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span> NodeColor<span class="token punctuation">.</span>Red <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NodeColor<span class="token punctuation">.</span>Black <span class="token punctuation">)</span><span class="token punctuation">{</span>                    w<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                    w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>                    w <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                w<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                w<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                x <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        x<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>NodeColor<span class="token punctuation">.</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//左旋</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">LEFT_ROTATE</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode x<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//左旋结点右子树不能为空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//定义y结点</span>        RedBlackTreeNode y <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//y左子树 -> x右子树</span>        x<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x -> y左子树父结点</span>        y<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x父结点 -> y父结点</span>        y<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//y -> x父结点左/右子树或根结点</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//x为根结点，y设为根结点</span>            T<span class="token punctuation">.</span><span class="token function">setRoot</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//x为左子树，y设为左子树</span>            x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//x为右子树，y设为右子树</span>            x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//x -> y左子树</span>        y<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//y -> x父结点</span>        x<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//右旋</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RIGHT_ROTATE</span><span class="token punctuation">(</span>RedBlackTree T<span class="token punctuation">,</span> RedBlackTreeNode x<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//右旋结点父结点不能为空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//定义y结点</span>        RedBlackTreeNode y <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x右子树 -> y左子树</span>        y<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//y -> x右子树父结点</span>        x<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//y父结点 -> x父结点</span>        x<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x -> y父结点左/右子树或根结点</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//y为根结点，x设为根结点</span>            T<span class="token punctuation">.</span><span class="token function">setRoot</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//y为左子树，x设为左子树</span>            y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//y为右子树，x设为右子树</span>            y<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//y -> x右子树</span>        x<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//x -> y父结点</span>        y<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//前序遍历</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preorder</span><span class="token punctuation">(</span>RedBlackTreeNode t<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IsNil</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">preorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">preorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//中序遍历</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">midorder</span><span class="token punctuation">(</span>RedBlackTreeNode t<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IsNil</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">midorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">midorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//后序遍历</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postorder</span><span class="token punctuation">(</span>RedBlackTreeNode t<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IsNil</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">postorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">postorder</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="Test-java"><a href="#Test-java" class="headerlink" title="Test.java"></a>Test.java</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        RedBlackTree T <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedBlackTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RedBlackTreeNode node1 <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">RB_NODE</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        T<span class="token punctuation">.</span><span class="token function">RB_INSERT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> node1<span class="token punctuation">)</span><span class="token punctuation">;</span>        RedBlackTreeNode node2 <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">RB_NODE</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        T<span class="token punctuation">.</span><span class="token function">RB_INSERT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> node2<span class="token punctuation">)</span><span class="token punctuation">;</span>        RedBlackTreeNode node3 <span class="token operator">=</span> T<span class="token punctuation">.</span><span class="token function">RB_NODE</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        T<span class="token punctuation">.</span><span class="token function">RB_INSERT</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> node3<span class="token punctuation">)</span><span class="token punctuation">;</span>        T<span class="token punctuation">.</span><span class="token function">preorder</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>H5视频流加密</title>
      <link href="/2020/05/10/h5-shi-pin-liu-jia-mi/"/>
      <url>/2020/05/10/h5-shi-pin-liu-jia-mi/</url>
      
        <content type="html"><![CDATA[<p>之前做过在页面上实现音频播放功能，但是业务又提出一个需求，就是音频只能在线播放，不允许下载。经过一番研究发现前端页面屏蔽下载功能只是个障眼法，用户可以直接请求后端接口下载得到原音频文件，因此要实现禁止下载功能还是得在后端接口上做文章，一开始的思路，在下载接口上加一些同源，token认证之类的权限校验，不满足条件则不允许下载。不过后来又觉得不行，因为这些参数都是可以模拟的，如果这些用户模拟这些参数向接口发送请求，一样可以得到原文件。于是又想到了另一种方案，即后端接口对原文件加密，输出加密后的文件，前端播放时再解密。这样即使直接请求后端接口得到的也是加密后的文件，无法播放。</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/1.jpg" alt></p><p>在此做一下记录，前端有两种方案，第一种是通过BlobURL访问资源，对于大文件，这种方式性能上会好很多。第二种是使用DataURL将源文件转为base64，这种方式看不到访问路径，前端也无法下载，可以满足需求，但是对于大文件不建议使用这种方式</p><h2 id="Blob-URL方式"><a href="#Blob-URL方式" class="headerlink" title="Blob URL方式"></a>Blob URL方式</h2><p>Blob URL是blob协议得URL，它的格式是：<code>blob:http://xxx</code>。Blob URL可以通过<code>URL.createObjectURL(blob)</code>创建。在绝大部分场景下，我们可以像使用Http协议得URL一样使用Blob URL。这种方式要把整个文件先下载下来，然后创建URL，对于非常大的文件例如视频流，其实也不建议使用。</p><h3 id="Java接口代码"><a href="#Java接口代码" class="headerlink" title="Java接口代码"></a>Java接口代码</h3><pre class=" language-java"><code class="language-java">   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/audio/player"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">player</span><span class="token punctuation">(</span>                         HttpServletRequest request<span class="token punctuation">,</span>                         HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"F:\\test\\十年.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"音频文件不存在 --> 404"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String range <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>range <span class="token operator">==</span> null<span class="token punctuation">)</span>            range <span class="token operator">=</span> <span class="token string">"bytes=0-"</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        range <span class="token operator">=</span> rs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> length <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> irange <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>        length <span class="token operator">=</span> length <span class="token operator">-</span> irange<span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Accept-Ranges"</span><span class="token punctuation">,</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Range"</span><span class="token punctuation">,</span> <span class="token string">"bytes "</span> <span class="token operator">+</span> range <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"audio/mpeg;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        OutputStream os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token punctuation">;</span>        FileInputStream fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 在原文件中，每1kb前面插入1个字节长度的字符 '-'</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">'-'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 插入字符</span>            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="前端H5代码"><a href="#前端H5代码" class="headerlink" title="前端H5代码"></a>前端H5代码</h3><pre class=" language-javascript"><code class="language-javascript">           <span class="token operator">&lt;</span>audio id<span class="token operator">=</span><span class="token string">"my-audio"</span> <span class="token punctuation">:</span>src<span class="token operator">=</span><span class="token string">"audioUrl"</span> controls<span class="token operator">=</span><span class="token string">"controls"</span> preload<span class="token operator">=</span><span class="token string">"auto"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>audio<span class="token operator">></span>           <span class="token comment" spellcheck="true">//解码播放</span>            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/audio/player'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blob <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求接口结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> start <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> blobs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始解码'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                        <span class="token keyword">let</span> end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1024</span><span class="token punctuation">;</span>                        <span class="token keyword">let</span> slip <span class="token operator">=</span> blob<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>slip<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                            <span class="token keyword">break</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        blobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>slip<span class="token punctuation">)</span><span class="token punctuation">;</span>                        start <span class="token operator">=</span> end<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">// 合并</span>                    <span class="token keyword">let</span> mergeBlob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>blobs<span class="token punctuation">,</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">"audio/mpeg"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> audioUrl <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>mergeBlob<span class="token punctuation">)</span><span class="token punctuation">;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'密码:'</span><span class="token operator">+</span>audioUrl<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'字符串url:'</span><span class="token operator">+</span>audioUrl<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 使用了vue，这里的this指的是vue实例</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>audioUrl <span class="token operator">=</span> audioUrl<span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 加载完毕后释放资源</span>            <span class="token keyword">let</span> myAudio <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'my-audio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            myAudio<span class="token punctuation">.</span>oncanplay <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'audio加载完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                window<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>audioUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'audio清除完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><h3 id="BlobURL总结"><a href="#BlobURL总结" class="headerlink" title="BlobURL总结"></a>BlobURL总结</h3><p>经过后端加密，前端再解密播放后，打开页面时，可以正常播放流，但是直接调用后端接口时，已不能正常播放。下图是页面正常加载了解析过的流</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/2.png" alt></p><p>直接调用后端接口，如下</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/3.png" alt></p><p>可以看到本来是音频文件的流，打开之前显示的是视频，且无法播放。说明后端原文件加密成功了。</p><h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p>这种方式确实做到了后端加密，直接请求接口无法得到原文件，但是前端播放后仍然能得到解密后的文件。因为前端是通过blob创建url访问的，F12后可以看到url，直接请求这个url仍然能得到解码后的源文件</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/4.png" alt></p><p>因此刚刚加密的方式只是后端实现了加密，对于前端来说，只要播放了还是有办法拿到原文件。原因在H5的媒体标签如<code>&lt;audio&gt;</code> 和 <code>&lt;video&gt;</code> 标签的src属性只接收一个原文件的地址。也就是说src的地址指向的一定是一个正常播放的原文件，而不是一个加密文件。因此本质上H5不能实现原文件不允许下载的功能。利用自定义的控件如flash可以实现加密播放，不过flash已经被谷歌淘汰了，谷歌浏览器马上要不支持flash控件了。</p><h2 id="Data-URL方式"><a href="#Data-URL方式" class="headerlink" title="Data URL方式"></a>Data URL方式</h2><p>有使用过base64来预览图片经验的，对这个应该并不陌生，Web性能优化有一项措施：把小图片用base64编码直接嵌入到HTML文件中，实际就是利用了Data URL来获取图片数据。由于使用Blob URL方式浏览器F12还是能看到blob的下载连接，还是能得到原文件，于是便想到通过base64对音频文件加密，这样前端就只能看到base64文本了，无法直接得到原文件，后端代码不变，前端调整如下</p><h3 id="前端H5代码-1"><a href="#前端H5代码-1" class="headerlink" title="前端H5代码"></a>前端H5代码</h3><pre class=" language-javascript"><code class="language-javascript">          <span class="token operator">&lt;</span>audio id<span class="token operator">=</span><span class="token string">"my-audio"</span> <span class="token punctuation">:</span>src<span class="token operator">=</span><span class="token string">"audioUrl"</span> controls<span class="token operator">=</span><span class="token string">"controls"</span> preload<span class="token operator">=</span><span class="token string">"auto"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>audio<span class="token operator">></span>             <span class="token comment" spellcheck="true">// 解码播放  Data URL</span>            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/audio/player'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blob <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求接口结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> start <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> blobs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始解码'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                        <span class="token keyword">let</span> end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1024</span><span class="token punctuation">;</span>                        <span class="token keyword">let</span> slip <span class="token operator">=</span> blob<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>slip<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                            <span class="token keyword">break</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        blobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>slip<span class="token punctuation">)</span><span class="token punctuation">;</span>                        start <span class="token operator">=</span> end<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">// 合并</span>                    <span class="token keyword">let</span> mergeBlob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>blobs<span class="token punctuation">,</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span><span class="token string">"audio/mpeg"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 使用了vue，这里的this指的是vue实例</span>                    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>                    fileReader<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        self<span class="token punctuation">.</span>audioUrl <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'base:'</span><span class="token operator">+</span>self<span class="token punctuation">.</span>audioUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">;</span>                    fileReader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>mergeBlob<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="BlobURL总结-1"><a href="#BlobURL总结-1" class="headerlink" title="BlobURL总结"></a>BlobURL总结</h3><p>音频转base64就完成了，<code>这样做有一个弊端对于大文件会导致网页卡顿，我经过测试一个48MB的音频使用base64加密，网页就大约卡了10多秒</code>。这对于一般的C端网站都是难以接受的，我的需求中音频文件是通话录音，所以基本上不会很大，于是决定采用这种方式。主要还是业务禁止下载的需求给逼的o(╥﹏╥)o 下面来看一下页面效果吧</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/7.png" alt></p><p>可以看到audio标签的src属性变成了一个base64的字符串，拿到base64的字符串，通过算法也可以把base64字符串还原成原文件，不过当我要去复制时，会提示太大无法编辑，这正是我需要的结果，哈哈。</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/6.png" alt></p><p>F12中请求也只出现了一个后端请求。base64比较完美的解决了我的需求，唯一不足是对于大文件的编码</p><p><img src="/2020/05/10/h5-shi-pin-liu-jia-mi/4.png" alt></p><h2 id="Blob-URL和Data-URL有什么区别"><a href="#Blob-URL和Data-URL有什么区别" class="headerlink" title="Blob URL和Data URL有什么区别"></a>Blob URL和Data URL有什么区别</h2><ul><li>blob显示的形式<code>blob:http://xxx</code>，dataURL的显示形式<code>data:image/jpeg;base64,/9j/4AAQ...</code></li><li>Blob URL的长度一般比较短，Data URL因为直接存储图片base64编码后的数据，往往很长。浏览器在显示Data URL时使用了省略号（…）。当显式大图片时，使用Blob URL能获取更好的可能性。</li><li>Blob URL 只能在当前应用内部使用，把Blob URL复制到浏览器的地址栏中，是无法获取数据的。Data URL相比之下，就有很好的移植性，你可以在任意浏览器中使用。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> H5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>H5播放视频流</title>
      <link href="/2020/05/08/h5-bo-fang-shi-pin-liu/"/>
      <url>/2020/05/08/h5-bo-fang-shi-pin-liu/</url>
      
        <content type="html"><![CDATA[<p>由于项目需求，在公司系统中需要播放录音。前端我就采用了H5的 <code>&lt;audio&gt;</code> 标签，而后端就是常规 的输出流操作，即通过response的outPutStream输出文件，对于前端来说就是文件下载。开始测试的时候因为使用的都是一些小文件音频（每个音频文件大概就几M吧）都很正常，但是当测到一些较大的音频文件时，就出现了问题，七分钟的音频（十多M的文件）只能播放出三四分钟，通过F12发现，那些小音频文件，一次请求就加载完成了，而对于七分钟的大音频，audio标签没有一次加载完，而且在播放一段时间后，会再次请求服务加载后面的音频。也就是说它是分段加载的，刚开始分段的请求正常，在播放了一半后，后面的分段请求会失败，导致后面的音频不能完整播放。也是由于没有流媒体经验，解决这个问题费了些周折，故在此记录一下。</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/1.jpg" alt></p><h2 id="文件输出流"><a href="#文件输出流" class="headerlink" title="文件输出流"></a>文件输出流</h2><p>我先说一下，常规的输出流方式会出现的问题。在公司时我使用的是<code>&lt;audio&gt;</code> 播放音频，于是回家后，我又用<code>&lt;video&gt;</code> 标签测试了一下，同样会出现视频卡主的现象，F12后同样是伴随分段视频流下载失败的异常。前端代码如下</p><pre class=" language-html"><code class="language-html">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://127.0.0.1:8090/video/player<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name">                    <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">300</span>px</span><span class="token punctuation">"</span></span>                    <span class="token attr-name">controls</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>controls<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre><p>后端 <code>/video/player</code> 接口代码如下</p><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/video/player"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">videoPlayer</span><span class="token punctuation">(</span>            HttpServletRequest request<span class="token punctuation">,</span>            HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        String range <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>range <span class="token operator">==</span> null<span class="token punctuation">)</span>            range <span class="token operator">=</span> <span class="token string">"bytes=0-"</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        range <span class="token operator">=</span> rs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\-"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"F:\\test\\异界.1080p.HD中字.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"视频文件不存在 --> 404"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        OutputStream os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileInputStream fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> length <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"file length : "</span> <span class="token operator">+</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 播放进度</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 播放百分比</span>        <span class="token keyword">int</span> percent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>length <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> irange <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>        length <span class="token operator">=</span> length <span class="token operator">-</span> irange<span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Accept-Ranges"</span><span class="token punctuation">,</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> length <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Range"</span><span class="token punctuation">,</span> <span class="token string">"bytes "</span> <span class="token operator">+</span> range <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> length <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"video/mp4;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>            count <span class="token operator">+=</span> len<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">>=</span> percent<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count: "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">", percent: "</span> <span class="token operator">+</span> percent<span class="token punctuation">)</span><span class="token punctuation">;</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>这里我播放的电影有1.4G，肯定会出现分段请求。在开始的时候，一切看起来很正常，视频可以正常播放，在播放一段时间后，在分段请求时就会出现如下异常</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/4.png" alt></p><p>可以看到，有几个请求出现了failed，视频也卡主了，一直在转圈加载。查看控制台异常信息如下</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/5.png" alt></p><p>而我在公司播放音频时碰到异常如下</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/6.jpg" alt></p><p>两个异常不太相同，分别是 <code>ERR_CONTENT_LENGTH_MISMATCH</code> 和 <code>ERR_CONNECTION_RESET 200</code> 。但其实都是由于前端播放流文件时，响应头不对的原因，对于前端的分段请求，后端必须要支持断点续传才行。下面就来看一下这种方式后端应该怎么写代码</p><h2 id="断点续传流"><a href="#断点续传流" class="headerlink" title="断点续传流"></a>断点续传流</h2><p>同样拿刚刚的H5视频做实验，前端代码不变，后端我新加了一个接口用于支持断点续传的方式，前端代码如下</p><pre class=" language-html"><code class="language-html">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://127.0.0.1:8090/video/player2<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name">                   <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">300</span>px</span><span class="token punctuation">"</span></span>                   <span class="token attr-name">controls</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>controls<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre><p>后端 <code>/video/player2</code> 接口代码如下</p><pre class=" language-java"><code class="language-java">   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/video/player2"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">videoPlayer2</span><span class="token punctuation">(</span>            HttpServletRequest request<span class="token punctuation">,</span>            HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        File downloadFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"F:\\test\\异界.1080p.HD中字.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>downloadFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            response<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_NOT_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">long</span> fileLength <span class="token operator">=</span> downloadFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 记录文件大小</span>        <span class="token keyword">long</span> pastLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 记录已下载文件大小</span>        <span class="token comment" spellcheck="true">// 0：从头开始的全文下载;</span>        <span class="token comment" spellcheck="true">// 1：从某字节开始的下载（bytes=27000-）;</span>        <span class="token comment" spellcheck="true">// 2：从某字节开始到某字节结束的下载（bytes=27000-39000）</span>        <span class="token keyword">int</span> rangeSwitch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> contentLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 客户端请求的字节总量</span>        String rangeBytes <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 记录客户端传来的形如“bytes=27000-”或者“bytes=27000-39000”的内容</span>        RandomAccessFile raf <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 负责读取数据</span>        OutputStream os <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 写出数据</span>        OutputStream out <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 缓冲</span>        <span class="token keyword">int</span> bsize <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 缓冲区大小</span>        <span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bsize<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 暂存容器</span>        String range <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> responseStatus <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 客户端请求的下载的文件块的开始字节</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> range<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"null"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            responseStatus <span class="token operator">=</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">.</span>SC_PARTIAL_CONTENT<span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"request.getHeader Range="</span> <span class="token operator">+</span> range<span class="token punctuation">)</span><span class="token punctuation">;</span>            rangeBytes <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"bytes="</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rangeBytes<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                rangeSwitch <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                rangeBytes <span class="token operator">=</span> rangeBytes<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rangeBytes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                pastLength <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>rangeBytes<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                contentLength <span class="token operator">=</span> fileLength <span class="token operator">-</span> pastLength<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                rangeSwitch <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                String temp0 <span class="token operator">=</span> rangeBytes<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rangeBytes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String temp2 <span class="token operator">=</span> rangeBytes<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>rangeBytes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> rangeBytes<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                pastLength <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>temp0<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 客户端要求全文下载</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            contentLength <span class="token operator">=</span> fileLength<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 清除首部的空白行</span>        response<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 告诉客户端允许断点续传多线程连接下载,响应的格式是:Accept-Ranges: bytes</span>        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Accept-Ranges"</span><span class="token punctuation">,</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果是第一次下,还没有断点续传,状态是默认的 200,无需显式设置;响应的格式是:HTTP/1.1</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rangeSwitch <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>responseStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 不是从最开始下载，断点下载响应号为206</span>            <span class="token comment" spellcheck="true">// 响应的格式是:</span>            <span class="token comment" spellcheck="true">// Content-Range: bytes [文件块的开始字节]-[文件的总大小 - 1]/[文件的总大小]</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>rangeSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    String contentRange <span class="token operator">=</span> <span class="token string">"bytes "</span> <span class="token operator">+</span> pastLength <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>fileLength<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileLength<span class="token punctuation">;</span>                    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Range"</span><span class="token punctuation">,</span> contentRange<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    String contentRange <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileLength<span class="token punctuation">;</span>                    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Range"</span><span class="token punctuation">,</span> contentRange<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            String contentRange <span class="token operator">=</span> <span class="token string">"bytes "</span> <span class="token operator">+</span> <span class="token string">"0-"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>fileLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileLength<span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Range"</span><span class="token punctuation">,</span> contentRange<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"video/mp4;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>            raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>downloadFile<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">long</span> outLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 实际输出字节数</span>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>rangeSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        raf<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pastLength<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>                            outLength <span class="token operator">+=</span> n<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        raf<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pastLength<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token keyword">long</span> readLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 记录已读字节数</span>                        <span class="token comment" spellcheck="true">// 大部分字节在这里读取</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span>readLength <span class="token operator">&lt;=</span> contentLength <span class="token operator">-</span> bsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            n <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>                            readLength <span class="token operator">+=</span> n<span class="token punctuation">;</span>                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>                            outLength <span class="token operator">+=</span> n<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 余下的不足 1024 个字节在这里读取</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>readLength <span class="token operator">&lt;=</span> contentLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            n <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>contentLength <span class="token operator">-</span> readLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>                            outLength <span class="token operator">+=</span> n<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Content-Length为："</span> <span class="token operator">+</span> contentLength <span class="token operator">+</span> <span class="token string">"；实际输出字节数："</span> <span class="token operator">+</span> outLength<span class="token punctuation">)</span><span class="token punctuation">;</span>                out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ignore</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>raf <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    raf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>前端请求 player2 就可以正常播放了，快进快退也很顺畅丝滑。通过F12观察一段时间后，也没有出现请求 failed 的情况</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/7.png" alt></p><p>查看每个请求的响应头可以发现，每个请求是只请求了视频的一部分内容，不是像第一种方式那样把整个文件都输出给前端了，从后端代码也可以看出这点，因为后端文件读取使用了<code>RandomAccessFile</code>，这个是用于文件随机读取的类。前端每次请求头中会带有 Range 属性，告诉后端要读取哪部分文件内容。</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/9.png" alt></p><p>每次请求到的文件长度不一样</p><p><img src="/2020/05/08/h5-bo-fang-shi-pin-liu/10.png" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一种方式其实也是可以的，只不过接口不支持流媒体，前端还是需要等待整个资源下载下来之后，才能做进度拖拽，播放等功能。因此在对于大文件来说肯定不合适。第二种方式是流媒体方式，即边下载边播放。需要HTTP支持断点续传。</p><h3 id="HTTP的断点续传"><a href="#HTTP的断点续传" class="headerlink" title="HTTP的断点续传"></a>HTTP的断点续传</h3><p>文件上传下载时，记录上一次上传下载的位置，再从标记位置继续传输，或者多线程下载，根据标记可按需获取。在以前版本的 HTTP 协议是不支持断点的，HTTP/1.1 开始就支持了。断点下载时需要用到 Range 和 Content-Range 实体头。</p><h5 id="请求头-Range"><a href="#请求头-Range" class="headerlink" title="请求头 Range"></a>请求头 Range</h5><p>请求资源的部分内容（不包括响应头的大小），单位是byte，即字节，从0开始，如果服务器能够正常响应的话，服务器会返回 206 Partial Content 的状态码及说明，如果不能处理这种Range的话，就会返回整个资源以及响应状态码为 200 OK，（这个要注意，要分段下载时，后端代码要先判断这个）用于请求头中，指定第一个字节的位置和最后一个字节的位置，一般格式：Range: bytes=start-end</p><ol><li><code>Range: bytes=10-</code> ：第10个字节及最后个字节的数据</li><li><code>Range: bytes=40-100</code> ：第40个字节到第100个字节之间的数据</li></ol><h5 id="响应头-Content-Range"><a href="#响应头-Content-Range" class="headerlink" title="响应头 Content-Range"></a>响应头 Content-Range</h5><ol><li><code>Content-Range: bytes 0-100/5000</code>：表示相应了0到100个字节的数据，共有5000个字节大小</li><li><code>Content-Length: 5000</code> ：表示总文件大小</li></ol>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> H5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React-Native项目搭建</title>
      <link href="/2020/05/05/react-native-xiang-mu-chu-ti-yan/"/>
      <url>/2020/05/05/react-native-xiang-mu-chu-ti-yan/</url>
      
        <content type="html"><![CDATA[<p>React Native 结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。简而言之，如果熟练使用过React做网页开发，那么可以很容易的切换到使用React Native做移动端APP开发。React Native是React大家族的一员，在使用方式，组件生命周期上几乎一样，这对于Web开发工程师来说，无疑是一件天大的好事。PC端使用的是JS语言，而移动端的React Native使用的也是JS语言，这样Web开发工程师真正可以做到移动端，PC端的全栈开发。React Native是Facebook出品的一个革新性的跨平台UI框架，跨平台不是它最大的亮点，它背后的<code>[React]</code>才应该是它的神奇说在。用一两句来总结它的伟大，那就是给把web开发中的无状态开发模式通过React实现了。 那些数不清的状态组合才是桌面应用和手机应用复杂的源头。我本人是一个后端开发，当发现React不仅可以做Web开发，还能开发APP时，于是本着没事瞎折腾的劲，做一个基于React Native的APP练练手。</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/s.jpg" alt></p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol><li><code>Node：</code> 安装node环境配置就不多说了吧</li><li><code>Android Studio：</code> 安卓的集成开发工具，官网下载安装</li><li><code>Android SDK：</code> 安卓开发需要的运行环境</li></ol><h2 id="Android-Studio安装"><a href="#Android-Studio安装" class="headerlink" title="Android Studio安装"></a>Android Studio安装</h2><p>Android Studio是由谷歌提供的，不过界面风格和IDEA很像，<a href="http://www.android-studio.org/" target="_blank" rel="noopener">官网下载地址</a>。下载windows版本即可</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/0.png" alt></p><p>下载完成后双击运行安装，基本无脑Next就行了，唯一要注意的地方就是安装路径，不要安装在C盘，自己选一个路径安装即可</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/3.png" alt></p><p>然后一路Next，等待安装完成即可，安卓SDK一会打开Android Studio可以在里面安装，先通过命令把React Native项目建好。</p><h2 id="初始化React-Native项目"><a href="#初始化React-Native项目" class="headerlink" title="初始化React Native项目"></a>初始化React Native项目</h2><p>创建一个android目录，专门用来存放安卓项目，然后打开windows终端，执行下面两个命令，初始化React Native项目</p><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g react-native-clireact-native init myApp</code></pre><p>react-native-cli是官方提供的快速创建React Native工程的脚手架。我在这创建了一个myApp项目，执行命令后显示如下，等待运行完即可</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/7.png" alt></p><p>初始化好后结果如下</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/8.png" alt></p><p>进入到myApp文件夹中，可以看到初始化好后，目录结构如下</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">|</span>- tests<span class="token operator">|</span>- android              <span class="token operator">|</span> android 端代码      <span class="token operator">|</span>- app                  <span class="token operator">|</span> app 模块        <span class="token operator">|</span>- build.gradle         <span class="token operator">|</span> app 模块 Gradle 配置文件        <span class="token operator">|</span>- progurad-rules.pro   <span class="token operator">|</span> 混淆配置文件        <span class="token operator">|</span>- src/main             <span class="token operator">|</span> 源代码            <span class="token operator">|</span>- AndroidManifest.xml  <span class="token operator">|</span> APK 配置信息             <span class="token operator">|</span>- java                 <span class="token operator">|</span> 源代码                <span class="token operator">|</span>- 包名                 <span class="token operator">|</span> java 源代码                    <span class="token operator">|</span>- MainActivity.java    <span class="token operator">|</span> 界面文件, <span class="token punctuation">(</span>加载ReactNative源文件入口<span class="token punctuation">)</span>                    <span class="token operator">|</span>- MainApplication.java <span class="token operator">|</span> 应用级上下文, <span class="token punctuation">(</span>ReactNative 插件配置<span class="token punctuation">)</span>            <span class="token operator">|</span>- res                  <span class="token operator">|</span> APK 资源文件    <span class="token operator">|</span>- gradle               <span class="token operator">|</span> Gradle 版本配置信息    <span class="token operator">|</span>- keystores            <span class="token operator">|</span> APK 打包签名文件<span class="token punctuation">(</span>如果正式开发需要自己定义修改签名文件<span class="token punctuation">)</span>    <span class="token operator">|</span>- gradlew              <span class="token operator">|</span> Gradle运行脚本, 与 react-native run-android 有关    <span class="token operator">|</span>- gradlew.bat          <span class="token operator">|</span> Gradle运行脚本, 与 react-native run-android 有关    <span class="token operator">|</span>- gradle.properties    <span class="token operator">|</span> Gradle 的配置文件, 正常是 AndroidHome, NDK, JDK, 环境变量的配置    <span class="token operator">|</span>- build.gradle         <span class="token operator">|</span> Gradle的全局配置文件, 主要是是配置编译 Android 的 Gradle 插件,及配置 Gradle仓库    <span class="token operator">|</span>- settings.gradle      <span class="token operator">|</span> Gradle模块配置<span class="token operator">|</span>- ios                  <span class="token operator">|</span> iOS 端代码<span class="token operator">|</span>- node_modules         <span class="token operator">|</span> 项目依赖库<span class="token operator">|</span>- .buckconfig<span class="token operator">|</span>- .flowconfig<span class="token operator">|</span>- .watchmanconfig<span class="token operator">|</span>- index.js<span class="token operator">|</span>- App.js<span class="token operator">|</span>- app.json<span class="token operator">|</span>- package.json         <span class="token operator">|</span> node配置文件, 主是要配置项目的依赖库,<span class="token operator">|</span>- index.android.js     <span class="token operator">|</span> Android 项目启动入口<span class="token operator">|</span>- index.ios.js         <span class="token operator">|</span> iOS 项目启动入口复制代码</code></pre><p>下面详细解释一下每个文件目录的作用</p><table><thead><tr><th>名称</th><th>解释</th></tr></thead><tbody><tr><td>tests</td><td>测试文件夹，执行命令 “npm test”会调用此文件夹，在文件夹中需要引入待测试文件</td></tr><tr><td>android</td><td>Android的原生开发目录，可以用Android Studio打开进行原生开发</td></tr><tr><td>ios</td><td>Ios的原生开发目录，可以用Xcode打开进行原生开发</td></tr><tr><td>node_modules</td><td>存放项目所有依赖的库，在package.json中配置</td></tr><tr><td>.buckconfig</td><td>buck的配置文件，buck是Facebook推出的一款高效率的App项目构建工具。</td></tr><tr><td>.flowconfig</td><td>Flow 是 Facebook 旗下一个为 JavaScript 进行静态类型检测的检测工具。<br>它可以在 JavaScript 的项目中用来捕获常见的 bugs，比如隐式类型转换，空引用等等。</td></tr><tr><td>.watchmanconfig</td><td>watchman的配置文件，watchman用于监控文件变化，辅助实现工程修改信息</td></tr><tr><td>index.js</td><td>ios或android的入口，但是老版本中可能使用index.ios.js/index.android.js。<br>android中配置application文件的getJSMainModuleName()配置入口</td></tr><tr><td>app.json</td><td>app的json文件</td></tr></tbody></table><h2 id="导入项目"><a href="#导入项目" class="headerlink" title="导入项目"></a>导入项目</h2><p>打开刚刚安装好的Android Studio</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/19.png" alt></p><p>然后导入刚刚初始化好的安卓项目，注意要选择<code>build.gradle</code>文件，即myApp目录下的android目录，而不是直接打开myApp目录。</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/15.png" alt></p><p>gradle会自动下载相关依赖，等待项目初始好就行了</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/16.png" alt></p><p>在此期间，可以配置一下安卓的SDK和安卓虚拟机</p><h2 id="Android-SDK安装"><a href="#Android-SDK安装" class="headerlink" title="Android SDK安装"></a>Android SDK安装</h2><p>打开 <code>File -&gt; Settings... -&gt; System Settings -&gt; Android SDK</code>，点击Edit</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/9.png" alt></p><p>然后选择安装目录，一路Next即可</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/10.png" alt></p><p>在环境变量Path中添加这两个目录</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/20.png" alt></p><h2 id="Android虚拟机配置"><a href="#Android虚拟机配置" class="headerlink" title="Android虚拟机配置"></a>Android虚拟机配置</h2><p>为了便于调试或者没有真机的情况下，可以配置一个安卓虚拟机用于开发调试，首先选择一个合适的机型</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/29.png" alt></p><p>我这里选择了现在主流的6.3寸的屏幕，然后选择x86系统，安卓10.0系统，然后点击Download下载安装虚拟机</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/31.png" alt></p><p>等待下载好后，选择刚刚下载好的虚拟机点击Next会进入如下界面，虚拟机实例内存选择4G，然后继续点击Next</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/32.png" alt></p><p>注意：安装虚拟机需要CPU开启虚拟化支持，如果没有开启需要进入BIOS设置开启虚拟化，没有开启虚拟化或者虚拟化设置不对会报如下异常</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/36.png" alt></p><h2 id="运行React-Native"><a href="#运行React-Native" class="headerlink" title="运行React Native"></a>运行React Native</h2><p>安卓SDK和虚拟机都配置好后，回到项目，此时Gradle应该已经把项目初始化好了，如果没有初始化好就继续再等等吧。需要注意的是项目初始化可能会报如下异常，导致初始化失败</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/24.png" alt></p><p>这实际是因为项目配置的 build-tools  platforms platform-tools 和本地下载的版本存在不一致的情况，需要进入到安卓SDK的安装目录下</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1.进入到安装目录</span><span class="token function">cd</span> F:\WorkTool\android-sdk10.0\tools\bin<span class="token comment" spellcheck="true"># 2.1. windows执行命令</span>sdkmanager --licenses<span class="token comment" spellcheck="true"># 2.2. linux执行命令</span>./sdkmanager --license</code></pre><p>更新 license 文件，执行过程需要多次确认。全部选择y即可。更新完成后再次初始化Gradle项目。好，到这里算把环境问题全搞定了，直接运行项目吧。</p><h3 id="运行App"><a href="#运行App" class="headerlink" title="运行App"></a>运行App</h3><p>通过前面的配置我已经把SDK和安卓虚拟机全配置好了，现在只管运行就行了</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/39.png" alt></p><p>如果顺利的话，会弹出安卓虚拟机，同时可以看到React的标志，欢迎来到React！</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/33.png" alt></p><p>通过上面的提示可以看到主页是编辑App.js，于是我在App.js中加了一句话试试效果</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/44.png" alt></p><p>不过令我奇怪的是重启服务后，这句话并没有加上去，而是需要点击myApp的wrapper后，再重启服务才加上了这句话</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/45.png" alt></p><p>重启后效果如下，嗯，万里长征总算走完了第一步。。。</p><p><img src="/2020/05/05/react-native-xiang-mu-chu-ti-yan/46.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react-native </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode-求两数组的中位数</title>
      <link href="/2020/04/22/leetcode-qiu-liang-shu-zu-de-zhong-wei-shu/"/>
      <url>/2020/04/22/leetcode-qiu-liang-shu-zu-de-zhong-wei-shu/</url>
      
        <content type="html"><![CDATA[<p>继续一天一个算法题，额….这个要求真的有点高 o(╥﹏╥)o ，今天这个算法题在LeetCode上是一个困难级别的题，我在看完这个题后基本上有了个大概的思路，然而理想很丰满，现实很骨感，用代码实现算法却用了一天多。这里记录一下我的解题思路</p><p><img src="/2020/04/22/leetcode-qiu-liang-shu-zu-de-zhong-wei-shu/1.jpg" alt></p><h2 id="寻找两个有序数组的中位数"><a href="#寻找两个有序数组的中位数" class="headerlink" title="寻找两个有序数组的中位数"></a>寻找两个有序数组的中位数</h2><p>给定两个大小为 m 和 n 的有序数组 nums1 和 nums2。请你找出这两个有序数组的中位数，并且要求算法的时间复杂度为 O(log(m + n))。你可以假设 nums1 和 nums2 不会同时为空。</p><p><strong>示例 1:</strong></p><pre><code>nums1 = [1, 3]nums2 = [2]则中位数是 2.0</code></pre><p><strong>示例 2:</strong></p><pre><code>nums1 = [1, 2]nums2 = [3, 4]则中位数是 (2 + 3)/2 = 2.5</code></pre><p><strong>备注：</strong></p><ul><li><code>中位数</code>：中位数的概念是初中的内容，简单来说，就是一个有序数组的中间那个数（如果数组长度是奇数，中位数是中间那个数；如果长度是偶数，中位数是中间两个数的平均数）</li><li><code>有序数组</code>：题干中有一点没讲清楚，就是只说了是两个有序数组，而没有说是两个升序数组，或者是两个降序数组，又或者一个升序一个降序。但我提交通过的代码，默认是处理两个数组是升序的，所以LeetCode这道题默认是针对两个升序数组的，我本地又测了一下两个降序和一个升序一个降序的情况，发现不能得到正确结果（后来我想了想，其实如果代码能正确得到两个升序数组的中位数，那么两个降序和一个升序一个降序的情况，只要稍加处理一下就行了，哈哈）</li></ul><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>所谓一千个人眼中有一千个哈姆雷特，不同的人对同一个题目有不同的算法思路，这里只记录我个人的解题思路。这道题要求算法复杂度是O(log(m + n))，这意味着只能遍历一次数组才能满足这个要求。而这道题最有用的价值就是两个数组已经是有序数组，要很好的利用这个特点。而不是首先想着把两个数组合成一个数组，然后再排好序，再求中位数。因此看完这道题时，我的脑海中有一个画面，想像有一个小人从数组的左边走到右边，他每次只能走一个数字，而且每走一步只能选择这两个数组中比较小的数走，然后走第二大的数，然后走第三大的数，依次这样走下去。当小人走的步数是两个数组长度的一半数时，他脚下的数字就是中位数了。这个思路的算法复杂度很小，没有任何多余的算法步骤，虽然思路是这样想的，但实际写代码时却总是不自觉得去遍历两个数组（因为发现如果不遍历，该怎么往右走呢），以至于花费了大半天时间还是得不到正确的结果，后来我再去仔细想了想这个思路过程，发现重要的不是遍历，而得需要知道下一步该怎么走（即是应该继续在这个数组上右移一步，还是应该跳到另一个数组）。也就是说我每走一步都需要规划下一步该怎么走，于是我写了一个死循环，然后每次循环时去规划下一次循环应走的代码逻辑（即 <code>if...else...</code>），然后再适当的时候跳出循环即可（即 <code>if...break</code>）。按这个思路这道题需要解决的问题点有三个：</p><ol><li><code>动态规划</code>：每右移一步时，要分别获取数组1和数组2的下一个元素，比较大小，然后选择较小的数组继续右移</li><li><code>临界判断</code>：存在一种情况，就是数组1的值比数组2的值全都小时，数组1跑完后，到数组2时就不需要再获取数组1的元素做动态规划了</li><li><code>长度判断</code>：当两数组长度和为奇数时比较好处理，当长度和为偶数时，跑到中间后，需把中间的数值先记下来，然后继续右移一位，这时再和刚刚记下的数值求和算中位数</li></ol><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="Java版本"><a href="#Java版本" class="headerlink" title="Java版本"></a>Java版本</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">getMiddleByTwoNumbers</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums1 <span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums2<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> value1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>value2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 声明两个游标,两个数组谁小，谁右移</span>        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> half <span class="token operator">=</span> <span class="token punctuation">(</span>nums1<span class="token punctuation">.</span>length<span class="token operator">+</span>nums2<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> lengthFlag <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nums1<span class="token punctuation">.</span>length<span class="token operator">+</span>nums2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">;</span>        Integer temp1<span class="token punctuation">,</span>temp0<span class="token operator">=</span>null<span class="token punctuation">;</span>        <span class="token keyword">boolean</span> flag1<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span>flag2<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>nums1<span class="token punctuation">.</span>length<span class="token punctuation">)</span>                value1 <span class="token operator">=</span> nums1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">&lt;</span>nums2<span class="token punctuation">.</span>length<span class="token punctuation">)</span>                value2 <span class="token operator">=</span> nums2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//(如果 num1当前值小于num2当前值，且游标未到达num1的最右边) 或者 (num2右标已到达最右边，此时只移动num1)</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value1<span class="token operator">&lt;</span>value2  <span class="token operator">&amp;&amp;</span> flag1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>flag2<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">>=</span> nums1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>                    flag1 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                temp1 <span class="token operator">=</span> value1<span class="token punctuation">;</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>j <span class="token operator">>=</span> nums2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    flag2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                temp1 <span class="token operator">=</span> value2<span class="token punctuation">;</span>                j<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 如果已经到了中位数的位置</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> half<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 两数组长为偶数时，需找两个值</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>lengthFlag<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>temp0 <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                        half<span class="token operator">++</span><span class="token punctuation">;</span>                        temp0 <span class="token operator">=</span> temp1<span class="token punctuation">;</span>                        <span class="token keyword">continue</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>temp1<span class="token operator">+</span>temp0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2d</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> temp1<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="Python版本"><a href="#Python版本" class="headerlink" title="Python版本"></a>Python版本</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token keyword">def</span> <span class="token function">getMiddleByTwoNumbers</span><span class="token punctuation">(</span>nums1<span class="token punctuation">:</span> List<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">,</span> nums2<span class="token punctuation">:</span> List<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> float<span class="token punctuation">:</span>     value1<span class="token operator">=</span><span class="token number">0</span>     value2<span class="token operator">=</span><span class="token number">0</span>     i<span class="token operator">=</span><span class="token number">0</span>     j <span class="token operator">=</span> <span class="token number">0</span>     half <span class="token operator">=</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>nums1<span class="token punctuation">)</span> <span class="token operator">+</span> len<span class="token punctuation">(</span>nums2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>     lengthFlag <span class="token operator">=</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>nums1<span class="token punctuation">)</span> <span class="token operator">+</span> len<span class="token punctuation">(</span>nums2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>     tempFlag <span class="token operator">=</span> <span class="token boolean">False</span>     temp1<span class="token operator">=</span><span class="token number">0</span>     temp0<span class="token operator">=</span><span class="token number">0</span>     flag1 <span class="token operator">=</span> <span class="token boolean">True</span>     flag2 <span class="token operator">=</span> <span class="token boolean">True</span>     <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>         <span class="token keyword">if</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">(</span>nums1<span class="token punctuation">)</span><span class="token punctuation">:</span>             value1<span class="token operator">=</span>nums1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>         <span class="token keyword">if</span> j<span class="token operator">&lt;</span>len<span class="token punctuation">(</span>nums2<span class="token punctuation">)</span><span class="token punctuation">:</span>             value2<span class="token operator">=</span>nums2<span class="token punctuation">[</span>j<span class="token punctuation">]</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>value1<span class="token operator">&lt;</span>value2 <span class="token operator">and</span> flag1<span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token operator">not</span> flag2<span class="token punctuation">:</span>             <span class="token keyword">if</span> i<span class="token operator">>=</span> len<span class="token punctuation">(</span>nums1<span class="token punctuation">)</span><span class="token punctuation">:</span>                 flag1 <span class="token operator">=</span> <span class="token boolean">False</span>                 <span class="token keyword">continue</span>             temp1 <span class="token operator">=</span> value1             i <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span>         <span class="token keyword">else</span><span class="token punctuation">:</span>             <span class="token keyword">if</span> j<span class="token operator">>=</span> len<span class="token punctuation">(</span>nums2<span class="token punctuation">)</span><span class="token punctuation">:</span>                 flag2 <span class="token operator">=</span> <span class="token boolean">False</span>                 <span class="token keyword">continue</span>             temp1 <span class="token operator">=</span> value2             j <span class="token operator">=</span> j<span class="token operator">+</span><span class="token number">1</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> half<span class="token punctuation">:</span>             <span class="token keyword">if</span> lengthFlag<span class="token punctuation">:</span>                 <span class="token keyword">if</span> <span class="token operator">not</span> tempFlag<span class="token punctuation">:</span>                     tempFlag <span class="token operator">=</span> <span class="token boolean">True</span>                     half <span class="token operator">=</span> half<span class="token operator">+</span><span class="token number">1</span>                     temp0 <span class="token operator">=</span> temp1                     <span class="token keyword">continue</span>                 <span class="token keyword">return</span> <span class="token punctuation">(</span>temp0<span class="token operator">+</span>temp1<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>             <span class="token keyword">else</span><span class="token punctuation">:</span>                 <span class="token keyword">return</span> temp1</code></pre><h3 id="Go版本"><a href="#Go版本" class="headerlink" title="Go版本"></a>Go版本</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">getMiddleByTwoNumbers</span><span class="token punctuation">(</span> num1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">,</span>num2 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> value1 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">var</span> value2 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment" spellcheck="true">// 声明两个游标</span>    <span class="token keyword">var</span> i <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">var</span> j <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">var</span> half <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>    <span class="token keyword">var</span> lengthFlag <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span>    <span class="token comment" spellcheck="true">// 两数组长度为偶数时，额外处理的开关</span>    <span class="token keyword">var</span> even <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">var</span> temp0 <span class="token builtin">int</span>    <span class="token keyword">var</span> temp1 <span class="token builtin">int</span>    <span class="token keyword">var</span> flag1 <span class="token builtin">bool</span> <span class="token operator">=</span><span class="token boolean">true</span>    <span class="token keyword">var</span> flag2 <span class="token builtin">bool</span> <span class="token operator">=</span><span class="token boolean">true</span>    <span class="token keyword">for</span> <span class="token boolean">true</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> i<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">{</span>            value1 <span class="token operator">=</span> num1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> j<span class="token operator">&lt;</span><span class="token function">len</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">{</span>            value2 <span class="token operator">=</span> num2<span class="token punctuation">[</span>j<span class="token punctuation">]</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value1<span class="token operator">&lt;</span>value2 <span class="token operator">&amp;&amp;</span> flag1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>flag2 <span class="token punctuation">{</span>            <span class="token keyword">if</span> i<span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">{</span>                flag1<span class="token operator">=</span><span class="token boolean">false</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            temp1 <span class="token operator">=</span> value1            i<span class="token operator">++</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> j<span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">{</span>                flag2<span class="token operator">=</span><span class="token boolean">false</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            temp1 <span class="token operator">=</span> value2            j<span class="token operator">++</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> half<span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 如果两数组长度和为偶数</span>            <span class="token keyword">if</span> lengthFlag <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 如果是false，说明中位数还需要拿一位</span>                <span class="token keyword">if</span> <span class="token operator">!</span>even <span class="token punctuation">{</span>                    half<span class="token operator">++</span>                    temp0 <span class="token operator">=</span> temp1                    even <span class="token operator">=</span> <span class="token boolean">true</span>                    <span class="token keyword">continue</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>temp0<span class="token operator">+</span>temp1<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>temp1<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>temp1<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h2 id="LeetCode运行结果"><a href="#LeetCode运行结果" class="headerlink" title="LeetCode运行结果"></a>LeetCode运行结果</h2><p>Java的优化确实已经登峰造极了，三种语言代码是一样的思路写的，Java还是跑的最快的，只不过内存用的有点多，毕竟Java有个JVM在那</p><p><img src="/2020/04/22/leetcode-qiu-liang-shu-zu-de-zhong-wei-shu/2.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode-两数相加</title>
      <link href="/2020/04/19/leetcode-liang-shu-xiang-jia/"/>
      <url>/2020/04/19/leetcode-liang-shu-xiang-jia/</url>
      
        <content type="html"><![CDATA[<p>在代码的世界中有一句名言，即程序=数据结构+算法。工作中大部分开发其实都用不到多高深的算法，因为前辈们已经造好了各种高级轮子，我们要做的仅仅只需要调用他们封装好的API就行了。这样就算不懂这些知识，只要Java API、开发框架用得熟练，照样可以把代码写得“飞”起来。但语言只是工具，而算法才是灵魂。而程序就等于算法加数据结构。足以可见，想要在编程之路上走的更长远，数据结构与算法就是必须要掌握的基本功。在看一些中间件的源码时，越发感觉如此。不然就算开发了五年八年，也只是个coder，而不能称为工程师。接下来一段时间我会有选择的刷一些LeetCode算法题，提高内功吧。我会尽量使用 <code>Java</code>，<code>Python</code>和<code>Go</code> 三种语言实现算法</p><p><img src="/2020/04/19/leetcode-liang-shu-xiang-jia/1.jpg" alt></p><h2 id="两数相加"><a href="#两数相加" class="headerlink" title="两数相加"></a>两数相加</h2><p>原题题干如下：</p><p>给出两个 非空 的链表用来表示两个非负的整数。其中，它们各自的位数是按照 逆序 的方式存储的，并且它们的每个节点只能存储 一位 数字。如果，我们将这两个数相加起来，则会返回一个新的链表来表示它们的和。您可以假设除了数字 0 之外，这两个数都不会以 0 开头。</p><p><strong>示例</strong>：</p><pre class=" language-basic"><code class="language-basic">输入：<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">4</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">6</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">)</span>输出：<span class="token number">7</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">8</span>原因：<span class="token number">342</span> <span class="token operator">+</span> <span class="token number">465</span> <span class="token operator">=</span> <span class="token number">807</span></code></pre><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>这个算法题难度在LeetCode上是中等难度，不知道这个难度是怎么定义的，就这道题而言。我大概看完题目想了一分钟的样子想到解题思路（PS：力扣上很多题，我看完题目，完全没有解题思路，无从下手的感觉，<del>o(&gt;_&lt;)o ~</del>）。只需把两个链表对应位置的数字相加就可以了，按这个思路这道题需要解决的问题点有三个</p><ol><li><code>同步遍历</code>：所谓同步遍历，就是说同时开始遍历且步长一样，通俗的讲就是链表1遍历到第一个元素时，链表2也遍历到第一个元素，链表1遍历到第二个元素时，链表2也遍历到第二个元素。</li><li><code>加法进位</code>：在两个数字相加时可能需要进位，因此要额外声明一个变量用来记录上一次的结果是否需要进位</li><li><code>空位补零</code>：题干中给的示例两个链表是等长的，如果两个链表不等长该怎么处理，例如 342+7465 。这里我想到是补零，即转化为 0342+7465，这样虽然多了一次运算但是 0+7还是等于7，代码实现更加简洁</li></ol><p>大概就是这样吧，具体写代码实现时，还有些细节需要考虑，例如两个链表等长，当两个链表都遍历完，但最后一次运算需要进位时，还要额外做一下处理。话不多说，上代码吧</p><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="Java版本"><a href="#Java版本" class="headerlink" title="Java版本"></a>Java版本</h3><p>ListNode.class</p><pre><code>public class ListNode {    private int value;    private ListNode next;    public ListNode(int value){        this.value=value;    }    public ListNode(int value,ListNode next){        this.value=value;        this.next=next;    }    public int getValue() {return value;}    public void setValue(int value) {this.value = value;}    public ListNode getNext() {return next;}    public void setNext(ListNode next) {this.next = next;}}</code></pre><p>测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>test<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2019/1/6 15:52 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        ListNode num1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ListNode num2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ListNode data <span class="token operator">=</span> <span class="token function">addTwoNumbers</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span>num2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> ListNode <span class="token function">addTwoNumbers</span><span class="token punctuation">(</span>ListNode num1 <span class="token punctuation">,</span>ListNode num2<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 进位标记  为true表示本次计算需要进位</span>        <span class="token keyword">boolean</span> carry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        ListNode rootNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ListNode preNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 当两个链表任意一个next还存在时，或者两个链表next都不存在，但上一次的计算结果需要进位时，都要继续循环</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>num1 <span class="token operator">!=</span> null <span class="token operator">||</span> num2 <span class="token operator">!=</span> null <span class="token operator">||</span> carry<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 空位补零，</span>            <span class="token keyword">int</span> value1<span class="token operator">=</span> num1 <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> num1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> value2<span class="token operator">=</span> num2 <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> num2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 计算本次结果</span>            <span class="token comment" spellcheck="true">// 如果上一次的计算需要进位，则+1</span>            <span class="token keyword">int</span> res <span class="token operator">=</span> carry <span class="token operator">?</span> <span class="token punctuation">(</span>value1<span class="token operator">+</span>value2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>value1<span class="token operator">+</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>            carry <span class="token operator">=</span> res <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">;</span>            ListNode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>res<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            preNode<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 保存上一个节点</span>            preNode <span class="token operator">=</span> node<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>num1 <span class="token operator">!=</span> null<span class="token punctuation">)</span>                num1 <span class="token operator">=</span> num1<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>num2 <span class="token operator">!=</span> null<span class="token punctuation">)</span>                num2 <span class="token operator">=</span> num2<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> rootNode<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="Python版本"><a href="#Python版本" class="headerlink" title="Python版本"></a>Python版本</h3><p>ListNode.py</p><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>val<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>val<span class="token operator">=</span>val        self<span class="token punctuation">.</span>next<span class="token operator">=</span>next<span class="token keyword">def</span> <span class="token function">addTwoNumbers</span><span class="token punctuation">(</span>num1 <span class="token punctuation">:</span> ListNode<span class="token punctuation">,</span>num2 <span class="token punctuation">:</span> ListNode<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> ListNode<span class="token punctuation">:</span>    rootNode <span class="token operator">=</span> ListNode<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>None<span class="token punctuation">)</span>    preNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>    carry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> num1 <span class="token operator">or</span> num2 <span class="token operator">or</span> carry<span class="token punctuation">:</span>        value1 <span class="token operator">=</span> num1<span class="token punctuation">.</span>val <span class="token keyword">if</span> num1 <span class="token keyword">else</span> <span class="token number">0</span>        value2 <span class="token operator">=</span> num2<span class="token punctuation">.</span>val <span class="token keyword">if</span> num2 <span class="token keyword">else</span> <span class="token number">0</span>        res <span class="token operator">=</span> value1<span class="token operator">+</span>value2<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">if</span> carry <span class="token keyword">else</span> value1<span class="token operator">+</span>value2        carry <span class="token operator">=</span> res<span class="token operator">>=</span><span class="token number">10</span>        node <span class="token operator">=</span> ListNode<span class="token punctuation">(</span>res<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">,</span>None<span class="token punctuation">)</span>        preNode<span class="token punctuation">.</span>next <span class="token operator">=</span> node        preNode <span class="token operator">=</span> node        num1 <span class="token operator">=</span> num1<span class="token punctuation">.</span>next <span class="token keyword">if</span> num1 <span class="token keyword">else</span> None        num2 <span class="token operator">=</span> num2<span class="token punctuation">.</span>next <span class="token keyword">if</span> num2 <span class="token keyword">else</span> None    <span class="token keyword">return</span> rootNode<span class="token punctuation">.</span>next</code></pre><p>测试类</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> study<span class="token punctuation">.</span>ListNode <span class="token keyword">import</span> ListNode<span class="token punctuation">,</span>addTwoNumbers<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    num1 <span class="token operator">=</span> ListNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ListNode<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>ListNode<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    num2 <span class="token operator">=</span> ListNode<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>ListNode<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>ListNode<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    data <span class="token operator">=</span> addTwoNumbers<span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span>    <span class="token keyword">while</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>val<span class="token punctuation">)</span>        data <span class="token operator">=</span> data<span class="token punctuation">.</span>next</code></pre><h3 id="Go版本"><a href="#Go版本" class="headerlink" title="Go版本"></a>Go版本</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">type</span> ListNode <span class="token keyword">struct</span> <span class="token punctuation">{</span>    value <span class="token builtin">int</span>    next <span class="token operator">*</span> ListNode<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">addTwoNumbers2</span><span class="token punctuation">(</span>num1 <span class="token operator">*</span>ListNode <span class="token punctuation">,</span>num2 <span class="token operator">*</span>ListNode<span class="token punctuation">)</span> <span class="token operator">*</span>ListNode<span class="token punctuation">{</span>    <span class="token keyword">var</span> carry <span class="token builtin">bool</span>    carry <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">var</span> rootNode <span class="token operator">=</span> <span class="token operator">&amp;</span>ListNode<span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span>    <span class="token keyword">var</span> preNode <span class="token operator">=</span> rootNode    <span class="token keyword">for</span> num1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> num2 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> carry <span class="token punctuation">{</span>        <span class="token keyword">var</span> value1 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">var</span> value2 <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">if</span> num1 <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>            value1 <span class="token operator">=</span> num1<span class="token punctuation">.</span>value        <span class="token punctuation">}</span>        <span class="token keyword">if</span> num2 <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>            value2 <span class="token operator">=</span> num2<span class="token punctuation">.</span>value        <span class="token punctuation">}</span>        <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">if</span> carry <span class="token punctuation">{</span>            res <span class="token operator">=</span> value1<span class="token operator">+</span>value2<span class="token operator">+</span><span class="token number">1</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            res <span class="token operator">=</span> value1<span class="token operator">+</span>value2        <span class="token punctuation">}</span>        <span class="token keyword">if</span> res<span class="token operator">>=</span><span class="token number">10</span> <span class="token punctuation">{</span>            carry <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            carry <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>        <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token operator">&amp;</span>ListNode<span class="token punctuation">{</span> value<span class="token punctuation">:</span> res<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">}</span>        preNode<span class="token punctuation">.</span>next <span class="token operator">=</span> node        preNode <span class="token operator">=</span> node        <span class="token keyword">if</span> num1 <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>            num1 <span class="token operator">=</span> num1<span class="token punctuation">.</span>next        <span class="token punctuation">}</span>        <span class="token keyword">if</span> num2 <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>            num2 <span class="token operator">=</span> num2<span class="token punctuation">.</span>next        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> rootNode<span class="token punctuation">.</span>next<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 2->4->3</span>    <span class="token keyword">var</span> num1 <span class="token operator">=</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> num12 <span class="token operator">=</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    num12<span class="token punctuation">.</span><span class="token function">setNextNode</span><span class="token punctuation">(</span><span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    num1<span class="token punctuation">.</span><span class="token function">setNextNode</span><span class="token punctuation">(</span>num12<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 5->6->4</span>    <span class="token keyword">var</span> num2 <span class="token operator">=</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> num22 <span class="token operator">=</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    num22<span class="token punctuation">.</span><span class="token function">setNextNode</span><span class="token punctuation">(</span><span class="token function">createNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    num2<span class="token punctuation">.</span><span class="token function">setNextNode</span><span class="token punctuation">(</span>num22<span class="token punctuation">)</span>    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token function">addTwoNumbers2</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span>num2<span class="token punctuation">)</span>    <span class="token keyword">for</span> data <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>value<span class="token punctuation">)</span>        data <span class="token operator">=</span> data<span class="token punctuation">.</span>next    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>嗯…感觉良好，继续加油吧。下面贴一下LeetCode的提交结果，令我惊讶的是，Java短短10多行的代码竟然占用40M的运行内存。但运行时间仅用了2毫秒。而Go语言内存只占用了5M，果然性能很高。</p><p><img src="/2020/04/19/leetcode-liang-shu-xiang-jia/2.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手写快速排序</title>
      <link href="/2020/04/18/shou-xie-kuai-su-pai-xu/"/>
      <url>/2020/04/18/shou-xie-kuai-su-pai-xu/</url>
      
        <content type="html"><![CDATA[<p>快速排序由C. A. R. Hoare在1960年提出。它的基本思想是：通过一趟排序将要排序的数据分割成独立的两部分，其中一部分的所有数据都比另外一部分的所有数据都要小，然后再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。快速排序算法是冒泡排序的一种改进，在面试中经常会有排序算法题，快速排序是高频的算法考查点。</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/1.jpg" alt></p><h2 id="算法思想"><a href="#算法思想" class="headerlink" title="算法思想"></a>算法思想</h2><p>快速排序属于分治思想，即把原数组按一定的规则划分为两个部分，然后再以同样的规则继续划分这两个部分，直到不能再划分为止。那为什么使用二分法把数组分为两个部分，而不使用三分法把数组分成三个部分呢。二分法相比于三分法思路更清晰简单。而且就算法复杂度而言，三分法也没什么优势。算法步骤也很简单，我总结分为四步</p><ol><li><code>选基准数</code>：在数组中随机选择一个数字作为基准数。不要被基准数这个名词吓到，说白了就是在数组中随便选一个数，我们把它叫做基准数。一般的我们就选择数组的第一个元素作为基准数。</li><li><code>比较交换</code>：设置两个游标，一个游标从数组的右边左走，遇到比基准数小的就停下，另一个游标从数组的左边往右走，遇到比基准数大的就停下，然后交换这个数字的位置。重复步骤2，直到两个游标相遇时进入步骤3（其实就是在用两个游标遍历数组，最终目的就是把数组中大于基准数的数字放数组右边，把小于基准数的数字放数组左边）</li><li><code>校准中轴</code>：步骤2中两个游标相遇的点，我们称之为中轴。这一步我们要做的就是把基准数和中轴点所在的数字交换位置。（因为中轴的位置和基准数的位置不一定会重合，经过步骤2后，我们需要保证数组被分为的两部分左边的比基本数小，右边的比基准数大，这必须把基准数和中轴数位置交换。这是整个快速排序的关键步骤）</li><li><code>递归快排</code>：经过步骤3后，数组的两个部分已经划分完毕，只需以同样的方式，继续划分这个两个部分即可</li></ol><h2 id="算法图解"><a href="#算法图解" class="headerlink" title="算法图解"></a>算法图解</h2><p>这里以一个具体的实例来图解算法过程吧，假设有一个数组 <code>int[] array = {3,1,4,7,5,2,8,9,6}</code> ，用快速排序进行排序。</p><h3 id="第一次递归"><a href="#第一次递归" class="headerlink" title="第一次递归"></a>第一次递归</h3><p>第一次递归的数组是原始数组，我们选择数组的第一个元素3作为基准数</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/21.png" alt></p><p>首先哨兵j开始出动。一定需要让哨兵j先出动，这一点非常重要（也是算法实现的一个细节点，如果不是左边的哨兵先动，最后无法完成排序）。哨兵j一步一步地向左挪动（即<code>j--</code>），直到找到一个小于3的数停下来。接下来哨兵i再一步一步向右挪动（即<code>i++</code>），直到找到一个数大于3的数停下来。最后哨兵j停在了数字2上，哨兵i停在了数字4上。</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/22.png" alt></p><p>然后交换4和2的位置。交换后数组的序列顺序如下</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/24.png" alt></p><p>到此，第一次交换结束。接下来开始哨兵j继续向左挪动。这时移动到2数字上时，哨兵j发现了2比3小于是停下。然后i往右移。正当哨兵i准备右移时，他发现哨兵j就在2上，他们两个相遇了。</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/25.png" alt></p><p>至此第一次递归结束，这时我们可以看到中轴数是2，中轴数的右边全都比基准数3大，中轴数的左边除了3都比基准数小。这是需要校准中轴了，即把中轴数和基准数交换位置，交换位置后，数组序列如下</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/26.png" alt></p><h3 id="第二次递归"><a href="#第二次递归" class="headerlink" title="第二次递归"></a>第二次递归</h3><p>经过第一次递归后，原始数组被划分为两个数组，分别是 <code>[2,1]</code> 和 <code>[7,5,4,8,9,6]</code>。以第二个数组为例。</p><p><img src="/2020/04/18/shou-xie-kuai-su-pai-xu/27.png" alt></p><p>后面的就不说了，和前面的步骤一样。</p><h2 id="Java代码实现"><a href="#Java代码实现" class="headerlink" title="Java代码实现"></a>Java代码实现</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>sort<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2020/4/18 14:07 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SortTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>array<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> item <span class="token operator">:</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 快速排序     * */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span><span class="token keyword">int</span> start<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>start<span class="token operator">></span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> low <span class="token operator">=</span> start<span class="token punctuation">;</span>        <span class="token keyword">int</span> height <span class="token operator">=</span> end<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 基准数</span>        <span class="token keyword">int</span> base <span class="token operator">=</span> arr<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>start<span class="token operator">&lt;</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意点</span>            <span class="token comment" spellcheck="true">// 1.必须从数组的右边先开始</span>            <span class="token comment" spellcheck="true">// 2.与基准数比较时必须是>=或&lt;=，不能只是>或&lt;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span><span class="token operator">>=</span>base <span class="token operator">&amp;&amp;</span> start<span class="token operator">&lt;</span>end<span class="token punctuation">)</span>                end<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token operator">&lt;=</span>base <span class="token operator">&amp;&amp;</span> start<span class="token operator">&lt;</span>end<span class="token punctuation">)</span>                start<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 左边找到一个比基准数大的，右边找到一个比基准数小的。两个数交换位置</span>            <span class="token keyword">int</span> temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>            arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span><span class="token punctuation">;</span>            arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 找完一轮后，将轴中数与基准数交换位置（目的是保证基准数始终处于交换轴的位置）</span>        arr<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>        arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span> <span class="token operator">=</span> base<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 左右两个数组继续递归快排</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>low<span class="token punctuation">,</span>start<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>start<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>在上面代码注释中我已经提到了两个注意点，这里总结一下，应该有四个注意点</p><ol><li>在<code>quickSort</code>方法中首先应判断 <code>start&gt;end</code> ，为 true 则结束方法。如不判断递归调用时会无限递归致使堆栈溢出</li><li>左右两个哨兵移动时，要保证总是右边的哨兵先往左移动。</li><li>在元素与基准数比较的时候要使用 <code>&gt;=</code> 或 <code>&lt;=</code>。如果仅仅使用 <code>&gt;</code> 或 <code>&lt;</code> ，会导致死循环。</li><li>比较完一轮后，基准数要和中轴数交换位置，否则会导致排序失败</li></ol>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开发必需学会的Linux命令</title>
      <link href="/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/"/>
      <url>/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/</url>
      
        <content type="html"><![CDATA[<p>市场大部分服务都运行Linux之上，开发过程中难免需要到服务器上查看服务日志，环境部署，排查问题等。操作系统是计算机科学都要接触的基本概念，抛开那些纯理论的操作系统底层实现，在Linux下做软件开发这么多年，每次程序运行出现问题，都要一步一步分析进程各种状态，去排查问题出在哪里。这里总结一下开发常用的Linux命令，以便日后方便查阅</p><p><img src="/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/1.jpg" alt></p><p>本文命令以<code>CentOS release 7.6.1810</code>版本为准，下面分几大类总结开发过程中常用的命令</p><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><p>在服务器上我们常需要查看进程的CPU，内存使用情况，获取进程的PID。线程是操作操作系统能够进行运算调度的最小单位。大部分情况下，它被包含在进程之中，是进程中的实际运作单位，一个进程内可以包含多个线程，是资源调度的最小单位</p><h3 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h3><p>ps命令是Process Status的缩写, 用来列出系统中当前运行的那些进程. ps命令列出的是当前那些进程的快照，就是执行ps命令的那个时刻的那些进程，如果想要动态的显示进程信息，就可以使用top命令</p><p>ps -ef ：用于列出系统中所有运行的进程，如果需要查看 Java进程可通过 grep进行过滤</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos /]# ps -efUID        PID  PPID  C STIME TTY          TIME CMDroot         1     0  0  2019 ?        00:00:01 /sbin/initroot         2     0  0  2019 ?        00:00:01 [kthreadd]root         3     2  0  2019 ?        00:07:27 [ksoftirqd/0]root         5     2  0  2019 ?        00:00:00 [kworker/0:0H]root         7     2  0  2019 ?        00:00:00 [migration/0]root         8     2  0  2019 ?        00:00:00 [rcu_bh]root         9     2  0  2019 ?        00:19:41 [rcu_sched]root        10     2  0  2019 ?        00:00:00 [lru-add-drain]root        11     2  0  2019 ?        00:01:22 [watchdog/0]root        13     2  0  2019 ?        00:00:00 [kdevtmpfs]root        14     2  0  2019 ?        00:00:00 [netns]root        15     2  0  2019 ?        00:00:03 [khungtaskd]root        16     2  0  2019 ?        00:00:00 [writeback]root        17     2  0  2019 ?        00:00:00 [kintegrityd]root        18     2  0  2019 ?        00:00:00 [bioset]root        19     2  0  2019 ?        00:00:00 [bioset][root@VM_0_3_centos /]# ps -ef|grep javaroot     2415 29781  0 22:56 pts/0    00:00:00 grep --color=auto javaroot     11115     1  0  2019 ?        04:33:17 java -jar spring-boot-demo-1.0-SNAPSHOT.jar</code></pre><p>ps  -aux：列出目前所有的正在内存当中的程序</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos /]# ps -auxUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMANDroot         1  0.0  0.2  43504  2652 ?        Ss    2019  26:10 /sbin/initroot         2  0.0  0.0      0     0 ?        S     2019   0:01 [kthreadd]root         3  0.0  0.0      0     0 ?        S     2019   7:27 [ksoftirqd/0]root         5  0.0  0.0      0     0 ?        S<    2019   0:00 [kworker/0:0H]root         7  0.0  0.0      0     0 ?        S     2019   0:00 [migration/0]root         8  0.0  0.0      0     0 ?        S     2019   0:00 [rcu_bh]root         9  0.0  0.0      0     0 ?        R     2019  19:41 [rcu_sched]root        10  0.0  0.0      0     0 ?        S<    2019   0:00 [lru-add-drain]root        11  0.0  0.0      0     0 ?        S     2019   1:22 [watchdog/0]root        13  0.0  0.0      0     0 ?        S     2019   0:00 [kdevtmpfs]root        14  0.0  0.0      0     0 ?        S<    2019   0:00 [netns]</code></pre><h3 id="pstree"><a href="#pstree" class="headerlink" title="pstree"></a>pstree</h3><p>pstree按树形结构打印运行中进程结构信息，可以直观的查看进程和它启动的线程的关系，并能显示进程标识。例如查看服务器上运行的 Java进程，通过 <code>ps -ef|grep java</code> 得到 Java进程的PID是 11115</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos /]# pstree -p 11115java(11115)─┬─{java}(11116)            ├─{java}(11117)            ├─{java}(11118)            ├─{java}(11119)            ├─{java}(11120)            ├─{java}(11121)            ├─{java}(11122)            ├─{java}(11123)            ├─{java}(11124)            ├─{java}(11150)            ├─{java}(11152)            ├─{java}(11153)            ├─{java}(11156)            ├─{java}(11157)            ├─{java}(11158)            ├─{java}(11159)            ├─{java}(11160)            ├─{java}(11161)            ├─{java}(11162)            ├─{java}(11163)            ├─{java}(11164)            ├─{java}(11165)            ├─{java}(11166)            ├─{java}(11167)            └─{java}(11168)</code></pre><p>可以看到在PID为11115进程中有25个线程，并且显示了线程的PID</p><h3 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h3><p>打印出运行中程序的堆栈信息。执行命令<code>pstack pid</code> 你能看到当前线程运行中的堆栈信息，其中的pid可用之前的<code>ps</code>命令获得，<code>pstack</code>可以看到进程内启动的线程号，每个进程内线程的「堆栈」内容也能看到。我们同样查看Java进程的堆栈信息</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos /]# pstack 11115Thread 26 (Thread 0x7f0b260f1700 (LWP 11116)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e053ab in os::PlatformEvent::park() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba529 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbb950 in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24f6aff1 in Threads::destroy_vm() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b25ab1418 in JavaMain () from /user/java/jdk1.8.0_221/bin/../lib/amd64/jli/libjli.so#7  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#8  0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 25 (Thread 0x7f0b0f7f0700 (LWP 11117)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24dface7 in os::PlatformEvent::park(long) [clone .part.33] () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba614 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbba8a in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24fc7922 in VMThread::loop() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b24fc7eb8 in VMThread::run() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#7  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#8  0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 24 (Thread 0x7f0b0f6ef700 (LWP 11118)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e053ab in os::PlatformEvent::park() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24de92d5 in ObjectMonitor::wait(long, bool, Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24be29b8 in JVM_MonitorWait () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#32 0x0000000000000000 in ?? ()Thread 23 (Thread 0x7f0b0f5ee700 (LWP 11119)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e053ab in os::PlatformEvent::park() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24de92d5 in ObjectMonitor::wait(long, bool, Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24be29b8 in JVM_MonitorWait () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x0000000000000000 in ?? ()Thread 22 (Thread 0x7f0b0f4ed700 (LWP 11120)):#0  0x00007f0b25cceadb in do_futex_wait.constprop.1 () from /lib64/libpthread.so.0#1  0x00007f0b25cceb6f in __new_sem_wait_slow.constprop.0 () from /lib64/libpthread.so.0#2  0x00007f0b25ccec0b in sem_wait@@GLIBC_2.2.5 () from /lib64/libpthread.so.0#3  0x00007f0b24dfb2d5 in check_pending_signals(bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24df320c in signal_thread_entry(JavaThread*, Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b24f6aa9b in JavaThread::thread_main_inner() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b24f6ada1 in JavaThread::run() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#9  0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 21 (Thread 0x7f0b0f3ec700 (LWP 11121)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24dface7 in os::PlatformEvent::park(long) [clone .part.33] () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba614 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbbace in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b2497c01b in CompileBroker::compiler_thread_loop() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b24f6aa9b in JavaThread::thread_main_inner() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00007f0b24dfc952 in java_start(Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#10 0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 20 (Thread 0x7f0b0f2eb700 (LWP 11122)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24dface7 in os::PlatformEvent::park(long) [clone .part.33] () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba614 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbbace in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24973772 in CompileQueue::get() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b2497c01b in CompileBroker::compiler_thread_loop() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b24f6aa9b in JavaThread::thread_main_inner() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#7  0x00007f0b24f6ada1 in JavaThread::run() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00007f0b24dfc952 in java_start(Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#10 0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 19 (Thread 0x7f0b0f1ea700 (LWP 11123)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e053ab in os::PlatformEvent::park() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba529 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbba8a in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24eac4d1 in ServiceThread::service_thread_entry(JavaThread*, Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b24f6aa9b in JavaThread::thread_main_inner() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#7  0x00007f0b24dfc952 in java_start(Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#9  0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 18 (Thread 0x7f0b0f0e9700 (LWP 11124)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24dface7 in os::PlatformEvent::park(long) [clone .part.33] () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24dba614 in Monitor::IWait(Thread*, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24dbba8a in Monitor::wait(bool, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#4  0x00007f0b24f5e60a in WatcherThread::run() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#5  0x00007f0b24dfc952 in java_start(Thread*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b25cc8dd5 in start_thread () from /lib64/libpthread.so.0#7  0x00007f0b255d5ead in clone () from /lib64/libc.so.6Thread 17 (Thread 0x7f0b0efe8700 (LWP 11150)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05aea in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b0efe7840 in ?? ()#7  0x00007f0b255ebc6d in clock_gettime () from /lib64/libc.so.6#8  0x00007f0b24dfd5cf in os::javaTimeNanos() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#22 0x00000000f6369810 in ?? ()#23 0x00007f0b24dfd5cf in os::javaTimeNanos() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.soThread 16 (Thread 0x7f0b0dc32700 (LWP 11152)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#6  0x00007f0b0dc31840 in ?? ()#7  0x00007f0b255ebc6d in clock_gettime () from /lib64/libc.so.6#8  0x00007f0b24dfd5cf in os::javaTimeNanos() () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#18 0x0000000000000000 in ?? ()Thread 15 (Thread 0x7f0b0cf1f700 (LWP 11153)):#0  0x00007f0b25cccd12 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24dface7 in os::PlatformEvent::park(long) [clone .part.33] () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24e02586 in os::sleep(Thread*, long, bool) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b24bf366a in JVM_Sleep () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#16 0x0000000000000000 in ?? ()Thread 14 (Thread 0x7f0b0cc1e700 (LWP 11156)):#0  0x00007f0b255d6483 in epoll_wait () from /lib64/libc.so.6#1  0x00007f0b0d927844 in Java_sun_nio_ch_EPollArrayWrapper_epollWait () from /user/java/jdk1.8.0_221/jre/lib/amd64/libnio.so#6  0x0000000000000000 in ?? ()Thread 13 (Thread 0x7f0b0cb1d700 (LWP 11157)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 12 (Thread 0x7f0b0ca1c700 (LWP 11158)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 11 (Thread 0x7f0b0c91b700 (LWP 11159)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00000000f643fbc8 in ?? ()#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#13 0x00007f0b110594e2 in ?? ()#14 0x0000000000000000 in ?? ()Thread 10 (Thread 0x7f0b0c81a700 (LWP 11160)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00000000f643fbc8 in ?? ()#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#13 0x00007f0b110594e2 in ?? ()#14 0x0000000000000000 in ?? ()Thread 9 (Thread 0x7f0b0c719700 (LWP 11161)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00000000f643fbc8 in ?? ()#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 8 (Thread 0x7f0b0c618700 (LWP 11162)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00000000f643fbc8 in ?? ()#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#13 0x00007f0b110594e2 in ?? ()#14 0x0000000000000000 in ?? ()Thread 7 (Thread 0x7f0b0c517700 (LWP 11163)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#3  0x00007f0b10db83ea in ?? ()#4  0x00000000f5b9c730 in ?? ()#5  0x00007f0b24fc6ff0 in VMThread::execute(VM_Operation*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#11 0x0000000000000000 in ?? ()Thread 6 (Thread 0x7f0b0c416700 (LWP 11164)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#8  0x00000000f643fbc8 in ?? ()#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 5 (Thread 0x7f0b0c315700 (LWP 11165)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 4 (Thread 0x7f0b0c214700 (LWP 11166)):#0  0x00007f0b25ccc965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0#1  0x00007f0b24e05ac0 in Parker::park(bool, long) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#2  0x00007f0b24f9347b in Unsafe_Park () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#9  0x00000000f6493598 in ?? ()#10 0x00007f0b254b6f8c in os::_initial_active_processor_count () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#14 0x0000000000000000 in ?? ()Thread 3 (Thread 0x7f0b0c113700 (LWP 11167)):#0  0x00007f0b255d6483 in epoll_wait () from /lib64/libc.so.6#1  0x00007f0b0d927844 in Java_sun_nio_ch_EPollArrayWrapper_epollWait () from /user/java/jdk1.8.0_221/jre/lib/amd64/libnio.so#3  0x00000000f643f968 in ?? ()#4  0x00007f0b2494bf2c in CollectedHeap::new_store_pre_barrier(JavaThread*, oopDesc*) () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#17 0x0000000000000000 in ?? ()Thread 2 (Thread 0x7f0af9ad5700 (LWP 11168)):#0  0x00007f0b25ccf97d in accept () from /lib64/libpthread.so.0#1  0x00007f0b0d92b1d3 in Java_sun_nio_ch_ServerSocketChannelImpl_accept0 () from /user/java/jdk1.8.0_221/jre/lib/amd64/libnio.so#9  0x00000000f643dcc8 in ?? ()#10 0x00007f0b24be85a4 in JVM_IsInterrupted () from /user/java/jdk1.8.0_221/jre/lib/amd64/server/libjvm.so#13 0x0000000000000000 in ?? ()Thread 1 (Thread 0x7f0b260f2740 (LWP 11115)):#0  0x00007f0b25cc9f47 in pthread_join () from /lib64/libpthread.so.0#1  0x00007f0b25ab6855 in ContinueInNewThread0 () from /user/java/jdk1.8.0_221/bin/../lib/amd64/jli/libjli.so#2  0x00007f0b25ab2c42 in ContinueInNewThread () from /user/java/jdk1.8.0_221/bin/../lib/amd64/jli/libjli.so#3  0x00007f0b25ab3368 in JLI_Launch () from /user/java/jdk1.8.0_221/bin/../lib/amd64/jli/libjli.so#4  0x000000000040053a in main ()</code></pre><p>看到上面打印出的LWP了吗，这里是个知识点， LPW是指<code>Light-weight process</code> 轻量级线程。引申知识：</p><ol><li>Linux中没有真正的线程</li><li>Linux中没有的线程<code>Thread</code>是由进程来模拟实现的所以称作：轻量级进程</li><li>进程是「资源管理」的最小单元，线程是「资源调度」的最小单元（这里不考虑协程）</li></ol><h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p> 跟踪进程内部的系统调用和信号，什么是「系统调用」？系统调用（system call），指运行在「用户态」的程序向操作系统「内核态」请求需要更高权限运行的服务，系统调用提供用户程序与操作系统之间的接口。一般涉及的硬件操作的都会由用户态转向内核态，如读写磁盘。<code>strace</code>后面跟着启动一个进程，可以跟踪启动后进程的系统调用和信号，这个命令可以看到进程执行时候都调用了哪些系统调用，<strong>通过指定不同的选项可以输出系统调用发生的时间，精度可以精确到微秒，甚至还可以统计分析系统「调用的耗时」。这在排查进程假死问题的时候很有用，能帮你发现进程卡在哪个系统调用上。已经在运行的进程也可以指定<code>-p</code>参数加pid，查看进程信息</strong></p><pre class=" language-shell"><code class="language-shell">strace -o output.txt -T -tt -e trace=all -p 2897927207 mkdir("/tmp/.ICE-unix", 0777) = -1 EEXIST (File exists)27207 lstat64("/tmp/.ICE-unix", {st_mode=S_IFDIR|S_ISVTX|0755, st_size=4096, ...}) = 027207 unlink("/tmp/.ICE-unix/dcop27207-1066844596") = -1 ENOENT (No such file or directory)27207 bind(3, {sin_family=AF_UNIX, path="/tmp/.ICE-unix/dcop27207-1066844596"}, 38) = -1 EACCES (Permission denied) 27207 write(2, "_KDE_IceTrans", 13) = 1327207 write(2, "SocketCreateListener: failed to "..., 46) = 4627207 close(3) = 0 27207 write(2, "_KDE_IceTrans", 13) = 1327207 write(2, "SocketUNIXCreateListener: ...Soc"..., 59) = 5927207 umask(0) = 0 27207 write(2, "_KDE_IceTrans", 13) = 1327207 write(2, "MakeAllCOTSServerListeners: fail"..., 64) = 6427207 write(2, "Cannot establish any listening s"..., 39) = 39</code></pre><p>每一行都是一条系统调用，等号左边是系统调用的函数名及其参数，右边是该调用的返回值。其中第一行显示程序试图创建/tmp/.ICE-unix目录，权限为0777，这个操作因为目录已经存在而失败了。第二个系统调用（lstat64）检查 了目录状态，并显示这个目录的权限是0755，这里出现了第一个程序运行错误的线索：程序试图创建属性为0777的目录，但是已经存在了一个属性为 0755的目录。第三个系统调用（unlink）试图删除一个文件，但是这个文件并不存在。strace的常用参数如下</p><p>-tt ：在每行输出的前面，显示毫秒级别的时间<br>-T ：显示每次系统调用所花费的时间<br>-v ：对于某些相关调用，把完整的环境变量，文件stat结构等打出来。<br>-f ：跟踪目标进程，以及目标进程创建的所有子进程<br>-e ：控制要跟踪的事件和跟踪行为,比如指定要跟踪的系统调用名称<br>-o ：把strace的输出单独写到指定的文件<br>-s ：当系统调用的某个参数是字符串时，最多输出指定长度的内容，默认是32个字节<br>-p ：指定要跟踪的进程pid, 要同时跟踪多个pid, 重复多次-p选项即可。</p><h3 id="proc目录"><a href="#proc目录" class="headerlink" title="proc目录"></a>proc目录</h3><p>/proc目录下有很多以数字命名的目录，每个数字代表进程号PID它们是进程目录。<code>/proc</code>系统是一个伪文件系统，它只存在内存当中，而不占用外存空间，以文件系统的方式为内核与进程提供通信的接口。进入系统<code>/proc</code>目录：</p><p><img src="/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/2.png" alt></p><p>系统中当前运行的每一个进程在/proc下都对应一个以进程号为目录名的目录<code>/proc/pid</code>。通过<code>/proc/pid</code>文件了解进程的运行时信息和统计信息。它们是读取进程信息的接口，我们可以进到这个文件里面，了解进程的运行时信息和统计信息。<code>/proc/pid</code>目录下的有一些重要文件，挑几个使用频率高的讲一讲。</p><h4 id="高频使用"><a href="#高频使用" class="headerlink" title="高频使用"></a>高频使用</h4><p><strong><code>/proc/pid/environ</code></strong> ：包含了进程的可用环境变量的列表 。程序出问题了如果不确定环境变量是否设置生效，可以<code>cat</code>这个文件出来查看确认一下。</p><p><strong><code>/proc/pid/fd/</code></strong> ：这个目录包含了进程打开的每一个文件的链接。从这里可以查看进程打开的文件描述符信息，包括标准输入、输出、错误流，进程打开的<code>socket</code>连接文件描述符也能看到，<code>lsof</code>命令也有类似的作用。</p><p><strong><code>/proc/pid/stat</code></strong> ：包含了进程的所有状态信息，进程号、父进程号、 线程组号、 该任务在用户态运行的时间 、 该任务在用内核态运行的时间、 虚拟地址空间的代码段、 阻塞信号的位图等等信息应有尽有。</p><p><strong><code>/proc/pid/cmdline</code></strong> ：该文件保存了进程的完整命令行</p><p><strong><code>/proc/pid/cwd</code></strong> ：一个符号连接, 指向进程当前的工作目录</p><p><strong><code>/proc/pid/exe</code></strong>： 包含了正在进程中运行的程序链接</p><p><strong><code>/proc/pid/mem</code></strong>： 包含了进程在内存中的内容</p><p><strong><code>/proc/pid/statm</code></strong>： 包含了进程的内存使用信息</p><h2 id="vi编辑文件"><a href="#vi编辑文件" class="headerlink" title="vi编辑文件"></a>vi编辑文件</h2><p>vi编辑器是所有Unix及Linux系统下标准的编辑器，他就相当于windows系统中的<strong>记事本</strong>一样，它的强大不逊色于任何最新的文本编辑器。他是我们使用Linux系统不能缺少的工具。由于对Unix及Linux系统的任何版本，vi编辑器是完全相同的，通常我们在部署时，常需要修改服务配置文件中的一些配置，这时就需要使用vi编辑文件了。vi可以分为三种模式，我把它叫做<code>读模式</code>，<code>写模式</code>，<code>命令模式</code>。网上的叫法挺多，例如一般模式，编辑模式或是输入模式，末行模式。没有一个统一的叫法。</p><ul><li><code>读模式</code>：通过vi命令刚进入文件的状态，这时内容是只读的不能修改</li><li><code>写模式</code>：进入到读模式后通过按键【I】，进入写模式，这时可以编辑文件内容</li><li><code>命令模式</code>：在读模式下通过 组合按键【Shift+:】，进入到命令模式。</li></ul><h3 id="vi-text-yml-进入读模式"><a href="#vi-text-yml-进入读模式" class="headerlink" title="vi  text.yml 进入读模式"></a>vi  text.yml 进入读模式</h3><p>通过vi+空格+文件名，来进入到文件编辑，这时文本末尾会出现 <strong>insert</strong> 单词，表明当前是在写模式下</p><p><img src="/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/3.png" alt></p><p>然后我们就可以通过 上下左右 方向键来控制光标，修改文本了。</p><h3 id="【Esc】-退出写模式，回到读模式"><a href="#【Esc】-退出写模式，回到读模式" class="headerlink" title="【Esc】 退出写模式，回到读模式"></a>【Esc】 退出写模式，回到读模式</h3><p>文件编辑好后，通过esc键回到读模式，表示我们刚刚的文件已经修改完成了，这时我们需要进入命令模式，通过命令来保存我们刚刚修改的文件</p><h3 id="【Shift-】命令模式"><a href="#【Shift-】命令模式" class="headerlink" title="【Shift+:】命令模式"></a>【Shift+:】命令模式</h3><p>在命令模式中，我们可以强制退出，保存退出，或者将修改的文件另存为一个新的文件。一般的会使用 <code>:wq</code>命令，然后按回车键，表示保存退出</p><p><img src="/2020/04/16/kai-fa-bi-xu-xue-hui-de-linux-ming-ling/4.png" alt></p><p>下面来看一下有哪些命令</p><ul><li><code>:w</code>   保存编辑的内容</li><li><code>:w!</code>  强制写入该文件，但跟你对该文件的权限有关</li><li><code>:q</code>    离开vi</li><li><code>:q!</code>  不想保存修改强制离开</li><li><code>:wq</code>   保存后退出，<strong>这个命令最常用</strong></li><li><code>:x</code>     保存后离开</li><li><code>:zz</code>   若文件没有更动，则不保存离开，若文件已经被更改过，则保存后离开</li><li><code>:w filename</code>  将编辑的数据保存成另一个文件（类似另存）</li><li><code>:r filename</code>   在编辑的数据中，读入另一个文件的数据。即将【filename】 这个文件的内容加到光标所在行后面。</li><li><code>:n1,n2 w filename</code>    将n1到n2的内容保存成filename这个文件。n1和n2是文件内容的行号</li></ul><h2 id="操作系统信息"><a href="#操作系统信息" class="headerlink" title="操作系统信息"></a>操作系统信息</h2><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>top命令是Linux下常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况，类似于Windows的任务管理器。top是一个动态显示过程,即可以通过用户按键来不断刷新当前状态.如果在前台执行该命令,它将独占前台,直到用户终止该程序为止.比较准确的说,top命令提供了实时的对系统处理器的状态监视.它将显示系统中CPU最敏感的任务列表.该命令可以按CPU使用.内存使用和执行时间对任务进行排序；而且该命令的很多特性都可以通过交互式命令或者在个人定制文件中进行设定。前五行是当前系统情况整体的统计信息区。</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos 11116]# toptop - 08:17:12 up 199 days, 13:12,  1 user,  load average: 0.44, 0.14, 0.08Tasks:  79 total,   1 running,  78 sleeping,   0 stopped,   0 zombie%Cpu(s):  3.0 us,  2.7 sy,  0.0 ni, 94.0 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 stKiB Mem :  1015024 total,   114888 free,   441148 used,   458988 buff/cacheKiB Swap:        0 total,        0 free,        0 used.   403244 avail Mem   PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                                                                                                                                                     23983 root      20   0  611272  13824   1672 S  2.7  1.4   1084:39 barad_agent                                                                                                                                                  1282 root      20   0  129536  56032  55700 S  0.7  5.5  70:47.87 systemd-journal                                                                                                                                              9816 root      20   0  178236  48224   2916 S  0.7  4.8 125:08.10 YDService                                                                                                                                                    2983 root      20   0  871408 201300  32616 S  0.3 19.8  44:22.61 rsyslogd                                                                                                                                                        1 root      20   0   43504   2652   1384 S  0.0  0.3  26:13.90 systemd                                                                                                                                                         2 root      20   0       0      0      0 S  0.0  0.0   0:01.27 kthreadd                                                                                                                                                        3 root      20   0       0      0      0 S  0.0  0.0   7:28.86 ksoftirqd/0                                                                                                                                                     5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H                                                                                                                                                    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0                                                                                                                                                     8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh                                                                                                                                                          9 root      20   0       0      0      0 S  0.0  0.0  19:44.31 rcu_sched                                                                                                                                                      10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-drain                                                                                                                                                  11 root      rt   0       0      0      0 S  0.0  0.0   1:22.41 watchdog/0                                                                                                                                                     13 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kdevtmpfs                                                                                                                                                      14 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 netns                                                                                                                                                          15 root      20   0       0      0      0 S  0.0  0.0   0:03.25 khungtaskd                                                                                                                                                     16 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 writeback                                                                                                                                                      17 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kintegrityd                                                                                                                                                    18 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset                                                                                                                                                         19 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset                                                                                                                                                         20 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset                                                                                                                                                         21 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kblockd                                                                                                                                                        22 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 md                                                                                                                                                             23 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 edac-poller                                                                                                                                                    24 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 watchdogd                                                                                                                                                      30 root      20   0       0      0      0 S  0.0  0.0   1:34.06 kswapd0                                                                                                                                                        31 root      25   5       0      0      0 S  0.0  0.0   0:00.00 ksmd                                                                                                                                                           32 root      39  19       0      0      0 S  0.0  0.0   0:24.61 khugepaged                                                                                                                                                     33 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 crypto                                                                                                                                                         41 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kthrotld           </code></pre><p><strong>第一行</strong>：任务队列信息，同 uptime 命令的执行结果，具体参数说明情况如下</p><ul><li><code>08:17:12</code>：当前系统时间</li><li><code>up 199 days, 13:12</code>：系统已经运行了199天13小时12分钟（在这期间系统没有重启过的哦！）</li><li><code>1 user</code>：当前有1个用户登录系统</li><li><code>load average: 0.44, 0.14, 0.08</code>：后面的三个数字分别是1分钟、5分钟、15分钟的负载情况。load average数据是每隔5秒钟检查一次活跃的进程数，然后按特定算法计算出的数值。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。</li></ul><p><strong>第二行</strong>：Tasks — 任务（进程）信息</p><ul><li><code>79 total</code>：系统现在共有206个进程</li><li><code>1 running</code>：处于运行中的有1个</li><li><code>78 sleeping</code>：78个在休眠（sleep）</li><li><code>0 stopped</code>：stoped状态的有0个</li><li><code>0 zombie</code>：zombie状态（僵尸）的有0个。</li></ul><p><strong>第三行</strong>：%Cpu(s) – cpu状态信息。<strong>注意</strong>：在这里CPU的使用比率和windows概念不同，需要理解linux系统用户空间和内核空间的相关知识！</p><ul><li><code>3.0 us</code>：用户空间占用CPU的百分比</li><li><code>2.7 sy</code>：内核空间占用CPU的百分比</li><li><code>0.0 ni</code>：改变过优先级的进程占用CPU的百分比</li><li><code>94.0 id</code>：空闲CPU百分比</li><li><code>0.3 wa</code>：IO等待占用CPU的百分比</li><li><code>0.0 hi</code>：硬中断（Hardware IRQ）占用CPU的百分比</li><li><code>0.0 si</code>：软中断（Software Interrupts）占用CPU的百分比</li><li><code>0.0 st</code>：这个虚拟机被hypervisor偷去的CPU时间（注：如果当前OS是处于一个hypervisor下的vm，实际上hypervisor也是要消耗一部分CPU处理时间的）。</li></ul><p><strong>第四行</strong>：KiB Mem – 内存状态</p><ul><li><code>1015024 total</code>：物理内存总量（1GB）</li><li><code>114888 free</code>：使用中的内存总量（114MB）</li><li><code>441148 used</code>：空闲内存总量（441MB）</li><li><code>458988 buff/cache</code>：缓存的内存量 （458MB）</li></ul><p><strong>第五行</strong>：swap交换分区信息</p><ul><li>0 total：交换区总量（0K）</li><li>0 free：空闲交换区总量（0K）</li><li>0 used：使用的交换区总量（0K）</li><li>403244 avail Mem：可用的交换区总量（403MB）</li></ul><p>第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心。如果出于习惯去计算可用内存数，<strong>这里有个近似的可用内存计算公式</strong>：第四行的free + 第四行的buffers + 第五行的cached，按这个公式此台服务器的可用内存：114888KB +458988KB +403244KB = 972MB左右。</p><p><strong>对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。</strong></p><p><strong>第七行</strong>：各进程（任务）的状态监控，项目列信息说明如下</p><ul><li><code>PID</code> ：进程id</li><li><code>USER</code> ：进程所有者，注意进程所有者同意也是进程拥有的权限，假如一个进程是 test 用户拥有，test用户没有某个目录的文件访问权限，那么当进程访问这个目录文件时，同样会有权限问题。</li><li><code>PR</code> ：进程优先级</li><li><code>NI</code> ：nice值。负值表示高优先级，正值表示低优先级</li><li><code>VIRT</code> ：进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</li><li><code>RES</code> ：进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</li><li><code>SHR</code> ：共享内存大小，单位kb</li><li><code>S</code> ：进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程</li><li><code>%CPU</code>：上次更新到现在的CPU时间占用百分比</li><li><code>%MEM</code>：进程使用的物理内存百分比</li><li><code>TIME+</code>：进程使用的CPU时间总计，单位1/100秒</li><li><code>COMMAND</code> ：进程名称（命令名/命令行）</li></ul><h3 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h3><p>vmstat命令是最常见的Linux/Unix监控工具，可以展现给定时间间隔的服务器的状态值,包括服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况。这个命令是我查看Linux/Unix最喜爱的命令，一个是Linux/Unix都支持，二是相比top，我可以看到整个机器的CPU,内存,IO的使用情况，而不是单单看到各个进程的CPU使用率和内存使用率(使用场景不一样)。</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos 11116]# vmstat 2 3   procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st 3  0      0  77316  41716 455136    0    0    11    27    1    0  1  1 98  0  0 0  0      0  75044  41716 455160    0    0     8     2  312  598  1  1 98  1  0 0  0      0  75668  41728 455156    0    0    10    40  490  927  1  2 97  1  0</code></pre><p>一般 <code>vmstat</code> 工具的使用是通过两个数字参数来完成的 第一个参数是采样的时间间隔数，单位是秒 第二个参数是采样的次数</p><ol><li><p><strong>procs</strong>：进程信息</p><ul><li><code>r</code>：运行和等待 CPU 时间片的进程数，原则上1核的 CPU 的运行队列不要超过2，整个系统的运行队列不能超过总核数的2倍，否则代表系统压力过大</li><li><code>b</code>：等待资源的进程数或阻塞的进程，比如正在等待磁盘I/O、网络I/O等</li></ul></li><li><p><strong>memory</strong>：内存信息</p><ul><li><code>swpd</code>：虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。</li><li><code>free</code> ：空闲的物理内存的大小</li><li><code>buff</code>：Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用40多M</li><li><code>cache</code>：直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用455多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地还给程序使用。)</li></ul></li><li><p><strong>swap</strong>：虚拟内存信息</p><ul><li><code>si</code>：每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。</li><li><code>so</code>：每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。</li></ul></li><li><p><strong>io</strong>：系统IO信息</p><ul><li><code>bi</code>：块设备每秒接收的块数量即读块设备，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte</li><li><code>bo</code>：块设备每秒发送的块数量即写块设备，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。</li></ul></li><li><p><strong>system</strong>：系统信息</p><ul><li><code>in</code>：每秒CPU的中断次数，包括时间中断</li><li><code>cs</code>：每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。</li></ul></li><li><p><strong>cpu</strong>：CPU信息</p><ul><li><code>us</code>：用户CPU时间，曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)</li><li><code>sy</code>：空系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。</li><li><code>id</code>：空闲 CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。</li><li><code>wa</code>：等待IO时间，wa过高时，说明io等待比较严重，这可能是由于磁盘大量随机访问造成的，也有可能是磁盘的带宽出现瓶颈</li></ul></li></ol><h3 id="free-内存信息"><a href="#free-内存信息" class="headerlink" title="free  内存信息"></a>free  内存信息</h3><p>应用程序可用内存数 <code>free -g</code> 内存大小按照 GB 统计 <code>free -m</code> 内存大小按照 MB 统计。<code>free -h</code>命令比较直观，统计出来的数字后面自带单位</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos 11116]# free -h              total        used        free      shared  buff/cache   availableMem:           991M        431M         60M        496K        499M        388MSwap:            0B          0B          0B</code></pre><h3 id="df-磁盘信息"><a href="#df-磁盘信息" class="headerlink" title="df  磁盘信息"></a>df  磁盘信息</h3><p><code>df -h</code> 查看磁盘剩余空间</p><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos 11116]# df -hFilesystem      Size  Used Avail Use% Mounted on/dev/vda1        50G  7.2G   40G  16% /devtmpfs        486M     0  486M   0% /devtmpfs           496M   24K  496M   1% /dev/shmtmpfs           496M  472K  496M   1% /runtmpfs           496M     0  496M   0% /sys/fs/cgrouptmpfs           100M     0  100M   0% /run/user/0</code></pre><h4 id="iostat-系统IO信息"><a href="#iostat-系统IO信息" class="headerlink" title="iostat  系统IO信息"></a>iostat  系统IO信息</h4><pre class=" language-shell"><code class="language-shell">[user1@Test_Server ~]$ iostat -xLinux 3.10.0-693.2.2.el7.x86_64 (jellythink)    01/05/2019      _x86_64_        (1 CPU)avg-cpu:  %user   %nice %system %iowait  %steal   %idle           1.83    0.00    0.31    0.09    0.00   97.77Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %utilvda               0.03     0.78    0.24    1.38    12.64    20.67    41.01     0.02   10.98   55.50    3.17   0.71   0.12</code></pre><p><code>iostat -x</code>也可以看到系统的CPU信息，<code>iostat</code>命令的重点不是用来看CPU的，重点是用来监测磁盘性能的。</p><ul><li><code>Device</code>：设备名称</li><li><code>rrqm/s</code>：每秒合并到设备的读取请求数</li><li><code>wrqm/s</code>：每秒合并到设备的写请求数</li><li><code>r/s</code>：每秒向磁盘发起的读操作数</li><li><code>w/s</code>：每秒向磁盘发起的写操作数</li><li><code>rkB/s</code>：每秒读K字节数</li><li><code>wkB/s</code>:每秒写K字节数</li><li><code>avgrq-sz</code>：平均每次设备I/O操作的数据大小</li><li><code>avgqu-sz</code>：平均I/O队列长度</li><li><code>await</code>：平均每次设备I/O操作的等待时间 (毫秒)，一般地，系统I/O响应时间应该低于5ms，如果大于 10ms就比较大了</li><li><code>r_await</code>：每个读操作平均所需的时间；不仅包括硬盘设备读操作的时间，还包括了在kernel队列中等待的时间</li><li><code>w_await</code>：每个写操作平均所需的时间；不仅包括硬盘设备写操作的时间，还包括了在kernel队列中等待的时间</li><li><code>svctm</code>：平均每次设备I/O操作的服务时间 (毫秒)（这个数据不可信！）</li><li><code>%util</code>：一秒中有百分之多少的时间用于I/O操作，即被IO消耗的CPU百分比，一般地，如果该参数是100%表示设备已经接近满负荷运行了</li></ul><h4 id="ifstat-网络IO"><a href="#ifstat-网络IO" class="headerlink" title="ifstat  网络IO"></a>ifstat  网络IO</h4><pre class=" language-shell"><code class="language-shell">[root@VM_0_3_centos 11116]# ifstat#kernelInterface        RX Pkts/Rate    TX Pkts/Rate    RX Data/Rate    TX Data/Rate                   RX Errs/Drop    TX Errs/Drop    RX Over/Rate    TX Coll/Rate  lo                    14 0            14 0          1168 0          1168 0                             0 0             0 0             0 0             0 0      eth0             100481K 0       102661K 0         1059M 0         1923M 0                             0 0             0 0             0 0             0 0 </code></pre><p><code>lo</code>和<code>eth0</code>分别表示的是网卡名称</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>λ演算与函数式编程</title>
      <link href="/2020/04/12/lyan-suan-yu-han-shu-shi-bian-cheng/"/>
      <url>/2020/04/12/lyan-suan-yu-han-shu-shi-bian-cheng/</url>
      
        <content type="html"><![CDATA[<p>最近在阅读一些JS开源组件的源码时，感觉有些吃力。原因在于源码的写法非常娴熟，充分的利用了JS语言函数式的特性，代码老练。虽然我使用JS也有几个年头了，但是仅仅停留在前端页面的一些字段校验和简单逻辑上，没有深入的去理解函数式编程思想。随着近几年函数式编程越来越受到重视，于是决定去学学它的函数式编程思维，与它有相同特性的 Python 也是函数式编程语言，Java8中也引入了函数式编程语言的特性（Java8的Lambda表达式）。我一直觉得学习一样新东西，首先要去了解它的历史，知道来龙去脉才会明白它的背景和价值，才会明白我们为什么要学习它使用它。</p><p><img src="/2020/04/12/lyan-suan-yu-han-shu-shi-bian-cheng/2.jpg" alt></p><h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>现代形式科学的所有的故事都来自于莱布尼茨的两大梦想：<strong>一、建立一套严格精密的人工语言，这种语言没有人类语言的歧义多结构，可以精确地描述任何哲学、逻辑和数学问题；二、找到一种方法，利用这套“普遍语言”，解决任何科学、哲学和数学的问题</strong>。莱布尼茨的梦想，在20世纪先后成真：集合论和符号逻辑、计算科学。而这一切的一切都源自19世纪末20世纪初发生的第三次数学危机。这场危机的结果使得数学、逻辑学和哲学发生了脱胎换骨的变化，数学的公理化、逻辑学的数学化、哲学的逻辑化是这个伟大变革中最显著的特点。不过很遗憾，这里没有空间详细讲故事，只有三个关键词：数学公理化，数学逻辑化和公理集合论。如果对这段历史不太了解可以参考《数学悖论与三次数学危机》第3、4、5章以及《逻辑的引擎》这两本书。λ演算的创建人是Alonzo Church(中文：阿隆佐·丘奇)。Church1903年生于美国华盛顿特区，后在普林斯顿大学学习数学，专攻数理逻辑。函数编程语言最重要的基础是λ演算。是否存在一个通用模型来解决一切计算任务？1936年，阿隆佐·邱奇设计了一个名为lambda演算的形式系统用来解决这个问题。这个系统实质上是为一个超级机器设计的编程语言。在这种语言里面，函数的参数是函数，返回值也是函数。这种函数用希腊字母lambda（λ），这种系统因此得名。除了阿隆佐，艾伦·图灵也在进行类似的研究。他设计了一种完全不同的系统（后来被称为图灵机），并用这种系统得出了和阿隆佐相似的答案。冯.诺依曼结构实现了理论上的图灵机，并且用在了如今的电脑上。而Alonzo Church的计算模型，与图灵机一样强大，但由于一些历史原因（当时整个世界笼罩在战争的火光和硝烟之中，美国陆军和海军前所未有的大量使用炮弹，为了改进炮弹的精确度，部队组织了大批的科学家持续地计算微分方程以解出弹道发射轨迹。在渐渐意识到这个任务用人力手工完成太耗精力后，开始着手开发各种设备来攻克这个难关。第一个解出了弹道轨迹的机器是 IBM 制造的 Mark I，它重达 5 吨，有 75 万个组件，每秒可以完成三次操作。1949 年，第一台电子离散变量自动计算机EDVAC诞生并取得了巨大的成功。它是冯·诺伊曼设计架构的第一个实例，也是一台现实世界中实现的图灵机。那一年开始好运与阿隆佐·丘奇无缘。）走了上了一条更加学术化，更不商业化的道路。后来人们证明图灵机和 λ 演算能力等同。现在我们使用的家用计算机，服务器基本都是图灵机，图灵也因此被誉为计算机之父</p><h2 id="发展"><a href="#发展" class="headerlink" title="发展"></a>发展</h2><p>上世纪50年代末，一个叫John McCarthy（约翰·麦卡锡）的MIT教授（他是普林斯顿的硕士）对阿隆佐的成果产生了兴趣。1958年他发明了一种列表处理语言（Lisp），这种语言是一种阿隆佐lambda演算在现实世界的实现，而且它能在冯·诺伊曼计算机上运行！很多计算机科学家都认识到了Lisp强大的能力。1973年在MIT人工智能实验室的一些程序员研发出一种机器，并把它叫做Lisp机。于是阿隆佐的lambda演算也有自己的硬件实现了！传统的程序设计语言是适应冯·诺依曼型计算机系统结构而发展起来的，LISP在诺依曼型计算机上运行的效率要低一些。计算机系统结构的发展，使得函数型语言有着广阔的前途。为了适应当前微型机发展水平和程序员使用传统语言编程的习惯，LISP语言增加了许多非函数型的语言成分，例如，prog、go等函数，所以，LISP已不是纯函数型语言，它既具有函数语言的功能，又具有传统语言的功能。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>在函数式语言中，函数(lambda 演算)作为一等公民，可以在任何地方定义，在函数内或函数外，可以作为函数的参数和返回值，可以对函数进行组合。函数式编程中的函数这个术语不是指计算机中的函数，而是指数学中的函数，即自变量的映射。也就是说一个函数的值仅决定于函数参数的值，不依赖其他状态。比如sqrt(x)函数计算x的平方根，只要x不变，不论什么时候调用，调用几次，值都是不变的。与函数式编程对应的是命令式编程（OOP），命令式编程是面向计算机硬件的抽象，有变量（对应存储单元），赋值语句（获取，存储指令），表达式（内存引用和算术运算）和控制语句（跳转指令）。下面是两种编程范式的对比</p><table><thead><tr><th>命令式范式（OOP）</th><th>函数式范式（FP）</th></tr></thead><tbody><tr><td>万物皆对象<br>（这话并不准确，例如Java中的方法就不能抽象为对象）</td><td>第一等公民是函数<br>（基本数据类型，如1，2，3也可以用函数表示）</td></tr><tr><td>抽象和封装</td><td>带有闭包的Lambdas/Anonymous函数</td></tr><tr><td>核心活动是组合和对象</td><td>核心活动是编写新的函数</td></tr><tr><td>着重于数据和状态</td><td>不变性，大部分无态处理，没有状态和变量</td></tr><tr><td><strong>基于图灵机</strong></td><td><strong>基于λ演算</strong></td></tr></tbody></table><p>面向对象和面向函数一直在争论，实际上纯粹的OOP和纯粹的FP都是极端的。</p><ul><li>对于OOP来讲：存在的并一定都是对象，函数就不是对象</li><li>对于FP来说：存在的并不总是纯粹的，副作用总是真实存在</li></ul><p>函数式中将超过计算的东西叫做副作用，因为文件读写，打印，随机数，这些东西都不是纯的计算过程，而是涉及到外部世界的交互，依赖于机器，不在理论的范畴。这些是不可避免的，因此副作用总是真实存在的。</p><h2 id="lambda-λ演算-定义"><a href="#lambda-λ演算-定义" class="headerlink" title="lambda | λ演算 定义"></a>lambda | λ演算 定义</h2><p>在lambda演算中只有三种合法表达式（也可以称之为项：λ-expression or λ-term）存在，λ演算是一个为了表达和计算函数的形式化系统，有着自己的化简规则和语法。整个系统是基于表达式的（也叫λ项）。一个表达式可以是一个<strong>变量</strong>（variable），一个<strong>抽象体</strong>（abstraction）或者一个<strong>应用</strong>（application）。即</p><pre class=" language-javascript"><code class="language-javascript">expression <span class="token operator">=</span> variable <span class="token operator">||</span> abstraction <span class="token operator">||</span> application </code></pre><h3 id="变量-Variable"><a href="#变量-Variable" class="headerlink" title="变量(Variable)"></a>变量(Variable)</h3><p>形式：<code>x</code> ，变量名可能是一个字符或字符串，它表示一个参数（形参）或者一个值（实参）。如果 X 是<strong>变量</strong>，E 是表达式，则λx.E是一个<strong>抽象体</strong>。</p><pre><code>variable = expression</code></pre><h3 id="抽象-Abstraction"><a href="#抽象-Abstraction" class="headerlink" title="抽象(Abstraction)"></a>抽象(Abstraction)</h3><p>形式：<code>λx.M</code>，在λ演算中，函数是用λ表示的匿名函数。一个匿名函数中只存在标识符和他自己的函数体。例如<code>λx.x</code>表达式定义了一个函数（也叫做λ抽象体）。紧跟在λ后面的名字是参数标识符，点后面的表达式是函数体。我们用javascript表示它：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> x <span class="token punctuation">}</span> </code></pre><p><code>λx.y</code>表示一个<strong>常量函数(constant function)</strong>，输出恒为y与输入无关。抽象体的通用模板</p><pre><code>abstraction = λ(variable).(expression) </code></pre><h3 id="应用-Application"><a href="#应用-Application" class="headerlink" title="应用(Application)"></a>应用(Application)</h3><p>形式：<code>M N</code>，它表示将函数M应用于参数N，其中M、N均为合法lambda表达式。简单来说就是给函数M输入实参N。例如<code>(λx.x) y</code>, <code>(λx.x) (λx.x)</code>。前者表示将函数<code>λx.x</code>应用于变量<code>y</code>，得到<code>y</code>；后者表示将函数<code>λx.x</code>应用于<code>λx.x</code>，得到<code>λx.x</code>。函数<code>λx.x</code>是一个<strong>恒等函数(identity function)</strong>，即输入恒等于输出</p><pre><code>application = (expression)(expression) </code></pre><p><strong>注意，</strong>这时候可能就有人纳闷儿了，<code>(λx.x) y</code>意义很明确，但<code>λy.xy</code>为什么代表函数抽象而不是将函数<code>λy.x</code>应用于<code>y</code>的函数应用呢？为了消除类似的表达式歧义，可以多使用小括号，也有以下几个<strong>消歧约定</strong>可以参考：</p><ul><li><em>一个函数抽象的函数体将尽最大可能向右扩展</em>，即：<code>λx.M N</code>代表的是一个函数抽象<code>λx.(M N)</code>而非函数应用<code>(λx.M) N</code>。</li><li><em>函数应用是左结合的</em>，即：<code>M N P</code>意为<code>(M N) P</code>而非<code>M (N P)</code></li></ul><h2 id="柯里化-Currying"><a href="#柯里化-Currying" class="headerlink" title="柯里化(Currying)"></a>柯里化(Currying)</h2><p>有时候我们的函数需要有多个参数，这太正常不过了，但是lambda函数只能有一个参数怎么办？解决这个问题的方法就是柯里化(Currying)。柯里化是用于处理多参数输入情况的方法，我们已经知道<strong>一个lambda函数的输入和输出也可以是函数</strong>，那么基于它，可以把多参数函数和单参数函数做以下转换：</p><pre><code>currying: λx y.xy = λx.(λy.xy)</code></pre><p>外层函数接受一个参数x返回一个函数<code>λy.xy</code>，这个返回函数（内层函数）又接受一个参数y返回xy，x绑定于外层函数，y绑定于内层函数，这样我们就在满足lambda函数只接受一个参数的约束下实现了多参数函数的功能，这就是柯里化，而<code>λx y.xy</code>称为<code>λx.(λy.xy)</code>的缩写，为了方便表达，后续会常常出现<code>λx y.xy</code>这样的书写方式，需要谨记它只是缩写写法。</p><h2 id="lambda-λ-归约"><a href="#lambda-λ-归约" class="headerlink" title="lambda | λ 归约"></a>lambda | λ 归约</h2><h3 id="beta-β-归约"><a href="#beta-β-归约" class="headerlink" title="beta | β 归约"></a>beta | β 归约</h3><p>对于一个函数应用<code>(λx.x) y</code>，它意为将函数应用<code>λx.x</code>应用于<code>y</code>，等价于<code>x[x:=y]</code>，即结果是<code>y</code>。在这个过程中，<code>(λx.x) y ≡ x[x:=y]</code>一步就叫做<strong>beta归约</strong>，<code>x[x:=y] ≡ y</code>一步称作<strong>替换(substitution)</strong>，<code>[x:=y]</code>意为将表达式中的自由变量<code>x</code>替换为<code>y</code>。</p><ul><li><p><strong>替换</strong>：形式：<strong>E[V := R]</strong>，意为将表达式<code>E</code>中的所有 “自由变量” <code>V</code>替换为表达式<code>R</code>。对于变量<code>x,y</code>和lambda表达式<code>M,N</code>，有以下规则：</p><pre><code>x[x := N]       ≡ Ny[x := N]       ≡ y //注意 x ≠ y(M1 M2)[x := N] ≡ (M1[x := N]) (M2[x := N])(λx.M)[x := N]  ≡ λx.M //注意 x 是绑定变量无法替换(λy.M)[x := N]  ≡ λy.(M[x := N]) //注意 x ≠ y, 且表达式N的自由变量中不包含 y 即 y ∉ FV(N)</code></pre></li><li><p><strong>beta归约</strong>：形式：<strong>β: ((λV.E) E′) ≡ E[V := E′]</strong>，其实就是用实参替换函数体中的形参，也就是函数抽象应用(apply)于参数的过程啦，只不过这个参数除了是一个变量还可能是一个表达式。</p></li></ul><p>细心的话可以注意到，替换规则中特别标注了一些<code>x ≠ y</code>或者<code>y ∉ FV(N)</code>等约束条件，它们的意义在于防止lambda表达式的归约过程中出现歧义。比如以下过程：</p><pre><code>// 错误演算(λx.(λy.xy)) y= (λy.xy)[x:=y] //beta归约：注意 y ∈ FV(y) 不满足替换的约束条件= λy.yy //替换：绑定变量y与自由变量y同名出现了冲突</code></pre><p>可以看出在不满足约束条件的情况强行替换造成了错误的结果，那么对于这种情况该如何处理呢？那就需要<strong>alpha转换</strong>啦。</p><h3 id="alpha-α-转换"><a href="#alpha-α-转换" class="headerlink" title="alpha | α 转换"></a>alpha | α 转换</h3><p>这条规则就是说，一个lambda函数抽象在更名绑定变量前后是等价的，即： <strong>α: λx.x ≡ λy.y</strong>，其作用就是解决绑定变量与自由变量间的同名冲突问题。那么对于上面的那个错误归约过程就可以纠正一下了</p><pre><code>(λx.(λy.xy))y= (λy.xy)[x:=y] //beta归约：注意 y ∈ FV(y) 不满足替换的约束条件= (λz.xz)[x:=y] //alpha转换：因为绑定变量y将与自由变量x（将被替换为y）冲突，所以更名为z= λz.yz</code></pre><h3 id="eta-η-归约"><a href="#eta-η-归约" class="headerlink" title="eta | η 归约"></a>eta | η 归约</h3><p>灵活运用alpha和beta已经可以解决所有的lambda表达式归约问题，但是考虑这样一个表达式：<code>λx.M x</code>，将它应用于任意一个参数上，比如<code>(λx.M x) N</code>，进行beta归约和替换后会发现它等价于<code>M N</code>，这岂不是意味着 <code>λx.M x ≡ M</code>。没错，对于形如<code>λx.M x</code>，其中表达式<code>M</code>不包含绑定变量<code>x</code>的函数抽象，它是冗余的，等价于<code>M</code>，而这就是<strong>eta归约</strong>，它一般用于<em>清除lambda表达式中存在的冗余函数抽象</em>。</p><h2 id="邱奇数"><a href="#邱奇数" class="headerlink" title="邱奇数"></a>邱奇数</h2><p><strong>Church 编码</strong>是把数据和运算符嵌入到 lambda 演算]内的一种方式，最常见的形式是 Church 数，它是使用 lambda 符号的自然数的表示法。这种方法得名于 Alonzo Church，他首先以这种方法把数据编码到 lambda 演算中。在其他符号系统中通常被认定为基本的项(比如整数、布尔值、有序对、列表和 tagged unions)都被映射到使用 Church 编码的高阶函数；根据邱奇-图灵论题我们知道任何可计算的运算符(和它的运算数)都可以用 Church 编码表示。Church 数 <strong>0</strong>, <strong>1</strong>, <strong>2</strong>, … 在 lambda 演算中被定义如下:</p><pre><code>0 ≡ λf.λx. x1 ≡ λf.λx. f x2 ≡ λf.λx. f (f x)3 ≡ λf.λx. f (f (f x))...</code></pre><p>我们可以使用js来验证这个计算模型</p><pre class=" language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 定义数字0:</span><span class="token comment" spellcheck="true">// 定义数字0:</span><span class="token keyword">let</span> zero <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> x<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 定义数字1:</span><span class="token keyword">let</span> one <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 计算数字2 = 1 + 1:</span><span class="token keyword">let</span> two <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>one<span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 定义加法:</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">m</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">n</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 计算数字3 = 1 + 2:</span><span class="token keyword">let</span> three <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>one<span class="token punctuation">,</span> two<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 给3传一个函数,会打印3次:</span><span class="token function">three</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'print 3 times'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 计算数字5 = 2 + 3:</span><span class="token keyword">let</span> five <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>two<span class="token punctuation">,</span> three<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 给5传一个函数,会打印5次:</span><span class="token function">five</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'print 5 times'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>运行结果如下</p><p><img src="/2020/04/12/lyan-suan-yu-han-shu-shi-bian-cheng/1.png" alt></p><p>实现原理实际上这里打印的次数，就是函数被调用的次数，邱奇用函数的递归调用次数来表示基本数据。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在函数式编程的世界中，一切皆函数，函数是一等公民。<strong>一等公民</strong>这个名字听起来很高大上，但是也相当晦涩，这个词也不是翻译的不好，因为英文原文中叫<strong>first class citizen</strong>很多人包括我也不知所云。<strong>其实所谓一等公民，它的意思是函数与基本数据类型一样，可作为函数的入参，也可作为函数的返回值，函数可以赋值给变量</strong>。我们知道在平常的命令式编程语言中（例如Java）中，函数的返回值比较简单，只能是基本数据类型（整型，布尔，字符串等）或者是一个Object。而在JavaScript函数是第一公民，因此我们也可以在函数中返回函数。正因为有了这种属性，函数的入参可以是函数，函数的返回值可以是函数，于是便有了高阶函数，以及各种骚操作和一些看起来很炫酷的语法糖。可以说<strong>函数为第一公民是函数式编程的必要条件</strong>。</p>]]></content>
      
      
      <categories>
          
          <category> javasript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javasript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从零搭建Gin的web项目</title>
      <link href="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/"/>
      <url>/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/</url>
      
        <content type="html"><![CDATA[<p><strong>Go</strong>语言（又称 <strong>Golang</strong>）是谷歌公司开发的强类型，编译型语言。Go 语言语法与 C相近，但功能上有：内存安全，GC（垃圾回收），结构形态及 CSP-style 并发计算。其实Go语言在2009就推出了，似乎不温不火。但是最近一两年在中国范围内，确实被关注的一塌糊涂。Go语言适合做服务端开发，web开发。本文将使用Go语言的Gin框架搭建一个web微服务工程。</p><h2 id="Go环境搭建"><a href="#Go环境搭建" class="headerlink" title="Go环境搭建"></a>Go环境搭建</h2><p>官方下载地址：<a href="https://golang.org/dl/" target="_blank" rel="noopener">https://golang.org/dl/</a>  。国外的地址貌似很难打开，可通过网盘下载 go1.14.1 版本，地址: <a href="https://pan.baidu.com/s/1rVLxkycsTADIsxglJx51NA" target="_blank" rel="noopener">https://pan.baidu.com/s/1rVLxkycsTADIsxglJx51NA</a> 提取码: 97b9 。下载完毕后就傻瓜式安装吧</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/1.png" alt></p><p>这一步可选择Go的安装路径，其余都Next直到安装完毕。打开windows终端，输入 go version 出现版本号则说明已经安装成功</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/2.png" alt></p><h2 id="安装Gin"><a href="#安装Gin" class="headerlink" title="安装Gin"></a>安装Gin</h2><p>这里使用go module管理go的依赖包，go module也是官方推荐的go第三方包管理工具。咱们在 GOPATH 之外的地方，新建一个空文件夹 <code>my_go_web</code> ，然后执行以下命令</p><pre class=" language-shell"><code class="language-shell">go mod init my_go_web</code></pre><p>执行成功后会输出：go: creating new go.mod: module go-gin-api。这时目录中会多出一个go.mod文件，内容如下</p><pre><code>module my_go_webgo 1.14require github.com/gin-gonic/gin v1.6.2</code></pre><p>注意module后面紧跟的my_go_web是当前项目的模块名，使用go module管理工程，在项目中导包时都需要使用模块名导包。</p><h2 id="项目目录结构"><a href="#项目目录结构" class="headerlink" title="项目目录结构"></a>项目目录结构</h2><p>Web 服务体系结构是构建每个项目之前的第一个阶段，就像您准备构建房屋并从创建体系结构计划开始一样。保持简单但直观的体系结构非常重要，因为众所周知，在 golang 中，您可以通过引用包名称来调用方法。开始先来约定一下项目的目录结构</p><pre><code>.├── src│   ├── config│   │   ├── mysql│   │   └── redis│   ├── cmd│   │   └── main.go│   ├── controller│   │   ├── car_controller.go│   │   ├── user_controller.go│   │   ├── login.go│   │   ├── system.go├── dao│   └── user_dao.go├── model│   ├── user_model.json│   ├── car_model.json├── route│   └── web_route.go├── service│   ├── user.json│   └── car.json├── util│   ├── date_util.go├── go.mod├── go.sum├── main.go</code></pre><h2 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h2><h4 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h4><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"my_go_web/src/route"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/*    r := gin.Default()    r.GET("/ping", func(c *gin.Context) {        c.JSON(200, gin.H{            "message": "pong",        })    })*/</span>    router <span class="token operator">:=</span> route<span class="token punctuation">.</span><span class="token function">RegisterWebRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8082"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// listen and serve on 0.0.0.0:8080</span><span class="token punctuation">}</span></code></pre><p>main函数中可以直接注册接口，但当接口数量越来越多时，就会显得代码混乱。为了代码整洁，把接口注册的地方抽离到一个go文件中。main函数中只保留服务启动的配置信息</p><h4 id="web-route-go"><a href="#web-route-go" class="headerlink" title="web_route.go"></a>web_route.go</h4><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> route<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"github.com/gin-gonic/gin"</span>    <span class="token string">"my_go_web/src/controller"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">RegisterWebRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 加载html文件，即template包下所有文件</span>    <span class="token comment" spellcheck="true">//router.LoadHTMLGlob("template/*")</span>    <span class="token comment" spellcheck="true">//router.GET("/hello", hello)</span>    userRouter <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>    userRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/query"</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>QueryUser<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 更新产品</span>    userRouter<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/delete/:id"</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>DeleteUser<span class="token punctuation">)</span>    fileRouter <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/car"</span><span class="token punctuation">)</span>    fileRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>CarList<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 更新产品</span>    fileRouter<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/info"</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>CarInfo<span class="token punctuation">)</span>    <span class="token keyword">return</span> router<span class="token punctuation">}</span></code></pre><p>在 java的spring中可以通过把controller注解放在类上实现根路由，在gin中可以通过 router.Group 创建一个根路由。在根路由下添加多个子路由。然后分别创建 <code>car_controller.go</code> 和 <code>user_controller.go</code> 。这样就实现和 java 一样的效果，把不同模块的功能聚合在它自己的controller中，下面是两个controller的代码实现</p><h4 id="car-controller-go"><a href="#car-controller-go" class="headerlink" title="car_controller.go"></a>car_controller.go</h4><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> controller<span class="token keyword">import</span> <span class="token string">"github.com/gin-gonic/gin"</span><span class="token keyword">func</span> <span class="token function">CarList</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>        <span class="token string">"car"</span><span class="token punctuation">:</span> <span class="token string">"奔驰"</span><span class="token punctuation">,</span>        <span class="token string">"age"</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">CarInfo</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>            <span class="token string">"car"</span><span class="token punctuation">:</span> <span class="token string">"奔驰"</span><span class="token punctuation">,</span>            <span class="token string">"length"</span><span class="token punctuation">:</span><span class="token string">"2m"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="user-controller-go"><a href="#user-controller-go" class="headerlink" title="user_controller.go"></a>user_controller.go</h4><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> controller<span class="token keyword">import</span> <span class="token string">"github.com/gin-gonic/gin"</span><span class="token keyword">func</span> <span class="token function">QueryUser</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>        <span class="token string">"age"</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">DeleteUser</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>    id <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>    context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>        <span class="token string">"result"</span><span class="token punctuation">:</span>id<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>这样就用go实现了一个简单web服务，下面启动服务</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/7.png" alt></p><p>可以看到服务已经正常启动在8082端口，同时从控制台可以看到服务注册的全部路由和每个路由的请求类型，在浏览器中请求一些 <code>/user/query</code> 接口</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/8.png" alt></p><p>请求返回了数据！我们已经成功的搭建了一个go语言的web服务</p><h2 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h2><p>引入gin的包时会出现，引用路径变红的问题。这时项目可以正常启动，但是看着代码报红，有强迫症的我很不舒服，按照网上的一些方法，例如执 <code>go mod vendor</code> 命令。这个命令是将项目依赖的包，放到项目的 vendor 目录中，执行完成后，项目的根路径下会出现一个 vendor 目录</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/11.png" alt></p><p>执行这个命令后，发现项目导包仍然报错，而项目依赖下只有sdk，没有go mod依赖的模块。</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/12.png" alt></p><h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>新建一个项目，<strong>创建项目的时候不要选择go modules ! ! !</strong>。仅创建一个普通的go项目</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/13.png" alt></p><p>项目创建好后，把原来那个项目里面的东西copy过来，删除vendor目录，这个目录用不上了。然后再打开setting，<strong>把go mod勾选上</strong>。</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/15.png" alt></p><p>然后，在项目的依赖中就会出现go mod依赖的库了，这时在看go文件中的导包路径已经不报红，而且高亮了。</p><p><img src="/2020/04/06/cong-ling-da-jian-gin-de-web-xiang-mu/16.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-boot注解大全</title>
      <link href="/2020/04/04/spring-boot-zhu-jie-da-quan/"/>
      <url>/2020/04/04/spring-boot-zhu-jie-da-quan/</url>
      
        <content type="html"><![CDATA[<p>spring boot是后端开发最主流的框架，spring boot的核心之一就是注解，它提供了很多注解来帮助我们简化配置，通过各种组合注解，极大地简化了spring项目的搭建和开发。为了方便我们在日常开发注解的使用，本文将开发所需要的注解统一并进行归类起来,并结合用例进行解析，这样收藏起来以便日后使用。</p><h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><h3 id="组件注解"><a href="#组件注解" class="headerlink" title="组件注解"></a>组件注解</h3><p><strong>@component</strong>，而其余 <strong>@Controller</strong>、<strong>@Service</strong>、<strong>@Repository</strong>都组合了@component注解，主要为便于使用者Class组件进行归类。默认加载IOC容器中的组件，容器启动会调用无参构造器创建对象，再进行初始化赋值等操作</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@Component</td><td>组件注解，使用了该注解会基于注释的配置和类路径扫描时。<br>会自动扫描并加载Class到ICO容器中</td><td>类上</td></tr><tr><td>@Controller</td><td>使用@Controller 注解类，在对应的方法上，视图解析器可以解析return 的 jsp,html页面<br>并且跳转到相应页面。此注解属于MVC中的C层（视图控制层）</td><td>类上</td></tr><tr><td>@RestController</td><td>相当于@ResponseBody ＋ @Controller合在一起的作用。使用@RestController注解，<br>无法返回jsp页面，或者html。只返回JSON格式的数据</td><td>类上</td></tr><tr><td>@Service</td><td>应用在service层（业务逻辑层）</td><td>类上</td></tr><tr><td>@Repository</td><td>应用在dao层（数据访问层）</td><td>类上</td></tr><tr><td>@Mapper</td><td>如果使用@Repository则需要使用@MapperScan(“xxx.xxx.mapper”)进行扫描<br>然后生成Dao层的Bean才能被注入到Service层中。<br>@Mapper=@Repository+@MapperScane</td><td>类上</td></tr></tbody></table><h3 id="依赖注入注解"><a href="#依赖注入注解" class="headerlink" title="依赖注入注解"></a>依赖注入注解</h3><p>Autowired注解和@Inject、@Resource，可以与@Qualifier或者@Name配合使用，防止多实例注入时出错，以及值注入@Value。</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@Autowired</td><td>通过AutowiredAnnotationBeanPostProcessor类实现的依赖注入，默认是根据类型进行注入的<br>因此如果有多个类型一样的Bean候选者，则需要限定其中一个候选者，否则将抛出异常。</td><td>字段上<br>方法上</td></tr><tr><td>@Inject</td><td>作用与@Autowired一样</td><td>字段上<br>方法上</td></tr><tr><td>@Resource</td><td>默认按照名称进行装配，名称可以通过name属性进行指定</td><td>字段上<br>方法上</td></tr><tr><td>@Qualifier</td><td>限定描述符除了能根据名字进行注入，更能进行更细粒度的控制如何选择候选者<br>可与@Autowired或者@Inject进行组合使用，进行精确注入</td><td>字段上<br>方法上</td></tr></tbody></table><h3 id="作用域和生命过程"><a href="#作用域和生命过程" class="headerlink" title="作用域和生命过程"></a>作用域和生命过程</h3><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@Scope</td><td>具有4个作用域，默认是单例模式，也就是singleton<br><strong>Singleton(单例式)</strong>：在整个应用中，只创建bean的一个实例。<br><strong>Prototype(原型式)</strong>：每次注入或者通过Spring应用上下文获取时，会创建一个新的bean实例。等同于new方式创建对象<br><strong>Session(会话式)</strong>：在Web应用中，为每个会话创建一个bean实例。（电子商务应用中，一个bean代表一个用户的购物车，只要同一个session一个bean）。<br><strong>Request(请求式)</strong>：在Web应用中，为每个请求创建一个bean实例。</td><td>类上</td></tr><tr><td>@PostConstruct</td><td>相当于init-method，在类的实例被初始化时执行，作用于方法上。</td><td>方法上</td></tr><tr><td>@PreDestroy</td><td>相当于destory-method，使用在方法上，当Bean销毁时执行</td><td>方法上</td></tr></tbody></table><p>下面代码例子：</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span> <span class="token comment" spellcheck="true">//组件注入，注明为service组件</span><span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">"prototype"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//声明Scope为Prototype</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseFunctionService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span> <span class="token comment" spellcheck="true">//默认按type注入</span>    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"functionService"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//精确注入</span>    FunctionService functionService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"baseDao"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//默认按name注入，可以通过name和type属性进行选择性注入</span>    <span class="token keyword">private</span> BaseDao baseDao<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Inject</span>    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"userServiceImpl"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//精确注入  </span>    <span class="token keyword">public</span> IUserService userService<span class="token punctuation">;</span>      <span class="token annotation punctuation">@PostConstruct</span><span class="token comment" spellcheck="true">//在UseFunctionService类实例执行完构造函数后执行</span>    <span class="token keyword">public</span> <span class="token function">postConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"postConstruct"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@PreDestroy</span><span class="token comment" spellcheck="true">//在UseFunctionService类实例Bean被销毁前执行</span>    <span class="token keyword">public</span> <span class="token function">perDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"perDestroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Autowired</span>       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDao</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"userDao"</span><span class="token punctuation">)</span> UserDao userDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao <span class="token operator">=</span> userDao<span class="token punctuation">;</span>       <span class="token punctuation">}</span>      <span class="token keyword">public</span> String <span class="token function">SayHello</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> functionService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="配置注解"><a href="#配置注解" class="headerlink" title="配置注解"></a>配置注解</h2><h3 id="Configuration配置注解"><a href="#Configuration配置注解" class="headerlink" title="Configuration配置注解"></a>Configuration配置注解</h3><p>@Configuration可替换xml配置文件进行配置。被注解的类内部包含有一个或多个被@Bean注解的方法,这些方法将会被AnnotationConfigApplicationContext或AnnotationConfigWebApplicationContext类进行扫描，并用于构建bean定义，初始化Spring容器。可与@PropertySource一起使用。</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@Configuration</td><td>配置类注解，可以与@Beae、@PropertySource一起使用，进行配置</td><td>在类、接口、枚举上</td></tr><tr><td>@SpringBootConfiguration</td><td>组合注解，@Configuration配置、@EnableAutoConfiguration启用自动配置<br>@ComponentScan默认扫描@SpringBootApplication所在类的同级目录以及它的子目录</td><td>类上</td></tr><tr><td>@AutoConfigureAfter</td><td>在指定的自动配置类之后再配置</td><td>类上</td></tr></tbody></table><h3 id="扫描注解"><a href="#扫描注解" class="headerlink" title="扫描注解"></a>扫描注解</h3><p>@ComponentScan注解,被@Configuration注解标注的类上面,涉及了@filter过滤器注解</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@ComponentScan</td><td>定义扫描的路径，默认就会加载标识了@Controller，@Service，@Repository，@Component注解的类到spring容器中<br>excludeFilters 指定扫描的时候需要排除的组件，includeFilters 指定扫描的时候只包含的组件</td><td>类上</td></tr><tr><td>@ComponentScans</td><td>包含着@ComponentScan数组</td><td>类上</td></tr><tr><td>@filter</td><td>声明要用作包含过滤器或排除过滤器的类型过滤器</td><td>可注解在@ComponentScan中</td></tr></tbody></table><h3 id="资源、值等注入注解"><a href="#资源、值等注入注解" class="headerlink" title="资源、值等注入注解"></a>资源、值等注入注解</h3><p>可以将配置文件、配置文件中的属性、以及系统属性等注入所需的字段中，或者bean中</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@Value</td><td>值注入，可以注入普通字符，系统属性，表达式运算结果，其他Bean的属性<br>文件内容，网址请求内容，配置文件属性值等等</td><td>字段上<br>方法上<br>参数上</td></tr><tr><td>@Bean</td><td>声明当前方法的返回值为一个Bean，而且返回的Bean对应的类中可以定义init()方法和destroy()方法<br>然后在@Bean(initMethod=”init”,destroyMethod=”destroy”)定义，在构造之后执行init，在销毁之前执行destroy</td><td>方法上<br>注解上</td></tr><tr><td>@PropertySource</td><td>指定配置文件位置，与@configuration类一起使用</td><td>类上<br>接口上</td></tr><tr><td>@ImportResource</td><td>加载xml配置文件</td><td>类上<br>接口上</td></tr><tr><td>@ConfigurationProperties</td><td>将properties属性与一个Bean及其属性相关联</td><td>类上<br>接口上</td></tr><tr><td>@Import</td><td>用来导入配置类的</td><td>类上<br>接口上</td></tr></tbody></table><h3 id="条件注解"><a href="#条件注解" class="headerlink" title="条件注解"></a>条件注解</h3><p>Conditional根据满足某一特定条件创建特定的Bean，基于@Conditional元注解可延伸很多条件注解。在spring boot的源码中很多配置类的实例化都使用到了条件注解，例如数据源类DataSource的实例化</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@ConditionalOnBean</td><td>Spring容器中是否存在对应的实例，可以通过实例的类型、类名、注解、昵称去容器中查找<br>可以配置从当前容器中查找或者父容器中查找或者两者一起查找。这些属性都是数组，通过”与”的关系进行查找</td><td>方法上</td></tr><tr><td>@ConditionalOnClass</td><td>类加载器中是否存在对应的类，逻辑跟@ConditionalOnBean类似</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnExpression</td><td>判断SpEL 表达式是否成立</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnJava</td><td>指定Java版本是否符合要求</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnMissingBean</td><td>Spring容器中是否缺少对应的实例，逻辑跟@ConditionalOnBean类似</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnMissingClass</td><td>Spring容器中是否缺少对应的实例，逻辑跟@ConditionalOnBean类似</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnNotWebApplication</td><td>应用程序是否是非Web程序，没有提供属性，只是一个标识</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@ConditionalOnProperty</td><td>是否存在指定的资源文件。只有一个属性resources，是个String数组。<br>会从类加载器中去查询对应的资源文件是否存在</td><td>类上<br>接口上<br>方法上</td></tr><tr><td>@Profile</td><td>指定某个bean属于哪一个profile：spring.profiles.active和spring.profiles.default（默认）</td><td>类上<br>接口上<br>方法上</td></tr></tbody></table><p>代码使用注解例子</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token comment" spellcheck="true">//@SpringBootConfiguration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"com.cn"</span><span class="token punctuation">,</span>ComponentDefaultFilters<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span>  includeFilters<span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type<span class="token operator">=</span>FilterType<span class="token punctuation">.</span>ANNOTATION<span class="token punctuation">,</span>classes<span class="token operator">=</span><span class="token punctuation">{</span>Controller<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type<span class="token operator">=</span>FilterType<span class="token punctuation">.</span>CUSTOM<span class="token punctuation">,</span>classes<span class="token operator">=</span><span class="token punctuation">{</span>MyTypeFilter<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ImportResource</span><span class="token punctuation">(</span><span class="token string">"classpath:condition.xml"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//导入xml配置</span><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>ConditionConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//导入ConditionConfig Class，并会实例化到容器中以及ConditionConfig中的配置也一起注入</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>     <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"I Love You!"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入普通字符</span>    <span class="token keyword">private</span> String normal<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"#{systemProperties['os.name']}"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入操作系统属性</span>    <span class="token keyword">private</span> String osName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"#{ T(java.lang.Math).random() * 100.0 }"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入表达式运算结果</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> randomNumber<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"#{demoService.another}"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入其他Bean的属性</span>    <span class="token keyword">private</span> String fromAnother<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"classpath:org/light4j/sping4/usually/el/test.txt"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入文件内容</span>    <span class="token keyword">private</span> Resource testFile<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入网址内容</span>    <span class="token keyword">private</span> Resource testUrl<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${book.name}"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//注入属性文件</span>    <span class="token keyword">private</span> String bookName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span><span class="token comment" spellcheck="true">//加载bean</span>    <span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span>WindowsCondition<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通过@Conditional注解，符合Windows条件则true</span>    <span class="token annotation punctuation">@ConditionalOnResource</span><span class="token punctuation">(</span>resources<span class="token operator">=</span><span class="token string">"classpath:windows.ini"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//在类路径下是否存在windows.ini文件，存在为true,最后进行注解与操作，为true实例化Bean</span>    <span class="token keyword">public</span> ListService <span class="token function">windowsListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WindowsListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span>LinuxCondition<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通过@ConditionalOnClass注解，符合Linux条件则true</span>    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"synchronize"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果synchronize在配置文件中并且值为true</span>    <span class="token keyword">public</span> ListService <span class="token function">linuxListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LinuxListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//加载配置文件中前缀为spring.datasource的属性</span>     <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource"</span><span class="token punctuation">)</span>      <span class="token keyword">public</span> DataSource <span class="token function">jwcDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token annotation punctuation">@ConditionalOnMissingClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>LinuxCondition<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>WindowsCondition<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//当容器中缺失这两个Class时为true</span>    <span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token string">"dev"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//在dev环境下为true  最后结果为注解和之与，true实例化该Bean</span>    <span class="token keyword">public</span> ListService <span class="token function">macListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MacListService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="Spring-boot注解"><a href="#Spring-boot注解" class="headerlink" title="Spring boot注解"></a>Spring boot注解</h2><h3 id="web注解"><a href="#web注解" class="headerlink" title="web注解"></a>web注解</h3><p>做web开发时需要用到的注解，主要在controller层。用于请求参数，请求头数据，cookie数据获取，以及跨域支持。支持restful风格的web应用开发</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@EnableWebMvc</td><td>会开启一些默认配置，如一些ViewResolver或者MessageConverter等</td><td>类上</td></tr><tr><td>@RequestMapping</td><td>用来映射Web请求(访问路径和参数)，处理类和方法的（即配置URL和方法之间的映射）<br>注解在方法上的@RequestMapping路径会继承注解在类上的路径</td><td>类上<br>方法上</td></tr><tr><td>@GetMapping</td><td>与@RequestMapping功能类似，但指定为get请求</td><td>方法上</td></tr><tr><td>@PostMapping</td><td>与@RequestMapping功能类似，但指定为post请求</td><td>方法上</td></tr><tr><td>@PutMapping</td><td>与@RequestMapping功能类似，但指定为put请求</td><td>方法上</td></tr><tr><td>@DeleteMapping</td><td>与@RequestMapping功能类似，但指定为delete请求</td><td>方法上</td></tr><tr><td>@ResponseBody</td><td>支持将返回值放在response体内</td><td>方法上</td></tr><tr><td>@RequestBody</td><td>http请求需携带请求体</td><td>参数上</td></tr><tr><td>@PathVariable</td><td>用来接收路径参数，如/ccww/003，可接收003作为参数</td><td>参数上</td></tr><tr><td>@RequestParam</td><td>请求url后面需携带的参数</td><td>参数上</td></tr><tr><td>@CrossOrigin</td><td>用于支持跨域请求，此注解有两个参数<br><strong>origins</strong>  ： 允许可访问的域列表<br><strong>maxAge</strong>：准备响应前的缓存持续的最大时间（以秒为单位）。</td><td>类上<br>方法上</td></tr><tr><td>@RequestHeader</td><td>用于映射请求头数据到Controller方法的对应参数</td><td>参数上</td></tr><tr><td>@CookieValue</td><td>可以把Request header中关于cookie的值绑定到方法的参数上。</td><td>参数上</td></tr></tbody></table><p>RequestHeader注解可获取请求头中的数据，下面介绍一下请求头（header）数据主要有哪些：</p><table><thead><tr><th>Header</th><th>解释</th><th>示例</th></tr></thead><tbody><tr><td>Accept</td><td>客户端能够接收的内容类型</td><td>Accept:text/html,image/* <br>[告诉服务器，浏览器可以接受文本，网页图片]</td></tr><tr><td>Accept-Charaset</td><td>浏览器可接受的字符编码集</td><td>Accept-Charaset:ISO-8859-1<br>[接受字符编码：iso-8859-1]</td></tr><tr><td>Accept-Encoding</td><td>浏览器支持的服务器返回的压缩编码类型</td><td>Accept-Encoding:gzip,compress<br>[可以接受  gzip,compress压缩后数据]</td></tr><tr><td>Accept-Language</td><td>浏览器可接受的语言</td><td>Accept-Language:zh-cn<br>[浏览器支持的语言]</td></tr><tr><td>Accept-Ranges</td><td>用于告知客户端服务器是否能处理范围请求,以指定获取服务器端某个部分的资源</td><td>Accept-Ranges:bytes</td></tr><tr><td>Authorization</td><td>Http授权的授权证书</td><td>Authorization:Basic YWRtaW46YWRtaW4=</td></tr><tr><td>Cache-Control</td><td>指定请求和响应遵循的缓存机制</td><td>Cache-Control:no-cache</td></tr><tr><td>Connection</td><td>表示连接是否持久(HTTP1.1默认进行持久连接)</td><td>Connection:close</td></tr><tr><td>Cookie</td><td>HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器</td><td>Cookie:version=1;skin=new</td></tr><tr><td>Content-Length</td><td>请求内容长度</td><td>Content-Length:348</td></tr><tr><td>Content-Type</td><td>请求与实体对于的MIME信息</td><td>Content-Type:application/x-www-form-urlencoded</td></tr><tr><td>Date</td><td>请求发送的时间和日期</td><td>Date:Mon, 17 Mar 2015 05:34:54 GMT</td></tr><tr><td>Host</td><td>浏览器要找的主机</td><td>Host:localhost:8080</td></tr><tr><td>Referer</td><td>告诉服务器我来自哪里,常用于防止下载，盗链</td><td>Referer:<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></td></tr><tr><td>User-Agent</td><td>告诉服务器我的浏览器内核</td><td>User-Agent:Nozilla/4.0(Com…)</td></tr></tbody></table><p>注解使用示例：</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Controller</span> <span class="token comment" spellcheck="true">//声明此类是一个控制器</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/ccww"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//映射此类的访问路径是/ccww</span><span class="token comment" spellcheck="true">//origin="*"代表所有域名都可访问  使用@CrossOrigin注解版本要求jdk1.8+ ，Spring4.2+</span><span class="token comment" spellcheck="true">//maxAge飞行前响应的缓存持续时间的最大年龄，简单来说就是Cookie的有效期 单位为秒</span><span class="token comment" spellcheck="true">//若maxAge是负数,则代表为临时Cookie,不会被持久化,Cookie信息保存在浏览器内存中,浏览器关闭Cookie就消失</span><span class="token annotation punctuation">@CrossOrigin</span><span class="token punctuation">(</span>origins <span class="token operator">=</span> <span class="token string">"http://test.com"</span><span class="token punctuation">,</span>maxAge <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//@RestController // 使用@RestController，声明是控制器，并且返回数据时不需要@ResponseBody</span><span class="token comment" spellcheck="true">//@RequestMapping("/ccww")</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoAnnoController</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//此方法未标注路径，因此使用类级别的路径/anno;produces可定制返回的response的媒体类型和字符集，或返回值是json对象，则设置porduces="application/json;charset=UTF-8"</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>produces <span class="token operator">=</span> <span class="token string">"text/plain;charset=UTF-8"</span><span class="token punctuation">)</span>      <span class="token keyword">public</span> <span class="token annotation punctuation">@ResponseBody</span> String <span class="token function">index</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//可接受HttpServletRequest作为参数，当然也可以接受HttpServletResponse作为参数。此处的@ResponseBody用在返回值前</span>        <span class="token keyword">return</span> <span class="token string">"url:"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" can access"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demoPathVar/{str}"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"text/plain;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// </span>    <span class="token keyword">public</span> <span class="token annotation punctuation">@ResponseBody</span> String <span class="token function">demoPathVar</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> String str<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//接受路径参数，并在方法参数前结合@PathVariable使用，访问路径为/ccww/demoPathVar/xxx</span>            HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"url:"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" can access,str: "</span> <span class="token operator">+</span> str<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//常规的request参数获取，访问路径为/ccww/requestParam?id=1</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/requestParam"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"text/plain;charset=UTF-8"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token annotation punctuation">@ResponseBody</span> String <span class="token function">passRequestParam</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span>            HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"url:"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" can access,id: "</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/obj"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span> <span class="token comment" spellcheck="true">// 可注解在方法上</span>    <span class="token keyword">public</span> String <span class="token function">passObj</span><span class="token punctuation">(</span>DemoObj obj<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span> <span class="token string">"url:"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token operator">+</span> <span class="token string">" can access, obj id: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" obj name:"</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//映射不同的路径到相同的方法，访问路径为/anno/name1或/anno/name2</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"/name1"</span><span class="token punctuation">,</span> <span class="token string">"/name2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"text/plain;charset=UTF-8"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token annotation punctuation">@ResponseBody</span> String <span class="token function">remove</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"url:"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" can access"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/helloWorld"</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//以“user”为名称添加到模型对象中供视图页面展示使用</span>    <span class="token keyword">public</span> String <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ModelAttribute</span> User user<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"helloWorld"</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// 通过RequestHeader获取请求头中的数据</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/boweifeng"</span><span class="token punctuation">)</span>      <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> String <span class="token function">queryUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">)</span> String encoding<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span> <span class="token keyword">long</span> keepAlive<span class="token punctuation">,</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">"JSESSIONID"</span><span class="token punctuation">)</span> String cookie<span class="token punctuation">)</span>  <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token string">"encoding:"</span> <span class="token operator">+</span> encoding <span class="token operator">+</span> <span class="token string">"cookie:"</span><span class="token operator">+</span>cookie<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><h3 id="应用注解"><a href="#应用注解" class="headerlink" title="应用注解"></a>应用注解</h3><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@SpringBootApplication</td><td>Spring Boot核心注解，组合注解(@Configuration、@EnableAutoConfiguration、@ComponentScan)<br>主要是为了开启自动配置</td><td>启动类上</td></tr><tr><td>@EnableAutoConfiguration</td><td>让Spring Boot根据类路径中的jar包依赖为当前项目进行自动配置<br>开源组件如mybatis，redis都是通过此注解实现启动自动注入的</td><td>类上</td></tr></tbody></table><h2 id="JPA注解"><a href="#JPA注解" class="headerlink" title="JPA注解"></a>JPA注解</h2><p>下面是jpa和hibernate的常用注解</p><table><thead><tr><th>注解</th><th>解析</th><th>用法</th></tr></thead><tbody><tr><td>@entity</td><td>修饰一个实体类，接受一个name属性作为该实体类名称，可省略默认为该类名</td><td>类上</td></tr><tr><td>@Table</td><td>指定持久化类所映射的表名，可接受以下属性</td><td>类上</td></tr><tr><td>@Column</td><td>指定表列名和实体类的的映射关系</td><td>字段上</td></tr><tr><td>@Id</td><td>必须的，定义映射到数据库表的主键属性</td><td>字段上</td></tr><tr><td>@Transient</td><td>表示该属性并非一个到数据库表字段的映射，ORM框架将忽略该属性</td><td>字段上</td></tr><tr><td>@OneToOne</td><td>一对一双向外键关联：主控方的配置同一对一单向外键关联。</td><td>字段上</td></tr><tr><td>@ManyToOne</td><td>多对一单向外键关联：多对一，多方设置EAGER。fetch有两种：EAGER和LAZY</td><td>字段上</td></tr><tr><td>@ManyToOne</td><td>多对一双向外键关联 。多方：多方持有一方的引用</td><td>字段上</td></tr><tr><td>@ManyToMany</td><td>多对多双向外键关联：双方都持有对方的集合对象，其中一方设置</td><td>字段上</td></tr><tr><td>@JoinColum</td><td>用于表示两个实体的关联关系，和OneToOne，ManyToOne等注解配合使用</td><td>字段上</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>使用详解，通过例子来理解一对多，多对一几个注解的使用</p><h3 id="一对多（多对一）"><a href="#一对多（多对一）" class="headerlink" title="一对多（多对一）"></a>一对多（多对一）</h3><p>客户(Customer)和订单(Order)为例，客户(Customer)类为一的一方，订单(Order)类为多的一方。分别创建Customer和Order两个java类，通过jpa注解来表示他们的关系</p><p><strong>客户(Customer)类</strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 客户 ---- 一的一方</span><span class="token annotation punctuation">@Entity</span><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"t_customer"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Id</span>    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span>GenerationType<span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 主键</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 姓名</span>    <span class="token comment" spellcheck="true">// 描述客户可以有多个订单</span>    <span class="token comment" spellcheck="true">/*     * targetEntity="..."：相当于&lt;one-to-many class="...">     * mappedBy="..."：相当于inverse=true，即放弃关联关系的维护，不然会生成一个中间表     */</span>    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>targetEntity<span class="token operator">=</span>Order<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>mappedBy<span class="token operator">=</span><span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Order<span class="token operator">></span> orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Order<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Order<span class="token operator">></span> <span class="token function">getOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> orders<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrders</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Order<span class="token operator">></span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>orders <span class="token operator">=</span> orders<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Integer <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>订单(Order)类</strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 订单 ---- 多的一方</span><span class="token annotation punctuation">@Entity</span><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"t_order"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Id</span>    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span>GenerationType<span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>    <span class="token keyword">private</span> Double money<span class="token punctuation">;</span>    <span class="token keyword">private</span> String receiverInfo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 收货地址</span>    <span class="token comment" spellcheck="true">// 订单与客户关联</span>    <span class="token annotation punctuation">@ManyToOne</span><span class="token punctuation">(</span>targetEntity<span class="token operator">=</span>Customer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"c_customer_id"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定外键列</span>    <span class="token keyword">private</span> Customer c<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 描述订单属于某一个客户</span>    <span class="token keyword">public</span> Customer <span class="token function">getC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> c<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setC</span><span class="token punctuation">(</span>Customer c<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Integer <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Double <span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> money<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>Double money<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> money<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> receiverInfo<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReceiverInfo</span><span class="token punctuation">(</span>String receiverInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiverInfo <span class="token operator">=</span> receiverInfo<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>以学生与老师为例,使用<code>@ManyToMany</code>注解来配置多对多，只需要在一端配置中间表，另一端使用mappedBy表示放置外键的维护权。</p><p><strong>学生(Student )类</strong></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"t_student"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Id</span>    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span>GenerationType<span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>targetEntity<span class="token operator">=</span>Teacher<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// @JoinTable：使用@JoinTable来描述中间表，并描述中间表中外键与Student、Teacher的映射关系</span>    <span class="token comment" spellcheck="true">// joinColumns：它是用来描述Student与中间表的映射关系</span>    <span class="token comment" spellcheck="true">// inverseJoinColumns：它是用来描述Teacher与中间表的映射关系</span>    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"s_t"</span><span class="token punctuation">,</span> joinColumns<span class="token operator">=</span><span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"c_student_id"</span><span class="token punctuation">,</span>referencedColumnName<span class="token operator">=</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inverseJoinColumns<span class="token operator">=</span><span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"c_teacher_id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>     <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Teacher<span class="token operator">></span> teachers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Teacher<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> Integer <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Teacher<span class="token operator">></span> <span class="token function">getTeachers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> teachers<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTeachers</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Teacher<span class="token operator">></span> teachers<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>teachers <span class="token operator">=</span> teachers<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>老师(Teacher )类</strong></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"t_teacher"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Teacher</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Id</span>    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span>GenerationType<span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>targetEntity<span class="token operator">=</span>Student<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mappedBy<span class="token operator">=</span><span class="token string">"teachers"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 代表由对方来维护外键</span>    <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Student<span class="token operator">></span> students <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Student<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> Integer <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>Student<span class="token operator">></span> <span class="token function">getStudents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> students<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStudents</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Student<span class="token operator">></span> students<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>students <span class="token operator">=</span> students<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue和react实现组织架构树</title>
      <link href="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/"/>
      <url>/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/</url>
      
        <content type="html"><![CDATA[<p>公司项目需求，要在页面中实现一个公司组织架构图，并实现每个节点可以通过点击事件增加子节点，删除子节点。当时首先想到的是用echart的树图实现，但是echart的树图的节点不能自定义样式，而且点击事件也不是那么方便，于是就放弃了。然后在github上找找轮子，发现两个轻量的组织架构树组件，一个是vue版本，另一个是react版本的。在此记录一下使用步骤。</p><p><img src="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/1.jpg" alt></p><h2 id="组织树org-tree"><a href="#组织树org-tree" class="headerlink" title="组织树org-tree"></a>组织树org-tree</h2><h3 id="vue版本：vue-org-tree"><a href="#vue版本：vue-org-tree" class="headerlink" title="vue版本：vue-org-tree"></a>vue版本：vue-org-tree</h3><p>这是一个纯vue版本，我喜欢它的缩进方式和样式，同时它也是github上星星最多的。它只是相当于提供了模板，要实现自己的功能需要对插件进行改造。<a href="https://github.com/hukaibaihu/vue-org-tree" target="_blank" rel="noopener">github项目地址</a></p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><pre class=" language-shell"><code class="language-shell">npm install --save-dev vue2-org-tree// 只引入vue2-org-tree运行会报错少包npm install --save-dev less less-loader</code></pre><p>注意，demo中有两个bug，节点无法展开问题：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 底下这个函数一定要写两个参数，如果只写onExpand(data)，data.expand结果是undefined</span><span class="token comment" spellcheck="true">// 这个应该是插件的bug，一般只写一个参数也是可以</span><span class="token function">onExpand</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"expand"</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        data<span class="token punctuation">.</span>expand <span class="token operator">=</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expand<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>expand <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">"expand"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>点击node要跳转链接，点击展开收缩按钮也会跳转问题</p><pre class=" language-javascript"><code class="language-javascript">  增加判断语句即可，默认展开收缩按钮对象里的url肯定是空  <span class="token function">onNodeClick</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">//console.log(data.label);</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/2.png" alt></p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>刚开始把玩一番，颇为得意，很轻松的解决了烦人的需求。真是天道酬勤，哈哈哈哈，报应不爽啊，才懒一会儿，就被泼了凉水，因为我发现一个很让人绝望的问题。虽然这个组件支持你把数据传进来，然后渲染出效果。然后点两下开关，横排竖排显示。但是node节点不支持扩展，也就是说node节点只能显示字符串，不能自己自定义样式，这可不能满足变态的需求啊。可以看到节点方法，这个方法的返回值会渲染的节点中显示</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">renderContent</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> data<span class="token punctuation">.</span>label<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>我尝试着在返回值中加入html标签，发现会当做字符串显示，而不会解析成dom。本想着放弃了，于是想着试试返回JSX模板，vue默认是不支持JSX，需要导入插件才能支持，这就是会用到一个 <a href="https://github.com/vuejs/babel-plugin-transform-vue-jsx" target="_blank" rel="noopener">Babel plugin</a> 插件，然后导入以下组件</p><pre class=" language-shell"><code class="language-shell">npm install babel-plugin-syntax-jsx --save-devnpm install babel-plugin-transform-vue-jsx --save-devnpm install babel-helper-vue-jsx-merge-props --save-devnpm install babel-preset-env --save-dev</code></pre><p>修改项目根目录下的.babelrc文件，加入以下内容</p><pre><code>{ &quot;presets&quot;: [&quot;es2015&quot;], &quot;plugins&quot;: [&quot;transform-vue-jsx&quot;]}</code></pre><p>然后就可以这样写node的初始化方法了</p><pre class=" language-javascript"><code class="language-javascript">renderContent<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span>                    <span class="token operator">&lt;</span>div<span class="token operator">></span>                        <span class="token operator">&lt;</span>li<span class="token operator">></span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>label<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">)</span>            <span class="token punctuation">}</span></code></pre><h4 id="组件完整代码"><a href="#组件完整代码" class="headerlink" title="组件完整代码"></a>组件完整代码</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container"</span><span class="token operator">></span>      <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-10 col-md-offset-1"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"page-header"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>h3<span class="token operator">></span>基于Vue的组织架构树组件<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-8 col-md-offset-2"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>form <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-horizontal row"</span><span class="token operator">></span>              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-4"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"checkbox"</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>label<span class="token operator">></span>                    <span class="token operator">&lt;</span>input                      type<span class="token operator">=</span><span class="token string">"checkbox"</span>                      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"horizontal"</span>                    <span class="token operator">></span> Horizontal                  <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-4"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"checkbox"</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>label<span class="token operator">></span>                    <span class="token operator">&lt;</span>input                      type<span class="token operator">=</span><span class="token string">"checkbox"</span>                      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"collapsable"</span>                    <span class="token operator">></span> Collapsable                  <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-4"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"checkbox"</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>label<span class="token operator">></span>                    <span class="token operator">&lt;</span>input                      type<span class="token operator">=</span><span class="token string">"checkbox"</span>                      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"expandAll"</span>                      @change<span class="token operator">=</span><span class="token string">"expandChange"</span>                    <span class="token operator">></span> Expand All                  <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span>br<span class="token operator">></span>              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-6"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>label <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"control-label col-md-5"</span><span class="token operator">></span>labelClassName<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>                  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md-7"</span><span class="token operator">></span>                    <span class="token operator">&lt;</span>select                      <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span>                      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"labelClassName"</span>                    <span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-white"</span><span class="token operator">></span>bg<span class="token operator">-</span>white<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-orange"</span><span class="token operator">></span>bg<span class="token operator">-</span>orange<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-gold"</span><span class="token operator">></span>bg<span class="token operator">-</span>gold<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-gray"</span><span class="token operator">></span>bg<span class="token operator">-</span>gray<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-lightpink"</span><span class="token operator">></span>bg<span class="token operator">-</span>lightpink<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-chocolate"</span><span class="token operator">></span>bg<span class="token operator">-</span>chocolate<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                      <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">"bg-tomato"</span><span class="token operator">></span>bg<span class="token operator">-</span>tomato<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>                    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span>                  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>br<span class="token operator">></span>        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">"margin-left: 150px"</span><span class="token operator">></span><span class="token operator">&lt;</span>el<span class="token operator">-</span>button type<span class="token operator">=</span><span class="token string">"primary"</span> @click<span class="token punctuation">.</span>native<span class="token operator">=</span><span class="token string">"testBtn"</span><span class="token operator">></span>主要按钮<span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>button<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"text-center"</span> style<span class="token operator">=</span><span class="token string">"text-align: center;"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>vue2<span class="token operator">-</span>org<span class="token operator">-</span>tree name<span class="token operator">=</span><span class="token string">"test"</span>                         <span class="token punctuation">:</span>data<span class="token operator">=</span><span class="token string">"orgTree"</span>                         <span class="token punctuation">:</span>horizontal<span class="token operator">=</span><span class="token string">"horizontal"</span>                         <span class="token punctuation">:</span>collapsable<span class="token operator">=</span><span class="token string">"collapsable"</span>                         <span class="token punctuation">:</span>label<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">=</span><span class="token string">"labelClassName"</span>                         <span class="token punctuation">:</span>render<span class="token operator">-</span>content<span class="token operator">=</span><span class="token string">"renderContent"</span>                         @on<span class="token operator">-</span>expand<span class="token operator">=</span><span class="token string">"onExpand"</span>                         @on<span class="token operator">-</span>node<span class="token operator">-</span>click<span class="token operator">=</span><span class="token string">"onNodeClick"</span>          <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/ecmascript-6"</span><span class="token operator">></span>    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">{</span>                orgTree<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>                    label<span class="token punctuation">:</span> <span class="token string">"XXX科技有限公司"</span><span class="token punctuation">,</span>                    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                        <span class="token punctuation">{</span>                            id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                            label<span class="token punctuation">:</span> <span class="token string">"产品研发部"</span><span class="token punctuation">,</span>                            children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"研发-前端"</span>                                <span class="token punctuation">}</span><span class="token punctuation">,</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"研发-后端"</span>                                <span class="token punctuation">}</span><span class="token punctuation">,</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"UI设计"</span>                                <span class="token punctuation">}</span><span class="token punctuation">,</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"产品经理"</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">]</span>                        <span class="token punctuation">}</span><span class="token punctuation">,</span>                        <span class="token punctuation">{</span>                            id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>                            label<span class="token punctuation">:</span> <span class="token string">"销售部"</span><span class="token punctuation">,</span>                            children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"销售一部"</span>                                <span class="token punctuation">}</span><span class="token punctuation">,</span>                                <span class="token punctuation">{</span>                                    id<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                                    label<span class="token punctuation">:</span> <span class="token string">"销售二部"</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">]</span>                        <span class="token punctuation">}</span><span class="token punctuation">,</span>                        <span class="token punctuation">{</span>                            id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                            label<span class="token punctuation">:</span> <span class="token string">"财务部"</span>                        <span class="token punctuation">}</span><span class="token punctuation">,</span>                        <span class="token punctuation">{</span>                            id<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>                            label<span class="token punctuation">:</span> <span class="token string">"HR人事"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                horizontal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                collapsable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                expandAll<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                labelClassName<span class="token punctuation">:</span> <span class="token string">"bg-orange"</span>            <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token function">testBtn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              <span class="token keyword">this</span><span class="token punctuation">.</span>orgTree<span class="token operator">=</span><span class="token punctuation">{</span>                  id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>                  label<span class="token punctuation">:</span> <span class="token string">"XXX科技有限公司"</span><span class="token punctuation">,</span>                  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">{</span>                          id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                          label<span class="token punctuation">:</span> <span class="token string">"产品研发部"</span><span class="token punctuation">,</span>                          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"研发-前端"</span>                              <span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"研发-后端"</span><span class="token punctuation">,</span>                                  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                                      <span class="token punctuation">{</span>                                          id<span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span>                                          label<span class="token punctuation">:</span> <span class="token string">"Java研发组"</span>                                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                                      <span class="token punctuation">{</span>                                          id<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span>                                          label<span class="token punctuation">:</span> <span class="token string">"C++研发组"</span>                                      <span class="token punctuation">}</span>                                  <span class="token punctuation">]</span>                              <span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"UI设计"</span>                              <span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"产品经理"</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">]</span>                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token punctuation">{</span>                          id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>                          label<span class="token punctuation">:</span> <span class="token string">"销售部"</span><span class="token punctuation">,</span>                          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"销售一部"</span>                              <span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"销售二部"</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">]</span>                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token punctuation">{</span>                          id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                          label<span class="token punctuation">:</span> <span class="token string">"财务部"</span><span class="token punctuation">,</span>                          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"财务一部"</span>                              <span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>                                  id<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>                                  label<span class="token punctuation">:</span> <span class="token string">"财务二部"</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">]</span>                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token punctuation">{</span>                          id<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>                          label<span class="token punctuation">:</span> <span class="token string">"HR人事"</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">]</span>              <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            renderContent<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span>                    <span class="token operator">&lt;</span>div<span class="token operator">></span>                        <span class="token operator">&lt;</span>li<span class="token operator">></span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>label<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            onExpand<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'expand'</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    data<span class="token punctuation">.</span>expand <span class="token operator">=</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expand<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>expand <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'expand'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            onNodeClick<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//console.log(data.label);</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                    window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url<span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            collapse<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>                list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>expand<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        child<span class="token punctuation">.</span>expand <span class="token operator">=</span> <span class="token boolean">false</span>                    <span class="token punctuation">}</span>                    child<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>children<span class="token punctuation">)</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            expandChange<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expandAll<span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            toggleExpand<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">{</span>                        _this<span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'expand'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            _this<span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>children<span class="token punctuation">,</span> val<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'expand'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        _this<span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">,</span> val<span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>style type<span class="token operator">=</span><span class="token string">"text/css"</span><span class="token operator">></span>  <span class="token punctuation">.</span>org<span class="token operator">-</span>tree<span class="token operator">-</span>node<span class="token operator">-</span>label <span class="token punctuation">{</span>    white<span class="token operator">-</span>space<span class="token punctuation">:</span> nowrap<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>white <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> white<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>orange <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> orange<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>gold <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> gold<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>gray <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> gray<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>lightpink <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> lightpink<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>chocolate <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> chocolate<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token punctuation">.</span>bg<span class="token operator">-</span>tomato <span class="token punctuation">{</span>    background<span class="token operator">-</span>color<span class="token punctuation">:</span> tomato<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span></code></pre><h3 id="react版本：react-org-tree"><a href="#react版本：react-org-tree" class="headerlink" title="react版本：react-org-tree"></a>react版本：react-org-tree</h3><p>这是一个纯react版本，同时也是vue-org-tree的react版本，但似乎与vue-org-tree不是一个作者，vue-org-tree的原作者开始并没有提供react版本。react-org-tree完全还原了vue-org-tree的全部功能和样式，为需要使用react版本的的组织树提供了便利。<a href="https://github.com/artdong/react-org-tree" target="_blank" rel="noopener">react-org-tree项目地址</a>，可以关注下</p><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p>修复了vue版本的少包问题，只要导入react-org-tree即可</p><pre class=" language-shell"><code class="language-shell">npm install react-org-tree</code></pre><h4 id="效果图-1"><a href="#效果图-1" class="headerlink" title="效果图"></a>效果图</h4><p>横向展示图</p><p><img src="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/4.png" alt></p><p>纵向展示图</p><p><img src="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/5.png" alt></p><h4 id="组件完整代码-1"><a href="#组件完整代码-1" class="headerlink" title="组件完整代码"></a>组件完整代码</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span>PageHeaderWrapper<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@ant-design/pro-layout"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Collapse<span class="token punctuation">,</span>Button<span class="token punctuation">,</span>Rate  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span><span class="token keyword">import</span> OrgTree <span class="token keyword">from</span> <span class="token string">'react-org-tree'</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span> Panel <span class="token punctuation">}</span> <span class="token operator">=</span> Collapse<span class="token punctuation">;</span><span class="token keyword">const</span> MyNodeComponent <span class="token operator">=</span> node <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"initechNode"</span> key<span class="token operator">=</span><span class="token punctuation">{</span>node<span class="token punctuation">.</span>id<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">nodeClick</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>li<span class="token operator">></span><span class="token punctuation">{</span>node<span class="token punctuation">.</span>label<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>      <span class="token operator">&lt;</span>Rate allowHalf defaultValue<span class="token operator">=</span><span class="token punctuation">{</span>node<span class="token punctuation">.</span>rate<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">nodeClick</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">alert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyOrgTree</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      orgTree<span class="token punctuation">:</span> <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        label<span class="token punctuation">:</span> <span class="token string">'XXX股份有限公司'</span><span class="token punctuation">,</span>        rate<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>        children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span>          children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>            id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>            rate<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>            label<span class="token punctuation">:</span> <span class="token string">'后端工程师'</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>            rate<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>            label<span class="token punctuation">:</span> <span class="token string">'前端工程师'</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            id<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>            rate<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>            label<span class="token punctuation">:</span> <span class="token string">'运维工程师'</span>          <span class="token punctuation">}</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">3.5</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'人事部'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'销售部'</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      horizontal <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      collapsable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      expandAll <span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  testBtn<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">const</span> org <span class="token operator">=</span> <span class="token punctuation">{</span>      id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      label<span class="token punctuation">:</span> <span class="token string">'XXX股份有限公司'</span><span class="token punctuation">,</span>      rate<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>      children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        rate<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>        label<span class="token punctuation">:</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span>        children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'后端工程师'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'前端工程师'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'运维工程师'</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        rate<span class="token punctuation">:</span><span class="token number">3.5</span><span class="token punctuation">,</span>        label<span class="token punctuation">:</span> <span class="token string">'人事部'</span><span class="token punctuation">,</span>        children<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'人事一部'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>          id<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>          rate<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>          label<span class="token punctuation">:</span> <span class="token string">'人事二部'</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        rate<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span>        label<span class="token punctuation">:</span> <span class="token string">'销售部'</span>      <span class="token punctuation">}</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      orgTree<span class="token punctuation">:</span>org    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span>org<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  testBtn1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      horizontal<span class="token punctuation">:</span><span class="token boolean">false</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  testBtn2<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      horizontal<span class="token punctuation">:</span><span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  toggleExpand<span class="token operator">=</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// eslint-disable-next-line no-underscore-dangle</span>    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>        item<span class="token punctuation">.</span>expand <span class="token operator">=</span> val<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>          _this<span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>children<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      data<span class="token punctuation">.</span>expand <span class="token operator">=</span> val<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _this<span class="token punctuation">.</span><span class="token function">toggleExpand</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>children<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>PageHeaderWrapper<span class="token operator">></span>        <span class="token operator">&lt;</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>Collapse defaultActiveKey<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>callback<span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>Panel header<span class="token operator">=</span><span class="token string">"This is panel header 1"</span> key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>              <span class="token operator">&lt;</span>OrgTree                data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>orgTree<span class="token punctuation">}</span>                horizontal<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>horizontal<span class="token punctuation">}</span>                collapsable<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>collapsable<span class="token punctuation">}</span>                expandAll<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>expandAll<span class="token punctuation">}</span>                renderContent<span class="token operator">=</span><span class="token punctuation">{</span>MyNodeComponent<span class="token punctuation">}</span>              <span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>Panel<span class="token operator">></span>            <span class="token operator">&lt;</span>Panel header<span class="token operator">=</span><span class="token string">"This is panel header 1"</span> key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>              <span class="token operator">&lt;</span>Button style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginLeft<span class="token punctuation">:</span><span class="token string">'20px'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"primary"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>testBtn<span class="token punctuation">}</span><span class="token operator">></span>添加节点<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>              <span class="token operator">&lt;</span>Button style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginLeft<span class="token punctuation">:</span><span class="token string">'20px'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"primary"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>testBtn1<span class="token punctuation">}</span><span class="token operator">></span>纵向展示<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>              <span class="token operator">&lt;</span>Button style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>marginLeft<span class="token punctuation">:</span><span class="token string">'20px'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"primary"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>testBtn2<span class="token punctuation">}</span><span class="token operator">></span>横向展示<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>Panel<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>Collapse<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>PageHeaderWrapper<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyOrgTree<span class="token punctuation">;</span></code></pre><h2 id="orgchart"><a href="#orgchart" class="headerlink" title="orgchart"></a>orgchart</h2><p>react-orgchart是一个纯的react的组织树插件，网上有个叫orgchart的组件，它是基于jquery的，使用时必须导入jquery。而这里使用的react-orgchart则不需要依赖其他东西，<a href="https://www.npmjs.com/package/react-orgchart" target="_blank" rel="noopener">npm官方地址</a>。react-orgchart基本也能实现react-org-tree的效果，唯一不足的是没有横向展示，只有纵向展示。此外节点不支持收缩展开。不过这一点可以自己实现，大致思路如下：react-orgchart渲染出来是使用table来实现的，每个node实际上在tr中，而子节点所在的tr和父节点的tr是兄弟元素。因此在节点上添加点击事件，获取当前dom所在的tr，然后把这个tr的所有兄弟tr隐藏即可。下面介绍一下简单使用</p><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><pre class=" language-shell"><code class="language-shell">npm install react-orgchart</code></pre><h3 id="效果图-2"><a href="#效果图-2" class="headerlink" title="效果图"></a>效果图</h3><p><img src="/2020/04/01/vue-he-react-shi-xian-zu-zhi-jia-gou-shu/3.png" alt></p><h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>首先引入组件和样式</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> OrgChart <span class="token keyword">from</span> <span class="token string">'react-orgchart'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'react-orgchart/index.css'</span><span class="token punctuation">;</span></code></pre><p>刚开始使用的时候呢，发现它没有vue版本的好看，不过随后我就发现它的每个节点也是可以自定义样式的，每个节点也是一个组件，因此可以轻松的改写样式，节点上写点击事情也非常容易，对react兼容的非常好。不像vue版本那样需要额外引入支持JSX的插件，节点组件代码如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> MyNodeComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"initechNode"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Hi my real name is: "</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>actor<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span> node<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="组件完整代码-2"><a href="#组件完整代码-2" class="headerlink" title="组件完整代码"></a>组件完整代码</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span>PageHeaderWrapper<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@ant-design/pro-layout"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Collapse<span class="token punctuation">,</span>Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span><span class="token keyword">import</span> OrgChart <span class="token keyword">from</span> <span class="token string">'react-orgchart'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'react-orgchart/index.css'</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span> Panel <span class="token punctuation">}</span> <span class="token operator">=</span> Collapse<span class="token punctuation">;</span><span class="token keyword">const</span> MyNodeComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"initechNode"</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>border<span class="token punctuation">:</span><span class="token string">'1px dashed #000'</span><span class="token punctuation">,</span>width<span class="token punctuation">:</span><span class="token string">'100px'</span><span class="token punctuation">,</span>margin<span class="token punctuation">:</span><span class="token string">'0 auto'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">alert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>actor<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>      <span class="token punctuation">{</span> node<span class="token punctuation">.</span>name <span class="token punctuation">}</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyOrgTree</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      orgTree<span class="token punctuation">:</span><span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        actor<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"Peter Gibbons"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"Ron Livingston"</span><span class="token punctuation">,</span>            children<span class="token punctuation">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"And More!!"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"Gary Cole1"</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"And More!!"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"Gary Cole1"</span>              <span class="token punctuation">}</span>            <span class="token punctuation">]</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"test"</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"Bob Slydell"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"John C. McGi..."</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  testBtn<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      orgTree<span class="token punctuation">:</span><span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        actor<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"Peter Gibbons"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"Ron Livingston"</span><span class="token punctuation">,</span>            children<span class="token punctuation">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"And More!!"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"Gary Cole1"</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"And More!!"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"Gary Cole1"</span>              <span class="token punctuation">}</span>            <span class="token punctuation">]</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"Stephen Root"</span><span class="token punctuation">,</span>            children<span class="token punctuation">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"test1"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"test1"</span><span class="token punctuation">,</span>                children<span class="token punctuation">:</span> <span class="token punctuation">[</span>                  <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">"test3"</span><span class="token punctuation">,</span>                    actor<span class="token punctuation">:</span> <span class="token string">"test3"</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">"test4"</span><span class="token punctuation">,</span>                    actor<span class="token punctuation">:</span> <span class="token string">"test4"</span>                  <span class="token punctuation">}</span>                <span class="token punctuation">]</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span>                name<span class="token punctuation">:</span> <span class="token string">"test2"</span><span class="token punctuation">,</span>                actor<span class="token punctuation">:</span> <span class="token string">"test2"</span>              <span class="token punctuation">}</span>            <span class="token punctuation">]</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>          <span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">"Bob Slydell"</span><span class="token punctuation">,</span>            actor<span class="token punctuation">:</span> <span class="token string">"John C. McGi..."</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>PageHeaderWrapper<span class="token operator">></span>        <span class="token operator">&lt;</span>div<span class="token operator">></span>          <span class="token operator">&lt;</span>Collapse defaultActiveKey<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>callback<span class="token punctuation">}</span><span class="token operator">></span>            <span class="token operator">&lt;</span>Panel header<span class="token operator">=</span><span class="token string">"This is panel header 1"</span> key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>              <span class="token operator">&lt;</span>OrgChart tree<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>orgTree<span class="token punctuation">}</span> NodeComponent<span class="token operator">=</span><span class="token punctuation">{</span>MyNodeComponent<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>Panel<span class="token operator">></span>            <span class="token operator">&lt;</span>Panel header<span class="token operator">=</span><span class="token string">"This is panel header 1"</span> key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>              <span class="token operator">&lt;</span>Button type<span class="token operator">=</span><span class="token string">"primary"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>testBtn<span class="token punctuation">}</span><span class="token operator">></span>Primary<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>Panel<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>Collapse<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>PageHeaderWrapper<span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyOrgTree<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>element-ui实现二级多选框</title>
      <link href="/2020/03/30/element-ui-shi-xian-er-ji-duo-xuan-kuang/"/>
      <url>/2020/03/30/element-ui-shi-xian-er-ji-duo-xuan-kuang/</url>
      
        <content type="html"><![CDATA[<p>最近公司做项目碰到个需求，要实现一个二级下拉的多选框，并且实现选中一级条目时，此条目下的二级条目全选和全不选的功能。全选和全不选倒简单通过JS实现一下就行了，最主要的是elementUI没有现成的二级多选下拉框，因此首先需要实现一个多选二级下拉框。经过多方查阅资料，终于找到了elementUI有一个el-pot-right的class样式。这个样式可以实现在某个选项后面出现二级面板。在实现过程费了不少劲，故在此记录一下</p><p><img src="/2020/03/30/element-ui-shi-xian-er-ji-duo-xuan-kuang/1.jpg" alt></p><h2 id="Select-选择器"><a href="#Select-选择器" class="headerlink" title="Select 选择器"></a>Select 选择器</h2><p>在做之前我在CSDN找了一下，发现基本都是两个下拉框然后实现二级联动，类似第一个框选择省份，第二个框自动出现该省份下对应的所有城市。比如下面这样的</p><p><img src="/2020/03/30/element-ui-shi-xian-er-ji-duo-xuan-kuang/5.gif" alt></p><p>而我实际上想要这样的效果（下面这图是我已经做好的）</p><p><img src="/2020/03/30/element-ui-shi-xian-er-ji-duo-xuan-kuang/4.gif" alt></p><p>话不多说直接上代码吧，这里用到了select框的multiple和collapse-tags两个属性，multiple是实现下拉框可多选，collapse-tags是实现当多选时，只展示一个条目多余的显示数字累加。同时我把el-select套了一层封装自定义组件，并通过v-model可以直接获取到选择的值，这里就涉及到vue组件的一个高级用法了，自定义组件怎么绑定v-model。一般父子组件中，当子组件中的一些input框，select框值发生改变，向父组件返回这些改变的值是是通过监听函数的方式，而如果仅仅只是返回一个object时，用v-model更加方便。话不多说，直接上代码吧</p><h2 id="定义MySelect组件"><a href="#定义MySelect组件" class="headerlink" title="定义MySelect组件"></a>定义MySelect组件</h2><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-select</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectData<span class="token punctuation">"</span></span> <span class="token attr-name">multiple</span> <span class="token attr-name">collapse-tags</span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>请选择<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>select-item<span class="token punctuation">"</span></span> <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>changeData<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-option</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item1 in treeData<span class="token punctuation">"</span></span>                   <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item1.value<span class="token punctuation">"</span></span>                   <span class="token attr-name">:label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item1.label<span class="token punctuation">"</span></span>                   <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item1.value<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>{{item1.label}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>el-pot-right<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-option</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item2 in item1.children<span class="token punctuation">"</span></span>                       <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item2.value<span class="token punctuation">"</span></span>                       <span class="token attr-name">:label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item2.label<span class="token punctuation">"</span></span>                       <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>item2.value<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>{{item2.label}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-option</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-option</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-select</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span><span class="token string">'my-select'</span><span class="token punctuation">,</span>        model<span class="token punctuation">:</span> <span class="token punctuation">{</span>            prop<span class="token punctuation">:</span> <span class="token string">'data'</span><span class="token punctuation">,</span>            event<span class="token punctuation">:</span> <span class="token string">'revert'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        props<span class="token punctuation">:</span> <span class="token punctuation">{</span>            treeData<span class="token punctuation">:</span><span class="token punctuation">{</span>                type<span class="token punctuation">:</span> Array<span class="token punctuation">,</span>                <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">{</span>                selectData<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        methods<span class="token punctuation">:</span><span class="token punctuation">{</span>            <span class="token function">changeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'revert'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>selectData<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">  <span class="token selector"><span class="token class">.el-pot-right</span></span><span class="token punctuation">{</span>    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>    <span class="token property">top</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token property">right</span><span class="token punctuation">:</span> -<span class="token number">105%</span><span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>    <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode">#FFF</span><span class="token punctuation">;</span>    <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid <span class="token hexcode">#E4E7ED</span><span class="token punctuation">;</span>    <span class="token property">box-shadow</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">2</span>px <span class="token number">12</span>px <span class="token number">0</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>    <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">4</span>px<span class="token punctuation">;</span>    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">5</span>px <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-scrollbar</span></span><span class="token punctuation">{</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> initial<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-scrollbar__wrap</span></span><span class="token punctuation">{</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> initial<span class="token punctuation">;</span>    <span class="token property">margin-right</span><span class="token punctuation">:</span><span class="token number">0</span> <span class="token important">!important</span><span class="token punctuation">;</span>    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token important">!important</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-select-dropdown__item</span></span><span class="token punctuation">{</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> initial<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-select-dropdown__item</span>><span class="token class">.el-pot-right</span><span class="token pseudo-class">:hover</span></span><span class="token punctuation">{</span>    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-select-dropdown__item.hover</span>><span class="token class">.el-pot-right</span></span><span class="token punctuation">{</span>    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector"><span class="token class">.is-multiple</span> <span class="token class">.el-scrollbar__bar</span></span><span class="token punctuation">{</span>    <span class="token property">display</span><span class="token punctuation">:</span> none <span class="token important">!important</span><span class="token punctuation">;</span>    <span class="token property">opacity</span><span class="token punctuation">:</span><span class="token number">0</span> <span class="token important">!important</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code></pre><h2 id="引用MySelect组件"><a href="#引用MySelect组件" class="headerlink" title="引用MySelect组件"></a>引用MySelect组件</h2><p>在表单或是div中引用MySelect组件</p><pre class=" language-javascript"><code class="language-javascript"> <span class="token operator">&lt;</span>template<span class="token operator">></span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>         <span class="token operator">&lt;</span>el<span class="token operator">-</span>col <span class="token punctuation">:</span>span<span class="token operator">=</span><span class="token string">"11"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>my<span class="token operator">-</span>select <span class="token punctuation">:</span>tree<span class="token operator">-</span>data<span class="token operator">=</span><span class="token string">"treeData"</span> v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"treeDataList"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>my<span class="token operator">-</span>select<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>col<span class="token operator">></span>          <span class="token operator">&lt;</span>el<span class="token operator">-</span>col <span class="token punctuation">:</span>span<span class="token operator">=</span><span class="token string">"11"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>el<span class="token operator">-</span>button @click<span class="token operator">=</span><span class="token string">"getSelectData"</span><span class="token operator">></span>取值<span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>button<span class="token operator">></span>          <span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>col<span class="token operator">></span>     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span> <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/ecmascript-6"</span><span class="token operator">></span>  <span class="token keyword">import</span> MySelect <span class="token keyword">from</span> <span class="token string">'../sub/MySelect.vue'</span>    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>        components<span class="token punctuation">:</span> <span class="token punctuation">{</span>            MySelect        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">{</span>                treeDataList<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                treeData<span class="token punctuation">:</span><span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        label<span class="token punctuation">:</span><span class="token string">"熟食类"</span><span class="token punctuation">,</span>                        value<span class="token punctuation">:</span><span class="token string">"cooked"</span><span class="token punctuation">,</span>                        children<span class="token punctuation">:</span><span class="token punctuation">[</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"炸鸡腿"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"drumstick"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"辣条"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"strips"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"小鱼干"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"fillet"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"老干妈"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"old"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"烤面包"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"bao"</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token punctuation">{</span>                        label<span class="token punctuation">:</span><span class="token string">"炒货类"</span><span class="token punctuation">,</span>                        value<span class="token punctuation">:</span><span class="token string">"mast"</span><span class="token punctuation">,</span>                        children<span class="token punctuation">:</span><span class="token punctuation">[</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"杏仁"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"almond"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"腰果"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"cashew"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"夏威夷果"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"macadamia"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"开心果"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"pistachio"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"核桃"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"walnut"</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token punctuation">{</span>                        label<span class="token punctuation">:</span><span class="token string">"水果类"</span><span class="token punctuation">,</span>                        value<span class="token punctuation">:</span><span class="token string">"fruit"</span><span class="token punctuation">,</span>                        children<span class="token punctuation">:</span><span class="token punctuation">[</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"苹果"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"apple"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"香蕉"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"banana"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"菠萝"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"pineapple"</span>                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            <span class="token punctuation">{</span>                                label<span class="token punctuation">:</span><span class="token string">"草莓"</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span><span class="token string">"strawberry"</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token function">getSelectData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeDataList<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>大功告成，比较难的就是自定义组件的v-model用法，剩下的就是一些css样式的美化，二级多选框的数据结构定义是一颗树，可在组件初始化时，通过入参传进去。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python基本概念和语法</title>
      <link href="/2020/03/28/python-ji-ben-gai-nian-he-yu-fa/"/>
      <url>/2020/03/28/python-ji-ben-gai-nian-he-yu-fa/</url>
      
        <content type="html"><![CDATA[<p>随着人工智能的发展，python语言也越来越受到青睐。逐渐成为了人工智能领域的首选编程语言，实际上python不仅在人工智能领域应用广泛，同样可以用于服务端开发（虽然服务端是Java的主场）。目前Python是排名前3的最受欢迎和增长最快的编程语言之一，在一些语言排行榜上Python已经跃居首位，在TIOBE语言排行榜上，Python也仅次于Java和C，来发展前景非常广阔。它是一种多用途，高级别，面向对象，交互式，解释型和对用户非常友好的编程语言。由于工作原因利用零碎的时间学习使用python，本文是对Python基本使用的总结，一些入门级知识和概念的记录</p><p><img src="/2020/03/28/python-ji-ben-gai-nian-he-yu-fa/1.jpg" alt></p><h2 id="Python可以做什么"><a href="#Python可以做什么" class="headerlink" title="Python可以做什么"></a>Python可以做什么</h2><p>学习一门语言首先要明白它能做什么，Python 的主流的领域，当下全栈工程师的概念很火，而Python是一种全栈的开发语言，所以你如果能学好Python，那么前端，后端，测试，大数据分析，爬虫等这些工作你都能胜任。python的主要应用领域有以下几个方面</p><ol><li><strong>网络爬虫</strong>：说起爬虫很多第一想到的就python吧 ， 网络爬虫又称网络蜘蛛，是指按照某种规则在网络上爬取所需内容的脚本程序。相比与其他静态编程语言，如java，c#，c++，python抓取网页文档的接口更简洁；相比其他动态脚本语言，如perl，shell，python的urllib2包提供了较为完整的访问网页文档的API。</li><li><strong>科学计算</strong>：说起科学计算，首先会被提到的可能是MATLAB。然而除了MATLAB的一些专业性很强的工具箱还无法替代之外，MATLAB的大部分常用功能都可以在Python世界中找到相应的扩展库。</li><li><strong>游戏编程</strong>：Python在很早的时候就是一种游戏编程的辅助工具。在《星球大战》中扮演了重要的角色。目前，通过Python完全可以编写出非常棒的游戏程序。</li><li><strong>多媒体</strong>：利用PIL、Piddle、ReportLab 等模块,你可以处理图象、声音、视频、动画等，从而为你的程序添加亮丽的光彩。动态图表的生成、统计分析图表都可以通过Python来完成。</li><li><strong>网站开发</strong>：web开发现在用 Python 的也不少了，开发起来简单又高效，因为 Python 也有网站开发相关的框架，比如 Flask、Django、Bottle。有了它们，不管你是开发个人网站也好，企业网站也罢， Python 都能胜任。</li><li><strong>自动化运维</strong>：随着技术的进步、业务需求的快速增长，一个运维人员通常要管理上百、上千台服务器，运维工作也变的重复、繁杂。把运维工作自动化，能够把运维人员从服务器的管理中解放出来，让运维工作变得简单、快速、准确。用Python 来写是很爽的，那些频繁的、重复的、无脑的操作，你都可以自己写一个 Python 脚本让电脑帮你操作，可以节省你大量的时间。</li><li><strong>自动化测试</strong>：编写为简单的实现脚本，运用在Selenium/lr中，实现自动化。</li></ol><h2 id="Python的特点"><a href="#Python的特点" class="headerlink" title="Python的特点"></a>Python的特点</h2><ol><li><strong>简单易学</strong>：Python是一种代表简单主义思想的语言。阅读一个良好的Python程序就感觉像是在读英语一样。它使你能够专注于解决问题而不是去搞明白语言本身。Python极其容易上手，因为Python有极其简单的说明文档。</li><li><strong>高层语言</strong>：用Python语言编写程序的时候无需考虑诸如如何管理你的程序使用的内存一类的底层细节。垃圾回收机制似乎是高级语言的标配了</li><li><strong>可移植性</strong>：于 Python 是开源的，它已经被移植到许多平台上。如果能够避免使用依赖系统的特性，那就意味着，所有 Python 程序都无需修改就可以在好多平台上运行，包括 Linux、Windows、FreeBSD、Solaris 等等，甚至还有 PocketPC、Symbian 以及 Google 基于 Linux 开发的 Android平台。</li><li><strong>解释型语言</strong>：一个用编译性语言比如C或C++写的程序可以从源文件（即C或C++语言）转换到一个你的计算机使用的语言（二进制代码，即0和1）。这个过程通过编译器和不同的标记、选项完成。运行程序的时候，连接/转载器软件把你的程序从硬盘复制到内存中并且运行。而Python语言写的程序不需要编译成二进制代码。你可以直接从源代码运行 程序。在计算机内部，Python解释器把源代码转换成称为字节码的中间形式，然后再把它翻译成计算机使用的机器语言并运行。这使得使用Python更加简单。也使得Python程序更加易于移植。</li><li><strong>面向对象</strong>：Python既支持面向过程的编程也支持面向对象的编程。在“面向过程”的语言中，程序是由过程或仅仅是可重用代码的函数构建起来的。在“面向对象”的语言中，程序是由数据和功能组合而成的对象构建起来的。</li><li><strong>可扩展性</strong>：Python 的可扩展性体现为它的模块，Python 具有脚本语言中最丰富和强大的类库，这些类库覆盖了文件 I/O、GUI、网络编程、数据库访问、文本操作等绝大部分应用场景。Python 可扩展性一个最好的体现是，当我们需要一段关键代码运行的更快时，可以将其用 C 或 C++ 语言编写，然后在 Python 程序中使用它们即可。</li><li><strong>丰富的库</strong>：Python标准库确实很庞大。它可以帮助处理各种工作，包括正则表达式、文档生成、单元测试、线程、数据库、网页浏览器、CGI、FTP、电子邮件、XML、XML-RPC、HTML、WAV文件、密码系统、GUI（图形用户界面）、Tk和其他与系统有关的操作。这被称作Python的 “功能齐全” 理念。除了标准库以外，还有许多其他高质量的库，如wxPython、Twisted和Python图像库等等。</li></ol><h2 id="Python的基本数据类型"><a href="#Python的基本数据类型" class="headerlink" title="Python的基本数据类型"></a>Python的基本数据类型</h2><p>python3的基本数据类型：Number（数字）、String（字符串）、List（列表）、Tuple（元组）、Set（集合）、Dictionary（字典）、其中Number又可细分为整数型，浮点型，复数型，布尔型（布尔型为什么会被划分在Number类型下面呢？在Python2 中是没有布尔型的，它用数字 0 表示 False，用 1 表示 True。到 Python3 中，把 True 和 False 定义成关键字了，但它们的值还是 1 和 0，它们可以和数字相加。）。python是弱类型语言，会在运行时根据上下文自动识别变量类型</p><h3 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h3><p>在Python中，None、任何数值类型中的0、空字符串“”、空元组()、空列表[]、空字典{}都被当作False，还有自定义类型，如果实现了<strong>nonzero</strong>()或<strong>len</strong>()方法且方法返回0或False，则其实例也被当作False，其他对象均为True 。布尔值还可以用and、or和not运算。 </p><h3 id="整型-Int"><a href="#整型-Int" class="headerlink" title="整型(Int)"></a>整型(Int)</h3><p>在Python内部对整数的处理分为普通整数和长整数，普通整数长度为机器位长，通常都是32位，超过这个范围的整数就自动当长整数处理，而长整数的范围几乎完全没限制 。Python可以处理任意大小的整数，当然包括负整数，在程序中的表示方法和数学上的写法一模一样，例如：1，100，-8080，0，等等。</p><h3 id="浮点型-Float"><a href="#浮点型-Float" class="headerlink" title="浮点型(Float)"></a>浮点型(Float)</h3><p>Python的浮点数就是数学中的小数，类似C语言中的double。 在运算中，整数与浮点数运算的结果是浮点数 。浮点数也就是小数，之所以称为浮点数，是因为按照科学记数法表示时，一个浮点数的小数点位置是可变的，比如，1.23x109和12.3x108是相等的。浮点数可以用数学写法，如1.23，3.14，-9.01，等等。但是对于很大或很小的浮点数，就必须用科学计数法表示，把10用e替代，1.23x109就是1.23e9，或者12.3e8，0.000012可以写成1.2e-5，等等。 整数和浮点数在计算机内部存储的方式是不同的，整数运算永远是精确的（除法难道也是精确的？是的！），而浮点数运算则可能会有四舍五入的误差。</p><h3 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串(String)"></a>字符串(String)</h3><p>Python字符串即可以用单引号也可以用双引号括起来，甚至还可以用三引号括起来 字符串是以”或”“括起来的任意文本，比如’abc’，”xyz”等等。请注意，”或”“本身只是一种表示方式，不是字符串的一部分，因此，字符串’abc’只有a，b，c这3个字符。如果’本身也是一个字符，那就可以用”“括起来，比如”I’m OK”包含的字符是I，’，m，空格，O，K这6个字符。<br>如果字符串内部既包含’又包含”怎么办？可以用转义字符\来标识</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 整数类型</span>    a<span class="token operator">=</span><span class="token number">12</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>isinstance<span class="token punctuation">(</span>a<span class="token punctuation">,</span> int<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 浮点类型</span>    b<span class="token operator">=</span><span class="token number">3.14</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>isinstance<span class="token punctuation">(</span>b<span class="token punctuation">,</span> float<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 布尔类型</span>    c<span class="token operator">=</span><span class="token boolean">True</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>isinstance<span class="token punctuation">(</span>c<span class="token punctuation">,</span> bool<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 复数类型</span>    d<span class="token operator">=</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">3j</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>isinstance<span class="token punctuation">(</span>d<span class="token punctuation">,</span> complex<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 字符类型</span>    e<span class="token operator">=</span><span class="token string">'python'</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>isinstance<span class="token punctuation">(</span>e<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>    dataType<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>输出结果如下</p><pre><code>&lt;class &#39;int&#39;&gt;True&lt;class &#39;float&#39;&gt;True&lt;class &#39;bool&#39;&gt;True&lt;class &#39;complex&#39;&gt;True&lt;class &#39;str&#39;&gt;True</code></pre><h3 id="列表-List"><a href="#列表-List" class="headerlink" title="列表(List)"></a>列表(List)</h3><p>用符号[]表示列表，中间的元素可以是任何类型，用逗号分隔。list类似C语言中的数组，用于顺序存储结构 。列表可以完成大多数集合类的数据结构实现。列表中元素的类型可以不相同，它支持数字，字符串甚至可以包含列表（所谓嵌套）。<br>列表是写在方括号 [] 之间、用逗号分隔开的元素列表。和字符串一样，列表同样可以被索引和截取，列表被截取后返回一个包含所需元素的新列表。</p><pre class=" language-python"><code class="language-python">list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'abcd'</span><span class="token punctuation">,</span><span class="token number">213</span><span class="token punctuation">,</span><span class="token number">2.98</span><span class="token punctuation">,</span><span class="token string">'okokkok'</span><span class="token punctuation">,</span><span class="token number">70.2</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span>tinylist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token string">'kokoko'</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#输出完整列表</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#输出列表第一个元素</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#输出列表的第2个元素至第4个元素</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#输出列表第4个元素以及之后的元素</span><span class="token keyword">print</span><span class="token punctuation">(</span>tinylist <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#输出列表两次</span><span class="token keyword">print</span><span class="token punctuation">(</span>list <span class="token operator">+</span> tinylist<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#连接列表</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#输出嵌套列表</span><span class="token keyword">print</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#输出嵌套列表中的第2个元素</span></code></pre><p>输出结果</p><pre><code># 运行结果如下 #[&#39;abcd&#39;, 213, 2.98, &#39;okokkok&#39;, 70.2, [&#39;aaa&#39;, 12]]abcd[213, 2.98][&#39;okokkok&#39;, 70.2, [&#39;aaa&#39;, 12]][123, &#39;kokoko&#39;, 123, &#39;kokoko&#39;][&#39;abcd&#39;, 213, 2.98, &#39;okokkok&#39;, 70.2, [&#39;aaa&#39;, 12], 123, &#39;kokoko&#39;][&#39;aaa&#39;, 12]12</code></pre><h3 id="Tuple-元组"><a href="#Tuple-元组" class="headerlink" title="Tuple(元组)"></a>Tuple(元组)</h3><p>元组（tuple）与列表类似，不同之处在于元组的元素不能修改。元组写在小括号 () 里，元素之间用逗号隔开。<br>元组中的元素类型也可以不相同：</p><pre class=" language-python"><code class="language-python">tuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'abd'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">12.22</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token string">'342'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>tinytuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3242</span><span class="token punctuation">,</span><span class="token string">'dsf'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tuple<span class="token punctuation">)</span>             <span class="token comment" spellcheck="true"># 输出完整元组</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true"># 输出元组的第一个元素</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tuple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 输出从第二个元素开始到第三个元素</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tuple<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># 输出从第三个元素开始的所有元素</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tinytuple <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 输出两次元组</span><span class="token keyword">print</span> <span class="token punctuation">(</span>tuple <span class="token operator">+</span> tinytuple<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 连接元组</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token punctuation">(</span><span class="token string">'abd'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">12.22</span><span class="token punctuation">,</span> <span class="token string">'ios'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'342'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>abd<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">12.22</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">12.22</span><span class="token punctuation">,</span> <span class="token string">'ios'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'342'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3242</span><span class="token punctuation">,</span> <span class="token string">'dsf'</span><span class="token punctuation">,</span> <span class="token number">3242</span><span class="token punctuation">,</span> <span class="token string">'dsf'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'abd'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">12.22</span><span class="token punctuation">,</span> <span class="token string">'ios'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'342'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3242</span><span class="token punctuation">,</span> <span class="token string">'dsf'</span><span class="token punctuation">)</span></code></pre><p>元组与字符串类似，可以被索引且下标索引从0开始，-1 为从末尾开始的位置。也可以进行截取（看上面，这里不再赘述）。其实，可以把字符串看作一种特殊的元组。</p><h3 id="Set-集合"><a href="#Set-集合" class="headerlink" title="Set(集合)"></a>Set(集合)</h3><p>集合（set）是由一个或数个形态各异的大小整体组成的，构成集合的事物或对象称作元素或是成员。基本功能是进行成员关系测试和删除重复元素。可以使用大括号 { } 或者 set() 函数创建集合，注意：创建一个空集合必须用 set() 而不是 { }，因为 { } 是用来创建一个空字典。创建格式：</p><pre class=" language-python"><code class="language-python">parame <span class="token operator">=</span> <span class="token punctuation">{</span>value01<span class="token punctuation">,</span>value02<span class="token punctuation">,</span>…<span class="token punctuation">}</span><span class="token comment" spellcheck="true">#或者</span>set<span class="token punctuation">(</span>value<span class="token punctuation">)</span></code></pre><p>举个例子：</p><pre class=" language-python"><code class="language-python">student <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'Jim'</span><span class="token punctuation">,</span><span class="token string">'Marry'</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'Jack'</span><span class="token punctuation">,</span><span class="token string">'Rose'</span><span class="token punctuation">}</span><span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#输出集合，重复的元素会被自动去掉，且每次输出顺序不同</span><span class="token comment" spellcheck="true"># 成员测试</span><span class="token keyword">if</span> <span class="token string">'Rose'</span> <span class="token keyword">in</span> student<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Rose在集合中'</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Rose不在集合中'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#set可以进行集合运算</span>a <span class="token operator">=</span> set<span class="token punctuation">(</span><span class="token string">'abcdefg'</span><span class="token punctuation">)</span>b <span class="token operator">=</span> set<span class="token punctuation">(</span><span class="token string">'alaceio'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">-</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#a和b的差集</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">|</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#a和b的并集</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">&amp;</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#a和b的交集</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">^</span>b<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#a和b中不同时存在的元素</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token punctuation">{</span><span class="token string">'Rose'</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span> <span class="token string">'Marry'</span><span class="token punctuation">,</span> <span class="token string">'Jim'</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">}</span>Rose在集合中<span class="token punctuation">{</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">}</span></code></pre><h3 id="字典-Dictionary"><a href="#字典-Dictionary" class="headerlink" title="字典(Dictionary)"></a>字典(Dictionary)</h3><p>列表是有序的集合，字典是无序的对象集合。两者之间的区别在于：字典当中的元素是通过键来存取的，而不是通过偏移存取。字典是一种映射类型，字典用{}标识，他是一个无序的　键(key):值(value)的集合。键(key)必须使用不可变类型。<br>在同一个字典中，键(key)必须是唯一的。</p><pre class=" language-python"><code class="language-python">dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>dict<span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1-Python'</span>dict<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'2-Python'</span>tinydict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span><span class="token string">'okokokok'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'site'</span><span class="token punctuation">:</span><span class="token string">'fasklh'</span><span class="token punctuation">}</span><span class="token keyword">print</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tinydict<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tinydict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tinydict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token number">1</span><span class="token operator">-</span>Python<span class="token number">2</span><span class="token operator">-</span>Python<span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'okokokok'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'site'</span><span class="token punctuation">:</span> <span class="token string">'fasklh'</span><span class="token punctuation">}</span>dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'site'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>dict_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'okokokok'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'fasklh'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>构造函数dict()可以从键值对序列中构建字典如下</p><pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> dict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'heu'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'dianzi'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">'heu'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'dianzi'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'no'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token operator">>></span><span class="token operator">></span> dict<span class="token punctuation">(</span>heu<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>dianzi<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>no<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">'heu'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'dianzi'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'no'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token number">81</span><span class="token punctuation">}</span><span class="token operator">>></span><span class="token operator">></span> dict<span class="token punctuation">(</span>heu<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'dianzi'</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>no<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#key类型不同创建失败</span>  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span>SyntaxError<span class="token punctuation">:</span> keyword can't be an expression</code></pre><h2 id="Python数据类型转换"><a href="#Python数据类型转换" class="headerlink" title="Python数据类型转换"></a>Python数据类型转换</h2><p>有时候，我们需要对数据内置的类型进行转换，数据类型的转换，你只需要将数据类型作为函数名即可。以下几个内置的函数可以执行数据类型之间的转换。这些函数返回一个新的对象，表示转换的值。</p><table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://www.runoob.com/python3/python-func-int.html" target="_blank" rel="noopener">int(x [,base])</a></td><td>将x转换为一个整数</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-float.html" target="_blank" rel="noopener">float(x)</a></td><td>将x转换到一个浮点数</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-complex.html" target="_blank" rel="noopener">complex(real [,imag])</a></td><td>创建一个复数</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-str.html" target="_blank" rel="noopener">str(x)</a></td><td>将对象 x 转换为字符串</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-repr.html" target="_blank" rel="noopener">repr(x)</a></td><td>将对象 x 转换为表达式字符串</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-eval.html" target="_blank" rel="noopener">eval(str)</a></td><td>用来计算在字符串中的有效Python表达式,并返回一个对象</td></tr><tr><td><a href="https://www.runoob.com/python3/python3-func-tuple.html" target="_blank" rel="noopener">tuple(s)</a></td><td>将序列 s 转换为一个元组</td></tr><tr><td><a href="https://www.runoob.com/python3/python3-att-list-list.html" target="_blank" rel="noopener">list(s)</a></td><td>将序列 s 转换为一个列表</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-set.html" target="_blank" rel="noopener">set(s)</a></td><td>转换为可变集合</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-dict.html" target="_blank" rel="noopener">dict(d)</a></td><td>创建一个字典。d 必须是一个 (key, value)元组序列</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-frozenset.html" target="_blank" rel="noopener">frozenset(s)</a></td><td>转换为不可变集合</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-chr.html" target="_blank" rel="noopener">chr(x)</a></td><td>将一个整数转换为一个字符</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-ord.html" target="_blank" rel="noopener">ord(x)</a></td><td>将一个字符转换为它的整数值</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-hex.html" target="_blank" rel="noopener">hex(x)</a></td><td>将一个整数转换为一个十六进制字符串</td></tr><tr><td><a href="https://www.runoob.com/python3/python-func-oct.html" target="_blank" rel="noopener">oct(x)</a></td><td>将一个整数转换为一个八进制字符串</td></tr></tbody></table><h2 id="Python的变量作用域"><a href="#Python的变量作用域" class="headerlink" title="Python的变量作用域"></a>Python的变量作用域</h2><p>就作用域而言，Python与C有着很大的区别，在Python中并不是所有的语句块中都会产生作用域。只有当变量在Module(模块)、Class(类)、def(函数)中定义的时候，才会有作用域的概念。作用范围从小到大为，小作用域的可以调用大作用域的内容。1.局部 Local；2.闭包 Enclosing；3.全局 Global；4.内建 Build-in。</p><h3 id="L-local-局部作用域"><a href="#L-local-局部作用域" class="headerlink" title="L(local)局部作用域"></a>L(local)局部作用域</h3><p>局部变量：包含在def关键字定义的语句块中，即在函数中定义的变量。每当函数被调用时都会创建一个新的局部作用域。Python中也有递归，即自己调用自己，每次调用都会创建一个新的局部命名空间。在函数内部的变量声明，除非特别的声明为全局变量，否则均默认为局部变量。有些情况需要在函数内部定义全局变量，这时可以使用global关键字来声明变量的作用域为全局。局部变量域就像一个 栈，仅仅是暂时的存在，依赖创建该局部作用域的函数是否处于活动的状态。所以，一般建议尽量少定义全局变量，因为全局变量在模块文件运行的过程中会一直存在，占用内存空间。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    v<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment" spellcheck="true">#局部变量</span><span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 运行结果如下</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"test.py"</span><span class="token punctuation">,</span> line <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>NameError<span class="token punctuation">:</span> name <span class="token string">'v'</span> <span class="token keyword">is</span> <span class="token operator">not</span> defined</code></pre><p>由于局部变量作用域只在函数内部有效，因此程序会报错</p><h4 id="E-enclosing-闭包作用域"><a href="#E-enclosing-闭包作用域" class="headerlink" title="E(enclosing)闭包作用域"></a>E(enclosing)闭包作用域</h4><p>在python中“一切皆对象”，因此函数也被看作对象，因此产生了一种特殊的形式函数嵌套。E也包含在def关键字中，E和L是相对的，E相对于更上层的函数而言也是L。与L的区别在于，对一个函数而言，L是定义在此函数内部的局部作用域，而E是定义在此函数的上一层父级函数的局部作用域。主要是为了实现Python的闭包，而增加的实现。闭包是在内嵌函数生成的时候将其用到的环境以及自己本身都封装在了一起。为了直观理解闭包，我们介绍一下<strong>code</strong>对象，<strong>code</strong>对象是指代码对象，表示编译成字节的的可执行Python代码，或者字节码。它有几个比较重要的属性：</p><ul><li><p>co_name: 函数的名称</p></li><li><p>co_nlocals: 函数使用的局部变量的个数</p></li><li><p>co_varnames: 一个包含局部变量名字的元组</p></li><li><p>co_cellvars: 是一个元组，包含嵌套的函数所引用的局部变量的名字</p></li><li><p>co_freevars: 是一个元组，保存使用了的外层作用域中的变量名</p></li><li><p>co_consts: 是一个包含字节码使用的字面量的元组</p></li></ul><p>有如下程序</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">out_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token number">1</span>    b <span class="token operator">=</span> <span class="token number">2</span>    c <span class="token operator">=</span> <span class="token number">3</span>    <span class="token keyword">def</span> <span class="token function">iner_func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">def</span> <span class="token function">iner_func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> b <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">return</span> iner_func1func<span class="token operator">=</span>out_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>out_func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_varnames<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>out_func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_cellvars<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>out_func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_freevars<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_varnames<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_cellvars<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_freevars<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'iner_func1'</span><span class="token punctuation">,</span> <span class="token string">'iner_func2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code></pre><ol><li>前三个输出是关于外部函数的一些属性，由于out_func函数中声明了几个局部变量，因此包含三个变量。第二个输出是内部的函数用到的变量，而iner_func1与iner_func2用到了变量a与b。第三个输出是使用了的外部作用域的变量，因此是空。</li><li>后三个输出是关于内部函数的一些属性，前两个输出由于iner_func1没有使用到因此为空，由于iner_func1用到了外部变量a，因此只有变量a。</li></ol><h3 id="G-global-全局作用域"><a href="#G-global-全局作用域" class="headerlink" title="G(global)全局作用域"></a>G(global)全局作用域</h3><p>即在模块层次中定义的变量，每一个模块都是一个全局作用域。也就是说，在模块文件顶层声明的变量具有全局作用域，从外部开来，模块的全局变量就是一个模块对象的属性。注意：全局作用域的作用范围仅限于单个模块文件内，此外python与C，Java有许多不同的地方，例子如下</p><pre class=" language-python"><code class="language-python">v<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">def</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    v<span class="token operator">=</span><span class="token number">2</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>example<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token number">2</span><span class="token number">1</span></code></pre><p>当想要在函数中对全局变量进行赋值时，如上操作，python会生成新的局部变量，而不是修改全局变量的值，可以通过global标记在局部作用域中声明全局变量。正确使用如下</p><pre class=" language-python"><code class="language-python">v<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">def</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> v    v<span class="token operator">=</span><span class="token number">2</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>example<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 运行结果如下</span><span class="token number">2</span><span class="token number">2</span></code></pre><h3 id="B-built-in-内置作用域"><a href="#B-built-in-内置作用域" class="headerlink" title="B(built-in)内置作用域"></a>B(built-in)内置作用域</h3><p>系统内固定模块里定义的变量，如预定义在<strong>builtin</strong> 模块内的变量。</p><h3 id="变量名解析LEGB法则"><a href="#变量名解析LEGB法则" class="headerlink" title="变量名解析LEGB法则"></a>变量名解析LEGB法则</h3><p><strong>搜索变量名的优先级：局部作用域 &gt; 嵌套作用域 &gt; 全局作用域 &gt; 内置作用域</strong><br> <strong>LEGB法则</strong>： 当在函数中使用未确定的变量名时，Python会按照优先级依次搜索4个作用域，以此来确定该变量名的意义。首先搜索局部作用域(L)，之后是上一层嵌套结构中def或lambda函数的嵌套作用域(E)，之后是全局作用域(G)，最后是内置作用域(B)。按这个查找原则，在第一处找到的地方停止。如果没有找到，则会出发NameError错误。下面代码标识了各类型变量的声明定义</p><pre class=" language-python"><code class="language-python">globalVar <span class="token operator">=</span> <span class="token number">100</span>           <span class="token comment" spellcheck="true">#G</span><span class="token keyword">def</span> <span class="token function">test_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    enclosingVar <span class="token operator">=</span> <span class="token number">200</span>    <span class="token comment" spellcheck="true">#E</span>    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        localVar <span class="token operator">=</span> <span class="token number">300</span>    <span class="token comment" spellcheck="true">#L</span><span class="token keyword">print</span> __name__            <span class="token comment" spellcheck="true">#B</span></code></pre><p>为了更好理解，下面举个例子</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_scopt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    variable <span class="token operator">=</span> <span class="token number">200</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#这里的变量variable在E中绑定了内存对象200，为函数func()引入了一个新的变量</span>    func<span class="token punctuation">(</span><span class="token punctuation">)</span>variable <span class="token operator">=</span> <span class="token number">100</span>test_scopt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 输出结果如下</span><span class="token number">200</span><span class="token number">200</span><span class="token number">100</span></code></pre><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol><li>python能够产生作用域的代码段是 <em>def<em>、</em>class<em>、</em>lambda</em>.</li><li>python能够不能产生作用域的代码段是 <em>if-elif-else<em>、</em>for/while<em>、</em>try/except/finally</em></li></ol><p>例子1：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">if</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    variable <span class="token operator">=</span> <span class="token number">100</span>    <span class="token keyword">print</span> <span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"******"</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 输出结果如下</span><span class="token number">100</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token number">100</span></code></pre><p>例子2</p><pre class=" language-python"><code class="language-python"><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    newvar<span class="token operator">=</span><span class="token number">8</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>newvar<span class="token punctuation">)</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">print</span><span class="token punctuation">(</span>newvar<span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    newlocal<span class="token operator">=</span><span class="token number">7</span>    <span class="token keyword">raise</span> Exception<span class="token keyword">except</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>newlocal<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#可以直接使用哦</span><span class="token comment" spellcheck="true"># 输出结果如下</span><span class="token number">8</span><span class="token number">8</span><span class="token number">7</span></code></pre><p>Python在变量作用域上与C和Java有比较大的区别，在使用时一定要区分好，牢记LEGB法则法则</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python安装及环境搭建</title>
      <link href="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/"/>
      <url>/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/</url>
      
        <content type="html"><![CDATA[<p>Python就不多介绍了，本文记录的windows10系统下python环境的安装搭建，话不多说，开始吧</p><h2 id="下载Python"><a href="#下载Python" class="headerlink" title="下载Python"></a>下载Python</h2><p>1.进入<a href="www.python.org">python官网</a>，选择downloads，然后选择windows</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/1.png" alt></p><p>2.到这里可以看到Python2和Python3各提供了两个稳定版本可供下载，我们选择最新的python3下载，建议后面有<em>executable installer</em> ，意思是可执行安装包，和一般的软件安装没什么区别</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/2.png" alt></p><h2 id="安装Python"><a href="#安装Python" class="headerlink" title="安装Python"></a>安装Python</h2><p>1.双击刚刚下载好的安装包，如果出现如下界面直接点运行</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/3.png" alt></p><p>2.装的时候记得勾选 PATH 。install now是默认安装  customize installation是自定义安装 （新手我推荐默认安装这样不容易出问题 ，但是默认安装路径默认在C盘，所以我选择自定义安装）</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/4.png" alt></p><p>3.点击自定义安装后，来到如下界面，全部默认点击Next</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/6.png" alt></p><p>4.到这里上面勾选全部默认，在安装路径上选择自己想要安装的文件夹路径，然后点击install，等待安装完成</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/7.png" alt></p><p>5.打开cmd终端，输入python回车出现python的版本信息，则说明安装成功。如果没有出现任何内容，则可能是第一步安装的时候没有勾选path，这时需要配置一下环境变量。配置方法和java配置jdk类似</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/8.png" alt></p><h2 id="配置pip"><a href="#配置pip" class="headerlink" title="配置pip"></a>配置pip</h2><p>1.pip是python的第三方库安装工具，它随python一起安装好了，但需要配置一下环境变量。打开python的安装目录，找到srcipt文件夹，把这个文件夹路径配置到path中，如果环境变量中已经存在忽略此步骤</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/9.png" alt></p><p>2.在cmd中输入pip出现如下信息说明pip已配置成功</p><p><img src="/2020/03/26/python-an-zhuang-ji-huan-jing-da-jian/10.png" alt></p><p>3.在我们需要下载python的第三方库时，可通过下面几个命令执行第三方库的安装和卸载</p><pre class=" language-spreadsheet"><code class="language-spreadsheet">//以pyinstaller为例// 安装最新版本pip install pyinstaller// 安装指定版本pip install pyinstaller == 3.3// 指定源安装pip install -i https://pypi.douban.com/simple/ pyinstaller// 卸载pip uninstall pyinstaller</code></pre><p>国内可用的pip源</p><table><thead><tr><th>所属机构</th><th>地址</th></tr></thead><tbody><tr><td>豆瓣</td><td><a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a></td></tr><tr><td>清华大学</td><td><a href="https://pypi.tuna.tsinghua.edu.cn/simple/" target="_blank" rel="noopener">https://pypi.tuna.tsinghua.edu.cn/simple/</a></td></tr><tr><td>阿里云</td><td><a href="http://mirrors.aliyun.com/pypi/simple/" target="_blank" rel="noopener">http://mirrors.aliyun.com/pypi/simple/</a></td></tr><tr><td>华中理工大学</td><td><a href="http://pypi.hustunique.com/" target="_blank" rel="noopener">http://pypi.hustunique.com/</a></td></tr><tr><td>山东理工大学</td><td><a href="http://pypi.sdutlinux.org/" target="_blank" rel="noopener">http://pypi.sdutlinux.org/</a></td></tr><tr><td>中国科学技术大学</td><td><a href="http://pypi.mirrors.ustc.edu.cn/simple/" target="_blank" rel="noopener">http://pypi.mirrors.ustc.edu.cn/simple/</a></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见算法思想总结</title>
      <link href="/2020/03/22/chang-jian-suan-fa-si-xiang-zong-jie/"/>
      <url>/2020/03/22/chang-jian-suan-fa-si-xiang-zong-jie/</url>
      
        <content type="html"><![CDATA[<p>做开发的对于算法这个词都不陌生，每当谈论到某人是个算法工程师，某人写了个什么厉害的算法。都会不由得对他产生敬意，有人说，程序=数据结构+算法。虽然有失偏颇，但足以体现出算法的重要性。那什么是算法呢，它可以是一个公式，一个食谱，一本操作手册，其实在没有电脑之前，就已经有算法了，算法是解决特定问题的方法步骤的描述。在计算机中表现为指令的有限序列，并且每条指令表示一个或多个操作。算法思想有很多，业界公认的常用算法思想有八种，分别是枚举、递推、递归、分治、贪心、试探法、动态迭代和模拟。当然八种只是一个大概的划分，是一个“仁者见仁、智者见智”的问题。最近在力扣上看到不少精妙的解题思路，不禁想对算法常见的解题思路做一个总结。故有此文</p><p><img src="/2020/03/22/chang-jian-suan-fa-si-xiang-zong-jie/1.jpg" alt></p><h2 id="算法的基本特征"><a href="#算法的基本特征" class="headerlink" title="算法的基本特征"></a>算法的基本特征</h2><p>算法是计算机处理信息的本质，因为计算机程序本质上是一个算法来告诉计算机确切的步骤来执行一个指定的任务。一般地，当算法在处理信息时，会从输入设备或数据的存储地址读取数据，把结果写入输出设备或某个存储地址供以后再调用。对于算法而言，实现的语言并不重要，重要的是思想。一个正确的算法具备以下五个基本特征</p><ol><li><strong>输入</strong>: 算法具有0个或多个输入</li><li><strong>输出</strong>: 算法至少有1个或多个输出</li><li><strong>有穷性</strong>: 算法在有限的步骤之后会自动结束而不会无限循环，并且每一个步骤可以在可接受的时间内完成</li><li><strong>确定性</strong>：算法中的每一步都有确定的含义，不会出现二义性</li><li><strong>可行性</strong>：算法的每一步都是可行的，也就是说每一步都能够执行有限的次数完成</li></ol><h2 id="1-枚举思想"><a href="#1-枚举思想" class="headerlink" title="1.枚举思想"></a>1.枚举思想</h2><h3 id="基本思想"><a href="#基本思想" class="headerlink" title="基本思想"></a>基本思想</h3><p>枚举算法思想的最大特点是，在面对任何问题时它会去尝试每一种解决方法。在进行归纳推理时，如果逐个考察了某类事件的所有可能情况，因而得出一般结论，那么这个结论是可靠的，这种归纳方法叫作枚举法。</p><h3 id="方法特征"><a href="#方法特征" class="headerlink" title="方法特征"></a>方法特征</h3><ul><li>确定枚举对象、枚举范围和判定条件。</li><li>逐一列举可能的解，验证每个解是否是问题的解。</li></ul><h3 id="基本步骤"><a href="#基本步骤" class="headerlink" title="基本步骤"></a>基本步骤</h3><ol><li>确定枚举对象（即问题解的表达形式，一般需要用若干参数来描述）</li><li>逐一列举可能（根据枚举对象的参数构造循环，一一列举其表达式的每一种取值情况）</li><li>逐一验证可能解<strong>（</strong> 根据问题解的要求，验证枚举对象表达式的每一个取值，如果满足条件，则采纳它，否则抛弃之。）</li></ol><h3 id="经典例子"><a href="#经典例子" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>百钱买百鸡问题</strong>：有一个人有一百块钱，打算买一百只鸡。到市场一看，公鸡一只3元,母鸡一只5元,小鸡3只1元,试求用100元买100只鸡,各为多少才合适</li><li><strong>水仙花数问题</strong>：输出所有的“水仙花数”，所谓的“水仙花数”是指一个三位数其各位数字的立方和等于该数本身，例如153是“水仙花数”，因为：153 = 1^3 + 5^3 + 3^3。</li><li><strong>鸡兔同笼问题</strong>：今有鸡兔同笼，上有三十五头，下有九十四足。问鸡兔各几只？</li></ul><h2 id="2-递推思想"><a href="#2-递推思想" class="headerlink" title="2.递推思想"></a>2.递推思想</h2><h3 id="基本思想-1"><a href="#基本思想-1" class="headerlink" title="基本思想"></a>基本思想</h3><p>所谓递推，是指从已知的初始条件出发，依据某种递推关系，逐次推出所要求的各中间结果及最后结果。其中初始条件或是问题本身已经给定，或是通过对问题的分析与化简后确定。</p><h3 id="思想特征"><a href="#思想特征" class="headerlink" title="思想特征"></a>思想特征</h3><p>递推算法可以不断利用已有的信息推导出新的东西，在日常应用中有如下两种递推 算法。</p><ol><li>顺推法：从已知条件出发，逐步推算出要解决问题的方法。例如斐波那契数列就可以通过顺推法不断递推算出新的数据。</li><li>逆推法：从已知的结果出发，用迭代表达式逐步推算出问题开始的条件，即顺推法的逆过程。</li></ol><h2 id="3-递归思想"><a href="#3-递归思想" class="headerlink" title="3.递归思想"></a>3.递归思想</h2><h3 id="思维策略"><a href="#思维策略" class="headerlink" title="思维策略"></a>思维策略</h3><p>在计算机编程应用中，递归算法对解决大多数问题是十分有效的，它能够使算法的描述变得简洁而且易于理解递归算法实际上是把问题转化为规模缩小了的同类问题的子问题，然后再递归调用函数或过程来表示问题的解。递归过程一般通过函数或子过程来实现。递归算法在函数或子过程的内部，直接或者间接地调用自己的算法。</p><h3 id="方法特征-1"><a href="#方法特征-1" class="headerlink" title="方法特征"></a>方法特征</h3><ol><li>递归是在过程或函数中调用自身的过程。</li><li>在使用递归策略时，必须有一个明确的递归结束条件，这称为递归出口。</li><li>递归算法通常显得很简洁，但是运行效率较低，所以一般不提倡用递归算法设计程序。</li><li>在递归调用过程中，系统用栈来存储每一层的返回点和局部量。如果递归次数过多，则容易造成栈溢出，所以一般不提倡用递归算法设计程序。</li></ol><h3 id="经典例子-1"><a href="#经典例子-1" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>斐波那契数列</strong>：斐波那契数列的排列是：0，1，1，2，3，5，8，13，21，34，55，89，144……依次类推下去，你会发现，它后一个数等于前面两个数的和。在这个数列中的数字，就被称为斐波那契数。数列规律是下一个数等于前两个数的和（递归）</li><li><strong>汉诺塔</strong>：超经典了的递归解决问题例子，法国数学家爱德华·卢卡斯曾编写过一个印度的古老传说：在世界中心贝拿勒斯（在印度北部）的圣庙里，一块黄铜板上插着三根宝石针。印度教的主神梵天在创造世界的时候，在其中一根针上从下到上地穿好了由大到小的64片金片，这就是所谓的汉诺塔。不论白天黑夜，总有一个僧侣在按照下面的法则移动这些金片：一次只移动一片，不管在哪根针上，小片必须在大片上面。僧侣们预言，当所有的金片都从梵天穿好的那根针上移到另外一根针上时，世界就将在一声霹雳中消灭，而梵塔、庙宇和众生也都将同归于尽。</li></ul><h2 id="4-分治思想"><a href="#4-分治思想" class="headerlink" title="4.分治思想"></a>4.分治思想</h2><p>将一个难以直接解决的大问题，分割成一些规模较小的相同问题，以便各个击破，分而治之。</p><h3 id="基本思想-2"><a href="#基本思想-2" class="headerlink" title="基本思想"></a>基本思想</h3><p>“分而治之”，大问题能够拆成相似的小问题，记住这些小问题需要具有相似性。而后将小问题的每个解合成为大问题的解。所以说<strong>大问题如何拆，小问题如何合并才是这个算法最主要的一个思想</strong>。实际上很多算法如贪心算法，动态规划等等都是要求把大问题拆成小问题。而分治算法的重要一点就是要适用于能够重新把小问题的解合并为大问题的解。</p><h3 id="方法特征-2"><a href="#方法特征-2" class="headerlink" title="方法特征"></a>方法特征</h3><ol><li>该问题的规模缩小到一定的程度就可以容易地解决</li><li>该问题可以分解为若干个规模较小的相同问题，即该问题具有最优子结构性质。</li><li>利用该问题分解出的子问题的解可以合并为该问题的解；</li><li>该问题所分解出的各个子问题是相互独立的，即子问题之间不包含公共的子子问题。</li></ol><p>第一条特征是绝大多数问题都可以满足的，因为问题的计算复杂性一般是随着问题规模的增加而增加；第二条特征是应用分治法的前提它也是大多数问题可以满足的，此特征反映了递归思想的应用；、第三条特征是关键，能否利用分治法完全取决于问题是否具有第三条特征，如果具备了第一条和第二条特征，而不具备第三条特征，则可以考虑用贪心法或动态规划法。第四条特征涉及到分治法的效率，如果各子问题是不独立的则分治法要做许多不必要的工作，重复地解公共的子问题，此时虽然可用分治法，但一般用动态规划法较好。</p><h3 id="基本步骤-1"><a href="#基本步骤-1" class="headerlink" title="基本步骤"></a>基本步骤</h3><ol><li>分解：将原问题分解为若干个规模较小，相互独立，与原问题形式相同的子问题；</li><li>解决：若子问题规模较小而容易被解决则直接解，否则递归地解各个子问题</li><li>合并：将各个子问题的解合并为原问题的解。</li></ol><h3 id="经典例子-2"><a href="#经典例子-2" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>快速排序</strong>：这个就不用多说了吧。。</li><li><strong>Strassen矩阵乘法</strong> ：矩阵乘法，一般代码实现需要做三次循环，其时间复杂度就是O(n^3)。strassen提出的Strassen矩阵乘法，最终把复杂度降低为O( n^lg7 ) ≈ O( n^2.81 )；别小看这个细微的改进，当n非常大时，该算法将比平凡算法节约大量时间。这个算法种就使用到分治思想</li><li><strong>棋盘覆盖问题</strong></li><li><strong>线性时间选择问题</strong></li><li><strong>循环赛日程表</strong></li></ul><h2 id="5-动态规划"><a href="#5-动态规划" class="headerlink" title="5.动态规划"></a>5.动态规划</h2><p>每次决策依赖于当前状态，又随即引起状态的转移。一个决策序列就是在变化的状态中产生出来的，所以，这种多阶段最优化决策解决问题的过程就称为动态规划。</p><h3 id="基本思想-3"><a href="#基本思想-3" class="headerlink" title="基本思想"></a>基本思想</h3><p>将待求解的问题分解为若干个子问题（阶段），按顺序求解子阶段，前一子问题的解，为后一子问题的求解提供了有用的信息。在求解任一子问题时，列出各种可能的局部解，通过决策保留那些有可能达到最优的局部解，丢弃其他局部解。依次解决各子问题，最后一个子问题就是初始问题的解。</p><h3 id="方法特征-3"><a href="#方法特征-3" class="headerlink" title="方法特征"></a>方法特征</h3><ol><li>最优化原理：如果问题的最优解所包含的子问题的解也是最优的，就称该问题具有最优子结构，即满足最优化原理。</li><li>无后效性：即某阶段状态一旦确定，就不受这个状态以后决策的影响。也就是说，某状态以后的过程不会影响以前的状态，只与当前状态有关。</li><li>有重叠子问题：即子问题之间是不独立的，一个子问题在下一阶段决策中可能被多次使用到。（该性质并不是动态规划适用的必要条件，但是如果没有这条性质，动态规划算法同其他算法相比就不具备优势）</li></ol><h3 id="基本步骤："><a href="#基本步骤：" class="headerlink" title="基本步骤："></a>基本步骤：</h3><p>分析最优解的性质，并刻画其结构特征。<br>递归的定义最优解。<br>以自底向上或自顶向下的记忆化方式（备忘录法）计算出最优值<br>根据计算最优值时得到的信息，构造问题的最优解</p><h3 id="经典例子-3"><a href="#经典例子-3" class="headerlink" title="经典例子"></a>经典例子</h3><ol><li><strong>剪绳子问题</strong> ：给你一根长度为N的绳子，请把绳子剪成M段（m,n都是整数），每段绳子的 长度记为k[0],k[1],k[2]….请问如何剪绳子使得k[0],k[1],k[2] 的乘积最大 。例如 绳子长度8 最大乘积18 = 2<em>3</em>3</li><li><strong>硬币问题</strong> ：我们有面值为1元3元5元的硬币若干枚，如何用最少的硬币凑够11元？</li><li><strong>最长公共子串（Longest Common Substring）</strong>与<strong>最长公共子序列（Longest Common Subsequence）</strong>问题： 给定两个序列（两个字符串），求出它们的最长公共子序列（公共子字符串）。注意：<strong>子串要求在原字符串中是连续的</strong>，而<strong>子序列则只需保持相对顺序一致，并不要求连续</strong>。例如X = {a, Q, 1, 1}; Y = {a, 1, 1, d, f}那么，{a, 1, 1}是X和Y的最长公共子序列，但不是它们的最长公共字串。而 S1 = ABCD，S2=AEBD，那么S1与S2的最长公共子序列是{ABD}。</li></ol><h2 id="6-贪心法"><a href="#6-贪心法" class="headerlink" title="6.贪心法"></a>6.贪心法</h2><p>在对问题求解时，总是做出在当前看来是最好的选择。也就是说，不从整体最优上加以考虑，他所做出的仅是在某种意义上的局部最优解。</p><h3 id="基本思想-4"><a href="#基本思想-4" class="headerlink" title="基本思想"></a>基本思想</h3><p>贪心算法没有固定的算法框架，算法设计的关键是贪心策略的选择。必须注意的是，贪心算法不是对所有问题都能得到整体最优解，选择的贪心策略必须具备无后效性，即某个状态以后的过程不会影响以前的状态，只与当前状态有关。所以对所采用的贪心策略一定要仔细分析其是否满足无后效性。</p><h3 id="基本步骤：-1"><a href="#基本步骤：-1" class="headerlink" title="基本步骤："></a>基本步骤：</h3><ol><li>建立数学模型来描述问题。</li><li>把求解的问题分成若干个子问题。</li><li>对每一子问题求解，得到子问题的局部最优解。</li><li>把子问题的解局部最优解合成原来解问题的一个解。</li></ol><h3 id="经典例子-4"><a href="#经典例子-4" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>钱币找零问题</strong>：假设1元、2元、5元、10元、20元、50元、100元的纸币，张数不限制，现在要用来支付K元，至少要多少张纸币？</li><li><strong>股票问题</strong>：假设你有一个数组，其中第i个元素是某只股票在第i天的价格。如你最多只获准完成一项交易(即，买一股，卖一股)，设计一个算法来寻找最大的利润。注意，你不能在买股票之前卖掉它。</li><li><strong>小船过河问题</strong></li><li><strong>区间覆盖问题</strong></li><li><strong>Huffman编码</strong></li><li><strong>Dijkstra算法（求解最短路径）</strong></li><li><strong>最小生成树算法</strong></li></ul><h2 id="7-回溯法"><a href="#7-回溯法" class="headerlink" title="7.回溯法"></a>7.回溯法</h2><p>回溯算法实际上一个类似枚举的搜索尝试过程，主要是在搜索尝试过程中寻找问题的解，当发现已不满足求解条件时，就“回溯”返回，尝试别的路径。回溯法是一种选优搜索法，按选优条件向前搜索，以达到目标。但当探索到某一步时，发现原先选择并不优或达不到目标，就退回一步重新选择，这种走不通就退回再走的技术为回溯法，而满足回溯条件的某个状态的点称为“回溯点”。许多复杂的，规模较大的问题都可以使用回溯法，有“通用解题方法”的美称。</p><h3 id="基本思想-5"><a href="#基本思想-5" class="headerlink" title="基本思想"></a>基本思想</h3><p>在包含问题的所有解的解空间树中，按照深度优先搜索的策略，从根结点出发深度探索解空间树。当探索到某一结点时，要先判断该结点是否包含问题的解，如果包含，就从该结点出发继续探索下去，如果该结点不包含问题的解，则逐层向其祖先结点回溯。（其实回溯法就是对隐式图的深度优先搜索算法）。若用回溯法求问题的所有解时，要回溯到根，且根结点的所有可行的子树都要已被搜索遍才结束。对于回溯法所用到的核心思想就是递归法。回溯法也是经典的人工智能的基础，这句话中”经典”可以理解为”传统”。现如今，人工智能领域有一个非常流行的话题，那就是机器学习。</p><h3 id="方法特征-4"><a href="#方法特征-4" class="headerlink" title="方法特征"></a>方法特征</h3><ol><li>针对所给问题，确定问题的解空间：首先应明确定义问题的解空间，问题的解空间应至少包含问题的一个（最优）解。</li><li>确定结点的扩展搜索规则</li><li>以深度优先方式搜索解空间，并在搜索过程中用剪枝函数避免无效搜索。</li></ol><h3 id="经典例子-5"><a href="#经典例子-5" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><p><strong>八皇后问题</strong>：该问题是国际西洋棋棋手马克斯·贝瑟尔于1848年提出：在8×8格的国际象棋上摆放八个皇后，使其不能互相攻击，即任意两个皇后都不能处于同一行、同一列或同一斜线上，问有多少种摆法。</p></li><li><p><strong>迷宫问题</strong>：定义一个二维数组如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> maze<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>它表示一个迷宫，其中的1表示墙壁，0表示可以走的路，只能横着走或竖着走，不能斜着走，要求编程序找出从左上角到右下角的最短路线。</p></li><li><p><strong>图的着色问题</strong>：又称着色问题，是最著名的NP-完全问题之一。其数学定义为：给定一个无向图G=（V, E），其中V为顶点集合，E为边集合，图着色问题即为将V分为K个颜色组，每个组形成一个独立集，即其中没有相邻的顶点。其优化版本是希望获得最小的K值。</p></li><li><p><strong>连续邮资问题</strong>：假设国家发行了n种不同面值的邮票，并且规定每张信封上最多只允许贴m张邮票。连续邮资问题要求对于给定的n和m的值，给出邮票面值的最佳设计，在一张信封上可以贴出从邮资1开始，增量为1的最大连续邮资区间。</p></li><li><p><strong>符号三角形问题</strong>：由14个“+”号和14个“-”号组成的符号三角形。2个相邻同号下面是“+”号，2个相邻异号下面是“-”号。</p><pre><code>　　+　　 +　　 _　　 +　　 _　　 +　　 +　　    +　　_　 　_　 　_ 　　_ 　　+　　　　   _ 　　+　　+　　+　　_　　　　　　  _ 　　+ 　　+ 　_　　　　　　　　 _ 　　+ 　_　　　　　　　　　　_ 　_　　　　　　　　　　  +</code></pre><p>在一般情况下，符号三角形第一行有N个符号，该问题要求对于给定n计算有多少种不同的符号三角形。使其所含的+  — 个数相同。</p></li></ul><h3 id="递归回溯算法模板"><a href="#递归回溯算法模板" class="headerlink" title="递归回溯算法模板"></a>递归回溯算法模板</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">backtrack</span><span class="token punctuation">(</span><span class="token keyword">int</span> t<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">//t表示递归深度，即当前扩展节点在解空间树的深度</span><span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span> t <span class="token operator">></span> n <span class="token punctuation">)</span> <span class="token function">output</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//n控制递归深度，如果算法已经搜索到叶节点，记录输出可行解X</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>t<span class="token punctuation">)</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token function">g</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>t<span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//在深度t，i从未搜索过得起始编号到终止编号</span>        <span class="token punctuation">{</span>            x<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//查看i这个点的值是否满足题目的要求</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">constraint</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">bound</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token function">backtrack</span><span class="token punctuation">(</span>t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">//constraint（t）为true表示在当前扩展节点处x[1:t]的取值满足问题的约束条件；</span>       <span class="token comment" spellcheck="true">//bound(t)为true表示当前扩展节点取值没有使目标函数越界；</span>       <span class="token comment" spellcheck="true">//为true表示还需要进一步的搜索子树，否则减去子树。</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="8-概率算法思想"><a href="#8-概率算法思想" class="headerlink" title="8.概率算法思想"></a>8.概率算法思想</h2><p>概率算法依照概率统计的思路来求解问题，往往不能得到问题的精确解，但却在数值计算领域得到了广泛的应用。因为很多数学问题，往往没有或者很难计算解析解，这时便需要通过数值计算来求解近似值。</p><h3 id="基本思想-6"><a href="#基本思想-6" class="headerlink" title="基本思想"></a>基本思想</h3><p>通过概率统计来求解问题，但是不能求解精准答案，概率算法大致分为如下4中形式：</p><ul><li>数值概率算法；</li><li>蒙特卡洛(Monte Carlo)算法；</li><li>拉斯维加斯(Las Vegas)算法；</li><li>舍伍德(Sherwood)算法；</li></ul><p>简而言之，与确定性算法相比，<strong>若冒险，可能做得更好！</strong>这就是概率算法的魅力</p><h3 id="基本步骤-2"><a href="#基本步骤-2" class="headerlink" title="基本步骤"></a>基本步骤</h3><ol><li>将问题转化为相应的几何图形S，S的面积是容易计算的，问题的结果往往对应几何图形中某一部分S1的面积</li><li>然后，向几何图形中随机撒点.</li><li>统计几何图形中S中和S1中的点数，根据S的面积和S1面积的关系以及各图形中的点数来计算得到结果.</li><li>判断上述结果是否在需要的精度之内，如果未达到精度则进行执行步骤2.如果达到精度，则输出近似结果.</li></ol><h3 id="经典例子-6"><a href="#经典例子-6" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>蒙特卡罗计算圆周率</strong></li></ul><h2 id="9-双指针思想"><a href="#9-双指针思想" class="headerlink" title="9.双指针思想"></a>9.双指针思想</h2><p>一般暴力的做法的复杂度往往达到O(n^2）复杂度，双指针算法是运用题目内部的具体逻辑将上述算法的复杂度降到O(n)，是一种常用的有效的降低算法复杂度的算法思想</p><h3 id="基本思想-7"><a href="#基本思想-7" class="headerlink" title="基本思想"></a>基本思想</h3><p>双指针其实是利用数组（或者求解问题）的有序特性，在遍历的过程中使用两个相同方向或者相反方向的指针进行扫描，从而达到目的的一种算法。（注：这里的指针并非专指c语言中的指针，表达的含义是下标、索引值或者是可进行迭代的对象等）</p><h3 id="算法模板"><a href="#算法模板" class="headerlink" title="算法模板"></a>算法模板</h3><p>我们常见的一般的二重循环如下：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>而双指针算法可以将上面的二重循环优化成这样（模板不唯一）：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;</span> i <span class="token operator">&amp;&amp;</span> <span class="token function">check</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        j<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>虽然看上去仍然是循环套循环，但是实际上是一个O(n)的时间复杂度。因为<strong>每一个指针在所有循环里面总共移动的次数是不超过n的，那么两个指针总共移动的次数不超过2n次。</strong></p><h3 id="双指针算法的分类"><a href="#双指针算法的分类" class="headerlink" title="双指针算法的分类"></a>双指针算法的分类</h3><p>基于不同双指针算法的适用情况，我将其分为3类：</p><ul><li><strong>快慢双指针</strong>。用于解决链表问题，两指针一快一慢从链表头节点head扫描至链表末节点（从数据结构上也很容易理解，因为链表结构只能顺藤摸瓜，只能从头扫到尾，木有其他扫描方式）</li><li><strong>首尾双指针，特点是【夹逼】</strong>。用于解决顺序表问题，两个指针一个指头、一个指尾，向中间夹逼，两指针相遇时结束，此时刚好扫描整个顺序表一次</li><li><strong>蠕动双指针。也就是滑动窗口，特点是【一伸一缩】</strong>。用于解决顺序表问题，两个指针都从顺序表头部出发，一个指针做蠕虫头，另一指针做蠕虫尾，一伸一缩蠕动前进，直到蠕虫抵达顺序表末尾。我们都知道蚯蚓，蚯蚓怎么蠕动的呢？当蚯蚓前进时，身体后部的刚毛钉入土里，使后部不能移动，这时身体就向前伸长；接着身体前部的刚毛钉入土里，使前部不能移动，这时向前缩短。就这样，蚯蚓一伸一缩完成向前移动。那么我们想象一条蚯蚓爬过一个顺序表（如一个数组），这就是蠕动双指针的工作模式</li></ul><h3 id="经典例子-7"><a href="#经典例子-7" class="headerlink" title="经典例子"></a>经典例子</h3><ul><li><strong>有序数组的两数和</strong>：在有序数组中找出两个数，使它们的和为 target。</li><li><strong>回文字符串</strong>：可以删除一个字符，判断是否能构成回文字符串。</li><li><strong>判断链表是否存在环</strong>：使用双指针，一个指针每次移动一个节点，一个指针每次移动两个节点，如果存在环，那么这两个指针一定会相遇。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>那个被叫做太阳的公司</title>
      <link href="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/"/>
      <url>/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/</url>
      
        <content type="html"><![CDATA[<p>近一百多年来，在IT信息产业的发展过程中，特别在20世纪八九年代是IT科技史上群星闪耀的时代。在这个大时代里，很多公司原本有可能成为信息产业的王者与弄潮儿，但最终却与之失之交臂，这些公司无论其曾经多么的辉煌，当它们开始走下坡路时，被人遗忘的速度远远超过它衰落的速度。   今天，我们不妨回过头来看一看这些失落或者已经消失的争霸者，毕竟他们曾经在信息产业呼风唤雨过。 Sun公司作为世界上顶天立地级的技术巨头之一，已经成立了将近三十年，随着不久前甲骨文（Oracle）的对其收购，Sun很可能会逐渐淡出人们的视野。也许很多人还不知道sun公司，但一定使用JDK中sun公司的Jar包。美林公司的分析师史蒂文曾说过一句话：“如果你想知道计算机行业的发展趋势，去问Sun公司”。Sun公司作为Java语言的缔造者，一家曾经可以与微软匹敌的公司，对于IT信息产业的贡献无疑应当名垂青史。Java在最近20年间只有2014年被C语言短暂超过位居第二，其余19年均为第一名， Java语言适用范围之广，受欢迎程度之高由此可见。可实际上Sun公司是一家重硬轻软的公司，硬件才是Sun公司的主流产品，而软件则是为硬件服务的。</p><h2 id="传奇的开始"><a href="#传奇的开始" class="headerlink" title="传奇的开始"></a>传奇的开始</h2><p>  Sun，对于这家公司很多人将其理解成“太阳”，其实不然，它是斯坦福大学网络部（Stanford University Network）的缩写，源自斯坦福大学电子工程和计算机科学系的博士生Andy Bechtolsheim（下图右二）的设想，和他一起创业的还有MBA以及电子工程师Vinod Khosla（左一）、后来加入的Scot McNealy（右一），而Sun Microsystems作为一个公司，则是由开发过UnixBSD的Bill Joy（左二）在1982年一月以第一任CEO的身份成立</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/2.jpg" alt="创始人(从左至右)Vinod Khosla、Bill Joey、Andy Bechtolsheim、Scot McNealy"></p><p>本无太阳之意，却真正成了计算机界的太阳系中心。Sun最早靠卖工作站、服务器起家。当时市场都在使用Wintel，即微软与英特尔合作的微处理器芯片，统治着整个PC王国。Sun公司成立以后就推出了第一款产品：工作站 Sun-1。 第一代Sun工作站产品极具魅力，它基于摩托罗拉68000CPU，有着1MB的内存和百万像素级的显示器。那个年代市场上常见的计算机主要是大型机和小型机，大型机以IBM为主，小型机以DEC和惠普为主，而Sun公司出产的工作站Sun-1比小型机还要小，运算能力和小型机差距不大，价格更便宜。与小型机相比，Sun-1 竞争优势非常明显，一经推出就十分火爆，公司成立当年就盈利了。 </p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/3.jpg" alt="Sun-1工作站"></p><p>Sun陆续开发了Solaris操作系统和SPARC 指令集的处理器，实现了“软硬通吃”。摆脱了巨头在芯片与系统上的控制，Sun真正拥有了掌控自己命运的能力。 成立以来Sun始终保持着高速的发展，1986年，成立刚满四年的 Sun 公司便成功在纳斯达克挂牌上市了。</p><h3 id="SPARC——RISC架构商用成功的标志（1989）"><a href="#SPARC——RISC架构商用成功的标志（1989）" class="headerlink" title="SPARC——RISC架构商用成功的标志（1989）"></a>SPARC——RISC架构商用成功的标志（1989）</h3><p>  RISC（精简指令集计算）架构源自伯克利分校80年代的研究，Sparc最终成为商用工作站CPU的标志。Sun对Sparc的第一个设计应用在1986年发布，但到1989年才出现Sparc CPU的工作站。Sparc是一个开源的设计，其他公司基于Sparc开发出了其他产品，如富士通和LSI</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/4.jpg" alt></p><h3 id="Solaris的光芒（1991）"><a href="#Solaris的光芒（1991）" class="headerlink" title="Solaris的光芒（1991）"></a>Solaris的光芒（1991）</h3><p>  Sun对Solaris的描述是：“工业界第一套完善封装的分布式计算环境”，作为一个和AT&amp;T的合作项目，Solaris将当时流行的三大Unix发行版（BSD, System V, Xenix）合为一体。原本Solaris的开发是要在x86和SPARC两大架构上运行，但后来Solaris只在Sun系统上出现。今天Solaris成为了开源操作系统之一</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/5.jpg" alt></p><h2 id="反叛的Sun公司"><a href="#反叛的Sun公司" class="headerlink" title="反叛的Sun公司"></a>反叛的Sun公司</h2><p>80年代的科技公司，都抗着“版权保护”这块大盾牌，但Sun却发起了自杀式进攻：扔掉“版权保护”的盾牌，开放技术。 从1987年开始，Sun鼓励其他公司克隆它的Sparc处理器和Solaris的Unix版本。 Sun的目的很明确：大量克隆版本可促使以Sun芯片为基础的机器，大范围出现，接着带动软件开发者为Sparc编写程序，反过来又能使机器销量增加。《财富》杂志却认为，太多的克隆版本出现，Sun将先在价格中败下阵来。<strong>无论如何，Sun的行为，无异于自杀。</strong>如果失败，它将一无所有。事实是怎样的呢？制造商们争着销售Sparc技术，使芯片成本大幅降低，性能极大提高；所有市场领域的工作站硬件，都有Sparc技术，这项技术成了行业标准；Solaris疯狂铺向市场，Sun成为了唯一一个能直掐微软7寸的硬件帝国；Solaris是当时市面上最完善的系统，比Windows更适合企业使用。价值百万美元的服务器成为各大网站的能量中心——大多数科技企业，都在使用Sun的服务器。<strong>正是Sun的反叛，推翻知识中的壁垒，推动信息开放，让更多的人更容易接触到信息。</strong>这让Sun不仅获得了巨额利润，也使它赢得了世界，成为那个时代最伟大的公司之一。在回忆这段时光时，CEO麦克尼利说：<em>“我们想用零件拼装成一辆法拉利，我们要么取得难以置信的成功，要么一败涂地。”</em> </p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/6.jpg" alt="CEO斯考特·麦克尼利"></p><h2 id="站上顶峰"><a href="#站上顶峰" class="headerlink" title="站上顶峰"></a>站上顶峰</h2><p>从成立到之后的十多年时间里，Sun的发展可谓是一帆风顺，几乎没遇到过任何阻力和挑战。在开放技术领域上，Sun把这一套路发挥到了登峰造极的地步，尤其是Java。1990年底，詹姆斯·高斯林想要做个项目，CEO麦克尼利知道眼前的这个伙伴，是位极其出色的编程人员，他说：“好吧，说出你的项目，无论是什么，我都会投资。”高斯林开心的挑了几个程序员，离开了Sun的总部，去了一个“神秘”的地方搞研发。耗时5年，得到了Java。可看着Java，就像看着刚出生的小肉球哪吒一样，所有人都摸不着头脑：这玩意很好，可是，怎么赚钱？能有什么前途？就连CEO麦克尼利自己，都半信半疑的给Java定位：<em>“这是一种通用的、无人拥有的语言，每一台计算机都适用，是从穴居部落的墙壁上偷来的。”</em>  但这个构想没有打动任何人。一开始Sun想把它固化进芯片中，来解决电视、电话、闹钟、微波炉的控制和通信问题（对，就是物联网），但没有一家电器公司对此感兴趣。此时刚好互联网兴起，CEO麦克尼利马上意识到这是一个机会，他将Java放到网上，免费任由人们使用。<strong>一个任何平台都能使用的语言，和免费开源的技术，Sun公司这一次，真正撼动了整个计算机行业。</strong>当时所有网络公司都为 Java 配置了专门的开发团队。就连最骄傲的微软，为了打败网景浏览器，也不得不向对手Sun公司低头，请求授权Java的使用。数百万的开发者因Java聚集了起来，Java 就是真金白银，Java 就是自己的未来。CEO麦克尼利也从此将自己称做是”JavaMan”。但在Java15的历程中，除了和微软的一场侵权官司，赢得的16亿美元赔偿外，Sun就几乎就没能从Java身上赚过钱，<strong>撼动计算机时代，并不意味着能从中挣到钱。</strong>但Java为Sun公司吸引了整个计算业的注意力，使它真正像太阳一样，成为了中心。 这也不能责怪Sun，因为即使是甲骨文后来收购了这家企业，也依然没有琢磨出用Java赚钱的方法.倒是用它去起诉了谷歌侵权。如果能获赔，也算是靠Java赚的第一桶金。</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/7.jpg" alt="Java之父詹姆斯·高斯林"></p><p>到了2001年，Sun在全球的员工总数超过五万人，市值超过两千亿美元，销售额达183 亿美元。旗下产品不仅包括小型机、工作站、服务器和芯片，还拥有Solaris操作系统、风靡世界的 Java 编程语言和办公软件等软件产品。Sun覆盖了计算机领域几乎所有硬件和软件，产品体系比微软更全面。</p><h2 id="有趣的灵魂，是一起对付这个世界"><a href="#有趣的灵魂，是一起对付这个世界" class="headerlink" title="有趣的灵魂，是一起对付这个世界"></a>有趣的灵魂，是一起对付这个世界</h2><p>在Sun的黄金时代，市值一度超过2000亿美元，覆盖170个国家，全球拥有五万名员工。当时的苹果公司经营不善曾想买给Sun公司，而且要不是有人从中做梗，恐怕苹果的传奇不会是乔布斯，而是Sun了。事情起因是微软、IBM和英特尔结盟售卖廉价电脑，将苹果的高价电脑逼入了困境，最窘迫时股票仅有每股5美元。 <strong>这是一场最有可能成功的并购：苹果与Sun有几乎重合的文化“极致的创新、拥有多项专利，跳跃性的思维……”。</strong>在Sun准备宣布收购苹果的计划时，突然其中一位苹果的股东竭力反对，Sun最终不得不放弃收购。庆幸苹果最后坚守了自己，但我们也不妨试想一下，假如Sun与苹果合并，凭借Sun极强的研发能力，和天生叛逆的能量，是否会创造出更大的奇迹呢？在Sun公司，每年四月的愚人节恶作剧，几乎成了传统。</p><ul><li>首席技术专家比尔·乔伊，也是创始人之一，有一次发现他最心爱的法拉力，竟被悬挂在Sun总部前的喷水池上。——哈，这是工程师们的恶作剧。</li><li>CEO麦克尼利喜欢打高尔夫，然后当他回到办公室，发现全是沙子、绿草、球洞，还有水坑。——这是工程师们的愚人节礼物。</li></ul><p>麦克尼利有条瑞士山地狗，名字就叫“网络”。他经常会在公司聚会时，把狗狗带到台中央，让它在标与Sun的竞争对手名称的纸板上撒尿。这种显得几分傲慢又无礼的幽默，常常让员工们开怀大笑之后，也向竞争对手发起进攻。麦克尼利曾得意的说：<em>“出色的Unix工程师、出色的芯片设计者、出色的计算机设计师愿为我们工作。”</em> 任何一家有活力的公司，都需要狂人，这些狂人，则需要一位更狂的人，带领他们一起攻城掠地。Sun成为IT史最伟大公司之一，斯科特•麦克尼利（Scott McNealy）是绝对无法绕开的人物。 他是除了甲骨文的拉里·埃里森之外，目前互联网公司任期最长的CEO，也是公认硅谷最好斗、最有热情的人之一。1991 年，在Sun 用十年时间建造工作站，人们认为，他胆敢在服务器上与 DEC、惠普和 IBM 叫板，简直是拿鸡蛋碰石头。然而，麦克尼利击败了巨人。1995 年，当他向全世界宣布 Java 编程语言时，人们又认为，Java虽然好，但无用。现在Java已经成为一种互联网标准。麦克尼利又赢了。麦克尼利有一个理论：</p><p><em>“如果你的战略是没有争议的，你就没有办法赚钱。如果每一个人都认为Sun的做法是对的，那么每个人都会做。如果每个人都在做，你就不可能独树一帜。真正的胜利者，是那些选择了非常有争议的战略，又最终证明自己正确的人。”</em></p><p>就像现在大家常说的一句话：<strong>如果每个人都理解你，你将会多么平庸啊！</strong> </p><h2 id="宿命时刻"><a href="#宿命时刻" class="headerlink" title="宿命时刻"></a>宿命时刻</h2><p>有的企业与其说是先进，倒不如说是先烈。正当Sun如日中天的时候，迎来了它生命中最强的对手：微软。微软早就察觉到了Sun可能带来的威胁，于是做出两项举措：一是发布.NET软件开发平台与Java竞争；二是发布了新一代服务器操作系统Windows NT，Windows NT的图形界面和 Windows 95 相似，但比 Windows 95更注重局域网组网和管理，让个人计算机拥有企业组网功能。Java与.NET开发平台的竞争一直持续到今天还没结束，可谓是难分伯仲，但是Windows NT对Sun的打击可是致命的。当时微型计算机（就是我们现在用的个人电脑）已经慢慢兴起，随着技术的发展和在Windows NT的支持下，高端微型计算机在性能上和工作站相差无几，个人计算机时代即将来临。一直以来，Sun就被人们所戏称为“技术上的王者，商业上的侏儒”。 让我们看一组数据：</p><ul><li>从1986年到2001年，Sun的营收高达平均每年36%；</li><li>营业额从2.1亿美元涨到183亿美元，并且保持连续15年。 </li></ul><p>历史上做到这一点的，只有微软、思科、英特尔。 Sun并不是商业上的侏儒。现在回过头去看，每个人都能总结出一套失败的理论，但在当时，一切都像赌注一样潦草。 做为对手，微软和IBM始终是Sun最可怕的敌人： </p><ol><li>IBM 投入力量在 Linux 的开发，开源代码，性能几乎能匹敌低端的 Sun 工作站；</li><li>微软发布服务器操作系统 Windows NT，个人计算机进入企业组网阶段。 </li><li>个人电脑慢慢地作为服务器使用，大量用户逐步开始退出Sun的市场。 </li></ol><p><strong>但Sun的目标从来不是桌面上摆着电脑这样的小玩意，而是网络的星辰大海。</strong>创立之初Sun就提出“网络就是计算机”的概念。从建立工作站，到关注数据共享，再到后来的全球网络开发，Sun一直在做一件事：未来所有的设备，都将通过网络管理，它们都将连接在Sun的服务器上。现在互联网火爆的云计算 的概念并不是源由Scott McNealy，而是由Sun的第五位雇员John Gage在1984年提出的，Gage是加州大学伯克利分校的一位数学讲师，但是对计算机拥有浓厚兴趣，后来成为Sun的公众形象。他预言了“云计算”的出现，后来Sun的事业腾飞时，“云计算”一直是Sun的工作理念和方向之一。</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/8.jpg" alt></p><p>现在我们理解了云计算、物联网，但在20世纪90年代中期，即使是最出色的专家，也不知道因特网是什么。桀骜不驯的Sun曾在公司网页上写下一段话：当其他人致力于知识产权的保护，试图建立独立王国时，我们则致力于将公司推进网络时代。 Sun从不跟风，它自己就是风本身。</p><h2 id="英雄落幕"><a href="#英雄落幕" class="headerlink" title="英雄落幕"></a>英雄落幕</h2><p>个人计算机搭载 Linux 作为服务器，取代 Sun 工作站的方案越来越成熟，也更价廉物美。虽然拥有强大硬件与软件，Sun 公司的订单却开始不断萎缩。 千禧年互联网泡沫，前期积累的互联网泡沫逐渐破裂，破产、裁员、变卖资产等事件陆续在互联网公司上演。在这种情况下，各公司在计算机上的预算纷纷下调，Sun公司的生意越来越差。再加上个人电脑在性能上已经足以和工作站媲美，但是价格便宜的多。Sun落了个“高不成低不就”，在性能上比不过IBM的大型机，在价格上又比不过个人电脑。一年之内，Sun营业额就比前一年跌掉了三成，Sun猛然从盈利九亿美元到亏损五亿美元，股价从每股 247 美元跌到49美元。</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/9.jpg" alt></p><p>变卖公司多处房产，其中就有今天Facebook总部所在的园区；开源Solaris抢回部分市场占有率；用强劲的IT技术服务带回现金流……此后每天的新闻都是Sun亏损了，又亏损了。裁员、整合…负面新闻不断。 当时账面还有20亿美元现金，CEO麦克尼利一直相信，自己还有机会再造奇迹。可最终奇迹没能再现，Sun公司走上了卖身的道路。最先出手的是IBM，它看上了Sun的软件和Solaris、Java以及MySQL等开发者社区，这可以使IBM拥有对抗微软的能力，扩大在云计算的影响力。 后来IBM担心垄断调查，收回了先前的70亿出价。Sun别无选择，只好转投甲骨文。2009 年，甲骨文（Oracle）宣布以 74 亿美元的价格收购Sun。随着收购的完成，Sun彻底退出了历史的舞台。Sun公司从 1982 年成立到 2000 年达到顶峰用了近二十年的时间，而走下坡路只用了一年，足以令人惋惜。</p><p>Sun失败了，与其说败给微软，不如说败给了时代，个人计算机时代必然要来临，这是时代发展的结果。Sun是一家真正的技术公司，它曾经创造的辉煌没有人能够磨灭，它发明的Java编程语言至今仍伴随着众多IT人员一起成长！</p><h2 id="善待，不过是虚假的愿望"><a href="#善待，不过是虚假的愿望" class="headerlink" title="善待，不过是虚假的愿望"></a>善待，不过是虚假的愿望</h2><p>Sun的CEO麦克尼利与甲骨文的埃里森私交很好，卖给甲骨文，更多的是期望对方可以善待员工，和多年辛苦研发的产品。然而，收购了Sun得到Java的甲骨文，不久后就对谷歌发起了侵权诉讼，同时开始大量裁员。Sun存活了28年，最核心的能力，是解决最棘手的计算机科学各种问题。因此参与项目的工程师们，有做重大决策的权力。 然而，这个权力在甲骨文消失了。</p><p><img src="/2020/03/21/na-ge-bei-jiao-zuo-tai-yang-de-gong-si/10.png" alt="甲骨文CEO埃里森"></p><p>工程师们再也无权做任何决策。甚至是被尊称为java之父的高斯林，都无权在java上做任何决定。“我们的决策权不复存在。”高斯林和一批Sun的工程师黯然离去。没有照料好原来的工程师，对麦克尼利一心托付的产品，埃里森做的更残酷：</p><ul><li>Java EE 交给了一个开源基金会； </li><li>NetBeans被捐献给了 Apache 基金会； </li><li>埃里森同意Solaris 只有开源才能赢得市场，然后把 Solaris 弄死了；</li><li>取消 Sun Cloud ，拆除Solaris 云服务功能，然后现在是云服务的天下；</li><li>放弃了 Sun 的身份管理项目，而 Forgerock 用它撑起了一个价值五亿美金的业务；</li></ul><p>Sun委身甲骨文的所有意图，一 一落空。这一次收购，被称为“开源最大的悲剧”。 有人说，Sun的伟大，在于给我们贡献的太多，自己忘记商业了，最后才被甲骨文收购。 只是，这也许就是<strong>交易的艺术。</strong> 想起诺基亚被微软收购时，CEO约玛·奥利拉说：“我们并没有做错什么，但不知为什么，我们输了。”</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 互联网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>amr文件转mp3格式</title>
      <link href="/2020/03/17/amr-wen-jian-zhuan-mp3-ge-shi/"/>
      <url>/2020/03/17/amr-wen-jian-zhuan-mp3-ge-shi/</url>
      
        <content type="html"><![CDATA[<p>由于公司业务需求，需要做录音播放功能，简单来说就是业务员跟客户的通话记录会落地保存，然后需要用H5实现录音播放，但是录音文件保存的是amr格式，H5的audio标签不支持amr格式，需要把amr格式转mp3格式。于是去查了查相关格式转换的资料，发现前端JS有类似的工具包，但后来想想这格式转换的事情还是给后端做比较合理吧，便在github上搜了半天找到两个Java的转码包，他们都是基于ffmpeg做的封装，兼容了Windos和Linux系统，话不多说，直接开干吧。</p><p><img src="/2020/03/17/amr-wen-jian-zhuan-mp3-ge-shi/1.jpg" alt></p><h2 id="方式一：JAVE包"><a href="#方式一：JAVE包" class="headerlink" title="方式一：JAVE包"></a>方式一：JAVE包</h2><p>jave项目实际上早就有了，它封装了 <a href="http://ffmpeg.org/" target="_blank" rel="noopener">ffmpeg</a> 的命令，让开发者可以<strong>通过 Java 转换文件格式</strong>。不幸的是，这个项目可谓年久失修，存在一些问题，<strong>JAVE 项目的问题：</strong></p><ol><li><strong>项目老旧没再维护</strong>。官网最近版本是2009年发布的，其依赖的ffmpeg早已过时，很多情况下用不了。</li><li><strong>转码一直报异常</strong> EncoderException: Stream mapping</li><li><strong>没有发布maven仓库</strong>，而且 JAVE 本身也不是一个maven项目</li><li><strong>不支持Mac OS</strong></li></ol><p>不过这里介绍的是一位开发者根据网上的资料进行整理和修改，并基于 JAVE 项目的修改和升级。同时将写好的轮子发布到了Maven的中央仓库，<a href="https://github.com/dadiyang/jave" target="_blank" rel="noopener">github项目地址</a>，项目特点如下：</p><ul><li><strong>这是一个maven项目</strong>，而且已发布到中央仓库。</li><li>项目依赖的 ffmpeg 可执行文件<strong>经过验证可以使用</strong>（单元测试中提供了一个简单的检验方法）</li><li>解决了amr转mp3出现的 <strong>EncoderException: Stream mapping</strong></li><li>支持 <strong>Linux/Windows/Mac</strong> 平台</li></ul><p>使用方式也很简单，代码如下</p><h3 id="引入maven依赖"><a href="#引入maven依赖" class="headerlink" title="引入maven依赖"></a>引入maven依赖</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.dadiyang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="调用-AudioUtils-amrToMp3-方法"><a href="#调用-AudioUtils-amrToMp3-方法" class="headerlink" title="调用 AudioUtils.amrToMp3 方法"></a>调用 AudioUtils.amrToMp3 方法</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">amrToMp3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>    File source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"target/test-classes/material/testAudio.amr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    File target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"testAudio.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    AudioUtils<span class="token punctuation">.</span><span class="token function">amrToMp3</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这个jar包本人在windows10上测试过，确实可行。</p><h2 id="方式二：JAVE2包"><a href="#方式二：JAVE2包" class="headerlink" title="方式二：JAVE2包"></a>方式二：JAVE2包</h2><p>这个开源项目也是在github上发现的，同样是基于ffmpeg实现（ffmpeg是C语言实现，不同的OS有所区别），不过看起来像是JAVE的升级版，不知道作者是不是一个人，JAVE2不仅仅支持音频还支持视频转码，可谓更加强大。JAVE2（Java音频视频编码器）库是ffmpeg项目上的Java包装器。开发人员可以利用JAVE2将音频和视频文件从一种格式转换到另一种格式。例如，可以将AVI文件转换为MPEG文件，可以将DivX视频流更改为（类似于youtube的）Flash FLV文件，可以将WAV音频文件转换为MP3或Ogg Vorbis文件，可以分离和转换音频和视频轨迹，可以调整视频大小，更改其大小和比例等。</p><h3 id="环境支持"><a href="#环境支持" class="headerlink" title="环境支持"></a>环境支持</h3><p>JAVE2 需要 <strong>Java 8 or higher</strong>，JAVE2可以支持在哪些OS上格式转码呢</p><table><thead><tr><th>操作系统</th><th>Windows x32,x64</th><th>MacOS x32,x64</th><th>Linux x32,x64</th></tr></thead><tbody><tr><td><strong>是否支持</strong></td><td>是</td><td>是</td><td>是</td></tr></tbody></table><p>在使用上JAVE2做了很多定制化需求，例如在引入时，就可以根据不同OS按需引入</p><h3 id="引入maven依赖-1"><a href="#引入maven依赖-1" class="headerlink" title="引入maven依赖"></a>引入maven依赖</h3><h5 id="全平台依赖引入"><a href="#全平台依赖引入" class="headerlink" title="全平台依赖引入"></a>全平台依赖引入</h5><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ws.schild<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave-all-deps<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>这样引入包括了支持平台的所有二进制文件，一劳永逸。</p><h5 id="单个平台引入"><a href="#单个平台引入" class="headerlink" title="单个平台引入"></a>单个平台引入</h5><p>当我们只想在Linux上运行时，我们可以只引入Linux的二进制文件，从而达到减少依赖的目的。当我们只想引入某一个平台的二进制文件时可以这样做，首先引入核心包，这个是所有平台都必须引入的</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ws.schild<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p><strong>Linux 64位</strong></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ws.schild<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave-nativebin-linux64<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p><strong>Windows 64位</strong></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ws.schild<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave-nativebin-win64<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p><strong>MacOS 64位</strong></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ws.schild<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jave-nativebin-osx64<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="代码使用例子"><a href="#代码使用例子" class="headerlink" title="代码使用例子"></a>代码使用例子</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>                                                          File source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"file path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          File target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>"file path<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">//Audio Attributes                                       </span> AudioAttributes audio <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               audio<span class="token punctuation">.</span><span class="token function">setCodec</span><span class="token punctuation">(</span><span class="token string">"libmp3lame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                audio<span class="token punctuation">.</span><span class="token function">setBitRate</span><span class="token punctuation">(</span><span class="token number">128000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    audio<span class="token punctuation">.</span><span class="token function">setChannels</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        audio<span class="token punctuation">.</span><span class="token function">setSamplingRate</span><span class="token punctuation">(</span><span class="token number">44100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">//Encoding attributes                                       </span> EncodingAttributes attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EncodingAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         attrs<span class="token punctuation">.</span><span class="token function">setFormat</span><span class="token punctuation">(</span><span class="token string">"mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      attrs<span class="token punctuation">.</span><span class="token function">setAudioAttributes</span><span class="token punctuation">(</span>audio<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment" spellcheck="true">//Encode                                                    </span> Encoder encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MultimediaObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                       ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        succeeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                                          <span class="token punctuation">}</span>               </code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Ant-Design-Pro项目</title>
      <link href="/2020/03/15/da-jian-ant-design-pro-xiang-mu/"/>
      <url>/2020/03/15/da-jian-ant-design-pro-xiang-mu/</url>
      
        <content type="html"><![CDATA[<p> 最近公司项目使用了ant design pro，从没接触过react的我只能趁着周末学习熟悉，赶紧上手。（都是泪。。）说到ant design pro，得先了解一下ant design是个什么东西？ant design蚂蚁金服基于react打造的一个服务于企业级产品的UI框架。而ant design pro呢?就是基于<code>Ant Design这个框架</code>搭建的中后台管理控制台的脚手架  。连登陆界面主界面布局都写好了，只需要在里面写业务相关的页面就可以了，节省不少人力。它秉承 Ant Design 的设计价值观，致力于在设计规范和基础组件的基础上，继续向上构建，提炼出典型模板/业务组件/配套设计资源，进一步提升企业级中后台产品设计研发过程中的『用户』和『设计者』的体验。使用antd-pro 之前，开发的同学们最好了解 ES2015+、React、UmiJS、dva、g2 、 antd以及React Router v4的基础知识，这将为你的开发工作提供必要的基础。需要学习的东西挺多，上手门槛比VUE高了一些。这里主要记录本人从零搭建ant design pro的过程，以及常用的语法</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/1.png" alt></p><h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><p>首先，找个地方建个空目录，然后使用 <code>npm create umi</code> 脚手架，创建模板：</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/2.png" alt></p><p>选择第一项：ant-design-pro。然后回车</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/3.png" alt></p><p>为了简单起见，选择JavaScript创建项目，然后一路回车。到下面这个步骤项目就已经初始化好了</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/4.png" alt></p><p>使用webstorm打开刚刚创建的工程，可以看到目录结构如下</p><pre><code>├── config  # umi 配置，包含路由，构建等配置│  ├── config  # 配置文件：包含路由、样式、proxy等│  ├── defaultSettings # 默认设置：包括标题title、navTheme等│  ├── plugin.config # webpack的Plugin配置│  ├── themePluginConfig # 风格主题的配置├── mock  # 本地模拟数据├── public│  └── favicon.png # Favicon├── src│  ├── assets  # 本地静态资源│  ├── components  # 业务通用组件│      ├...│      ├── GlobalHeader  # 基础布局的头部│          ├── AvatarDropdown  # 用户头像下拉菜单│          ├── NoticeIconView  # 通知图标和通知消息视图│          ├── plugin.config # webpack的Plugin配置│          ├── RightContent  # 基础布局的头部核心：包含搜索、头像、语言选择│  ├── e2e # 集成测试用例│  ├── layouts # 通用布局│  ├── models  # 全局 dva model│  ├── pages # 业务页面入口和常用模板│  ├── services  # 后台接口服务│  ├── utils # 工具库│  ├── locales # 国际化资源│  ├── global.less # 全局样式│  └── global.ts # 全局 JS├── tests # 测试工具├── README.md├── package.json└── ... # 其他</code></pre><p>然后进入目录，执行 <code>npm install</code> 下载前端依赖包，在下载依赖过程中可能会失败，显示会是权限问题，其实就是包下载不下来，报错如下</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/6.png" alt></p><p>而一次出错之后，一般人都会再次<code>npm install</code> ，而npm install命令并不会主动清除上次安装的包，而你上次安装的包又不完整，包与包之间又有依赖关系，结果自然再次出错。所以，要想解决这个问题，就应该清除上次安装的包，想要彻底清除则一般需要以下3步，删除node modules中的全部文件。然后执行：<code>npm cache clean --force</code> 命令，npm可执行命令如下</p><pre class=" language-javascript"><code class="language-javascript">npm start # 运行这个脚本会启动服务，自动打开默认浏览器展示你的页面。当你重新编辑代码后，页面还会自动刷新。npm run build # 运行这个脚本将会编译你的项目，你可以在项目中的 dist 目录中找到编译后的文件用于部署。npm run lint # 通过这个脚本来查看你的代码有哪些问题npm test # 这个脚本会执行一系列测试，包括 e2e 测试。npm run i18n<span class="token operator">-</span>remove # 这个脚本将会尝试删除项目中所有的 i18n 代码，对于复杂的运行时代码，表现并不好，慎用。</code></pre><p>执行 npm start，启动成功后可看到主界面</p><p><img src="/2020/03/15/da-jian-ant-design-pro-xiang-mu/7.png" alt></p><p>到此，ant design pro项目就搭建好了。下面介绍一下JSX语法吧，这是React官方推荐的模板语法，与VUE使用模板的方式差别还是挺大的。不过本人在使用了Vue和React后，觉得Vue的模板语法使用更加顺手，基本上符合Html的语法，上手更快。看个人习惯吧</p><h2 id="JSX模板语法"><a href="#JSX模板语法" class="headerlink" title="JSX模板语法"></a>JSX模板语法</h2><p>简单来说，在JS中书写HTML语法（不是简单在JS中写HTML字符串），就可称之为JSX语法。JSX就是Javascript和XML结合的一种格式。React发明了JSX，利用HTML语法来创建虚拟DOM。当遇到&lt;，JSX就当HTML解析，遇到{就当JavaScript解析。JS语法与JSX语法的区别。在普通的JS语法中，如果想渲染一段html文本的话，我们需要这么做。如下：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> child1 <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'First Text Content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> child2 <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Second Text Content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> root <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'my-list'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> child1<span class="token punctuation">,</span> child2<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>等价于(JSX写法)</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> root <span class="token operator">=</span><span class="token punctuation">(</span>  <span class="token operator">&lt;</span>ul className<span class="token operator">=</span><span class="token string">"my-list"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>li<span class="token operator">></span>First Text Content<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>    <span class="token operator">&lt;</span>li<span class="token operator">></span>Second Text Content<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>后者将XML语法直接加入JS中,通过代码而非模板来高效的定义界面。之后JSX通过翻译器转换为纯JS再由浏览器执行。在实际开发中，JSX在产品打包阶段都已经编译成纯JavaScript，JSX的语法不会带来任何性能影响。另外，由于JSX只是一种语法，因此JavaScript的关键字class, for等也不能出现在XML中，而要如例子中所示，使用className, htmlFor代替，这和原生DOM在JavaScript中的创建也是一致的。JSX只是创建虚拟DOM的一种语法格式而已,除了用JSX,我们也可以用JS代码来创建虚拟DOM。</p><h3 id="JSX的基本使用"><a href="#JSX的基本使用" class="headerlink" title="JSX的基本使用"></a>JSX的基本使用</h3><p>要使用 JSX 则必须要引入React,React的每一个组件都有render函数，render函数返回的就是JSX渲染的内容，JSX的基本使用个HTML标签没有什么区别。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>div<span class="token operator">></span>Hello word<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code></pre><h3 id="JSX占位符：Fragement"><a href="#JSX占位符：Fragement" class="headerlink" title="JSX占位符：Fragement"></a>JSX占位符：Fragement</h3><p>在JSX中返回的内容都必须包含在一个大的标签内，所以我们不得不在最外边套一层div，如果我们不希望页面渲染这层div的话就需要使用占位符-Fragement在JSX中返回的内容都必须包含在一个大的标签内，所以我们不得不在最外边套一层div，如果我们不希望页面渲染这层div的话就需要使用占位符-Fragement</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Fragement<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>        <span class="token operator">&lt;</span>Fragement<span class="token operator">></span>            <span class="token operator">&lt;</span>div<span class="token operator">></span>Hello word<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>            <span class="token operator">&lt;</span>div<span class="token operator">></span>Hello React<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>Fragement<span class="token operator">></span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="JSX中绑定事件"><a href="#JSX中绑定事件" class="headerlink" title="JSX中绑定事件"></a>JSX中绑定事件</h3><p>SX让事件直接绑定在元素上。</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token attr-value"><span class="token punctuation">=</span>{this.checkAndSubmit.bind(this)}</span><span class="token punctuation">></span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code></pre><p>和原生HTML定义事件的唯一区别就是JSX采用驼峰写法来描述事件名称，大括号中仍然是标准的JavaScript表达式，返回一个事件处理函数。React并不会真正的绑定事件到每一个具体的元素上，而是采用事件代理的模式：在根节点document上为每种事件添加唯一的Listener，然后通过事件的target找到真实的触发元素。这样从触发元素到顶层节点之间的所有节点如果有绑定这个事件，React都会触发对应的事件处理函数。这就是所谓的React模拟事件系统。尽管整个事件系统由React管理，但是其API和使用方法与原生事件一致。</p><h3 id="JSX中使用样式"><a href="#JSX中使用样式" class="headerlink" title="JSX中使用样式"></a>JSX中使用样式</h3><p>在JSX中使用样式和真实的样式也很类似，通过style属性来定义，但和真实DOM不同的是，属性值不能是字符串而必须为对象。例如:</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation">=</span>{{color:</span> <span class="token attr-name">'#ff0000',</span> <span class="token attr-name"><span class="token namespace">fontSize:</span></span> <span class="token attr-name">'14px'}}</span><span class="token punctuation">></span></span>Hello World.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre><p>或者</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> style <span class="token operator">=</span> <span class="token punctuation">{</span>  color<span class="token punctuation">:</span> <span class="token string">'#ff0000'</span><span class="token punctuation">,</span>  fontSize<span class="token punctuation">:</span> <span class="token string">'14px'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">></span>HelloWorld<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span></code></pre><p>要明确记住,{}里面是JS代码,这里传进去的是标准的JS对象。在JSX中可以使用所有的的样式，基本上属性名的转换规范就是将其写成驼峰写法，例如“background-color”变为“backgroundColor”, “font-size”变为“fontSize”，这和标准的JavaScript操作DOM样式的API是一致的。</p><h3 id="父组件向子组件传值"><a href="#父组件向子组件传值" class="headerlink" title="父组件向子组件传值"></a>父组件向子组件传值</h3><p>父组件Comment.js</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token keyword">import</span> ComentList <span class="token keyword">from</span> <span class="token string">"./ComentList"</span><span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>            arr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"fangMing"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"123333"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"zhangSan"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"345555"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"liSi"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"567777"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"wangWu"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"789999"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div<span class="token operator">></span>                <span class="token operator">&lt;</span>ComentList arr<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>arr<span class="token punctuation">}</span><span class="token operator">></span> <span class="token comment" spellcheck="true">//这里把state里面的arr传递到子组件,等号左边的arr就是形参名，在子组件中取参数也是取arr</span>                <span class="token operator">&lt;</span><span class="token operator">/</span>ComentList<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Comment<span class="token punctuation">;</span></code></pre><p>子组件ComentList.js</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token keyword">class</span> <span class="token class-name">ComentList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"list"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>ul<span class="token operator">></span>                    <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//这个地方通过this.props.arr接收到父组件传过来的arr，然后在{}里面进行js的循环</span>                            <span class="token keyword">return</span> <span class="token punctuation">(</span>                                <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token operator">></span>                                    <span class="token punctuation">{</span>item<span class="token punctuation">.</span>userName<span class="token punctuation">}</span> 评论是<span class="token punctuation">:</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span>                                <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>                            <span class="token punctuation">)</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ComentList<span class="token punctuation">;</span></code></pre><h3 id="子组件向父组件传值"><a href="#子组件向父组件传值" class="headerlink" title="子组件向父组件传值"></a>子组件向父组件传值</h3><p>父组件Comment.js</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token keyword">import</span> ComentList <span class="token keyword">from</span> <span class="token string">"./ComentList"</span><span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>            parentText<span class="token punctuation">:</span> <span class="token string">"this is parent text"</span><span class="token punctuation">,</span>            arr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"fangMing"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"123333"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"zhangSan"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"345555"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"liSi"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"567777"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token string">"userName"</span><span class="token punctuation">:</span> <span class="token string">"wangWu"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"789999"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            parentText<span class="token punctuation">:</span> data <span class="token comment" spellcheck="true">//把父组件中的parentText替换为子组件传递的值</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>parentText<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//setState是异步操作，但是我们可以在它的回调函数里面进行操作</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div<span class="token operator">></span>                <span class="token comment" spellcheck="true">//通过绑定事件进行值的运算，这个地方一定要记得.bind(this)，不然会报错，切记切记，因为通过事件传递的时候this的指向已经改变</span>                <span class="token operator">&lt;</span>ComentList arr<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>arr<span class="token punctuation">}</span> pfn<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>ComentList<span class="token operator">></span>                <span class="token operator">&lt;</span>p<span class="token operator">></span>                    text is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>parentText<span class="token punctuation">}</span>                <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Comment<span class="token punctuation">;</span> </code></pre><p>子组件ComentList.js</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token keyword">class</span> <span class="token class-name">ComentList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>            childText<span class="token punctuation">:</span> <span class="token string">"this is child text"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">clickFun</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">pfn</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//这个地方把值传递给了props的事件当中</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"list"</span><span class="token operator">></span>                <span class="token operator">&lt;</span>ul<span class="token operator">></span>                    <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                            <span class="token keyword">return</span> <span class="token punctuation">(</span>                                <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>userName<span class="token punctuation">}</span><span class="token operator">></span>                                    <span class="token punctuation">{</span>item<span class="token punctuation">.</span>userName<span class="token punctuation">}</span> 评论是<span class="token punctuation">:</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span>                                <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>                            <span class="token punctuation">)</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>                <span class="token comment" spellcheck="true">//通过事件进行传值，如果想得到event，可以在参数最后加一个event，这个地方还是要强调，this，this，this</span>                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickFun<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>childText<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>                    click me                <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ComentList<span class="token punctuation">;</span></code></pre><p>最后想说一点，如果嵌套的父子组件很深好几层，这个时候我想你应该考虑用状态管理工具redux了</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Echarts图表各种参数详解</title>
      <link href="/2020/03/12/echarts-tu-biao-ge-chong-can-shu-xiang-jie/"/>
      <url>/2020/03/12/echarts-tu-biao-ge-chong-can-shu-xiang-jie/</url>
      
        <content type="html"><![CDATA[<p>公司做项目需要报表统计，用到Echarts。但是UI给出的风格和Echarts官方的风格差别有点大，因此需要自己去调整报表的风格样式，官方文档非常详细。但是每次都要去不同的菜单下去查看文档也很麻烦，在使用过程中个人对报表的统计参数做了一些总结，方便查阅。ECharts，是一个由百度前端技术部开源的纯 Javascript 的图表库，可以流畅的运行在 PC 和移动设备上，兼容当前绝大部分浏览器（IE8/9/10/11，Chrome，Firefox，Safari等），底层依赖轻量级的 Canvas 类库 <a href="https://github.com/ecomfe/zrender" target="_blank" rel="noopener">ZRender</a>，提供直观，生动，可交互，可高度个性化定制的数据可视化图表。ECharts 3 中更是加入了更多丰富的交互功能以及更多的可视化效果，并且对移动端做了深度的优化。</p><p><img src="/2020/03/12/echarts-tu-biao-ge-chong-can-shu-xiang-jie/1.jpg" alt></p><p>本文主要记录Echarts的两种常规需求，一种是在报表上添加点击事件，第二种是对官网的echarts的报表样式做一些个性化的修改。</p><h1 id="图表点击事件"><a href="#图表点击事件" class="headerlink" title="图表点击事件"></a>图表点击事件</h1><p>通常在使用Echarts画图之后可能会碰到这样的需求，通过点击生成后图形具体某一项来传递相应的参数然后进行一个页面的跳转或者通过点击事件触发弹框，遇到这个需求第一就想到了用on绑定点击事件的方法，然后就在代码上进行尝试，果然可以实现这个功能，我在这块展示的是一个柱状图，通过点击事件输出一下获取的参数可以得到什么结果呢？实现代码如下：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> echarts <span class="token keyword">from</span> <span class="token string">'echarts'</span>  <span class="token keyword">var</span> myChart <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>domID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//这里自己按需要自己写</span>myChart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>myChart<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>点击画图，可以看到控制台信息</p><p><img src="/2020/03/12/echarts-tu-biao-ge-chong-can-shu-xiang-jie/3.png" alt></p><p>在这块我点击了8月份降水量，可以看到这块输出了，这一栏所对应的信息，包括名称seriesName：降水量，以及data值182.2，还以一些其他的信息，同样点击其他的也可以输出对应信息，这样我们就可以进行点击跳转并且传递对应的参数就ok了。但是这个方法有一个不友好的地方就是只有用户点击到柱状图上它才会触发到这个点击事件，比如图中的一月份对应的数值就特别小，点击那一列的其他位置是没有作用的，只有点击直柱阴影部分才触发，只一点对于用户来说就非常不友好，因此找到了另外一种方法实现这个需求，通过点击所在值的这一列就会触发，实现代码如下：</p><pre class=" language-javascript"><code class="language-javascript">myChart<span class="token punctuation">.</span><span class="token function">getZr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">let</span> point<span class="token operator">=</span><span class="token punctuation">[</span>params<span class="token punctuation">.</span>offsetX<span class="token punctuation">,</span>params<span class="token punctuation">.</span>offsetY<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>myChart<span class="token punctuation">.</span><span class="token function">containPixel</span><span class="token punctuation">(</span><span class="token string">'gird'</span><span class="token punctuation">,</span>point<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">let</span> xIndex<span class="token operator">=</span>myChart<span class="token punctuation">.</span><span class="token function">convertFromPixel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>seriesIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              point<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> op<span class="token operator">=</span>myChart<span class="token punctuation">.</span><span class="token function">getOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> name<span class="token operator">=</span>op<span class="token punctuation">.</span>xAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>xIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这部分的代码可以实现点击某一列就能触发这个事件，主要的信息集中在op这个变量中，name变量是点击某一列对应的名称，使用时可以将这个变量打印出来然后选择所需要传递的参数，其实这个代码是通过鼠标点击图形的坐标来进行判断点击的位置属于哪一列，从而实现这个需求，在这块我在写的时候碰到一个问题，有一个图形点击一次总是触发两次这个函数，如果你也出现了这个问题可以通过在绑定事件之前加上一句代码。</p><pre class=" language-javascript"><code class="language-javascript">myChart<span class="token punctuation">.</span><span class="token function">getZr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="action图表行为"><a href="#action图表行为" class="headerlink" title="action图表行为"></a>action图表行为</h2><p>图表行为用于触发能够改变图表显示的相关动态功能，event事件用于接收action触发的行为，所以action行为要配合event事件一块学习</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//触发图表行为（更改变图表显示的相关动态），例如图例开关legendToggleSelect, 数据区域缩放dataZoom，显示提示框showTip等等</span><span class="token comment" spellcheck="true">//通过不同的type触发不同的行为</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'highlight'</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//高亮指定的数据图形。通过seriesName或者seriesIndex指定系列。如果要再指定某个数据可以再指定dataIndex或者name。</span>    type<span class="token punctuation">:</span> <span class="token string">'downplay'</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//取消高亮指定的数据图形。通过seriesName或者seriesIndex指定系列。如果要指定某个数据可以再指定dataIndex或者name。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token operator">|</span>Array<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 可选，系列 index，可以是一个数组指定多个系列</span>    seriesName<span class="token punctuation">:</span> string<span class="token operator">|</span>Array<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 可选，系列名称，可以是一个数组指定多个系列</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 可选，数据的 index</span>    name<span class="token punctuation">:</span> string                <span class="token comment" spellcheck="true">// 可选，数据的 名称</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================dataZoom的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'dataZoom'</span><span class="token punctuation">,</span>    dataZoomIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 可选，dataZoom 组件的 index，多个 dataZoom 组件时有用，默认为 0</span>    start<span class="token punctuation">:</span> number<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">// 开始位置的百分比，0 - 100</span>    end<span class="token punctuation">:</span> number<span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">// 结束位置的百分比，0 - 100</span>    startValue<span class="token punctuation">:</span> number<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 开始位置的数值</span>    endValue<span class="token punctuation">:</span> number           <span class="token comment" spellcheck="true">// 结束位置的数值</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一次触发多个开关</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'dataZoom'</span><span class="token punctuation">,</span>    batch<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                   <span class="token comment" spellcheck="true">// 第一个 dataZoom 组件</span>        start<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        end<span class="token punctuation">:</span> <span class="token number">30</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        dataZoomIndex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">// 第二个 dataZoom 组件</span>        start<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>        end<span class="token punctuation">:</span> <span class="token number">20</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================legend的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'legendSelect'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//选中图例。</span>    type<span class="token punctuation">:</span> <span class="token string">'legendUnSelect'</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//取消选中图例。</span>    type<span class="token punctuation">:</span> <span class="token string">'legendToggleSelect'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//切换图例的选中状态。</span>    name<span class="token punctuation">:</span> string  <span class="token comment" spellcheck="true">// 图例名称</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'legendScroll'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//控制图例的滚动。当 legend.type 为 'scroll' 时有效。</span>    scrollDataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>    legendId<span class="token punctuation">:</span> string<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================tooltip的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'showTip'</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//显示提示框，指定在相对容器的位置处显示提示框，如果指定的位置无法显示则无效。</span>    x<span class="token punctuation">:</span> number<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// 屏幕上的 x 坐标</span>    y<span class="token punctuation">:</span> number<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// 屏幕上的 y 坐标</span>    <span class="token comment" spellcheck="true">// 本次显示 tooltip 的位置。只在本次 action 中生效。</span>    <span class="token comment" spellcheck="true">// 缺省则使用 option 中定义的 tooltip 位置。</span>    position<span class="token punctuation">:</span> Array<span class="token punctuation">.</span><span class="token operator">&lt;</span>number<span class="token operator">></span><span class="token operator">|</span>string<span class="token operator">|</span>Function<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'showTip'</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//显示提示框，指定数据图形，根据 tooltip 的配置项显示提示框。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 系列的 index，在 tooltip 的 trigger 为 axis 的时候可选。</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 数据的 index，如果不指定也可以通过 name 属性根据名称指定数据</span>    name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">// 可选，数据名称，在有 dataIndex 的时候忽略</span>    <span class="token comment" spellcheck="true">// 本次显示 tooltip 的位置。只在本次 action 中生效。</span>    <span class="token comment" spellcheck="true">// 缺省则使用 option 中定义的 tooltip 位置。</span>    position<span class="token punctuation">:</span> Array<span class="token punctuation">.</span><span class="token operator">&lt;</span>number<span class="token operator">></span><span class="token operator">|</span>string<span class="token operator">|</span>Function<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'hideTip'</span>             <span class="token comment" spellcheck="true">//隐藏提示框。</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================visualMap的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'selectDataRange'</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//选取映射的数值范围。</span>    visualMapIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 可选，visualMap 组件的 index，多个 visualMap 组件时有用，默认为 0</span>    <span class="token comment" spellcheck="true">// 连续型 visualMap 和 离散型 visualMap 不一样</span>    <span class="token comment" spellcheck="true">// 连续型的是一个表示数值范围的数组。selected: [20, 40],</span>    <span class="token comment" spellcheck="true">// 离散型的是一个对象，键值是类目或者分段的索引。值是 `true`, `false`,例如：selected: { 1: false }// 取消选中第二段, selected: { '优': false }// 取消选中类目 `优`</span>    selected<span class="token punctuation">:</span> Object<span class="token operator">|</span>Array<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================timeline的相关触发=================</span><span class="token comment" spellcheck="true">//时间轴组件相关的行为，必须引入时间轴组件后才能使用</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'timelineChange'</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//设置当前的时间点。</span>    currentIndex<span class="token punctuation">:</span> number        <span class="token comment" spellcheck="true">// 时间点的 index</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'timelinePlayChange'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//切换时间轴的播放状态。</span>    playState<span class="token punctuation">:</span> boolean            <span class="token comment" spellcheck="true">// 播放状态，true 为自动播放</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================toolbox的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'restore'</span>             <span class="token comment" spellcheck="true">//重置 option。</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================pie的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'pieUnSelect'</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//取消选中指定的饼图扇形。</span>    type<span class="token punctuation">:</span> <span class="token string">'pieToggleSelect'</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//切换指定的饼图扇形选中状态。</span>    type<span class="token punctuation">:</span> <span class="token string">'pieSelect'</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//选中指定的饼图扇形。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token operator">|</span>Array<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 可选，系列 index，可以是一个数组指定多个系列</span>    seriesName<span class="token punctuation">:</span> string<span class="token operator">|</span>Array<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 可选，系列名称，可以是一个数组指定多个系列</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 数据的 index，如果不指定也可以通过 name 属性根据名称指定数据</span>    name<span class="token punctuation">:</span> string                <span class="token comment" spellcheck="true">// 可选，数据名称，在有 dataIndex 的时候忽略</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================geo的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'geoSelect'</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//选中指定的地图区域。</span>    type<span class="token punctuation">:</span> <span class="token string">'geoUnSelect'</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//取消选中指定的地图区域。</span>    type<span class="token punctuation">:</span> <span class="token string">'geoToggleSelect'</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//切换指定的地图区域选中状态。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token operator">|</span>Array<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 可选，系列 index，可以是一个数组指定多个系列</span>    seriesName<span class="token punctuation">:</span> string<span class="token operator">|</span>Array<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 可选，系列名称，可以是一个数组指定多个系列</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 数据的 index，如果不指定也可以通过 name 属性根据名称指定数据</span>    name<span class="token punctuation">:</span> string                <span class="token comment" spellcheck="true">// 可选，数据名称，在有 dataIndex 的时候忽略</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================map的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'mapSelect'</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//选中指定的地图区域。</span>    type<span class="token punctuation">:</span> <span class="token string">'mapUnSelect'</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//取消选中指定的地图区域。</span>    type<span class="token punctuation">:</span> <span class="token string">'mapToggleSelect'</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//切换指定的地图区域选中状态。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token operator">|</span>Array<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 可选，系列 index，可以是一个数组指定多个系列</span>    seriesName<span class="token punctuation">:</span> string<span class="token operator">|</span>Array<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 可选，系列名称，可以是一个数组指定多个系列</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 数据的 index，如果不指定也可以通过 name 属性根据名称指定数据</span>    name<span class="token punctuation">:</span> string                 <span class="token comment" spellcheck="true">// 可选，数据名称，在有 dataIndex 的时候忽略</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//=====================graph的相关触发=================</span>myChart<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span> <span class="token string">'focusNodeAdjacency'</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//将指定的节点以及其所有邻接节点高亮。</span>    type<span class="token punctuation">:</span> <span class="token string">'unfocusNodeAdjacency'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//将指定的节点以及其所有邻接节点高亮。</span>    <span class="token comment" spellcheck="true">// 使用 seriesId 或 seriesIndex 或 seriesName 来定位 series.</span>    seriesId<span class="token punctuation">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>    seriesIndex<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    seriesName<span class="token punctuation">:</span> <span class="token string">'nnn'</span><span class="token punctuation">,</span>    dataIndex<span class="token punctuation">:</span> <span class="token number">12</span>                   <span class="token comment" spellcheck="true">// 使用 dataIndex 来定位节点。</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="event图表事件"><a href="#event图表事件" class="headerlink" title="event图表事件"></a>event图表事件</h2><p>event事件用于接收用户的相关事件和action触发的图表的行为。图表行为用于触发能够改变图表显示的相关动态功能，event事件用于接收action触发的行为，所以action行为要配合event事件一块学习。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//在 ECharts 中主要通过 on 方法添加事件处理函数，该文档描述了所有 ECharts 的事件列表。</span><span class="token comment" spellcheck="true">//ECharts 中的事件分为两种，一种是鼠标事件，在鼠标点击某个图形上会触发，还有一种是 调用 dispatchAction 后触发的事件。</span><span class="token comment" spellcheck="true">//==========================鼠标事件==============================</span><span class="token comment" spellcheck="true">//鼠标事件包括'click'，'dblclick'，'mousedown'，'mouseup'，'mouseover'，'mouseout'，'globalout'，'contextmenu'。</span><span class="token comment" spellcheck="true">//鼠标事件的事件参数是事件对象的数据的各个属性，具体见各个图表类型的 label formatter 回调函数的 params。</span>myChart<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//对于图表的点击事件，基本参数如下，其它图表诸如饼图可能会有部分附加参数。</span>params<span class="token operator">=</span><span class="token punctuation">{</span>    componentType<span class="token punctuation">:</span> string<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 当前点击的图形元素所属的组件名称，// 其值如 'series'、'markLine'、'markPoint'、'timeLine' 等。</span>    seriesType<span class="token punctuation">:</span> string<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 系列类型。值可能为：'line'、'bar'、'pie' 等。当 componentType 为 'series' 时有意义。</span>    seriesIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 系列在传入的 option.series 中的 index。当 componentType 为 'series' 时有意义。</span>    seriesName<span class="token punctuation">:</span> string<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 系列名称。当 componentType 为 'series' 时有意义。</span>    name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">// 数据名，类目名</span>    dataIndex<span class="token punctuation">:</span> number<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// 数据在传入的 data 数组中的 index</span>    data<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">// 传入的原始数据项</span>    <span class="token comment" spellcheck="true">// sankey、graph 等图表同时含有 nodeData 和 edgeData 两种 data，</span>    <span class="token comment" spellcheck="true">// dataType 的值会是 'node' 或者 'edge'，表示当前点击在 node 还是 edge 上。</span>    <span class="token comment" spellcheck="true">// 其他大部分图表中只有一种 data，dataType 无意义。</span>    dataType<span class="token punctuation">:</span> string<span class="token punctuation">,</span>    value<span class="token punctuation">:</span> number<span class="token operator">|</span>Array         <span class="token comment" spellcheck="true">// 传入的数据值</span>    color<span class="token punctuation">:</span> string               <span class="token comment" spellcheck="true">// 数据图形的颜色。当 componentType 为 'series' 时有意义。</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//==========================action事件的响应函数==============================</span><span class="token comment" spellcheck="true">//type就是action中的type，在action执行完毕后触发响应函数，响应函数的params中包含的属性就是触发action时添加的属性</span>myChart<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//params中包含的属性就是触发action时添加的属性</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//例如触发legendSelect选中图例时，会添加name属性，则使用以下函数设置回调函数</span>myChart<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'legendselectchanged'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//读取触发时添加的属性</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="图标样式修改"><a href="#图标样式修改" class="headerlink" title="图标样式修改"></a>图标样式修改</h1><p>关于报表的各种参数汇总整理，如果错误的地方，以官方文档为准。首先整理各图表的公有参数，即图标的 title，tooltip，toolbox，dataZoom，visualMap 几个配置的详细注释，这几个参数是各图表中基本都具备的</p><h2 id="六大公共参数详解"><a href="#六大公共参数详解" class="headerlink" title="六大公共参数详解"></a>六大公共参数详解</h2><h3 id="title详解"><a href="#title详解" class="headerlink" title="title详解"></a>title详解</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>title<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//是否显示</span>    text<span class="token punctuation">:</span><span class="token string">"大标题"</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//大标题</span>    subtext<span class="token punctuation">:</span><span class="token string">"小标题"</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//小标题</span>    sublink<span class="token punctuation">:</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//小标题链接</span>    target<span class="token punctuation">:</span><span class="token string">"blank"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//'self' 当前窗口打开，'blank' 新窗口打开</span>    subtarget<span class="token punctuation">:</span><span class="token string">"blank"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//小标题打开链接的窗口</span>    textAlign<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//文本水平对齐</span>    textBaseline<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//文本垂直对齐</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//标题样式</span>    subtextStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//小标题样式</span>    padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//标题内边距 5  [5, 10]  [5,10,5,10]</span>    itemGap<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//大小标题间距</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>    left<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//组件离容器左侧的距离,'left', 'center', 'right','20%'</span>    top<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//组件离容器上侧的距离,'top', 'middle', 'bottom','20%'</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//组件离容器右侧的距离,'20%'</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,'20%'</span>    backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//标题背景色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//边框线宽</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//阴影的模糊大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="tooltip详解"><a href="#tooltip详解" class="headerlink" title="tooltip详解"></a>tooltip详解</h3><pre class=" language-javascript"><code class="language-javascript">tooltip <span class="token operator">=</span><span class="token punctuation">{</span>                                      <span class="token comment" spellcheck="true">//提示框组件</span>    trigger<span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//触发类型,'item'数据项图形触发，主要在散点图，饼图等无类目轴的图表中使用。 'axis'坐标轴触发，主要在柱状图，折线图等会使用类目轴的图表中使用。</span>    triggerOn<span class="token punctuation">:</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//提示框触发的条件,'mousemove'鼠标移动时触发。'click'鼠标点击时触发。'mousemove|click'同时鼠标移动和点击时触发。'none'不在 'mousemove' 或 'click' 时触发</span>    showContent<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//是否显示提示框浮层</span>    alwaysShowContent<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//是否永远显示提示框内容</span>    showDelay<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//浮层显示的延迟，单位为 ms</span>    hideDelay<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//浮层隐藏的延迟，单位为 ms</span>    enterable<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//鼠标是否可进入提示框浮层中</span>    confine<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//是否将 tooltip 框限制在图表的区域内</span>    transitionDuration<span class="token punctuation">:</span><span class="token number">0.4</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//提示框浮层的移动动画过渡时间，单位是 s,设置为 0 的时候会紧跟着鼠标移动</span>    position<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//提示框浮层的位置，默认不设置时位置会跟随鼠标的位置,[10, 10],回掉函数，inside鼠标所在图形的内部中心位置，top、left、bottom、right鼠标所在图形上侧，左侧，下侧，右侧，</span>    formatter<span class="token punctuation">:</span><span class="token string">"{b0}: {c0}&lt;br />{b1}: {c1}"</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//提示框浮层内容格式器，支持字符串模板和回调函数两种形式,模板变量有 {a}, {b}，{c}，{d}，{e}，分别表示系列名，数据名，数据值等</span>    backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//标题背景色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//边框线宽</span>    padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//图例内边距，单位px  5  [5, 10]  [5,10,5,10]</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//文本样式</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="toolbox详解"><a href="#toolbox详解" class="headerlink" title="toolbox详解"></a>toolbox详解</h3><pre class=" language-javascript"><code class="language-javascript">toolbox<span class="token operator">=</span><span class="token punctuation">{</span>    show <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//是否显示工具栏组件</span>    orient<span class="token punctuation">:</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//工具栏 icon 的布局朝向'horizontal' 'vertical'</span>    itemSize<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//工具栏 icon 的大小</span>    itemGap<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//工具栏 icon 每项之间的间隔</span>    showTitle<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//是否在鼠标 hover 的时候显示每个工具 icon 的标题</span>    feature <span class="token punctuation">:</span> <span class="token punctuation">{</span>        mark <span class="token punctuation">:</span> <span class="token punctuation">{</span>                                 <span class="token comment" spellcheck="true">// '辅助线开关'</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        dataView <span class="token punctuation">:</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">//数据视图工具，可以展现当前图表所用的数据，编辑后可以动态更新</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否显示该工具。</span>            title<span class="token punctuation">:</span><span class="token string">"数据视图"</span><span class="token punctuation">,</span>            readOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//是否不可编辑（只读）</span>            lang<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'数据视图'</span><span class="token punctuation">,</span> <span class="token string">'关闭'</span><span class="token punctuation">,</span> <span class="token string">'刷新'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//数据视图上有三个话术，默认是['数据视图', '关闭', '刷新']</span>            backgroundColor<span class="token punctuation">:</span><span class="token string">"#fff"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//数据视图浮层背景色。</span>            textareaColor<span class="token punctuation">:</span><span class="token string">"#fff"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//数据视图浮层文本输入区背景色</span>            textareaBorderColor<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//数据视图浮层文本输入区边框颜色</span>            textColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//文本颜色。</span>            buttonColor<span class="token punctuation">:</span><span class="token string">"#c23531"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//按钮颜色。</span>            buttonTextColor<span class="token punctuation">:</span><span class="token string">"#fff"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//按钮文本颜色。</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        magicType<span class="token punctuation">:</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">//动态类型切换</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            title<span class="token punctuation">:</span><span class="token string">"切换"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//各个类型的标题文本，可以分别配置。</span>            type<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//启用的动态类型，包括'line'（切换为折线图）, 'bar'（切换为柱状图）, 'stack'（切换为堆叠模式）, 'tiled'（切换为平铺模式）</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        restore <span class="token punctuation">:</span> <span class="token punctuation">{</span>                             <span class="token comment" spellcheck="true">//配置项还原。</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否显示该工具。</span>            title<span class="token punctuation">:</span><span class="token string">"还原"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        saveAsImage <span class="token punctuation">:</span> <span class="token punctuation">{</span>                         <span class="token comment" spellcheck="true">//保存为图片。</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否显示该工具。</span>            type<span class="token punctuation">:</span><span class="token string">"png"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//保存的图片格式。支持 'png' 和 'jpeg'。</span>            name<span class="token punctuation">:</span><span class="token string">"pic1"</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//保存的文件名称，默认使用 title.text 作为名称</span>            backgroundColor<span class="token punctuation">:</span><span class="token string">"#ffffff"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//保存的图片背景色，默认使用 backgroundColor，如果backgroundColor不存在的话会取白色</span>            title<span class="token punctuation">:</span><span class="token string">"保存为图片"</span><span class="token punctuation">,</span>            pixelRatio<span class="token punctuation">:</span><span class="token number">1</span>                        <span class="token comment" spellcheck="true">//保存图片的分辨率比例，默认跟容器相同大小，如果需要保存更高分辨率的，可以设置为大于 1 的值，例如 2</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        dataZoom <span class="token punctuation">:</span><span class="token punctuation">{</span>                             <span class="token comment" spellcheck="true">//数据区域缩放。目前只支持直角坐标系的缩放</span>            show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否显示该工具。</span>            title<span class="token punctuation">:</span><span class="token string">"缩放"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//缩放和还原的标题文本</span>            xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//指定哪些 xAxis 被控制。如果缺省则控制所有的x轴。如果设置为 false 则不控制任何x轴。如果设置成 3 则控制 axisIndex 为 3 的x轴。如果设置为 [0, 3] 则控制 axisIndex 为 0 和 3 的x轴</span>            yAxisIndex<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//指定哪些 yAxis 被控制。如果缺省则控制所有的y轴。如果设置为 false 则不控制任何y轴。如果设置成 3 则控制 axisIndex 为 3 的y轴。如果设置为 [0, 3] 则控制 axisIndex 为 0 和 3 的y轴</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>    left<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器左侧的距离,'left', 'center', 'right','20%'</span>    top<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//组件离容器上侧的距离,'top', 'middle', 'bottom','20%'</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,'20%'</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,'20%'</span>    width<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//图例宽度</span>    height<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//图例高度</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="dataZoom详解"><a href="#dataZoom详解" class="headerlink" title="dataZoom详解"></a>dataZoom详解</h3><pre class=" language-javascript"><code class="language-javascript">dataZoom<span class="token operator">=</span><span class="token punctuation">[</span>                                      <span class="token comment" spellcheck="true">//区域缩放</span>    <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token string">'dataZoomX'</span><span class="token punctuation">,</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//是否显示 组件。如果设置为 false，不会显示，但是数据过滤的功能还存在。</span>        backgroundColor<span class="token punctuation">:</span><span class="token string">"rgba(47,69,84,0)"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//组件的背景颜色</span>        type<span class="token punctuation">:</span> <span class="token string">'slider'</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//slider表示有滑动块的，inside表示内置的</span>        dataBackground<span class="token punctuation">:</span><span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">//数据阴影的样式。</span>            lineStyle<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//阴影的线条样式</span>            areaStyle<span class="token punctuation">:</span>myareaStyle<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//阴影的填充样式</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        fillerColor<span class="token punctuation">:</span><span class="token string">"rgba(167,183,204,0.4)"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//选中范围的填充颜色。</span>        borderColor<span class="token punctuation">:</span><span class="token string">"#ddd"</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//边框颜色。</span>        filterMode<span class="token punctuation">:</span> <span class="token string">'filter'</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//'filter'：当前数据窗口外的数据，被 过滤掉。即 会 影响其他轴的数据范围。每个数据项，只要有一个维度在数据窗口外，整个数据项就会被过滤掉。</span>                                                  <span class="token comment" spellcheck="true">//'weakFilter'：当前数据窗口外的数据，被 过滤掉。即 会 影响其他轴的数据范围。每个数据项，只有当全部维度都在数据窗口同侧外部，整个数据项才会被过滤掉。</span>                                                  <span class="token comment" spellcheck="true">//'empty'：当前数据窗口外的数据，被 设置为空。即 不会 影响其他轴的数据范围。</span>                                                  <span class="token comment" spellcheck="true">//'none': 不过滤数据，只改变数轴范围。</span>        xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 x轴,可以用数组表示多个轴</span>        yAxisIndex<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 y轴,可以用数组表示多个轴</span>        radiusAxisIndex<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 radius 轴,可以用数组表示多个轴</span>        angleAxisIndex<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 angle 轴,可以用数组表示多个轴</span>        start<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//数据窗口范围的起始百分比,表示30%</span>        end<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//数据窗口范围的结束百分比,表示70%</span>        startValue<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//数据窗口范围的起始数值</span>        endValue<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//数据窗口范围的结束数值。</span>        orient<span class="token punctuation">:</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//布局方式是横还是竖。不仅是布局方式，对于直角坐标系而言，也决定了，缺省情况控制横向数轴还是纵向数轴。'horizontal'：水平。'vertical'：竖直。</span>        zoomLock<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否锁定选择区域（或叫做数据窗口）的大小。如果设置为 true 则锁定选择区域的大小，也就是说，只能平移，不能缩放。</span>        throttle<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//设置触发视图刷新的频率。单位为毫秒（ms）。</span>        zoomOnMouseWheel<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//如何触发缩放。可选值为：true：表示不按任何功能键，鼠标滚轮能触发缩放。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标滚轮能触发缩放。'ctrl'：表示按住 ctrl 和鼠标滚轮能触发缩放。'alt'：表示按住 alt 和鼠标滚轮能触发缩放。</span>        moveOnMouseMove<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//如何触发数据窗口平移。true：表示不按任何功能键，鼠标移动能触发数据窗口平移。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标移动能触发数据窗口平移。'ctrl'：表示按住 ctrl 和鼠标移动能触发数据窗口平移。'alt'：表示按住 alt 和鼠标移动能触发数据窗口平移。</span>        left<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//组件离容器左侧的距离,'left', 'center', 'right','20%'</span>        top<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//组件离容器上侧的距离,'top', 'middle', 'bottom','20%'</span>        right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//组件离容器右侧的距离,'20%'</span>        bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//组件离容器下侧的距离,'20%'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        id<span class="token punctuation">:</span> <span class="token string">'dataZoomY'</span><span class="token punctuation">,</span>        type<span class="token punctuation">:</span> <span class="token string">'inside'</span><span class="token punctuation">,</span>        filterMode<span class="token punctuation">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>        disabled<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否停止组件的功能。</span>        xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 x轴,可以用数组表示多个轴</span>        yAxisIndex<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 y轴,可以用数组表示多个轴</span>        radiusAxisIndex<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 radius 轴,可以用数组表示多个轴</span>        angleAxisIndex<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//设置 dataZoom-inside 组件控制的 angle 轴,可以用数组表示多个轴</span>        start<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//数据窗口范围的起始百分比,表示30%</span>        end<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//数据窗口范围的结束百分比,表示70%</span>        startValue<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//数据窗口范围的起始数值</span>        endValue<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//数据窗口范围的结束数值。</span>        orient<span class="token punctuation">:</span><span class="token string">"horizontal"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//布局方式是横还是竖。不仅是布局方式，对于直角坐标系而言，也决定了，缺省情况控制横向数轴还是纵向数轴。'horizontal'：水平。'vertical'：竖直。</span>        zoomLock<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否锁定选择区域（或叫做数据窗口）的大小。如果设置为 true 则锁定选择区域的大小，也就是说，只能平移，不能缩放。</span>        throttle<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//设置触发视图刷新的频率。单位为毫秒（ms）。</span>        zoomOnMouseWheel<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//如何触发缩放。可选值为：true：表示不按任何功能键，鼠标滚轮能触发缩放。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标滚轮能触发缩放。'ctrl'：表示按住 ctrl 和鼠标滚轮能触发缩放。'alt'：表示按住 alt 和鼠标滚轮能触发缩放。</span>        moveOnMouseMove<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//如何触发数据窗口平移。true：表示不按任何功能键，鼠标移动能触发数据窗口平移。false：表示鼠标滚轮不能触发缩放。'shift'：表示按住 shift 和鼠标移动能触发数据窗口平移。'ctrl'：表示按住 ctrl 和鼠标移动能触发数据窗口平移。'alt'：表示按住 alt 和鼠标移动能触发数据窗口平移。</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="visualMap详解"><a href="#visualMap详解" class="headerlink" title="visualMap详解"></a>visualMap详解</h3><pre class=" language-javascript"><code class="language-javascript">visualMap<span class="token operator">=</span><span class="token punctuation">[</span>                                     <span class="token comment" spellcheck="true">//视觉映射组件，用于进行『视觉编码』，也就是将数据映射到视觉元素。视觉元素可以是：symbol: 图元的图形类别。symbolSize: 图元的大小。color: 图元的颜色。</span>                                                 <span class="token comment" spellcheck="true">// colorAlpha: 图元的颜色的透明度。opacity: 图元以及其附属物（如文字标签）的透明度。colorLightness: 颜色的明暗度。colorSaturation: 颜色的饱和度。colorHue: 颜色的色调。</span>    <span class="token punctuation">{</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//是否显示 visualMap-continuous 组件。如果设置为 false，不会显示，但是数据映射的功能还存在</span>        type<span class="token punctuation">:</span> <span class="token string">'continuous'</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">// 定义为连续型 viusalMap</span>        min<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//指定 visualMapContinuous 组件的允许的最小值</span>        max<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//指定 visualMapContinuous 组件的允许的最大值</span>        range<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//指定手柄对应数值的位置。range 应在 min max 范围内</span>        calculable<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//是否显示拖拽用的手柄（手柄能拖拽调整选中范围）</span>        realtime<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//拖拽时，是否实时更新</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否反转 visualMap 组件</span>        precision<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//数据展示的小数精度，默认为0，无小数点</span>        itemWidth<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//图形的宽度，即长条的宽度。</span>        itemHeight<span class="token punctuation">:</span><span class="token number">140</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//图形的高度，即长条的高度。</span>        align<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//指定组件中手柄和文字的摆放位置.可选值为：'auto' 自动决定。'left' 手柄和label在右。'right' 手柄和label在左。'top' 手柄和label在下。'bottom' 手柄和label在上。</span>        text<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'High'</span><span class="token punctuation">,</span> <span class="token string">'Low'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//两端的文本</span>        textGap<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//两端文字主体之间的距离，单位为px</span>        dimension<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//指定用数据的『哪个维度』，映射到视觉元素上。『数据』即 series.data。 可以把 series.data 理解成一个二维数组,其中每个列是一个维度,默认取 data 中最后一个维度</span>        seriesIndex<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//指定取哪个系列的数据，即哪个系列的 series.data,默认取所有系列</span>        hoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//鼠标悬浮到 visualMap 组件上时，鼠标位置对应的数值 在 图表中对应的图形元素，会高亮</span>        inRange<span class="token punctuation">:</span><span class="token punctuation">{</span>                               <span class="token comment" spellcheck="true">//定义 在选中范围中 的视觉元素</span>            color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'#121122'</span><span class="token punctuation">,</span> <span class="token string">'rgba(3,4,5,0.4)'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            symbolSize<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        outOfRange<span class="token punctuation">:</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//定义 在选中范围外 的视觉元素。</span>            color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'#121122'</span><span class="token punctuation">,</span> <span class="token string">'rgba(3,4,5,0.4)'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            symbolSize<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>        z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>        left<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器左侧的距离,'left', 'center', 'right','20%'</span>        top<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//组件离容器上侧的距离,'top', 'middle', 'bottom','20%'</span>        right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,'20%'</span>        bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,'20%'</span>        orient<span class="token punctuation">:</span><span class="token string">"vertical"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//图例排列方向</span>        padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//图例内边距，单位px  5  [5, 10]  [5,10,5,10]</span>        backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//标题背景色</span>        borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//边框颜色</span>        borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//边框线宽</span>        textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//文本样式</span>        formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//标签的格式化工具。</span>            <span class="token keyword">return</span> <span class="token string">'aaaa'</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 范围标签显示内容。</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否显示 visualMap-continuous 组件。如果设置为 false，不会显示，但是数据映射的功能还存在</span>        type<span class="token punctuation">:</span> <span class="token string">'piecewise'</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// 定义为分段型 visualMap</span>        splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//对于连续型数据，自动平均切分成几段。默认为5段</span>        pieces<span class="token punctuation">:</span> <span class="token punctuation">[</span>                           <span class="token comment" spellcheck="true">//自定义『分段式视觉映射组件（visualMapPiecewise）』的每一段的范围，以及每一段的文字，以及每一段的特别的样式</span>            <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">1500</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">// 不指定 max，表示 max 为无限大（Infinity）。</span>            <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">900</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">1500</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">310</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>min<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> label<span class="token punctuation">:</span> <span class="token string">'10 到 200（自定义label）'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>value<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> label<span class="token punctuation">:</span> <span class="token string">'123（自定义特殊颜色）'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token string">'grey'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 表示 value 等于 123 的情况。</span>            <span class="token punctuation">{</span>max<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 不指定 min，表示 min 为无限大（-Infinity）。</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        categories<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'严重污染'</span><span class="token punctuation">,</span> <span class="token string">'重度污染'</span><span class="token punctuation">,</span> <span class="token string">'中度污染'</span><span class="token punctuation">,</span> <span class="token string">'轻度污染'</span><span class="token punctuation">,</span> <span class="token string">'良'</span><span class="token punctuation">,</span> <span class="token string">'优'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//用于表示离散型数据（或可以称为类别型数据、枚举型数据）的全集</span>        min<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//指定 visualMapContinuous 组件的允许的最小值</span>        max<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//指定 visualMapContinuous 组件的允许的最大值</span>        minOpen<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//界面上会额外多出一个『&lt; min』的选块</span>        maxOpen<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//界面上会额外多出一个『> max』的选块。</span>        selectedMode<span class="token punctuation">:</span><span class="token string">"multiple"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//选择模式，可以是：'multiple'（多选）。'single'（单选）。</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//是否反转 visualMap 组件</span>        precision<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//数据展示的小数精度，默认为0，无小数点</span>        itemWidth<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//图形的宽度，即长条的宽度。</span>        itemHeight<span class="token punctuation">:</span><span class="token number">140</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//图形的高度，即长条的高度。</span>        align<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//指定组件中手柄和文字的摆放位置.可选值为：'auto' 自动决定。'left' 手柄和label在右。'right' 手柄和label在左。'top' 手柄和label在下。'bottom' 手柄和label在上。</span>        text<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'High'</span><span class="token punctuation">,</span> <span class="token string">'Low'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//两端的文本</span>        textGap<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//两端文字主体之间的距离，单位为px</span>        showLabel<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//是否显示每项的文本标签</span>        itemGap<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//每两个图元之间的间隔距离，单位为px</span>        itemSymbol<span class="token punctuation">:</span><span class="token string">"roundRect"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//默认的图形。可选值为： 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>        dimension<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//指定用数据的『哪个维度』，映射到视觉元素上。『数据』即 series.data。 可以把 series.data 理解成一个二维数组,其中每个列是一个维度,默认取 data 中最后一个维度</span>        seriesIndex<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//指定取哪个系列的数据，即哪个系列的 series.data,默认取所有系列</span>        hoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//鼠标悬浮到 visualMap 组件上时，鼠标位置对应的数值 在 图表中对应的图形元素，会高亮</span>        inRange<span class="token punctuation">:</span><span class="token punctuation">{</span>                             <span class="token comment" spellcheck="true">//定义 在选中范围中 的视觉元素</span>            color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'#121122'</span><span class="token punctuation">,</span> <span class="token string">'rgba(3,4,5,0.4)'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            symbolSize<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        outOfRange<span class="token punctuation">:</span><span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">//定义 在选中范围外 的视觉元素。</span>            color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'#121122'</span><span class="token punctuation">,</span> <span class="token string">'rgba(3,4,5,0.4)'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            symbolSize<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>        z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>        left<span class="token punctuation">:</span><span class="token string">"center"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器左侧的距离,'left', 'center', 'right','20%'</span>        top<span class="token punctuation">:</span><span class="token string">"top"</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//组件离容器上侧的距离,'top', 'middle', 'bottom','20%'</span>        right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,'20%'</span>        bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,'20%'</span>        orient<span class="token punctuation">:</span><span class="token string">"vertical"</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//图例排列方向</span>        padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//图例内边距，单位px  5  [5, 10]  [5,10,5,10]</span>        backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//标题背景色</span>        borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//边框颜色</span>        borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//边框线宽</span>        textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//文本样式</span>        formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//标签的格式化工具。</span>            <span class="token keyword">return</span> <span class="token string">'aaaa'</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 范围标签显示内容。</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h2 id="五大坐标系详解"><a href="#五大坐标系详解" class="headerlink" title="五大坐标系详解"></a>五大坐标系详解</h2><h3 id="地理坐标系geo"><a href="#地理坐标系geo" class="headerlink" title="地理坐标系geo"></a>地理坐标系geo</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>geo<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//是否显示</span>    map<span class="token punctuation">:</span><span class="token string">"china"</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//地图类型。world世界地图，china中国地图</span>    roam<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移，可以设置成 'scale' 或者 'move'。设置成 true 为都开启</span>    center<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">115.97</span><span class="token punctuation">,</span> <span class="token number">29.71</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//当前视角的中心点，用经纬度表示</span>    aspectScale<span class="token punctuation">:</span><span class="token number">0.75</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//这个参数用于 scale 地图的长宽比。</span>    boundingCoords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//二维数组，定义定位的左上角以及右下角分别所对应的经纬度</span>    zoom<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                     <span class="token comment" spellcheck="true">//当前视角的缩放比例</span>    scaleLimit<span class="token punctuation">:</span><span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>        min<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//最小的缩放值</span>        max<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//最大的缩放值</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    nameMap<span class="token punctuation">:</span><span class="token punctuation">{</span>                                   <span class="token comment" spellcheck="true">//自定义地区的名称映射</span>        <span class="token string">'China'</span> <span class="token punctuation">:</span> <span class="token string">'中国'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    selectedMode<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//选中模式，表示是否支持多个选中，默认关闭，支持布尔值和字符串，字符串取值可选'single'表示单选，或者'multiple'表示多选。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                                     <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等</span>        normal<span class="token punctuation">:</span><span class="token punctuation">{</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否在普通状态下显示标签。</span>            textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//普通状态下的标签文本样式。</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span><span class="token punctuation">{</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否在高亮状态下显示标签。</span>            textStyle<span class="token punctuation">:</span>mytextStyle              <span class="token comment" spellcheck="true">//高亮状态下的标签文本样式。</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                                 <span class="token comment" spellcheck="true">//地图区域的多边形 图形样式</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                        <span class="token comment" spellcheck="true">//所属图形的 z 值。</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                                     <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    layoutCenter<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'30%'</span><span class="token punctuation">,</span> <span class="token string">'30%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//地图中心在屏幕中的位置</span>    layoutSize<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//地图的大小,支持相对于屏幕宽高的百分比或者绝对的像素大小。</span>    regions<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>                                  <span class="token comment" spellcheck="true">//在地图中对特定的区域配置样式。</span>        name<span class="token punctuation">:</span> <span class="token string">'广东'</span><span class="token punctuation">,</span>        itemStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>            normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                areaColor<span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>                color<span class="token punctuation">:</span> <span class="token string">'red'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="直角坐标系grid（xAxis、yAxis）"><a href="#直角坐标系grid（xAxis、yAxis）" class="headerlink" title="直角坐标系grid（xAxis、yAxis）"></a>直角坐标系grid（xAxis、yAxis）</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>grid<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//是否显示</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    width<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//图例宽度</span>    height<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//图例高度</span>    containLabel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//grid 区域是否包含坐标轴的刻度标签，</span>    backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//标题背景色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//边框线宽</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//阴影的模糊大小</span>    tooltip<span class="token punctuation">:</span><span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">//坐标系特定的 tooltip 设定</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//是否显示提示框组件，包括提示框浮层和 axisPointer</span>        trigger<span class="token punctuation">:</span><span class="token string">"axis"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//触发类型 none不触发  'item' 数据项图形触发，主要在散点图，饼图等无类目轴的图表中使用。  'axis'  坐标轴触发，主要在柱状图，折线图等会使用类目轴的图表中使用。</span>        position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//提示框浮层的位置，默认不设置时位置会跟随鼠标的位置,[10, 10],回掉函数，inside鼠标所在图形的内部中心位置，top、left、bottom、right鼠标所在图形上侧，左侧，下侧，右侧，</span>        formatter<span class="token punctuation">:</span><span class="token string">"{b0}: {c0}&lt;br />{b1}: {c1}"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//提示框浮层内容格式器，支持字符串模板和回调函数两种形式,模板变量有 {a}, {b}，{c}，{d}，{e}，分别表示系列名，数据名，数据值等</span>        backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//标题背景色</span>        borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>        borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//边框线宽</span>        padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//图例内边距，单位px  5  [5, 10]  [5,10,5,10]</span>        textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//文本样式</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>xAxis<span class="token operator">=</span><span class="token punctuation">[</span>    <span class="token punctuation">{</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否显示 x 轴</span>        gridIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//x 轴所在的 grid 的索引，默认位于第一个 grid</span>        position<span class="token punctuation">:</span><span class="token string">"bottom"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//x 轴的位置。"top"，"bottom"，默认 grid 中的第一个 x 轴在 grid 的下方（'bottom'），第二个 x 轴视第一个 x 轴的位置放在另一侧</span>        offset<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//X 轴相对于默认位置的偏移，在相同的 position 上有多个 X 轴的时候有用</span>        type<span class="token punctuation">:</span><span class="token string">"category"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//坐标轴类型。'value' 数值轴，适用于连续数据。'category' 类目轴，适用于离散的类目数据，为该类型时必须通过 data 设置类目数据。</span>                                   <span class="token comment" spellcheck="true">// 'time' 时间轴，适用于连续的时序数据，与数值轴相比时间轴带有时间的格式化，在刻度计算上也有所不同，例如会根据跨度的范围来决定使用月，星期，日还是小时范围的刻度。'log' 对数轴。适用于对数数据</span>        name<span class="token punctuation">:</span><span class="token string">'时间'</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴名称</span>        nameLocation<span class="token punctuation">:</span><span class="token string">"end"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//坐标轴名称显示位置。可选：'start','middle','end'</span>        nameTextStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//坐标轴名称的文字样式</span>        nameGap<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴名称与轴线之间的距离</span>        nameRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//坐标轴名字旋转，角度值</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否是反向坐标轴</span>        boundaryGap<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//类目轴中 boundaryGap 可以配置为 true 和 false。非类目轴，包括时间，数值，对数轴，boundaryGap是一个两个值的数组，分别表示数据最小值和最大值的延伸范围，可以直接设置数值或者相对的百分比，在设置 min 和 max 后无效['20%', '20%']</span>        min<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴刻度最小值。可以设置成特殊值 'dataMin'，此时取数据在该轴上的最小值作为最小刻度。不设置时会自动计算最小值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        max<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//坐标轴刻度最大值。可以设置成特殊值 'dataMax'，此时取数据在该轴上的最大值作为最大刻度。不设置时会自动计算最大值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>        splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//坐标轴的分割段数，需要注意的是这个分割段数只是个预估值，最后实际显示的段数会在这个基础上根据分割后坐标轴刻度显示的易读程度作调整</span>        minInterval<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//自动计算的坐标轴最小间隔大小,例如可以设置成1保证坐标轴分割刻度显示成整数。只在数值轴中（type: 'value'）有效。</span>        logBase<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//对数轴的底数，只在对数轴中（type: 'log'）有效</span>        silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>        triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>        axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标 轴线</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>            onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>            alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>            interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>            length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>            rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>            margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>            formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>                <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>            showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>            textStyle<span class="token punctuation">:</span>mytextStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        splitLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔线。</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示分隔线。默认数值轴显示，类目轴不显示。</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//坐标轴分隔线的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，可以用数值表示间隔的数据，也可以通过回调函数控制。回调函数格式如下：</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        splitArea<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔区域，默认不显示。</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否显示分隔区域</span>            areaStyle<span class="token punctuation">:</span>myareaStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//类目数据，在类目轴（type: 'category'）中有效。</span>        zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//X 轴所有图形的 zlevel 值。</span>        z<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//X 轴组件的所有图形的z值</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>yAxis<span class="token operator">=</span>xAxis<span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//y轴配置内容同x轴</span></code></pre><h3 id="parallel平行坐标系"><a href="#parallel平行坐标系" class="headerlink" title="parallel平行坐标系"></a>parallel平行坐标系</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>parallel<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//是否显示</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    width<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//图例宽度</span>    height<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//图例高度</span>    layout<span class="token punctuation">:</span> <span class="token string">"horizontal"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//布局方式，可选值为：'horizontal'：水平排布各个坐标轴。'vertical'：竖直排布各个坐标轴。</span>    axisExpandable<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否允许点击展开折叠 axis。</span>    axisExpandCenter<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//初始时，以哪个轴为中心展开，这里给出轴的 index。没有默认值，需要手动指定。</span>    axisExpandCount<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//初始时，有多少个轴会处于展开状态。建议根据你的维度个数而手动指定。</span>    axisExpandWidth<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//在展开状态，轴的间距是多少，单位为像素。</span>    axisExpandTriggerOn<span class="token punctuation">:</span><span class="token string">"click"</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//'click'：鼠标点击的时候 expand。'mousemove'：鼠标悬浮的时候 expand。</span>    parallelAxisDefault<span class="token punctuation">:</span><span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">//配置多个 parallelAxis 时，有些值一样的属性，如果书写多遍则比较繁琐，那么可以放置在 parallel.parallelAxisDefault 里</span>        type<span class="token punctuation">:</span><span class="token string">"category"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴类型。'value' 数值轴，适用于连续数据。'category' 类目轴，适用于离散的类目数据，为该类型时必须通过 data 设置类目数据。</span>                                         <span class="token comment" spellcheck="true">// 'time' 时间轴，适用于连续的时序数据，与数值轴相比时间轴带有时间的格式化，在刻度计算上也有所不同，例如会根据跨度的范围来决定使用月，星期，日还是小时范围的刻度。'log' 对数轴。适用于对数数据</span>        name<span class="token punctuation">:</span><span class="token string">'时间'</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴名称</span>        nameLocation<span class="token punctuation">:</span><span class="token string">"end"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴名称显示位置。可选：'start','middle','end'</span>        nameTextStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//坐标轴名称的文字样式</span>        nameGap<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//坐标轴名称与轴线之间的距离</span>        nameRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//坐标轴名字旋转，角度值</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//是否是反向坐标轴</span>        boundaryGap<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//类目轴中 boundaryGap 可以配置为 true 和 false。非类目轴，包括时间，数值，对数轴，boundaryGap是一个两个值的数组，分别表示数据最小值和最大值的延伸范围，可以直接设置数值或者相对的百分比，在设置 min 和 max 后无效['20%', '20%']</span>        min<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//坐标轴刻度最小值。可以设置成特殊值 'dataMin'，此时取数据在该轴上的最小值作为最小刻度。不设置时会自动计算最小值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        max<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//坐标轴刻度最大值。可以设置成特殊值 'dataMax'，此时取数据在该轴上的最大值作为最大刻度。不设置时会自动计算最大值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>        splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴的分割段数，需要注意的是这个分割段数只是个预估值，最后实际显示的段数会在这个基础上根据分割后坐标轴刻度显示的易读程度作调整</span>        minInterval<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//自动计算的坐标轴最小间隔大小,例如可以设置成1保证坐标轴分割刻度显示成整数。只在数值轴中（type: 'value'）有效。</span>        logBase<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//对数轴的底数，只在对数轴中（type: 'log'）有效</span>        silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>        triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>        axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">//坐标 轴线</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>            onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                       <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>            alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>            interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>            length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>            lineStyle<span class="token punctuation">:</span>mylineStyle <span class="token comment" spellcheck="true">//</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>            rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>            margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>            formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>                <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>            showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>            textStyle<span class="token punctuation">:</span>mytextStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//类目数据，在类目轴（type: 'category'）中有效。</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>parallelAxis<span class="token operator">=</span><span class="token punctuation">[</span>    <span class="token punctuation">{</span>        dim<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//坐标轴的维度序号。</span>        parallelIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//用于定义『坐标轴』对应到哪个『坐标系』中。</span>        realtime<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否坐标轴刷选的时候，实时刷新视图。如果设为 false，则在刷选动作结束时候，才刷新视图。大数据量时，建议设置成 false，从而避免卡顿。</span>        areaSelectStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">//在坐标轴上可以进行框选，这里是一些框选的设置。</span>            width<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//框选范围的宽度。</span>            borderWidth<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//选框的边框宽度。</span>            borderColor<span class="token punctuation">:</span><span class="token string">'rgba(160,197,232)'</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//选框的边框颜色。</span>            color<span class="token punctuation">:</span> <span class="token string">'rgba(160,197,232)'</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//选框的填充色。</span>            opacity<span class="token punctuation">:</span><span class="token number">0.3</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//选框的透明度。</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        type<span class="token punctuation">:</span><span class="token string">"category"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//坐标轴类型。'value' 数值轴，适用于连续数据。'category' 类目轴，适用于离散的类目数据，为该类型时必须通过 data 设置类目数据。</span>                                       <span class="token comment" spellcheck="true">// 'time' 时间轴，适用于连续的时序数据，与数值轴相比时间轴带有时间的格式化，在刻度计算上也有所不同，例如会根据跨度的范围来决定使用月，星期，日还是小时范围的刻度。'log' 对数轴。适用于对数数据</span>        name<span class="token punctuation">:</span><span class="token string">'时间'</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴名称</span>        nameLocation<span class="token punctuation">:</span><span class="token string">"end"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴名称显示位置。可选：'start','middle','end'</span>        nameTextStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//坐标轴名称的文字样式</span>        nameGap<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//坐标轴名称与轴线之间的距离</span>        nameRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴名字旋转，角度值</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否是反向坐标轴</span>        boundaryGap<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//类目轴中 boundaryGap 可以配置为 true 和 false。非类目轴，包括时间，数值，对数轴，boundaryGap是一个两个值的数组，分别表示数据最小值和最大值的延伸范围，可以直接设置数值或者相对的百分比，在设置 min 和 max 后无效['20%', '20%']</span>        min<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//坐标轴刻度最小值。可以设置成特殊值 'dataMin'，此时取数据在该轴上的最小值作为最小刻度。不设置时会自动计算最小值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        max<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//坐标轴刻度最大值。可以设置成特殊值 'dataMax'，此时取数据在该轴上的最大值作为最大刻度。不设置时会自动计算最大值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>        splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//坐标轴的分割段数，需要注意的是这个分割段数只是个预估值，最后实际显示的段数会在这个基础上根据分割后坐标轴刻度显示的易读程度作调整</span>        minInterval<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//自动计算的坐标轴最小间隔大小,例如可以设置成1保证坐标轴分割刻度显示成整数。只在数值轴中（type: 'value'）有效。</span>        logBase<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//对数轴的底数，只在对数轴中（type: 'log'）有效</span>        silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>        triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>        axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标 轴线</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>            onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                   <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>            alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>            interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>            length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>            lineStyle<span class="token punctuation">:</span>mylineStyle <span class="token comment" spellcheck="true">//</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                   <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否显示</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>            rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>            margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>            formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>                <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>            showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>            textStyle<span class="token punctuation">:</span>mytextStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//类目数据，在类目轴（type: 'category'）中有效。</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="polar极坐标系"><a href="#polar极坐标系" class="headerlink" title="polar极坐标系"></a>polar极坐标系</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>polar<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//是否显示</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的Canvas分层，zlevel 大的 Canvas 会放在 zlevel 小的 Canvas 的上面</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>    center<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//极坐标系的中心（圆心）坐标，像素值或百分比均可。设置成百分比，设置成百分比时第一项是相对于容器宽度，第二项是相对于容器高度</span>    radius<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'20%'</span><span class="token punctuation">,</span> <span class="token string">'70%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//数组的第一项是内半径，第二项是外半径。支持设置成百分比，相对于容器高宽中较小的一项的一半。</span>    tooltip<span class="token punctuation">:</span><span class="token punctuation">{</span>                                   <span class="token comment" spellcheck="true">//坐标系特定的 tooltip 设定</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//是否显示提示框组件，包括提示框浮层和 axisPointer</span>        trigger<span class="token punctuation">:</span><span class="token string">"axis"</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//触发类型 none不触发  'item' 数据项图形触发，主要在散点图，饼图等无类目轴的图表中使用。  'axis'  坐标轴触发，主要在柱状图，折线图等会使用类目轴的图表中使用。</span>        position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//提示框浮层的位置，默认不设置时位置会跟随鼠标的位置,[10, 10],回掉函数，inside鼠标所在图形的内部中心位置，top、left、bottom、right鼠标所在图形上侧，左侧，下侧，右侧，</span>        formatter<span class="token punctuation">:</span><span class="token string">"{b0}: {c0}&lt;br />{b1}: {c1}"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//提示框浮层内容格式器，支持字符串模板和回调函数两种形式,模板变量有 {a}, {b}，{c}，{d}，{e}，分别表示系列名，数据名，数据值等</span>        backgroundColor<span class="token punctuation">:</span><span class="token string">"transparent"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//标题背景色</span>        borderColor<span class="token punctuation">:</span><span class="token string">"#ccc"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//边框颜色</span>        borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//边框线宽</span>        padding<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//图例内边距，单位px  5  [5, 10]  [5,10,5,10]</span>        textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//文本样式</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>radiusAxis<span class="token operator">=</span><span class="token punctuation">[</span>    <span class="token punctuation">{</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//是否显示 x 轴</span>        polarIndex <span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//x 轴所在的 grid 的索引，默认位于第一个 grid</span>        type<span class="token punctuation">:</span><span class="token string">"category"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//坐标轴类型。'value' 数值轴，适用于连续数据。'category' 类目轴，适用于离散的类目数据，为该类型时必须通过 data 设置类目数据。</span>                                        <span class="token comment" spellcheck="true">// 'time' 时间轴，适用于连续的时序数据，与数值轴相比时间轴带有时间的格式化，在刻度计算上也有所不同，例如会根据跨度的范围来决定使用月，星期，日还是小时范围的刻度。'log' 对数轴。适用于对数数据</span>        name<span class="token punctuation">:</span><span class="token string">'时间'</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//坐标轴名称</span>        nameLocation<span class="token punctuation">:</span><span class="token string">"end"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴名称显示位置。可选：'start','middle','end'</span>        nameTextStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//坐标轴名称的文字样式</span>        nameGap<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴名称与轴线之间的距离</span>        nameRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴名字旋转，角度值</span>        inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否是反向坐标轴</span>        boundaryGap<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//类目轴中 boundaryGap 可以配置为 true 和 false。非类目轴，包括时间，数值，对数轴，boundaryGap是一个两个值的数组，分别表示数据最小值和最大值的延伸范围，可以直接设置数值或者相对的百分比，在设置 min 和 max 后无效['20%', '20%']</span>        min<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//坐标轴刻度最小值。可以设置成特殊值 'dataMin'，此时取数据在该轴上的最小值作为最小刻度。不设置时会自动计算最小值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        max<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//坐标轴刻度最大值。可以设置成特殊值 'dataMax'，此时取数据在该轴上的最大值作为最大刻度。不设置时会自动计算最大值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>        scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>        splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴的分割段数，需要注意的是这个分割段数只是个预估值，最后实际显示的段数会在这个基础上根据分割后坐标轴刻度显示的易读程度作调整</span>        minInterval<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//自动计算的坐标轴最小间隔大小,例如可以设置成1保证坐标轴分割刻度显示成整数。只在数值轴中（type: 'value'）有效。</span>        logBase<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//对数轴的底数，只在对数轴中（type: 'log'）有效</span>        silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>        triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>        axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//坐标 轴线</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>            onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>            alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>            interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>            length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>            lineStyle<span class="token punctuation">:</span>mylineStyle <span class="token comment" spellcheck="true">//</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>            inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>            rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>            margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>            formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>                <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>            showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>            textStyle<span class="token punctuation">:</span>mytextStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        splitLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔线。</span>            show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示分隔线。默认数值轴显示，类目轴不显示。</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//坐标轴分隔线的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，可以用数值表示间隔的数据，也可以通过回调函数控制。回调函数格式如下：</span>            lineStyle<span class="token punctuation">:</span>mylineStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        splitArea<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔区域，默认不显示。</span>            interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否显示分隔区域</span>            areaStyle<span class="token punctuation">:</span>myareaStyle        <span class="token punctuation">}</span><span class="token punctuation">,</span>        data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//类目数据，在类目轴（type: 'category'）中有效。</span>        zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//X 轴所有图形的 zlevel 值。</span>        z<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//X 轴组件的所有图形的z值</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>angleAxis<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">//y轴配置内容同x轴</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//角度轴所在的极坐标系的索引，默认使用第一个极坐标系</span>    startAngle<span class="token punctuation">:</span><span class="token number">90</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//起始刻度的角度，默认为 90 度，即圆心的正上方。0 度为圆心的正右方。</span>    clockwise<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//刻度增长是否按顺时针，默认顺时针。</span>    type<span class="token punctuation">:</span><span class="token string">"category"</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴类型。'value' 数值轴，适用于连续数据。'category' 类目轴，适用于离散的类目数据，为该类型时必须通过 data 设置类目数据。</span>                                          <span class="token comment" spellcheck="true">// 'time' 时间轴，适用于连续的时序数据，与数值轴相比时间轴带有时间的格式化，在刻度计算上也有所不同，例如会根据跨度的范围来决定使用月，星期，日还是小时范围的刻度。'log' 对数轴。适用于对数数据</span>    inverse<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//是否是反向坐标轴</span>    boundaryGap<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//类目轴中 boundaryGap 可以配置为 true 和 false。非类目轴，包括时间，数值，对数轴，boundaryGap是一个两个值的数组，分别表示数据最小值和最大值的延伸范围，可以直接设置数值或者相对的百分比，在设置 min 和 max 后无效['20%', '20%']</span>    min<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//坐标轴刻度最小值。可以设置成特殊值 'dataMin'，此时取数据在该轴上的最小值作为最小刻度。不设置时会自动计算最小值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>    max<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//坐标轴刻度最大值。可以设置成特殊值 'dataMax'，此时取数据在该轴上的最大值作为最大刻度。不设置时会自动计算最大值保证坐标轴刻度的均匀分布。在类目轴中，也可以设置为类目的序数</span>    scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>    splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//坐标轴的分割段数，需要注意的是这个分割段数只是个预估值，最后实际显示的段数会在这个基础上根据分割后坐标轴刻度显示的易读程度作调整</span>    minInterval<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//自动计算的坐标轴最小间隔大小,例如可以设置成1保证坐标轴分割刻度显示成整数。只在数值轴中（type: 'value'）有效。</span>    logBase<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//对数轴的底数，只在对数轴中（type: 'log'）有效</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>    triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>    axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                           <span class="token comment" spellcheck="true">//坐标 轴线</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>        onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>        lineStyle<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                         <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>        alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>        interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>        inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>        length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>        lineStyle<span class="token punctuation">:</span>mylineStyle <span class="token comment" spellcheck="true">//</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                         <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//是否显示</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>        inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>        rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>        margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>        formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>            <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>        showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>        textStyle<span class="token punctuation">:</span>mytextStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    splitLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔线。</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示分隔线。默认数值轴显示，类目轴不显示。</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//坐标轴分隔线的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，可以用数值表示间隔的数据，也可以通过回调函数控制。回调函数格式如下：</span>        lineStyle<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    splitArea<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔区域，默认不显示。</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否显示分隔区域</span>        areaStyle<span class="token punctuation">:</span>myareaStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'周一'</span><span class="token punctuation">,</span> <span class="token string">'周二'</span><span class="token punctuation">,</span> <span class="token string">'周三'</span><span class="token punctuation">,</span> <span class="token string">'周四'</span><span class="token punctuation">,</span> <span class="token string">'周五'</span><span class="token punctuation">,</span> <span class="token string">'周六'</span><span class="token punctuation">,</span> <span class="token string">'周日'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//类目数据，在类目轴（type: 'category'）中有效。</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//所属图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">//组件的所属图形的z值</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="radar雷达坐标系"><a href="#radar雷达坐标系" class="headerlink" title="radar雷达坐标系"></a>radar雷达坐标系</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>radar<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    center<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//中心（圆心）坐标，数组的第一项是横坐标，第二项是纵坐标。支持设置成百分比，设置成百分比时第一项是相对于容器宽度，第二项是相对于容器高度。</span>    radius<span class="token punctuation">:</span><span class="token string">"75%"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//数组的第一项是内半径，第二项是外半径。支持设置成百分比，相对于容器高宽中较小的一项的一半。</span>    startAngle<span class="token punctuation">:</span><span class="token number">90</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//起始刻度的角度，默认为 90 度，即圆心的正上方。0 度为圆心的正右方。</span>    name<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//雷达图每个指示器名称的配置项。</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示指示器名称。</span>        formatter<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> indicator<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//用回调函数，第一个参数是指示器名称，第二个参数是指示器配置项</span>            <span class="token keyword">return</span> <span class="token string">'【'</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'】'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        textStyle<span class="token punctuation">:</span>mytextStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    nameGap<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//指示器名称和指示器轴的距离</span>    splitNumber<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//指示器轴的分割段数</span>    scale<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//只在数值轴中（type: 'value'）有效。是否是脱离 0 值比例。设置成 true 后坐标刻度不会强制包含零刻度。在双数值轴的散点图中比较有用。在设置 min 和 max 之后该配置项无效。</span>    shape<span class="token punctuation">:</span><span class="token string">"polygon"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//雷达图绘制类型，支持 'polygon' 和 'circle'。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴是否是静态无法交互</span>    triggerEvent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//坐标轴的标签是否响应和触发鼠标事件</span>    axisLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                   <span class="token comment" spellcheck="true">//坐标 轴线</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//是否显示坐标轴轴线</span>        onZero<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//X 轴或者 Y 轴的轴线是否在另一个轴的 0 刻度上，只有在另一个轴为数值轴且包含 0 刻度时有效</span>        lineStyle<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    axisTick <span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度相关设置</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示坐标轴刻度。</span>        alignWithLabel<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//类目轴中在 boundaryGap 为 true 的时候有效，可以保证刻度线和标签对齐</span>        interval<span class="token punctuation">:</span>auto<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//坐标轴刻度的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>        inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//坐标轴刻度是否朝内，默认朝外。</span>        length<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴刻度的长度。</span>        lineStyle<span class="token punctuation">:</span>mylineStyle <span class="token comment" spellcheck="true">//</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    axisLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴刻度标签的相关设置</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否显示</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//坐标轴刻度标签的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，如果值为 2，表示隔两个标签显示一个标签，以此类推</span>        inside<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//刻度标签是否朝内，默认朝外</span>        rotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签旋转的角度，在类目轴的类目标签显示不下的时候可以通过旋转防止标签之间重叠。旋转的角度从 -90 度到 90 度</span>        margin<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//刻度标签与轴线之间的距离</span>        formatter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使用函数模板，函数参数分别为刻度数值（类目），刻度的索引</span>            <span class="token keyword">return</span> value<span class="token operator">+</span><span class="token string">"kg"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        showMinLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//是否显示最小 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最小 tick 的 label）</span>        showMaxLabel<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//是否显示最大 tick 的 label。可取值 true, false, null。默认自动判定（即如果标签重叠，不会显示最大 tick 的 label）</span>        textStyle<span class="token punctuation">:</span>mytextStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    splitLine<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔线。</span>        show<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//是否显示分隔线。默认数值轴显示，类目轴不显示。</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//坐标轴分隔线的显示间隔，在类目轴中有效。默认会采用标签不重叠的策略间隔显示标签。可以设置成 0 强制显示所有标签。如果设置为 1，表示『隔一个标签显示一个标签』，可以用数值表示间隔的数据，也可以通过回调函数控制。回调函数格式如下：</span>        lineStyle<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    splitArea<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//坐标轴在 grid 区域中的分隔区域，默认不显示。</span>        interval<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>        show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否显示分隔区域</span>        areaStyle<span class="token punctuation">:</span>myareaStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    indicator<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token comment" spellcheck="true">//雷达图的指示器，用来指定雷达图中的多个变量（维度）</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'销售（sales）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">6500</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'管理（Administration）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">16000</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'信息技术（Information Techology）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'客服（Customer Support）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">38000</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'研发（Development）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">52000</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'市场（Marketing）'</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">25000</span><span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//所属图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//组件的所属图形的z值</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h2 id="九种图表类型详解"><a href="#九种图表类型详解" class="headerlink" title="九种图表类型详解"></a>九种图表类型详解</h2><h3 id="series-bar柱形图详解"><a href="#series-bar柱形图详解" class="headerlink" title="series-bar柱形图详解"></a>series-bar柱形图详解</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"bar"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//柱形</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token string">"cartesian2d"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">////'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    stack<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//数据堆叠，同个类目轴上系列配置相同的stack值可以堆叠放置。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    barGap<span class="token punctuation">:</span><span class="token string">"30%"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//柱间距离，可设固定值（如 20）或者百分比（如 '30%'，表示柱子宽度的 30%）。</span>    barCategoryGap<span class="token punctuation">:</span><span class="token string">"20%"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//类目间柱形距离，默认为类目间距的20%，可设固定值</span>    encode<span class="token punctuation">:</span> <span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">//可以定义 data 的哪个维度被编码成什么</span>        x<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">// 表示维度 3、1、5 映射到 x 轴。</span>        y<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">// 表示维度 2 映射到 y 轴。</span>        tooltip<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 表示维度 3、2、4 会在 tooltip 中显示。</span>        label<span class="token punctuation">:</span> <span class="token number">3</span>                    <span class="token comment" spellcheck="true">// 表示 label 使用维度 3。</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                         <span class="token comment" spellcheck="true">//每一列称为一个『维度』。维度下标从0开始</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    markPoint<span class="token punctuation">:</span>mypoint<span class="token punctuation">.</span>data<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'最大值'</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'某个坐标'</span><span class="token punctuation">,</span> coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'固定 x 像素位置'</span><span class="token punctuation">,</span> yAxis<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token string">'90%'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'某个屏幕坐标'</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    markLine<span class="token punctuation">:</span>myline<span class="token punctuation">.</span>data<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'平均线'</span><span class="token punctuation">,</span>type<span class="token punctuation">:</span> <span class="token string">'average'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// 支持 'average', 'min', 'max'</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Y 轴值为 100 的水平线'</span><span class="token punctuation">,</span>yAxis<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'最小值到最大值'</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">'min'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 起点和终点的项会共用一个 name</span>            <span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'两个坐标之间的标线'</span><span class="token punctuation">,</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>yAxis<span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">,</span>x<span class="token punctuation">:</span> <span class="token string">'90%'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">// 固定起点的 x 像素位置，用于模拟一条指向最大值的水平线</span>            <span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'两个屏幕坐标之间的标线'</span><span class="token punctuation">,</span>x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>x<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>y<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    markArea<span class="token punctuation">:</span>myarea<span class="token punctuation">.</span>data<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'平均值到最大值'</span><span class="token punctuation">,</span>type<span class="token punctuation">:</span> <span class="token string">'average'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'两个坐标之间的标域'</span><span class="token punctuation">,</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'60分到80分'</span><span class="token punctuation">,</span>yAxis<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>yAxis<span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'所有数据范围区间'</span><span class="token punctuation">,</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">,</span> <span class="token string">'min'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>coord<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'两个屏幕坐标之间的标域'</span><span class="token punctuation">,</span>x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>x<span class="token punctuation">:</span> <span class="token string">'90%'</span><span class="token punctuation">,</span>y<span class="token punctuation">:</span> <span class="token string">'10%'</span><span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    tooltip<span class="token punctuation">:</span>tooltip<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-effectscatter特效散点图"><a href="#series-effectscatter特效散点图" class="headerlink" title="series-effectscatter特效散点图"></a>series-effectscatter特效散点图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"effectScatter"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//特效散点图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    hoverAnimation<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否开启鼠标 hover 的提示动画效果。</span>    effectType<span class="token punctuation">:</span><span class="token string">"ripple"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//特效类型，目前只支持涟漪特效'ripple'。</span>    showEffectOn<span class="token punctuation">:</span><span class="token string">"render"</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//配置何时显示特效。可选：'render' 绘制完成后显示特效。'emphasis' 高亮（hover）的时候显示特效。</span>    rippleEffect<span class="token punctuation">:</span><span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//涟漪特效相关配置。</span>        period<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//动画的时间。</span>        scale<span class="token punctuation">:</span><span class="token number">2.5</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//动画中波纹的最大缩放比例。</span>        brushType<span class="token punctuation">:</span><span class="token string">'fill'</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//波纹的绘制方式，可选 'stroke' 和 'fill'。</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    coordinateSystem<span class="token punctuation">:</span><span class="token string">"geo"</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的极坐标系的 index，在单个图表实例中存在多个极坐标系的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    calendarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//使用的日历坐标系的 index，在单个图表实例中存在多个日历坐标系的时候有用。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    large<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否开启大规模散点图的优化，在数据图形特别多的时候（>=5k）可以开启。开启后配合 largeThreshold 在数据量大于指定阈值的时候对绘制进行优化。缺点：优化后不能自定义设置单个数据项的样式。</span>    largeThreshold<span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//开启绘制优化的阈值。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    encode<span class="token punctuation">:</span> <span class="token punctuation">{</span>                   <span class="token comment" spellcheck="true">//可以定义 data 的哪个维度被编码成什么</span>        x<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">// 表示维度 3、1、5 映射到 x 轴。</span>        y<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">// 表示维度 2 映射到 y 轴。</span>        tooltip<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 表示维度 3、2、4 会在 tooltip 中显示。</span>        label<span class="token punctuation">:</span> <span class="token number">3</span>                <span class="token comment" spellcheck="true">// 表示 label 使用维度 3。</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                     <span class="token comment" spellcheck="true">//每一列称为一个『维度』。维度下标从0开始</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-graph关系图"><a href="#series-graph关系图" class="headerlink" title="series-graph关系图"></a>series-graph关系图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"graph"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//关系图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    width<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图例宽度</span>    height<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图例高度</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    hoverAnimation<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否开启鼠标 hover 节点的提示动画效果。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//null无坐标系，'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系，'polar'使用极坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的极坐标系的 index，在单个图表实例中存在多个极坐标系的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    calendarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//使用的日历坐标系的 index，在单个图表实例中存在多个日历坐标系的时候有用。</span>    layout<span class="token punctuation">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//'none' 不采用任何布局，使用节点中提供的 x， y 作为节点的位置.'circular' 采用环形布局，'force' 采用力引导布局。</span>    <span class="token comment" spellcheck="true">//circular:{},               //环形布局相关配置</span>    <span class="token comment" spellcheck="true">//force:{},                  //力引导布局相关的配置项</span>    roam<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移，可以设置成 'scale' 或者 'move'。设置成 true 为都开启</span>    nodeScaleRatio<span class="token punctuation">:</span><span class="token number">0.6</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//鼠标漫游缩放时节点的相应缩放比例，当设为0时节点不随着鼠标的缩放而缩放</span>    draggable<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//节点是否可拖拽，只在使用力引导布局的时候有用。</span>    focusNodeAdjacency<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//是否在鼠标移到节点上的时候突出显示节点以及节点的边和邻接节点。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    edgeSymbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'circle'</span><span class="token punctuation">,</span> <span class="token string">'arrow'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//边两端的标记类型，可以是一个数组分别指定两端，也可以是单个统一指定。默认不显示标记，常见的可以设置为箭头</span>    edgeSymbolSize<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//边两端的标记大小，可以是一个数组分别指定两端，也可以是单个统一指定。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    edgeLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    categories<span class="token punctuation">:</span><span class="token punctuation">[</span>                <span class="token comment" spellcheck="true">//节点分类的类目，可选。</span>        <span class="token punctuation">{</span>            name<span class="token punctuation">:</span><span class="token string">"类目名称"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//类目名称</span>            symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>            symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>            symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>            symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>            label<span class="token punctuation">:</span><span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>                normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>                emphasis<span class="token punctuation">:</span>mylabel            <span class="token punctuation">}</span><span class="token punctuation">,</span>            itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>                normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>                emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                     <span class="token comment" spellcheck="true">//data就是node</span>        <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>        x<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>        y<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>        value<span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>        x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>        y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>        value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        symbolSize<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        itemStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>            normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                color<span class="token punctuation">:</span> <span class="token string">'red'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    links<span class="token punctuation">:</span><span class="token punctuation">[</span>                 <span class="token comment" spellcheck="true">//links就是edges</span>        <span class="token punctuation">{</span>            source<span class="token punctuation">:</span> <span class="token string">'n1'</span><span class="token punctuation">,</span>            target<span class="token punctuation">:</span> <span class="token string">'n2'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            source<span class="token punctuation">:</span> <span class="token string">'n2'</span><span class="token punctuation">,</span>            target<span class="token punctuation">:</span> <span class="token string">'n3'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span>mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"graph"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//关系图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    width<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图例宽度</span>    height<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图例高度</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    hoverAnimation<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否开启鼠标 hover 节点的提示动画效果。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//null无坐标系，'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系，'polar'使用极坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的极坐标系的 index，在单个图表实例中存在多个极坐标系的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    calendarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//使用的日历坐标系的 index，在单个图表实例中存在多个日历坐标系的时候有用。</span>    layout<span class="token punctuation">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//'none' 不采用任何布局，使用节点中提供的 x， y 作为节点的位置.'circular' 采用环形布局，'force' 采用力引导布局。</span>    <span class="token comment" spellcheck="true">//circular:{},               //环形布局相关配置</span>    <span class="token comment" spellcheck="true">//force:{},                  //力引导布局相关的配置项</span>    roam<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移，可以设置成 'scale' 或者 'move'。设置成 true 为都开启</span>    nodeScaleRatio<span class="token punctuation">:</span><span class="token number">0.6</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//鼠标漫游缩放时节点的相应缩放比例，当设为0时节点不随着鼠标的缩放而缩放</span>    draggable<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//节点是否可拖拽，只在使用力引导布局的时候有用。</span>    focusNodeAdjacency<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//是否在鼠标移到节点上的时候突出显示节点以及节点的边和邻接节点。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    edgeSymbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'circle'</span><span class="token punctuation">,</span> <span class="token string">'arrow'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//边两端的标记类型，可以是一个数组分别指定两端，也可以是单个统一指定。默认不显示标记，常见的可以设置为箭头</span>    edgeSymbolSize<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//边两端的标记大小，可以是一个数组分别指定两端，也可以是单个统一指定。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    edgeLabel<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    categories<span class="token punctuation">:</span><span class="token punctuation">[</span>                <span class="token comment" spellcheck="true">//节点分类的类目，可选。</span>        <span class="token punctuation">{</span>            name<span class="token punctuation">:</span><span class="token string">"类目名称"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//类目名称</span>            symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>            symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>            symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>            symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>            label<span class="token punctuation">:</span><span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>                normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>                emphasis<span class="token punctuation">:</span>mylabel            <span class="token punctuation">}</span><span class="token punctuation">,</span>            itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>                normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>                emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                     <span class="token comment" spellcheck="true">//data就是node</span>        <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>        x<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>        y<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>        value<span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>        x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>        y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>        value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        symbolSize<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        itemStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>            normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                color<span class="token punctuation">:</span> <span class="token string">'red'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    links<span class="token punctuation">:</span><span class="token punctuation">[</span>                 <span class="token comment" spellcheck="true">//links就是edges</span>        <span class="token punctuation">{</span>            source<span class="token punctuation">:</span> <span class="token string">'n1'</span><span class="token punctuation">,</span>            target<span class="token punctuation">:</span> <span class="token string">'n2'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            source<span class="token punctuation">:</span> <span class="token string">'n2'</span><span class="token punctuation">,</span>            target<span class="token punctuation">:</span> <span class="token string">'n3'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-heatmap热力图"><a href="#series-heatmap热力图" class="headerlink" title="series-heatmap热力图"></a>series-heatmap热力图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"heatmap"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//热力图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token string">"geo"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的极坐标系的 index，在单个图表实例中存在多个极坐标系的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    calendarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//使用的日历坐标系的 index，在单个图表实例中存在多个日历坐标系的时候有用。</span>    blurSize<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//每个点模糊的大小，在地理坐标系(coordinateSystem: 'geo')上有效。</span>    minOpacity<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//最小的透明度，在地理坐标系(coordinateSystem: 'geo')上有效。</span>    maxOpacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//最大的透明度，在地理坐标系(coordinateSystem: 'geo')上有效。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token comment" spellcheck="true">//每一列称为一个『维度』。维度下标从0开始</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-line线图"><a href="#series-line线图" class="headerlink" title="series-line线图"></a>series-line线图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"lines"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//线图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token string">"geo"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    polyline<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否是多段线。默认为 false，只能用于绘制只有两个端点的线段，线段可以通过 lineStyle.normal.curveness 配置为曲线。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    large<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否开启大规模散点图的优化，在数据图形特别多的时候（>=5k）可以开启。开启后配合 largeThreshold 在数据量大于指定阈值的时候对绘制进行优化。缺点：优化后不能自定义设置单个数据项的样式。</span>    largeThreshold<span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//开启绘制优化的阈值。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">122</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            lineStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>normal<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-map地图"><a href="#series-map地图" class="headerlink" title="series-map地图"></a>series-map地图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"map"</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//地图数据表</span>    map<span class="token punctuation">:</span><span class="token string">"china"</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//地图类型。world世界地图，china中国地图</span>    roam<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移，可以设置成 'scale' 或者 'move'。设置成 true 为都开启</span>    center<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">115.97</span><span class="token punctuation">,</span> <span class="token number">29.71</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//当前视角的中心点，用经纬度表示</span>    aspectScale<span class="token punctuation">:</span><span class="token number">0.75</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true">//这个参数用于 scale 地图的长宽比。</span>    boundingCoords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//二维数组，定义定位的左上角以及右下角分别所对应的经纬度</span>    zoom<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                     <span class="token comment" spellcheck="true">//当前视角的缩放比例</span>    scaleLimit<span class="token punctuation">:</span><span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">//所属组件的z分层，z值小的图形会被z值大的图形覆盖</span>        min<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//最小的缩放值</span>        max<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">//最大的缩放值</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    nameMap<span class="token punctuation">:</span><span class="token punctuation">{</span>                                   <span class="token comment" spellcheck="true">//自定义地区的名称映射</span>        <span class="token string">'China'</span> <span class="token punctuation">:</span> <span class="token string">'中国'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    selectedMode<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//选中模式，表示是否支持多个选中，默认关闭，支持布尔值和字符串，字符串取值可选'single'表示单选，或者'multiple'表示多选。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                                     <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等</span>        normal<span class="token punctuation">:</span><span class="token punctuation">{</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//是否在普通状态下显示标签。</span>            textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//普通状态下的标签文本样式。</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span><span class="token punctuation">{</span>            show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//是否在高亮状态下显示标签。</span>            textStyle<span class="token punctuation">:</span>mytextStyle              <span class="token comment" spellcheck="true">//高亮状态下的标签文本样式。</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                                 <span class="token comment" spellcheck="true">//地图区域的多边形 图形样式</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">,</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">//所属图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                                         <span class="token comment" spellcheck="true">//所属图形的 z 值。</span>    left<span class="token punctuation">:</span><span class="token string">"10%"</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//组件离容器左侧的距离,百分比字符串或整型数字</span>    top<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">,</span>                                      <span class="token comment" spellcheck="true">//组件离容器上侧的距离，百分比字符串或整型数字</span>    right<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">//组件离容器右侧的距离,百分比字符串或整型数字</span>    bottom<span class="token punctuation">:</span><span class="token string">"auto"</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//组件离容器下侧的距离,百分比字符串或整型数字</span>    layoutCenter<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'30%'</span><span class="token punctuation">,</span> <span class="token string">'30%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//地图中心在屏幕中的位置</span>    layoutSize<span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//地图的大小,支持相对于屏幕宽高的百分比或者绝对的像素大小。</span>    mapValueCalculation<span class="token punctuation">:</span><span class="token string">"sum"</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//多个拥有相同地图类型的系列会使用同一个地图展现，如果多个系列都在同一个区域有值，目前有：'sum' 取和。'average' 取平均值。'max' 取最大值。'min' 取最小值。</span>    showLegendSymbol<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//在图例相应区域显示图例的颜色标识（系列标识的小圆点），存在 legend 组件时生效。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'数据1'</span><span class="token punctuation">,</span>value<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'数据2'</span><span class="token punctuation">,</span>value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-pie饼图"><a href="#series-pie饼图" class="headerlink" title="series-pie饼图"></a>series-pie饼图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"pie"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//饼图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    center<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//饼图的中心（圆心）坐标，数组的第一项是横坐标，第二项是纵坐标。支持设置成百分比，设置成百分比时第一项是相对于容器宽度，第二项是相对于容器高度。</span>    radius<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'75%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//饼图的半径，数组的第一项是内半径，第二项是外半径。支持设置成百分比，相对于容器高宽中较小的一项的一半。可以将内半径设大显示成圆环图（Donut chart）。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    hoverAnimation<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否开启 hover 在扇区上的放大动画效果。</span>    selectedMode<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//选中模式，表示是否支持多个选中，默认关闭，支持布尔值和字符串，字符串取值可选'single'，'multiple'，分别表示单选还是多选。</span>    selectedOffset<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//选中扇区的偏移距离。</span>    clockwise<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//饼图的扇区是否是顺时针排布。</span>    startAngle<span class="token punctuation">:</span><span class="token number">90</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//起始角度，支持范围[0, 360]。</span>    minAngle<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//最小的扇区角度（0 ~ 360），用于防止某个值过小导致扇区太小影响交互。</span>    roseType<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否展示成南丁格尔图，通过半径区分数据大小。可选择两种模式：'radius' 扇区圆心角展现数据的百分比，半径展现数据的大小。'area' 所有扇区圆心角相同，仅通过半径展现数据大小。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span><span class="token punctuation">[</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'数据1'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'数据2'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip  <span class="token comment" spellcheck="true">//index,js</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-radar雷达图"><a href="#series-radar雷达图" class="headerlink" title="series-radar雷达图"></a>series-radar雷达图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>mylabel<span class="token punctuation">,</span> mytextStyle<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//mylabel对象和mytextStyle对象合并成mylabel对象</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"radar"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//雷达图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    radarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//雷达图所使用的 radar 组件的 index。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    areaStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myareaStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myareaStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                     <span class="token comment" spellcheck="true">//每一列称为一个『维度』。维度下标从0开始</span>        <span class="token punctuation">{</span>            value <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4300</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">28000</span><span class="token punctuation">,</span> <span class="token number">35000</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token number">19000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            name <span class="token punctuation">:</span> <span class="token string">'预算分配（Allocated Budget）'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            value <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token number">14000</span><span class="token punctuation">,</span> <span class="token number">28000</span><span class="token punctuation">,</span> <span class="token number">31000</span><span class="token punctuation">,</span> <span class="token number">42000</span><span class="token punctuation">,</span> <span class="token number">21000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            name <span class="token punctuation">:</span> <span class="token string">'实际开销（Actual Spending）'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    tooltip<span class="token punctuation">:</span>tooltip  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h3 id="series-scatter散点图"><a href="#series-scatter散点图" class="headerlink" title="series-scatter散点图"></a>series-scatter散点图</h3><pre class=" language-javascript"><code class="language-javascript">mytextStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//文字颜色</span>    fontStyle<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//italic斜体  oblique倾斜</span>    fontWeight<span class="token punctuation">:</span><span class="token string">"normal"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//文字粗细bold   bolder   lighter  100 | 200 | 300 | 400...</span>    fontFamily<span class="token punctuation">:</span><span class="token string">"sans-serif"</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//字体系列</span>    fontSize<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//字体大小</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylineStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"#333"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//颜色，'rgb(128, 128, 128)'，'rgba(128, 128, 128, 0.5)'，支持线性渐变，径向渐变，纹理填充</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    type<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//坐标轴线线的类型，solid，dashed，dotted</span>    width<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//坐标轴线线宽</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myareaStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'rgba(250,250,250,0.3)'</span><span class="token punctuation">,</span><span class="token string">'rgba(200,200,200,0.3)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//分隔区域颜色。分隔区域会按数组中颜色的顺序依次循环设置颜色。默认是一个深浅的间隔色。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myitemStyle<span class="token operator">=</span><span class="token punctuation">{</span>    color<span class="token punctuation">:</span><span class="token string">"red"</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//颜色</span>    borderColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//边框颜色</span>    borderWidth<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//柱条的描边宽度，默认不描边。</span>    borderType<span class="token punctuation">:</span><span class="token string">"solid"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//柱条的描边类型，默认为实线，支持 'dashed', 'dotted'。</span>    barBorderRadius<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//柱形边框圆角半径，单位px，支持传入数组分别指定柱形4个圆角半径。</span>    shadowBlur<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//图形阴影的模糊大小。</span>    shadowColor<span class="token punctuation">:</span><span class="token string">"#000"</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//阴影颜色</span>    shadowOffsetX<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影水平方向上的偏移距离。</span>    shadowOffsetY<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//阴影垂直方向上的偏移距离。</span>    opacity<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//图形透明度。支持从 0 到 1 的数字，为 0 时不绘制该图形。</span><span class="token punctuation">}</span><span class="token punctuation">;</span>mylabel<span class="token operator">=</span><span class="token punctuation">{</span>    show<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//是否显示标签。</span>    position<span class="token punctuation">:</span><span class="token string">"inside"</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//标签的位置。// 绝对的像素值[10, 10],// 相对的百分比['50%', '50%'].'top','left','right','bottom','inside','insideLeft','insideRight','insideTop','insideBottom','insideTopLeft','insideBottomLeft','insideTopRight','insideBottomRight'</span>    offset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//是否对文字进行偏移。默认不偏移。例如：[30, 40] 表示文字在横向上偏移 30，纵向上偏移 40。</span>    formatter<span class="token punctuation">:</span><span class="token string">'{b}: {c}'</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。</span>    textStyle<span class="token punctuation">:</span>mytextStyle<span class="token punctuation">}</span><span class="token punctuation">;</span>mypoint<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myline<span class="token operator">=</span><span class="token punctuation">{</span>    symbol<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"pin"</span><span class="token punctuation">,</span><span class="token string">"circle"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    precision<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//标线数值的精度，在显示平均值线的时候有用。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    lineStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylineStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylineStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>myarea<span class="token operator">=</span><span class="token punctuation">{</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>    type<span class="token punctuation">:</span><span class="token string">"scatter"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//散点图</span>    zlevel<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//柱状图所有图形的 zlevel 值。</span>    z<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//柱状图组件的所有图形的z值。控制图形的前后顺序。z值小的图形会被z值大的图形覆盖。</span>    silent<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形是否不响应和触发鼠标事件，默认为 false，即响应和触发鼠标事件。</span>    name<span class="token punctuation">:</span><span class="token string">"数据名称"</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//系列名称，用于tooltip的显示，legend 的图例筛选，在 setOption 更新数据和配置项时用于指定对应的系列。</span>    legendHoverLink<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//是否启用图例 hover 时的联动高亮。</span>    hoverAnimation<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//是否开启鼠标 hover 的提示动画效果。</span>    coordinateSystem<span class="token punctuation">:</span><span class="token string">"geo"</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//'cartesian2d'使用二维的直角坐标系。'geo'使用地理坐标系</span>    xAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 x 轴的 index，在单个图表实例中存在多个 x 轴的时候有用。</span>    yAxisIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的 y 轴的 index，在单个图表实例中存在多个 y轴的时候有用。</span>    polarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//使用的极坐标系的 index，在单个图表实例中存在多个极坐标系的时候有用。</span>    geoIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">//使用的地理坐标系的 index，在单个图表实例中存在多个地理坐标系的时候有用。</span>    calendarIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//使用的日历坐标系的 index，在单个图表实例中存在多个日历坐标系的时候有用。</span>    symbol<span class="token punctuation">:</span><span class="token string">"pin"</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">//图形 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'</span>    symbolSize<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true">//标记的大小，可以设置成诸如 10 这样单一的数字，也可以用数组分开表示宽和高，例如 [20, 10] 表示标记宽为20，高为10。</span>    symbolRotate<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//标记的旋转角度。注意在 markLine 中当 symbol 为 'arrow' 时会忽略 symbolRotate 强制设置为切线的角度。</span>    symbolOffset<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//标记相对于原本位置的偏移。默认情况下，标记会居中置放在数据对应的位置</span>    large<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//是否开启大规模散点图的优化，在数据图形特别多的时候（>=5k）可以开启。开启后配合 largeThreshold 在数据量大于指定阈值的时候对绘制进行优化。缺点：优化后不能自定义设置单个数据项的样式。</span>    largeThreshold<span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//开启绘制优化的阈值。</span>    cursor<span class="token punctuation">:</span><span class="token string">"pointer"</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">//鼠标悬浮时在图形元素上时鼠标的样式是什么。同 CSS 的 cursor。</span>    label<span class="token punctuation">:</span><span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">//图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等，</span>        normal<span class="token punctuation">:</span>mylabel<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>mylabel    <span class="token punctuation">}</span><span class="token punctuation">,</span>    itemStyle<span class="token punctuation">:</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//图形样式，normal 是图形在默认状态下的样式；emphasis 是图形在高亮状态下的样式，比如在鼠标悬浮或者图例联动高亮时。</span>        normal<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>        emphasis<span class="token punctuation">:</span>myitemStyle<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    encode<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//可以定义 data 的哪个维度被编码成什么</span>        x<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">// 表示维度 3、1、5 映射到 x 轴。</span>        y<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">// 表示维度 2 映射到 y 轴。</span>        tooltip<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 表示维度 3、2、4 会在 tooltip 中显示。</span>        label<span class="token punctuation">:</span> <span class="token number">3</span>                 <span class="token comment" spellcheck="true">// 表示 label 使用维度 3。</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token comment" spellcheck="true">//每一列称为一个『维度』。维度下标从0开始</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//markPoint:同bar</span>    <span class="token comment" spellcheck="true">//markLine:同bar</span>    <span class="token comment" spellcheck="true">//markArea:同bar</span>    tooltip<span class="token punctuation">:</span>tooltip  <span class="token comment" spellcheck="true">//index.js</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>参考：<a href="https://blog.csdn.net/luanpeng825485697/article/details/76739026" target="_blank" rel="noopener">https://blog.csdn.net/luanpeng825485697/article/details/76739026</a></p><p>​    </p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> api </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VUE中使用Echarts</title>
      <link href="/2020/03/10/vue-zhong-shi-yong-echarts/"/>
      <url>/2020/03/10/vue-zhong-shi-yong-echarts/</url>
      
        <content type="html"><![CDATA[<p>最近公司开发做报表统计，需要用到echarts。官网上的echarts是操作dom节点来初始化画布的，那么在使用vue作为前端开发框架的时候，这种方式显然不够优雅。于是想着把echarts封装成一个公共组件，在需要使用的地方直接引用组件，通过组件参数传入相应的数据即可。故在此记录下来，不过在我把echarts封装成组件后，发现在NPM库中有一个别人封装好的组件可以直接使用叫<code>vue-echarts</code>，但在封装过程中也有收获，体会到了vue组件化思想的强大能力。自己封装了可以个性化的东西更多，用开源vue组件可以直接上手，拿来主义；算各有优势吧。下面我将介绍这两种方式</p><p><img src="/2020/03/10/vue-zhong-shi-yong-echarts/1.png" alt></p><h2 id="一-组件化Echarts"><a href="#一-组件化Echarts" class="headerlink" title="一. 组件化Echarts"></a>一. 组件化Echarts</h2><p>首先先在项目中导入echarts，这里通过npm命令导入即可。然后再把echarts挂载到vue的原型链上，以便组件中直接引用原生的echarts组件，命令如下</p><pre class=" language-shell"><code class="language-shell">npm install echarts --save</code></pre><p>然后在项目的main.js中挂载echarts到vue的原型链上</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> Echarts <span class="token keyword">from</span> <span class="token string">'echarts'</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Echarts<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="封装echarts"><a href="#封装echarts" class="headerlink" title="封装echarts"></a>封装echarts</h4><p>在工程中创建一个base目录，用于存放项目中最基础的组件，将要封装echarts组件放在这个目录下，并命名为<code>BaseEcharts.vue</code>，当然这个命名随个人喜好。组件代码如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>    <span class="token operator">&lt;</span>div<span class="token operator">></span>      <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"echarts"</span> <span class="token punctuation">:</span>id<span class="token operator">=</span><span class="token string">"randomId"</span> style<span class="token operator">=</span><span class="token string">"height: 100%"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/ecmascript-6"</span><span class="token operator">></span>    <span class="token keyword">import</span> echarts <span class="token keyword">from</span> <span class="token string">'echarts'</span>    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'echarts'</span><span class="token punctuation">,</span>        props<span class="token punctuation">:</span> <span class="token punctuation">{</span>            option<span class="token punctuation">:</span> <span class="token punctuation">{</span>                type<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>                <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            randomId<span class="token punctuation">:</span> <span class="token punctuation">{</span>                type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>                <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token string">'myChart'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//# 1. 获取一个用于挂在 echarts 的 DOM 元素</span>            <span class="token keyword">let</span> $echartsDOM <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>randomId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//# 2. 初始化</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>$echartsDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAndSetOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//组件卸载释放chart内存</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//清空图表</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//释放图表组件</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token function">option</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAndSetOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token function">checkAndSetOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">function</span> <span class="token function">isValidOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEmptyObject</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>                        <span class="token operator">&amp;&amp;</span> <span class="token function">hasSeriesKey</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>                        <span class="token operator">&amp;&amp;</span> <span class="token function">isSeriesArray</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSeriesEmpty</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>                <span class="token punctuation">}</span>                <span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>                <span class="token punctuation">}</span>                <span class="token keyword">function</span> <span class="token function">isEmptyObject</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span>                <span class="token punctuation">}</span>                <span class="token keyword">function</span> <span class="token function">hasSeriesKey</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>option<span class="token punctuation">[</span><span class="token string">'series'</span><span class="token punctuation">]</span>                <span class="token punctuation">}</span>                <span class="token keyword">function</span> <span class="token function">isSeriesArray</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>option<span class="token punctuation">[</span><span class="token string">'series'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>                <span class="token keyword">function</span> <span class="token function">isSeriesEmpty</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> option<span class="token punctuation">[</span><span class="token string">'series'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span>                <span class="token punctuation">}</span>                <span class="token keyword">let</span> option <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//配置等于父组件传过来的数据</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isValidOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//渲染出来</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//隐藏加载动画</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>myEcharts<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//加载动画</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>创建一个测试组件<code>MyEcharts.vue</code>，在该组件中引入刚刚封装好的BaseEcharts组件，直接使用就可以了</p><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"block"</span> style<span class="token operator">=</span><span class="token string">"padding: 15px"</span><span class="token operator">></span>      <span class="token operator">&lt;</span>chart <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"echarts-container"</span> <span class="token punctuation">:</span>randomId<span class="token operator">=</span><span class="token string">"chart1"</span> <span class="token punctuation">:</span>option<span class="token operator">=</span><span class="token string">"option1"</span> style<span class="token operator">=</span><span class="token string">"height: 600px;width: 45%;display: inline-block;margin: 10px"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>chart<span class="token operator">></span>      <span class="token operator">&lt;</span>chart <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"echarts-container"</span> <span class="token punctuation">:</span>randomId<span class="token operator">=</span><span class="token string">"chart4"</span> <span class="token punctuation">:</span>option<span class="token operator">=</span><span class="token string">"option4"</span> style<span class="token operator">=</span><span class="token string">"height: 600px;width: 45%;display: inline-block;margin: 10px"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>chart<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/ecmascript-6"</span><span class="token operator">></span>    <span class="token keyword">import</span> chart <span class="token keyword">from</span> <span class="token string">'../base/Echarts'</span>    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>        name<span class="token punctuation">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>        components<span class="token punctuation">:</span> <span class="token punctuation">{</span>            chart        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">{</span>                chart1<span class="token punctuation">:</span><span class="token string">'chart1'</span><span class="token punctuation">,</span>                chart4<span class="token punctuation">:</span><span class="token string">'chart4'</span><span class="token punctuation">,</span>                option1<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                option4<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//柱状图</span>              <span class="token keyword">this</span><span class="token punctuation">.</span>option1<span class="token operator">=</span><span class="token punctuation">{</span>                  title <span class="token punctuation">:</span> <span class="token punctuation">{</span>                      text<span class="token punctuation">:</span> <span class="token string">'某地区蒸发量和降水量'</span><span class="token punctuation">,</span>                      subtext<span class="token punctuation">:</span> <span class="token string">'纯属虚构'</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  tooltip <span class="token punctuation">:</span> <span class="token punctuation">{</span>                      trigger<span class="token punctuation">:</span> <span class="token string">'axis'</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  legend<span class="token punctuation">:</span> <span class="token punctuation">{</span>                      data<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'蒸发量'</span><span class="token punctuation">,</span><span class="token string">'降水量'</span><span class="token punctuation">]</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  toolbox<span class="token punctuation">:</span> <span class="token punctuation">{</span>                      show <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                      feature <span class="token punctuation">:</span> <span class="token punctuation">{</span>                          dataView <span class="token punctuation">:</span> <span class="token punctuation">{</span>show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> readOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                          magicType <span class="token punctuation">:</span> <span class="token punctuation">{</span>show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                          restore <span class="token punctuation">:</span> <span class="token punctuation">{</span>show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                          saveAsImage <span class="token punctuation">:</span> <span class="token punctuation">{</span>show<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  calculable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                  xAxis <span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">{</span>                          type <span class="token punctuation">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>                          data <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'1月'</span><span class="token punctuation">,</span><span class="token string">'2月'</span><span class="token punctuation">,</span><span class="token string">'3月'</span><span class="token punctuation">,</span><span class="token string">'4月'</span><span class="token punctuation">,</span><span class="token string">'5月'</span><span class="token punctuation">,</span><span class="token string">'6月'</span><span class="token punctuation">,</span><span class="token string">'7月'</span><span class="token punctuation">,</span><span class="token string">'8月'</span><span class="token punctuation">,</span><span class="token string">'9月'</span><span class="token punctuation">,</span><span class="token string">'10月'</span><span class="token punctuation">,</span><span class="token string">'11月'</span><span class="token punctuation">,</span><span class="token string">'12月'</span><span class="token punctuation">]</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">]</span><span class="token punctuation">,</span>                  yAxis <span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">{</span>                          type <span class="token punctuation">:</span> <span class="token string">'value'</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">]</span><span class="token punctuation">,</span>                  series <span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">{</span>                          name<span class="token punctuation">:</span><span class="token string">'蒸发量'</span><span class="token punctuation">,</span>                          type<span class="token punctuation">:</span><span class="token string">'bar'</span><span class="token punctuation">,</span>                          data<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.9</span><span class="token punctuation">,</span> <span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token number">23.2</span><span class="token punctuation">,</span> <span class="token number">25.6</span><span class="token punctuation">,</span> <span class="token number">76.7</span><span class="token punctuation">,</span> <span class="token number">135.6</span><span class="token punctuation">,</span> <span class="token number">162.2</span><span class="token punctuation">,</span> <span class="token number">32.6</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">6.4</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          markPoint <span class="token punctuation">:</span> <span class="token punctuation">{</span>                              data <span class="token punctuation">:</span> <span class="token punctuation">[</span>                                  <span class="token punctuation">{</span>type <span class="token punctuation">:</span> <span class="token string">'max'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'最大值'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                                  <span class="token punctuation">{</span>type <span class="token punctuation">:</span> <span class="token string">'min'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'最小值'</span><span class="token punctuation">}</span>                              <span class="token punctuation">]</span>                          <span class="token punctuation">}</span><span class="token punctuation">,</span>                          markLine <span class="token punctuation">:</span> <span class="token punctuation">{</span>                              data <span class="token punctuation">:</span> <span class="token punctuation">[</span>                                  <span class="token punctuation">{</span>type <span class="token punctuation">:</span> <span class="token string">'average'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'平均值'</span><span class="token punctuation">}</span>                              <span class="token punctuation">]</span>                          <span class="token punctuation">}</span>                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                      <span class="token punctuation">{</span>                          name<span class="token punctuation">:</span><span class="token string">'降水量'</span><span class="token punctuation">,</span>                          type<span class="token punctuation">:</span><span class="token string">'bar'</span><span class="token punctuation">,</span>                          data<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">2.6</span><span class="token punctuation">,</span> <span class="token number">5.9</span><span class="token punctuation">,</span> <span class="token number">9.0</span><span class="token punctuation">,</span> <span class="token number">26.4</span><span class="token punctuation">,</span> <span class="token number">28.7</span><span class="token punctuation">,</span> <span class="token number">70.7</span><span class="token punctuation">,</span> <span class="token number">175.6</span><span class="token punctuation">,</span> <span class="token number">182.2</span><span class="token punctuation">,</span> <span class="token number">48.7</span><span class="token punctuation">,</span> <span class="token number">18.8</span><span class="token punctuation">,</span> <span class="token number">6.0</span><span class="token punctuation">,</span> <span class="token number">2.3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          markPoint <span class="token punctuation">:</span> <span class="token punctuation">{</span>                              data <span class="token punctuation">:</span> <span class="token punctuation">[</span>                                  <span class="token punctuation">{</span>name <span class="token punctuation">:</span> <span class="token string">'年最高'</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token number">182.2</span><span class="token punctuation">,</span> xAxis<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> yAxis<span class="token punctuation">:</span> <span class="token number">183</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                                  <span class="token punctuation">{</span>name <span class="token punctuation">:</span> <span class="token string">'年最低'</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token number">2.3</span><span class="token punctuation">,</span> xAxis<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> yAxis<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>                              <span class="token punctuation">]</span>                          <span class="token punctuation">}</span><span class="token punctuation">,</span>                          markLine <span class="token punctuation">:</span> <span class="token punctuation">{</span>                              data <span class="token punctuation">:</span> <span class="token punctuation">[</span>                                  <span class="token punctuation">{</span>type <span class="token punctuation">:</span> <span class="token string">'average'</span><span class="token punctuation">,</span> name <span class="token punctuation">:</span> <span class="token string">'平均值'</span><span class="token punctuation">}</span>                              <span class="token punctuation">]</span>                          <span class="token punctuation">}</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">]</span>              <span class="token punctuation">}</span><span class="token punctuation">;</span>              <span class="token keyword">this</span><span class="token punctuation">.</span>option4 <span class="token operator">=</span> <span class="token punctuation">{</span>                  backgroundColor<span class="token punctuation">:</span> <span class="token string">'#2c343c'</span><span class="token punctuation">,</span>                  title<span class="token punctuation">:</span> <span class="token punctuation">{</span>                      text<span class="token punctuation">:</span> <span class="token string">'Customized Pie'</span><span class="token punctuation">,</span>                      left<span class="token punctuation">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>                      top<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>                      textStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>                          color<span class="token punctuation">:</span> <span class="token string">'#ccc'</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  tooltip <span class="token punctuation">:</span> <span class="token punctuation">{</span>                      trigger<span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">,</span>                      formatter<span class="token punctuation">:</span> <span class="token string">"{a} &lt;br/>{b} : {c} ({d}%)"</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  visualMap<span class="token punctuation">:</span> <span class="token punctuation">{</span>                      show<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                      min<span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>                      max<span class="token punctuation">:</span> <span class="token number">600</span><span class="token punctuation">,</span>                      inRange<span class="token punctuation">:</span> <span class="token punctuation">{</span>                          colorLightness<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                  series <span class="token punctuation">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">{</span>                          name<span class="token punctuation">:</span><span class="token string">'访问来源'</span><span class="token punctuation">,</span>                          type<span class="token punctuation">:</span><span class="token string">'pie'</span><span class="token punctuation">,</span>                          radius <span class="token punctuation">:</span> <span class="token string">'55%'</span><span class="token punctuation">,</span>                          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'50%'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          data<span class="token punctuation">:</span><span class="token punctuation">[</span>                              <span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token number">335</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token string">'直接访问'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token number">310</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token string">'邮件营销'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token number">274</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token string">'联盟广告'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token number">235</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token string">'视频广告'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                              <span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token number">400</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token string">'搜索引擎'</span><span class="token punctuation">}</span>                          <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a<span class="token punctuation">.</span>value <span class="token operator">-</span> b<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          roseType<span class="token punctuation">:</span> <span class="token string">'radius'</span><span class="token punctuation">,</span>                          label<span class="token punctuation">:</span> <span class="token punctuation">{</span>                              normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                  textStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                      color<span class="token punctuation">:</span> <span class="token string">'rgba(255, 255, 255, 0.3)'</span>                                  <span class="token punctuation">}</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">}</span><span class="token punctuation">,</span>                          labelLine<span class="token punctuation">:</span> <span class="token punctuation">{</span>                              normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                  lineStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                      color<span class="token punctuation">:</span> <span class="token string">'rgba(255, 255, 255, 0.3)'</span>                                  <span class="token punctuation">}</span><span class="token punctuation">,</span>                                  smooth<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>                                  length<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                                  length2<span class="token punctuation">:</span> <span class="token number">20</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">}</span><span class="token punctuation">,</span>                          itemStyle<span class="token punctuation">:</span> <span class="token punctuation">{</span>                              normal<span class="token punctuation">:</span> <span class="token punctuation">{</span>                                  color<span class="token punctuation">:</span> <span class="token string">'#c23531'</span><span class="token punctuation">,</span>                                  shadowBlur<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>                                  shadowColor<span class="token punctuation">:</span> <span class="token string">'rgba(0, 0, 0, 0.5)'</span>                              <span class="token punctuation">}</span>                          <span class="token punctuation">}</span><span class="token punctuation">,</span>                          animationType<span class="token punctuation">:</span> <span class="token string">'scale'</span><span class="token punctuation">,</span>                          animationEasing<span class="token punctuation">:</span> <span class="token string">'elasticOut'</span><span class="token punctuation">,</span>                          animationDelay<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>                              <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">;</span>                          <span class="token punctuation">}</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">]</span>              <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><h2 id="二-使用vue-echarts"><a href="#二-使用vue-echarts" class="headerlink" title="二. 使用vue-echarts"></a>二. 使用vue-echarts</h2><p>同样的通过npm导入，在main.js中挂载到原型链上，命令如下</p><pre class=" language-shell"><code class="language-shell">npm install echarts vue-echarts</code></pre><p>在main.js中，除了全量引用echarts，我们还可以采用按需引入的方式，但是全局引入会将所有的echarts图表打包，导致体积过大，所以如果仅仅只是少量的报表还是按需引入吧。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> ECharts <span class="token keyword">from</span> <span class="token string">'vue-echarts'</span><span class="token keyword">import</span> <span class="token string">'echarts/lib/chart/line'</span>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'chart'</span><span class="token punctuation">,</span> ECharts<span class="token punctuation">)</span></code></pre><p>创建一个<code>HelloWorld.vue</code>测试一下，代码如下</p><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>chart ref<span class="token operator">=</span><span class="token string">"chart1"</span> <span class="token punctuation">:</span>options<span class="token operator">=</span><span class="token string">"orgOptions"</span> <span class="token punctuation">:</span>auto<span class="token operator">-</span>resize<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>chart<span class="token operator">></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>  data <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      orgOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>orgOptions <span class="token operator">=</span> <span class="token punctuation">{</span>        xAxis<span class="token punctuation">:</span> <span class="token punctuation">{</span>            type<span class="token punctuation">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>            data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Mon'</span><span class="token punctuation">,</span> <span class="token string">'Tue'</span><span class="token punctuation">,</span> <span class="token string">'Wed'</span><span class="token punctuation">,</span> <span class="token string">'Thu'</span><span class="token punctuation">,</span> <span class="token string">'Fri'</span><span class="token punctuation">,</span> <span class="token string">'Sat'</span><span class="token punctuation">,</span> <span class="token string">'Sun'</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        yAxis<span class="token punctuation">:</span> <span class="token punctuation">{</span>            type<span class="token punctuation">:</span> <span class="token string">'value'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        series<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>            data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">820</span><span class="token punctuation">,</span> <span class="token number">932</span><span class="token punctuation">,</span> <span class="token number">901</span><span class="token punctuation">,</span> <span class="token number">934</span><span class="token punctuation">,</span> <span class="token number">1290</span><span class="token punctuation">,</span> <span class="token number">1330</span><span class="token punctuation">,</span> <span class="token number">1320</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            type<span class="token punctuation">:</span> <span class="token string">'line'</span><span class="token punctuation">,</span>            smooth<span class="token punctuation">:</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><p>到这里就结束了。是不是很简单，毕竟是别人造好的轮子，只管用就行了。</p><h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><p>两种方式都能满足常规的开发需求。个人认为：</p><ul><li>如果你的需求是定制化比较少的，或者项目开发时间比较紧张，基本上绑定数据然后展示就行了，又或者你对echarts还不是很熟悉的，那么vue-echarts是一个不错的选择；</li><li>如果你的需求是定制化多的，比如需要特殊处理鼠标事件什么的（当然vue-echarts也可以，但需要同时看两份API文档，多累呀），又或者你已经对echarts比较熟悉了（那你就不会看这篇文章了哈哈），你会发现Echarts官方文档写得真是清晰明了，直接用着也很爽呀完全没问题。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA永久破解</title>
      <link href="/2020/03/07/idea-yong-jiu-po-jie/"/>
      <url>/2020/03/07/idea-yong-jiu-po-jie/</url>
      
        <content type="html"><![CDATA[<p>IDEA是目前最流行也是最好用的集成开发工具，强大的代码提示和编辑功能吸引了很多开发者，Jetbrains下还有很多类似的开发工具，也很受开发者青睐。Jetbrains下的产品都是商业付费版，因此购买才可以使用，这对于普通开发者和学生党来说是笔小开销，到网上找一些激活码呢，过一段时间就会时期，时不时的得再去找新的激活码也很烦人，这里介绍的是如何将IDEA永久破解，愉快的写代码。当然笔者建议有一定经济条件的，还是去官网购买正版软件，也不是很贵，这是对别人产品的一种尊重也是认可。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/1.png" alt></p><p>Jetbrains的全家桶产品众多，本文主要介绍几款常用的软件破解方法，包括IDEA，WebStorm和GoLand。每个开发工具在使用不同的版本时，破解工具也要使用其对应的版本，而且破解工具不同，破解方式也不一样，并不通用。因此破解方式只针对具体的版本，如果版本和本文阐述的版本不一致，可能会导致破解失败。下面几个版本都是亲测可用的。</p><h2 id="IDEA破解"><a href="#IDEA破解" class="headerlink" title="IDEA破解"></a>IDEA破解</h2><h4 id="破解准备"><a href="#破解准备" class="headerlink" title="破解准备"></a>破解准备</h4><ol><li><strong>IDEA版本</strong>：2018.1.6</li><li><strong>破解工具</strong>：百度网盘: <a href="https://pan.baidu.com/s/1DRROpPD3CwpjiQ27xnIjgg" target="_blank" rel="noopener">https://pan.baidu.com/s/1DRROpPD3CwpjiQ27xnIjgg</a> 提取码: c1vv</li></ol><h3 id="破解方法"><a href="#破解方法" class="headerlink" title="破解方法"></a>破解方法</h3><ol><li><p>把下载好的破解工具<code>JetbrainsIdesCrack-4.2-release-enc.jar</code>添加到IDEA安装目录的 bin 目录下。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/2.png" alt></p></li><li><p>修改bin目录下的<code>idea64.exe.vmoptions</code>和<code>idea.exe.vmoptions</code>两个文件，在文件中最后一行添加如下配置</p><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">-javaagent</span><span class="token punctuation">:</span><span class="token attr-value">D:\Program Files\JetBrains\IntelliJ IDEA 2018.1.6\bin\JetbrainsIdesCrack-4.2-release-enc.jar</span></code></pre><p>文件路径是破解jar包的路径，<code>idea64.exe.vmoptions</code>和<code>idea.exe.vmoptions</code>在同步操作系统上可能只有一个，这里是win10的系统。只有一个改一个就行。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/3.png" alt></p></li><li><p>打开IDEA工具，在 <code>Activation Code</code>中填写刚刚这<code>idea64.exe.vmoptions</code>文件中追加的配置</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/4.png" alt></p></li><li><p>至此IDEA已破解完成，可进入到IDEA后，打开 Help -&gt; About 查看是否破解成功，如破解成功可以看到到期时间是2099年</p></li></ol><p><img src="/2020/03/07/idea-yong-jiu-po-jie/5.png" alt></p><h2 id="WebStorm破解"><a href="#WebStorm破解" class="headerlink" title="WebStorm破解"></a>WebStorm破解</h2><h4 id="破解准备-1"><a href="#破解准备-1" class="headerlink" title="破解准备"></a>破解准备</h4><ol><li><strong>webstorm版本</strong>：2019.2.1</li><li><strong>破解工具</strong>：百度网盘: <a href="https://pan.baidu.com/s/1iOEiZ07iFPWMZN7B4ZvRBg" target="_blank" rel="noopener">https://pan.baidu.com/s/1iOEiZ07iFPWMZN7B4ZvRBg</a> 提取码: aejt </li></ol><h3 id="破解方法-1"><a href="#破解方法-1" class="headerlink" title="破解方法"></a>破解方法</h3><ol><li><p>把下载好的破解工具<code>jetbrains-agent.jar</code>添加到IDEA安装目录的 bin 目录下。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/6.png" alt></p></li><li><p>修改bin目录下的<code>webstorm.exe.vmoptions</code>和<code>webstorm.exe.vmoptions</code>两个文件，在文件中最后一行添加如下配置</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/7.png" alt></p></li><li><p>打开hosts文件，windows在 <code>C:\Windows\System32\drivers\etc</code> 目录下，在hosts文件中添加如下配置</p><pre><code>0.0.0.0 account.jetbrains.com0.0.0.0 www.jetbrains.com</code></pre><p>这样就使得webstorm不能联网检查，然后重新打开webstorm，这时由于不能联网检查会弹出提示框，选择Activation code方式离线激活，使用ACTIVATION_CODE.txt 内的注册码激活</p></li><li><p>至此Webstorm已破解完成，可进入到Webstorm后，打开 Help -&gt; About 查看是否破解成功，如破解成功可以看到到期时间是2089年</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/8.png" alt></p></li></ol><h2 id="GoLang破解"><a href="#GoLang破解" class="headerlink" title="GoLang破解"></a>GoLang破解</h2><h4 id="破解准备-2"><a href="#破解准备-2" class="headerlink" title="破解准备"></a>破解准备</h4><ol><li><strong>golang版本</strong>：2019.1.3</li><li><strong>破解工具</strong>：百度网盘: <a href="https://pan.baidu.com/s/1xAEzaUcES1-JFzCKDd9-TQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1xAEzaUcES1-JFzCKDd9-TQ</a> 提取码: 3n6s</li></ol><h3 id="破解方法-2"><a href="#破解方法-2" class="headerlink" title="破解方法"></a>破解方法</h3><ol><li><p>把下载好的破解工具<code>JetbrainsCrack-release-enc.jar</code>添加到IDEA安装目录的 bin 目录下。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/9.png" alt></p></li><li><p>修改bin目录下的<code>goland64.exe.vmoptions</code>和<code>goland.exe.vmoptions</code>两个文件，在文件中最后一行添加如下配置</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/10.png" alt></p></li><li><p>打开GoLang，在<code>Activation Code</code>填写刚刚下载压缩包中的激活码，然后就破解了。如果没有前面两个步骤，直接填写激活码，会提示激活码是非法的。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/11.png" alt></p></li></ol><h2 id="Pycharm破解"><a href="#Pycharm破解" class="headerlink" title="Pycharm破解"></a>Pycharm破解</h2><h4 id="破解准备-3"><a href="#破解准备-3" class="headerlink" title="破解准备"></a>破解准备</h4><ol><li><strong>pycharm版本</strong>：2018.2.3</li><li><strong>破解工具</strong>：百度网网盘: <a href="https://pan.baidu.com/s/1yoDKFiuBIq8Vo56QyhK7JA" target="_blank" rel="noopener">https://pan.baidu.com/s/1yoDKFiuBIq8Vo56QyhK7JA</a> 提取码: a5px </li></ol><h4 id="破解方法-3"><a href="#破解方法-3" class="headerlink" title="破解方法"></a>破解方法</h4><h3 id="破解方法-4"><a href="#破解方法-4" class="headerlink" title="破解方法"></a>破解方法</h3><ol><li><p>把下载好的破解工具<code>JetbrainsCrack-3.1-release-enc</code>添加到IDEA安装目录的 bin 目录下。</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/21.png" alt></p></li><li><p>修改bin目录下的<code>pycharm.exe.vmoptions</code>和<code>pycharm64.exe.vmoptions</code>两个文件，在文件中最后一行添加如下配置</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/22.png" alt></p></li><li><p>打开Pycharm，这时不会提示需要激活了，如果还弹出激活框，随便找个激活码填进去就可以了</p><p><img src="/2020/03/07/idea-yong-jiu-po-jie/23.png" alt></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器的V8引擎</title>
      <link href="/2020/03/01/liu-lan-qi-de-v8-yin-qing/"/>
      <url>/2020/03/01/liu-lan-qi-de-v8-yin-qing/</url>
      
        <content type="html"><![CDATA[<p>V8引擎是前端开发工程师进阶的必经之路，它是JS的解释器。对于CPU硬件是无法直接运行高级语言的，需要把高级语言翻译成机器码，而V8引擎是专门作为JavaScript而创造的解释器。在Java中JVM也有类似的作用，但与JVM不同的是。V8引擎是把JavaScript语言直接翻译成机器码，而JVM并不是直接翻译Java语言，而是把字节码翻译成机器码。Google V8 引擎使用 C++ 代码编写，实现了 ECMAScript 规范的第五版，可以运行在所有的主流操作系统中，甚至可以运行在移动终端 ( 基于 ARM 的处理器，如 HTC G7 等 )。V8开发小组是一群程序语言专家。核心工程师Lars Bak之前研发了HotSpot，因此V8引擎的实现原理中有一部分借鉴JVM。V8 会编译 / 执行 JavaScript 代码，管理内存，负责垃圾回收，与宿主语言的交互等。V8 的垃圾回收器采用了众多技术，使得其运行效率大大提高。通过暴露宿主对象 ( 变量，函数等 ) 到 JavaScript，JavaScript 可以访问宿主环境中的对象，并在脚本中完成对宿主对象的操作。</p><p><img src="/2020/03/01/liu-lan-qi-de-v8-yin-qing/1.jpg" alt></p><h2 id="V8引擎的历史"><a href="#V8引擎的历史" class="headerlink" title="V8引擎的历史"></a>V8引擎的历史</h2><p>2006 年秋，Google 聘请 Lars Bak 为 Chrome 浏览器构建了一个新的 JavaScript 引擎，当时它仍然是一个 Google 内部秘密的项目。后来，Lars 想留在丹麦，他从硅谷搬回了丹麦的奥胡斯。但那里没有谷歌办公室，Lars和该项目最早的几个工程师开始在他的农场里工作。新的 JavaScript 引擎被命名为“V8”，隐喻肌肉车里的强大引擎[注：肌肉车装备有大马力 V8 发动机]。随着 V8 团队壮大，开发人员从他们的农场搬到了奥胡斯的现代化办公大楼，团队带着他们特有的驱动力，专注于构建地球上最快的 JavaScript 引擎。Google开始研发V8，部分的原因是Google对JavaScript引擎的执行速度不满意。JavaScript存在至少10年了。在1995年，它出现在网景(Netscape Communications)公司所研发的网页浏览器Netscape Navigator 2.0中。然而有段时间人们对于性能的要求不高，因为它只用在网页上少数的动画、交互操作或其它类似的动作上。浏览器的显示速度视网络传输速度以及渲染引擎（rendering engine）解析HTML、CSS（cascading style sheets, CSS）及其他代码的速度而定。浏览器的开发工作优先提升渲染引擎的速度，而JavaScript的处理速度不是太重要。同时出现的Java有相当大的进步，它被做得愈来愈快，以便和C++竞争。但随着Web相关技术的发展，JavaScript所要承担的工作也越来越多，早就超越了“表单验证”的范畴，例如桌面应用的软件（其中包括Office套件等），现已成为可以在浏览器中执行的软件。Google本身就推出了好几款JavaScript网络应用，其中包括它的Gmail电子邮件服务、Google Maps地图数据服务、以及Google Docs office套件。这些应用表现出的速度不仅受到服务器、网络、渲染引擎以及其他诸多因素的影响，同时也受到JavaScript本身执行速度的影响。这就更需要快速的解析和执行JavaScript脚本。V8引擎就是为解决这一问题而生，在node中也是采用该引擎来解析JavaScript。</p><h2 id="浏览器的结构"><a href="#浏览器的结构" class="headerlink" title="浏览器的结构"></a>浏览器的结构</h2><p>浏览器是使用最广的软件之一，我们平时在打开浏览器输出网址回车后，浏览器做了哪些事情呢，这就涉及到浏览器的工作原理了，首先来看一下浏览器的结构，浏览器的核心是两部分：渲染引擎和JavaScript解释器（JavaScript引擎），如果细分的话，可分为8个子系统</p><p><img src="/2020/03/01/liu-lan-qi-de-v8-yin-qing/2.jpg" alt></p><h3 id="用户界面（User-Interface）"><a href="#用户界面（User-Interface）" class="headerlink" title="用户界面（User Interface）"></a>用户界面（User Interface）</h3><p>用户界面主要包括工具栏、地址栏、前进/后退按钮、书签菜单、可视化页面加载进度、智能下载处理、首选项、打印等。除了浏览器主窗口显示请求的页面之外，其他显示的部分都属于用户界面。用户界面还可以与桌面环境集成，以提供浏览器会话管理或与其他桌面应用程序的通信。</p><h3 id="浏览器引擎（Browser-Engine）"><a href="#浏览器引擎（Browser-Engine）" class="headerlink" title="浏览器引擎（Browser Engine）"></a>浏览器引擎（Browser Engine）</h3><p>浏览器引擎是一个可嵌入的组件，其为渲染引擎提供高级接口。浏览器引擎可以加载一个给定的URI，并支持诸如：前进/后退/重新加载等浏览操作。浏览器引擎提供查看浏览会话的各个方面的挂钩，例如：当前页面加载进度、JavaScript alert。浏览器引擎还允许查询/修改渲染引擎设置。</p><h3 id="网络（Networking）"><a href="#网络（Networking）" class="headerlink" title="网络（Networking）"></a>网络（Networking）</h3><p>网络系统实现HTTP和FTP等文件传输协议。 网络系统可以在不同的字符集之间进行转换，为文件解析MIME媒体类型。 网络系统可以实现最近检索资源的缓存功能。</p><h3 id="JavaScript解释器（JavaScript-Interpreter）"><a href="#JavaScript解释器（JavaScript-Interpreter）" class="headerlink" title="JavaScript解释器（JavaScript Interpreter）"></a>JavaScript解释器（JavaScript Interpreter）</h3><p>又名JS引擎，JavaScript解释器能够解释并执行嵌入在网页中的JavaScript（又称ECMAScript）代码。 为了安全起见，浏览器引擎或渲染引擎可能会禁用某些JavaScript功能，如弹出窗口的打开。</p><h3 id="XML解析器（XML-Parser）"><a href="#XML解析器（XML-Parser）" class="headerlink" title="XML解析器（XML Parser）"></a>XML解析器（XML Parser）</h3><p>XML解析器可以将XML文档解析成文档对象模型（Document Object Model，DOM）树。 XML解析器是浏览器架构中复用最多的子系统之一，几乎所有的浏览器实现都利用现有的XML解析器，而不是从头开始创建自己的XML解析器。与其功能相似的HTML解析器为什么划分在渲染引擎中，后者作为独立的子系统？XML解析器对于系统来说，其功能并不是关键性的，但是从复用角度来说，XML解析器是一个通用的，可重用的组件，具有标准的，定义明确的接口。相比之下，HTML解析器通常与渲染引擎紧耦合。</p><h3 id="Data-Persistence-数据持久层"><a href="#Data-Persistence-数据持久层" class="headerlink" title="Data Persistence(数据持久层)"></a>Data Persistence(数据持久层)</h3><p>数据持久层将与浏览会话相关联的各种数据存储在硬盘上。 这些数据可能是诸如：书签、工具栏设置等这样的高级数据，也可能是诸如：Cookie，安全证书、缓存等这样的低级数据</p><h3 id="显示后端（Display-Backend）"><a href="#显示后端（Display-Backend）" class="headerlink" title="显示后端（Display Backend）"></a>显示后端（Display Backend）</h3><p>显示后端提供绘图和窗口原语，包括：用户界面控件集合、字体集合。</p><h2 id="渲染引擎"><a href="#渲染引擎" class="headerlink" title="渲染引擎"></a>渲染引擎</h2><p>渲染引擎是浏览器的核心，也可以叫做浏览器的内核（这种说法并不是很严谨）。他的功能是渲染，即在浏览器窗口中显示所请求的内容。默认情况下，渲染引擎可显示 HTML 和 XML 文档及图片。目前，常见的渲染引擎有Trident、Gecko、WebKit等。渲染引擎一开始会从网络层获取请求文档的内容（以8k分块）。解析HTML文档，并将文档中的标签转化为dom节点树，即”内容树”。同时，它也会解析外部CSS文件以及style标签中的样式数据。这些样式信息连同HTML中的”可见内容”一道，被用于构建另一棵树——”渲染树(Render树)”。渲染树由一些带有视觉属性(如颜色、大小等)的矩形组成，这些矩形将按照正确的顺序显示在频幕上。渲染树构建完毕之后，将会进入”布局”处理阶段，即为每一个节点分配一个屏幕坐标。再下一步就是绘制(painting)，即遍历render树，并使用UI后端层绘制每个节点。这个过程是逐步完成的，为了更好的用户体验，<strong>渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等到所有的html都解析完成之后再去构建和布局render树。</strong>它是解析完一部分内容就显示一部分内容，同时，可能还在通过网络下载其余内容。下图所示为渲染引擎工作流程中各个步骤所对应的模块，其中第1步和第2步涉及到多个模块，并且耦合程度较高。这样的设计会为了达到更好的用户体验，渲染引擎尽快将内容显示在屏幕上。</p><p><img src="/2020/03/01/liu-lan-qi-de-v8-yin-qing/3.jpg" alt></p><p>看完这图是不是让人头大，不管是HTML，CSS还是JS解释渲染。其实现原理都涉及编译原理，所以如果想再深究实现细节，就得先明白编译原理了。（大佬就是这么无情啊，一言不合就创造一门语言）回到主题，继续JS引擎吧</p><h2 id="JS引擎"><a href="#JS引擎" class="headerlink" title="JS引擎"></a>JS引擎</h2><p>JS引擎是一个专门处理JS脚本的虚拟机，专门设计来解释和执行的 JavaScript 代码。 JS引擎会加载你的源代码，把它分解成字符串，把这些字符串转换成编译器可以理解的字节码，然后执行这些字节码。不同浏览器有不同的JS引擎，下面是一些常用浏览器的JS引擎</p><table><thead><tr><th>浏览器（或JS运行环境）</th><th>JavaScript引擎</th></tr></thead><tbody><tr><td>Firefox（火狐浏览器）</td><td>SpiderMonkey</td></tr><tr><td>Chorme（谷歌浏览器）</td><td>V8</td></tr><tr><td>Safari（macOS中的浏览器）</td><td>JavaScriptCore</td></tr><tr><td>IE / Edge</td><td>Chakra</td></tr><tr><td>Node</td><td>V8</td></tr></tbody></table><p>从性能的角度来看，V8具有4个主要特性。首先，它在执行时以称为及时（just-in-time, JIT）的编译方法，来产生机器语言。这是个普遍用来改善解释速度的方法，在Java和.NET等语言中也可以发现此方法。V8比Firefox中的SpiderMonkey JavaScript引擎，或Safari的JavaScriptCore等竞争引擎还要早的实践了这一技术。V8 JIT编译器在产生机器语言时，不会产生中间码。而在Java编译器先将原始码转换成一个以虚拟中间语言（称为字节码，bytecode）<strong>JAVA中称之为类文件 (class file)</strong>。Java编译器和字节码编译器产生字节码，而非机器语言。Java VM按顺序地在执行中解释字节码。此执行模式称为字节码解释器(bytecode interpreter)。 Firefox的SpiderMonkey具有一个内部的字节码编译器和字节解释器，将JavaScript原始码转换成它自家特色的字节代码，以便执行。V8不是将原始程序转换成中间语言，而是将抽象语法直接产生机器语言并加以执行。没有虚拟机，且因为不需要中间表示式，程序处理会更早开始了。然而，另一方面，它也丧失了虚拟机的好处，例如透过字节码解释器和混合模式等</p><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>JavaScript使用垃圾回收机制来自动管理内存。垃圾回收是一把双刃剑，其好处是可以大幅简化程序的内存管理代码，降低程序员的负担，减少因长时间运转而带来的内存泄露问题。但使用了垃圾回收即意味着程序员将无法掌控内存。ECMAScript没有暴露任何垃圾回收器的接口。我们无法强迫其进行垃圾回收，更无法干预内存管理。V8的垃圾回收策略基于分代回收机制，该机制又基于 世代假说。该假说有两个特点：</p><ul><li>大部分新生对象倾向于早死；</li><li>不死的对象，会活得更久。</li></ul><p>基于这个理论，现代垃圾回收算法根据对象的存活时间将内存进行了分代，并对不同分代的内存采用不同的高效算法进行垃圾回收。和Java的JVM垃圾回收相似度非常高，JVM同样是采用分代垃圾回收。</p><h3 id="V8的内存限制"><a href="#V8的内存限制" class="headerlink" title="V8的内存限制"></a>V8的内存限制</h3><p>Node与其他语言不同的一个地方，就是其限制了JavaScript所能使用的内存（64位为1.4GB，32位为0.7GB），这也就意味着将无法直接操作一些大内存对象。这很令人匪夷所思，因为很少有其他语言会限制内存的使用。V8之所以限制了内存的大小，表面上的原因是V8最初是作为浏览器的JavaScript引擎而设计，不太可能遇到大量内存的场景，而深层次的原因则是由于V8的垃圾回收机制的限制。由于V8需要保证JavaScript应用逻辑与垃圾回收器所看到的不一样，V8在执行垃圾回收时会阻塞JavaScript应用逻辑，直到垃圾回收结束再重新执行JavaScript应用逻辑，这种行为被称为“全停顿”（stop-the-world）。若V8的堆内存为1.5GB，V8做一次小的垃圾回收需要50ms以上，做一次非增量式的垃圾回收甚至要1秒以上。这样浏览器将在1s内失去对用户的响应，造成假死现象。如果有动画效果的话，动画的展现也将显著受到影响。当然这个限制是可以打开的，类似于JVM，我们通过在启动node时可以传递–max-old-space-size或–max-new-space-size来调整内存限制的大小，前者确定老生代的大小，单位为MB，后者确定新生代的大小，单位为KB。这些配置只在V8初始化时生效，一旦生效不能再改变</p><h3 id="回收算法"><a href="#回收算法" class="headerlink" title="回收算法"></a>回收算法</h3><p>在V8中，将内存分为了新生代（new space）和老生代（old space）。它们特点如下：</p><ul><li>新生代：对象的存活时间较短。新生对象或只经过一次垃圾回收的对象。</li><li>老生代：对象存活时间较长。经历过一次或多次垃圾回收的对象。</li></ul><p>由于新生代和老生代特点不同，新生代对象基本朝生夕死。针对这两个区域，产生不同的算法回收垃圾对象。</p><h5 id="Scavenge-算法"><a href="#Scavenge-算法" class="headerlink" title="Scavenge 算法"></a>Scavenge 算法</h5><p>新生代中的对象主要通过 Scavenge 算法进行垃圾回收。Scavenge 的具体实现，主要采用了Cheney算法。Cheney算法采用复制的方式进行垃圾回收。它将堆内存一分为二，每一部分空间称为 semispace。这两个空间，只有一个空间处于使用中，另一个则处于闲置。使用中的 semispace 称为 「From 空间」，闲置的 semispace 称为 「To 空间」。Scavenge 算法的缺点是，它的算法机制决定了只能利用一半的内存空间。但是新生代中的对象生存周期短、存活对象少，进行对象复制的成本不是很高，因而非常适合这种场景。学过Java虚拟机的对此算法应该很熟悉，这个算法主要是为了避免STW时间太长<strong>（Stop The World ）</strong>。</p><h5 id="Mark-Sweep"><a href="#Mark-Sweep" class="headerlink" title="Mark-Sweep"></a>Mark-Sweep</h5><p>老生代的算法主要有两个Mark-Sweep和Mark-Compact，是标记清除的意思。它主要分为标记和清除两个阶段。</p><ul><li>标记阶段，它将遍历堆中所有对象，并对存活的对象进行标记；</li><li>清除阶段，对未标记对象的空间进行回收。</li></ul><p>与 Scavenge 算法不同，Mark-Sweep 不会对内存一分为二，因此不会浪费空间。但是，经历过一次 Mark-Sweep 之后，内存的空间将会变得不连续，这样会对后续内存分配造成问题。比如，当需要分配一个比较大的对象时，没有任何一个碎片内支持分配，这将提前触发一次垃圾回收，尽管这次垃圾回收是没有必要的。</p><h5 id="Mark-Compact"><a href="#Mark-Compact" class="headerlink" title="Mark-Compact"></a>Mark-Compact</h5><p>为了解决内存碎片的问题，提高对内存的利用，引入了 Mark-Compact （标记整理）算法。Mark-Compact 是在 Mark-Sweep 算法上进行了改进，标记阶段与Mark-Sweep相同，但是对未标记的对象处理方式不同。与Mark-Sweep是对未标记的对象立即进行回收，Mark-Compact则是将存活的对象移动到一边，然后再清理端边界外的内存。由于Mark-Compact需要移动对象，所以执行速度上，比Mark-Sweep要慢。所以，V8主要使用Mark-Sweep算法，然后在当空间内存分配不足时，采用Mark-Compact算法。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript之ES6</title>
      <link href="/2020/02/29/javascript-zhi-es6/"/>
      <url>/2020/02/29/javascript-zhi-es6/</url>
      
        <content type="html"><![CDATA[<p>在前端技术快速发展的今天，越来越多的前端新词汇涌现出来，特别是NodeJs出来之后，出现了ES6，ECMAScript 2015 ，TypeScript，它们语法上与JS相似，但又有区别，一开始接触还真有些头疼，本文将系统的整理一下它们之间的关系与区别。ECMAScript 6.0（以下简称ES6）是JavaScript语言（现在是遵循ES5标准）的下一代标准，已经在2015年6月正式发布了。它的目标，是使得JavaScript语言可以用来编写复杂的大型应用程序，成为企业级开发语言。</p><p><img src="/2020/02/29/javascript-zhi-es6/1.jpg" alt></p><h2 id="ECMAScript-和-JavaScript-的关系"><a href="#ECMAScript-和-JavaScript-的关系" class="headerlink" title="ECMAScript 和 JavaScript 的关系"></a>ECMAScript 和 JavaScript 的关系</h2><p>一个常见的问题是，ECMAScript 和 JavaScript 到底是什么关系？要讲清楚这个问题，需要回顾历史。1996 年 11 月，JavaScript 的创造者 Netscape 公司，决定将 JavaScript 提交给标准化组织 ECMA，希望这种语言能够成为国际标准。次年，ECMA 发布 262 号标准文件（ECMA-262）的第一版，规定了浏览器脚本语言的标准，并将这种语言称为 ECMAScript，这个版本就是 1.0 版。该标准从一开始就是针对 JavaScript 语言制定的，但是之所以不叫 JavaScript，有两个原因。一是商标，Java 是 Sun 公司的商标，根据授权协议，只有 Netscape 公司可以合法地使用 JavaScript 这个名字，且 JavaScript 本身也已经被 Netscape 公司注册为商标。二是想体现这门语言的制定者是 ECMA，不是 Netscape，这样有利于保证这门语言的开放性和中立性。因此，ECMAScript 和 JavaScript 的关系是，前者是后者的规格，后者是前者的一种实现（另外的 ECMAScript 方言还有 JScript 和 ActionScript）。日常场合，这两个词是可以互换的。</p><h2 id="ECMAScript-2015与ES6-与的关系"><a href="#ECMAScript-2015与ES6-与的关系" class="headerlink" title="ECMAScript 2015与ES6 与的关系"></a>ECMAScript 2015与ES6 与的关系</h2><p>ECMAScript 2015（简称 ES2015）这个词，也是经常可以看到的。它与 ES6 是什么关系呢？2011 年，ECMAScript 5.1 版发布后，就开始制定 6.0 版了。因此，ES6 这个词的原意，就是指 JavaScript 语言的下一个版本。但是，因为这个版本引入的语法功能太多，而且制定过程当中，还有很多组织和个人不断提交新功能。事情很快就变得清楚了，不可能在一个版本里面包括所有将要引入的功能。常规的做法是先发布 6.0 版，过一段时间再发 6.1 版，然后是 6.2 版、6.3 版等等。但是，标准的制定者不想这样做。他们想让标准的升级成为常规流程：任何人在任何时候，都可以向标准委员会提交新语法的提案，然后标准委员会每个月开一次会，评估这些提案是否可以接受，需要哪些改进。如果经过多次会议以后，一个提案足够成熟了，就可以正式进入标准了。这就是说，标准的版本升级成为了一个不断滚动的流程，每个月都会有变动。标准委员会最终决定，标准在每年的 6 月份正式发布一次，作为当年的正式版本。接下来的时间，就在这个版本的基础上做改动，直到下一年的 6 月份，草案就自然变成了新一年的版本。这样一来，就不需要以前的版本号了，只要用年份标记就可以了。ES6 的第一个版本，就这样在 2015 年 6 月发布了，正式名称就是《ECMAScript 2015 标准》（简称 ES2015）。2016 年 6 月，小幅修订的《ECMAScript 2016 标准》（简称 ES2016）如期发布，这个版本可以看作是 ES6.1 版，因为两者的差异非常小（只新增了数组实例的<code>includes</code>方法和指数运算符），基本上是同一个标准。根据计划，2017 年 6 月发布 ES2017 标准。因此，ES6 既是一个历史名词，也是一个泛指，含义是 5.1 版以后的 JavaScript 的下一代标准，涵盖了 ES2015、ES2016、ES2017 等等，而 ES2015 则是正式名称，特指该年发布的正式版本的语言标准。</p><h2 id="JavaScript-与-TypeScript-的关系"><a href="#JavaScript-与-TypeScript-的关系" class="headerlink" title="JavaScript 与 TypeScript 的关系"></a>JavaScript 与 TypeScript 的关系</h2><p>TypeScript是Javascript的超集，实现以面向对象编程的方式使用Javascript。当然最后代码还是编译为Javascript。因此TypeScript 实际上是增强了Javascript语言，利用TypeScript 使得JavaScript开发大型项目成为可能，特别是Node出来后这一优势在服务端开发更为明显，下面来比较一下TypeScript与Javascript各自的特点</p><h4 id="JavaScript的特点"><a href="#JavaScript的特点" class="headerlink" title="JavaScript的特点"></a>JavaScript的特点</h4><ol><li>JavaScript 是一种基于对象的语言，可以创建对象同时使用现有对象。但是 Javascript 并不支持其它面向对象语言所具有的继承和重载功能。</li><li>JavaScript 的语法简单，使用的变量为弱类型。</li><li>JavaScript 语言较为安全，使用单线程模型，不存在数据共享同步问题</li><li>JavaScript 语言具有动态性。JavaScript 是事件驱动的，只根据用户的操作做出相应的反应处理。</li></ol><h4 id="TypeScriptt的特点"><a href="#TypeScriptt的特点" class="headerlink" title="TypeScriptt的特点"></a>TypeScriptt的特点</h4><ol><li>TypeScript 是 Microsoft 推出的开源语言，使用 Apache 授权协议</li><li>TypeScript 增加了静态类型、类、模块、接口和类型注解</li><li>TypeScript 可用于开发大型的应用</li><li>TypeScript 易学易于理解</li></ol><p>TypeScript 可以使用 JavaScript 中的所有代码和编码概念，TypeScript 是为了使 JavaScript 的开发变得更加容易而创建的。例如，TypeScript 使用类型和接口等概念来描述正在使用的数据，这使开发人员能够快速检测错误并调试应用程序。TypeScript 从核心语言方面和类概念的模塑方面对 JavaScript 对象模型进行扩展。可根据实际情况决定需要不要引用TypeScript ，Angular2是基于typescript来开发的JS框架。</p><h2 id="JavaScript-的组成"><a href="#JavaScript-的组成" class="headerlink" title="JavaScript 的组成"></a>JavaScript 的组成</h2><p>我们开发中使用的js语言由三部分构成，而ECMAScript只是其中一部分的规范，其他两部分是专门针对浏览器端而使用的，如果仅仅是用于后端开发则只需要ECMAScript就够了</p><ol><li><strong>ECMAScript (核心)：</strong>描述了该语言的语法和基本对象，如类型、运算、流程控制、面向对象、异常等。</li><li><strong>DOM (文档对象模型)：</strong>描述处理网页HTML内容的方法和接口。</li><li><strong>BOM (浏览器对象模型)：</strong>描述与浏览器进行交互的方法和接口。</li></ol><p>其中<code>Node.Js</code>就只有<code>ES</code>，目前浏览器比较流行的版本就是<code>ES6(ES2015)</code>，老浏览器的版本基本上都是<code>ES5</code>。所以<code>alert</code>和<code>document</code>不能在<code>Node</code>运行是因为<code>Node</code>没有<code>Dom</code>和<code>Bom</code>。</p><h2 id="ES6的新特性"><a href="#ES6的新特性" class="headerlink" title="ES6的新特性"></a>ES6的新特性</h2><p>ES6的特性比较多，在 ES5 发布近 6 年（2009-11 至 2015-6）之后才将其标准化。两个发布版本之间时间跨度很大，所以ES6中的特性比较多。在这里列举几个常用的：</p><h4 id="类（class）"><a href="#类（class）" class="headerlink" title="类（class）"></a>类（class）</h4><p>对熟悉Java，object-c，c#等纯面向对象语言的开发者来说，都会对class有一种特殊的情怀。ES6 引入了class（类），让JavaScript的面向对象编程变得更加简单和易于理解。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造函数，实例化的时候将会被调用，如果不指定，那么会有一个不带参数的默认构造函数.</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>color<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// toString 是原型对象上的属性</span>    <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">',color:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">var</span> animal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">'dog'</span><span class="token punctuation">,</span><span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//实例化Animal</span> animal<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//true</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'toString'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'toString'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span> <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 子类必须要在constructor中指定super 函数，否则在新建实例的时候会报错.</span>    <span class="token comment" spellcheck="true">// 如果没有置顶consructor,默认带super函数的constructor将会被添加、</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span><span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">var</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token string">'catch'</span><span class="token punctuation">)</span> cat<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实例cat 是 Cat 和 Animal 的实例，和Es5完全一致。</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cat <span class="token keyword">instanceof</span> <span class="token class-name">Cat</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cat <span class="token keyword">instanceof</span> <span class="token class-name">Animal</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span></code></pre><h4 id="let与const"><a href="#let与const" class="headerlink" title="let与const"></a>let与const</h4><p>ES6推荐使用let声明局部变量，相比之前的var（无论声明在何处，都会被视为声明在函数的最顶部），在之前JS是没有<code>块级作用域</code>的，<code>const</code>与<code>let</code>填补了这方便的空白，const与let都是块级作用域。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 使用var定义的变量为函数级作用域</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出10</span><span class="token comment" spellcheck="true">// 使用let与const定义的变量为块级作用域</span><span class="token punctuation">{</span>  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//-1 or Error"ReferenceError: a is not defined"</span></code></pre><h4 id="模板字符串"><a href="#模板字符串" class="headerlink" title="模板字符串"></a>模板字符串</h4><p>在ES6之前，我们往往这么处理模板字符串：通过”&quot;和”+”来构建模板</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token string">"This demonstrates the output of HTML \content to the page, including student's\"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> seatNumber <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> sex <span class="token operator">+</span> <span class="token string">" and so on."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而对ES6来说</p><ol><li>基本的字符串格式化。将表达式嵌入字符串中进行拼接。用${}来界定；</li><li>ES6反引号(``)直接搞定；</li></ol><pre class=" language-javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`This demonstrates the output of HTML content to the page, including student's </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>seatNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and so on.`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="箭头函数（Arrow-Functions）"><a href="#箭头函数（Arrow-Functions）" class="headerlink" title="箭头函数（Arrow Functions）"></a>箭头函数（Arrow Functions）</h4><p>这是ES6中最令人激动的特性之一。箭头函数就是函数的一种简写形式，但<code>=&gt;</code>不只是关键字<code>function</code>的简写，它还带来了其它好处。箭头函数与包围它的代码<code>共享同一个this</code>,能帮你很好的解决this的指向问题。有经验的JavaScript开发者都熟悉诸如var self = this;或var that = this这种引用外围this的模式。但借助=&gt;，就不需要这种模式了。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ES5</span><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ES6使用箭头函数</span><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ES5</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ES6使用箭头函数</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="模块化-Module"><a href="#模块化-Module" class="headerlink" title="模块化(Module)"></a>模块化(Module)</h4><p>ES5不支持原生的模块化，在ES6中模块作为重要的组成部分被添加进来。模块的功能主要由 export 和 import 组成。每一个模块都有自己单独的作用域，模块之间的相互调用关系是通过 export 来规定模块对外暴露的接口，通过import来引用其它模块提供的接口。同时还为模块创造了命名空间，防止函数的命名冲突。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> myName<span class="token operator">=</span><span class="token string">"laowang"</span><span class="token punctuation">;</span><span class="token keyword">let</span> myAge<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> myfn<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"我是"</span><span class="token operator">+</span>myName<span class="token operator">+</span><span class="token string">"！今年"</span><span class="token operator">+</span>myAge<span class="token operator">+</span><span class="token string">"岁了"</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token punctuation">{</span>    myName<span class="token punctuation">,</span>    myAge<span class="token punctuation">,</span>    myfn<span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******************************接收的代码调整为**********************/</span><span class="token keyword">import</span> <span class="token punctuation">{</span>myfn<span class="token punctuation">,</span>myAge<span class="token punctuation">,</span>myName<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./test.js"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">myfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//我是laowang！今年20岁了</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myAge<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//20</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//laowang</span></code></pre><p>如果你不想暴露模块当中的变量名字，可以通过as来进行操作</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> myName<span class="token operator">=</span><span class="token string">"laowang"</span><span class="token punctuation">;</span><span class="token keyword">let</span> myAge<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">let</span> myfn<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"我是"</span><span class="token operator">+</span>myName<span class="token operator">+</span><span class="token string">"！今年"</span><span class="token operator">+</span>myAge<span class="token operator">+</span><span class="token string">"岁了"</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token punctuation">{</span>    myName <span class="token keyword">as</span> name<span class="token punctuation">,</span>    myAge <span class="token keyword">as</span> age<span class="token punctuation">,</span>    myfn <span class="token keyword">as</span> fn<span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******************************接收的代码调整为**********************/</span><span class="token keyword">import</span> <span class="token punctuation">{</span>fn<span class="token punctuation">,</span>age<span class="token punctuation">,</span>name<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./test.js"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//我是laowang！今年20岁了</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//20</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//laowang</span></code></pre><h4 id="解构赋值"><a href="#解构赋值" class="headerlink" title="解构赋值"></a>解构赋值</h4><p>解构赋值，解构赋值语法是JavaScript的一种表达式，可以方便的从数组或者对象中快速提取值赋给定义的变量。就是怎么快速地从对象和数组中获取到你想要的数据，先来看对象的解构赋值。</p><p><strong>1. 获取数组中的值</strong></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token string">"four"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token punctuation">[</span>one<span class="token punctuation">,</span> two<span class="token punctuation">,</span> three<span class="token punctuation">]</span> <span class="token operator">=</span> foo<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "one"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>two<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "two"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>three<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "three"</span><span class="token comment" spellcheck="true">//如果你要忽略某些值，你可以按照下面的写法获取你想要的值</span><span class="token keyword">var</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token punctuation">,</span> last<span class="token punctuation">]</span> <span class="token operator">=</span> foo<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "one"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "four"</span><span class="token comment" spellcheck="true">//你也可以这样写</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//先声明变量</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span></code></pre><p><strong>2.获取对象中的值</strong></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> student <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span><span class="token string">'Ming'</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span><span class="token string">'18'</span><span class="token punctuation">,</span>  city<span class="token punctuation">:</span><span class="token string">'Shanghai'</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>city<span class="token punctuation">}</span> <span class="token operator">=</span> student<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "Ming"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "18"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "Shanghai"</span></code></pre><h4 id="延展操作符-Spread-operator"><a href="#延展操作符-Spread-operator" class="headerlink" title="延展操作符(Spread operator)"></a>延展操作符(Spread operator)</h4><p>延展操作符<code>...</code>可以在函数调用/数组构造时, 将数组表达式或者string在语法层面展开；还可以在构造对象时, 将对象表达式按<code>key-value</code>的方式展开。</p><p><strong>1.改变函数的调用</strong></p><p>在es6以前将数组作为函数的参数传递进去的时候，通常使用的方法是function.prototype.apply,例如：</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'jack'</span><span class="token punctuation">,</span><span class="token string">'rose'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'niulang'</span><span class="token punctuation">,</span><span class="token string">'zhinv'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//jack,rose,niulang,zhinv</span></code></pre><p>  这样写很麻烦，有了延展操作符，它可以将数组（可遍历对象）进行展开然后作为函数的参数进行调用。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'jack'</span><span class="token punctuation">,</span><span class="token string">'rose'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'niulang'</span><span class="token punctuation">,</span><span class="token string">'zhinv'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//jack,rose,niulang,zhinv</span></code></pre><p><strong>2 .数组构造</strong></p><p>在延展运算符之前，我们如果想让一个数组成为另一个数组的一部分，需要用到之前学到的cancat，push等等。现在延展操作符允许我们简单地操作就能实现。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'jack'</span><span class="token punctuation">,</span><span class="token string">'rose'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'niulang'</span><span class="token punctuation">,</span><span class="token operator">...</span>arr<span class="token punctuation">,</span><span class="token string">'zhinv'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//['niulang','jack','rose','zhinv']</span></code></pre><p><strong>3.数组解构</strong></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token string">"four"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token punctuation">[</span>one<span class="token punctuation">,</span> two<span class="token punctuation">,</span> three<span class="token punctuation">]</span> <span class="token operator">=</span> foo<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "one"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>two<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "two"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>three<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "three"</span><span class="token comment" spellcheck="true">//如果你要忽略某些值，你可以按照下面的写法获取你想要的值</span><span class="token keyword">var</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token punctuation">,</span> last<span class="token punctuation">]</span> <span class="token operator">=</span> foo<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "one"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "four"</span><span class="token comment" spellcheck="true">//你也可以这样写</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//先声明变量</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span></code></pre><p><strong>4.对象解构</strong></p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> student <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span><span class="token string">'Ming'</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span><span class="token string">'18'</span><span class="token punctuation">,</span>  city<span class="token punctuation">:</span><span class="token string">'Shanghai'</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>city<span class="token punctuation">}</span> <span class="token operator">=</span> student<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "Ming"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "18"</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// "Shanghai"</span></code></pre><h4 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h4><p><code>Promise</code> 是<code>异步编程</code>的一种解决方案，<code>比传统的解决方案callback更加的优雅</code>。它最早由社区提出和实现的，ES6 将其写进了语言标准，统一了用法，原生提供了Promise对象。</p><p><strong>1.不使用ES6</strong></p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 嵌套两个setTimeout回调函数</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1秒后输出"Hello"</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2秒后输出"Hi"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>2.使用ES6</strong></p><pre class=" language-java"><code class="language-java">var waitSecond <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token function">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>waitSecond    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1秒后输出"Hello"</span>      <span class="token keyword">return</span> waitSecond<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2秒后输出"Hi"</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分布式算法之paxos算法</title>
      <link href="/2020/02/27/fen-bu-shi-suan-fa-zhi-paxos-suan-fa/"/>
      <url>/2020/02/27/fen-bu-shi-suan-fa-zhi-paxos-suan-fa/</url>
      
        <content type="html"><![CDATA[<p> Paxos是用于一种分布式系统并且具有容错性的一致性算法，是目前业界公认能解决分布式系统一致性的问题算法之一。它晦涩难懂的程度完全可以跟它的重要程度相匹敌。Paxos于1990年由Lamport提出，但直到1998才正式被计算机科学界接受。因为Lamport刚开始采用描述故事的方式来描述算法，但不被相关的出版社接受。后来Lamport发表《Paxos Make Simple》论文使得Paxos加速被广大计算机工程师理解并接受。但一直以来计算机的工程师抱怨Paxos算法是难以理解、晦涩，本人在学习之初也有深有体会。我在之前的文章有写过Paxos算法的原理，但那时理解的不够透彻，这里再对Paxos算法的原理做分析记录，加深理解。</p><p><img src="/2020/02/27/fen-bu-shi-suan-fa-zhi-paxos-suan-fa/1.jpg" alt></p><h2 id="拜占庭将军问题"><a href="#拜占庭将军问题" class="headerlink" title="拜占庭将军问题"></a>拜占庭将军问题</h2><p>拜占庭将军问题也被称为“拜占庭容错”，拜占庭将军问题是Leslie Lamport（2013年的图灵讲得住）用来为描述<strong>分布式系统一致性问题</strong>（Distributed Consensus）在<a href="http://lamport.azurewebsites.net/pubs/byz.pdf" target="_blank" rel="noopener">论文</a>中抽象出来一个著名的例子。这个例子大意是这样的：</p><p>拜占庭帝国想要进攻一个强大的敌人，为此派出了10支军队去包围这个敌人。这个敌人虽不比拜占庭帝国，但也足以抵御5支常规拜占庭军队的同时袭击。这10支军队在分开的包围状态下同时攻击。他们任一支军队单独进攻都毫无胜算，除非有至少6支军队（一半以上）同时袭击才能攻下敌国。他们分散在敌国的四周，依靠通信兵骑马相互通信来协商进攻意向及进攻时间。困扰这些将军的问题是，他们不确定他们中是否有叛徒，叛徒可能擅自变更进攻意向或者进攻时间。在这种状态下，拜占庭将军们才能保证有多于6支军队在同一时间一起发起进攻，从而赢取战斗？拜占庭将军问题中并不去考虑通信兵是否会被截获或无法传达信息等问题，即消息传递的信道绝无问题。拜占庭问题，假设将军总数是N，叛徒将军数为F，则当 N &gt;= 3F+1 时，问题才有解，共识才能达成，这就是Byzantine Fault Tolerant（BFT）算法。拜占庭算法不在本文章的范围之内，本文的Paxos算法是假设集群中不存在拜占庭问题，即不存在数据被篡改的情况，数据要么到达，要么不到达，不存在被篡改后送达。</p><h2 id="Paxos算法"><a href="#Paxos算法" class="headerlink" title="Paxos算法"></a>Paxos算法</h2><p>Paxos算法有三种角色，两个大阶段，每个大阶段下又有两个小阶段，每种角色在不同阶段有不同的操作。就本人的学习经验而言觉得Paxos算法难以理解的地方在于，仅靠文字难以描述清楚Paxos算法的收敛过程。本文将全力把算法讲的通俗易懂，并配上小例子，Paxos算法中的参与者主要分为三个角色，同时每个参与者又可兼领多个角色。在整个算法过程中提案中的提案号只能递增。</p><h3 id="三个角色"><a href="#三个角色" class="headerlink" title="三个角色"></a>三个角色</h3><ol><li><strong>proposer：</strong> 提议者，提出提案（proposal），提案信息包括提案编号和提议的value</li><li><strong>acceptor：</strong> 表决者，收到提案后可以接受(accept)提案</li><li><strong>learner：</strong> 学习者，只能”学习”被批准的提案，并广播给未学习的learner学习提案。</li></ol><h3 id="三个承诺"><a href="#三个承诺" class="headerlink" title="三个承诺"></a>三个承诺</h3><ol><li><strong>promise(v)：</strong>acceptor对proposer承诺，如果没有更大编号的proposal会accept它提交的proposal</li><li><strong>accept(v)：</strong>acceptor没有发现有比之前的proposal更大编号的proposal，就批准了该proposal</li><li><strong>chosen(v)：</strong>当acceptor的多数派都accept一个proposal时，该proposal就被最终chosen，也称为决议</li></ol><p>提案是Paxos算法的一个重要概念，一个提案中有两个值<strong>Proposal Number</strong>和<strong>Proposal Value</strong>，简称Number和Value。其中Number是每次提案的版本号，而Value是提案的值，在分布式系统中Value可以是一个具体的字段，一个文本，或是一个命令。下面是先贴上算法的官方描述，是算法保证一致性的基本语义：</p><ol><li>决议（value）只有在被proposers提出后才能被批准（未经批准的决议称为“提案（proposal）”）；</li><li>在一次Paxos算法的执行实例中，只批准（chosen）一个value；</li><li>learners只能获得被批准（chosen）的value。</li></ol><p>Paxos算法的作者Lamport通过不断加强上述3个约束（主要是第二个）获得了Paxos算法，因此又衍生出四个约束f分别是P1，P2，P2a，P2b，P2c。这也是Paxos算法的推导过程</p><p><strong>P1：一个acceptor必须接受（accept）第一次收到的提案。</strong></p><p>注意P1是不完备的。如果恰好一半acceptor接受的提案具有value A，另一半接受的提案具有value B，那么就无法形成多数派，无法批准任何一个value。约束2并不要求只批准一个提案，暗示可能存在多个提案。只要提案的value是一样的，批准多个提案不违背约束2。于是可以产生约束P2。</p><p><strong>P2：一旦一个具有value v的提案被批准（chosen），那么之后批准（chosen）的提案必须具有value v。</strong></p><p>注：通过某种方法可以为每个提案分配一个编号，在提案之间建立一个全序关系，所谓“之后”都是指所有编号更大的提案。如果P1和P2都能够保证，那么约束2就能够保证。批准一个value意味着多个acceptor接受（accept）了该value.因此，可以对P2进行加强。</p><p><strong>P2a：一旦一个具有value v的提案被批准（chosen），那么之后任何acceptor再次接受（accept）的提案必须具有value v。</strong> </p><p>由于通信是异步的，P2a和P1会发生冲突。如果一个value被批准后，一个proposer和一个acceptor从休眠中苏醒，前者提出一个具有新的value的提案。根据P1，后者应当接受，根据P2a，则不应当接受，这中场景下P2a和P1有矛盾。于是需要换个思路，转而对proposer的行为进行约束。</p><p><strong>P2b：一旦一个具有value v的提案被批准（chosen），那么以后任何proposer提出的提案必须具有value v。</strong></p><p>由于acceptor能接受的提案都必须由proposer提出，所以P2b蕴涵了P2a，是一个更强的约束。但是根据P2b难以提出实现手段。因此需要进一步加强P2b。假设一个编号为m的value v已经获得批准（chosen），来看看在什么情况下对任何编号为n（n&gt;m）的提案都含有value v。因为m已经获得批准（chosen），显然存在一个acceptors的多数派C，他们都接受（accept）了v。考虑到任何多数派都和C具有至少一个公共成员，可以找到一个蕴涵P2b的约束P2c。</p><p><strong>P2c：如果一个编号为n的提案具有value v，那么存在一个多数派，要么他们中所有人都没有接受（accept）编号小于n 的任何提案，要么他们已经接受（accept）的所有编号小于n的提案中编号最大的那个提案具有value v。</strong></p><p>可以用数学归纳法证明P2c蕴涵P2b，根据数学归纳法，我们证明了若满足P2c，则P2b一定满足。假设具有value v的提案m获得批准，当n=m+1时，采用反证法，假如提案n不具有value v，而是具有value w，根据P2c，则存在一个多数派S1，要么他们中没有人接受过编号小于n的任何提案，要么他们已经接受的所有编号小于n的提案中编号最大的那个提案是value w。由于S1和通过提案m时的多数派C之间至少有一个公共的acceptor，所以以上两个条件都不成立，导出矛盾从而推翻假设，证明了提案n必须具有value v；若（m+1）..（N-1）所有提案都具有value v，采用反证法，假如新提案N不具有value v，而是具有value w’,根据P2c，则存在一个多数派S2，要么他们没有接受过m..（N-1）中的任何提案，要么他们已经接受的所有编号小于N的提案中编号最大的那个提案是value w’。由于S2和通过m的多数派C之间至少有一个公共的acceptor，所以至少有一个acceptor曾经接受了m，从而也可以推出S2中已接受的所有编号小于n的提案中编号最大的那个提案的编号范围在m..（N-1）之间，而根据初始假设，m..（N-1）之间的所有提案都具有value v，所以S2中已接受的所有编号小于n的提案中编号最大的那个提案肯定具有value v，导出矛盾从而推翻新提案n不具有value v的假设。根据数学归纳法，我们证明了若满足P2c，则P2b一定满足。P2c是可以通过消息传递模型实现的。另外，引入了P2c后，也解决了前文提到的P1不完备的问题。</p><h2 id="算法过程"><a href="#算法过程" class="headerlink" title="算法过程"></a>算法过程</h2><p>前面看不懂没关系，那是论文中的内容，晦涩难懂，下面开始用大白话来剥开Paxos算法。用一句话总结就是：proposer将发起提案（value）给所有accpetor，超过半数同意(accpet)后，提案获得批准(chosen)，提案写入accpetor内，最终所有accpetor获得一致性的确定性取值。</p><h3 id="prepare阶段"><a href="#prepare阶段" class="headerlink" title="prepare阶段"></a>prepare阶段</h3><ol><li>第一阶段A：Proposer选择一个提案号n，向所有的Acceptor广播proposal [n , null]提案请求。</li><li>第一阶段B：Acceptor接收到proposal [n , null] 提案请求，分为两种情况<ol><li>如果自己没有批准过提案，并且提案号n比之前收到过的proposal提案号都要大，回复[OK]并承诺将不会接受提案号比n小的提案号，如果提案比之前收到过的提案号小，则忽略当前提案请求。简而言之，在没批准过提案之前的Acceptor会不断接受新的提案。</li><li>如果自己已经批准过提案，则回复自己批准过的提案信息</li></ol></li></ol><h3 id="accept阶段"><a href="#accept阶段" class="headerlink" title="accept阶段"></a>accept阶段</h3><ol><li>第二阶段A：整个协议最为关键的点：Proposer得到了Acceptor响应。有以下几种情况<ol><li>如果没有收到超过半数accpetor回复，直接提议失败，proposer回到prepare阶段继续发起新提案</li><li>如果收到了超过半数的accpetor回复，又分为两种情况<ol><li>收到所有的accpetor回复都是[OK]，说明accpetor都没有批准过提案，那么向所有的Acceptor发起自己的提案信息[n , value]，这里要注意一定是所有的回复都是 [OK]。</li><li>收到所有的accpetor回复中有一部分回复的是批准的提案 [n1, value]，[n2, value]。那么从所有收到的提案中选择提案号最大的作为提案的值，提议编号仍然为n。作为提案向accpetor发起请求</li></ol></li></ol></li><li>第二阶段B：Acceptor接收到提议后，如果该提议版本号不等于自身保存记录的版本号（第一阶段记录的），不接受该请求，相等则写入本地。</li></ol><p>整个paxos协议过程盘根错节，复杂难懂，但只要把握和理解这两点就基本理解了paxos的精髓，这也是使得paxos算法最终收敛到一个提案的关键点：</p><ol><li><p>理解第一阶段accpetor的处理流程：如果Acceptor已经批准过提案，会保存当前请求过来的提案号，但不会接受提案，而是返回之前批准过的提案信息；如果Acceptor没有批准过提案，则本地记录当前请求的提案号，并承诺不再接受低于提案号的提案，简单来说只信任最后一次提交的版本号的请求；</p></li><li><p>理解第二阶段proposer的处理流程：未超过半数accpetor响应，提案失败，重新回到第一阶段发起提案请求；返回的accpetor值都为空才提交自身要写入的值，否则选择非空值里版本号最大的值提交，最大的区别在于是提交的值是自身的还是使用以前提交的。</p></li></ol><h2 id="活锁"><a href="#活锁" class="headerlink" title="活锁"></a>活锁</h2><p>在第一阶段，proposer提出提案后，Acceptor收到该提案比本地以前收到过的提案记录小会拒绝。因此proposer会继续提出编号更大的提案。这时Paxos算法存在一种极端情况，如果2个proposer都发现自己的编号过低转而交替提出更高编号的提案，如此这两个proposer会陷入死循环，这种情况称为活锁。Paxos算法的改进版Multi Paxos解决了这个问题。</p><h2 id="三军问题"><a href="#三军问题" class="headerlink" title="三军问题"></a>三军问题</h2><p>这里用三军问题，通过现实场景来描述一下Paxos算法是过程，三军问题比较切合Paxos算法的场景，也有很多博文使用三军问题来解释Paxos算法，这里三军是虚数，可以是五军也可以是七军，为了简单起见故用三军。故事背景是这样的：</p><ol><li>三支军队准备进攻攻打一个城邦，他们中任意一支军队单独攻打城邦，必败。其中两支军攻打城邦才有胜算，因此他们必须约定一个统一的时间，至少联合两支军队，才可以进攻。</li><li>每支军队有1个参谋负责提议进攻时间，每支军队也有1个将军批准参谋提出的进攻时间。</li><li>三支军队的唯一媒介是派通信兵告诉其他军队，自己军队提议的进攻时间信息。但通信兵可能被城邦的侦察兵捕获俘虏，导致信息丢失不能送达。（如果城邦的人把通信兵抓了后，修改了进攻时间信息，并放回了通信兵。就会出现拜占庭问题，即信息被篡改了。这里假设不存在这种情况）</li></ol><p>为了通过Paxos算法来使三军决策出一个进攻时间，还需要做出一些约束：每个军队的参谋在提出进攻时间的提案时，必须使用一个全局递增的编号，一个军队的将军在收到另外两支军队的提案时，只接受编号最大的提案。下面开始算法过程：</p><ol><li>参谋1发起提议，派通信兵带信给3个将军，内容为 [编号1 , null]；</li><li>三个将军的情况如下<ol><li>将军1和将军2收到参谋1的提议，将军1和将军2把 [编号1 , null] 记录下来，如果有其他参谋提出更小的编号，将被拒绝；同时让通信兵带信回去，内容为[Accepted]；</li><li>派往军队3的通信兵被抓，因此将军3没收到参谋1的提议；</li></ol></li><li>参谋2在同一时间也发起了提议，派通信兵带信给3个将军，内容为 [编号2 , null]；</li><li>三个将军的情况如下<ol><li>将军2和将军3收到参谋2的提议，将军2和将军3把 [编号2 , null] 记录下来，如果有其他参谋提出更小的编号，将被拒绝；同时让通信兵带信回去，内容为 [Accepted]；</li><li>派往军队1的通信兵被抓，因此将军1没收到参谋2的提议；</li></ol></li><li>参谋1收到至少2个将军的回复，再次派通信兵带信给有答复的2个将军，内容为 [编号1，进攻时间1]；</li><li>两个将军的情况如下<ol><li>将军1收到了 [编号1，进攻时间1] ，和自己保存的历史编号相同，因此把 [编号1，进攻时间1] 保存下来；同时让通信兵带信回去，内容为 [Accepted]；</li><li>将军2收到了 [编号1，进攻时间1]，由于编号1小于已经保存的编号2。因此让通信兵带信回去，内容为[Rejected，编号2]；</li></ol></li><li>参谋2收到至少2个将军的回复，再次派通信兵带信给有答复的2个将军，内容为 [编号2，进攻时间2]；</li><li>两个将军的情况如下<ol><li>将军2收到了 [编号2，进攻时间2]，和自己保存的编号相同，因此把[编号2，进攻时间2]保存下来，同时让通信兵带信回去，内容为 [Accepted]；</li><li>将军3收到了 [编号2，进攻时间2]，和自己保存的编号相同，因此把[编号2，进攻时间2]保存下来，同时让通信兵带信回去，内容为 [Accepted]；</li></ol></li><li>参谋2收到至少2个将军的 [Accepted] 内容，确认进攻时间已经被多数派接受；</li><li>参谋1只收到了1个将军的（Accepted）内容，同时收到一个 [Rejected，编号2]；参谋1重新发起提议，派通信兵带信给3个将军，内容为（编号3）；</li><li>三个将军的情况如下<ol><li>将军1收到参谋1的提议，由于[编号3]大于之前保存的[编号1]，因此把[编号3]保存下来；由于将军1已经接受参谋1前一次的提议，因此让通信兵带信回去，内容为[编号1，进攻时间1]；</li><li>将军2收到参谋1的提议，由于[编号3]大于之前保存的[编号2]，因此把[编号3]保存下来；由于将军2已经接受参谋2的提议，因此让通信兵带信回去，内容为[编号2，进攻时间2]；</li><li>负责通知将军3的通信兵被抓，因此将军3没收到参谋1的提议；</li></ol></li><li>参谋1收到了至少2个将军的回复，比较两个回复的编号大小，选择大编号对应的进攻时间作为最新的提议；参谋1再次派通信兵带信给有答复的2个将军，内容为[编号3，进攻时间2]；</li><li>将军1和将军2收到了[编号3，进攻时间2]，和自己保存的编号相同，因此保存[编号3，进攻时间2]，同时让通信兵带信回去，内容为[Accepted]；</li><li>参谋1收到了至少2个将军的[accepted]内容，确认进攻时间已经被多数派接受；</li></ol>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VUE简介与前后端分离架构</title>
      <link href="/2020/02/22/vue-jian-jie-yu-qian-hou-duan-fen-chi-jia-gou/"/>
      <url>/2020/02/22/vue-jian-jie-yu-qian-hou-duan-fen-chi-jia-gou/</url>
      
        <content type="html"><![CDATA[<p>前后端分离已成为互联网项目开发的业界标准使用方式，通过nginx+tomcat的方式有效的进行解耦，并且前后端分离会为以后的大型分布式架构、弹性计算架构、微服务架构、多端化服务（多种客户端，例如：浏览器，车载终端，安卓，IOS等等）打下坚实的基础。这个步骤是系统架构从猿进化成人的必经之路。以前的Java Web项目大多数都是Java程序员又当爹又当妈，又搞前端，又搞后端。随着技术的不断发展更新，渐渐的许多大中小公司开始把前后端的界限分的越来越明确，前端工程师只管前端的事情，后端工程师只管后端的事情。正所谓术业有专攻，一个人如果什么都会，那么他毕竟什么都不精。前后端分离技术实现了前端和后端从开发到部署的完全分离，使得前端和后端可以同时开发，极大的提高了开发效率。由此也诞生了一些前端框架，VUE就是其中的佼佼者。</p><p><img src="/2020/02/22/vue-jian-jie-yu-qian-hou-duan-fen-chi-jia-gou/1.png" alt></p><h2 id="前后端分离架构图"><a href="#前后端分离架构图" class="headerlink" title="前后端分离架构图"></a>前后端分离架构图</h2><p>前后端分离并不只是开发模式，而是web应用的一种架构模式。在开发阶段，前后端工程师约定好数据交互接口，实现并行开发和测试；在运行阶段前后端分离模式需要对web应用进行分离部署，前后端之前使用HTTP或者其他协议进行交互请求。前后端交互方式通常是JSON格式数据。</p><h3 id="前后端分离架构图-1"><a href="#前后端分离架构图-1" class="headerlink" title="前后端分离架构图"></a>前后端分离架构图</h3><p><img src="/2020/02/22/vue-jian-jie-yu-qian-hou-duan-fen-chi-jia-gou/2.png" alt></p><h3 id="前端架构设计图"><a href="#前端架构设计图" class="headerlink" title="前端架构设计图"></a>前端架构设计图</h3><p><img src="/2020/02/22/vue-jian-jie-yu-qian-hou-duan-fen-chi-jia-gou/5.png" alt></p><h2 id="Vue简介"><a href="#Vue简介" class="headerlink" title="Vue简介"></a>Vue简介</h2><p>Vue是一套用于构建用户界面的<strong>渐进式框架</strong>。与其它大型框架不同的是，Vue 被设计为可以自底向上逐层应用。Vue 的核心库只关注视图层，不仅易于上手，还便于与第三方库或既有项目整合。另一方面，Vue 完全有能力驱动采用单文件组件和 Vue 生态系统支持的库开发的复杂单页应用。Vue的作者借鉴了angular和react的优点，使得Vue成为当下最流行的前端框架。 </p><h3 id="Vue的特点"><a href="#Vue的特点" class="headerlink" title="Vue的特点"></a>Vue的特点</h3><ol><li><p><strong>轻量级框架</strong>：核心库只关注视图层，是一个构建数据的视图集合，大小只有几十kb </p></li><li><p><strong>数据双向绑定</strong>：保留了angular的特点，界面的操作能实时反映到数据，数据的变更能实时展现到界面。(mvvm即Model-View-ViewModel数据到视图，视图到数据的双向绑定模式) </p></li><li><p><strong>组件化开发</strong>：保留了react的优点，实现了html的封装和复用,在构建单页面应用方面有着独特的优势 </p></li><li><p><strong>虚拟DOM</strong>：原生js和jquery都是基于真实的dom操作，是非常耗费性能的。Vue通过虚拟dom操作节点，很大程度上减小了真实的dom操作（例如表格数据），极大的提升页面渲染性能 </p></li></ol><h3 id="vue与其他框架的关系"><a href="#vue与其他框架的关系" class="headerlink" title="vue与其他框架的关系"></a>vue与其他框架的关系</h3><p>如今前端框架可谓百花齐放，各种各样的框架层出不穷，看的人眼花缭乱。所以明白Vue在这些框架中扮演的角色尤为重要，实际上前端框架可分为几大类，一是ui框架，ui框架很多如eayui，bootstrap。二是工具型框架，典型的就是jquery，三是工程级别的框架，vue等。vue能帮助我们合理的设计和组织前端代码，提高代码复用性。当使用vue把html代码封装成组件后，组件之间可以相互引用，可以继承实现扩展，组件可以传参通信，有利于构建大型复杂的应用。下面是vue与其他框架的关系</p><ol><li><p><strong>vue与angular，react</strong>：竞争关系，并称为前端三大框架。vue与react属于mvvm模式，angular也是mvvm，但也有mvc成分，它们都是优秀的前端框架。目前vue追随者最多。 </p></li><li><p><strong>vue与jquery</strong>：严格来说jquery不能称之为框架，而是一个为了简化原生js复杂繁琐操作的工具库，因为jquery并不能帮组我们组织和复用前端代码。二者可以混合使用，jquery是基于真实的dom操作，vue专注于数据驱动dom操作。二者在实现思想上就有本质的区别 。</p></li><li><p><strong>vue与easyui，bootstrap等</strong>：不是一个维度的东西。eayui和bootstrap都是ui层框架，esyui基于js实现，bootstrap基于css实现。它们对前端开发模式没有根本性的改变，与vue比起来只能算是前端ui库。eayui和bootstrap可以作为vue视图层的实现去使用。</p></li></ol><h3 id="Vue的生态"><a href="#Vue的生态" class="headerlink" title="Vue的生态"></a>Vue的生态</h3><ol><li><p><strong>Vue-router</strong>：前端路由控制器，官方维护的路由插件。 </p></li><li><p><strong>Vue-Bus</strong>：总线控制，用于vue组件之间的通信 </p></li><li><p><strong>Vuex</strong>：用于状态管理，降低组件与组件之间的耦合，也用于组件通信 </p></li><li><p><strong>Vue-devtools</strong>：基于谷歌浏览器的一款调试vue.js应用的开发者浏览器扩展插件 </p></li><li><p><strong>Vue-cli</strong>： Vue的脚手架，快速的构建vue的工程。 </p></li><li><p><strong>Vue-axios</strong>：基于Promise的http请求客户端，可同时在浏览器和 Node.js 中使用。 </p></li><li><p><strong>UI</strong>：基于Vue的UI框架也很多 </p></li></ol><p>​      (1)     <strong>Element</strong>：饿了么开源的基于vue 2.0后台UI框架，适用PC端 </p><p>​      (2)     <strong>Iview</strong>：主要服务于 PC 界面的中后台产品，由Talking </p><p>Data团队开发维护 </p><h3 id="Vue工程目录结构"><a href="#Vue工程目录结构" class="headerlink" title="Vue工程目录结构"></a>Vue工程目录结构</h3><p>通过vue-cli生成vue工程，首先本地确保已经安装了vue-clie，如果没有安装可执行以下命令安装</p><pre><code>// 全局安装 vue-cli$ cnpm install –global vue-cli// my-project为自定义项目名$ vue init webpack my-project</code></pre><p>不同的vue-cli版本项目目录结构可能和下面的稍有区别，下面是vue-cli（版本2.9.9）以webpack模板生成的项目。</p><pre><code>|-- build                 // 项目构建(webpack)相关代码|-- build.js              //生产环境构建代码|-- check-version.js        // 检查node、npm等版本|-- utils.js                 // 构建工具相关|-- vue-loader.conf.js          // webpack loader配置|-- webpack.base.conf.js        // webpack基础配置|-- webpack.dev.conf.js         // webpack开发环境配置,构建开发本地服务器|-- webpack.prod.conf.js        // webpack生产环境配置|-- config                          // 项目配置|   |-- dev.env.js                   // 开发环境变量|   |-- index.js                     // 项目一些配置变量|   |--prod.env.js                  // 生产环境变量                                               |--node_modules                       //项目依赖的第三方包，下载依赖包时自动创建|--dist                              //npm项目打包后的默认输出路径，打包时自动创建|-- src                             // 源码目录，开发常用的目录|   |-- components                 // vue公共组件|   |-- router                      // vue的路由管理|   |-- App.vue                     // 页面入口文件|   |-- main.js                      // 程序入口文件，加载各种公共组件|-- static                           // 静态文件，比如一些图片，json数据等|-- .babelrc                         // ES6语法编译配置|-- .editorconfig                     // 定义代码格式|-- .postcsssrc                       // postcss配置文件|-- index.html                       // 入口页面|-- package.json                     // 项目基本信息,包依赖信息等</code></pre><h3 id="Vue项目的部署"><a href="#Vue项目的部署" class="headerlink" title="Vue项目的部署"></a>Vue项目的部署</h3><p>Vue部署方式分为两种，一种主流的开发分离，部署分离，第二种非主流的开发分离，部署不分离。第一种方式实际上前后端已经完全分离，前端和后端是两个服务，它们通过http协议通信，第二种方式就是传统的方式，只是传统方式一般使用jsp模板引擎开发，而这里使用vue开发，vue编译之后会把编译后的前端代码复制到后端项目中。后端仍然使用模板引擎的方式返回前端代码。</p><h4 id="开发分离，整体部署"><a href="#开发分离，整体部署" class="headerlink" title="开发分离，整体部署"></a>开发分离，整体部署</h4><p>适合业务相对独立的小型应用，部署容易，启动简单，不需要额外的前端web容器，减小维护成本。缺点前后端仍然是耦合在一个项目中，如果单是前端或是后端的代码修改也只能把整个项目重新部署，后期如果业务扩展导致后端拆分，这种方式就不适用了，改动较大。此外模板引擎只支持html的，对于jsp的模板引擎不支持（因为vue打包后生成html文件）。关于打包时整体打包的方法，在之前的博客中已经介绍过，这里就不赘述了，想了解整体打包<a href="https://lushunjian.gitee.io/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/">点击这里</a></p><h4 id="开发分离，部署分离"><a href="#开发分离，部署分离" class="headerlink" title="开发分离，部署分离"></a>开发分离，部署分离</h4><p>试想一种业务场景，前端页面左边的下拉菜单中一个菜单选项的数据全部来自A服务，另一个菜单选项全部来自B服务。这种情况如果使用第一种部署方式就不适用了，因为前端访问涉及到多个服务，无论把前端代码放在哪一个服务中都不合适，而且前端在一个服务上访问另一个服务会出现跨域问题。此时应使用前后端分离部署，这时前端可以根据不同服务设置不同的路由，例如当访问A服务时，所有路由以 /a开头，当访问B服务时，所有路由以 /b开头。然后通过nginx做反向代理，通过不同路由访问不同的服务。我们把vue打包好的工程放在服务器上的某个目录，然后核心配置如下</p><pre><code>server {        listen       8012;        server_name  127.0.0.1;                  location        /rms/ {              proxy_pass              http://10.10.10.10:8080/;         }         location        /cis/ {              proxy_pass              http://10.10.10.11:8081/;         }   }</code></pre><p>这种部署方式，适用于后端服务是大型的微服务集群，前端代码已不适合放在任何一个服务中，因此把前端代码抽离出来，前端和后端服务各自独立运行，前后端通过http方式进行数据交互。但需要多维护一个nginx集群（解决前端服务的单点问题）</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开发常用工具</title>
      <link href="/2020/02/19/kai-fa-chang-yong-gong-ju/"/>
      <url>/2020/02/19/kai-fa-chang-yong-gong-ju/</url>
      
        <content type="html"><![CDATA[<p>工欲善其事必先利其器！在编程开发中能够使用好一些开发辅助工具能够让我们事半功倍。Perl之父Larry Wall曾在 Programming Perl 一书中提到：程序员的三个美德是<strong>懒惰</strong>、<strong>不耐烦</strong>和<strong>傲慢</strong>。<strong>懒惰，是程序员美德的第一要素。</strong>Larry Wall所说的“懒惰”，并不是安于现状和不思进取，而是付出最少的时间或者精力来达到同样甚至更好的目标。“懒惰”的程序员会尽量使自己的代码既实用又有很好的可读性，这样可以节省后面的很多维护成本；还会尽力完善代码中的注释及文档，以免别人问自己太多问题，更擅长使用各种工具，从方方面面提升自己的效率。下面就总结一下开发过程中常用的开发工具</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/1.jpg" alt></p><h2 id="IntelliJIDEA"><a href="#IntelliJIDEA" class="headerlink" title="IntelliJIDEA"></a>IntelliJIDEA</h2><p> IntelliJ IDEA是IDEA 的全称，是java编程语言开发的集成环境。IntelliJ在业界被公认为最好的java开发工具，尤其在智能代码助手、代码自动提示、重构、J2EE支持、各类版本工具(git、svn等)、JUnit、CVS整合、代码分析、 创新的GUI设计等方面的功能可以说是超常的。IDEA是<a href="https://baike.baidu.com/item/JetBrains" target="_blank" rel="noopener">JetBrains</a>公司的产品，这家公司总部位于捷克共和国的首都布拉格，开发人员以严谨著称的东欧程序员为主。它的旗舰版本还支持HTML，CSS，PHP，MySQL，Python等。免费版只支持Python等少数语言。Java集成开发工具主流的有<strong>IntelliJIDEA</strong>和<strong>Eclipse</strong>。这两款开发工具之争由来已久，不过最近几年，IntelliJIDEA逐渐撼动了Eclipse的霸主地位，成为开发者的首选开发工具。笔者也经历过从Eclipes转向IntelliJ IDEA的过程，相比之下，Intellij IDEA在某些方面如代码提示，插件等确实比Eclipse更加出色一些。下面是IDEA工具的开发界面，酷酷的黑色主题既不那么伤眼也很装逼有不有~</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/2.png" alt></p><h2 id="SecureCRT"><a href="#SecureCRT" class="headerlink" title="SecureCRT"></a>SecureCRT</h2><p>SecureCRT是一款终端仿真程序，支持SSH（SSH1和SSH2）以及Telnet和rlogin协议。SecureCRT用于连接运行包括Windows、UNIX和VMS在内的远程系统的理想工具。有流行CRTTelnet客户机的所有特点,包括:自动注册、对不同主机保持不同的特性、打印功能、颜色设置、可变屏幕尺寸、用户定义的键位图和优良的VT100,VT102,VT220和ANSI竞争.能从命令行中运行或从浏览器中运行.其它特点包括文本手稿、易于使用的工具条、用户的键位图编辑器、可定制的ANSI颜色等。SecureCRT是本人使用的第一款SSH连接工具，后来又使用过Xshell，Putty等。还是钟爱于SecureCRT。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/3.png" alt></p><h2 id="Beyond-Compare"><a href="#Beyond-Compare" class="headerlink" title="Beyond Compare"></a>Beyond Compare</h2><p>Beyond Compare是一套由Scooter Software推出的文件比较工具。是一款不可多得的专业级的文件夹和文件对比工具。使用他可以很方便的对比出两个文件夹或者文件的不同之处。并把相差的每一个字节用颜色加以表示，查看方便。并且支持多种规则对比。Beyond Compare 3 可以对文本、mp3、图片、数据、注册表等进行比较分析。对于程序员，你可以用它来对比两份代码的变化，甚至可以用它来比较文件版本和文件夹。在进行文件比较的使用界面中，软件提供了全部显示、差异显示、相同行显示、逐段比较、交换两侧等极其方便的按钮，使用文本差异一目了然，显而易见。与其它同类软件相比，Beyond Compare 3 除了具体以上全面的比较功能外，还附带了文件合并和文件夹同步两种实用工具。并且支持便携式安装，完全不写系统注册表，你可以把它放到U盘里，随时使用！这个文件对比工具是在工作中经常会使用到的，简单方便。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/4.png" alt></p><h2 id="UltraEdit"><a href="#UltraEdit" class="headerlink" title="UltraEdit"></a>UltraEdit</h2><p>UltraEdit 是一套功能强大的文本编辑器，可以编辑文本、十六进制、ASCII 码，完全可以取代记事本（如果电脑配置足够强大），内建英文单字检查、C++ 及 VB 指令突显，可同时编辑多个文件，而且即使开启很大的文件速度也不会慢。UltraEdit 是 Windows 旗下一款流行的老牌文本/HEX 编辑器（非开源）。UltraEdit 正被移植到 Linux 平台。该移植名为 UEX，意即 UltraEdit forLinux。UEX具有原生的 Linux 外观，其界面、配置、热键等与 Windows 版并无二致。UltraEdit是一个49.95美元的共享软件，提供了友好界面的编程编辑器，支持语法高亮，代码折叠和宏，以及一大堆其他的功能，内置了对于HTML、PHP和JavaScript等语法的支持。UltraEdit代码折叠支持在所有 32 位Windows平台上进行 64 位文件处理（标准），Unicode 支持基于磁盘的文本编辑和大文件处理 - 支持超过 4GB 的文件，即使是数兆字节的文件也只占用极少的内存。本人在使用它之前一直使用notepad++，对于一些常用的处理实际上notepad++也完全够用，而且notepad++安装包非常小，轻便。但notepad++对于内存管理做的不好，导致对于一些大文件如十几兆，几十兆的文件时，notepad++会打不开，甚至直接闪退，卡死等。这一点上UltraEdit 就甩了它几条街了。UltraEdit 并不是免费软件，需要破解。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/5.png" alt></p><h2 id="StarUML"><a href="#StarUML" class="headerlink" title="StarUML"></a>StarUML</h2><p>StarUML是一款开放源码的UML开发工具，是由韩国公司主导开发出来的产品，可以直接到StarUML网站下载。可以用来创建UML类图。StarUML 支持多种格式的影像文件可导出JPG、JPEG、BMP、EMF和WMF等格式的影像文件。 StarUML 可以依据类图的内容生成Java、C++、C#代码，也能够读取Java、C++、C#代码反向生成类图。反向工程有两个主要用途，其一是旧有的源码反转成图之后，可以构建UML模型的方式继续将新的设计添加上去；另一项用途是想要解析源码时，可以通过反转的类图来理解，不再需要查看一行又一行的代码，这将节省大量的时间和精力。可到官网下载即可(建议下载staruml3.0.2版本）。破解方式到软件安装目录如 C:\Program Files\StarUML\resources。把这个目录下的app.asar替换掉即可。破解app.asar文件，链接: <a href="https://pan.baidu.com/s/1UGa8VBCTfPnkEhAyIUcb3Q" target="_blank" rel="noopener">https://pan.baidu.com/s/1UGa8VBCTfPnkEhAyIUcb3Q</a> 提取码: 16pk。下面是StarUML的工作界面图，看起来很清爽</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/6.png" alt></p><h2 id="Postman"><a href="#Postman" class="headerlink" title="Postman"></a>Postman</h2><p>这个工具做后端接口开发的都不模式吧，Postman是404大厂的基于javascript语言完成的一款超级强大的插件，名字也很亲近（邮递员）。postman为用户提供强大的 Web API &amp; HTTP 请求调试功能。postman能够发送任何类型的HTTP 请求 (GET, HEAD, POST, PUT等)，附带任何数量的参数+ headers，是一款非常实用的调试工具。postman适用于不同的操作系统，Postman Mac、Windows X32、Windows X64、Linux系统，还支持postman 浏览器扩展程序、postman chrome应用程序等。前端后台测试使用Postman都可以提供很多帮助,使用方便而且功能全面。最赞的是还有接口文档在线生成，一边测试一边就可以完成文档的编写。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/7.png" alt></p><h2 id="WinSCP"><a href="#WinSCP" class="headerlink" title="WinSCP"></a>WinSCP</h2><p>WinSCP是Martin Prikryl公司发布的基于SSH的FTP客户端软件。WinSCP界面清新简洁友好，用户能在较短的时间内掌握软件的使用。WinSCP是一个Windows环境下使用SSH的开源图形化SFTP客户端。同时支持SCP协议。它的主要功能就是在本地与远程计算机间安全的复制文件。WinSCP可以执行所有基本的文件操作，例如下载和上传。同时允许为文件和目录重命名、改变属性、建立符号链接和快捷方式。WinSCP是本人最喜欢使用的服务器文件传输工具，在没有持续集成的年代，基本上就是使用去环境上发布服务，拉取服务器上的日志文件等。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/8.png" alt></p><h2 id="JD-GUI"><a href="#JD-GUI" class="headerlink" title="JD-GUI"></a>JD-GUI</h2><p>JD-GUI是一款基于Java的反编译工具，它包括图形化界面，eclipse插件以及idea插件，采用C++开发,支持苹果Mac、微软windows以及Linux多个平台,可以反编译class文件、jar包等。用的人比较多。但是它已经好久没有更新了，JAVA7的代码很多语法都不支持,就别提已经大热的JAVA8了，在我说完这句话的时候,去oracle官网一看,jdk13都发布惹。。。不过凭借着便捷与图形化还是再加上时间的沉淀，作者还是给它排在第一位。对了,JD-GUI的核心其实是听过jd-core来完成的。您可以使用<strong>JD-GUI</strong>中文版浏览和重建源代码的即时访问方法和字段，以代码高度方式来显示反编译过来的代码。在工作中可能会碰到一些莫名其妙的问题，就需要反编译查看，这个工具少不了。</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/9.png" alt></p><h2 id="GitMind"><a href="#GitMind" class="headerlink" title="GitMind"></a>GitMind</h2><p>GitMind是一款在线思维导图软件。支持Windows、Mac系统。为用户提供思维导图、鱼骨图、逻辑结构图、流程图的绘制。支持自主选择思维导图模版；可导出JPG、PNG图片、PDF文档以及TXT文本等多种格式 。作为开发人员，有时候整体系统文档或交付时画系统的思维导图，流程图不可避免。笔者用过Visio，ProcessOn。但Visio太过笨重了，安装包非常大，ProcessOn是在线作图很方便不过是付费的。知道发现了GitMind，它可以画流程图，思维导图。更重要的是它是完全免费的，良心工具推荐一下</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/15.png" alt></p><h2 id="Cmder"><a href="#Cmder" class="headerlink" title="Cmder"></a>Cmder</h2><p>Cmder是Windows下非常好用的终端模拟器， 常用于替换windows自带的终端。它可以在不同的标签页中同时连接不同的底层Shell，包括cmd、PowerShell、Bash和WSL，并提供相关增强功能和更加便捷的操作方式，这也正是它被大家称作为Windows下的神器的原因。它支持了大部分的Linux命令。支持ssh连接linux，使用起来非常方便。比起cmd、powershell、conEmu，其界面美观简洁，功能强大。下面来看看效果</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/14.png" alt></p><h2 id="Mockplus"><a href="#Mockplus" class="headerlink" title="Mockplus"></a>Mockplus</h2><p>Mockplus（摹客）是一款简洁快速的原型图设计工具。适合软件团队、个人在软件开发的设计阶段使用。其低保真、无需学习、快速上手、功能够用。并能够很好地表达自己的设计。在写前端页面时先需画出原型图，这时原型图工具Mockplus就派上用场了，当然人各有好，还有很多其他优秀的原型图工具，如墨刀和axure。Mockplus的优点是基础版免费使用，操作简单，上手快，交互简单(只需拖曳就可以)，功能多样，组件资源丰富，预览方式和导出类型多样，支持团队协作。对于一些常规的原型图足够，如果你是专业人士推荐axure。下面是Mockplus的操作界面，还是比较美的</p><p><img src="/2020/02/19/kai-fa-chang-yong-gong-ju/10.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 其他 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot与Vue项目整合打包</title>
      <link href="/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/"/>
      <url>/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/</url>
      
        <content type="html"><![CDATA[<p>最近在公司项目需要做前端优化，项目是一个比老的项目，前端使用的是easyui后端用的是spring mvc。目前后端已经把代码迁移到spring-boot框架。但前端一直还是用的easyui，由于当前vue比较火爆，于是尝试用vue进行前端界面优化。本人之前有过使用vue的经验，这个任务就交到我身上了（我太难了。。）主流的使用vue的方式是使用前后端分离的方式，即后端用微服务架构，前端用nginx作为web服务器。但由于项目团队前端力量薄弱，所以我采用了一种维护成本较低的方式，即开发的时候使用前后端分离开发，但打包阶段把前端代码和后端代码整合到一个包中部署。这样无需额外再安装nginx服务，最后只需部署springboot的项目即可。</p><p><img src="/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/1.jpg" alt></p><p>这里有两种方式，可以实现这个功能。在前端打包到后端工程之前，还需要把后端项目先配置好。SpringBoot对于前端UI是支持多种模板引擎的。但由于前端工程打包之后的文件是html文件，所以SpringBoot工程只能配置基于html文件的模板引擎，这里我使用官方推荐的thymeleaf模板引擎。</p><h2 id="SpringBoot项目配置"><a href="#SpringBoot项目配置" class="headerlink" title="SpringBoot项目配置"></a>SpringBoot项目配置</h2><p>通过官方网站初始化SpringBoot工程，在pom.xml中加入thymeleaf模板引擎依赖，同时还需要加入html5文件的非严格检查依赖，同时在application.yml中加入必要的配置，不然浏览器可能会报错，具体配置如下</p><pre class=" language-xml"><code class="language-xml">        <span class="token comment" spellcheck="true">&lt;!-- thymeleaf模板引擎 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- html5非严格检查 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>net.sourceforge.nekohtml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>nekohtml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.9.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>application.xml的配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span><span class="token key atrule">spring</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># templates 模板引擎配置</span>  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>     <span class="token key atrule">mode</span><span class="token punctuation">:</span> LEGACYHTML5  <span class="token comment" spellcheck="true"># 不进未关闭标签检查，需配合nekohtml使用</span>     <span class="token key atrule">encoding</span><span class="token punctuation">:</span> UTF<span class="token punctuation">-</span><span class="token number">8</span>     <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false     </span><span class="token comment" spellcheck="true"># 关闭缓存</span>     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/templates/     <span class="token key atrule">suffix</span><span class="token punctuation">:</span> .html</code></pre><p>工程创建完成后，目录结构如下。其中resources下的templates就是前端代码的文件路径。下面还有一个static目录，这其实是vue打包完成后的文件目录。vue打包完成的文件名就叫static，这里是原封不动的放在了templates目录下。因此这里还需要一个额外的操作，不然前端可能无法访问static下的静态文件。</p><p><img src="/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/2.png" alt></p><p>vue打包完成后是以static作为根路径去加载 js和css文件的，所以需要对static里面的文件做一次映射，把templates/static/目录映射成/static目录，对应的SpringBoot配置类如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lsj<span class="token punctuation">.</span>config<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ComponentScan<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ResourceUtils<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>EnableWebMvc<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ResourceHandlerRegistry<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>WebMvcConfigurer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>WebMvcConfigurerAdapter<span class="token punctuation">;</span><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@EnableWebMvc</span><span class="token annotation punctuation">@ComponentScan</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 静态文件映射     * addResourceHandler指的是对外暴露的访问路径，addResourceLocations指的是文件放置的目录     * 映射之后，Controller返回到 html ，使用映射后的路径     * 如下将 static 下的静态文件映射到根路径下，     * 文件实际路径 /static/semantic/semantic.min.js 映射之后     * 在 html 中就可以通过 semantic/semantic.min.js 路径访问静态文件     *     * 也可映射绝对路径,例如下面注释，把D盘static中的静态文件，映射到项目根路径下     * */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span>ResourceHandlerRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">"/static/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span>ResourceUtils<span class="token punctuation">.</span>CLASSPATH_URL_PREFIX<span class="token operator">+</span><span class="token string">"/templates/static/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到这里后端工程准备完毕，下面用前端工程来搞点事情吧。把前端工程的代码整合到后端工程中，这里有两种方式，第一种简单粗暴但不适合自动化部署，第二种比较复杂些，但是可以通过maven一键打包。</p><h2 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h2><p>前端开发好后将build构建好的dist下的文件拷贝到springboot的resources的static下。操作步骤：前端vue项目使用命令 npm run build 或者 cnpm run build 打包生成dist文件，在springboot项目中resources下建立static文件夹，将dist文件中的文件复制到static中，然后去application中跑起来boot项目，这样直接访问index.html就可以访问到页面（api接口请求地址自己根据情况打包时配置或者在生成的dist文件中config文件夹中的index.js中配置）</p><p><img src="/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/3.png" alt></p><p>这是vue前端工程的目录结构，使用npm打包后会生成dist目录。我们需要把dist目前下的全部文件都拷贝到后端SpringBoot工程中resources目录的templates目前下。然后启动前端工程就可以了。这是最简单的方式，但是如果作为工程级的项目开发，并不推荐使用手工合并。下面是第二种方式</p><h2 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h2><p>为了前后端代码分离开发，这里我创建了两个独立的工程，一个后端工程和一个前端工程，然后两个工程通过maven聚合组成一个工程。最终工程的目录结构如下</p><p><img src="/2020/02/18/springboot-yu-vue-xiang-mu-zheng-he-da-bao/5.png" alt></p><p>具体的pom.xml的配置如下</p><pre class=" language-xml"><code class="language-xml">    <span class="token comment" spellcheck="true">&lt;!-- parent --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>vue-element-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>spring-boot-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- spring --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.lsj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-vue-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">></span></span>../<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- vue --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.lsj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-vue-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">></span></span>../<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></code></pre><p>然后在vue工程中就不再直接使用npm打包了，而是通过maven调用npm的打包命令。vue工程pom.xml的关键的配置</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 调用npm命令插件 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.codehaus.mojo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>exec-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                    <span class="token comment" spellcheck="true">&lt;!-- 先执行前端依赖下载 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>exec-npm-install<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>npm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arguments</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argumnet</span><span class="token punctuation">></span></span>install<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argumnet</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arguments</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workingDirectory</span><span class="token punctuation">></span></span>${basedir}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workingDirectory</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                    <span class="token comment" spellcheck="true">&lt;!-- npm打包 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>exec-npm-run-build<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>npm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arguments</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argumnet</span><span class="token punctuation">></span></span>run<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argumnet</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argumnet</span><span class="token punctuation">></span></span>build<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argumnet</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arguments</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workingDirectory</span><span class="token punctuation">></span></span>${basedir}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workingDirectory</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></code></pre><p>SpringBoot工程pom.xml关键配置</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">></span></span>com.lsj.StartApplication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- 把vue打包后的 dist目录下的所有文件拷贝到resource目录下 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-resources-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${maven.resource.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>copy-static<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>validate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>copy-resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outputDirectory</span><span class="token punctuation">></span></span>src/main/resources/templates<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outputDirectory</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>overwrite</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>overwrite</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>                                    <span class="token comment" spellcheck="true">&lt;!-- 因为vue-cli打包目录在项目跟目录，所以从这里复制 --></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>../vue-element-demo/dist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></code></pre><p>父工程中配置编译插件</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!--编译插件--></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${maven.compiler.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">></span></span>${java.source.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>${java.target.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">></span></span>${file.encoding}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></code></pre><p>最终只需要执行父工程的打包命令，即可将前后端整体打包成一个jar包。部署时只需部署这个jar包就行了</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-boot各版本Java版本要求</title>
      <link href="/2020/01/18/spring-boot-ge-ban-ben-java-ban-ben-yao-qiu/"/>
      <url>/2020/01/18/spring-boot-ge-ban-ben-java-ban-ben-yao-qiu/</url>
      
        <content type="html"><![CDATA[<p>Spring Boot 与 Java 对应版本，以下表格由官方网站总结。官网：<a href="https://spring.io/projects/spring-boot#learn" target="_blank" rel="noopener">https://spring.io/projects/spring-boot#learn</a> 。具体版本依赖地址：<a href="https://docs.spring.io/spring-boot/docs/{verion}/reference/htmlsingle/" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/{verion}/reference/htmlsingle/</a>   查看此条目：System Requirements。</p><table><thead><tr><th><strong>Sping Boot</strong></th><th><strong>Spring Framework</strong></th><th><strong>Java</strong></th><th><strong>Maven</strong></th><th><strong>Gradle</strong></th><th><strong>Tomcat</strong></th><th><strong>Jetty</strong></th></tr></thead><tbody><tr><td><strong>Spring Boot 2.3.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>2.3.0.BUILD-SNAPSHOT</td><td>5.2.3.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>6.x</td><td>9.0</td><td>3.1</td></tr><tr><td><strong>Spring Boot 2.2.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>2.2.3.RELEASE</td><td>5.2.3.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>5.0 +</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.2.RELEASE</td><td>5.2.2.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>5.0 +</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.1.RELEASE</td><td>5.2.1.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.0.RELEASE</td><td>5.2.0.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.0.RC1</td><td>5.2.0.RELEASE</td><td>Java 8~13</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.0.M6</td><td>5.2.0.RC2</td><td>Java 8~12</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.0.M5</td><td>5.2.0.RC1</td><td>Java 8~12</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td>2.2.0.M4</td><td>5.2.0.RC1</td><td>Java 8~11</td><td>3.3+</td><td>5.x</td><td>4.0</td><td>3.1</td></tr><tr><td><strong>Spring Boot 2.1.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>2.1.9.RELEASE</td><td>5.1.10.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.8.RELEASE</td><td>5.1.9.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.7.RELEASE</td><td>5.1.9.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.6.RELEASE</td><td>5.1.8.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.5.RELEASE</td><td>5.1.7.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.4.RELEASE</td><td>5.1.6.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.3.RELEASE</td><td>5.1.5.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.2.RELEASE</td><td>5.1.4.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.12.RELEASE</td><td>5.1.13.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.11.RELEASE</td><td>5.1.12.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.10.RELEASE</td><td>5.1.11.RELEASE</td><td>Java 8~12</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.1.RELEASE</td><td>5.1.3.RELEASE</td><td>Java 8~11</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.0.RC1</td><td>5.1.1.RELEASE</td><td>Java 8~9</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.0.M4</td><td>5.1.0.RELEASE</td><td>Java 8~9</td><td>3.3+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.0.M3</td><td>5.1.0.RC3</td><td>Java 8~9</td><td>3.2+</td><td>4.4+</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.0.M2</td><td>5.1.0.RC2</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>9.0</td><td>9.4</td></tr><tr><td>2.1.0.M1</td><td>5.1.0.RC1</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>9.0</td><td>9.4</td></tr><tr><td><strong>Spring Boot 2.0.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>2.0.9.RELEASE</td><td>5.0.13.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.8.RELEASE</td><td>5.0.12.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.7.RELEASE</td><td>5.0.11.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.6.RELEASE</td><td>5.0.10.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.5.RELEASE</td><td>5.0.9.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.4.RELEASE</td><td>5.0.8.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.3.RELEASE</td><td>5.0.7.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.2.RELEASE</td><td>5.0.6.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.1.RELEASE</td><td>5.0.5.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.RELEASE</td><td>5.0.4.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.RC2</td><td>5.0.4.RELEASE</td><td>Java 8~9</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.RC1</td><td>5.0.3.RELEASE</td><td>Java 8</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M7</td><td>5.0.2.RELEASE</td><td>Java 8</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M5</td><td>5.0.0.RELEASE</td><td>Java 8</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M4</td><td>5.0.0.RC4</td><td>Java 8</td><td>3.2+</td><td>4.x</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M3</td><td>5.0.0.RC3</td><td>Java 8</td><td>3.2+</td><td>3.4+</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M2</td><td>5.0.0.RC2</td><td>Java 8</td><td>3.2+</td><td>3.4+</td><td>8.5</td><td>9.4</td></tr><tr><td>2.0.0.M1</td><td>5.0.0.RC1</td><td>Java 8</td><td>3.2+</td><td>3.4+</td><td>8.5</td><td>9.4</td></tr><tr><td><strong>Spring Boot 1.5.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>1.5.9.RELEASE</td><td>4.3.13.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.8.RELEASE</td><td>4.3.12.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.7.RELEASE</td><td>4.3.11.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.6.RELEASE</td><td>4.3.10.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.5.RELEASE</td><td>4.3.10.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.4.RELEASE</td><td>4.3.9.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.3.RELEASE</td><td>4.3.8.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9+</td><td>8</td><td>9.2</td></tr><tr><td>1.5.22.RELEASE</td><td>4.3.25.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.21.RELEASE</td><td>4.3.24.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.20.RELEASE</td><td>4.3.23.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.2.RELEASE</td><td>4.3.7.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.19.RELEASE</td><td>4.3.22.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.18.RELEASE</td><td>4.3.21.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.17.RELEASE</td><td>4.3.20.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.16.RELEASE</td><td>4.3.19.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.15.RELEASE</td><td>4.3.18.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.14.RELEASE</td><td>4.3.18.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.13.RELEASE</td><td>4.3.17.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.12.RELEASE</td><td>4.3.16.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.11.RELEASE</td><td>4.3.15.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.10.RELEASE</td><td>4.3.14.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.1.RELEASE</td><td>4.3.6.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.0.RELEASE</td><td>4.3.6.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td>1.5.0.RC1</td><td>4.3.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>2.9, 3.x</td><td>8</td><td>9.2</td></tr><tr><td><strong>Spring Boot 1.4.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>1.4.7.RELEASE</td><td>4.3.9.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.6.RELEASE</td><td>4.3.8.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.5.RELEASE</td><td>4.3.7.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.4.RELEASE</td><td>4.3.6.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.3.RELEASE</td><td>4.3.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.2.RELEASE</td><td>4.3.4.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.1.RELEASE</td><td>4.3.3.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12, 2.x</td><td>8</td><td>9.2</td></tr><tr><td>1.4.0.RELEASE</td><td>4.3.2.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12+</td><td>8</td><td>9.2</td></tr><tr><td>1.4.0.RC1</td><td>4.3.1.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12+</td><td>8</td><td>9.2</td></tr><tr><td>1.4.0.M3</td><td>4.3.0.RC2</td><td>Java 7~8</td><td>3.2+</td><td>1.12+</td><td>8</td><td>9</td></tr><tr><td>1.4.0.M2</td><td>4.3.0.RC1</td><td>Java 7~8</td><td>3.2+</td><td>1.12+</td><td>8</td><td>9</td></tr><tr><td>1.4.0.M1</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12+</td><td>8</td><td>9</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>下面是Spring Boot1.3</p><table><thead><tr><th><strong>Sping Boot</strong></th><th><strong>Spring Framework</strong></th><th><strong>Java</strong></th><th><strong>Maven</strong></th><th><strong>Gradle</strong></th><th><strong>Tomcat</strong></th><th><strong>Jetty</strong></th></tr></thead><tbody><tr><td><strong>Spring Boot 1.3.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>1.3.8.RELEASE</td><td>4.2.8.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.7.RELEASE</td><td>4.2.7.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.6.RELEASE</td><td>4.2.7.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.5.RELEASE</td><td>4.2.6.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.4.RELEASE</td><td>4.2.6.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.3.RELEASE</td><td>4.1.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.2.RELEASE</td><td>4.1.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.1.RELEASE</td><td>4.1.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.RELEASE</td><td>4.1.5.RELEASE</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.RC1</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.M5</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.M4</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.M3</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.M2</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.3.0.M1</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td><strong>Spring Boot 1.2.x</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>1.2.8.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.7.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.6.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.5.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.4.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.3.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.2.RELEASE</td><td>4.1.3+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.1.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.0.RELEASE</td><td>4.1.5+</td><td>Java 7~8</td><td>3.2+</td><td>1.12 , 2.x</td><td>8</td><td>9</td></tr><tr><td>1.2.0.RC2</td><td>1.2.0.RC2</td><td>Java 6+</td><td>3.0</td><td>1.6+</td><td>8</td><td>9</td></tr><tr><td>1.2.0.RC1</td><td>1.2.0.RC1</td><td>Java 6+</td><td>3.0</td><td>1.6+</td><td>8</td><td>9</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux的五种IO模型</title>
      <link href="/2019/08/17/linux-de-wu-chong-io-mo-xing/"/>
      <url>/2019/08/17/linux-de-wu-chong-io-mo-xing/</url>
      
        <content type="html"><![CDATA[<p>IO模型相信做开发的都不陌生，我在深入去了解Java NIO的时候就被IO模型的各种概念搞的痛不欲生。阻塞和非阻塞，同步和异步，没有真正理解它们的之前，难以搞清楚它们之间的本质区别。由于工作中常常接触到，最后痛定思痛。花了些时间去研究它。看了很多相关的资料，博客。很多文章都用生活中的例子来类比阻塞非阻塞，同步和异步。其中同步和异步是比较好理解的，生活中的例子也很贴切。但是阻塞和非阻塞在生活中就很难找到这种比较贴切的例子，稍不注意就会和同步异步混为一谈了。本文就谈一谈IO模型，一为记录知识，二为加深理解。</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io.jpg" alt></p><a id="more"></a> <h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>在理解IO模型概念之前，首先要明白这几个概念：</p><h4 id="线程的阻塞"><a href="#线程的阻塞" class="headerlink" title="线程的阻塞"></a>线程的阻塞</h4><p>线程阻塞通常是指一个线程在执行过程中暂停，以等待某个条件的触发。线程进入阻塞状态的原因包括：</p><ul><li>等待阻塞：当线程执行了某个对象的wait()方法时，线程会被置入该对象的等待集中，直到执行了该对象的notify()方法wait()/notify()方法的执行要求线程首先获得该对象的锁。</li><li>同步阻塞：当多个线程试图进入某个同步区域（同步锁）时，没能进入该同步区域（同步锁）的线程会被置入锁定集（锁池）中，直到获得该同步区域的锁，进入就绪状态。</li><li>其他阻塞：运行的线程执行sleep()或join()方法，或者发出了I/O请求时，JVM会把该线程置为阻塞状态。当sleep()状态超时、join()等待线程终止或者超时、或者I/O处理完毕时，线程重新转入就绪状态。</li></ul><p>线程处于阻塞状态时，线程会被系统调度而暂时挂起，等待条件触发唤醒。也就是说线程因阻塞而被调度时是不占用CPU资源的，同时也会导致线程的上下文切换。</p><h4 id="线程的上下文切换"><a href="#线程的上下文切换" class="headerlink" title="线程的上下文切换"></a>线程的上下文切换</h4><p>这个词常出现在和并发有关的场合，不过当线程阻塞而被系统调度时也会出现上下文切换。那么所谓的上下文切换，到底是个什么操作，它在切换什么呢？对于单核CPU来说，CPU在一个时刻只能运行一个线程，为了控制线程的执行，内核必须有能力挂起正在CPU上运行的进程，并恢复以前挂起的某个线程的执行。这种行为被称为线程切换（线程是CPU能控制的最小执行单元）。因此为了能恢复一个线程之前运行的状态，在线程调度之前必须把线程的状态冻结，实际上就是把当前线程在CPU高速缓存，寄存器中的数据保存起来。任何线程都是在操作系统内核的支持下运行的，是与内核紧密相关的。从一个线程的运行转到另一个线程上运行，这个过程中经过下面这些变化：</p><ul><li>保存处理机上下文，包括程序计数器和其他寄存器。</li><li>更新PCB信息（PCB又名进程控制块，PCB中记录了操作系统所需要的、用于描述进程情况及控制进程运行所需要的全部信息）。</li><li>把进程的PCB移入相应的队列，如就绪、在某事件阻塞等队列。</li><li>选择另一个进程执行，并更新其PCB。</li><li>更新内存管理的数据结构。</li><li>恢复处理机上下文。</li></ul><p>总而言之线程上下文切换很耗资源。</p><h4 id="文件描述符-fd"><a href="#文件描述符-fd" class="headerlink" title="文件描述符 fd"></a>文件描述符 fd</h4><p>文件描述符（File descriptor）是计算机科学中的一个术语，是一个用于表述指向文件的引用的抽象化概念。操作系统内核（kernel）利用文件描述符（file descriptor）来访问文件。文件描述符是非负整数。打开现存文件或新建文件时，内核会返回一个文件描述符。读写文件也需要使用文件描述符来指定待读写的文件。它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于UNIX、Linux这样的操作系统。</p><h4 id="用户态与内核态"><a href="#用户态与内核态" class="headerlink" title="用户态与内核态"></a>用户态与内核态</h4><p>这两个词在线程切换时也是经常碰到，对于以前的 DOS 操作系统来说，是没有内核空间、用户空间以及内核态、用户态这些概念的。可以认为所有的代码都是运行在内核态的。但在 CPU 的所有指令中，有些指令是非常危险的，如果错用，将导致系统崩溃，比如清内存、设置时钟等。如果允许所有的程序都可以使用这些指令，那么系统崩溃的概率将大大增加。所以，CPU 将指令分为特权指令和非特权指令，对于那些危险的指令，只允许操作系统及其相关模块使用，普通应用程序只能使用那些不会造成灾难的指令。对于 Linux 来说，通过区分内核空间和用户空间的设计，隔离了操作系统代码(操作系统的代码要比应用程序的代码健壮很多)与应用程序代码。即便是单个应用程序出现错误也不会影响到操作系统的稳定性，这样其它的程序还可以正常的运行。好了我们现在需要再解释一下什么是内核态、用户态：</p><ul><li><strong>内核态：</strong>进程运行在内核地址空间中，此时 CPU 可以执行任何指令。运行的代码也不受任何的限制，可以自由地访问任何有效地址，也可以直接进行端口的访问。</li><li><strong>用户态：</strong>进程运行在用户地址空间中，被执行的代码要受到 CPU 的诸多检查，它们只能访问映射其地址空间的页表项中规定的在用户态下可访问页面的虚拟地址，且只能对任务状态段(TSS)中 I/O 许可位图(I/O Permission Bitmap)中规定的可访问端口进行直接访问。</li></ul><p>简单来说就是操作系统把内存寻址空间分为了两个空间，内核空间和用户空间，当代码运行在内核空间时那么线程就在内核态，当代码运行在用户空间时那么线程就在用户态。其实所有的系统资源管理都是在内核空间中完成的。比如读写磁盘文件，分配回收内存，从网络接口读写数据等等。我们的应用程序是无法直接进行这样的操作的。但是我们可以通过内核提供的接口来完成这样的任务。比如应用程序要读取磁盘上的一个文件，它可以向内核发起一个 “系统调用” 告诉内核：”我要读取磁盘上的某某文件”。其实就是通过调用系统接口让进程从用户态进入到内核态(到了内核空间)，在内核空间中，CPU 可以执行任何的指令，当然也包括从磁盘上读取数据。具体过程是先把数据读取到内核空间中，然后再把数据拷贝到用户空间并从内核态切换到用户态。此时应用程序已经从系统调用中返回并且拿到了想要的数据，可以开开心心的往下执行了。简单说就是应用程序想要读取磁盘，但应用程序没这个权利，那咋办呢？委托给内核，内核把磁盘的数据读取后再把数据返回给应用程序，就这么件简单的事情。</p><h2 id="IO分类"><a href="#IO分类" class="headerlink" title="IO分类"></a>IO分类</h2><p>IO分为两种类型分别为磁盘IO和网络IO，而IO读取数据的方式又分为两个维度，就是文章开头说的。“阻塞（Blocking）”、“非阻塞（Non-blocking）”、“同步”、“异步”。总结起来是四种模型 同步阻塞、同步非阻塞；异步阻塞、异步非阻塞 。每个 IO 模型都有自己的使用模式，它们对于特定的应用程序都有自己的优点。不管是哪种IO模型，从根本上IO操作都分为两个阶段。</p><table><thead><tr><th></th><th>磁盘IO</th><th>网络IO</th></tr></thead><tbody><tr><td><strong>阶段一</strong></td><td>将数据从磁盘读取到内核空间</td><td>等待网络上的数据流到达，然后被复制到内核的某个缓冲区</td></tr><tr><td><strong>阶段二</strong></td><td>将数据从内核空间拷贝到用户空间</td><td>将数据从内核缓冲区复制到应用进程缓冲区</td></tr></tbody></table><p>其中阶段一可概括为数据的准备阶段，阶段二可概括为数据的拷贝阶段，前文所说的阻塞和非阻塞是针对阶段一而言的，而同步和异步是针对阶段二而言的，因此理解了这两个阶段，基本上也就理解了IO模型。</p><h2 id="Linux-下五种I-O模型"><a href="#Linux-下五种I-O模型" class="headerlink" title="Linux 下五种I/O模型"></a>Linux 下五种I/O模型</h2><p>这里先把概念都抛出来吧，后面我会通过生活中的一个例子来结合概念去理解它。Linux下实现了五种IO模型，下面就分别来介绍一下这5种IO模型的异同。它们分别如下：</p><ol><li>阻塞式I/O：所有套接字默认</li><li>非阻塞I/O</li><li>I/O复用(select，poll，epoll)</li><li>信号驱动式（SIGIO）：内核在描述符就绪时发送SIGIO通知进程</li><li>异步I/O（POSIX的aio_系列函数）：不会阻塞。内核完成后整个操作，通知进程。</li></ol><h4 id="阻塞IO模型"><a href="#阻塞IO模型" class="headerlink" title="阻塞IO模型"></a>阻塞IO模型</h4><p>最传统的一种IO模型，也是实现思路最简单的IO模型，即在读写数据过程中会发生阻塞现象。当用户线程发出IO请求之后，内核会去查看数据是否就绪，如果没有就绪就会等待数据就绪，而用户线程就会处于阻塞状态，用户线程交出CPU。当数据就绪之后，内核会将数据拷贝到用户线程，并返回结果给用户线程，用户线程才解除block状态。它的流程图如下</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io2.png" alt></p><h4 id="非阻塞IO模型"><a href="#非阻塞IO模型" class="headerlink" title="非阻塞IO模型"></a>非阻塞IO模型</h4><p>当用户线程发起一个read操作后，并不需要等待，而是马上就得到了一个结果（ps：是不是和同步异步的概念很像，对于异步而言也是在发起请求后马上返回，通过回调告诉调用者最终结果）。如果结果是一个error时，它就知道数据还没有准备好，于是它可以再次发送read操作。一旦内核中的数据准备好了，并且又再次收到了用户线程的请求，那么它马上就将数据拷贝到了用户线程，然后返回。因此，在非阻塞IO模型中，用户线程需要不断地询问内核数据是否就绪，非阻塞IO不会交出CPU，而会一直占用CPU的资源，相比阻塞IO模型，因为用户线程不会进入系统调度，所以在轮询期间用户线程还可以干点别的事情，在一定程度上提高了资源的利用率。但这也是会导致一个非常严重的问题，因为需要不断地去询问内核数据是否就绪，这样会导致CPU占用率非常高。它的流程图如下</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io3.png" alt></p><h4 id="多路复用IO模型"><a href="#多路复用IO模型" class="headerlink" title="多路复用IO模型"></a>多路复用IO模型</h4><p>多路复用IO模型是目前使用得比较多的模型。Java NIO实际上就是多路复用IO。从非阻塞IO的实现原理可以看出，由于非阻塞需要一直轮询内核数据是否就绪，轮询占据了很大一部分过程，轮询会消耗大量的CPU时间。结合前面两种模式。如果轮询不是进程的用户态，而是有人帮忙就好了。多路复用正好处理这样的问题。多路复用的特点是通过一种机制一个进程能同时等待IO文件描述符，内核监视这些文件描述符（套接字描述符），这就是select函数，多个进程的IO可以注册到同一个select上，当用户进程调用该select，select会监听所有注册好的IO，如果所有被监听的IO需要的数据都没有准备好时，select调用进程会阻塞。当任意一个IO所需的数据准备好之后，select调用就会返回，然后进程在通过recvfrom来进行数据拷贝。对于监视的方式，可分为 select， poll， epoll三种方式。这几个函数都是内核级别的，select轮询相对非阻塞的轮询的区别在于—前者可以等待多个socket，当其中任何一个socket的数据准好了，就能返回进行可读，然后进程再进行recvform系统调用获取准备好的数据，将数据由内核拷贝到用户进程，当然这个过程是阻塞的。它的流程图如下</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io4.png" alt></p><h4 id="信号驱动IO模型"><a href="#信号驱动IO模型" class="headerlink" title="信号驱动IO模型"></a>信号驱动IO模型</h4><p>当用户线程发起一个IO请求操作，会给对应的socket注册一个信号函数，然后立马返回，用户线程会继续执行，等数据准备好后，内核为该进程产生一个SIGIO信号。就用recvfrom函数来拷贝数据到用户空间（这个过程是阻塞的）。这个一般用于UDP中，对TCP套接口几乎是没用的。原因是在TCPsocket中很多事件均会产生SIGIO信号，因为在同一个时候产生这种信号的原因太多我们不能区分到底是哪一种情况产生的SIGIO信号，所以在TCP中信号驱动是不太适合使用的，相反在UDP中却比较适合使用。信号驱动IO模型如下图</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io5.png" alt></p><h4 id="异步IO模型"><a href="#异步IO模型" class="headerlink" title="异步IO模型"></a>异步IO模型</h4><p>异步操作的原理简单来说，就是我们给内核定下某个操作，让内核在完成整个操作的时候通知我们。前面说的四种IO模型都是同步IO模型，因为当数据准备好了之后，对于IO的第二阶段，都需要用户线程主动去从内核空间把数据拷贝到用户空间，但实际上这个步骤对于所有的IO操作都不可避免，那为什么不能让内核把数据拷贝到用户空间，万事俱备了之后再通知用户线程呢。异步IO就解决了这个问题，因此异步IO模型是最理想的IO模型，在异步IO模型中，当用户线程发起read操作之后，立刻就可以开始去做其它的事。而另一方面，从内核的角度，当它受到一个asynchronous read之后，它会立刻返回，说明read请求已经成功发起了，因此不会对用户线程产生任何block。然后，内核会等待数据准备完成，然后将数据拷贝到用户线程，当这一切都完成之后，内核会给用户线程发送一个信号，告诉它read操作完成了。也就说用户线程完全不需要关心实际的整个IO操作是如何进行的，只需要先发起一个请求，当接收内核返回的成功信号时表示IO操作已经完成，可以直接去使用数据了。也就说在异步IO模型中，IO操作的两个阶段都不会阻塞用户线程，这两个阶段都是由内核自动完成。异步IO是需要操作系统的底层支持，在Java 7中，提供了Asynchronous IO，简称AIO。而我们之前一直用的Java NIO是同步非阻塞IO。这里对Java中出现的，BIO，NIO，AIO做个总结</p><table><thead><tr><th>类别</th><th>IO模型实现</th></tr></thead><tbody><tr><td>BIO（Block IO）</td><td>阻塞同步IO模型</td></tr><tr><td>NIO（New IO）</td><td>非阻塞同步IO模型</td></tr><tr><td>AIO（Asynchronous IO）</td><td>非阻塞异步IO模型</td></tr></tbody></table><p>对于异步IO模型，其原理图如下</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io6.png" alt></p><h2 id="结合生活例子理解IO模型"><a href="#结合生活例子理解IO模型" class="headerlink" title="结合生活例子理解IO模型"></a>结合生活例子理解IO模型</h2><p>通过生活中的例子可以更好的帮助我们理解IO模型。我以去书店买书为例，在买书的例子中有三个必不可少的对象，它们分别是小明，书店以及出版社。小明去书店买书，书店去出版社采购书籍。还有一个限制条件，小明不能直接去出版社买书。这里实际上就是模拟了IO的工作方式，小明代表的是应用程序，书店代表的是操作系统内核，出版社代表的是磁盘。因此买书的过程就大致是一个IO过程（为什么小明不能直接去出版社买书呢，因为应用程序也不能直接读磁盘）。好了下面开始五种IO模型的场景模拟吧。</p><ul><li><strong>阻塞IO：</strong> 小明准备去书店买本小说《三国演义》，于是打电话跟书店说：“服务员，我要买本三国演义”<strong>（发起IO请求）</strong>。可遗憾的是书店并没有存货，于是书店只能先去出版社把书采购回来<strong>（读取磁盘）</strong>。小明在这个过程中呢？小明只能干等着书店把书采购好<strong>（阻塞）</strong>，在书店没有反馈之前他不能做任何事情。然后等待书店的通知，过了一段时间书店总算把三国演义采购回来了，但这时候书还只是在书店，因此小明还需要自己去书店把书拿回家<strong>（同步）</strong>，然后小明就可以开心的看小说了。这里有两个需要注意的地方，1.小明在等书店反馈期间不能做任何事情，只能等；2.小明要买书，书店就会有一个服务员给小明提供服务。小红也要买书，书店就会有新的服务员给小红提供服务，也就是说只要有人请求要买书，书店都会给这个人提供一个单独的服务员，简单来说就是一对一的VIP服务。这样的工作方式在放生活中简直难以理解，可是早期的操作系统就是设计的这么直白。</li><li><strong>非阻塞IO：</strong> 小明准备去书店买本小说《山海经》，于是打电话跟书店说：“服务员，我要买本山海经”<strong>（发起IO请求）</strong>。可遗憾的是书店并没有存货，于是书店只能先去出版社把书采购回来<strong>（读取磁盘）</strong>。有了之前的买书经验，这次小明变聪明了。他也不干等了，而是挂断了电话准备去做点别的事情。不过小明也不知道什么时候书店会把书采购回来，于是只能隔一段时间就打电话问书店，书采购好了没有<strong>（非阻塞轮询）</strong>。过了一段时间书店总算把山海经采购回来了，但这时候书还只是在书店，小明仍然需要自己去书店把书拿回家<strong>（同步）</strong>，然后小明就可以开心的看小说了。相比于阻塞IO，好处就是小明不用一直干等了，但是小明必须时不时打电话给书店询问情况。这对于书店来说这并不是一个好方式，因为小明总是打电话给书店，导致书店的电话大部分时间占线而给其他客人造成了较差的用户体验<strong>（占用较高的CPU资源）</strong></li><li><strong>信号驱动IO：</strong> 小明准备去书店买本小说《东周列国志》，于是打电话给书店。：“服务员，我要买本东周列国志”<strong>（发起IO请求）</strong>。可遗憾的是书店并没有存货，于是书店只能先去出版社把书采购回来<strong>（读取磁盘）</strong>。小明有了前两次的买书经验，觉得自己轮询，总得时不时的打个电话，问下书到了没有，也太麻烦了。于是他干脆给书店留了自己的电话号码说：“这是我的号码，如果书到了，打电话告诉我，我来取书”<strong>（信号驱动）</strong>。这种方式完全的做到了非阻塞，但小明需要自己去书店取书，所以仍然是同步的方式。</li><li><strong>多路复用IO：</strong> 小明准备去书店买本小说《山海经》，于是打电话跟书店说：“服务员，我要买本山海经”<strong>（发起IO请求）</strong>，小明的朋友小红也打电话给书店说：服务员，我要买本《三国演义》<strong>（多个IO请求）</strong>。可遗憾的是书店并没有存货，于是书店只能先去出版社把书采购回来。书店这边呢，随着书店生意越来越好，以前的一对一VIP服务方式难以支撑多个IO请求了，100个人来买书难道还真招100个服务员来一对一服务吗？于是书店老板改变了做法，服务员接到买书请求后就挂断了电话<strong>（非阻塞）</strong>，然后把这个买书请求放到一个清单中，然后服务员只需轮询这份清单，看书采购回来了没有。如果采购回来了就打电话通知买书的人，让他过来取书<strong>（同步）</strong>。这样只需要一个服务员就能处理100个人的买书请求，简直完美。对于这种方式，服务员查询清单这个过程仍然是阻塞的（当知道出版社有书时，服务员必须等待书采购并货运至书店，类比于磁盘数据读取到内核空间这个过程中，内核线程阻塞），所以<strong>IO多路复用是阻塞在select，epoll这样的系统调用之上，而没有阻塞在真正的I/O系统调用如recvfrom之上</strong>，但对于用户来说这种方式是非阻塞同步的。</li><li><strong>异步IO：</strong> 小明准备去书店买本小说《镜花缘》。于是到书店的官网上提交了镜花缘书籍的请求（ps：书店也升级了），然后小明填写了自己的住址就下单了，然后就做自己的事情去了<strong>（非阻塞）</strong>。书店看了下书单请求，发现没有这本书，没关系先去出版社采购回来吧<strong>（读取磁盘）</strong>，书采购回书店后，书店的老板根据小明留下的住址，将书通过邮寄的方式寄到了小明家里<strong>（把数据从内核态拷贝到用户态）</strong>，小明等到送货上门的书后就可以愉快的看小说啦。这种方式就比较符合我们的生活习惯了，是完完全全的异步非阻塞。因为整个过程中小明从提交买书的请求，到把书拿到手，什么都不用做，只管躺着玩就行了（果然世界还是属于懒人的）。</li></ul><p>本文所讨论的IO模型来自大名鼎鼎的《unix网络编程：卷1套接字联网API》。文中的IO模型的图片也取自该书。对于<strong>阻塞非阻塞，同步异步</strong>的理解这里再总结一下。同步异步好理解，它是针对请求而言的，客户端请求服务端如果立即返回，结果通过回调的方法返回，那么这种方式就是异步的；如果客户端请求服务端，没有立即返回而是等待服务端的结果再返回，那么这种方式就是同步的。阻塞非阻塞是针对客户端和服务端中间多一个第三方而言的，例如应用程序要访问磁盘，应用程序没权限，只能委托给内核（第三方）。在委托之后，客户端要不要等待结果返回，如果要等待就是阻塞的，不等待就是非阻塞的。<strong>（因为阻塞就意味着会有系统调度）</strong>。下图是五种IO模型的比较图。</p><p><img src="/2019/08/17/linux-de-wu-chong-io-mo-xing/io7.jpg" alt></p><h2 id="关于epoll，poll，select"><a href="#关于epoll，poll，select" class="headerlink" title="关于epoll，poll，select"></a>关于epoll，poll，select</h2><p>多路复用是一种机制，可以用来监听多种描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。但select，poll，epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是同步的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间。这三个方法是内核中的方法，通过C语言实现。下面分别介绍一下这个三个方法的原理</p><h5 id="select"><a href="#select" class="headerlink" title="select"></a>select</h5><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">select</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> timeval <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>select 函数监视的文件描述符分3类，分别是writefds、readfds、和exceptfds。这3类文件描述符是在用户空间创建然后拷贝到内核中。它们分别监听读、写、异常动作。这里受到单个进程可以打开的fd数量限制，默认是1024。调用后select函数会阻塞，采用轮询方式,遍历所有fd，直到有描述副就绪（有数据 可读、可写、或者有except），或者超时（timeout指定等待时间，如果立即返回设为null即可），最后返回一个描述符读写操作是否就绪的mask掩码，根据这个掩码给fd_set赋值。 将之前传入的fd_set拷贝传出到用户态并返回就绪的文件描述符总数。用户态并不知道是哪些文件描述符处于就绪态,需要遍历来判断。select目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点。</p><h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">poll</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> pollfd <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>不同与select使用三个位图来表示三个fdset的方式，poll使用一个 pollfd的指针实现。在用户态中通过将传入的struct pollfd结构体数组拷贝到内核中进行监听。 pollfd结构体如下</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> pollfd <span class="token punctuation">{</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* file descriptor */</span>    <span class="token keyword">short</span> events<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* requested events to watch */</span>    <span class="token keyword">short</span> revents<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* returned events witnessed */</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>pollfd结构包含了要监视的event和发生的event，不再使用select“参数-值”传递的方式。同时，pollfd并没有最大数量限制（但是数量过大后性能也是会下降）。 和select函数一样，poll返回后，会将之前传入的fd数组拷贝传出用户态并返回就绪的文件描述符总数。同样用户态并不知道是哪些文件描述符处于就绪态，需要遍历来判断。</p><h5 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h5><p>epoll是在2.6内核中提出的，是之前的select和poll的增强版本。相对于select和poll来说，epoll更加灵活，没有描述符限制。epoll使用一个文件描述符管理多个描述符，将用户关系的文件描述符的事件存放到内核的一个事件表中，这样在用户空间和内核空间的copy只需一次。epoll操作过程需要三个接口，分别如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span>；<span class="token comment" spellcheck="true">//创建一个epoll的句柄，size用来告诉内核这个监听的数目一共有多大</span><span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span>event<span class="token punctuation">)</span>；<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> epoll_event <span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>执行epoll_create会在内核的高速cache区中建立一颗红黑树以及就绪链表(该链表存储已经就绪的文件描述符)。接着用户执行的epoll_ctl函数添加文件描述符会在红黑树上增加相应的结点。epoll_create方法的参数size用来告诉内核这个监听的数目一共有多大，这个参数不同于select()中的第一个参数，给出最大监听的fd+1的值，参数size并不是限制了epoll所能监听的描述符最大个数，只是对内核初始分配内部数据结构的一个建议。当创建好epoll句柄后，它就会占用一个fd值，在linux下如果查看/proc/进程id/fd/，是能够看到这个fd的，所以在使用完epoll后，必须调用close()关闭，否则可能导致fd被耗尽。采用回调机制。在执行epoll_ctl的add操作时,不仅将文件描述符放到红黑树上,而且也注册了回调函数,内核在检测到某文件描述符可读/可写时会调用回调函数,该回调函数将文件描述符放在就绪链表中。上面三个方法中有两个都有epoll_event参数，它是一个结构体，封装了监听的事件，struct epoll_event结构如下</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> epoll_event <span class="token punctuation">{</span>  __uint32_t events<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Epoll events */</span>  epoll_data_t data<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* User data variable */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//events可以是以下几个宏的集合：</span>EPOLLIN ：表示对应的文件描述符可以读（包括对端SOCKET正常关闭）；EPOLLOUT：表示对应的文件描述符可以写；EPOLLPRI：表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）；EPOLLERR：表示对应的文件描述符发生错误；EPOLLHUP：表示对应的文件描述符被挂断；EPOLLET： 将EPOLL设为边缘触发<span class="token punctuation">(</span>Edge Triggered<span class="token punctuation">)</span>模式，这是相对于水平触发<span class="token punctuation">(</span>Level Triggered<span class="token punctuation">)</span>来说的。EPOLLONESHOT：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里</code></pre><p><strong>epoll_ctl方法：</strong> 函数是对指定描述符fd执行op操作。</p><table><thead><tr><th>方法名</th><th>解释</th></tr></thead><tbody><tr><td>epfd</td><td>是epoll_create()方法的返回值。</td></tr><tr><td>op</td><td>表示op操作，用三个宏来表示：添加EPOLL_CTL_ADD，删除EPOLL_CTL_DEL，修改EPOLL_CTL_MOD。分别添加、删除和修改对fd的监听事件</td></tr><tr><td>event</td><td>是告诉内核需要监听什么事</td></tr></tbody></table><p> <strong>int epoll_wait方法：</strong>等待epfd上的io事件，最多返回maxevents个事件。</p><table><thead><tr><th>方法名</th><th>解释</th></tr></thead><tbody><tr><td>events</td><td>表示从内核得到事件的集合</td></tr><tr><td>timeout</td><td>超时时间（毫秒，0会立即返回，-1将不确定，也有说法说是永久阻塞）</td></tr></tbody></table><p><strong>epoll的两种工作模式</strong></p><p>epoll对文件描述符的操作有两种模式：<strong>LT（level trigger）</strong>和<strong>ET（edge trigger）</strong>。LT模式是默认模式，LT模式与ET模式的区别如下：</p><table><thead><tr><th>模式</th><th>解释</th></tr></thead><tbody><tr><td>LT模式</td><td>当epoll_wait检测到描述符事件发生并将此事件通知应用程序，<code>应用程序可以不立即处理该事件</code>。下次调用epoll_wait时，会再次响应应用程序并通知此事件。</td></tr><tr><td>ET模式</td><td>当epoll_wait检测到描述符事件发生并将此事件通知应用程序，<code>应用程序必须立即处理该事件</code>。如果不处理，下次调用epoll_wait时，不会再次响应应用程序并通知此事件。</td></tr></tbody></table><p>在 select/poll中，进程只有在调用方法后，内核才对所有监视的文件描述符进行扫描，而<strong>epoll事先通过epoll_ctl()来注册一 个文件描述符，一旦基于某个文件描述符就绪时，内核会采用类似callback的回调机制，迅速激活这个文件描述符，当进程调用epoll_wait() 时便得到通知</strong>。(<code>此处去掉了遍历文件描述符，而是通过监听回调的的机制</code>。这正是epoll的魅力所在。)</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>下面总结一下各个方法处理I/O的细节，下面1到4就是IO处理过程：</p><ol><li><p><strong>用户态将文件描述符传入内核的方式</strong><br><strong>select</strong>：创建3个文件描述符集并拷贝到内核中,分别监听读、写、异常动作。这里受到单个进程可以打开的fd数量限制,默认是1024。<br><strong>poll</strong>：将传入的struct pollfd结构体数组拷贝到内核中进行监听。<br><strong>epoll</strong>：执行epoll_create会在内核的高速cache区中建立一颗红黑树以及就绪链表(该链表存储已经就绪的文件描述符)。接着用户执行的epoll_ctl函数添加文件描述符会在红黑树上增加相应的结点。</p></li><li><p><strong>内核态检测文件描述符是否可读可写的方式</strong><br><strong>select</strong>：采用轮询方式,遍历所有fd,最后返回一个描述符读写操作是否就绪的mask掩码,根据这个掩码给fd_set赋值。<br><strong>poll</strong>：同样采用轮询方式,查询每个fd的状态,如果就绪则在等待队列中加入一项并继续遍历。<br><strong>epoll</strong>：采用回调机制。在执行epoll_ctl的add操作时,不仅将文件描述符放到红黑树上,而且也注册了回调函数,内核在检测到某文件描述符可读/可写时会调用回调函数,该回调函数将文件描述符放在就绪链表中。</p></li><li><p><strong>如何找到就绪的文件描述符并传递给用户态</strong><br><strong>select</strong>：将之前传入的fd_set拷贝传出到用户态并返回就绪的文件描述符总数。用户态并不知道是哪些文件描述符处于就绪态,需要遍历来判断。<br><strong>poll</strong>：将之前传入的fd数组拷贝传出用户态并返回就绪的文件描述符总数。用户态并不知道是哪些文件描述符处于就绪态,需要遍历来判断。<br><strong>epoll</strong>：epoll_wait只用观察就绪链表中有无数据即可,最后将链表的数据返回给数组并返回就绪的数量。内核将就绪的文件描述符放在传入的数组中,所以只用遍历依次处理即可。这里返回的文件描述符是通过mmap让内核和用户空间共享同一块内存实现传递的,减少了不必要的拷贝。</p></li><li><p><strong>继续重新监听时如何重复以上步骤</strong><br><strong>select</strong>：将新的监听文件描述符集合拷贝传入内核中,继续以上步骤。<br><strong>poll</strong>：将新的struct pollfd结构体数组拷贝传入内核中,继续以上步骤。<br><strong>epoll</strong>：无需重新构建红黑树,直接沿用已存在的即可。</p></li><li><p><strong>三种方式的效率</strong><br><strong>select</strong>：函数select每次调用都会线性扫描全部的FD集合，这样效率就会呈现线性下降，把FD_SETSIZE改大的后果就是，会因为前面的过慢导致后面的超时<br><strong>poll</strong>：效率问题和select一样，区别就是将FD集合改成了线性链表。FD的上限不受限制<br><strong>epoll</strong>：Epoll最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关，因此在实际的网络环境中，Epoll的效率就会远远高于select和poll。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> io </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>彻底搞懂RPC</title>
      <link href="/2019/08/11/che-di-gao-dong-rpc/"/>
      <url>/2019/08/11/che-di-gao-dong-rpc/</url>
      
        <content type="html"><![CDATA[<p>在公司做新一个项目的开发时，又接触到了RPC。虽然我以前做过WebService的相关开发，不过那时只是照葫芦画瓢的实现功能开发，没有深入研究它的实现原理。RPC的概念由来已久，最早是由互联网大师 Jon Postel在1974年冬发表了RFC674：“<em>Procedure Call Protocol Documents，Version 2</em>”，尝试定义一种在包含70个节点的网络中共享资源的通用方法。在大师一生中编辑过的无数个RFC文档中，674属于并不突出的一个，但却拉开了RPC的序幕。在随后80年代Bruce Jay Nelson在他的论文<a href="http://birrell.org/andrew/papers/ImplementingRPC.pdf" target="_blank" rel="noopener">“Implementing Remote Procedure Calls”</a> 正式提出RPC 这个概念术语，并定义了RPC的调用标准。后面所有RPC框架，都是按照这个标准模式来的。RPC是Remote Procedure Call的缩写，即远程过程调用。</p><p><img src="/2019/08/11/che-di-gao-dong-rpc/rpc.jpeg" alt></p><a id="more"></a> <h2 id="什么是RPC"><a href="#什么是RPC" class="headerlink" title="什么是RPC"></a>什么是RPC</h2><p>首先要纠正一个观点，<strong>RPC是一种技术思想或者编程模型而不是一种技术的具体实现</strong>。也就是说RPC只是一种理论模型，它是一种进程间通信方式。允许像调用本地服务一样调用远程服务，它的具体实现方式可以不同，例如Spring的 HTTP Invoker，Facebook的 Thrift二进制私有协议通信。，在Nelson 的论文中提到了RPC应具备的特性</p><ol><li>简单：RPC 概念的语义十分清晰和简单，这样建立分布式计算就更容易。</li><li>高效：过程调用看起来十分简单而且高效。</li><li>通用：在单机计算中过程往往是不同算法和APl，跨进程调用最重要的是通用的通信机制。</li></ol><p>RPC框架的目标就是让远程过程(服务)调用更加简单、透明，RPC框架负责屏蔽底层的传输方式(TCP或者UDP)、序列化方式( XML/JSON/二进制)和通信细节。框架使用者只需要了解谁在什么位置提供了什么样的远程服务接口即可，开发者不需要关心底层通信细节和调用过程。</p><h2 id="为什么使用RPC"><a href="#为什么使用RPC" class="headerlink" title="为什么使用RPC"></a>为什么使用RPC</h2><p>其实这是应用开发到一定的阶段的强烈需求驱动的。</p><ol><li>如果我们开发简单的单一应用，逻辑简单、用户不多、流量不大，那我们用不着，这个时候的服务一般为单体服务；</li><li>当我们的系统访问量增大、业务增多时，我们会发现一台单机运行此系统已经无法承受。此时，我们可以将业务拆分成几个<strong>互不关联的应用</strong>，分别部署在各自机器上，以划清逻辑并减小压力。此时，我们也可以不需要RPC，因为应用之间是互不关联的</li><li>当我们的业务越来越多、应用也越来越多时，自然的，我们会发现有些功能已经<strong>不能简单划分开来或者划分不出来</strong>。此时，可以将公共业务逻辑抽离出来，将之组成独立的服务Service应用 。而原有的、新增的应用都可以与那些独立的Service应用 交互，以此来完成完整的业务功能。所以此时，我们急需<strong>一种高效的应用程序之间的通讯手段</strong>来完成这种需求，所以你看，RPC大显身手的时候来了！</li></ol><p>其实三描述的场景也是<strong>服务化 、微服务</strong> 和<strong>分布式系统架构</strong> 的基础场景。即RPC框架就是实现以上结构的有力方式。为什么有了HTTP，我们还需要RPC呢。如果产生这个疑问那只能说明对RPC的概念理解不透彻，因为HTTP只是一个通信协议，它跟RPC不是一个层级的概念，HTTP本身也可以作为RPC的传输层协议。但HTTP请求是非常浪费资源的。虽然其实本质上，HTTP也是走在TCP上面的，但是HTTP请求自己增加了很多自己的信息，因此会消耗带宽资源。因此很多RPC框架为了效率都是基于Socket通信。</p><h2 id="RPC-的结构"><a href="#RPC-的结构" class="headerlink" title="RPC 的结构"></a>RPC 的结构</h2><p>Nelson 的论文中指出实现 RPC 的程序包括 5 个部分：1. User；2.User-Stub；3.RPCRuntime；4.Server-stub；5.Server。他们调用原理图如下：</p><p><img src="/2019/08/11/che-di-gao-dong-rpc/rpc1.png" alt></p><p>以左边的Client端为例，User就是RPC的调用方，User-Stub就是User的代理实例，其实内部是通过RPC方式来进行远程调用的代理对象。至于RPCRuntime 则是实现远程调用的工具包，比如jdk的Socket，最后通过底层网络实现实现数据的传输。这个过程中最重要的就是<strong>序列化</strong>和<strong>反序列化</strong>了，因为数据传输的数据包必须是二进制的，Java对象是没法直接进行网络传输的，你必须把Java对象序列化为二进制格式，传给Server端，Server端接收到之后，再反序列化为Java对象。</p><h2 id="Java中常用的RPC框架"><a href="#Java中常用的RPC框架" class="headerlink" title="Java中常用的RPC框架"></a>Java中常用的RPC框架</h2><p><strong>Thrift</strong>：thrift是一个软件框架，用来进行可扩展且跨语言的服务的开发。它结合了功能强大的软件堆栈和代码生成引擎，以构建在 C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, and OCaml 这些编程语言间无缝结合的、高效的服务。</p><p><strong>Dubbo</strong>：Dubbo是一个分布式服务框架，以及SOA治理方案。其功能主要包括：高性能NIO通讯及多协议集成，服务动态寻址与路由，软负载均衡与容错，依赖分析与降级等。 Dubbo是阿里巴巴内部的SOA服务化治理方案的核心框架，Dubbo自2011年开源后，已被许多非阿里系公司使用。 是国内较早开源的服务治理的Java RPC框架，虽然在阿里巴巴内部竞争中落败于HSF，沉寂了几年，但是在国内得到了广泛的应用，目前dubbo项目又获得了支持，并且dubbo 3.0也开始开发</p><p><strong>Spring Cloud</strong>：Spring Cloud由众多子项目组成，如Spring Cloud Config、Spring Cloud Netflix、Spring Cloud Consul 等，提供了搭建分布式系统及微服务常用的工具，如配置管理、服务发现、断路器、智能路由、微代理、控制总线、一次性token、全局锁、选主、分布式会话和集群状态等，满足了构建微服务所需的所有解决方案。Spring Cloud基于Spring Boot, 使得开发部署极其简单。</p><h2 id="实现一个简单的RPC"><a href="#实现一个简单的RPC" class="headerlink" title="实现一个简单的RPC"></a>实现一个简单的RPC</h2><p>要实现一个RPC不算难，这里我自己动手写了一个非常简单RPC服务，思路也很简单服务端开启一个Scoket监听，然后读取从客户端传输过来的二进制数据，转换成Java对象。通过对象中的参数调用服务端对应Service对象的方法。仔细一想，你会发现这个过程和HTTP请求大体相似，只不过HTTP不需要自己手动序列化和传输参数了，它站在了更高的地方。下面开始贴代码吧，先是客户端的代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcClient</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ADDRESS<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PORT<span class="token operator">=</span><span class="token number">8090</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">runObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Socket socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>ADDRESS<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将请求参数序列化</span>            RequestDto requestDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestDto</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"getArea"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ObjectOutputStream objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将请求发给服务提供方</span>            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>requestDto<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将响应体反序列化</span>            ObjectInputStream objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object response <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>response <span class="token keyword">instanceof</span> <span class="token class-name">ResponseDto</span><span class="token punctuation">)</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------- RPC-Response ----------"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这里实现的功能就是计算一个长方形的面积，其中RequestDto是一个普通的JavaBean，里面有wide，high和method三个属性。wide，high代表的就是长方形的长和宽。而method就是我要调用的服务端的方法。为了简单易懂，客户端调用服务端时，这里写死的IP和端口。下面是服务端的代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcServer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        ServerSocket listener <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">8090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Socket socket <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将请求反序列化</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------收到请求------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ObjectInputStream objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object object <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">RequestDto</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                RequestDto requestDto <span class="token operator">=</span> <span class="token punctuation">(</span>RequestDto<span class="token punctuation">)</span>object<span class="token punctuation">;</span>                AreaCalculateService calculateService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AreaCalculateService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"getArea"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>requestDto<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    result <span class="token operator">=</span> calculateService<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span>requestDto<span class="token punctuation">.</span><span class="token function">getWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestDto<span class="token punctuation">.</span><span class="token function">getHigh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 返回结果</span>            ObjectOutputStream objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseDto</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>result<span class="token punctuation">,</span><span class="token string">"计算结果返回"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>服务端开启了一个端口为8090的Socket监听，收到客户端的数据后，将数据直接转成Object对象再强转为具体的业务Bean。其中AreaCalculateService是服务的Service层的类，用于计算长方形的面积。这里还有个要注意的地方，客户端和服务端序列化Bean时，要使用同一版本的类。否则会抛出如下异常：</p><pre class=" language-java"><code class="language-java">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InvalidClassException<span class="token operator">:</span> com<span class="token punctuation">.</span>lsj<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>ResponseDto<span class="token punctuation">;</span> local <span class="token keyword">class</span> <span class="token class-name">incompatible</span><span class="token operator">:</span> stream classdesc serialVersionUID <span class="token operator">=</span> <span class="token number">7775905651334527585</span><span class="token punctuation">,</span> local <span class="token keyword">class</span> <span class="token class-name">serialVersionUID</span> <span class="token operator">=</span> <span class="token number">1637265455040962658</span></code></pre><p>上面的例子中我使用的是请求类是自己定义的RequestDto，响应类是ResponseDto。那么在客户端和服务端，这两个类的定义中要保证 serialVersionUID 一致，即</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestDto</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这个值客户端和服务端要一致</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 7775905651334527585L<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> wide<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> high<span class="token punctuation">;</span>    <span class="token keyword">private</span> String method<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> wide<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWide</span><span class="token punctuation">(</span><span class="token keyword">int</span> wide<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>wide <span class="token operator">=</span> wide<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHigh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> high<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHigh</span><span class="token punctuation">(</span><span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>high <span class="token operator">=</span> high<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> method<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMethod</span><span class="token punctuation">(</span>String method<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>通过上面的代码我们就实现了一个简单的RPC，但是这个RPC非常简陋，只是为了理解RPC实际的调用过程。如果要用于商业环境那要优化事情还有很多很多很多。。。</p><h2 id="RPC没那么简单"><a href="#RPC没那么简单" class="headerlink" title="RPC没那么简单"></a>RPC没那么简单</h2><p><strong>要实现一个RPC不算难，难的是实现一个高性能高可靠的RPC框架。</strong>既然是分布式了，那么一个服务可能有多个实例，你在调用时，要如何获取这些实例的地址呢？这时候就需要一个服务注册中心，比如在Dubbo里头，就可以使用Zookeeper作为注册中心，在调用时，从Zookeeper获取服务的实例列表，再从中选择一个进行调用。而在Spring Cloud中则使用Eureka作为服务的注册中心。Zookeepe和Eureka两个注册中心，其实现原理是有侧重的，这又扯出了分布式理论中著名的CAP理论了。在从注册中心获取到服务列表后，那么选哪个调用好呢？这时候就需要负载均衡了，于是你又得考虑如何实现复杂均衡，比如Dubbo就提供了好几种负载均衡策略。这还没完，总不能每次调用时都去注册中心查询实例列表吧，这样效率多低呀，于是又有了缓存，有了缓存，就要考虑缓存的更新问题。还有呢，当需要修改一个服务的配置文件时，由于这个服务有多个实例，一个一个改完再重启也太麻烦了，于是又出现了配置中心。你以为就这样结束了吗，没呢，还有这些：</p><ul><li>客户端总不能每次调用完都干等着服务端返回数据吧，于是就要支持异步调用。</li><li>当服务端某个接口一直报错，不可用时总不能让客户端一直傻傻的请求吧，这样可能会把服务搞挂的，于是就有了熔断机制。</li><li>当RPC服务于服务之间调用关系越来越复杂时，怎么样快速定位到是哪个服务出现问题，导致某个请求出现异常的，于是就有了链路追踪。</li><li>blablabla……</li></ul><p>RPC 框架一般都有注册中心，有丰富的 监控管理；发布、下线接口、动态扩展等，对调用方来说是无感知、统一化的操作。<strong>因此成熟的 RPC 框架是一个强力的支撑</strong>。系统做大了，都是分开部署，单独上线的。RPC 的核心并不在于使用什么协议。RPC 的目的是让你在本地调用 远程的方法，而对你来说这个调用是透明的，你并不知道这个调用的方法是部署哪里。现在主流的<strong>Spring Cloud</strong>和<strong>Dubbo</strong>不只是一个RPC框架，同时还是一个强大的服务治理框架。下面是总结的RPC的优缺点</p><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>提升系统可扩展性</td><td>一个成熟的RPC框架开发难度大</td></tr><tr><td>提升系统可维护性和持续交付能力</td><td>RPC框架调用成功率受限于网络状况（远程通信都有这问题）</td></tr><tr><td>实现系统高可用</td><td>调用远程方法对初学者来说难度大</td></tr></tbody></table><h2 id="RPC框架的核心技术点"><a href="#RPC框架的核心技术点" class="headerlink" title="RPC框架的核心技术点"></a>RPC框架的核心技术点</h2><h4 id="1-服务暴露"><a href="#1-服务暴露" class="headerlink" title="1.服务暴露"></a>1.服务暴露</h4><p>远程提供者需要以某种形式提供<strong>服务调用相关的信息</strong>，包括但不限于<strong>服务接口定义</strong>、<strong>数据结构</strong>、或者中间态的<strong>服务定义文件</strong>。例如Facebook的Thrift的<strong>IDL文件</strong>，Web service的<strong>WSDL文件</strong>；服务的调用者需要通过一定的途径获取远程服务调用相关的信息。目前，大部分跨语言平台 RPC 框架采用根据 IDL 定义通过 code generator 去生成 stub 代码，这种方式下实际导入的过程就是<strong>通过代码生成器在编译期完成的</strong>。代码生成的方式对跨语言平台 RPC 框架而言是必然的选择，而对于同一语言平台的 RPC 则可以通过<strong>共享接口定义</strong>来实现。这里的导入方式本质也是一种代码生成技术，只不过是在<strong>运行时生成</strong>，比静态编译期的代码生成看起来更简洁些。</p><p>Java 中还有一种比较特殊的调用就是<strong>多态</strong>，也就是一个接口可能有多个实现，那么远程调用时到底调用哪个？这个本地调用的语义是通过 jvm 提供的引用多态性隐式实现的，那么对于 RPC 来说跨进程的调用就没法隐式实现了。如果前面DemoService 接口有 2 个实现，那么在导出接口时就需要<strong>特殊标记不同的实现需要</strong>，那么远程调用时也需要传递该标记才能调用到正确的实现类，这样就解决了<strong>多态调用</strong>的语义问题。</p><h4 id="2-远程代理对象"><a href="#2-远程代理对象" class="headerlink" title="2.远程代理对象"></a>2.远程代理对象</h4><p>服务调用者用的服务实际是远程服务的本地代理。说白了就是通过<strong>动态代理</strong>来实现。Java 里至少提供了两种技术来提供动态代码生成，一种是 jdk 动态代理，另外一种是字节码生成。动态代理相比字节码生成使用起来更方便，但动态代理方式在性能上是要逊色于直接的字节码生成的，而字节码生成在代码可读性上要差很多。两者权衡起来，个人认为牺牲一些性能来获得代码可读性和可维护性显得更重要。</p><h4 id="3-通信"><a href="#3-通信" class="headerlink" title="3.通信"></a>3.通信</h4><p>RPC框架与具体的协议无关。RPC 可基于 <strong>HTTP 或 TCP 协议</strong>，Web Service 就是基于 HTTP 协议的 RPC，它具有良好的跨平台性，但其性能却不如基于 TCP 协议的 RPC。</p><ol><li><strong>TCP/HTTP</strong>：众所周知，TCP 是传输层协议，HTTP 是应用层协议，而传输层较应用层更加底层，在数据传输方面，越底层越快，因此，在一般情况下，TCP 一定比 HTTP 快。</li><li><strong>消息ID</strong>：RPC 的应用场景实质是一种<strong>可靠的请求应答消息流</strong>，和 HTTP 类似。因此选择长连接方式的 TCP 协议会更高效，与 HTTP 不同的是在协议层面我们<strong>定义了每个消息的唯一 id</strong>，因此可以更容易的复用连接。</li><li><strong>IO方式</strong>：为了支持高并发，传统的阻塞式 IO 显然不太合适，因此我们需要<strong>异步的 IO</strong>，即 NIO。Java 提供了 NIO 的解决方案，Java 7 也提供了更优秀的 NIO.2 支持。</li><li><strong>多连接</strong>：既然使用长连接，那么第一个问题是到底 client 和 server 之间需要多少根连接？实际上单连接和多连接在使用上没有区别，对于<strong>数据传输量较小</strong>的应用类型，<strong>单连接</strong>基本足够。单连接和多连接最大的区别在于，每根连接都有自己私有的发送和接收缓冲区，因此<strong>大数据量传输时分散在不同的连接缓冲区会得到更好的吞吐效率</strong>。所以，如果你的数据传输量不足以让单连接的缓冲区一直处于饱和状态的话，那么使用多连接并不会产生任何明显的提升，反而会增加<strong>连接管理</strong>的开销。</li><li><strong>心跳</strong>：连接是由 client 端发起建立并维持。如果 client 和 server 之间是直连的，那么连接一般不会中断（当然物理链路故障除外）。如果 client 和 server 连接经过一些负载中转设备，有可能连接一段时间不活跃时会被这些中间设备中断。为了保持连接有必要定时为每个连接发送心跳数据以维持连接不中断。心跳消息是 RPC 框架库使用的内部消息，在前文协议头结构中也有一个专门的<strong>心跳位</strong>，就是用来标记心跳消息的，它对业务应用透明。</li></ol><h4 id="4-序列化"><a href="#4-序列化" class="headerlink" title="4.序列化"></a>4.序列化</h4><p><strong>两方面会直接影响 RPC 的性能，一是传输方式，二是序列化。</strong>RPC通信毕竟是远程通信，需要将对象转化成二进制流进行传输。不同的RPC框架应用的场景不同，在序列化上也会采取不同的技术。 就序列化而言，Java 提供了默认的序列化方式，但在高并发的情况下，这种方式将会带来一些性能上的瓶颈，于是市面上出现了一系列优秀的序列化框架，比如：Protobuf、Kryo、Hessian、Jackson 等，它们可以取代 Java 默认的序列化，从而提供更高效的性能。<strong>编码内容</strong>：出于效率考虑，编码的信息越少越好（传输数据少），编码的规则越简单越好（执行效率高）。</p><h2 id="RPC-vs-Restful"><a href="#RPC-vs-Restful" class="headerlink" title="RPC vs Restful"></a>RPC vs Restful</h2><p>其实这两者并不是一个维度的概念，总得来说RPC涉及的维度更广。如果硬要比较，那么可以从RPC风格的url和Restful风格的url上进行比较。比如你提供一个查询订单的接口，用RPC风格和Restful风格的区别如下表格</p><table><thead><tr><th>RPC</th><th>Restful</th></tr></thead><tbody><tr><td>GET  /api/queryOrder</td><td>GET  /api/queryOrder</td></tr><tr><td>GET  /api/addOrder</td><td>POST  /api/addOrder</td></tr><tr><td>GET  /api/updateOrder</td><td>PUT  /api/updateOrder</td></tr><tr><td>GET  /api/deleteOrder</td><td>DELETE  /api/deleteOrder</td></tr></tbody></table><p><strong>RPC是面向过程，Restful是面向资源</strong>，并且使用了Http动词。从这个维度上看，Restful风格的url在表述的精简性、可读性上都要更好。所以REST 通过 URI 暴露资源时，会强调不要在 URI 中出现动词。</p>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>七层网络模型</title>
      <link href="/2019/07/28/qi-ceng-wang-luo-mo-xing/"/>
      <url>/2019/07/28/qi-ceng-wang-luo-mo-xing/</url>
      
        <content type="html"><![CDATA[<p>对于Java EE开发者来说，网络编程大多只需要使用HTTP通信协议就可以了，不需要关注协议具体的数据交换细节。不过随着时间的推移，我对这个过程越来越好奇，试想一下我在中国上海使用微信给一位身处美国洛杉矶的朋友发一条消息，这条消息是经过了哪些线路最终传输到朋友的手机上的。这条消息是怎么找到朋友的设备IP的。这个世界的计算机又是如何组成一个计算机网络的。我们知道两台计算机直接的联系是依靠网络来完成的，但是网络的信息传递又是依靠七层模型（即 物理层、数据链路层、网络层、传输层、会话层、表示层、应用层），我们称之为—– OSI参考模型。OSI模型是解决一台机器上的一个应用软件与另一个机器上的应用软件所进行的信息交互。因为计算机与计算机进行联系，他们都是硬件设备，所以想要建立联系，就必须有软件的支持。</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/net0.jpg" alt></p><a id="more"></a> <h2 id="OSI参考模型"><a href="#OSI参考模型" class="headerlink" title="OSI参考模型"></a>OSI参考模型</h2><p>在上世纪70年代，国外一些主要计算机生产厂家先后推出了各自的网络体系结构，但它们都属于专用的。为使不同计算机厂家的计算机能够互相通信，以便在更大的范围内建立计算机网络，有必要建立一个国际范围的网络体系结构标准。国际标准化组织ISO 于1981年正式推荐了一个网络系统结构—-七层参考模型  ，叫做开放系统互连模型(Open System Interconnection，OSI)。由于这个标准模型的建立,使得各种计算机网络向它靠拢，大大推动了网络通信的发展。OSI定义了网络互连的七层框架（物理层、数据链路层、网络层、传输层、会话层、表示层、应用层），即ISO开放互连系统参考模型。如下图。</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/network.png" alt></p><p>还有一种通信模型是TCP/IP五层协议，它与OSI的七层协议区别如下，实际上就是把OSI的上三层合并为一层了。其中最上层中就有我们熟悉的HTTP，FTP协议。</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/net.png" alt></p><p>OSI的七层协议每层各自的功能</p><ol><li><strong>应用层：</strong>  OSI参考模型中最靠近用户的一层，是为计算机用户提供应用接口，也为用户直接提供各种网络服务。我们常见应用层的网络服务协议有：HTTP，HTTPS，FTP，POP3、SMTP等。</li><li><strong>表示层：</strong>数据的表示、安全、压缩，编码。负责设备固有的数据格式与网络标准数据格式之间的转换（接收各种形式的信息，如文字，图片，视频，音频等）。数据压缩和加密也是表示层提供的转换功能。格式有JPEG、ASCll、DECOIC、加密格式等。</li><li><strong>会话层：</strong> 负责建立、管理和终止表示层实体之间的通信会话。该层的通信由不同设备中的应用程序之间的服务请求和响应组成。      </li><li><strong>传输层：</strong>  传输层建立了主机端到端的连接。有了MAC地址和IP地址，我们就能精准的找到某台计算机了，但还需要一个参数，表示数据应该发送给哪个应用程序。例如计算机上同时运行这QQ和微信，这个参数就能决定数据是送给QQ还是送给微信，这个参数就是端口。传输层的功能就是建立端到端的通信，只有这层成功了，两台计算机上的进程才能实现数据交换。</li><li><strong>网络层：</strong> 进行逻辑地址寻址，实现不同网络之间的路径选择。本层通过IP寻址来建立两个节点之间的连接，为源端的运输层送来的分组，选择合适的路由和交换节点，正确无误地按照地址传送给目的端的运输层。就是通常说的IP层。这一层就是我们经常说的IP协议层。IP协议是Internet的基础。</li><li><strong>数据链路层：</strong> 建立逻辑连接、进行硬件地址寻址、差错校验等功能。将比特组合成字节进而组合成帧，用MAC地址访问介质，错误发现但不能纠正。数据链路层又分为2个子层：逻辑链路控制子层（LLC）和媒体访问控制子层（MAC）。 MAC子层处理CSMA/CD算法、数据出错校验、成帧等；LLC子层定义了一些字段使上次协议能共享数据链路层。 在实际使用中，LLC子层并非必需的。</li><li><strong>物理层：</strong> 建立、维护、断开物理连接。 实际最终信号的传输是通过物理层实现的。通过物理介质传输比特流。规定了电平、速度和电缆针脚。常用设备有（各种物理设备）集线器、中继器、调制解调器、网线、双绞线、同轴电缆。这些都是物理层的传输介质。</li></ol><p>基本上Java开发者都是面向应用层的开发，更多的是关心应用程序的逻辑细节，而不是数据在网络中的传输活动。应用层其下三层则处理真正的通信细节。在 Internet 整个发展过程中的所有思想和着重点都以一种称为 RFC（Request For Comments）的文档格式存在。针对每一种特定的 TCP/IP 应用，有相应的 RFC文档。</p><h2 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h2><p>为什么需要通信协议？OSI协议搞了七层协议，比较复杂。如果没有七层协议我们就不能实现计算机的通信了吗？当然可以，只不过张三用张三的协议，李四用李四的协议，久而久之可能张三的协议占据了主流，这时候我们学习的就不是OSI协议了而是张三协议。协议只是一种双方都明白或者必须遵守的事先约定，实际上人类很早就在使用协议了，比如我们说的汉语，汉文字就是一种通信协议。语言统一了对生活中事物的描述和表达，只有大家都把猪称之为猪，把房子称之为房子。我们才能更好的交流发展。又比如说长城上放狼烟，是因为人们已经预先设定好狼烟这个物理信号代表了“敌人入侵”这一抽象信号。这样一个“狼烟=敌人入侵”就是一个简单的协议。而汉语和英语就是两种不同的通信协议，如果一个中国人和美国人交流，就需要一个翻译官，这个翻译扮演的角色就类似OSI七层协议中的表示层。计算机中的通信协议很多也比较复杂，比如摩尔斯码(Morse Code)，使用短信号和长信号的组合，来代表不同的英文字母。同样，计算机之间的通信也要遵循不同层次的协议，来实现计算机的通信。早期的计算机网络，都是由各厂商自己规定一套协议，IBM，Apple，和MicroSoft都有自己的网络协议，比如MicroSoft的两台电脑用网线连起来，互相说话能听懂。但是MicroSoft和Apple的电脑连接起来说话就听不懂了，想想你和我微信聊天，我是MicroSoft电脑，你是Apple电脑，你发送的消息到我这里显示不了或者解析成另一个意思，这样通讯就不能进行了。为了把全世界的所有不同类型的计算机都连接起来，就必须规定一套全球通用的协议，为了实现这个目标，<strong>互联网协议簇</strong>（Internet Protocol Suite）就成为了通用协议标准。互联网协议包含了上百种协议，但是最重要的两个协议是TCP和IP协议，而我们通常把基于TCP和IP协议的所有协议统称为<strong>”TCP/IP协议（蔟）”</strong>。下图是一个完整的OSI七层协议的图，对每一层的协议都标注的比较清楚。</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/nets.gif" alt></p><h2 id="光缆分布"><a href="#光缆分布" class="headerlink" title="光缆分布"></a>光缆分布</h2><p>电脑要组网，第一件事要干什么？当然是先把电脑连起来，可以用光缆、电缆、双绞线、无线电波（WiFi）等方式。这是物理层的职责，前面说到在上海发微信消息给洛杉矶，消息是怎么过去的。毫无疑问的是，消息肯定会经过物理层。但是上海和美国相差半个地球会用无线电波的方式吗？显然不太可能，因为无线波传播介质是空气，暴雨雷电等恶劣天气就会影响无线波的传输。因此无线波传输固然方便但存在不稳定和不可控的因素。中美两国之间的网络通信是通过海底光缆。两个不同的局域网（电信的网络和移动的网络）通讯，稍微麻烦点，我的电信手机先连上电信的服务器，你的移动手机连移动服务器，他们两个ISP（Internet Service Provider 互联网服务提供商）之间是通过物理手段链接的，这样我们就能够间接的实现通讯了。下图是2015年全球互联网跨国通信光缆的连接情况：</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/net10.jpg" alt></p><p>下面是2015年中国部分的互联网跨国通信光缆的连接情况图，就是上图中国部分的放大版。</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/net5.jpg" alt></p><p>从图中可以看出中国的跨国海底光缆并不多，主要集中在几个重要的沿海城市，这会不会是互联网公司主要集中在沿海的一个因素，因此在连接国外的网站延迟这么大也就是情理之中的事了。其中可以看到下面光缆节点比较多，主要集中在香港。所以在购买翻墙软件选择VPN节点时，选择靠近香港的会比较好。</p><h2 id="互联网的历史"><a href="#互联网的历史" class="headerlink" title="互联网的历史"></a>互联网的历史</h2><p>Internet的最早起源于美国国防部高级研究计划署DARPA(Defence Advanced Research Projects Agency)的前身ARPAnet，该网于1969年投入使用。没有ARPA，就没有如今的互联网。由此，ARPAnet成为现代计算机网络诞生的标志。作为一家军事研究机构，Arpa 在创造互联网时具有明确的军事动机：它能够提供一种方式，将计算能力带到前线。1969 年，Arpa 建立了一个称为 Arpanet 的计算机网络，将全美各大学院校、政府机关和国防承包商的主机连接在一起。Arpanet 发展迅速，到上世纪 70 年代中期，已经拥有大约 60 个节点。但Arpanet 存在一个问题，它无法移动。按今天的标准，Arpanet 上的计算机堪称庞然大物，它们通过固定链路进行通信。这对于坐在剑桥或门罗帕克市的计算机终端前的研究人员来说，或许行得通，但对于深入敌区的士兵而言，却是远水难救近火。Arpanet 要在战场上派上用场，就必须在世界的任何地方都能够访问。想象一辆在扎伊尔丛林中行驶的吉普车，或者一架在北越上空盘旋的B-52 轰炸机。然后把它们想象成一个无线网络上的节点，而这个无线网络又连接到数千英里之外拥有众多强大计算机的另一个网络。这正是利用计算能力打击苏联及其盟国的网络化军队的梦想。正是这个梦想催生了互联网。要让这个梦想成真，需要做两件事情。首先是建立一个无线网络，通过无线电或卫星在广泛分布的美国军队设施之间中继数据包。其次要将这些无线网络连接到Arpanet 的有线网络，以便那些价值数百万美元的大型主机能够为前线的士兵服务。科学家称之为“网络互联”。发明互联网的初衷就是要解决网络互联的问题。网络互联给人们带来了巨大的挑战。把两台计算机连在一起，只是迈出了建立互联网的一小步。人们很快发现，如果要把更多的不同型号的计算机，通过不同规格的网络连接在一起，还要让它们能共享内容，就非得发明一套更先进的技术不可。假如看到互联网发明之初的那股子混乱劲儿，熟练操作着智能手机、利用无线信号进行视频对话的现代人可能会觉得难以置信。Arpanet问世之后，美国军方很快采纳了这一技术，但是，接入网络的电脑越来越多，造成发送信息的计算机很难在庞杂的网络中定位目标计算机。并且，最初的网络缺少纠错功能，数据在传输过程中一旦出现错误，网络就可能停止运行。出错电脑增多，使得网络运行效率大打折扣。于是便催生了第一份互联网协议</p><h4 id="TCP-IP协议诞生"><a href="#TCP-IP协议诞生" class="headerlink" title="TCP/IP协议诞生"></a>TCP/IP协议诞生</h4><p>  大名鼎鼎的两位科学家、TCP/IP协议的发明者——罗伯特·卡恩和文顿·瑟夫就是在这时开始了他们的重要工作。他们恐怕也是这一群拥有“互联网之父”头衔的科学家中知名度最高的。他们都获得过“计算机科学界的诺贝尔奖”——图灵奖，瑟夫还曾任谷歌公司的全球副总裁和首席互联网专家。两位科学家首先着眼于给每台电脑都分配一个唯一的确定的地址，就像住宅的门牌号一样，有了它快递员才能把包裹准确投递到位——这就是IP。而TCP则负责监督传输过程，一出现问题就发出信号，要求重新传输，直到所有数据安全正确地传输到目的地。这套思想直接导致了一种新设备——路由器的出现。在1973年问世并被持续不断改进的TCP/IP协议至今仍然是全球互联网得以稳定运作的保证。通过这项技术，两位科学家使信息传输的可靠性完全由主机设备保障，而与连接这些主机的网络硬件的材质与形态无关。人们评价说，TCP/IP技术将最终可以运行在“两个罐子和一根弦”上，甚至可以用信鸽来代替网络。<strong>如果将TCP/IP申请专利，世界首富还会是盖茨吗？</strong>全世界已经有几十亿人在使用互联网，三十多年前研究TCP/IP的时候，谁也没有想到这项技术会得到如此广泛的运用。在这个信息社会谁也离不开网络。因此这个问题就好像如果交流电申请专利，尼古拉特斯拉会不会成为首富一样。如今，TCP/IP协议让互联网越来越远，毫不夸张的说，没有这张“网”的世界将不能成为21世纪。“网”一直处于虑拟世界，看不见、摸不着，连接世界的互联网你有没有想过到底是什么样子的？一起来看看下图</p><p><img src="/2019/07/28/qi-ceng-wang-luo-mo-xing/tcpnet.jpg" alt></p><p>这个图是基于真实的世界互联网真实路由节点绘制出来的，这个图的右下角放大了网络拓扑中的一个星状亮点，从放大的图片可以看出，每个星状亮点的末枝对应的就是一个局域网的<strong>内网IP地址</strong>；而亮点的中心对应的就是路由器的IP地址，也就是互联网的<strong>外网IP地址</strong>。注意内网IP和外网IP不是一个概念，路由器拥有两组IP地址，分别为<strong>外网IP地址</strong>和<strong>内网IP地址</strong>；其中外网IP地址是网络运营商所分配的IP地址，用于唯一标识此路由器在互联网中的位置。而内网IP地址则用于实现局域网电脑与路由器之间的相互访问，通过路由器内网IP地址，其它处于局域网中的电脑可以通过此IP地址获取网关地址，从而通过路由器实现访问互联网操作。</p>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编程范式漫谈</title>
      <link href="/2019/07/14/bian-cheng-fan-shi-man-tan/"/>
      <url>/2019/07/14/bian-cheng-fan-shi-man-tan/</url>
      
        <content type="html"><![CDATA[<p>最近在学习Golang时，发现自己对编程语言的理解还不够透彻。在Go的官网上写道<strong>Go</strong>（又称<strong>Golang</strong>）是Google开发的一种静态强类型、编译型、并发型，并具有垃圾回收功能的编程语言。虽然我知道Java是一种静态强类型解释型语言，但回头一想却没有仔细追究过静态，强类型，解释型代表的含义。编程语言种类繁多，静态动态，强类型弱类型，解释型和编译型，还有命令式编程和函数式编程。不好好梳理一下这些基础概念，会让我感觉自己的知识犹如空中楼阁，那种下不着地的感觉让人很不踏实。</p><p><img src="/2019/07/14/bian-cheng-fan-shi-man-tan/go.jpg" alt></p><a id="more"></a> <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>静态类型：</strong>在编译时变量的数据类型即可确定的语言，多数静态类型语言要求在使用变量之前必须声明数据类型，某些具有类型推导能力的现代语言可能能够部分减轻这个要求，例如在Java8中的泛型，List&lt; String&gt; list = new ArrayList&lt;&gt;()。由于前面指定了String类型，后面ArrayList就不需要指定类型了，编译器会推导出这个类型。</p><p><strong>动态类型：</strong>动态类型语言是指在运行期间才去做数据类型检查的语言，也就是说，在用动态类型的语言编程时，永远也不用给任何变量指定数据类型，该语言会在你第一次赋值给变量时，在内部将数据类型记录下来。Python和Ruby就是一种典型的动态类型语言，其他的各种脚本语言如VBScript也多少属于动态类型语言。</p><p><strong>强类型：</strong>强制数据类型定义的语言。也就是说，一旦一个变量被指定了某个数据类型，如果不经过强制转换，那么它就永远是这个数据类型了。例如在Java中定义了一个整型变量a,那么程序根本不可能将a当作字符串类型处理。强类型定义语言是类型安全的语言。我们知道计算机是结构化很强的，堆栈上一个二进制位的错误就会导致溢出，bus等错误。所以语言层面的自由得益于编译器或者解释器的功劳。比如java，c等语言有很强的编译时类型检测机制，强类型的好处驱使编码人员写出很少有语法，语义错误的代码，对IDE的支持也很棒，是大型技术团队的基石。</p><p><strong>弱类型：</strong>数据类型可以被忽略的语言。它与强类型定义语言相反, 一个变量可以赋不同数据类型的值。这个在JavaScript中表现很明显，在JavaScript中声明变量时都可以声明为 var 类型。这种思维方式很接近自然语言了，我们日常沟通中文字就是文字并不需要区分整型，字符串型，布尔型。通常的说，Java/Python都算是强类型的，而 VB/Perl/C/JavaScript 都是弱类型的。弱类型语言让我们获取了自由（不需要类型信息），让开发者少敲了许多键盘。但自由是有代价的，编译器或解释器中内含类型推理(infer type); 类型推理是利用归一方法，基于上下文中的变量显式类型，操作符，返回值等信息，利用栈和逐渐替换的过程来推到出类型。 弱类型虽然可以轻松编译通过（或者不需要编译而是解释执行），但都是有类型检查过程的，只是将此过程延迟到运行时了。所以弱类型语言结构化不强，编码时很难确保类型无误，IDE，大型团队开发也不友好。 但是通过一些分析器可以不断的检测语法，语义错误，相当于达到了强类型语言的IDE效果。</p><h2 id="编译型和解释型"><a href="#编译型和解释型" class="headerlink" title="编译型和解释型"></a>编译型和解释型</h2><p>我之前一直以为Java是编译型语言，因为每次运行程序都需要把工程先编译打成jar包，然后再去运行，但实际上Java是解释型语言，这也是为什么Java移植性强的原因。而实际上，很多高级语言都是解释型语言。Java、JavaScript、VBScript、Perl、Python、Scala、C#等。而编译型语言大多是偏底层的语言，如C/C++、Pascal/Object Pascal（Delphi）、VB。解释型语言和编译型语言区别只有一个，就是在把代码翻译成机器码的时机不同。先来解释一下这两个概念吧</p><p><strong>编译型：</strong>编程语言在程序执行之前，有一个单独的编译过程，将程序翻译成机器语言（二进制代码），以后执行这个程序的时候，就不用再进行翻译成机器码了。举个例子，先看编译型以C语言为例子，C语言在工程写完之后也需要一个工具将代码翻译为机器码，这个工具叫 gcc 。这个过程说得专业一点，就称为编译（Compile），而负责编译的程序自然就称为编译器（Compiler）。如果我们写的程序代码都包含在一个源文件中，那么通常编译之后就会直接生成一个可执行文件，我们就可以直接运行了。但对于一个比较复杂的项目，为了方便管理，我们通常把代码分散在各个源文件中，作为不同的模块来组织。这时编译各个文件时就会生成目标文件（Object file）而不是前面说的可执行文件。一般一个源文件的编译都会对应一个目标文件。这些目标文件里的内容基本上已经是可执行代码了，但由于只是整个项目的一部分，所以我们还不能直接运行。待所有的源文件的编译都大功告成，我们就可以最后把这些半成品的目标文件“打包”成一个可执行文件了，这个工作由另一个程序负责完成，由于此过程好像是把包含可执行代码的目标文件连接装配起来，所以又称为链接（Link），而负责链接的程序就叫链接程序（Linker）。链接程序除了链接目标文件外，可能还有各种资源，像图标文件啊、声音文件啊什么的，还要负责去除目标文件之间的冗余重复代码，等等。链接完成之后，一般就可以得到我们想要的可执行文件了。 </p><p><strong>解释型：</strong>解释型语言，是在运行的时候将程序翻译成机器语言，所以运行速度相对于编译型语言要慢。这中间通常需要一个解释器。例如Java再经过JDK编译后，生成的是字节码，而不是机器码。字节码不能直接运行在操作系统上。因此需要经过解释器将字节码翻译为机器码，再交给操作系统执行，在Java中这个解释器就是JVM。翻译的时刻是在程序运行的前一刻，程序每执行到源程序的某一条指令，会有一个称之为解释程序的外壳程序将源代码转换成二进制代码以供执行，总言之，就是不断地解释、执行、解释、执行……所以，解释型程序是离不开解释程序的。像早期的BASIC就是一门经典的解释型语言，要执行BASIC程序，就得进入BASIC环境，然后才能加载程序源文件、运行。解释型程序中，由于程序总是以源代码的形式出现，因此只要有相应的解释器，移植几乎不成问题。编译型程序虽然源代码也可以移植，但前提是必须针对不同的系统分别进行编译，对于复杂的工程来说，的确是一件不小的时间消耗，况且很可能一些细节的地方还是要修改源代码。而且，解释型程序省却了编译的步骤，修改调试也非常方便，编辑完毕之后即可立即运行，不必像编译型程序一样每次进行小小改动都要耐心等待漫长的Compiling…Linking…这样的编译链接过程。不过凡事有利有弊，由于解释型程序是将编译的过程放到执行过程中，这就决定了解释型程序注定要比编译型慢上一大截，像几百倍的速度差距也是不足为奇的。 </p><p>编译型与解释型，两者各有利弊。前者由于程序执行速度快。同等条件下对系统要求较低，因此像开发操作系统、大型应用程序、数据库系统等时都采用它。而服务器脚本及辅助开发接口这样的对速度要求不高、对不同系统平台间的兼容性有一定要求的程序则通常使用解释性语言。所以如果你愿意，你也可以自己用一门底层语言编写一个解释器，创造出一种高级语言。当然，现存的高级语言都是经历考验、受到广泛认可的，这才能流行起来，让大家来都遵循你的规范。代码世界里的规则完全是由人创造的，如果没有人遵循你创造的规则，那这个规则就只对你自己有意义了，对其他人则毫无意义。Java的编译器由C语言编写，C语言的编译过程有一步叫汇编，任何代码，最终都是要转化二进制命令来执行动作的，当然这个过程就在现今看来步骤就太多太复杂了。</p><h2 id="命令式与函数式"><a href="#命令式与函数式" class="headerlink" title="命令式与函数式"></a>命令式与函数式</h2><p>命令式编程与函数式编程其实早在上个世纪就有了，一直都是命令式编程占据主导地位，例如Java，C语言都是命令式编程语言，不过最近几年函数式编程也异军突起，在Java8中也加入了函数式编程范式，<em>Lambda 表达式</em>。个人理解，在硬件架构上现在主流的计算机基本使用的是冯诺依曼架构，函数式编程与面向对象一样是对硬件工作方式的一种上层抽象，只不过两者思考问题的角度不一样。“函数式编程”, 又称泛函编程, 是一种”编程范式”（programming paradigm），也就是如何编写程序的方法论。它的基础是 λ 演算（lambda calculus）。λ演算可以接受函数当作输入（参数）和输出（返回值）。λ 演算可以被称为最小的通用程序设计语言。它包括一条变换规则 (变量替换) 和一条函数定义方式，λ演算之通用在于，任何一个可计算函数都能用这种形式来表达和求值。因而，它是等价于图灵机的。尽管如此，λ演算强调的是变换规则的运用，而非实现它们的具体机器。可以认为这是一种更接近软件而非硬件的方式。它一个数理逻辑形式系统，使用变量代入和置换来研究基于函数定义和应用的计算。希腊字母λ被用来在λ演算模型中表示将一个变量绑定在一个函数中。就像在OOP中，一切皆是对象，编程的是由对象交互创造的世界；在FP中，一切皆是函数，编程的世界是由函数交互创造的世界。</p><h4 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h4><p>在计算机科学刚刚起步的时候，很多计算机科学的理论都还没有落地。那时候有两个伟大的计算机科学家：阿隆佐·丘奇和阿兰·图灵。他们创造了两个不同的，但是具有同等效力的通用计算模型。两个模型都可以计算任何可以计算的东西。阿隆佐·丘奇发明了 λ 演算， λ 演算是基于函数应用的通用计算模型。阿兰·图灵则因图灵机而广为人知。图灵机定义了一个理论上的设备，它可以控制条带上的符号。他们合作证明了 λ 演算和图灵机是功能等价的。λ 演算全部都是关于函数组合。函数组合在软件开发中是非常富有表现力和说服力的。这里有三点关于 λ 演算的特殊说明：</p><ol><li>函数通常是匿名的。在 JavaScript 中，<code>const sum = (x, y) =&gt; x + y</code> 的右边是匿名函数，即 <code>(x, y) =&gt; x + y</code>。</li><li>λ 演算中的函数只接受单一输入，它是一元的。如果你需要传递多参数，函数会接受第一个输入并且返回一个新的函数来接受第二个参数，以此类推。一个 n 元函数 <code>(x, y) =&gt; x + y</code> 可以表达为一个一元函数：<code>x =&gt; y =&gt; x + y</code>。这种 n 元函数到一元函数的转化叫做柯里化。</li><li>函数是一级的。意思是说一个函数可以作为另一个函数的输入，并且一个函数可以返回另一个函数。</li></ol><p>老外做东西喜欢把一个系统抽象成一个模型，这种方式确实很不错，很大的简化了思考难度。我们从最底层的模型开始思考，在计算机系统模型中，由运算单元（CPU），存储单元（寄存器和内存），输入（键盘或鼠标），输出（显示器或打印机）组成。假设我们就只有这一堆硬件，我们想要这个计算机模型正常工作，需要人工把计算的过程送入CPU，人工把计算的中间结果送入内存，把最终的结果送入显示器并显示出来。太麻烦了，这些事情怎么自动化，多个计算任务怎么协调工作，于是就有了操作系统。操作系统就是硬件和软件的大管家，然后我们只要把计算的任务打好包（即可执行程序）交给操作系统运行就行了。但到这还只是解决了硬件层面的问题，那我们怎么把计算任务打包，CPU只认得二进制文件。我们当然只能把二进制的计算任务编写好后给操作系统，再由操作系统交给CPU执行了。但这对于人来说太难了，试想一下，一个文件中全是0和1 ，我们该怎么编写计算的逻辑呢，别说写了，就是看看也让人头痛吧。于是便有了编程语言，最开始的是汇编语言，是将一些二进制指令映射成助记符，极大的简化了开发过程，编写好程序后再由编译器翻译成二进制代码。当然汇编还是太复杂，科学家们又开始躁动了，于是就有了更高级的语言C，Java，Python等。语言的出现是本质上是为了解决编写计算任务（也就是程序）时使用二进制太难的问题。但实际上还有很多其他便利，现在知道了编程语言的必要性，试想一下，如果我们自己想发明一门语言首先要考虑的问题是什么呢？语法还是性能，我觉得应该是选择编程范式，即应该是以函数式还是以命令式作为语言的编程范式。这将决定了语言的编程思想，也就是你以什么样的方式去看待现实中的问题，并将这些问题转化到语言层面交给计算机解决。因此个人理解面向对象和函数式只是在不同的角度对待计算系统的问题。面向对象更关注于把计算过程中的一些属性和方法封装成对象，然后通过这些对象的交互解决问题，而函数式编程更关注于把复杂的计算过程拆分成一个个小的单一的计算方法（也就是函数），通过这些方法的层层调用使系统最终趋于稳定，解决问题，这里在拆分为函数时需要是一个纯函数（即相同的输入，永远会得到相同的输出，没有任何可观察的副作用）才满足函数式编程的思想。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 其他 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>硬盘的工作原理</title>
      <link href="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/"/>
      <url>/2019/07/13/ying-pan-de-gong-zuo-yuan-li/</url>
      
        <content type="html"><![CDATA[<p>硬盘是用于存储数据的硬件，内存也是存储数据的，但二者不同的是内存数据是掉电不保存的而硬盘数据是可以永久保存的，在读写速度上硬盘比内存慢几个数量级。硬盘也是和程序交互比较频繁的硬件了，经常在看一些数据存储相关框架的原理时，会对一些硬盘方面的专业术语感到迷惑，不明白其中的含义。例如寻道时间，旋转时间，顺序读写，随机读写等。故整理了一下硬盘的工作原理，对于软件开发者来说，硬盘的相关操作都被封装成了系统接口，上层只管调用就行了。但了解硬件的工作原理对于软件开发还是有帮助的，本文将从硬件角度了解硬盘是如何运转的。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/disk.jpg" alt></p><a id="more"></a> <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>从硬盘问世至今已经过了60多个年头，不管是容量、体积还是生产工艺都较之前有了重大革新和改进。硬盘按照其工作形式的不同分为两种，机械硬盘HDD（Hard Disk Drive）和固态硬盘SSD（Solid State Drive）。机械硬盘即传统的普通硬盘，主要由盘片、盘片转轴、磁头组件、磁头驱动机构、控制电路组成。固态硬盘类似于U盘技术，全电子结构，没有机械运动部件，采用集成电路存储技术，由控制单元和存储单元组成。</p><h4 id="机械硬盘"><a href="#机械硬盘" class="headerlink" title="机械硬盘"></a>机械硬盘</h4><p>机械硬盘（Hard Disk Drive）即传统普通硬盘，其构成部件主要是：磁盘、转轴及控制电机、磁头、磁头控制器、接口等几个部分构成。磁头在高速运转的磁盘上到达预先指定位置对数据进行读写操作。数据信息通过离磁性表面仅一根发丝直径大小的磁头，以电磁流改变极性方式写到磁盘上，数据信息可以通过相反的方式读取。其读写速度依赖于电机的转速，因为需要依靠电机带动磁盘高速转动使磁头找到指定位置进行读写，所以，在当下对读写速度的高要求下机械硬盘显得疲于应对。</p><h4 id="固态硬盘"><a href="#固态硬盘" class="headerlink" title="固态硬盘"></a>固态硬盘</h4><p>固态硬盘（Solid State Disk），简称固盘或者也称其为SSD，固态硬盘是基于固态电子存储芯片阵列制成的硬盘，由控制单元和存储单元组成。固态硬盘与机械硬盘在功能、规范和使用方式上完全相同，因其为纯芯片结构，相较于机械硬盘固态硬盘的体积和重量要小很多。从采用的存储介质来看主要分为两种，一种是选用Flash芯片作为存储介质，基于闪存设计的固态硬盘：根据闪存的不同又分为NAND闪存和NOR闪存。由于NAND闪存存储密度大，改写速度快等优点，因而在业界得到广泛应用。被制作成如体积小巧的U盘、笔记本硬盘、数码产品的存储卡等。NAND固态硬盘凭借可移动性，数据保护不受限于电源控制，更适合于个人用户在各种工况下使用。另一种固盘是采用DRAM作为存储介质，应用方式可分为SSD硬盘和SSD硬盘阵列两种。虽然它拥有较长的使用寿命，性能突出，美中不足的是为了保护数据安全需要独立的电源，一旦掉电RAM内的数据就将丢失，价格昂贵。所以目前DRAM固态硬盘应用范围较窄。</p><p>由于固态硬盘成本高，而且固态硬盘如果损坏难以恢复等原因，目前服务器广泛采用的还是机械硬盘作为数据存储媒介。需要注意的是机械硬盘驱动器磁头的飞行悬浮高度低、速度快，一旦有小的尘埃进入硬盘密封腔内，或者一旦磁头与盘体发生碰撞，就可能造成数据丢失，形成坏块，甚至造成 磁头和盘体的损坏。所以，硬盘系统的密封一定要可靠，在非专业条件下绝对不能开启硬盘密封腔，否则，灰尘进入后会加速硬盘的损坏。另外，硬盘驱动器磁头的寻道伺服电机多采用音圈式旋转或直线运动步进电机，在伺服跟踪的调节下精确地跟踪盘片的磁道，所以，硬盘工作时不要有冲击碰撞，搬动时要小心轻放。</p><h2 id="机械磁盘结构"><a href="#机械磁盘结构" class="headerlink" title="机械磁盘结构"></a>机械磁盘结构</h2><p>无论哪种机械硬盘，都主要由盘片、磁头、盘片主轴、控制电机、磁头控制器、数据转换器、接口、缓存等几个部份组成。其中所有的盘片都固定在一个旋转轴上，这个轴即盘片主轴。而所有盘片之间是绝对平行的，在每个盘片的存储面上都有一个磁头，磁头与盘片之间的距离比头发 丝的直径还小。所有的磁头连在一个磁头控制器上，由磁头控制器负责各个磁头的运动。磁头可沿盘片的半径方向动作，而盘片以每分钟数千转到上万转的速度在高速旋转，这样磁头就能对盘片上的指定位置进行数据的读写操作。因此这里也可以知道平时我们购买硬盘时，硬盘的转速就是一个很好的参考指标。转速越快说明硬盘效率越高，读写速度越快。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/disk1.jpg" alt></p><h4 id="盘片与磁头"><a href="#盘片与磁头" class="headerlink" title="盘片与磁头"></a>盘片与磁头</h4><p>盘片的表面涂有磁性材料，厚度一般在0.5mm左右。碟片安装在主轴马达的转轴上，工作时所有碟片在主轴马达的带动下高速旋转。每个碟片都有正反两面，称为盘面。第1个碟片的正面称为0面，反面称为1面，第2个碟片的正面称为2面，反面称为3面…依次类推。每个盘面都有一个对应磁头负责读写该该盘面上的数据。关机时，磁头停留在硬盘的停泊区。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/disk13.png" alt></p><p>主轴上的盘片是绝对平行的，在每个盘片的存储面上都有一个磁头，当磁盘工作时，磁头与盘面并不会接触，硬盘工作时盘片飞速旋转产生的气流相当强，足以使磁头托起，并与盘面保持一个微小的距离。这个距离越小，磁头读写数据的灵敏度就越高，当然对硬盘各部件的要求也越高。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/disk4.jpg" alt></p><p>早期设计的磁盘驱动器使磁头保持在盘面上方几微米处飞行。稍后一些设计使磁头在盘面上的飞行高度降到约0.1μm～0.5μm，现在的水平已经达到 0.005μm～0.01μm，这只是人类头发直径的千分之一。磁头必须飞行在盘面上方，而不是接触盘面，这种位置可避免擦伤磁性涂层，但更重要的是不让磁性涂层损伤磁头。但是，磁头也不能离盘面太远，否则，就不能使盘面达到足够强的磁化，难以读出盘上的磁化翻转（磁极转换形式，是磁盘上实际记录数据的方式）所有的磁头连在一个磁头控制器上，由磁头控制器负责各个磁头的运动。磁头可沿盘片的半径方向动作，，每个磁头同一时刻也必须是同轴的，即从正上方向下看，所有磁头任何时候都是重叠的（不过目前已经有多磁头独立技术，可不受此限制）。由于每个盘片有正反两个面。每个盘面对应一个磁头用于读写数据。第一个盘面的正面的磁头称为0磁头，背面称为1磁头；第二个盘片正面的磁头称为2磁头，背面称为3磁头，以此类推。盘面数和磁头数是相等的。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/diks5.jpg" alt></p><h4 id="磁道"><a href="#磁道" class="headerlink" title="磁道"></a>磁道</h4><p>磁盘在格式化时被划分成许多同心圆，这些同心圆轨迹叫做磁道（Track）。磁道从外向内从0开始顺序编号。硬盘的每一个盘面有300～1 024个磁道，新式大容量硬盘每面的磁道数更多。信息以脉冲串的形式记录在这些轨迹中，这些同心圆不是连续记录数据，而是被划分成一段段的圆弧，这些圆弧 的角速度一样。由于径向长度不一样。所以，线速度也不一样，外圈的线速度较内圈的线速度大，即同样的转速下，外圈在同样时间段里，划过的圆弧长度要比内圈 划过的圆弧长度大。每段圆弧叫做一个扇区，扇区从“1”开始编号，每个扇区中的数据作为一个单元同时读出或写入。一个标准的3。5寸硬盘盘面通常有几百到 几千条磁道。磁道是“看”不见的，只是盘面上以特殊形式磁化了的一些磁化区，在磁盘格式化时就已规划完毕。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/disk6.jpg" alt></p><h4 id="柱面"><a href="#柱面" class="headerlink" title="柱面"></a>柱面</h4><p>所有盘面上的同一磁道构成一个圆柱，通常称做柱面（Cylinder），每个圆柱上的磁头由上而下从“0”开始编号。数据的读/写按柱面进行，即磁 头读/写数据时首先在同一柱面内从“0”磁头开始进行操作，依次向下在同一柱面的不同盘面即磁头上进行操作，只在同一柱面所有的磁头全部读/写完毕后磁头才转移到下一柱面，因为选取磁头只需通过电子切换即可，而选取柱面则必须通过机械切换。电子切换相当快，比在机械上磁头向邻近磁道移动快得多，所以，数据 的读/写按柱面进行，而不按盘面进行。也就是说，一个磁道写满数据后，就在同一柱面的下一个盘面来写，一个柱面写满后，才移到下一个柱面开始写数据。读数据也按照这种方式进行，这样就提高了硬盘的读/写效率。总结来说就是磁盘读写数据是按柱面进行，即在读写时磁头先寻找到数据所在的柱面（寻找磁道），然后再判断数据所在的盘面。这样大大提升了磁盘的读写效率，因为盘面的确定是电子操作速度非常快，但磁道的寻找需要电动马达带动磁头移到到指定磁道上，是机械操作。</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/timg.jpg" alt></p><h4 id="扇区"><a href="#扇区" class="headerlink" title="扇区"></a>扇区</h4><p>操作系统以扇区（Sector）形式将信息存储在硬盘上，每个扇区包括512个字节的数据和一些其他信息。一个扇区有两个主要部分：存储数据地点的标识符和存储数据的数据段。扇区的第一个主要部分是标识符。标识符，就是扇区头标，包括组成扇区三维地址的三个数字：扇区所在的磁头（或盘面）、磁道（或柱面号）以及扇区在磁 道上的位置即扇区号。头标中还包括一个字段，其中有显示扇区是否能可靠存储数据，或者是否已发现某个故障因而不宜使用的标记。有些硬盘控制器在扇区头标中 还记录有指示字，可在原扇区出错时指引磁盘转到替换扇区或磁道。最后，扇区头标以循环冗余校验（CRC）值作为结束，以供控制器检验扇区头标的读出情况， 确保准确无误。扇区的第二个主要部分是存储数据的数据段，可分为数据和保护数据的纠错码（ECC）。在初始准备期间，计算机用512个虚拟信息字节（实际数据的存放地）和与这些虚拟信息字节相应的ECC数字填入这个部分。给扇区编号的最简单方法是l，2，3，4，5，6等顺序编号。如果扇区按顺序绕着磁道依次编号，那么当磁头读取完一个扇区后完全来不及定位到下一个连续的下扇区，盘面就已经旋转过了，这时只能等盘片旋转完一圈，在下一圈来时处理下一个扇区的数据，这极大浪费了时间，所以用交叉编排来解决这个问题。这是许多年前，IBM的一位杰出工程师想出的一个绝妙的办法，即对扇区不使用顺序编号，而是使用一个交叉因子（interleave）进行编号。交叉因子用比值的方法来表示。介绍了这么多，下面是硬盘工作原理的解说视频，比较详细</p><iframe style="with:400px;height:250px" frameborder="0" src="https://v.qq.com/txp/iframe/player.html?vid=t0896p6gnqo" allowfullscreen="true"></iframe><h2 id="硬盘的性能"><a href="#硬盘的性能" class="headerlink" title="硬盘的性能"></a>硬盘的性能</h2><p>明白了硬盘的内部构造和工作原理后，就能大致分析出影响硬盘工作效率的原因了，其主要的性能指标有这几个。寻道时间，旋转时间和传输时间。这几个属性中旋转时间和操作时间基本由硬件决定了，唯一软件可优化的部分就只有寻道时间，Kakfa也正是利用这一点才到达了如此高的吞吐量。首先解释一下这几个指标的含义</p><ul><li><p><strong>寻道时间：</strong>读写数据时磁头首先要移到到指定磁道（柱面），这段时间称为寻道时间。一般硬盘的平均寻道时间在7.5～ 14ms，它比盘片旋转寻找扇区的时间还要长，因此，想要提高磁盘的IO读写性能，需在软件上下功夫，如何减少磁盘的随机读写。这里可以简单列举几个方法：(1).减少文件个数，使用大文件，尤其linux ext系列文件系统。(2).数据库表不要存储太大数据，可以采用分表方式减少单表容量，因为表太大数据库索引的原理就会导致磁盘随机读写增多。(3).提升每次写磁盘的数据大小，数据先缓存到buffer,等满了或超时了再写磁盘。</p></li><li><p><strong>旋转时间：</strong>当磁头移动到指定磁道后，需要等待要操作的扇区旋转到磁头的下方，这段时间称为旋转延迟时间。这个时间取决于硬盘的转速。我们通常所说的7200转的硬盘的转就是这个，7200转的硬盘的平均旋转延迟等于1/2*120≈4.17ms。旋转延迟只和硬件有关。</p></li><li><p><strong>传输时间：</strong>磁头进行读写传输数据所花费的时间</p></li></ul><p>硬盘读写数据时间主要就花在这三个操作上，由此也可得出公式：<strong>磁盘读写时耗 = 寻道时间 + 旋转延迟时间 + 操作时耗</strong>。在聊完了硬盘的工作原理后，再来看看怎么利用硬盘的特性，提高IO的效率。以Kafka为例，首先必须了解关于硬盘读写的另外两个概念，即顺序读写和随机读写。</p><ul><li><p><strong>顺序读写：</strong>读写一个大文件。例如要写一个500M的文件到硬盘，而此时硬盘上有剩余的连续的600M大小空间。这时候写入的文件就是顺序读写。主要时间花费在了传输时间，而这个时间两种读写可以认为是一样的。在读取数据方面，磁盘会预读，预读即在读取的起始地址连续读取多个页面。提高了数据的命中，减少IO次数。</p></li><li><p><strong>随机读写：</strong>读写多个小文件。例如要写一个500M的文件到硬盘，硬盘上还剩余不连续的600M大小空间，这是硬盘不得不将这个500M文件拆分成两个小文件，然后将它们写入到磁盘中。因为存在多次写入，就需要多次寻道和旋转延迟。而这个时间可能是传输时间的许多倍。此外因为数据没有在一起，预读也就没有作用了。</p></li></ul><h2 id="Kafka的高性能"><a href="#Kafka的高性能" class="headerlink" title="Kafka的高性能"></a>Kafka的高性能</h2><p>kafka的高性能原因很多，它分布式的架构设计，数据零拷贝以及高效使用磁盘都是它如此高效的原因。不过这里只关注磁盘的利用。在官网上以及一些论坛上经常能看到kafka变态的性能和吞吐量，更为恐怖的是kafka的数据并没有通过内存来存储的，而是通过磁盘。据LINDEDIN统计，最新的数据是每天利用KAFKA处理的消息超过1万亿条，在峰值时每秒钟会发布超过百万条消息，就算是在内存和CPU都不高的情况下，Kafka的速度最高可以达到每秒十万条数据，并且还能持久化存储。我们知道现在的磁盘大多数都还是机械结构(SSD不在讨论的范围内)，如果将消息以随机写的方式存入磁盘，就会按柱面、磁头、扇区的方式进行(寻址过程)，缓慢的机械运动(相对内存)会消耗大量时间，导致磁盘的写入速度只能达到内存写入速度的几百万分之一，为了规避随机写带来的时间消耗，KAFKA采取顺序写的方式存储数据，如下图所示：</p><p><img src="/2019/07/13/ying-pan-de-gong-zuo-yuan-li/kafka.png" alt></p><p>新来的消息只能追加到已有消息的末尾，并且已经生产的消息不支持随机删除以及随机访问，但是消费者可以通过重置offset的方式来访问已经消费过的数据。即使顺序读写，过于频繁的大量小I/O操作一样会造成磁盘的瓶颈，所以KAFKA在此处的处理是把这些消息集合在一起批量发送，这样减少对磁盘IO的过度读写，而不是一次发送单个消息。另一个是无效率的字节复制，尤其是在负载比较高的情况下影响是显着的。为了避免这种情况，KAFKA采用由Producer，broker和consumer共享的标准化二进制消息格式，这样数据块就可以在它们之间自由传输，无需转换，降低了字节复制的成本开销。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 其他 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入Mybatis源码实现</title>
      <link href="/2019/07/06/shen-ru-mybatis-yuan-ma-shi-xian/"/>
      <url>/2019/07/06/shen-ru-mybatis-yuan-ma-shi-xian/</url>
      
        <content type="html"><![CDATA[<p>MyBatis 是一款优秀的持久层框架，它支持定制化 SQL、存储过程以及高级映射。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以使用简单的 XML 或注解来配置和映射原生信息，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。我使用Mybatis也有好几年了，对于Mybatis配置和使用也是熟门熟路。尤其在Spring Boot出现后，Mybatis的配置和使用也更加简单。但对于Mybatis的原理一直没去了解，Spring Boot在启动时，Mybatis做了哪些事情。在调用Mapper层接口后，底层到底是怎么调用SQL然后操作数据库的。本文就来聊一聊Mybatis的工作原理</p><p><img src="/2019/07/06/shen-ru-mybatis-yuan-ma-shi-xian/mybatis.jpg" alt></p><a id="more"></a> <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>通过Spring Boot使用第三方框架时，配置和使用都变得异常简单。这得益于它的默认大于配置的思想，只要少量的配置就能快速的集成第三方框架，Mybatis同样如此，本文是以Mybatis-1.3.2为例。Maven依赖如下</p><pre class=" language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>使用 mybatis-spring-boot-starter 依赖后，只需要在 yml 中配置xml的扫描路径就可以使用mybatis了。那么这个包的源码中纠结做了哪些事情。打开这个包的源代码，会发现这包中没有代码，只有一个pom.xml</p><p><img src="/2019/07/06/shen-ru-mybatis-yuan-ma-shi-xian/mybatis1.png" alt></p><p>打开这个pom.xml，就能看到Mybatis的全部依赖都在这个pom中了，源码如下</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-autoconfigure<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></code></pre><p>其中重要的依赖就是 mybatis-spring-boot-autoconfigure 包，这个包中就有Mybatis自动注入的源码实现。下面就来看看这个包的源码吧</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在 mybatis-spring-boot-autoconfigure 包中有两个重要的类，分别是 MybatisAutoConfiguration 和 MybatisProperties 。其中 MybatisProperties 的作用很简单就是加载 application.yml 中有关 Mybatis的属性配置，源码如下：</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>    prefix <span class="token operator">=</span> <span class="token string">"mybatis"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisProperties</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String MYBATIS_PREFIX <span class="token operator">=</span> <span class="token string">"mybatis"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String configLocation<span class="token punctuation">;</span>    <span class="token keyword">private</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> mapperLocations<span class="token punctuation">;</span>    <span class="token keyword">private</span> String typeAliasesPackage<span class="token punctuation">;</span>    <span class="token keyword">private</span> String typeHandlersPackage<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> checkConfigLocation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> ExecutorType executorType<span class="token punctuation">;</span>    <span class="token keyword">private</span> Properties configurationProperties<span class="token punctuation">;</span>    <span class="token annotation punctuation">@NestedConfigurationProperty</span>    <span class="token keyword">private</span> Configuration configuration<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//</span>    <span class="token punctuation">}</span></code></pre><p>这里只贴出了属性，省略了方法。其中configLocation就是配置xml文件的扫描路径，从这个类的私有属性也可以看出在 application.yml 可以配置哪些属性。接下来看一下另一个核心类的实现，MybatisAutoConfiguration。这个类中做了很多事情，主要是在Spring Boot启动时对Mybatis的初始化。下面是这个类的部分源码</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>SqlSessionFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> SqlSessionFactoryBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span>DataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span>MybatisProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>DataSourceAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisAutoConfiguration</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//.....</span>    <span class="token punctuation">}</span></code></pre><p>这里省略了类中的全部代码，先来看一下这个类在注入前做了什么事情。其中 Configuration 注解不用多说了吧。然后就是ConditionalOnClass注解。这个注解很少见，下面总结了一些类似注解的作用，这些注解在平常使用几乎很少，但在Spring Boot的源码中却很常见。</p><table><thead><tr><th>注解</th><th>作用</th></tr></thead><tbody><tr><td>@ConditionalOnBean</td><td>仅当前上下文中存在配置的对象Bean时，才会加载当前类</td></tr><tr><td>@ConditionalOnMissingBean</td><td>与前一个注解作用相反，仅当不存在配置的对象时，才会加载当前类</td></tr><tr><td>@ConditionalOnClass</td><td>仅当在 classpath 中存在指定类，才创建某个Bean</td></tr><tr><td>@ConditionalOnExpression</td><td>当表达式为true的时候，才会实例化一个Bean</td></tr><tr><td>@AutoConfigureAfter</td><td>在加载配置的类之后再加载当前类</td></tr><tr><td>@Import</td><td>功能类似XML配置的，用来导入配置类，可以导入带有@Configuration注解的配置类或实现了ImportSelector/ImportBeanDefinitionRegistrar，或者导入普通的POJO（Spring会将其注册成Spring Bean，导入POJO需要使用Spring 4.2以上）</td></tr></tbody></table><p>到这里可以看出在MybatisAutoConfiguration加载之前，会先加载 DataSource，DataSourceAutoConfiguration等类。</p><h2 id="Mapper加载"><a href="#Mapper加载" class="headerlink" title="Mapper加载"></a>Mapper加载</h2><p>前面说了那么多都是铺垫，到了加载MybatisAutoConfiguration类才真正开始。在MybatisAutoConfiguration类中，最为重要的方法就是加载Mapper的方法，源码如下</p><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Configuration</span>    <span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span>MybatisAutoConfiguration<span class="token punctuation">.</span>AutoConfiguredMapperScannerRegistrar<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span>MapperFactoryBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MapperScannerRegistrarNotFoundConfiguration</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token function">MapperScannerRegistrarNotFoundConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@PostConstruct</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            MybatisAutoConfiguration<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"No {} found."</span><span class="token punctuation">,</span> MapperFactoryBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>在这个方法上有个@Import注解，表示在这个方法加载之前会先导入AutoConfiguredMapperScannerRegistrar实例。而AutoConfiguredMapperScannerRegistrar是MybatisAutoConfiguration的一个静态内部类，并且实现了ImportBeanDefinitionRegistrar接口。ImportBeanDefinitionRegistrar的作用是手动注入bean到容器中，再通过@Import注解导入实现了ImportBeanDefinitionRegistrar接口的类，并会执行registerBeanDefinitions方法。下面是Mapper注册类的源码实现</p><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AutoConfiguredMapperScannerRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">,</span> ImportBeanDefinitionRegistrar<span class="token punctuation">,</span> ResourceLoaderAware <span class="token punctuation">{</span>        <span class="token keyword">private</span> BeanFactory beanFactory<span class="token punctuation">;</span>        <span class="token keyword">private</span> ResourceLoader resourceLoader<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">AutoConfiguredMapperScannerRegistrar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>AnnotationMetadata importingClassMetadata<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>            MybatisAutoConfiguration<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Searching for mappers annotated with @Mapper"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 扫描所有注解了@Mapper的接口。</span>            ClassPathMapperScanner scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathMapperScanner</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    scanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                List<span class="token operator">&lt;</span>String<span class="token operator">></span> packages <span class="token operator">=</span> AutoConfigurationPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>MybatisAutoConfiguration<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Iterator var5 <span class="token operator">=</span> packages<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        String pkg <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        MybatisAutoConfiguration<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Using auto-configuration base package '{}'"</span><span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                scanner<span class="token punctuation">.</span><span class="token function">setAnnotationClass</span><span class="token punctuation">(</span>Mapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                scanner<span class="token punctuation">.</span><span class="token function">registerFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                scanner<span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>packages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> var7<span class="token punctuation">)</span> <span class="token punctuation">{</span>                MybatisAutoConfiguration<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Could not determine auto-configuration package, automatic mapper scanning disabled."</span><span class="token punctuation">,</span> var7<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanFactory</span><span class="token punctuation">(</span>BeanFactory beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span>ResourceLoader resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>这个方法中核心代码在于第30行的scanner.doScan(StringUtils.toStringArray(packages));。这行代码就是扫描真正Mapper类，并为每个Mappper类生成了代理类，继续看doScan方法。</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Set<span class="token operator">&lt;</span>BeanDefinitionHolder<span class="token operator">></span> <span class="token function">doScan</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Set<span class="token operator">&lt;</span>BeanDefinitionHolder<span class="token operator">></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No MyBatis mapper was found in '"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' package. Please check your configuration."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>这个方法的第一行的super.doScan(basePackages);就是获取Mapper接口了，了解Spring初始化Bean过程的人可能都知道，Spring首先会将需要初始化的所有class先通过BeanDefinitionRegistry进行注册，并且将该Bean的一些属性信息(如scope、className、beanName等)保存至BeanDefinitionHolder中；Mybatis这里首先会调用Spring中的ClassPathBeanDefinitionScanner.doScan方法，将所有Mapper接口的class注册至BeanDefinitionHolder实例中，然后返回一个Set集合，其它包含了所有搜索到的Mapper class BeanDefinitionHolder对象。接下来就是一个非空判断，然后就会进入processBeanDefinitions方法。</p><pre class=" language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>BeanDefinitionHolder<span class="token operator">></span> beanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Iterator var3 <span class="token operator">=</span> beanDefinitions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>var3<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            BeanDefinitionHolder holder <span class="token operator">=</span> <span class="token punctuation">(</span>BeanDefinitionHolder<span class="token punctuation">)</span>var3<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            GenericBeanDefinition definition <span class="token operator">=</span> <span class="token punctuation">(</span>GenericBeanDefinition<span class="token punctuation">)</span>holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating MapperFactoryBean with name '"</span> <span class="token operator">+</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' mapperInterface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            definition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addGenericArgumentValue</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            definition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperFactoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"addToConfig"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ...</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>此方法比较冗长，源码–。其中核心的代码是definition.setBeanClass(this.mapperFactoryBean.getClass());当看MapperFactoryBean的classname就知道它是一个专门用于创建 Mapper 实例Bean的工厂。这个工厂作用可就大了。例如当在以Service层中，需要注入 UserMapper接口实例时，由于mybatis给所有的Mapper 实例注册都是一个MapperFactory的工厂，所以产生UserMapper实际上是 MapperFactoryBean来进行创建的。接下来看看 MapperFactoryBean的处理过程。</p><h4 id="MapperFactoryBean"><a href="#MapperFactoryBean" class="headerlink" title="MapperFactoryBean"></a>MapperFactoryBean</h4><p>一个FactoryBean，负责创建对应映射接口的实现类对象，这个实现类负责完成映射接口的方法和XML定义的SQL语句的映射关系。Mybatis通过SqlSession接口执行SQL语句，所以MapperFactoryBean会在初始化时通过持有的SqlSessionFactory对象创建一个SqlSessionTemplate（它实现了SqlSession）对象。这个SqlSessionTemplate是mybatis-spring的核心，它比常规的SqlSession赋予了更多的功能。在MapperFactoryBean类中是通过 getObject 方法获取Mapper实例，源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperFactoryBean</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">SqlSessionDaoSupport</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Class<span class="token operator">&lt;</span>T<span class="token operator">></span> mapperInterface<span class="token punctuation">;</span>     <span class="token keyword">public</span> <span class="token function">MapperFactoryBean</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> mapperInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">=</span> mapperInterface<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">,</span> <span class="token string">"Property 'mapperInterface' is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Configuration configuration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error while adding the mapper '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">+</span> <span class="token string">"' to configuration."</span><span class="token punctuation">,</span> var6<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                ErrorContext<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> T <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>其中 mapperInterface 代表的就是Mapper接口的类。在getObject方法中 this.getSqlSession()方法返回SqlSession接口，而在此类中是SqlSessionTemplate类，继续看SqlSessionTemplate类中的getMapper方法</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">getMapper</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>继续刨根问底，看这个方法中的getMapper方法</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">getMapper</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">,</span> SqlSession sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperRegistry<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> sqlSession<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>其中 mapperRegistry保存着当前所有的 mapperInterface class。那么它在什么时候将 mapperinterface class 保存进入的呢？其实就是在上面的 MapperFactoryBean类中checkDaoConfig方法通过 configuration.addMapper(this.mapperInterface) 添加进入的。再继续看getMapper方法的实现。</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">getMapper</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">,</span> SqlSession sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MapperProxyFactory<span class="token operator">&lt;</span>T<span class="token operator">></span> mapperProxyFactory <span class="token operator">=</span> <span class="token punctuation">(</span>MapperProxyFactory<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>knownMappers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperProxyFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Type "</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">" is not known to the MapperRegistry."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> mapperProxyFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Error getting mapper instance. Cause: "</span> <span class="token operator">+</span> var5<span class="token punctuation">,</span> var5<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>转了这么多getMapper方法，终于到了最核心的部分。可以看到这个方法最终返回的是一个代理对象。核心方法是mapperProxyFactory.newInstance(sqlSession)。继续看newInstance方法。</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> T <span class="token function">newInstance</span><span class="token punctuation">(</span>SqlSession sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MapperProxy<span class="token operator">&lt;</span>T<span class="token operator">></span> mapperProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxy</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methodCache<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>至此，基本Mybatis已经完成了Mapper实例的整个创建过程，也就是你在具体使用 UserMapper.getUser 时，它实际上调用的是 MapperProxy，因为此时 所返回的 MapperProxy是实现了 UserMapper接口的。只不过 MapperProxy拦截了所有对userMapper中方法的调用。</p><h4 id="MapperProxy类"><a href="#MapperProxy类" class="headerlink" title="MapperProxy类"></a>MapperProxy类</h4><p>继续深挖MapperProxy类，他实现了InvocationHandler接口，因此调用它时会执行invoke方法，invoke方法源码如下</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDefaultMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invokeDefaultMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> ExceptionUtil<span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>var5<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        MapperMethod mapperMethod <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cachedMapperMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> mapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>第一个判断是对Object方法的判断，如果是调用Object中的方法，则直接调用被代理对象的方法。核心的代码是mapperMethod.execute(this.sqlSession, args);此方法是真正执行sql的地方，其中sqlSession是数据库的会话，args是调用dao接口时的参数。继续看execute方法</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">execute</span><span class="token punctuation">(</span>SqlSession sqlSession<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object param<span class="token punctuation">;</span>        Object result<span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> INSERT<span class="token operator">:</span>            param <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> UPDATE<span class="token operator">:</span>            param <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> DELETE<span class="token operator">:</span>            param <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> SELECT<span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">hasResultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeWithResultHandler</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>                result <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">returnsMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeForMany</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">returnsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeForMap</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">returnsCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeForCursor</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                param <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>                result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> FLUSH<span class="token operator">:</span>            result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Unknown execution method for: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Mapper method '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" attempted to return null from a method with a primitive return type ("</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>到这就已经到了对数据库的操作了。对于Mybatis的总结，我们编写的dao层接口就对应了数据库的操作。Mybatis会为dao层的所有Mapper类生成代理对象，因此实际在调用Mapper接口的方法时，调用的是代理对象的方法。这个代理对象接管了Mapper的方法到xml中的SQL映射。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊对ThreadLocal的理解</title>
      <link href="/2019/06/22/liao-liao-dui-threadlocal-de-li-jie/"/>
      <url>/2019/06/22/liao-liao-dui-threadlocal-de-li-jie/</url>
      
        <content type="html"><![CDATA[<p>JDK 1.2的版本中就提供java.lang.ThreadLocal，ThreadLocal为解决多线程程序的并发问题提供了一种新的思路。使用这个工具类可以很简洁地编写出优美的多线程程序。也是面试中出现频率比较高的知识点。ThreadLocal望文生义即表示的是一个线程中的局部变量，对比我们自己编写业务类中的私有变量，在对象实例化后，类的私有属性就是实例对象的局部变量，在实例对象的整个生命周期都可以随时获取这些私有变量。那么ThreadLocal和我们自己编写业务类的私有变量有什么本质区别吗？实际上没有区别，ThreadLocal的中存储的线程局部变量，最终也是Thread类中的一个局部变量（类似于Map的数据结构），生命周期和Thread实例一样。只不过JDK通过ThreadLocal做了一层封装，并对外提供了更简便的API。下面就来看看ThreadLocal的实现原理，它到底是做了什么事情。</p><p><img src="/2019/06/22/liao-liao-dui-threadlocal-de-li-jie/threadlocal.jpg" alt></p><a id="more"></a> <h2 id="ThreadLocal的应用"><a href="#ThreadLocal的应用" class="headerlink" title="ThreadLocal的应用"></a>ThreadLocal的应用</h2><p>ThreadLocal是一个本地线程副本变量工具类。主要用于将私有线程和该线程存放的副本对象做一个映射，各个线程之间的变量互不干扰，在高并发场景下，可以实现无状态的调用，特别适用于各个线程依赖不通的变量值完成操作的场景。因此，ThreadLocal 不是用来解决共享对象的多线程访问问题的，一般情况下，通过ThreadLocal.set() 到线程中的对象是该线程自己使用的对象，其他线程是不需要访问的，也是访问不到的。通过ThreadLocal.set()保存到当前线程实例的ThreadLocalMap对象中，ThreadLocal实例是作为map的key来使用的。 下面来看一个hibernate中典型的ThreadLocal的应用： </p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal threadSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> Session <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InfrastructureException <span class="token punctuation">{</span>      Session s <span class="token operator">=</span> <span class="token punctuation">(</span>Session<span class="token punctuation">)</span> threadSession<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              s <span class="token operator">=</span> <span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              threadSession<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HibernateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InfrastructureException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> s<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  </code></pre><p>由于在数据库操作中，很多地方会用到Session会话，而且操作都是在同一个线程中。所以hibernate把Session存入到ThreadLocal中，以便在其他方法获取Session实例时，直接通过ThreadLocal获取。这里如果不用ThreadLocal方式，该怎么做呢？最直接的方式，就是把需要用到Session对象的方法多加一个Session类型的入参。但这个种方式很麻烦，而且还有一个不好的地方。因为框架封装了数据库的缘故，我们编写的dao层代码是通过AOP嵌入到hibernate中执行的，因此我们编写dao层的代码就可能需要加上Session参数而我们又完全用不上这个参数，这会让开发者感到莫名其妙。hibernate利用ThreadLocal得到了一个很完美的设计思路。不仅仅是hibernate，在其他许多框架中都可以看到ThreadLocal的身影</p><h2 id="ThreadLocal的原理"><a href="#ThreadLocal的原理" class="headerlink" title="ThreadLocal的原理"></a>ThreadLocal的原理</h2><p>话不多说了吧，直接上源码，主要来看一下ThreadLocal的get和set方法，这两个方法是最常用的</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Returns the value in the current thread's copy of this     * thread-local variable.  If the variable has no value for the     * current thread, it is first initialized to the value returned     * by an invocation of the {@link #initialValue} method.     *     * @return the current thread's value of this thread-local     */</span>    <span class="token keyword">public</span> T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            ThreadLocalMap<span class="token punctuation">.</span>Entry e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>                T result <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">return</span> result<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Sets the current thread's copy of this thread-local variable     * to the specified value.  Most subclasses will have no need to     * override this method, relying solely on the {@link #initialValue}     * method to set the values of thread-locals.     *     * @param value the value to be stored in the current thread's copy of     *        this thread-local.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>其中set方法中又通过getMap方法获取数据，返回的是一个ThreadLocalMap，我们看一下getMap的实现</p><pre class=" language-java"><code class="language-java">    ThreadLocalMap <span class="token function">getMap</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>在getMap方法中，通过Thread对象直接获取了threadLocals属性，再来看一下Thread类中的threadLocals属性</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/* ThreadLocal values pertaining to this thread. This map is maintained     * by the ThreadLocal class. */</span>    ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap threadLocals <span class="token operator">=</span> null<span class="token punctuation">;</span></code></pre><p>注意threadLocals没有关键字修饰，表示它是default的，表示该属性只允许在同一个包中进行访问。到这里就明白了，在每个Thread线程被创建的时候，线程对象本身就包含一个ThreadLocalMap类型的属性，用来存储线程局部变量。我们再来看一看ThreadLocalMap是个什么数据结构，其实看名字也能知道它是个Map。但它和HashMap有一点区别，就是对于哈希冲突的处理方式。ThreadLocalMap实现更简单轻巧，但不适合存储大量的数据。后面会再详细说这一点。下面是运行时ThreadLocal的数据结构图</p><p><img src="/2019/06/22/liao-liao-dui-threadlocal-de-li-jie/thradLocal.png" alt></p><p>线程运行时，内部保存着一个Map的数据结构，而Map的Key是固定的ThreadLocal类型，值就是存储我们自己想存储的数据，图中用Object类型表示。也就是说 ThreadLocal本身并不存储值，它只是作为一个 key来让线程从 ThreadLocalMap获取 value。看明白了这个图，就明白了ThreadLocal的工作原理了。</p><h2 id="哈希冲突"><a href="#哈希冲突" class="headerlink" title="哈希冲突"></a>哈希冲突</h2><p>前面说过ThreadLocalMap实现方式简单，不适合存储大量的数据，那么ThreadLocalMap是怎么实现的呢，它是怎么解决哈希冲突的。这就是需要深入看一下set方法的源码</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**         * Set the value associated with key.         *         * @param key the thread local object         * @param value the value to be set         */</span>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// We don't use a fast path as with get() because it is at</span>            <span class="token comment" spellcheck="true">// least as common to use set() to create new entries as</span>            <span class="token comment" spellcheck="true">// it is to replace existing ones, in which case, a fast</span>            <span class="token comment" spellcheck="true">// path would fail more often than not.</span>            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>            <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                 e <span class="token operator">!=</span> null<span class="token punctuation">;</span>                 e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">>=</span> threshold<span class="token punctuation">)</span>                <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>到这里看着和HashMap类似，也定义了一个Entry数组。首先通过当前key的哈希码和数组长度，计算出当前key应该存储在数组中的下标位置，继续看下面for循环，这个逻辑很简单，从数组中获取刚刚算出的下标位置的元素，如果为空就直接把key和value存储进去，如果不为空就出现哈希碰撞了，它是如何解决的。重点在于nextIndex方法。继续看nextIndex方法的源码。</p><pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**         * Increment i modulo len.         */</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>是不是很震惊，这个方法竟然如此的简单。就是把下标往后移一位，然后返回，再继续刚刚的循环。由此可见，ThreadLocalMap处理哈希碰撞的方式就是把下标往后移一位。直到能放进去为止。这也是它为什么不适合存储大量数据的原因，数据一多出现哈希碰撞的概率就大，如果出现大量的哈希碰撞，那么数组就会特别长。同样在get方法的时候，会先根据key计算出下标，再比较key是否相等。如果不相等就从计算出的下标开始往后遍历数组。源码如下</p><pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**         * Get the entry associated with key.  This method         * itself handles only the fast path: a direct hit of existing         * key. It otherwise relays to getEntryAfterMiss.  This is         * designed to maximize performance for direct hits, in part         * by making this method readily inlinable.         *         * @param  key the thread local object         * @return the entry associated with key, or null if no such         */</span>        <span class="token keyword">private</span> Entry <span class="token function">getEntry</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Entry e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>                <span class="token keyword">return</span> e<span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/**         * Version of getEntry method for use when key is not found in         * its direct hash slot.         *         * @param  key the thread local object         * @param  i the table index for key's hash code         * @param  e the entry at table[i]         * @return the entry associated with key, or null if no such         */</span>        <span class="token keyword">private</span> Entry <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> Entry e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span>                    <span class="token keyword">return</span> e<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null<span class="token punctuation">)</span>                    <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                    i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>                e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>getEntry就是从数组中获取Entry实例，当出现key不相等时会进入else，也就是getEntryAfterMiss方法。从这个方法可以看出，出现哈希碰撞就会遍历数组了。如果看过HashMap源码的朋友，看这个代码应该不在话下，逻辑非常简单明了。</p><h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><p>ThreadLocal会出现内存泄漏，其原因出现在Entry中的Key是一个弱引用。源码如下</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * The entries in this hash map extend WeakReference, using         * its main ref field as the key (which is always a         * ThreadLocal object).  Note that null keys (i.e. entry.get()         * == null) mean that the key is no longer referenced, so the         * entry can be expunged from table.  Such entries are referred to         * as "stale entries" in the code that follows.         */</span>        <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">/** The value associated with this ThreadLocal. */</span>            Object value<span class="token punctuation">;</span>            <span class="token function">Entry</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k<span class="token punctuation">,</span> Object v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>                value <span class="token operator">=</span> v<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>   <span class="token punctuation">}</span></code></pre><p>这里省略了一些无关代码，Entry是ThreadLocalMap的静态内部类。从代码中可以看出Entry的Key是WeakReference包装的，是一个弱引用类型。什么是弱引用，在Java中有4中引用：强引用，弱引用， 虚引用， 软引用。这里只说弱引用，我们平时写代码基本使用的都是强引用。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 强引用</span>String str <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 弱引用</span>WeakReference<span class="token operator">&lt;</span>String<span class="token operator">></span> weak <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 主动触发GC</span>System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发现了<strong>只具有弱引用</strong>的对象，不管当前内存空间足够与否，都会回收它的内存。因此一个对象如果只有弱引用，那么它能存活到下一次GC之前。在ThreadLocalMap的设计中，Key使用的是弱引用，那么在运行时，引用链如下：</p><p><img src="/2019/06/22/liao-liao-dui-threadlocal-de-li-jie/threadLocal2.png" alt></p><p>ThreadLocalMap使用ThreadLocal的弱引用作为key，如果一个ThreadLocal没有外部强引用来引用它，那么系统 GC 的时候，这个ThreadLocal势必会被回收，这样一来，ThreadLocalMap中就会出现key为null的Entry，就没有办法访问这些key为null的Entry的value，如果当前线程再迟迟不结束的话，这些key为null的Entry的value就会一直存在一条强引用链：Thread Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value永远无法回收，造成内存泄漏。其实，ThreadLocalMap的设计中已经考虑到这种情况，也加上了一些防护措施：在ThreadLocal的get(),set(),remove()的时候都会清除线程ThreadLocalMap里所有key为null的value，当然这只是一种防护措施，JDK建议将ThreadLocal变量定义成private static的，这样的话ThreadLocal的生命周期就更长，由于一直存在ThreadLocal的强引用，所以ThreadLocal也就不会被回收，也就能保证任何时候都能根据ThreadLocal的弱引用访问到Entry的value值，然后remove它，防止内存泄露。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入Java线程池实现源码</title>
      <link href="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/"/>
      <url>/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/</url>
      
        <content type="html"><![CDATA[<p>Java线程池是使用频率很高的开源框架。也是在面试中常被问到的组件。它的实现源码在J.U.C包下，本人也经常使用线程池，简单方便。大多是浮于表面的一些API的调用，对于框架实现中具体做了哪些事情，却是知之甚少。本文将从源码角度，深入了聊一聊Java线程池的源码实现中到底做了什么事情。Java线程池的源码编写者也是大名鼎鼎的 Doug Lea 。这老爷子对Java并发编程的贡献相当大，说他是这个世界上对Java影响力最大的一个人，一点也不为过。因为两次Java历史上的大变革，他都间接或直接的扮演了举足轻重的角色。2004年所推出的Tiger。Tiger广纳了15项JSRs(Java Specification Requests)的语法及标准，其中一项便是JSR-166。JSR-166是来自于Doug编写的util.concurrent包。所以看J.U.C包下的源码，也是理解老爷子对于并发编程的思维方式的最好材料。</p><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/poll.jpg" alt></p><a id="more"></a> <h2 id="为什么使用线程池"><a href="#为什么使用线程池" class="headerlink" title="为什么使用线程池"></a>为什么使用线程池</h2><p>在Java开发过程中，总是不可避免的要使用各种池，比如线程池，连接池，缓存池等等。那么既然可以使用原生的方式实现功能，为什么还要使用池呢？其实虽然池管理的对象不一样，但原因大同小异。对于线程池来说，线程是稀缺资源，如果被无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，合理的使用线程池对线程进行统一分配、调优和监控，有以下好处：</p><ol><li>降低资源消耗。对于任何在池中的对象而言，肯定是使用频率比较高，而且创建的代价比较昂贵。如果频繁的被创建和销毁，就会过多的消耗系统资源，降低了服务的性能。</li><li>提高响应速度。正因为创建的代价高，比较消耗资源，因此在需要对象的时候直接去线程池中获取就行了，不需要等待创建线程，提高了响应速度</li><li>提高线程的可管理性。连接池可帮我们做一些公共的事情，比如想让线程被阻塞时间过长后返回，想知道当前线程的状态。回收一些长期空闲的线程等</li></ol><p>在Java1.5中引入的Executor框架把任务的提交和执行进行解耦，只需要定义好任务，然后提交给线程池，而不用关心该任务是如何执行、被哪个线程执行，以及什么时候执行。在深入源码之前先来看看Executor框架线程池的类图：</p><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/calss.png" alt></p><p>它们的最顶层是一个Executor接口，它只有一个方法：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Runnable command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="线程池状态"><a href="#线程池状态" class="headerlink" title="线程池状态"></a>线程池状态</h2><p>ExecutorService扩展了Executor，添加了操控线程池生命周期的方法，如shutDown()，shutDownNow()等，以及扩展了可异步跟踪执行任务生成返回值Future的方法，如submit()等方法。ThreadPoolExecutor继承自AbstractExecutorService，同时实现了ExecutorService接口，也是Executor框架默认的线程池实现类，也是这篇文章重点分析的对象，一般我们使用线程池，如没有特殊要求，直接创建ThreadPoolExecutor，初始化一个线程池，如果需要特殊的线程池，则直接继承ThreadPoolExecutor，并实现特定的功能，如ScheduledThreadPoolExecutor，它是一个具有定时执行任务的线程池。Executor框架中创建线程池非常简单，使用线程池提交线程也很简单。代码如下</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 创建线程池</span>ExecutorService executeService <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 提交线程</span>executeService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>executeService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>executeService<span class="token punctuation">.</span><span class="token function">invokeAll</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>submit，execute，invokeAll都可以提交线程。其中invokeAll可以批量提交线程，并提供了返回值。而这三个方法最终都会执行顶层接口中的execute方法。因此直接看execute方法的实现。该方法的实现在ThreadPoolExecutor类中，在看该方法的实现之前需要先了解一些线程池的是属性信息，因为在提交线程到线程池时，都围绕着这些属性的改变。</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> AtomicInteger ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> Integer<span class="token punctuation">.</span>SIZE <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CAPACITY   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// runState is stored in the high-order bits</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RUNNING    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHUTDOWN   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STOP       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TIDYING    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TERMINATED <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Packing and unpacking ctl</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>     <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token operator">~</span>CAPACITY<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> CAPACITY<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rs <span class="token operator">|</span> wc<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><p>从代码中可以看到，线程池一共有状态5种状态，分别是：</p><ol><li><strong>RUNNING：</strong>线程池初始化时默认的状态，表示线程池正处于运行状态，能够接受新提交的任务，同时也能够处理阻塞队列中的任务</li><li><strong>SHUTDOWN：</strong>调用shutdown()方法会使线程池进入到该状态，该状态下不再继续接受新提交的任务，但是还会处理阻塞队列中的任务</li><li><strong>STOP：</strong>调用shutdownNow()方法会使线程池进入到该状态，该状态下不再继续接受新提交的任务，同时不再处理阻塞队列中的任务</li><li><strong>TIDYING：</strong>如果线程池中workerCount=0，即有效线程数量为0时，会进入该状态</li><li><strong>TERMINATED：</strong>在terminated()方法执行完后进入该状态，只不过terminated()方法需要我们自行实现。</li></ol><p>这些状态均由int型表示，大小关系为 RUNNING&lt;SHUTDOWN&lt;STOP&lt;TIDYING&lt;TERMINATED，这个顺序基本上也是遵循线程池从 运行 到 终止这个过程。此外下面还有三个方法用于获取线程池当前的状态，有效线程数等。其中CAPACITY经过(1 &lt;&lt; COUNT_BITS) - 1运算后得到的是一个高3位是0，低29位是1的整数。</p><ol><li><strong>runStateOf(int c)：</strong> CAPACITY取反码，即高3位是1，低29位是0。c &amp; ~CAPACITY用于获取高3位保存的线程池状态。</li><li><strong>workerCountOf(int c)：</strong>运算 c &amp; CAPACITY，用于获取c变量低29位的值，也就是获取线程池中的有效线程数。</li><li><strong>ctlOf(int rs, int wc)：</strong>参数rs表示runState，参数wc表示workerCount，即根据runState和workerCount打包合并成ctl。</li></ol><p>仔细思考的朋友肯定会有疑问，我刚看的时候也非常困惑。Doug Lea大神为什么要用一个int变量的高3位表示线程池状态，低29位表示线程池当前的有效线程数，为什么不使用两个变量分别表示。有人会觉得是为了节省了存储空间，但是这里很显然不是为了节省空间而设计的，两个变量也就多4个字节而已。为了这4个字节而去大费周章地设计一通，不但麻烦而且增加了代码复杂度。从上面关于线程状态的解释可以看出，线程状态的转变很大程度上决定于线程池中的有效线程数，在多线程运行环境下，线程池中的线程数量和线程池状态往往是动态改变的，并且运行状态和有效线程数量需要保证统一，不能出现一个改而另一个没有改的情况。因此把他们放到一个变量中，用一个变量表示两个值，那么在修改的时候只需要修改一次，就统一了两个值的修改，同时该值又是AtomicInteger类型，保证了多线程下修改它的值是一个原子操作。试想一下，如果使用两个值会是什么情况，首先要保证两个值各自的修改是原子操作，因此必须将两个变量设置为原子类AtomicInteger类型，同时又得保证两个值的修改是统一的同步的，所以得把两个值的修改操作放到一个方法中并使用synchronize关键字修饰该方法保证同步，这样做就能实现源码中用一个类表示两个值的最终效果，但是性能消耗就大大增加了，因为synchronize是一把重量级锁，虽然JDK对它做了优化，但是在竞争激烈的情况下synchronize还是会升级为重量级锁，当然也可以使用Lock锁，但肯定也不会比一个int类型数据的修改性能消耗低。分析完这一波，是不是更加佩服老爷子的神操作了。</p><h2 id="线程池运行过程"><a href="#线程池运行过程" class="headerlink" title="线程池运行过程"></a>线程池运行过程</h2><h3 id="execute-–-提交任务"><a href="#execute-–-提交任务" class="headerlink" title="execute()  –  提交任务"></a>execute()  –  提交任务</h3><p>excute方法是提交任务到线程池的核心方法，下面是ThreadPoolExecutor类中关于该方法的源码。源码中的注释也很好的解释了提交任务的逻辑</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Executes the given task sometime in the future.  The task     * may execute in a new thread or in an existing pooled thread.     * 在要执行给定的任务时。这个任务会用一个新线程执行，或者用线程池中的一个线程执行     *     * If the task cannot be submitted for execution, either because this     * executor has been shutdown or because its capacity has been reached,     * the task is handled by the current {@code RejectedExecutionHandler}.     * 如果任务无法被提交执行，要么是因为这个Executor已经被shutdown关闭，     * 要么是已经达到其容量上限，任务会被当前的RejectedExecutionHandler处理     *     * @param command the task to execute     * @throws RejectedExecutionException at discretion of     *         {@code RejectedExecutionHandler}, if the task     *         cannot be accepted for execution     * @throws NullPointerException if {@code command} is null     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> null<span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*         * Proceed in 3 steps:         *         * 1. If fewer than corePoolSize threads are running, try to         * start a new thread with the given command as its first         * task.  The call to addWorker atomically checks runState and         * workerCount, and so prevents false alarms that would add         * threads when it shouldn't, by returning false.         * 如果运行的线程少于corePoolSize，尝试开启一个新线程去运行command，         * command作为这个线程的第一个任务         *         * 2. If a task can be successfully queued, then we still need         * to double-check whether we should have added a thread         * (because existing ones died since last checking) or that         * the pool shut down since entry into this method. So we         * recheck state and if necessary roll back the enqueuing if         * stopped, or start a new thread if there are none.         * 如果任务被成功放入队列，我们仍需要一个双重校验去确认是否应该新建一个线程         *（因为可能存在有些线程在我们上次检查后死了） 或者 从我们进入这个方法后，pool被关闭了         * 所以我们需要再次检查state，如果线程池停止了需要回滚入队列，如果池中没有线程了，新开启 一个线程         *         * 3. If we cannot queue task, then we try to add a new         * thread.  If it fails, we know we are shut down or saturated         * and so reject the task.         * 如果无法将任务入队列（可能队列满了），需要添加一个新线程（线程池扩容：往maxPoolSize发展）         * 如果失败了，说明线程池shutdown 或者 饱和了，所以我们拒绝任务         */</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/**       * 1、如果当前线程数少于corePoolSize，则添加任务       */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/**         * 没有成功addWorker()，再次获取c（凡是需要再次用ctl做判断时，都会再次调用ctl.get()）         * 失败的原因可能是：         * 1、线程池已经shutdown，shutdown的线程池不再接收新任务         * 2、workerCountOf(c) &lt; corePoolSize 判断后，由于并发，别的线程先创建了worker线程，导致workerCount>=corePoolSize         */</span>            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/**        * 2、如果线程池RUNNING状态，且入队列成功        * offer方法是往队列中添加任务，队列已满无法添加，返回false        */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 再次获取ctl的值</span>            <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/**         * 再次校验放入workerQueue中的任务是否能被执行         * 1、如果线程池不是运行状态了，应该拒绝添加新任务，从workQueue中删除任务         * 2、如果线程池是运行状态，或者从workQueue中删除任务失败（刚好有一个线程执行完毕，并消耗了这个任务），确保还有线程执行任务（只要有一个就够了）         */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/**          * 如果当前worker数量为0，通过addWorker(null, false)创建一个线程，其任务为null          * 为什么只检查运行的worker数量是否等于0而不和corePoolSize比较呢？          * 因为只保证有一个worker线程可以从queue中获取任务执行就行了          * 因为只要还有活动的worker线程，就可以消费workerQueue中的任务          */</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//第一个参数为null，说明只为新建一个worker线程，没有指定firstTask</span>                <span class="token comment" spellcheck="true">//第二个参数为true代表占用corePoolSize，false占用maxPoolSize</span>                <span class="token function">addWorker</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/**        * 3、如果线程池不是running状态 或者 无法入队列        *   尝试开启新线程，扩容至maxPoolSize，如果addWork(command, false)失败了，拒绝当前command        */</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>单从execute()方法来说，这个方法就干了一件事情，就是添加任务。添加任务分为三种情况，分别对应代码中的三个大 if 条件。下面来说说每种情况的具体条件</p><p><strong>参数：</strong> command  &lt;执行任务的线程，不能为空&gt;</p><p><strong>执行流程：</strong> </p><p><strong>1 . 添加任务到线程池（coreSizePool）：</strong> 第一个 if 判断，当前线程池中的线程数小于corePoolSize，则通过addWorker方法创建新线程，并添加到线程池中。如果添加成功则返回，如果添加失败继续后续步骤。核心线程池中添加失败的原因可能有： </p><ol><li>线程池已经被其他线程shutdown，shutdown的线程池不再接收新任务。</li><li>workerCountOf(c) &lt; corePoolSize 判断通过后，由于并发，别的线程先创建了worker线程，导致workerCount&gt;=corePoolSize</li></ol><p><strong>2 . 添加任务到队列（BlockingQueue）：</strong> 第二个 if 判断，当往核心线程池中添加任务失败，说明线程池中的有效线程池已经等于设置的核心线程数大小。这时继续被添加的任务只能添加到阻塞队列中，等待核心线程池中有线程空闲到队列中取任务执行。往队列中添加任务失败的原因可能有：</p><ol><li>如果线程池已经不是running状态了，应该拒绝添加新任务，从workQueue中删除刚刚添加的任务任务。</li><li>如果线程池是运行状态，或者从workQueue中删除任务失败（刚好核心线程池中有一个线程执行完毕，并消耗了刚添加到队列的这个任务），确保还有线程执行任务（只要有一个就够了）</li></ol><p><strong>3 . 添加任务到线程池（maxSizePool）：</strong> 第三个 if 判断，当核心线程池中添加任务失败，任务队列中添加任务也失败时。会将线程池的线程数扩容到设置的最大线程数。新添加的任务会通过addWorker方法创建新线程，并添加到线程池中，这部分新创建的线程是一些临时工。当任务执行完后会被回收，使线程池的大小最终维持在coreSize。</p><p>execute方法的大致流程就分析完了，下面是它的执行流程图。</p><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/execute.png" alt></p><h3 id="addWorker-–-添加worker线程"><a href="#addWorker-–-添加worker线程" class="headerlink" title="addWorker()  –  添加worker线程"></a>addWorker()  –  添加worker线程</h3><p>此方法的作用是添加任务到线程池，并运行任务。该方法的源码如下</p><pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">/**     * Checks if a new worker can be added with respect to current     * pool state and the given bound (either core or maximum). If so,     * the worker count is adjusted accordingly, and, if possible, a     * new worker is created and started, running firstTask as its     * first task. This method returns false if the pool is stopped or     * eligible to shut down. It also returns false if the thread     * factory fails to create a thread when asked.  If the thread     * creation fails, either due to the thread factory returning     * null, or due to an exception (typically OutOfMemoryError in     * Thread.start()), we roll back cleanly.     * 检查根据当前线程池的状态和给定的边界(core or maximum)是否可以创建一个新的worker     * 如果是这样的话，worker的数量做相应的调整，如果可能的话，创建一个新的worker并启动，     * 参数中的firstTask作为worker的第一个任务     * 如果方法返回false，可能因为pool已经关闭或者调用过了shutdown     * 如果线程工厂创建线程失败，也会失败，返回false     * 如果线程创建失败，要么是因为线程工厂返回null，要么是发生了OutOfMemoryError     *     * @param firstTask the task the new thread should run first (or     * null if none). Workers are created with an initial first task     * (in method execute()) to bypass queuing when there are fewer     * than corePoolSize threads (in which case we always start one),     * or when the queue is full (in which case we must bypass queue).     * Initially idle threads are usually created via     * prestartCoreThread or to replace other dying workers.     *     * @param core if true use corePoolSize as bound, else     * maximumPoolSize. (A boolean indicator is used here rather than a     * value to ensure reads of fresh values after checking other pool     * state).     * @return true if successful     */</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span>Runnable firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">//外层循环，负责判断线程池状态</span>        retry<span class="token operator">:</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Check if queue empty only if necessary.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>                <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>                   firstTask <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span>                   <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//内层循环，负责对worker数量的+1</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">>=</span> CAPACITY <span class="token operator">||</span>                    wc <span class="token operator">>=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">//调用unsafe CAS操作，使得worker数量+1，成功则跳出retry循环</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span> retry<span class="token punctuation">;</span>                c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Re-read ctl</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>                    <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// else CAS failed due to workerCount change; retry inner loop</span>                <span class="token comment" spellcheck="true">// else CAS失败时因为workerCount改变了，继续内层循环尝试CAS对worker数量+1</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//worker数量+1成功的后续操作，添加到workers Set集合，并启动worker线程</span>        <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        Worker w <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> Thread t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>                mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// Recheck while holding lock.</span>                    <span class="token comment" spellcheck="true">// Back out on ThreadFactory failure or if</span>                    <span class="token comment" spellcheck="true">// shut down before lock acquired.</span>                    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> SHUTDOWN <span class="token operator">||</span>                        <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// precheck that t is startable</span>                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">></span> largestPoolSize<span class="token punctuation">)</span>                            largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>                        workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                    mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//如果往HashSet中添加worker成功，启动线程</span>                    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>                <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>当线程池是可添加任务状态的时候，都会执行到addWorker方法。这个方法的功能简单理解就是创建任务线程并执行任务，具体流程逻辑如下</p><p><strong>参数：</strong> firstTask &lt; worker线程的初始任务，可以为null &gt;，core &lt; true：将corePoolSize作为上限，false：将maximumPoolSize作为上限 &gt;</p><p><strong>执行流程：</strong> </p><p><strong>1 . 判断线程池状态：</strong> 判断线程池当前是否为可以添加worker线程的状态，可以则继续下一步，不可以返回 false：</p><ol><li>线程池状态&gt;shutdown，可能为stop、tidying、terminated，不能添加worker线程</li><li>线程池状态==shutdown，firstTask不为空，不能添加worker线程，因为shutdown状态的线程池不接收新任务</li><li>线程池状态==shutdown，firstTask==null，workQueue为空，不能添加worker线程，因为firstTask为空是为了添加一个没有任务的线程再从workQueue获取task，而workQueue为空，说明添加无任务线程已经没有意义</li></ol><p><strong>2 . 判断线程池边界：</strong> 线程池当前线程数量是否超过上限（corePoolSize 或 maximumPoolSize），如果超过了返回false，没超过则对workerCount+1，继续下一步</p><p><strong>3 . 创建并执行任务：</strong> 在ReentrantLock保证下（在操作work set集合largestPoolSize时需要上锁，一个线程池只有一把可重入锁），向线程池中添加新创建的worker实例，并启动worker线程，如果都成功了，返回 true，如果向线程池添加worker实例失败或任务线程启动失败，调用addWorkerFailed()逻辑。</p><p><strong>方法参数：</strong> addWorker有两个参数，对应于4种传参方式。作用分别如下</p><table><thead><tr><th></th><th>在execute方法中就使用了前3种</th></tr></thead><tbody><tr><td>addWorker(command, true)</td><td>线程数小于corePoolSize时，放一个需要处理的task进Workers Set。<br>如果Workers Set长度超过corePoolSize，就返回false</td></tr><tr><td>addWorker(command, false)</td><td>当队列被放满时，就将这个新来的task直接放入Workers Set。<br>此时Workers Set的长度限制是maximumPoolSize。如果线程池也满了的话就返回false</td></tr><tr><td>addWorker(null, false)</td><td>放入一个空的task进workers Set，此时长度限制是maximumPoolSize。<br>这样一个task为空的worker在线程执行的时候会去任务队列里拿任务，<br>这样就相当于创建了一个新的线程，只是没有马上分配任务</td></tr><tr><td>addWorker(null, true)</td><td>此方法就是放一个null的task进Workers Set，而且是在小于corePoolSize时，<br>如果此时Set中的数量已经达到corePoolSize那就返回false，什么也不干。<br>实际使用中是在prestartAllCoreThreads()方法，<br>此方法用来为线程池预先启动corePoolSize个worker等待从队列中获取任务执行</td></tr></tbody></table><p>下面是addWorker方法的流程图</p><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/addwork.png" alt></p><h3 id="内部类Worker"><a href="#内部类Worker" class="headerlink" title="内部类Worker"></a>内部类Worker</h3><p>Worker类本身既实现了Runnable，又继承了AbstractQueuedSynchronizer（以下简称AQS），所以其既是一个可执行的任务，又可以达到锁的效果。前面分析到提交任务时，线程池会把提交的线程封装成Worker实例。任务提交后通过Worker类中的t.start()运行线程。刚看到这里时，就有一个疑问了。执行线程的start方法是直接运行线程了。那么是它怎么保证线程池中的核心线程池数不变的。一切的奥秘就隐藏在Worker类中的run方法了。需要注意的是，执行t.start方法并不会直接运行提交线程的run()方法中的代码，而会运行Worker类中的run方法。因为在Worker实例创建时，通过工程创建了线程，而创建时又将自身作为参数传了进去。下面是内部类Worker类的源码实现</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Class Worker mainly maintains interrupt control state for     * threads running tasks, along with other minor bookkeeping.     * This class opportunistically extends AbstractQueuedSynchronizer     * to simplify acquiring and releasing a lock surrounding each     * task execution.  This protects against interrupts that are     * intended to wake up a worker thread waiting for a task from     * instead interrupting a task being run.  We implement a simple     * non-reentrant mutual exclusion lock rather than use     * ReentrantLock because we do not want worker tasks to be able to     * reacquire the lock when they invoke pool control methods like     * setCorePoolSize.  Additionally, to suppress interrupts until     * the thread actually starts running tasks, we initialize lock     * state to a negative value, and clear it upon start (in     * runWorker).     * Worker类大体上管理着运行线程的中断状态 和 一些指标。     * 此类继承了AQS吗，又实现了Runnable，说明其既是一个可运行的任务，也是一把锁（不可重入）     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>        <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>        <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * This class will never be serialized, but we provide a         * serialVersionUID to suppress a javac warning.         */</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 6138294804551838833L<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Thread this worker is running in.  Null if factory fails. */</span>        <span class="token keyword">final</span> Thread thread<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Initial task to run.  Possibly null. */</span>        Runnable firstTask<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Per-thread task counter */</span>        <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * Creates with given first task and thread from ThreadFactory.         * @param firstTask the first task (null if none)         */</span>        <span class="token function">Worker</span><span class="token punctuation">(</span>Runnable firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">//设置AQS的同步状态private volatile int state，是一个计数器，大于0代表锁已经被获取</span>             <span class="token comment" spellcheck="true">// 在运行runWorker方法之前，不可被中断</span>            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// inhibit interrupts until runWorker</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/** Delegates main run loop to outer runWorker  */</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Lock methods</span>        <span class="token comment" spellcheck="true">//</span>        <span class="token comment" spellcheck="true">// The value 0 represents the unlocked state.</span>        <span class="token comment" spellcheck="true">// The value 1 represents the locked state.</span>        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">void</span> <span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Thread t<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>为什么要把传进来的线程再封装成一个Worker类，为什么不直接执行execute(command)提交的command呢。主要是为了控制中断，用AQS锁，当运行时上锁，就不能中断，TreadPoolExecutor的shutdown()方法中断前都要获取worker锁，只有在等待从workQueue中获取任务getTask()时才能中断，worker实现了一个简单的不可重入的互斥锁，而不是用ReentrantLock可重入锁。</p><p><strong>new Worker()：</strong></p><ol><li>将AQS的state置为-1，在runWoker()前不允许中断</li><li>待执行的任务会以参数传入，并赋予firstTask</li><li>用Worker这个Runnable创建Thread</li></ol><p>之所以Worker自己实现Runnable，并创建Thread，在firstTask外包一层，是因为要通过Worker控制中断，而firstTask这个工作任务只是负责执行业务</p><p><strong>Worker控制中断的几方面：</strong></p><ol><li>初始AQS状态为-1，此时不允许中断interrupt()，只有在worker线程启动了，执行了runWoker()，将state置为0，才能中断，其中不允许中断体现在：(a) . shutdown()线程池时，会对每个worker tryLock()上锁，而Worker类这个AQS的tryAcquire()方法是固定将state从0-&gt;1，故初始状态state==-1时tryLock()失败，没发interrupt()。(b) . shutdownNow()线程池时，不用tryLock()上锁，但调用worker.interruptIfStarted()终止worker，interruptIfStarted()也有state&gt;0才能interrupt的逻辑</li><li>为了防止某种情况下，在运行中的worker被中断，runWorker()每次运行任务时都会lock()上锁，而shutdown()这类可能会终止worker的操作需要先获取worker的锁，这样就防止了中断正在运行的线程</li></ol><p><strong>Worker和firstTask的区别：</strong>Worker是线程池中的线程，而Task虽然是runnable，但是并没有真正执行，只是被Worker调用了run方法，后面会看到这部分的实现。这也是线程池能保证核心线程数的原因（因为线程池并不是直接创建我们提交给线程池任务的线程，而是自己创建线程，用它创建的线程调用我们提交的线程的run()方法。）</p><h3 id="runWorker-–-执行任务"><a href="#runWorker-–-执行任务" class="headerlink" title="runWorker()  –  执行任务"></a>runWorker()  –  执行任务</h3><p>下面是Worker类中run()方法中调用的runWorker()方法</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Main worker run loop.  Repeatedly gets tasks from queue and     * executes them, while coping with a number of issues:     *     * 1. We may start out with an initial task, in which case we     * don't need to get the first one. Otherwise, as long as pool is     * running, we get tasks from getTask. If it returns null then the     * worker exits due to changed pool state or configuration     * parameters.  Other exits result from exception throws in     * external code, in which case completedAbruptly holds, which     * usually leads processWorkerExit to replace this thread.     *      * 1.我们可能使用一个初始化任务开始，即firstTask为null     * 然后只要线程池在运行，我们就从getTask()获取任务     * 如果getTask()返回null，则worker由于改变了线程池状态或参数配置而退出     * 其它退出因为外部代码抛异常了，这会使得completedAbruptly为true，     * 这会导致在processWorkerExit()方法中替换当前线程     *     * 2. Before running any task, the lock is acquired to prevent     * other pool interrupts while the task is executing, and then we     * ensure that unless pool is stopping, this thread does not have     * its interrupt set.     *     * 2. 在任何任务执行之前，都需要对worker加锁去防止在任务运行时，其它任务执行时中断，     * 此外还需确保线程没有中断标记，除非线程池已经停了      *     * 3. Each task run is preceded by a call to beforeExecute, which     * might throw an exception, in which case we cause thread to die     * (breaking loop with completedAbruptly true) without processing     * the task.     *      * 3. 每个任务执行前会调用beforeExecute()，其中可能抛出一个异常，这种情况下会导致线程死亡     *（跳出循环，且completedAbruptly==true），没有执行任务     * 因为beforeExecute()的异常没有cache住，会上抛，跳出循环     *     * 4. Assuming beforeExecute completes normally, we run the task,     * gathering any of its thrown exceptions to send to afterExecute.     * We separately handle RuntimeException, Error (both of which the     * specs guarantee that we trap) and arbitrary Throwables.     * Because we cannot rethrow Throwables within Runnable.run, we     * wrap them within Errors on the way out (to the thread's     * UncaughtExceptionHandler).  Any thrown exception also     * conservatively causes thread to die.     *      * 4. 假定beforeExecute()正常完成，我们执行任务     * 汇总任何抛出的异常并发送给afterExecute(task, thrown)     * 因为我们不能在Runnable.run()方法中重新上抛Throwables，     * 我们将Throwables包装到Errors上抛（会到线程的UncaughtExceptionHandler去处理）     * 任何上抛的异常都会导致线程死亡     *     * 5. After task.run completes, we call afterExecute, which may     * also throw an exception, which will also cause thread to     * die. According to JLS Sec 14.20, this exception is the one that     * will be in effect even if task.run throws.     *     * 5 .任务执行结束后，调用afterExecute()，也可能抛异常，也会导致线程die     * 根据JLS Sec 14.20，这个异常（finally中的异常）会生效     *     * The net effect of the exception mechanics is that afterExecute     * and the thread's UncaughtExceptionHandler have as accurate     * information as we can provide about any problems encountered by     * user code.     *     * @param w the worker     */</span>    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span>Worker w<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Runnable task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>        w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> null<span class="token punctuation">;</span>        w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// allow interrupts</span>        <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// If pool is stopping, ensure thread is interrupted;</span>                <span class="token comment" spellcheck="true">// if not, ensure thread is not interrupted.  This</span>                <span class="token comment" spellcheck="true">// requires a recheck in second case to deal with</span>                <span class="token comment" spellcheck="true">// shutdownNow race while clearing interrupt</span>                <span class="token comment" spellcheck="true">// 确保只有在线程stoping时，才会被设置中断标示，否则清除中断标示</span>                <span class="token comment" spellcheck="true">// 1、如果线程池状态>=stop，且当前线程没有设置中断状态，wt.interrupt()</span>                <span class="token comment" spellcheck="true">// 2、如果一开始判断线程池状态&lt;stop，但Thread.interrupted()为true，即线程已经被中断，又清除了中断标示，再次判断线程池状态是否>=stop</span>                <span class="token comment" spellcheck="true">// 是，再次设置中断标示，wt.interrupt()</span>                <span class="token comment" spellcheck="true">//  否，不做操作，清除中断标示后进行后续步骤</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span>                     <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                      <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>                    Throwable thrown <span class="token operator">=</span> null<span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                        <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                    task <span class="token operator">=</span> null<span class="token punctuation">;</span>                    w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>                    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p><strong>runWorker(Worker w)执行流程：</strong></p><ol><li>执行任务之前，首先worker.unlock()，将AQS的state置为0，允许中断当前worker线程</li><li>开始执行firstTask，调用task.run()，在执行任务前会上锁wroker.lock()，在执行完任务后会解锁，为了防止在任务运行时被线程池一些中断操作中断</li><li>在任务执行前后，可以根据业务场景自定义beforeExecute() 和 afterExecute()方法</li><li>无论在beforeExecute()、task.run()、afterExecute()发生异常上抛，都会导致worker线程终止，进入processWorkerExit()处理worker退出的流程</li><li>如正常执行完当前task后，会通过getTask()从阻塞队列中获取新任务，当队列中没有任务，且获取任务超时，那么当前worker也会进入退出流程</li></ol><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/runWork.png" alt></p><h3 id="getTask-–-获取任务"><a href="#getTask-–-获取任务" class="headerlink" title="getTask()  –  获取任务"></a>getTask()  –  获取任务</h3><p>这个方法也是线程池的很重要的方法，它定义了任务从线程池获取线程的具体逻辑。也是保证线程池中核心线程数量的关键方法。当有效线程数小于corePoolSize时，有阻塞的从队列中获取任务。源码如下</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * Performs blocking or timed wait for a task, depending on     * current configuration settings, or returns null if this worker     * must exit because of any of:     * 1. There are more than maximumPoolSize workers (due to     *    a call to setMaximumPoolSize).     * 2. The pool is stopped.     * 3. The pool is shutdown and the queue is empty.     * 4. This worker timed out waiting for a task, and timed-out     *    workers are subject to termination (that is,     *    {@code allowCoreThreadTimeOut || workerCount > corePoolSize})     *    both before and after the timed wait, and if the queue is     *    non-empty, this worker is not the last thread in the pool.     *     * @return task, or null if the worker must exit, in which case     *         workerCount is decremented     */</span>    <span class="token keyword">private</span> Runnable <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Did the last poll() time out?</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Check if queue empty only if necessary.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> STOP <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Are workers subject to culling?</span>            <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">></span> corePoolSize<span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">/**             * 如果线程数量大于maximumPoolSize（可能maximumPoolSize被修改了）             * 要么既需要计时timed==true，也超时了timedOut==true             * worker数量-1，减一执行一次就行了，然后返回null，在runWorker()中会有逻辑减少worker线程             * 如果本次减一失败，继续内层循环再次尝试减一             */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">></span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Runnable r <span class="token operator">=</span> timed <span class="token operator">?</span>                    <span class="token comment" spellcheck="true">// 大于corePoolSize</span>                    workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">:</span>                       <span class="token comment" spellcheck="true">// 小于等于corePoolSize</span>                    workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 如果获取到了任务就返回</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span>                    <span class="token keyword">return</span> r<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 没有返回，说明超时，那么在下一次内层循环时会进入worker count减一的步骤</span>                timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>                timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p><strong>执行流程：</strong></p><p>1、首先判断是否可以满足从workQueue中获取任务的条件，不满足return null<br>​    A、线程池状态是否满足：<br>​        （1）shutdown状态 + workQueue为空 或 stop状态，都不满足，因为被shutdown后还是要执行workQueue剩余的任务，但workQueue也为空，就可以退出了<br>​        （2）stop状态，shutdownNow()操作会使线程池进入stop，此时不接受新任务，中断正在执行的任务，workQueue中的任务也不执行了，故return null返回<br>​    B、线程数量是否超过maximumPoolSize 或 获取任务是否超时<br>​        （1）线程数量超过maximumPoolSize可能是线程池在运行时被调用了setMaximumPoolSize()被改变了大小，否则已经addWorker()成功不会超过maximumPoolSize<br>​        （2）如果 当前线程数量&gt;corePoolSize，才会检查是否获取任务超时，这也体现了当线程数量达到maximumPoolSize后，如果一直没有新任务，会逐渐终止worker线程直到corePoolSize<br>2、如果满足获取任务条件，根据是否需要定时获取调用不同方法：<br>​    A、workQueue.poll()：如果在keepAliveTime时间内，阻塞队列还是没有任务，返回null<br>​    B、workQueue.take()：如果阻塞队列为空，当前线程会被挂起等待；当队列中有任务加入时，线程被唤醒，take方法返回任务<br>3、在阻塞从workQueue中获取任务时，可以被interrupt()中断，代码中捕获了InterruptedException，重置timedOut为初始值false，再次执行第1步中的判断，满足就继续获取任务，不满足return null，会进入worker退出的流程</p><p><img src="/2019/06/11/shen-ru-java-xian-cheng-chi-shi-xian-yuan-ma/getTask.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java实现Mysql增量同步</title>
      <link href="/2019/06/08/java-shi-xian-mysql-zeng-liang-tong-bu/"/>
      <url>/2019/06/08/java-shi-xian-mysql-zeng-liang-tong-bu/</url>
      
        <content type="html"><![CDATA[<p>最近公司有个基于Mysql做增量数据同步的需求需要我要完成。源端是两个不同业务系统数据库的两张表，需要把这两张表的数据字段做一些过滤和处理，然后增量同步到本地服务的数据库中。由于数据量不大，源端两个表都是几十万的数据，因此当时首先想到的就是通过java定时读取表数据的方式做数据同步，但这种方式太过呆板，而且延迟也比较大。所以目前的思路想通过mysql binlog日志，使mysql中的数据变化实时同步到本地数据库，根据业务需求我只需要监听数据的insert，update，delete这几种event。监听mysql binlog工具有很多，目前大多数使用</p><ul><li><a href="https://github.com/shyiko/mysql-binlog-connector-java" target="_blank" rel="noopener">mysql-binlog-connector-java</a></li><li><a href="https://github.com/alibaba/canal" target="_blank" rel="noopener">阿里巴巴开源组件canal</a> </li></ul><p>canal使用集群方式部署，系统比较臃肿，复杂性也相对较高，可定制性也比较差，所以我没有考虑这种方案，采用了mysql-binlog-connector-java</p><p><img src="/2019/06/08/java-shi-xian-mysql-zeng-liang-tong-bu/mysql.jpg" alt></p><a id="more"></a> <h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>将mysql的日志格式设置为row模式，使用mysql-binlog-connector对日志进行读取，将读取到的mysql操作事件进行解析封装，最终封装为事件对象，进而对mysql的日志进行处理。但区别在于canal是模拟mysql slave端，主动从master端拉取日志数据。而mysql-binlog-connector只是一个解析库，它有两种模式：BinaryLogFileReader日志读取模式，和BinaryLogClient客户端访问模式。但似乎BinaryLogFileReader日志读取模式更适合于增量同步，它是可中断可指定position读取的的模式。下面是BinaryLogFileReader日志读取模式的示例代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>shyiko<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>binlog<span class="token punctuation">.</span>BinaryLogFileReader<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>shyiko<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>binlog<span class="token punctuation">.</span>event<span class="token punctuation">.</span>Event<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>shyiko<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>binlog<span class="token punctuation">.</span>event<span class="token punctuation">.</span>deserialization<span class="token punctuation">.</span>ChecksumType<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>shyiko<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>binlog<span class="token punctuation">.</span>event<span class="token punctuation">.</span>deserialization<span class="token punctuation">.</span>EventDeserializer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        String filePath<span class="token operator">=</span><span class="token string">"D:\\DATA\\mysql-bin.000987"</span><span class="token punctuation">;</span>        File binlogFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        EventDeserializer eventDeserializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        eventDeserializer<span class="token punctuation">.</span><span class="token function">setChecksumType</span><span class="token punctuation">(</span>ChecksumType<span class="token punctuation">.</span>CRC32<span class="token punctuation">)</span><span class="token punctuation">;</span>        BinaryLogFileReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinaryLogFileReader</span><span class="token punctuation">(</span>binlogFile<span class="token punctuation">,</span> eventDeserializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Event event<span class="token punctuation">;</span> <span class="token punctuation">(</span>event <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上述代码，实现了针对某个sql日志文件进行读取，解析mysql事件，并封装为Event的功能。这样只能读取本地的Mysql日志文件，也就是说用这种方式，那么同步服务只能和源端数据库在同一台机器上，这显然不是我想要的方式，下面是主要说BinaryLogFileReader日志读取模式，它可监听远程的Mysql日志文件变化。</p><h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><h3 id="1-Maven配置"><a href="#1-Maven配置" class="headerlink" title="1.Maven配置"></a>1.Maven配置</h3><pre class=" language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.shyiko<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-binlog-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.18.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="2-Mysql源端数据库配置"><a href="#2-Mysql源端数据库配置" class="headerlink" title="2.Mysql源端数据库配置"></a>2.Mysql源端数据库配置</h3><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">      server-id</span><span class="token punctuation">=</span><span class="token attr-value">1</span><span class="token attr-name">      log-bin</span><span class="token punctuation">=</span><span class="token attr-value">mysql-bin</span><span class="token attr-name">      binlog-format</span><span class="token punctuation">=</span><span class="token attr-value">ROW</span><span class="token attr-name">      expire_logs_days</span> <span class="token punctuation">=</span> <span class="token attr-value">10</span><span class="token attr-name">      max_binlog_size</span>  <span class="token punctuation">=</span> <span class="token attr-value">100M</span></code></pre><p>在Mysql的my.cnf配置文件中需增加以上几个属性(windows环境为my.ini文件)，然后重启数据库。</p><h3 id="3-Java代码"><a href="#3-Java代码" class="headerlink" title="3.Java代码"></a>3.Java代码</h3><p>注意如果要监听多个源端，需要开启多个线程。因为这个开源组件中，监听源端日志文件的代码是阻塞的。所以如果在单线程中监听多个源端，那么只会有第一个数据源能监听到。由于我需要监听两个源端，因此开启了两个线程去获取源端的bing-log。下面是测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        Thread thread1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadTesta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread thread2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadTestb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>源端A对应的线程代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTesta</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">testRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">final</span> BinaryLogClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinaryLogClient</span><span class="token punctuation">(</span><span class="token string">"118.25.36.79"</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 指定从何处开始增量</span>        client<span class="token punctuation">.</span><span class="token function">setBinlogFilename</span><span class="token punctuation">(</span><span class="token string">"mysql-bin.000003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setBinlogPosition</span><span class="token punctuation">(</span><span class="token number">154</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        EventDeserializer eventDeserializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        eventDeserializer<span class="token punctuation">.</span><span class="token function">setCompatibilityMode</span><span class="token punctuation">(</span>                EventDeserializer<span class="token punctuation">.</span>CompatibilityMode<span class="token punctuation">.</span>DATE_AND_TIME_AS_LONG<span class="token punctuation">,</span>                EventDeserializer<span class="token punctuation">.</span>CompatibilityMode<span class="token punctuation">.</span>CHAR_AND_BINARY_AS_BYTE_ARRAY        <span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setEventDeserializer</span><span class="token punctuation">(</span>eventDeserializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">registerEventListener</span><span class="token punctuation">(</span>event <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            EventData data <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            event<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">UpdateRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------Update--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>UpdateRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">updateFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// System.out.println(data.toString());</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">WriteRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------- Insert---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>WriteRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// System.out.println(data.toString());</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">DeleteRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------Delete--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DeleteRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//System.out.println(data.toString());</span>            <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">TableMapEventData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                TableMapEventData tableMapEventData <span class="token operator">=</span> <span class="token punctuation">(</span>TableMapEventData<span class="token punctuation">)</span> data<span class="token punctuation">;</span>                String dataBase <span class="token operator">=</span> tableMapEventData<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String tableName <span class="token operator">=</span> tableMapEventData<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------dataBase:"</span><span class="token operator">+</span>dataBase<span class="token operator">+</span><span class="token string">"-----tableName:"</span><span class="token operator">+</span>tableName<span class="token operator">+</span><span class="token string">"-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//tableMap.put(tableMapEventData.getTableId(), tableMapEventData.getTable());</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>        Iterator var2 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----row-data-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects <span class="token operator">=</span> <span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> beforeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> objects<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert-or-delete:"</span><span class="token operator">+</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>beforeList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">updateFormat</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>        Iterator var2 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----rows-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Map<span class="token punctuation">.</span>Entry row <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> beforeData <span class="token operator">=</span> <span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> beforeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> beforeData<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token string">"before-data:"</span><span class="token operator">+</span>beforeList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> afterData <span class="token operator">=</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> afterList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> afterData<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token string">"after-data:"</span><span class="token operator">+</span>afterList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>源端B对应的线程代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTestb</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">testLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">final</span> BinaryLogClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinaryLogClient</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 指定从何处开始增量</span>        client<span class="token punctuation">.</span><span class="token function">setBinlogFilename</span><span class="token punctuation">(</span><span class="token string">"mysql-bin.000001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setBinlogPosition</span><span class="token punctuation">(</span><span class="token number">3754</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        EventDeserializer eventDeserializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        eventDeserializer<span class="token punctuation">.</span><span class="token function">setCompatibilityMode</span><span class="token punctuation">(</span>                EventDeserializer<span class="token punctuation">.</span>CompatibilityMode<span class="token punctuation">.</span>DATE_AND_TIME_AS_LONG<span class="token punctuation">,</span>                EventDeserializer<span class="token punctuation">.</span>CompatibilityMode<span class="token punctuation">.</span>CHAR_AND_BINARY_AS_BYTE_ARRAY        <span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setEventDeserializer</span><span class="token punctuation">(</span>eventDeserializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">registerEventListener</span><span class="token punctuation">(</span>event <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            EventData data <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">UpdateRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------Update--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>UpdateRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">updateFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// System.out.println(data.toString());</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">WriteRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------- Insert---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>WriteRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// System.out.println(data.toString());</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">DeleteRowsEventData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-------------Delete--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DeleteRowsEventData<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//System.out.println(data.toString());</span>            <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">TableMapEventData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                TableMapEventData tableMapEventData <span class="token operator">=</span> <span class="token punctuation">(</span>TableMapEventData<span class="token punctuation">)</span> data<span class="token punctuation">;</span>                String dataBase <span class="token operator">=</span> tableMapEventData<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String tableName <span class="token operator">=</span> tableMapEventData<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------dataBase:"</span><span class="token operator">+</span>dataBase<span class="token operator">+</span><span class="token string">"-----tableName:"</span><span class="token operator">+</span>tableName<span class="token operator">+</span><span class="token string">"-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//tableMap.put(tableMapEventData.getTableId(), tableMapEventData.getTable());</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteOrInsertFormat</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>        Iterator var2 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----row-data-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects <span class="token operator">=</span> <span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> beforeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> objects<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert-or-delete:"</span><span class="token operator">+</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>beforeList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">updateFormat</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Serializable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>        Iterator var2 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----rows-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Map<span class="token punctuation">.</span>Entry row <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> beforeData <span class="token operator">=</span> <span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> beforeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> beforeData<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token string">"before-data:"</span><span class="token operator">+</span>beforeList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> afterData <span class="token operator">=</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            List<span class="token operator">&lt;</span>String<span class="token operator">></span> afterList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj <span class="token operator">:</span> afterData<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    beforeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    afterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token string">"after-data:"</span><span class="token operator">+</span>afterList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这里需要注意的是，源端数据库的账户。如果使用非root用户需要给相应的权限。此外在获取日志文件中的数据中，可以指定从哪个文件哪个位置开始监听。以防止数据丢失，可通过以下sql来查询当前数据库正处于的位置</p><pre class=" language-mysql"><code class="language-mysql">show master status;-- 结果-- +------------------+----------+--------------+------------------+-------------------+-- | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |-- +------------------+----------+--------------+------------------+-------------------+-- | mysql-bin.000005 | 154      |              |                  |                   |-- +------------------+----------+--------------+------------------+-------------------+</code></pre><p>如果在代码运行中，不确定源端是否开启了bin-log，可通过下面这个sql来查询</p><pre class=" language-mysql"><code class="language-mysql">show variables like '%log_bin%';-- 结果-- +---------------------------------+-----------------------------------------------------------+-- | Variable_name                   | Value                                                     |-- +---------------------------------+-----------------------------------------------------------+-- | log_bin                         | ON                                                        |-- +---------------------------------+-----------------------------------------------------------+-- | log_bin_basename                | C:\ProgramData\MySQL\MySQL Server 5.7\Data\mysql-bin      |-- +---------------------------------+-----------------------------------------------------------+-- | log_bin_index                   | C:\ProgramData\MySQL\MySQL Server 5.7\Data\mysql-bin.index|-- +---------------------------------+-----------------------------------------------------------+-- | log_bin_trust_function_creators | OFF                                                       |-- +---------------------------------+-----------------------------------------------------------+-- | log_bin_use_v1_row_events         | OFF                                                       |-- +---------------------------------+-----------------------------------------------------------+-- | sql_log_bin                     | ON                                                        |-- +---------------------------------+-----------------------------------------------------------+</code></pre><p>结果中log-bin的值为ON表示，Mysql数据库已经开启了bin-log。关于Myql的日志模式的理解。以上就是全部代码了，唯一有点不方便的地方就是该组件可以获取到表变更的数据但不能获取到表的字段名，字段名只能通过另外的方式获取，可登陆源端数据库，通过下面这个sql获取。</p><pre class=" language-mysql"><code class="language-mysql">select COLUMN_NAME from information_schema.COLUMNS where table_name = 'dev_device_camera'; </code></pre><h2 id="Mysql的三种日志"><a href="#Mysql的三种日志" class="headerlink" title="Mysql的三种日志"></a>Mysql的三种日志</h2><p>MySQL binlog日志有三种格式，分别为Statement,MiXED和ROW。下面总结了各自的优缺点</p><p><strong>1.Statement：</strong>每一条会修改数据的sql都会记录在binlog中。</p><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>出现最早，兼容较好，binlog文件较小</td><td>存在安全隐患，可能导致主从不一致</td></tr><tr><td>日志是包含用户执行的原始SQL,方便统计和审计</td><td>对一些系统函数不能准确复制或是不能复制</td></tr></tbody></table><p><strong>2.ROW：</strong>不记录sql语句上下文相关信息，仅保存哪条记录被修改。</p><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>相比statement更加安全的复制格式</td><td>binlog比较大（myql5.6支持binlog_row_image）</td></tr><tr><td>在某些情况下复制速度更快（SQL复杂，表有主键）</td><td>单语句更新（删除）表的行数过多，会形成大量binlog</td></tr><tr><td>系统的特殊函数也可以复制</td><td>无法从binlog看见用户执行SQL</td></tr></tbody></table><p><strong>3.Mixed：</strong> 是以上两种level的混合使用，一般的语句修改使用statment格式保存binlog，如一些函数，statement无法完成主从复制的操作，则采用row格式保存binlog，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种.新版本的MySQL中队row level模式也被做了优化，并不是所有的修改都会以row level来记录，像遇到表结构变更的时候就会以statement模式来记录。至于update或者delete等修改数据的语句，还是会记录所有行的变更。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面试总结</title>
      <link href="/2019/05/15/mian-shi-zong-jie/"/>
      <url>/2019/05/15/mian-shi-zong-jie/</url>
      
        <content type="html"><![CDATA[<p>又到一年金三银四的黄金跳槽季，相信很多人都在这期间蠢蠢欲动，不是正在离职，就是在纠结要不要跳槽。各大公司呢，也开始招兵买马为今年公司的发展储备人才。2019年的金三银四可以说比较特殊了，人们都说，互联网寒冬来了。各大互联网公司裁员，在互联网巨头中有京东，腾讯都裁员不少。再到2019年年初的 996,ICU 事件的持续发酵，程序员们众推了许多大公司包括阿里巴巴，腾讯，有赞等上了996黑名单。再到马云微博的声援996是员工一种福报的价值观引发众多网友反对，甚至成为众矢之的事件。这些事情必然导致今年的金三银四与往年相比有些不一样，员工和企业主都会更加理性了。这个时候还在大面积招人的公司，必然是牛逼的公司。而这个时候勇敢跳槽的人，必然是牛逼的人。</p><p><img src="/2019/05/15/mian-shi-zong-jie/mainshi.jpg" alt></p><a id="more"></a> <p>经过一些面试后，深感自己技术理解不够深入，很多停留在表面的使用上，稍有理解的也仅仅只是明白那个道理，却难以举一反三灵活应用，感觉前方的路任重而道远啊。下面是我几个印象比较深刻的面试经历，其中括号中的是我回答的内容和一些解释。</p><h2 id="1-阿里口碑"><a href="#1-阿里口碑" class="headerlink" title="1.阿里口碑"></a>1.阿里口碑</h2><p>阿里口碑面试是在2019年3月份，当时是猎头推荐的。已经通过了简历筛选，大概过几天就会有电话过来进行简单的沟通。说实话那时我内心是很激动的，因为进入阿里这样的大厂对于多数程序员来说都是终极梦想，我得到这次机会，说明我的工作经历在一定程度上得到了认可。大概过了两三天后的一个晚上，阿里的人打电话过来了</p><h4 id="一面："><a href="#一面：" class="headerlink" title="一面："></a>一面：</h4><p>一面是电话面试，首先进行了自我介绍。然后面试官会针对你的项目介绍问一些问题，一面对技术的问的并不深入，但涉及的广度比较大，因此平时要多做准备，广泛涉猎。下面是问到的一些主要问题。</p><ol><li>太平洋的大数据平台项目主要用了哪些技术，业务作用是什么，你在项目中担任什么角色。（这个问题基本如实回答就行）</li><li>在项目中主要使用的Java语言是吧，并发接触的多不多，说一下Java中实现线程安全的方式有哪些（这个问题能牵扯出一大堆问题。synchronize和lock锁可实现线程安全，更深层次的可以对比两种锁的实现原理来讲，当时我了解的没有那么深入就没有说，在项目开发中也会使用到concurrentHashMap和concurrent包下的原子操作类来提供并发的吞吐）</li><li>在Java中HashMap和HashTable的区别（我只是回答了HashMap线程不安全，HashTable线程不安全。但应该还会有一些别的区别，不然感觉回答的太简单了）</li><li>在项目开发过程中有使用过连接池吗（使用过，主要使用的就是阿里巴巴的数据库连接池Druid）</li><li>嗯，说一说数据库使用连接池和不使用连接池有什么区别（如果使用原生的JDBC，每次操作数据库时需要创建连接，使用完毕后需要关闭连接，在并发比较大的时候会因超过数据库连接上限而无法连接，造成系统响应较慢。使用连接池的话，省去了连接维护的成本同时提高系统的稳定性，降低开发成本）</li><li>如果原生的JDBC查询比较慢怎么优化（这个问题我比较懵，当时首先想的不是sql优化，而是原生的JDBC在客户端是不是可以缓存什么的，所以糊里糊涂的回答了不知道）</li><li>spring boot用过吧，简单聊一下，你是怎么用的。（spring boot是spring MVC的升级版，以约定大于配置的方式极大的简化了spring MVC中繁琐的xml配置，使用spring boot只需要在maven中依赖插件就会自动加载到spring容器中，它的原理是通过springBootApplication注解实现的，springBootApplication是个组合注解，其中比较重要的是EnableAutoConfiguration注解，它可以帮助SpringBoot应用将所有符合条件的@Configuration配置都加载到当前SpringBoot创建并使用的IoC容器。实现自动化加载JavaBean，这也是spring boot这么简单的原因）</li><li>嗯，说一下mybatis中#和$的区别吧（这个问题简直是送分的，# 仅仅是个占位符，而美元符取的是变量值，#不会出现sql注入攻击，美元符则容易出现sql注入攻击，在开发过程中推荐使用#）</li><li>了解过幂等吗，在web请求中怎么实现接口的幂等。（没有使用过幂等，但我有去了解过，幂等是为了防止接口在短时间内的重复请求，一般出现在金融支付方面，由于鼠标的机械抖动导致一个支付请求连续发送了两次。可以在请求发送前，先去请求后端的一个接口得到一个一次性的票据，然后在支付时带上这个票据就可以了）</li><li>如果想实现一个限流的网关，怎么实现。（可以通过spring的拦截器实现，其原理的话，是通过令牌桶的方式，首先创建一个一定容量的容器，在请求来时创建一个令牌并把它放入桶中，在请求返回时移除这个请求对应的令牌。每次请求来时，首先判断容器中的令牌是不是已经满了，如果满了则直接返回这个请求告诉用户请求已经达到最大，让用户稍后访问）</li><li>嗯，今天面试就到这，你有什么想问我的吗（固定套路，一般碰到这种问题，大概问一下项目或是公司的一些大概情况）</li></ol><h4 id="二面："><a href="#二面：" class="headerlink" title="二面："></a>二面：</h4><p>一面通过后，第二天晚上口碑的电话又打过来了，不过由于当时我在洗澡没有接到，导致错过了两个电话，后来和猎头沟通之后直接约了现场面试。地点是在上海五道口，约的是周六。到达指定的楼层后首先映入眼帘的就是口碑的logo，环境也比较好。当然这栋楼并不是阿里的，只是租了几层吧。到前台做登记后，便有人领我到了一个会议室等待面试官的到来。这里还有一个小插曲，当时先进来一个人，面相比较和蔼，头发有些发白看上去应该有50左右了，先和握了手，然后还简单的介绍了一下自己，隐约记得说他是14年加入阿里的。当时我心里一愣，心想年纪这么大了，应该级别比较高吧，不至于二面就来面试我这样的级别的吧。果然不久又来一个人，看上去就年轻多了30多岁的样子，然后和那个年长的沟通了一下，意思是会议室搞错了，然后就带我去了另外一个会议室。不过这个小经历也让我感觉到，阿里还是很开放的，其实只要有能力所谓的中年危机也没那网上说的那么严重吧。嗯，题外话，下面是二面的主要过程。</p><ol><li>先做一下自我介绍吧（面试官全程看着电脑，好像在看我的简历。这次我非常紧张，刚开始声音都带一点颤抖，一方面是是对阿里大厂的敬畏，二是怕说错什么，毕竟阿里的人技术肯定都很强，我怕我一说错会让他们觉得我技术很菜。。）</li><li>项目中主要使用的是mysql吧，说一说数据库中怎么使用索引的（数据库的索引很多，我主要使用的是唯一索引，联合索引等，在查询时尽量使sql优先走索引，以加快查询速度，少使用!=，=null这种操作来避免sql走全表扫描）</li><li>使用过分表分库，或是主从配置吗，简单讲一下（这块没有了解过）</li><li>数据库索引的实现原理讲一下（数据库索引的实现主要使用的是B+树，B+树是一种自平衡的多路搜索树，在每个非节点上不存储数据只存储索引，所有数据都存储在叶子节点上，同时所有叶子节点存在着横向的索引，以便于数据库的范围查询。这些回答其实一直在讲B+树结构本身的特点，还是没有讲出数据库为什么使用B+的核心点）</li><li>叶子节点存在横向索引吗（是的，这我不知道是面试官有意试探，还是他不知道这些细节。在我的记忆里，B+树的叶子节点确实存在横向索引，所以我就给了肯定的回答）</li><li>使用过redis吗，redis集群是怎么实现数据一致的？（这块我不了解。这里我有点懵，因为我虽然使用过redis，却没自己搭建过redis集群）</li><li>那你知道ZAB协议吗，简单讲一下（没有接触过ZAB协议。我真的是太紧张了，这个都答出来，这其实也就是上一个问题面试官想要了解的，ZAB协议是Paxos算法得来的。我还专门去看过Paxos算法的过程，如果面试官问zookeeper的一致性原理，我肯定能反应过来了，很可惜）</li><li>你的离职原因是什么（问到这，其实我感觉已经凉凉了，因为面试官没有问我几个技术问题，就开始问个人问题了，前面几个问题回答的不好吧）</li><li>谈一谈你的职业规划，你想往哪方面发展（首先我想提高自己的技术，然后往架构师的方向发展）</li><li>嗯，行，你还有什么想问我的吗</li></ol><p>这次面试其实面到一半我就感觉要凉凉了，主要原因还是由于自己太过紧张，影响了我的正常发挥。所以不管以后遇到什么事情，自信是最重要的，回过头来想，其实阿里虽是个大厂但是问的问题基本上和普通公司区别不大，基础打扎实了，基本都能应付过来，主要还是要自信。</p><h2 id="2-中国移动产业研究院"><a href="#2-中国移动产业研究院" class="headerlink" title="2.中国移动产业研究院"></a>2.中国移动产业研究院</h2><p>这个机会也是猎头推荐的，中国移动是家国企，工资给不高，平时福利待遇会好一些。这家公司我拿到了offer，不过最后没有去，主要还是薪水给的不够。年薪算下来和我现在的持平，但月薪比我现在还低。是按13薪算的。不过每个月有小几千的交通补贴。不过其实我还是蛮想去的，因为研究院主要做的方向是5G金融，算是比较前沿的领域了。现在5G还没有普及，未来不可限量。话不多说，面试过程也简单粗暴，就两轮面试，一轮技术面，二轮人事面。第一轮技术直接就是群面，在一个大会议室，大约有10来个人做在我对面。下面是主要问的问题</p><h4 id="一面：-1"><a href="#一面：-1" class="headerlink" title="一面："></a>一面：</h4><ol><li>先做下自我介绍吧（坐在中间的最先发言，看起来年纪比较大，应该是这些人里面级别最高的吧）</li><li>嗯，我看你用spring还用的比较多，讲一下spring吧。（spring有两个核心点即IOC和AOP。IOC即控制反转就是将原本通过new对象的方式变成了由spring容器管理对象。pring默认的注入对象是单例的，可通过构造器注入，set方法注入。AOP即面向切面编程，在spring中的体现有前置拦截器，后置拦截器，事务控制等 。其底层原理是通过动态代理方式实现的。会议室坐了10来号人，实际提问的就四五个人，随机发言提问。）</li><li>讲一下Java的动态代理和spring的动态代理有什么区别（java的动态代理是需要代理类与被代理类实现同一个接口的，而spring的动态代理则是通过cglib来实现动态代理的，在编码上其代理类与被代理类没有直接关系。但实际上在字节码中，代理类是继承了被代理类的，它们两个是继承关系）</li><li>你有个项目用过spark，讲一下使用场景，什么要使用spark（在原来的系统中，有很多用户系统，用户数据分散在不同的系统中，那个场景是需要汇聚上游业务系统的用户数据，首先是将数据从数据库发送到kafka中，这个功能由另一个team做，我这是通过spark streaming从kafka中拉取数据，经过数据的清洗过滤，最终将数据存入到hbase中）</li><li>你在项目中担任什么角色，做了什么事情（这个项目分为两个模块，一个是实时处理，另一个是批处理跑历史数据，我是在实时处理模块中担任开发工作，主要负责从kafka消费数据到数据的清洗加工部分）</li><li>你说你用过Hbase，说一下Hbase的架构吧。（Hbase集群分为HMaster和HRegion，其中HMaster负责管理集群的HRegion,会存储部分元数据。HRegion是真正存储数据的节点，Hbase的一张表会根据rowkey进行散列并存储在不同的HRegion中。所有节点会通过zookeeper管理。当Hbase的客户端发送一个查询请求时，首先会提交给HMaster，HMaster会通过存储在zookeeper的HRegion元数据表信息，将查询请求的数据定位某一个节点从而加快查询速度）</li><li>说一下spring boot和spring MVC的区别（我觉得spring boot是spring mvc的升级版，它以约定大于配置的理念极大的简化了spring的使用成本，使得开发人员得以从繁琐的配置中解脱出来，同时spring boot内嵌了tomcat，因此spring boot打成包后可以直接运行）</li><li>你觉得spring boot和spring mvc是一个东西吗（我觉得可以理解为一个升级版，为什么简化spring mvc的使用，降低学习门槛。面试官的眼神中似乎对我的回答不太满意，觉得我有些概念模糊，于是又追问了下面这个第9问。不过我觉得有一些过于纠结概念了）</li><li>那你觉得spring和spring mvc是一个东西吗（不是，spring仅仅是一个管理对象容器的中间件，而spring mvc是一个可以快速集成第三方开源组件，提供开发效率的企业级框架。回答到此，面试官才不再追问了。。）</li><li>你在现在这家公司主要做了什么内容（现在公司主要从事安防行业，目前是给上海市公安局维护视频监控平台，包括去年平台的升级，我负责开发一个适配服务，因为平台升级只在市局节点升级了，分局和派出所仍然使用旧版本的系统，因此需要做适配。让所有需要调旧版本的接口全部走我这个适配服务）</li><li>维护工作主要做些什么内容（主要负责市局的一些小需求变更的开发工作，数据方面的问题，主要是老系统遗留下来的问题，有时会出现数据同步异常的情况，需要人工去解决，这其实也是数据同步架构导致的）</li><li>数据同步的问题，有解决方案吗（目前没有，因为公安局比较依赖于这个系统，日常摄像机的实时监控都需要通过这个平台，因此我们的首要工作就是保障系统的正常使用，如果想要根治这个问题，需要全节点升级系统，工作量非常大而且造成的影响也无法估计）</li></ol><p>在没人提问之后，一面结束。总体感觉不错，虽然是群面但是个人感觉良好，碰到问题有理有据的回答，没有出现紧张的情况。最后坐在中间的那个大佬说话了，要我出去等一会。看来一面是过了。</p><h4 id="二面：-1"><a href="#二面：-1" class="headerlink" title="二面："></a>二面：</h4><p>一面过后，大概等了半个多小时。二面直接就是人事面了，当时是有点出乎我的意料的，效率这么高。人事是个中年男人，讲话有些轻声细语的。问的问题也比较简单。大致人事都会问这些问题吧</p><ol><li>简单自我介绍了一下</li><li>问了一下离职原因</li><li>介绍了一下公司的情况，目前正在做的项目，发展前景等</li><li>谈薪阶段，说了一下公司的福利待遇。国企给的薪水不会很高，要有心理准备</li></ol><h2 id="3-蚂蚁金服"><a href="#3-蚂蚁金服" class="headerlink" title="3.蚂蚁金服"></a>3.蚂蚁金服</h2><p>有几个猎头给我介绍过蚂蚁金服，但听其中一个猎头说，去年他推荐的一个人选在蚂蚁做了7个月就因为加班太严重而离职了。莫名的对这个机会有些犹豫，心里头想该不会是去填坑的吧，于是就不了了之。后来有天晚上，接到了蚂蚁金服的人给我打来电话，问我想不想试一试机会。当时真的很意外，于是便试一下自己的水平吧。面试时间是在周六，过来先做一套笔试题，面试的人很多，很大的一个会议室都坐满了埋头在做笔试题的人，看来今天是专场了。试卷难度倒也不大，主要是为了错开面试候选人的时间吧。大概过了一个小时后，我被领到一间会议室开始了面试，面试有两个人。他们首先在看我的笔试题</p><h4 id="一面：-2"><a href="#一面：-2" class="headerlink" title="一面："></a>一面：</h4><ol><li>这个题怎么写的都是伪代码。（一定要写代码吗，我就用伪代码写了一下思路）</li><li>行吧，先做下自我介绍吧。（右边那个面试官仍然在翻看我的笔试题，给人感觉很干练，技术也很深厚。后面全程基本上都是他在提问）</li><li>说一下B+树吧（B+树是一颗自平衡的多路搜索树，数据都存储在叶子节点，非叶子节点存储数据，仅存储索引。在叶子节点上有横向的索引。叶子节点的横向索引可以加快范围搜索的时间）</li><li>B+树是一颗多路搜索树，它为什么能提高查询速度，为什么不使用红黑树做数据库的索引实现呢（因为B+树的多路特性，导致B+树是一颗矮胖树，因此在往下搜索的时候减少了搜索的次数）</li><li>你说的对，B+树是一颗多路搜索树，但多路搜索就会快吗，一个节点上有多个子节点。这就需要横向的遍历，同样需要耗费时间，而红黑树是一颗二叉树，不需要遍历，只需判断一下就可以了。（不好意思，这我没有深入了解。&lt;从面试官的表情可以看出他明显失望了，也没有再问。这里一定要好好看看，数据库B+树最最重要的原因，是因为磁盘，一张几千万数据的表，可能索引就会有几个G，不可能把索引全加载到内存，因此减少IO次数就是关键，这也是B+数被设计为矮胖的多路搜索树的原因&gt;）</li><li>谈一下HashMap的底层实现吧，线程不安全怎么办（底层是数组加链表，在jdk1.7以后，HashMap做了优化，节点数大于8时，链表会转化为红黑树。HashMap线程设计的时候就没有考虑线程安全问题，官方也不推荐在并发情况下使用HashMap，而推荐使用ConcurrentHashMap，或是使用HashTable）</li><li>说一下CouncurrentHashMap的实现原理（CouncurrentHashMap使用分段锁技术，底层包含多个Segement，提供了高并发情况下的吞吐量。）</li><li>说一下sycorbnize的实现原理（sycorbnize是java中的常用的同步方式，在jdk1.5以前它是一把重量级锁，1.5以后对他多了优化，在使用sycornize时，它首先是偏向锁，然后升级为轻量级锁，再自旋升级为重量级锁）</li><li>谈一下自旋锁，偏向锁的实现原理，CAS底层是怎么实现的（自旋锁其实是一种侥幸心理，当前线程假设正在持有锁的线程会很快释放锁，因此当前线程就做空循环，即自旋。目的是避免自己进入系统调度，但这个自旋有时间限制，不会无限自旋下去。偏向锁是当前锁偏向于某个线程，即对象头中记录了某个线程的ID，当线程来竞争锁时，只需判断一下线程ID是不是自己，如果是的话直接持有锁。CAS底层是一个原子操作，它的实现是CPU级别的一个指令，在硬件上就保证了原子性）</li><li>那你知道实现CAS的指令是什么吗（不知道。&lt;很意外，面试官还会问我这个&gt;）</li><li>实现线程安全的方式有哪些，怎么理解线程的本地内存和主存（sycornize关键字，Lock锁。线程的本地内存在硬件上可理解为CPU的高速缓存和寄存器中的数据，而主存可理解为内存条中的内存）</li><li>聊一下对你成长最大的一个项目吧，可以在黑板上画一下架构图，描述一下业务流程（好的。&lt;这个过程需要对项目有深入的理解，每个组件的原理和选型&gt;）</li><li>你这个项目中用到了Spark，为什么要用Spark，怎么不用Flink（这个项目是给太平洋保险做的，他们用的是华为大数据平台的产品，因此使用的Spark。&lt;这个问题，问的我懵的，我也不知道为什么使用Spark，我参与的时候就已经使用这个架构，这也让我吸取教训，写在简历上的项目一定要熟悉。不能简单的只是参与，面试的时候说流水账&gt;）</li><li>这个架构中如果kafka数据消费的时候，由于消费端出现问题阻塞了怎么解决（你的意思是kafka取到数据后，处理的时候，数据落地到hbase时出现异常怎么处理吧，这个架构中Kafka专门有一个topic，当数据不能入库时，会把数据发回到这个topic，再走一遍流程，避免了数据的阻塞。同时形成闭环，数据不会丢失。）</li><li>为什么要单独创建一个topic，而不是发送到原来的topic。（这部分数据是异常数据，只有在入库时出现异常才会发回去，如果第二次还是不能入库的，就会把数据写入到文件，人工来处理。专门用个topic也是为了方便查找问题。因为这些都是异常数据，我们只管去这个topic看就行了）</li><li>Hbase落地后怎么进行分区的，怎么保证数据均匀的分布在每个节点上（Hbase是通过rowkey来进行分区的，因此数据在源端发送到kafka时，就要求源端为每条数据生成一个uuid，我是通过这个uuid来保证rowkey能均匀分区的）</li><li>UUID吗？你这样确实能保证数据均匀分布了，但是你怎么在Hbase中查找这条数据呢？（嗯，在实际业务中也确实出现，需要通过表的一些字段条件搜索的情况，因此我在数据存储到Hbase的时候，先会存储一个字段到rowkey的索引到solr中）</li><li>用了solr做索引，那为什么不用elasticsearch呢？（没有接触过elasticsearch。&lt;我有些崩溃，我也不知道为什么要用solr而不用elasticsearch，我只是个开发啊啊啊。。。&gt;）</li><li>用UUID能保证唯一性吗（UUID是唯一的，它是根据网卡MAC地址，时间戳，机器码而生成的，肯定能唯一）</li><li>不一定，UUID也可能出现一样的，只是概率很小（。。。&lt;这倒是让我长见识了，我之前一直以为UUID不会重复，面试完后还特意去查了一下&gt;）</li><li>你这个架构怎么保证kafka数据不丢失（因为我是自己维护offset的，因此在单个节点上，在提交offset时，使用原子操作类加同步的方式，保证offset有序的更改。这里使用的是spark分布式节点去计算的，后面又发现不同节点去消费同一个topic时，会出现同时提交offset的情况，因此又用zookeeper去做了一个分布式锁来提交offset）</li><li>有了zookeeper的分布式锁，还有必要在单个节点上保证同步吗。分布式锁就能保证同步了嘛（额。是的&lt;不得不说，这个面试官逻辑很清晰，很快就能找出一些问题&gt;）</li></ol><p>蚂蚁金服基本就问了这些，不过和我以前面的公司有很大的不一样。以前的面试基本上是我在讲，面试官在听，而问的问题也是按他自己的思路问。而蚂蚁金服的面试官不一样，他基本是顺着你讲的东西问，在聊的过程中发现问题，并且指正，面试官技术很深厚。也让我感觉到了，要在这条路上走下去，就不能只停留在那些容易变的组件使用上，而是要深入了解其原理</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面经 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java并发编程-Java中的锁</title>
      <link href="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/"/>
      <url>/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/</url>
      
        <content type="html"><![CDATA[<p>在并发编程中，经常遇到多个线程访问同一个 共享资源 ，这时候必须考虑如何维护数据一致性。在JVM中所有线程都共享堆内存的，因此Java中的同步都是针对堆中的对象。一般在Java中所说的锁就是指的内置锁，每个Java对象都可以作为一个实现同步的锁。虽说在Java中有句万物皆对象的名言，但Java中的同步锁仅仅是针对引用数据类型而言，基本数据类型不能作为同步的锁。在JDK1.5之前都是使用synchronized关键字保证同步的，Synchronized的作用相信大家都已经非常熟悉了，它是一把重量级锁，但随着人们对性能和体验的要求越来越高，JDK1.6以后对Synchronized做了优化处理。同时根据锁的状态，锁的设计等不同角度又衍生出各种类型的锁，如果不明白它们的关系，会让人云里雾里，摸不着头脑。下面就介绍各种锁的分类以及实现的原理</p><p><img src="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/AQS.png" alt></p><a id="more"></a> <p>在java中提到锁、安全性、同步，首先想到的则是java提供synchronized。synchronized是这么的神奇而又强大，成为了我们解决多线程情况的百试不爽的良药。但是，随着我们学习的进行我们知道synchronized是一个重量级锁，相对于Lock，它会显得笨重无比，在如今人们对速度和性能极致要求的现在，现在此时并不能满足性能上的要求。诚然SUN公司也认识到了这一点，在Java SE 1.6对synchronized进行了各种优化后，有些情况下它就并不那么笨重了。在Java SE 1.6中为了减少获得锁和释放锁带来的性能开销而引入偏向锁和轻量级锁。synchronized关键字可以用在方法上，也可以用在对象上，但实际上都是锁住了JVM堆中的对象。Java中每一个对象都可以作为锁，这是synchronized实现同步的基础，普1.通同步方法：锁是当前实例对象，2.静态同步方法：锁是当前类的class对象，3.同步方法块：锁是括号里面的对象。当一个线程访问同步代码块时，它首先是需要得到锁才能执行同步代码，当退出或者抛出异常时必须要释放锁，我们先看一段简单的代码：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>SynchronizedTest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>利用javap工具查看生成的class文件信息来分析Synchronize的实现</p><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_SYNCHRONIZED    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// String Hello World</span>         <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>         <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V    flags<span class="token operator">:</span> ACC_PUBLIC    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">5</span>                  <span class="token comment" spellcheck="true">// class com/hollis/SynchronizedTest</span>         <span class="token number">2</span><span class="token operator">:</span> dup         <span class="token number">3</span><span class="token operator">:</span> astore_1         <span class="token number">4</span><span class="token operator">:</span> monitorenter         <span class="token number">5</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>         <span class="token number">8</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// String Hello World</span>        <span class="token number">10</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>        <span class="token number">13</span><span class="token operator">:</span> aload_1        <span class="token number">14</span><span class="token operator">:</span> monitorexit        <span class="token number">15</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">23</span>        <span class="token number">18</span><span class="token operator">:</span> astore_2        <span class="token number">19</span><span class="token operator">:</span> aload_1        <span class="token number">20</span><span class="token operator">:</span> monitorexit        <span class="token number">21</span><span class="token operator">:</span> aload_2        <span class="token number">22</span><span class="token operator">:</span> athrow        <span class="token number">23</span><span class="token operator">:</span> <span class="token keyword">return</span></code></pre><p>从上面可以看出，同步代码块是使用monitorenter和monitorexit指令实现的，同步方法（在这看不出来需要看JVM底层实现）依靠的是方法修饰符上的ACC_SYNCHRONIZED实现。方法级的同步是隐式的。同步方法的常量池中会有一个<code>ACC_SYNCHRONIZED</code>标志。当某个线程要访问某个方法的时候，会检查是否有<code>ACC_SYNCHRONIZED</code>，如果有设置，则需要先获得监视器锁，然后开始执行方法，方法执行之后再释放监视器锁。这时如果其他线程来请求执行方法，会因为无法获得监视器锁而被阻断住。值得注意的是，如果在方法执行过程中，发生了异常，并且方法内部并没有处理该异常，那么在异常被抛到方法外面之前监视器锁会被自动释放。因此加锁解锁的原理大致如下：同步方法通过<code>ACC_SYNCHRONIZED</code>关键字隐式的对方法进行加锁。当线程要执行的方法被标注上<code>ACC_SYNCHRONIZED</code>时，需要先获得锁才能执行该方法。同步代码块通过<code>monitorenter</code>和<code>monitorexit</code>执行来进行加锁。当线程执行到<code>monitorenter</code>的时候要先获得所锁，才能执行后面的方法。当线程执行到<code>monitorexit</code>的时候则要释放锁。每个对象自身维护这一个被加锁次数的计数器，当计数器数字为0时表示可以被任意线程获得锁。当计数器不为0时，只有获得锁的线程才能再次获得锁。即可重入锁。</p><h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><p>在jdk1.6后对synchronized做了很多优化，这里就需要深入了解一下synchronized的工作原理了。但是在深入之前我们需要了解两个重要的概念：Java对象头，Monitor。synchronized用的锁是存在Java对象头里的。otspot虚拟机的对象头主要包括两部分数据：Mark Word（标记字段）、Klass Pointer（类型指针）。其中Klass Point是是对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例，Mark Word用于存储对象自身的运行时数据，它是实现轻量级锁和偏向锁的关键，所以下面将重点阐述</p><h3 id="Mark-Word"><a href="#Mark-Word" class="headerlink" title="Mark Word"></a>Mark Word</h3><p>Mark Word用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等等。Java对象头一般占有两个机器码（在32位虚拟机中，1个机器码等于4字节，也就是32bit），但是如果对象是数组类型，则需要三个机器码，因为JVM虚拟机可以通过Java对象的元数据信息确定Java对象的大小，但是无法从数组的元数据来确认数组的大小，所以用一块来记录数组长度。对象头信息是与对象自身定义的数据无关的额外存储成本，但是考虑到虚拟机的空间效率，Mark Word被设计成一个非固定的数据结构以便在极小的空间内存存储尽量多的数据，它会根据对象的状态复用自己的存储空间，也就是说，Mark Word会随着程序的运行发生变化，变化状态如下（64位虚拟机）：</p><p><img src="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/markword2.png" alt></p><h3 id="乐观锁与悲观锁"><a href="#乐观锁与悲观锁" class="headerlink" title="乐观锁与悲观锁"></a>乐观锁与悲观锁</h3><p>乐观锁对应于生活中乐观的人总是想着事情往好的方向发展，悲观锁对应于生活中悲观的人总是想着事情往坏的方向发展。这两种人各有优缺点，不能不以场景而定说一种人好于另外一种人。</p><h5 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h5><p>总是假设最坏的情况，每次去读数据的时候都认为别人会修改，所以每次在读数据的时候都会上锁，这样别人想读这个数据就会阻塞直到它拿到锁（共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源给其它线程）。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。Java中synchronized和ReentrantLock等独占锁就是悲观锁思想的实现</p><h5 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h5><p>总是假设最好的情况，每次去读数据的时候都认为别人不会修改，所以不会上锁，但是在写数据的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号机制和CAS算法实现。乐观锁适用于多读的应用类型，这样可以提高吞吐量，像数据库提供的类似于write_condition机制，其实都是提供的乐观锁。在Java中java.util.concurrent.atomic包下面的原子变量类就是使用了乐观锁的一种实现方式CAS实现的。如果仅仅简单的使用CAS会出现ABA的问题。</p><h5 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h5><p>CAS 的含义为 compare and swap，目前绝大多数 CPU 都原生支持 CAS 原子指令，例如在 IA64、x86的指令集中，就有 cmpxchg 这样的指令来完成 CAS 功能，它的原子性要求是在硬件层面上得到保证的。CAS 指令一般需要有三个参数，分别是值的内存地址、期望中的旧值和新值。CAS 指令执行时，如果该内存地址上的值符合期望中的旧值，处理器会用新值更新该内存地址上的值，否则就不更新。这个操作在 CPU 内部保证了是原子性的。在 Java 中有许多 CAS 相关的 API，我们常见的有 <code>java.util.concurrent</code> 包下的各种原子类，例如<code>AtomicInteger</code>，<code>AtomicReference</code>等等。这些类都支持 CAS 操作，其内部实际上也依赖于 <code>sun.misc.Unsafe</code> 这个类里的 compareAndSwapInt() 和 compareAndSwapLong() 方法。CAS 并非是完美无缺的，尽管它能保证原子性，但它存在一个著名的 <strong>ABA</strong> 问题。一个变量初次读取的时候值为 A，再一次读取的时候也为 A，那么我们是否能说明这个变量在两次读取中间没有发生过变化？不能。在这期间，变量可能由 A 变为 B，再由 B 变为 A，第二次读取的时候看到的是 A，但实际上这个变量发生了变化。一般的代码逻辑不会在意这个 ABA 问题，因为根据代码逻辑它不会影响并发的安全性，但如果在意的话，可能考虑采用阻塞同步的方式而不是 CAS。实际上 JDK 本身也对这个 ABA 问题解决方案，提供了 <code>AtomicStampedReference</code> 这个类，为变量加上版本来解决 ABA 问题。</p><h5 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h5><p>Hotspot的作者经过以往的研究发现大多数情况下锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低而引入了偏向锁。当一个线程访问同步块并获取锁时，会在对象头和栈帧中的锁记录里存储锁偏向的线程ID，以后该线程在进入和退出同步块时不需要花费CAS操作来加锁和解锁，而只需简单的测试一下对象头的Mark Word里是否存储着指向当前线程的偏向锁，如果测试成功，表示线程已经获得了锁，如果测试失败，则需要再测试下Mark Word中偏向锁的标识是否设置成1（表示当前是偏向锁），如果没有设置，则使用CAS竞争锁，如果设置了，则尝试使用CAS将对象头的偏向锁指向当前线程。偏向锁有一些特点</p><ul><li><strong>偏向锁的Bulk Revoke机制：</strong>Bulk Revoke即偏向锁的批量撤销，偏向锁使用了一种等到竞争出现才释放锁的机制，所以当其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，然后检查持有偏向锁的线程是否活着，如果线程不处于活动状态，则将对象头设置成无锁状态，如果线程仍然活着，拥有偏向锁的栈会被执行，遍历偏向对象的锁记录，栈中的锁记录和对象头的Mark Word要么重新偏向于其他线程，要么恢复到无锁或者标记对象不适合作为偏向锁，最后唤醒暂停的线程。</li><li><strong>偏向锁的Bulk Rebias机制：</strong>偏向锁的批量重偏向，这个机制很特殊， 别的锁在执行完同步代码块后， 都会有释放锁的操作， 而偏向锁并没有直观意义上的“释放锁”操作。bulk rebias机制是为了解决：一个线程创建了大量对象并执行了初始的同步操作，后来另一个线程也来将这些对象作为锁对象进行操作，这样会导致大量的偏向锁撤销操作。其逻辑如下，引入一个概念 epoch, 其本质是一个时间戳 ， 代表了偏向锁的有效性。从前文描述的对象头结构中可以看到， epoch 存储在可偏向对象的 MarkWord 中。除了对象中的 epoch, 对象所属的类 class 信息中， 也会保存一个 epoch 值，每当遇到一个全局安全点时， 如果要对 class C 进行批量再偏向， 则首先对 class C 中保存的 epoch 进行增加操作， 得到一个新的 epoch_0。然后扫描所有持有 class C 实例的线程栈， 根据线程栈的信息判断出该线程是否锁定了该对象， 仅将 epoch_0 的值赋给被锁定的对象中。退出安全点后， 当有线程需要尝试获取偏向锁时， 直接检查 class C 中存储的 epoch 值是否与目标对象中存储的 epoch 值相等， 如果不相等， 则说明该对象的偏向锁已经无效了， 可以尝试对此对象重新进行偏向操作。</li><li><strong>关闭偏向锁：</strong>偏向锁在Java 6和Java 7里是默认启用的，但是它在应用程序启动几秒钟之后才激活，如有必要可以使用JVM参数来关闭延迟-XX：BiasedLockingStartupDelay = 0。如果你确定自己应用程序里所有的锁通常情况下处于竞争状态，可以通过JVM参数关闭偏向锁-XX:-UseBiasedLocking=false，那么默认会进入轻量级锁状态。</li></ul><p><strong>批量重偏向与批量撤销渊源：</strong>从偏向锁的加锁解锁过程中可看出，当只有一个线程反复进入同步块时，偏向锁带来的性能开销基本可以忽略，但是当有其他线程尝试获得锁时，就需要等到safe point时，再将偏向锁撤销为无锁状态或升级为轻量级，会消耗一定的性能，所以在多线程竞争频繁的情况下，偏向锁不仅不能提高性能，还会导致性能下降。于是，就有了批量重偏向与批量撤销的机制。</p><h5 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h5><p>轻量级锁，也是JDK 1.6加入的新机制，之所以成为“轻量级”，是因为它不是使用操作系统互斥量来实现锁， 而是通过CAS操作，来实现锁。当线程获得轻量级锁后，可以再次进入锁，即锁是可重入（<code>Reentrance Lock</code>）的。</p><ul><li><strong>轻量级锁的加锁过程：</strong>轻量级锁加锁过程分几个步骤。<strong>步骤1：</strong>在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁标志位为“01”状态，是否为偏向锁为“0”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间，用于存储锁对象目前的Mark Word的拷贝，官方称之为 Displaced Mark Word。<strong>步骤2：</strong>拷贝对象头中的Mark Word复制到锁记录中。<strong>步骤3：</strong>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock record里的owner指针指向object mark word。如果更新成功，则执行步骤4，否则执行步骤5。<strong>步骤4：</strong>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，即表示此对象处于轻量级锁定状态。<strong>步骤5：</strong>如果这个更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行。否则说明多个线程竞争锁，轻量级锁就要膨胀为重量级锁，锁标志的状态值变为“10”，Mark Word中存储的就是指向重量级锁（互斥量）的指针，后面等待锁的线程也要进入阻塞状态。 而当前线程便尝试使用自旋来获取锁，自旋就是为了不让线程阻塞，而采用循环去获取锁的过程。</li><li><strong>释放锁线程视角：</strong>由轻量锁切换到重量锁，是发生在轻量锁释放锁的期间，之前在获取锁的时候它拷贝了锁对象头的markword，在释放锁的时候如果它发现在它持有锁的期间有其他线程来尝试获取锁了，并且该线程对markword做了修改，两者比对发现不一致，则切换到重量锁。</li><li><strong>尝试获取锁线程视角：</strong>如果线程尝试获取锁的时候，轻量锁正被其他线程占有，那么它就会修改markword，修改重量级锁，表示该进入重量锁了。还有一个注意点：等待轻量锁的线程不会阻塞，它会一直自旋等待锁，当然这也有次数限制，不会一直自旋。得到锁后会修改markword。这就是自旋锁，尝试获取锁的线程，在没有获得锁的时候，不被挂起，而转而去执行一个空循环，即自旋。在若干个自旋后，如果还没有获得锁，则才被挂起，获得锁，则执行代码。</li></ul><h5 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h5><p>自旋锁原理非常简单，实际上是一种冒险的思想，假设当前持有锁的线程能在很短时间内释放锁资源，那么那些等待竞争锁的线程就不需要做内核态和用户态之间的切换进入阻塞挂起状态，那么它们只需要等一等（自旋），自旋其实就是一个空循环，什么都不做，但是占用CPU的资源。等持有锁的线程释放锁后即可立即获取锁，这样就<strong>避免了用户线程和内核的切换的消耗</strong>。这样做有利有弊，它不能代替阻塞。自旋等待虽然避免了线程切换的开销，但它要占用处理器时间。如果锁被占用的时间很短，自旋等待的效果就会非常好。反之，如果锁被占用的时间很长，那么自旋的线程只会白浪费处理器资源。但相比在大量线程并发情况下进入线程调度，这么做确实值得。自旋等待的时间必须要有一定的限度，如果自旋超过了限定次数（默认是10次，可以使用<code>-XX:PreBlockSpin</code>来更改）没有成功获得锁，就会当挂起线程。自旋锁在JDK1.4.2中引入，使用<code>-XX:+UseSpinning</code>来开启。JDK 6中变为默认开启，并且引入了自适应的自旋锁（适应性自旋锁）。</p><ul><li><strong>自适应自旋：</strong>自适应意味着自旋的时间（次数）不再固定，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。如果在同一个锁对象上，自旋等待刚刚成功获得过锁，并且持有锁的线程正在运行中，那么虚拟机就会认为这次自旋也是很有可能再次成功，进而它将允许自旋等待持续相对更长的时间。如果对于某个锁，自旋很少成功获得过，那在以后尝试获取这个锁时将可能省略掉自旋过程，直接阻塞线程，避免浪费处理器资源。</li></ul><p>正如前面所说，自旋锁一般发生在获取轻量级锁的过程中，当获取轻量级锁时会使用自旋锁等待。并升级为重量级锁</p><h5 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h5><p>重量锁在JVM中又叫对象监视器（Monitor），它很像C中的Mutex，除了具备Mutex(0|1)互斥的功能，它还负责实现了Semaphore(信号量)的功能，也就是说它至少包含一个竞争锁的队列，和一个信号阻塞队列（wait队列），前者负责做互斥，后一个用于做线程同步。重量级锁通过对象内部的监视器（monitor）实现，其中monitor的本质是依赖于底层操作系统的Mutex Lock实现，操作系统实现线程之间的切换需要从用户态到内核态的切换，切换成本非常高。在Java中，重量级锁的实现就是Synchronized关键字。它可以把任意一个非null的对象当作锁。Synchronized的实现如下图</p><p><img src="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/lock.png" alt></p><p>当多个线程一起访问某个对象监视器的时候，对象监视器会将这些线程存储在不同的容器中：</p><ul><li><strong>Contention List：</strong>争队列，所有请求锁的线程首先被放在这个竞争队列中</li><li><strong>Entry List：</strong>Contention List中那些有资格成为候选资源的线程被移动到Entry List中</li><li><strong>Waiting Set：</strong>调用wait方法被阻塞的线程被放置在这里</li><li><strong>OnDeck：</strong>任意时刻，最多只有一个线程正在竞争锁资源，该线程被成为OnDeck</li><li><strong>Owner：</strong>当前已经获取到所资源的线程被称为Owner</li></ul><p>JVM每次从队列的尾部取出一个数据用于锁竞争候选者（OnDeck），但是并发情况下，Contention List会被大量的并发线程进行CAS访问，为了降低对尾部元素的竞争，JVM会将一部分线程移动到Entry List中作为候选竞争线程。Owner线程会在unlock时，将Contention List中的部分线程迁移到Entry List中，并指定Entry List中的某个线程为OnDeck线程（一般是最先进去的那个线程）。Owner线程并不直接把锁传递给OnDeck线程，而是把锁竞争的权利交给OnDeck，OnDeck需要重新竞争锁。这样虽然牺牲了一些公平性，但是能极大的提升系统的吞吐量，在JVM中，也把这种选择行为称之为“竞争切换”。OnDeck线程获取到锁资源后会变为Owner线程，而没有得到锁资源的仍然停留在Entry List中。如果Owner线程被wait方法阻塞，则转移到Wait Set队列中，直到某个时刻通过notify或者notifyAll唤醒，会重新进去Entry List中。处于Contention List、Entry List、Wait Set中的线程都处于阻塞状态，该阻塞是由操作系统来完成的（Linux内核下采用pthread_mutex_lock内核函数实现的）。<strong>Synchronized是非公平锁</strong>， Synchronized在线程进入ContentionList时，等待的线程会先尝试自旋获取锁，如果获取不到就进入ContentionList，这明显对于已经进入队列的线程是不公平的，还有一个不公平的事情就是自旋获取锁的线程还可能直接抢占OnDeck线程的锁资源。</p><h5 id="Synchronized的执行过程"><a href="#Synchronized的执行过程" class="headerlink" title="Synchronized的执行过程"></a>Synchronized的执行过程</h5><ol><li>检测Mark Word里面是不是当前线程的ID，如果是，表示当前线程处于偏向锁 </li><li>如果不是，则使用CAS将当前线程的ID替换Mard Word，如果成功则表示当前线程获得偏向锁，置偏向标志位1 </li><li>如果失败，则说明发生竞争，撤销偏向锁，进而升级为轻量级锁。 </li><li>当前线程使用CAS将对象头的Mark Word替换为锁记录指针，如果成功，当前线程获得锁 </li><li>如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁。 </li><li>如果自旋成功则依然处于轻量级状态。 </li><li>如果自旋失败，则升级为重量级锁。</li></ol><p>上面几种锁都是JVM自己内部实现，当我们执行synchronized同步块的时候jvm会根据启用的锁和当前线程的争用情况，决定如何执行同步操作。在所有的锁都启用的情况下线程进入临界区时会先去获取偏向锁，如果已经存在偏向锁了，则会尝试获取轻量级锁，启用自旋锁，如果自旋也没有获取到锁，则使用重量级锁，没有获取到锁的线程阻塞挂起，直到持有锁的线程执行完同步块唤醒他们。偏向锁是在无锁争用的情况下使用的，也就是同步开在当前线程没有执行完之前，没有其它线程会执行该同步块，一旦有了第二个线程的争用，偏向锁就会升级为轻量级锁，如果轻量级锁自旋到达阈值后，没有获取到锁，就会升级为重量级锁。</p><h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p>我们已经知道，synchronized 是Java的关键字，是Java的内置特性，在JVM层面实现了对临界资源的同步互斥访问，但 synchronized 粒度有些大，在处理实际问题时存在诸多局限性，比如响应中断等。Lock 提供了比 synchronized更广泛的锁操作，它能以更优雅的方式处理线程同步问题。Lock锁是Java代码级别来实现的，相对于synchronizedd在功能性上，有所加强，主要是，公平锁，轮询锁，定时锁，可中断锁等，还增加了多路通知机制（Condition），可以用一个锁来管理多个同步块。另外在使用的时候，必须手动的释放锁。</p><h5 id="Lock接口的基本思想"><a href="#Lock接口的基本思想" class="headerlink" title="Lock接口的基本思想"></a>Lock接口的基本思想</h5><p>需要实现锁的功能，有两个必备元素：</p><ol><li>一个表示状态的变量（我们假设0表示没有线程获取锁，1表示已有线程占有锁），并把该变量声明为voaltile类型</li><li>一个FIFO队列，队列中的节点表示因未能获取锁而阻塞的线程。</li></ol><p>在java.util.concurrent.locks包中有很多Lock的实现类，如ReentrantLock、ReadWriteLock（实现类ReentrantReadWriteLock），其实现都依赖java.util.concurrent.AbstractQueuedSynchronizer类，实现思路大同小异，下面主要讲ReentrantLock。ReentrantLock把所有Lock接口的操作都委派到Sync类上，该类继承了AbstractQueuedSynchronizer，多数需要覆盖的方法都是在Sync类实现的，而NonfairSync、FairSync只是在tryAcquire方法和lock方法上有所不同。那么来看看AbstractQueuedSynchronizer（下面简称AQS）到底干了什么吧。类关系图如下：</p><p><img src="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/locks.png" alt></p><p>其中ReentrantLock中包含FairSync和NonfairSync，FairSync 与 NonfairSync的区别在于，是不是保证获取锁的公平性。在源代码中的体现如下：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable <span class="token punctuation">{</span>     <span class="token keyword">private</span> <span class="token keyword">final</span> Sync sync<span class="token punctuation">;</span>     <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>     <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">//构造函数-默认是非公平锁</span>     <span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//构造函数-带参可设置公平与非公平锁</span>     <span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="ReentrantLock加锁原理"><a href="#ReentrantLock加锁原理" class="headerlink" title="ReentrantLock加锁原理"></a>ReentrantLock加锁原理</h3><p>简单说来，AbstractQueuedSynchronizer会把所有的请求线程构成一个CLH队列，当一个线程执行完毕（lock.unlock()）时会激活自己的后继节点，但正在执行的线程并不在队列中，而那些等待执行的线程全部处于阻塞状态，经过调查线程的显式阻塞是通过调用LockSupport.park()完成，而LockSupport.park()则调用sun.misc.Unsafe.park()本地方法，再进一步，HotSpot在<a href="http://lib.csdn.net/base/linux" target="_blank" rel="noopener">Linux</a>中中通过调用pthread_mutex_lock函数把线程交给系统内核进行阻塞。首先来看加锁操作的lock()方法，源码如下：</p><pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>if 条件的第一个分支是使用CAS操作，将锁状态更新为1，1表示当前线程成功占有锁。如果返回true的话是正常流程，表示当前线程成功的抢到了锁，然后就会执行业务代码了。如果已经有别的线程占有了锁，CAS会失败，返回false，则会进入第二个分支，重点来看看这个分支的逻辑。acquire源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>我们看到这个if条件中有两个条件，代码比较简洁，但做的事情并不简单。这里主要做了三件事情：</p><ol><li>tryAcquire：会尝试再次通过CAS获取一次锁。</li><li>addWaiter：将当前线程加入上面锁的双向链表（等待队列）中</li><li>acquireQueued：通过自旋，判断当前队列节点是否可以获取锁。</li></ol><p>下面重点分析一下这三件事情是怎么做的，tryAcquire方法比较简单，就是通过CAS再做一次获取锁的尝试，就不多说了。尝试获取锁失败后，返回false，这里取了反，判断为真，因此会进入acquireQueued方法，先来看一下addWaiter方法，该方法源码如下：</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Node <span class="token function">addWaiter</span><span class="token punctuation">(</span>Node mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Node node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Try the fast path of enq; backup to full enq on failure</span>        Node pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>                <span class="token keyword">return</span> node<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> node<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>这个方法第一步首先把当前线程包装成了一个Node对象。假设当前没有线程获得锁，当Thread1获取锁执行到这个方法，这时肯定是没有头节点的，因此第5行代码的 if 分支不会进去，直接执行 enq 方法。如此继续看enq方法的源码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Node <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Node t <span class="token operator">=</span> tail<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Must initialize</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    tail <span class="token operator">=</span> head<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>从这里代码可以看出，在没有线程获得锁，第一次循环时，tail肯定是null，因此会进入第4行的分支，这里代码很简单创建了一个头节点，注意这个头节点没有任何参数，也就是说 HEAD 节点不关联线程。然后进行第二次循环，进入第7行的分支，把当前节点的prev指向刚刚创建的头节点，同时把头节点的next指向当前节点，形成一个双向链表，并返回当前线程的Node对象。接着来看acquireQueued方法，源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//返回当前节点的前节点</span>                <span class="token keyword">final</span> Node p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>首先获取了当前节点的前节点，判断前节点是否为HEAD节点，注意前面说过HEAD节点是不与任务线程关联的节点，仅仅只是做链表头的作用。因此当前节点的前节点为HEAD时，说明当前节点排在链表的最前面了。因此当前节点会通过tryAcquire方法尝试去获取锁，如果成功了直接返回false。如果失败则会进入第14行的分支代码，源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>Node pred<span class="token punctuation">,</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">do</span> <span class="token punctuation">{</span>                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>举个例子假设Thread1已经获得了锁，Thread2和Thread3要去竞争锁。对于 Thread2 来说，它的 prev 指向 HEAD，因此会首先再尝试获取锁一次，如果失败，则会将 HEAD 的 waitStatus 值为 SIGNAL，下次循环的时候再去尝试获取锁，如果还是失败，且这个时候 prev 节点的 waitStatus 已经是 SIGNAL，则这个时候线程会被通过 LockSupport 挂起。对于 Thread3 来说，它的 prev 指向 Thread2，因此直接看看 Thread2 对应的节点的 waitStatus 是否为 SIGNAL，如果不是则将它设置为 SIGNAL，再给自己一次去看看自己有没有资格获取锁，如果 Thread2 还是挡在前面，且它的 waitStatus 是 SIGNAL，则将自己挂起。如果 Thread1 死死的握住锁不放，那么 Thread2 和 Thread3 现在的状态就是挂起状态啦，而且 HEAD，以及 Thread 的 waitStatus 都是 SIGNAL，尽管他们在整个过程中曾经数次去尝试获取锁，但是都失败了，失败了不能死循环呀，所以就被挂起了。挂起的方法是通过parkAndCheckInterrupt做的</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>其中LockSupport.park(this)就会调用系统级别的函数将当前线程挂起。此时线程状态图如下：</p><p><img src="/2019/04/23/java-bing-fa-bian-cheng-java-zhong-de-suo/AQS.png" alt></p><h5 id="重入锁"><a href="#重入锁" class="headerlink" title="重入锁"></a>重入锁</h5><p>重入锁指的是当前线成功获取锁后，如果再次访问该临界区，则不会对自己产生互斥行为。Java中对ReentrantLock和synchronized都是可重入锁，synchronized由jvm实现可重入，ReentrantLock都可重入性基于AQS实现。同时，<code>ReentrantLock</code>还提供<code>公平锁</code>和<code>非公平锁</code>两种模式。重入锁的基本原理是判断上次获取锁的线程是否为当前线程，如果是则可再次进入临界区，如果不是，则阻塞。由于<code>ReentrantLock</code>是基于<code>AQS</code>实现的，底层通过操作同步状态来获取锁，下面看一下非公平锁的实现逻辑：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//获取当前线程</span>            <span class="token keyword">final</span> Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//通过AQS获取同步状态</span>            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//同步状态为0，说明临界区处于无锁状态，</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//修改同步状态，即加锁</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//将当前线程设置为锁的owner</span>                    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//如果临界区处于锁定状态，且上次获取锁的线程为当前线程</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//则递增同步状态</span>                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// overflow</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>重入锁的最主要逻辑就锁判断上次获取锁的线程是否为当前线程。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java并发编程-JVM架构与GC</title>
      <link href="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/"/>
      <url>/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/</url>
      
        <content type="html"><![CDATA[<p>作为一名Java开发者，掌握JVM的体系结构也是很有必要的，了解底层的东西，有助于更好的理解和掌握程序运行中的原理。JVM是Java Virtual Machine（Java虚拟机）的缩写，JVM是一种用于计算设备的规范，它是一个虚构出来的计算机，是通过在实际的计算机上仿真模拟各种计算机功能来实现的。Java虚拟机包括一套字节码指令集、一组寄存器、一个栈、一个垃圾回收堆和一个存储方法域。 JVM屏蔽了与具体操作系统平台相关的信息，使Java程序只需生成在Java虚拟机上运行的目标代码（字节码）,就可以在多种平台上不加修改地运行。JVM在执行字节码时，实际上最终还是把字节码解释成具体平台上的机器指令执行。JVM伴随Java程序的开始而开始，程序的结束而停止。一个Java程序会开启一个JVM进程，一台计算机上可以运行多个程序，也就可以运行多个JVM进程。JVM将线程分为两种：守护线程和普通线程。守护线程是JVM自己使用的线程，比如垃圾回收（GC）就是一个守护线程。普通线程一般是Java程序的线程，只要JVM中有普通线程在执行，那么JVM就不会停止。</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/jvm.png" alt></p><a id="more"></a> <h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p>JRE由Java API和JVM组成，JVM通过类加载器(Class Loader)加类Java应用，并通过Java API进行执行。</p><p><strong>虚拟机(VM: Virtual Machine)</strong>是通过软件模拟物理机器执行程序的执行器。最初Java语言被设计为基于虚拟机器在而非物理机器，重而实现一次编写，到处运行的目的，尽管这个目标几乎被世人所遗忘。所以，JVM可以在所有的硬件环境上执行Java字节码而无须调整Java的执行模式。</p><p>JVM的基本特性：</p><ul><li><strong>基于栈(Stack-based)的虚拟机</strong>: 不同于Intel x86和ARM等比较流行的计算机处理器都是基于<em>寄存器(register)</em>架构，JVM是<em>基于栈执行的</em>。</li><li><strong>符号引用(Symbolic reference)</strong>: 除基本类型外的所有Java类型(类和接口)都是通过符号引用取得关联的，而非显式的基于内存地址的引用。</li><li><strong>垃圾回收机制</strong>: 类的实例通过用户代码进行显式创建，但却通过垃圾回收机制自动销毁。</li><li><strong>通过明确清晰基本类型确保平台无关性</strong>: 像C/C++等传统编程语言对于int类型数据在同平台上会有不同的字节长度。JVM却通过明确的定义基本类型的字节长度来维持代码的平台兼容性，从而做到平台无关。</li><li><strong>网络字节序(Network byte order)</strong>: Java class文件的二进制表示使用的是基于网络的字节序(network byte order)。为了在使用小端(little endian)的Intel x86平台和在使用了大端(big endian)的RISC系列平台之间保持平台无关，必须要定义一个固定的字节序。JVM选择了网络传输协议中使用的网络字节序，即基于大端(big endian)的字节序。</li></ul><p>Sun 公司开发了Java语言，但任何人都可以在遵循JVM规范的前提下开发和提供JVM实现。所以目前业界有多种不同的JVM实现，包括Oracle Hostpot JVM和IBM JVM。Google公司使用的Dalvik VM也是一种JVM实现，尽管其并未完全遵循JVM规范。与基于栈机制的Java 虚拟机不同的是Dalvik VM是基于寄存器的，Java 字节码也被转换为Dalvik VM使用的寄存器指令集。</p><h2 id="JRE、JDK和JVM的关系"><a href="#JRE、JDK和JVM的关系" class="headerlink" title="JRE、JDK和JVM的关系"></a>JRE、JDK和JVM的关系</h2><ol><li>*<em>JRE（Java Runtime Environment， Java运行环境）: *</em>是Java的运行环境，所有的程序都要在JRE下才能够运行。包括JVM和Java核心类库和支持文件。</li><li>*<em>JDK（Java Development Kit，Java开发工具包）: *</em>用来编译、调试Java程序的开发工具包。包括Java工具（javac/java/jdb等）和Java基础的类库（java API ）。</li><li><strong>JVM（Java Virtual Machine， Java虚拟机）：</strong>是JRE的一部分。JVM主要工作是解释自己的指令集（即字节码）并映射到本地的CPU指令集和OS的系统调用。Java语言是跨平台运行的，不同的操作系统会有不同的JVM映射规则，使之与操作系统无关，完成跨平台性。</li></ol><p>使用JDK（调用JAVA API）开发JAVA程序后，通过JDK中的编译程序（javac）将Java程序编译为Java字节码，在JRE上运行这些字节码，JVM会解析并映射到真实操作系统的CPU指令集和OS的系统调用。下图表示了JDK、JRE和JVM三者间的关系：</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/javas.png" alt></p><h2 id="JVM架构"><a href="#JVM架构" class="headerlink" title="JVM架构"></a>JVM架构</h2><p>JVM被分为三个主要的子系统：（1）类加载器子系统（2）运行时数据区（3）执行引擎</p><h3 id="类装载子系统"><a href="#类装载子系统" class="headerlink" title="类装载子系统"></a>类装载子系统</h3><p>在JAVA虚拟机中，负责查找并装载类型的那部分被称为类装载子系统。JAVA虚拟机有两种类装载器：启动类装载器和用户自定义类装载器。前者是JAVA虚拟机实现的一部分，后者则是Java程序的一部分。由不同的类装载器装载的类将被放在虚拟机内部的不同命名空间中。类装载器子系统涉及Java虚拟机的其他几个组成部分，以及几个来自java.lang库的类。比如，用户自定义的类装载器是普通的Java对象，它的类必须派生自java.lang.ClassLoader类。ClassLoader中定义的方法为程序提供了访问类装载器机制的接口。此外，对于每一个被装载的类型，JAVA虚拟机都会为它创建一个java.lang.Class类的实例来代表该类型。和所有其他对象一样，用户自定义的类装载器以及Class类的实例都放在内存中的堆区，而装载的类型信息则都位于方法区。类装载器子系统除了要定位和导入二进制class文件外，还必须负责验证被导入类的正确性，为类变量分配并初始化内存，以及帮助解析符号引用。类加载系统主要分为三个部分，而且类的加载动作必须严格按以下顺序进行：</p><p><strong>装载：</strong>装载过程负责找到二进制字节码并加载至JVM中，JVM通过类名、类所在的包名通过ClassLoader来完成类的加载，同样，也采用以上三个元素来标识一个被加载了的类：类名+包名+ClassLoader实例ID，因此不同类加载器加载相同的类是不同的。有继承，将先在加载父类。</p><p><strong>连接：</strong>链接过程负责对二进制字节码的格式进行：校验、解析类中调用的接口、类。校验是防止不合法的.class文件，然后 对类中的所有属性、调用方法进行解析，以确保其需要调用的属性、方法存在，以及具备应的权限（例如public、private域权限等），会造成NoSuchMethodError、NoSuchFieldError等错误信息。</p><ul><li><strong>验证：</strong>确保被导入类型的正确性。（java可以自定义安全策略等）</li><li><strong>准备：</strong>为类的静态变量分配内存，并将其初始化为默认值</li><li><strong>解析：</strong>把类中的符号引用转化为直接引用</li></ul><p><strong>初始化：</strong>初始化过程即为执行类中的静态初始化代码、构造器代码以及静态属性的初始化。在四种情况下初始化过程会被触发执行。1.调用了new；2.反射调用了类中的方法；3.子类调用了初始化（先执行父类静态代码和静态成员，再执行子类静态代码和静态变量，然后调用父类构造器，最后调用自身构造器。）；4. JVM启动过程中指定的初始化类。 类加载系统使用双亲委派模型来确保每个类被正确的加载。每个类装载器都有自己的命名空间，其中维护着由它装载的类型。所以一个Java程序可以多次装载具有同一个全限定名的多个类型。这样一个类型的全限定名就不足以确定在一个Java虚拟机中的唯一性。因此，当多个类装载器都装载了同名的类型时，为了惟一地标识该类型，还要在类型名称前加上装载该类型（指出它所位于的命名空间）的类装载器标识。</p><h2 id="运行时数据区"><a href="#运行时数据区" class="headerlink" title="运行时数据区"></a>运行时数据区</h2><p>运行时数据区域被划分为五个主要组件：</p><p><strong>Java堆（Heap）：</strong> 对于大多数应用来说，Java堆（Java Heap）是Java虚拟机所管理的内存中最大的一块。Java堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。 Java堆是垃圾收集器管理的主要区域，因此很多时候也被称做GC堆。如果从内存回收的角度看，由于现在收集器基本都是采用的分代收集算法。根据Java虚拟机规范的规定，Java堆可以处于物理上不连续的内存空间中，只要逻辑上是连续的即可，就像我们的磁盘空间一样。在实现时，既可以实现成固定大小的，也可以是可扩展的，不过当前主流的虚拟机都是按照可扩展来实现的（通过-Xmx和-Xms控制）。如果在堆中没有内存完成实例分配，并且堆也无法再扩展时，将会抛出OutOfMemoryError异常。</p><p><strong>Java堆（Heap）：</strong>方法区（Method Area）与Java堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。每个JVM只有一个方法区，它是一个共享的资源。根据Java虚拟机规范的规定，当方法区无法满足内存分配需求时，将抛出OutOfMemoryError异常。 </p><p><strong>程序计数器（Program Counter Register）：</strong>程序计数器（Program Counter Register）是一块较小的内存空间，它的作用可以看做是当前线程所执行的字节码的行号指示器。在虚拟机的概念模型里（仅是概念模型，各种虚拟机可能会通过一些更高效的方式去实现），字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。 此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</p><p><strong>JVM栈（JVM Stacks）：</strong>与程序计数器一样，Java虚拟机栈（Java Virtual Machine Stacks）也是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法被执行的时候都会同时创建一个栈帧（Stack Frame）用于存储局部变量表、操作栈、动态链接、方法出口等信息。每一个方法被调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。栈帧被分为三个子实体</p><ul><li><strong>局部变量数组：</strong>  包含多少个与方法相关的局部变量并且相应的值将被存储在这里。</li><li><strong>操作数栈：</strong>  如果需要执行任何中间操作，操作数栈作为运行时工作区去执行指令。</li><li><strong>帧数据：</strong> 方法的所有符号都保存在这里。在任意异常的情况下，catch块的信息将会被保存在帧数据里面。</li></ul><p><strong>本地方法栈（Native Method Stacks）：</strong>本地方法栈（Native Method Stacks）与虚拟机栈所发挥的作用是非常相似的，其区别不过是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是为虚拟机使用到的Native方法服务。虚拟机规范中对本地方法栈中的方法使用的语言、使用方式与数据结构并没有强制规定，因此具体的虚拟机可以自由实现它。甚至有的虚拟机（譬如Sun HotSpot虚拟机）直接就把本地方法栈和虚拟机栈合二为一。与虚拟机栈一样，本地方法栈区域也会抛出StackOverflowError和OutOfMemoryError异常。</p><h2 id="执行引擎"><a href="#执行引擎" class="headerlink" title="执行引擎"></a>执行引擎</h2><p>执行引擎在执行Java代码时候可能会有解释执行和编译执行两种选择，也可能两者兼备，甚至还可能会包含几个不同级别的编译器执行引擎。</p><ol><li>解释执行：解释器能快速的解释字节码，但执行却很慢。 解释器的缺点就是,当一个方法被调用多次，每次都需要重新解释。</li><li>编译执行：JIT编译器消除了解释器的缺点。执行引擎利用解释器转换字节码，但如果是重复的代码则使用JIT编译器将全部字节码编译成本机代码。本机代码将直接用于重复的方法调用，这提高了系统的性能。</li></ol><p>当主流的虚拟机中都包含了即时编译器后，Class文件中的代码到底会被解释执行还是编译执行，只有虚拟机自己才能准确判断。Javac编译器完成了程序代码经过词法分析、语法分析到抽象语法树，再遍历语法树生成线性的字节码指令流的过程。因为这一动作是在Java虚拟机之外进行的，而解释器在虚拟机的内部，所以Java程序的编译是半独立的实现。Java程序最初是通过解释器进行解释执行的，当虚拟机发现某个方法或代码块的运行特别频繁，就会把这些代码认定为“热点代码”（Hot Spot Code）。为了提高热点代码的执行效率，在运行时，虚拟机将会把这些代码编译成与本地平台相关的机器码，并进行各种层次的优化，完成这个任务的编译器成为即时编译器（Just In Time Compiler，JIT编译器）当程序需要快速启动和执行时，解释器首先发挥作用，省去编译的时间，立即执行当程序运行后，随着时间的推移，编译器逐渐发挥作用，把越来越多的代码编译成本地代码，可以提高执行效率如果内存资源限制较大（部分嵌入式系统），可以使用解释执行节约内存，反之可以使用编译执行来提升效率。同时编译器的代码还能退回成解释器的代码。编译器主要分为四个部分，分别如下：</p><ul><li><strong>中间代码生成器：</strong> 生成中间代码</li><li><strong>代码优化器：</strong> 负责优化上面生成的中间代码</li><li><strong>目标代码生成器：</strong>负责生成机器代码或本机代码</li><li><strong>探测器(Profiler)：</strong> 一个特殊的组件，负责寻找被多次调用的方法。</li></ul><p>执行引擎中最频繁的就是方法调用，方法调用的主要任务就是确定被调用方法的版本(即调用哪一个方法),该过程不涉及方法具体的运行过程.按照调用方式共分为两类:</p><ol><li>解析调用时是静态的过程,在编译期间就完全确定目标方法。</li><li>分派调用则即可能是静态,也可能是动态的,根据分派标准可以分为单分派和多分派。两两组合有形成了静态单分派、静态多分派、动态单分派、动态多分派</li></ol><p>简单理解来说静态分派的典型应用是方法的重载，动态分派的典型应用是方法的重写。至于单分派和多分派就是方法的接收者与方法的参数统称为方法的宗量。根据分派基于多少种宗量，可以将分派划分为单分派和多分派两种。单分派是根据一个宗量对目标方法进行选择，多分派则是根据多于一个宗量对目标方法进行选择。至此，除了垃圾回收器，JVM的各个部分基本都说到了，下面将着重了解垃圾收集器，它是一个重要的组件，正是由于它的存在才使得Java开发者不用像C++开发者那样去管理令人头皮发麻的运行时内存，同时它也是JVM调优的重要阵地。下图是整个JVM的架构图</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/jvmjg.png" alt></p><h2 id="对象的内存分布"><a href="#对象的内存分布" class="headerlink" title="对象的内存分布"></a>对象的内存分布</h2><p>在 HotSpot 虚拟机中，分为 3 块区域：对象头(Header)、实例数据(Instance Data)和对齐填充(Padding)</p><ol><li>对象头(Header)：包含两部分，第一部分用于存储对象自身的运行时数据，如哈希码、GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等，32 位虚拟机占 32 bit，64 位虚拟机占 64 bit。官方称为 Mark Word。第二部分是类型指针，即对象指向它的类的元数据指针，虚拟机通过这个指针确定这个对象是哪个类的实例。另外，如果是 Java 数组，对象头中还必须有一块用于记录数组长度的数据，因为普通对象可以通过 Java 对象元数据确定大小，而数组对象不可以。</li><li><code>实例数据(Instance Data)</code>：程序代码中所定义的各种类型的字段内容(包含父类继承下来的和子类中定义的)。</li><li><code>对齐填充(Padding)</code>：不是必然需要，主要是占位，保证对象大小是某个字节的整数倍。</li></ol><p>当对象被创建了后，Java程序需要通过栈上的reference引用来操作堆上的具体对象。由于reference类型在Java虚拟机规范中只规定了一个指向对象的引用，并没有定义这个引用应该通过何种方式去定位、访问堆中的对象的具体位置，所以对象访问方法也是取决于虚拟机的实现而决定的。目前主流的访问方式有 <strong>句柄访问</strong> 和 <strong>指针访问</strong> 两种。</p><p><strong>句柄访问：</strong>Java 堆中会分配一块内存作为句柄池。reference 存储的是句柄地址。详情见图。</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/jbfw.png" alt></p><p><strong>指针访问：</strong>reference 中直接存储对象地址</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/zjfw.png" alt></p><p>使用句柄的最大好处是 reference 中存储的是稳定的句柄地址，在对象移动(GC)是只改变实例数据指针地址，reference 自身不需要修改。直接指针访问的最大好处是速度快，节省了一次指针定位的时间开销。如果是对象频繁 GC 那么句柄方法好，如果是对象频繁访问则直接指针访问好。</p><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>说起垃圾回收（GC），大部分人都把这项技术当做Java语言的伴生产物。事实上，GC的历史比Java久远，早在1960年Lisp这门语言中就使用了内存动态分配和垃圾回收技术。 JAVA GC（Garbage Collection，垃圾回收）机制是区别C++的一个重要特征，C++需要开发者自己实现垃圾回收的逻辑，而JAVA开发者则只需要专注于业务开发，因为垃圾回收这件繁琐的事情JVM已经为我们代劳了，从这一点上来说，JAVA还是要做的比较完善一些。但这并不意味着我们不用去理解GC机制的原理，因为如果不了解其原理，可能会引发内存泄漏、频繁GC导致应用卡顿,甚至出现OOM等问题，因此我们需要深入理解其原理，才能编写出高性能的应用程序，解决性能瓶颈。在Java中垃圾回收主要针对堆区，垃圾收集器在对堆区和方法区进行回收前，首先要确定这些区域的对象哪些可以被回收，哪些暂时还不能回收，这就要用到判断对象是否存活的算法！</p><h4 id="堆区的查找算法"><a href="#堆区的查找算法" class="headerlink" title="堆区的查找算法"></a>堆区的查找算法</h4><p>JVM中判断对象是否存活的算法主要有两种。1. 引用计数法，2. 根搜索算法</p><p><strong>(1) . 引用计数法：</strong>引用计数是垃圾收集器中的早期策略。在这种方法中，堆中每个对象实例都有一个引用计数。当一个对象被创建时，就将该对象实例分配给一个变量，该变量计数设置为1。当任何其它变量被赋值为这个对象的引用时，计数加1（a = b,则b引用的对象实例的计数器+1），但当一个对象实例的某个引用超过了生命周期或者被设置为一个新值时，对象实例的引用计数器减1。任何引用计数器为0的对象实例可以被当作垃圾收集。当一个对象实例被垃圾收集时，它引用的任何对象实例的引用计数器减1。引用计数法的优点是引用计数收集器可以很快的执行，交织在程序运行中。对程序需要不被长时间打断的实时环境比较有利，而缺点也很明显，它不能解决循环引用的问题。</p><p><strong>(2) . 可达性分析</strong>：此算法是从离散数学中的图论引入的，程序把所有的引用关系看作一张图，从一个节点GC ROOT开始，寻找对应的引用节点，找到这个节点以后，继续寻找这个节点的引用节点，当所有的引用节点寻找完毕之后，剩余的节点则被认为是没有被引用到的节点，即无用的节点，无用的节点将会被判定为是可回收的对象。</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/gcroot.png" alt></p><p>根搜索算法的核心在于GC Root，在Java语言中，可作为GC Root的对象包括下面几种：</p><ul><li>虚拟机栈中引用的对象（栈帧中的本地变量表）；</li><li>方法区中类静态属性引用的对象；</li><li>方法区中常量引用的对象；</li><li>本地方法栈中JNI（Native方法）引用的对象。</li></ul><p>无论是通过引用计数算法判断对象的引用数量，还是通过可达性分析算法判断对象的引用链是否可达，判定对象是否存活都与“引用”有关。在Java语言中，将引用又分为强引用、软引用、弱引用、虚引用4种，这四种引用强度依次逐渐减弱。</p><ul><li><strong>强引用：</strong>类似 <code>Object obj = new Object()</code> 这类引用都是强引用，只要强引用还存在，垃圾收集器永远不会回收掉被引用的对象，即使抛出OOM异常。 </li><li><strong>软引用：</strong>用来描述一些还有用但并非必须的对象，只有当JVM内存不足时才会被回收</li><li><strong>弱引用：</strong>也是用来描述非必需对象的，但是它的强度比软引用更弱一些。只要GC,就会立马回收，不管内存是否充足。 </li><li><strong>虚引用：</strong>也叫幽灵引用或幻影引用，是最弱的一种引用关系。可以忽略不计，JVM完全不会在乎虚引用。它唯一的作用就是做一些跟踪记录，辅助finalize函数的使用。</li></ul><h4 id="方法区的查找算法"><a href="#方法区的查找算法" class="headerlink" title="方法区的查找算法"></a>方法区的查找算法</h4><p>方法区存储内容是否需要回收与堆区的判断方法有一些区别。方法区主要回收的内容有：废弃常量和无用的类。对于废弃常量也可通过引用的可达性来判断，但是对于无用的类则需要同时满足下面三个条件：</p><ul><li>该类所有的实例都已经被回收；</li><li>加载该类的<code>ClassLoader</code>已经被回收；</li><li>该类对应的<code>java.lang.Class</code>对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li></ul><h2 id="GC算法"><a href="#GC算法" class="headerlink" title="GC算法"></a>GC算法</h2><h5 id="标记-清除算法（Mark-Sweep）"><a href="#标记-清除算法（Mark-Sweep）" class="headerlink" title="标记-清除算法（Mark-Sweep）"></a>标记-清除算法（Mark-Sweep）</h5><p>如它的名字一样，算法分为“标记”和“清除”两个阶段：首先标记出所有需要回收的对象，标记完毕后再扫描整个空间中未被标记的对象进行回收。之所以说它是最基础的收集算法，是因为后续的收集算法都是基于这种思路并对其缺点进行改进而得到的。标记-清除算法不需要进行对象的移动，只需对不存活的对象进行处理，在存活对象比较多的情况下极为高效，但由于标记-清除算法直接回收不存活的对象，因此会造成内存碎片。此外空间碎片太多可能会导致，当程序在以后的运行过程中需要分配较大对象时无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作。</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/bj.png" alt></p><h5 id="复制算法（Copying）"><a href="#复制算法（Copying）" class="headerlink" title="复制算法（Copying）"></a>复制算法（Copying）</h5><p>复制算法的提出是为了克服句柄的开销和解决内存碎片的问题。它将可用内存按容量划分为大小相等的两块，每次只使用其中的一块。当这一块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。样使得每次都是对其中的一块进行内存回收，内存分配时也就不用考虑内存碎片等复杂情况，只要移动堆顶指针，按顺序分配内存即可，实现简单，运行高效。只是这种算法的代价是将内存缩小为原来的一半，持续复制长生存期的对象则导致效率降低。</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/fz.png" alt></p><h5 id="标记-整理算法-Mark-compact"><a href="#标记-整理算法-Mark-compact" class="headerlink" title="标记-整理算法(Mark-compact)"></a>标记-整理算法(Mark-compact)</h5><p>复制收集算法在对象存活率较高时就要执行较多的复制操作，效率将会变低。更关键的是，如果不想浪费50%的空间，就需要有额外的空间进行分配担保，以应对被使用的内存中所有对象都100%存活的极端情况，所以在老年代一般不能直接选用这种算法。根据老年代的特点，有人提出了另外一种“标记-整理”（Mark-Compact）算法，标记过程仍然与“标记-清除”算法一样。在清除时不同，在回收不存活的对象占用的空间后，会将所有的存活对象往左端空闲空间移动，并更新对应的指针<strong>。标记-整理算法是在标记-清除算法的基础上，又进行了对象的移动</strong>，因此成本更高，但是却解决了内存碎片的问题</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/bjzl.png" alt></p><h5 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h5><p>GC分代的基本假设：绝大部分对象的生命周期都非常短暂，存活时间短。分代收集（Generational Collection）算法，把Java堆分为新生代和老年代，这样就可以根据各个年代的特点采用最适当的收集算法。在新生代中，每时每刻都大量的对象创建和死亡，处于新生代的对象可以说是朝生夕死，每次垃圾收集时都有大批对象死去，只有少量存活，适用于复制算法，只需要付出少量存活对象的复制成本就可以完成收集。而老年代中因为对象存活率高、没有额外空间对它进行分配担保，就必须使用“标记-清理”或“标记-整理”算法来进行回收。堆内存由<strong>年轻代</strong>和<strong>老年代</strong>组成，而年轻代内存又被分成三部分，<strong>Eden空间</strong>、<strong>From Survivor空间</strong>、<strong>To Survivor空间</strong>,默认情况下年轻代按照8:1:1的比例来分配</p><p><img src="/2019/04/13/java-bing-fa-bian-cheng-jvm-jia-gou-yu-gc/dui.png" alt></p><h5 id="年轻代（Young-Generation）的回收算法-回收主要以复制算法为主"><a href="#年轻代（Young-Generation）的回收算法-回收主要以复制算法为主" class="headerlink" title="年轻代（Young Generation）的回收算法 (回收主要以复制算法为主)"></a>年轻代（Young Generation）的回收算法 (回收主要以复制算法为主)</h5><ul><li>所有新生成的对象首先都是放在年轻代的。年轻代的目标就是尽可能快速的收集掉那些生命周期短的对象。</li><li>新生代内存按照8:1:1的比例分为一个Eden区和两个Survivor(From，To)区。一个Eden区，两个 Survivor区(一般而言)。大部分对象在Eden区中生成。回收时先将Eden区存活对象复制到From区，然后清空Eden区，当From区也存放满了时，则将Eden区和From区存活对象复制到To区，然后清空Eden和From区，此时From区是空的，然后将From区和To区交换，即保持To区为空， 如此往复。</li><li>当To区不足以存放 Eden和From的存活对象时，就将存活对象直接存放到老年代。若是老年代也满了就会触发一次Full GC(Major GC)，也就是新生代、老年代都进行回收。</li><li>新生代发生的GC也叫做Minor GC，MinorGC发生频率比较高(不一定等Eden区满了才触发)。</li></ul><h5 id="年老代（Old-Generation）的回收算法（回收主要以Mark-Compact为主）"><a href="#年老代（Old-Generation）的回收算法（回收主要以Mark-Compact为主）" class="headerlink" title="年老代（Old Generation）的回收算法（回收主要以Mark-Compact为主）"></a>年老代（Old Generation）的回收算法（回收主要以Mark-Compact为主）</h5><ul><li>在年轻代中经历了N次垃圾回收后仍然存活的对象，就会被放到年老代中。因此，可以认为年老代中存放的都是一些生命周期较长的对象。</li><li>内存比新生代也大很多(大概比例是1:2)，当老年代内存满时触发Major GC即Full GC，Full GC发生频率比较低，老年代对象存活时间比较长，存活率标记高。</li></ul><p>JVM初始分配的堆内存由-Xms指定，默认是物理内存的1/64；JVM最大分配的堆内存由-Xmx指定，默认是物理内存的1/4。默认空余堆内存小于40%时，JVM就会增大堆直到-Xmx的最大限制；空余堆内存大于70%时，JVM会减少堆直到-Xms的最小限制。因此服务器一般设置-Xms、-Xmx 相等以避免在每次GC 后调整堆的大小。</p><h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><ul><li><strong>Serial收集器：</strong>串行收集器是最古老，最稳定以及效率高的收集器，可能会产生较长的停顿，只使用<strong>一个线程</strong>去回收。新生代、老年代使用串行回收；<strong>新生代复制算法</strong>、<strong>老年代标记-压缩</strong>；垃圾收集的过程中会Stop The World（服务暂停），可以通过 -XX:+UseSerialGC 来强制指定。</li><li><strong>ParNew收集器：</strong>ParNew收集器其实就是Serial收集器的多线程版本，在多核CPU环境下有着比Serial更好的表现。<strong>新生代并行，老年代串行；</strong>新生代复制算法、老年代标记-压缩，可通过 -XX:+UseParNewGC 来指定使用此收集器，通过 -XX:ParallelGCThreads 来限制线程数量</li><li><strong>Parallel Scavenge收集器：</strong>并行收集器，追求高吞吐量，高效利用CPU。吞吐量一般为99%， 吞吐量= 用户线程时间/(用户线程时间+GC线程时间)。适合后台应用等对交互相应要求不高的场景。是server级别默认采用的GC方式，可用 -XX:+UseParallelGC 来强制指定，用 -XX:ParallelGCThreads=4 来指定线程数。</li><li><strong>Parallel Old收集器：</strong>Parallel Old是Parallel Scavenge收集器的老年代版本，使用多线程和标记－整理算法。这个收集器是在JDK 1.6中才开始提供。通过 -XX:+UseParallelOldGC 指定。</li><li><strong>CMS收集器：</strong>高并发、低停顿，追求最短GC回收停顿时间，cpu占用比较高，响应时间快，停顿时间短，多核cpu 追求高响应时间的选择。缺点是会产生大量空间碎片、并发阶段会降低吞吐量。通过-XX:+UseConcMarkSweepGC  指定使用CMS收集器；-XX:+CMSFullGCsBeforeCompaction 设置进行几次Full GC后，进行一次碎片整理；-XX:ParallelCMSThreads 设定CMS的线程数量，一般情况约等于可用CPU数量。</li><li><strong>G1收集器：</strong>G1是目前技术发展的最前沿成果之一，HotSpot开发团队赋予它的使命是未来可以替换掉JDK1.5中发布的CMS收集器。与CMS收集器相比G1收集器有以下特点。<strong>空间整合：</strong>G1收集器采用标记整理算法，不会产生内存空间碎片。分配大对象时不会因为无法找到连续空间而提前触发下一次GC。<strong>可预测停顿：</strong>是G1的另一大优势，降低停顿时间是G1和CMS的共同关注点，但G1除了追求低停顿外，还能建立可预测的停顿时间模型，能让使用者明确指定在一个长度为N毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒，这几乎已经是实时Java（RTSJ）的垃圾收集器的特征了。</li></ul><h2 id="GC触发的条件"><a href="#GC触发的条件" class="headerlink" title="GC触发的条件"></a>GC触发的条件</h2><p>大部分情况下，对象会在新生代的Eden区中分配空间，当Eden区没有足够大小的连续空间来分配给新创建的对象时，JVM将会触发一次Minor GC。在发生Minor GC之前，JVM会先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果这个条件成立，那么Minor GC可以确保是安全的。如果不成立，则JVM会查看<code>HandlePromotionFailure</code>设置值是否允许担保失败。若允许，那么会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试进行一次Minor GC，尽管这次Minor GC是有风险的；如果小于，或者<code>HandlePromotionFailure</code>设置不允许冒险，那这时要改为进行一次Full GC。</p><ul><li><p><strong>Minor GC：</strong>发生在新生代，回收新生代中的垃圾，速度很快但也很频繁</p></li><li><p><strong>Major GC：</strong>发生在老年代，比Minor GC慢10倍以上；通常会伴随一次Minor GC</p></li><li><p><strong>Full GC：</strong>回收所有区域，包括堆内存、方法区（Java 8之前的“永久代”，Java 8开始取代永久代的“元空间”）和直接内存。Full GC因为需要对整个堆进行回收，所以速度慢，工作线程的暂停时间长。而且Full Gc过程会发生stop the world。因此应该尽可能减少Full GC的次数。在对JVM调优的过程中，很大一部分工作就是对于Full GC的调节。有如下原因可能导致Full GC：</p><ol><li><p><strong>老年代空间（Tenured）被写满</strong></p><p>老年代空间只有在新生代对象转入及创建为大对象、大数组时才会出现不足的现象，当执行Full GC后空间仍然不足，则抛出如下错误： java.lang.OutOfMemoryError: Java heap space  为避免以上两种状况引起的FullGC，调优时应尽量做到让对象在Minor GC阶段被回收、让对象在新生代多存活一段时间及不要创建过大的对象及数组。</p></li><li><p><strong>显示的调用System.gc()方法</strong></p><p>此方法的调用是建议JVM进行Full GC,虽然只是建议而非一定,但很多情况下它会触发 Full GC,从而增加Full GC的频率,也即增加了间歇性停顿的次数。强烈影响系建议能不使用此方法就别使用，让虚拟机自己去管理它的内存，可通过通过-XX:+ DisableExplicitGC来禁止RMI（Java远程方法调用）调用System.gc。</p></li><li><p><strong>方法区空间被写满</strong></p><p>JVM规范中运行时数据区域中的方法区，在HotSpot虚拟机中又被习惯称为永久代或者永生区（Java8以后永久代被Metaspace取代，Metaspace使用的是本地内存，而非堆内存），Permanet Generation中存放的为一些class的信息、常量、静态变量等数据，当系统中要加载的类、反射的类和调用的方法较多时，Permanet Generation可能会被占满，在未配置为采用CMS GC的情况下也会执行Full GC。如果经过Full GC仍然回收不了，那么JVM会抛出如下错误信息： java.lang.OutOfMemoryError: PermGen space为避免Perm Gen占满造成Full GC现象，可采用的方法为增大Perm Gen空间或转为使用CMS GC。</p></li><li><p><strong>GC担保失败</strong></p><p>在发生MinorGC前,检查老年代是否有连续空间，如果有连续空间则继续执行，如果没有，则根据设置：XX:-HandlePromotionFailure 指定，如果设置为开启，那么继续检查当前老年代最大可用连续空间大于历次Minor GC的平均晋升大小，如果大于，则进行MinorGC，否则进行FullGC。如果HandlePromotionFailure 不设置直接进行FullGC。</p></li></ol></li></ul><h2 id="GC的参数"><a href="#GC的参数" class="headerlink" title="GC的参数"></a>GC的参数</h2><h5 id="堆内存调优"><a href="#堆内存调优" class="headerlink" title="堆内存调优"></a>堆内存调优</h5><p>对于JVM的GC调优有三个重要的核心参数：<strong>-Xms ，–Xmx， –Xss</strong>，其中-Xms –Xmx是堆内存的性能调优参数，一般两个设置是一样的，如果不一样，当Heap不够用，会发生内存抖动。一般都调大这两个参数，程序会启动的快一点，并且两个大小一样。-Xss是对每一个线程栈的性能调优参数,影响堆栈调用的深度。</p><ul><li><strong>-Xms：</strong> 为jvm启动时分配的内存，比如-Xms200m，表示分配200M</li><li><strong>-Xmx：</strong> 为jvm运行过程中分配的最大内存，比如-Xms500m，表示jvm进程最多只能够占用500M内存</li><li><strong>-Xss：</strong> 为jvm启动的每个线程分配的内存大小，默认JDK1.4中是256K，JDK1.5+中是1M</li></ul><p>关于堆内存JVM还提供了更详细的配置参数：</p><ul><li><strong>-XX：NewRatio=4：</strong>设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1/5</li><li><strong>–XX:SurvivorRatio=4：</strong>设置年轻代中Eden区与Survivor区的大小比值。设置为4，则两个Survivor区与一个Eden区的比值为2:4，一个Survivor区占整个年轻代的1/6，也就是From和To各占用了年轻代的1/6。如果分配不合理，Eden太大，这样产生对象很顺利，但是进行GC有一部分对象幸存下来，拷贝到To，空间小，就没有足够的空间，对象会被放在old Generation中。如果Survive空间大，会有足够的空间容纳GC后存活的对象，但是Eden区域小，会被很快消耗完，这就增加了GC的次数。</li><li><strong>–XX:NewSize：</strong>新生代初始化内存的大小(注意：该值需要小于-Xms的值)。</li><li><strong>–XX:MaxNewSize：</strong>新生代可被分配的内存的最大上限(注意：该值需要小于-Xmx的值)。</li><li><strong>-XX:MaxTenuringThreshold=0：</strong>设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概率。</li></ul><h5 id="永久代调优"><a href="#永久代调优" class="headerlink" title="永久代调优"></a>永久代调优</h5><p>从JDK8开始，永久代(PermGen)的概念被废弃掉了，取而代之的是一个称为Metaspace的存储空间。Metaspace使用的是本地内存，而不是堆内存，也就是说在默认情况下Metaspace的大小只与本地内存大小有关。由于类的元数据可以在本地内存(native memory)之外分配,所以其最大可利用空间是整个系统内存的可用空间。这样，你将不再会遇到OOM错误，溢出的内存会涌入到交换空间。原永久的PermGen空间的状况，这部分内存空间将全部移除。JVM的参数：PermSize 和 MaxPermSize 会被忽略并给出警告（如果在启用时设置了这两个参数）。现在可以通过以下的几个参数对Metaspace进行控制。</p><ul><li><strong>-XX:MetaspaceSize=N：</strong> 这个参数是初始化的Metaspace大小，该值越大触发Metaspace GC的时机就越晚。随着GC的到来，虚拟机会根据实际情况调控Metaspace的大小，可能增加上线也可能降低。在默认情况下，这个值大小根据不同的平台在12M到20M浮动。使用java -XX:+PrintFlagsInitial命令查看本机的初始化参数，-XX:Metaspacesize为21810376B（大约20.8M）。</li><li><strong>-XX:MaxMetaspaceSize=N：</strong>这个参数用于限制Metaspace增长的上限，防止因为某些情况导致Metaspace无限的使用本地内存，影响到其他程序。在本机上该参数的默认值为4294967295B（大约4096MB）。</li><li><strong>-XX:MinMetaspaceFreeRatio=N：</strong>当进行过Metaspace GC之后，会计算当前Metaspace的空闲空间比，如果空闲比小于这个参数，那么虚拟机将增长Metaspace的大小。在本机该参数的默认值为40，也就是40%。设置该参数可以控制Metaspace的增长的速度，太小的值会导致Metaspace增长的缓慢，Metaspace的使用逐渐趋于饱和，可能会影响之后类的加载。而太大的值会导致Metaspace增长的过快，浪费内存。</li><li><strong>-XX:MaxMetasaceFreeRatio=N：</strong>当进行过Metaspace GC之后， 会计算当前Metaspace的空闲空间比，如果空闲比大于这个参数，那么虚拟机会释放Metaspace的部分空间。在本机该参数的默认值为70，也就是70%。</li><li><strong>-XX:MaxMetaspaceExpansion=N：</strong>Metaspace增长时的最大幅度。在本机上该参数的默认值为5452592B（大约为5MB）。</li><li><strong>-XX:MinMetaspaceExpansion=N：</strong>Metaspace增长时的最小幅度。在本机上该参数的默认值为340784B（大约330KB为）。</li></ul><h2 id="回收器选择"><a href="#回收器选择" class="headerlink" title="回收器选择"></a>回收器选择</h2><p>JVM给了三种选择：<strong>串行收集器、并行收集器、并发收集器</strong>，但是串行收集器只适用于小数据量的情况，所以这里的选择主要针对并行收集器和并发收集器。默认情况下，JDK5.0以前都是使用串行收集器，如果想使用其他收集器需要在启动时加入相应参数。JDK5.0以后，JVM会根据当前系统配置进行判断。</p><p>1.吞吐量优先的并行收集器，并行收集器主要以到达一定的吞吐量为目标，适用于科学技术和后台处理等。典型配置：</p><ul><li>java -Xmx3800m -Xms3800m -Xmn2g -Xss128k <strong>-XX:+UseParallelGC -XX:ParallelGCThreads=20</strong><br><strong>-XX:+UseParallelGC</strong>：选择垃圾收集器为并行收集器。此配置仅对年轻代有效。即上述配置下，年轻代使用并发收集，而年老代仍旧使用串行收集。<strong>-XX:ParallelGCThreads=20</strong>：配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。</li><li>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 <strong>-XX:+UseParallelOldGC</strong>。<strong>-XX:+UseParallelOldGC</strong>：配置年老代垃圾收集方式为并行收集。JDK6.0支持对年老代并行收集。</li><li>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC  <strong>-XX:MaxGCPauseMillis=100</strong>。<strong>-XX:MaxGCPauseMillis=100：</strong>设置每次年轻代垃圾回收的最长时间，如果无法满足此时间，JVM会自动调整年轻代大小，以满足此值。</li><li>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC  -XX:MaxGCPauseMillis=100 <strong>-XX:+UseAdaptiveSizePolicy。-XX:+UseAdaptiveSizePolicy：</strong>设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时，一直打开。</li></ul><p>2.响应时间优先的并发收集器，并发收集器主要是保证系统的响应时间，减少垃圾收集时的停顿时间。适用于应用服务器、电信领域等。典型配置：</p><ul><li>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 <strong>-XX:+UseConcMarkSweepGC  -XX:+UseParNewGC</strong>。<strong>-XX:+UseConcMarkSweepGC</strong>：设置年老代为并发收集。测试中配置这个以后，-XX:NewRatio=4的配置失效了，原因不明。所以，此时年轻代大小最好用-Xmn设置。<br><strong>-XX:+UseParNewGC</strong>:设置年轻代为并行收集。可与CMS收集同时使用。JDK5.0以上，JVM会根据系统配置自行设置，所以无需再设置此值。</li><li>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseConcMarkSweepGC <strong>-XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection</strong>。<br><strong>-XX:CMSFullGCsBeforeCompaction</strong>：由于并发收集器不对内存空间进行压缩、整理，所以运行一段时间以后会产生“碎片”，使得运行效率降低。此值设置运行多少次GC以后对内存空间进行压缩、整理。<br><strong>-XX:+UseCMSCompactAtFullCollection</strong>：打开对年老代的压缩。可能会影响性能，但是可以消除碎片</li></ul><h2 id="JVM的GC日志解读"><a href="#JVM的GC日志解读" class="headerlink" title="JVM的GC日志解读"></a>JVM的GC日志解读</h2><h5 id="JVM-YoungGeneration下MinorGC日志详解"><a href="#JVM-YoungGeneration下MinorGC日志详解" class="headerlink" title="JVM YoungGeneration下MinorGC日志详解"></a>JVM YoungGeneration下MinorGC日志详解</h5><pre><code>[GC (Allocation Failure) [PSYoungGen:2336K-&gt;288K(2560K)] 8274K-&gt;6418K(9728K), 0.0112926 secs] [Times:user=0.06 sys=0.00, real=0.01 secs]</code></pre><p>PSYoungGen（是新生代类型，新生代日志收集器），2336K表示使用新生代GC前，占用的内存，-&gt;288K表示GC后占用的内存，(2560K)代表整个新生代总共大小。8274K（GC前整个JVM Heap对内存的占用）-&gt;6418K（MinorGC后内存占用总量）(9728K)（整个堆的大小）0.0112926 secs（Minor GC消耗的时间）] [Times: user=0.06 sys=0.00, real=0.01 secs] 用户空间耗时，内核空间耗时，真正的耗时时间。</p><h5 id="JVM的GC日志Full-GC日志每个字段彻底详解"><a href="#JVM的GC日志Full-GC日志每个字段彻底详解" class="headerlink" title="JVM的GC日志Full GC日志每个字段彻底详解"></a>JVM的GC日志Full GC日志每个字段彻底详解</h5><pre><code>[Full GC (Ergonomics) [PSYoungGen: 984K-&gt;425K(2048K)] [ParOldGen:7129K-&gt;7129K(7168K)] 8114K-&gt;7555K(9216K), [Metaspace:2613K-&gt;2613K(1056768K)], 0.1022588 secs] [Times: user=0.56 sys=0.02,real=0.10 secs][Full GC (Allocation Failure) [PSYoungGen: 425K-&gt;425K(2048K)][ParOldGen: 7129K-&gt;7129K(7168K)] 7555K-&gt;7555K(9216K), [Metaspace:2613K-&gt;2613K(1056768K)], 0.1003696 secs] [Times: user=0.64 sys=0.03,real=0.10 secs]</code></pre><p>Full GC（表明是Full GC） (Ergonomics) [PSYoungGen:FullGC会导致新生代Minor GC产生]984K-&gt;425K(2048K)[ParOldGen:（老年代GC）7129K（GC前多大）-&gt;7129K（GC后，并没有降低内存占用，因为写的程序不断循环一直有引用）(7168K) （老年代总容量）] 8114K（GC前占用整个Heap空间大小）-&gt;7555K （GC后占用整个Heap空间大小） (9216K) （整个Heap大小，JVM堆的大小）, Metaspace: （java6 7是permanentspace，java8改成Metaspace，类相关的一些信息） 2613K-&gt;2613K(1056768K) （GC前后基本没变，空间很大）], 0.1022588 secs（GC的耗时，秒为单位）[Times: user=0.56 sys=0.02, real=0.10 secs]（用户空间耗时，内核空间耗时，真正的耗时时间）</p><h5 id="Java8中的JVM的MetaSpace"><a href="#Java8中的JVM的MetaSpace" class="headerlink" title="Java8中的JVM的MetaSpace"></a>Java8中的JVM的MetaSpace</h5><p>Metaspace的使用C语言实现的，使用的是OS的空间，Native Memory Space可动态的伸缩，可以根据类加载的信息的情况，在进行GC的时候进行调整自身的大小，来延缓下一次GC的到来。可以设置Metaspace的大小，如果超过最大大小就会OOM，不设置如果把整个操作系统的内存耗尽了出现OOM，一般会设置一个足够大的初始值，安全其间会设置最大值。永久代发生GC有两种情况，类的所有的实例被GC掉，且class load不存。对于元数据空间 简化了GC， class load不存在了就需要进行GC。</p><h2 id="Spring-Boot的JVM参数调优"><a href="#Spring-Boot的JVM参数调优" class="headerlink" title="Spring Boot的JVM参数调优"></a>Spring Boot的JVM参数调优</h2><p>在使用spring boot时涉及到对微服务的JVM参数的调优，在此记录一下。对于spring boot项目调优的方式有两种。由于spring boot可以启动jar包的方式启动服务，因此一种比较通用的配置方式就是在启动服务脚本时配置JVM的参数，脚本如下</p><pre class=" language-shell"><code class="language-shell">java -jar -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=128m -Xms1024m -Xmx1024m -Xmn256m -Xss256k -XX:SurvivorRatio=8 -XX:+UseConcMarkSweepGC test-0.0.1-SNAPSHOT.jar</code></pre><p>第二种是通过 <code>application.properties</code> 或者 <code>application.yml</code> 文件设置。这里有一篇官方的的关于配置文件的文章，里面有详细的参数配置和注释，<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html#common-application-properties" target="_blank" rel="noopener">SpringBoot项目详细的配置文件修改文档</a>。其中比较重要的有：</p><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">server.tomcat.max-connections</span><span class="token punctuation">=</span><span class="token attr-value">0 # Maximum number of connections that the server accepts and processes at any given time.</span><span class="token attr-name">server.tomcat.max-http-header-size</span><span class="token punctuation">=</span><span class="token attr-value">0 # Maximum size, in bytes, of the HTTP message header.</span><span class="token attr-name">server.tomcat.max-http-post-size</span><span class="token punctuation">=</span><span class="token attr-value">0 # Maximum size, in bytes, of the HTTP post content.</span><span class="token attr-name">server.tomcat.max-threads</span><span class="token punctuation">=</span><span class="token attr-value">0 # Maximum number of worker threads.</span><span class="token attr-name">server.tomcat.min-spare-threads</span><span class="token punctuation">=</span><span class="token attr-value">0 # Minimum number of worker threads.</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java并发编程-JMM与JSR133</title>
      <link href="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/"/>
      <url>/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/</url>
      
        <content type="html"><![CDATA[<p>Java平台自动集成了线程以及多处理器技术，这种集成程度比Java以前诞生的计算机语言要厉害很多，该语言针对多种异构平台的平台独立性而使用的多线程技术支持也是具有开拓性的一面，有时候在开发Java同步和线程安全要求很严格的程序时，往往容易混淆的一个概念就是内存模型。究竟什么是内存模型？内存模型描述了程序中各个变量（实例域、静态域和数组元素）之间的关系，以及在实际计算机系统中将变量存储到内存和从内存中取出变量这样的底层细节，对象最终是存储在内存里面的，这点没有错，但是编译器、运行库、处理器或者系统缓存可以有特权在变量指定内存位置存储或者取出变量的值。JMM（Java Memory Model的缩写）允许编译器和缓存以数据在处理器特定的缓存（或寄存器）和主存之间移动的次序拥有重要的特权，因此JMM定义了Java 虚拟机(JVM)在计算机内存(RAM)中的工作方式。JVM是整个计算机虚拟模型，所以JMM是隶属于JVM的。从抽象的角度来看，JMM定义了线程和主内存之间的抽象关系：线程之间的共享变量存储在主内存（Main Memory）中，每个线程都有一个私有的本地内存（Local Memory），本地内存中存储了该线程以读/写共享变量的副本。本地内存是JMM的一个抽象概念，并不真实存在。它涵盖了缓存、写缓冲区、寄存器以及其他的硬件和编译器优化。</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/jmm.png" alt></p><a id="more"></a> <h2 id="JVM内存模型"><a href="#JVM内存模型" class="headerlink" title="JVM内存模型"></a>JVM内存模型</h2><p>对于JVM的内存模型，相信学Java的人并不陌生。JVM是一种用于计算设备的规范，它是一个虚构出来的计算机，是通过在实际的计算机上仿真模拟各种计算机功能来实现的。JVM有自己完善的硬件架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。Java语言最重要的特点就是跨平台运行。使用JVM就是为了支持与操作系统无关，实现跨平台。JVM是Java的核心和基础，在java编译器和os平台之间的虚拟处理器。它是一种基于下层的操作系统和硬件平台并利用软件方法来实现的抽象的计算机，JVM屏蔽了与具体操作系统平台相关的信息，可以在上面执行Java的字节码程序，在执行字节码时，实际上最终还是把字节码解释成具体平台上的机器指令执行。JVM的内存模型如下：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/jvm.png" alt></p><ul><li>Java栈：Java虚拟机栈是线程私有的，生命周期与线程相同，每个方法执行时都会创建一个栈帧（Stack Frame），描述的是Java方法执行的内存模型，用于存储局部变量，操作数栈，方法出口等。每个方法的调用都对应的出栈和入栈。虚拟机栈中执行每个方法的时候，都会创建一个栈帧用于存储局部变量表，操作数栈，动态链接，方法出口等信息。</li><li>Java堆：堆是Java对象的存储区域，任何用new字段分配的Java对象实例和数组，都被分配在堆上，Java堆可使用-Xms -Xmx进行内存控制，此区域所有Java线程锁共享的，不是线程安全的，在JVM启动时创建，也是GC管理的主要区域。值得一提的是从JDK1.7版本之后，运行时常量池从方法区移到了堆上。</li><li>方法区：它用于存储已被虚拟机加载的类信息，常量，静态变量，即时编译器编译后的代码等数据，存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation。方法区在JDK1.7版本及以前被称为永久代，从JDK1.8永久代被移除。</li><li>本地方法栈：本地方法栈（Native Stack）与Java虚拟机站（Java Stack）所发挥的作用非常相似，他们之间的区别在于虚拟机栈为虚拟机栈执行java方法（也就是字节码）服务，而本地方法栈则为使用到Native方法服务。</li><li>程序计数器：严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。</li></ul><p>Java虚拟机在执行Java程序的过程中，会把它管理的内存划分为以上几个不同的数据区域，每个区域都有各自的分工。这是一种整体上的理解，本人把它理解为一种鸟瞰图。就比如你坐在直升机上鸟瞰整个城市，也会看到城市的各个区域，开发区，商业区，居民区等等。但这仅仅只是一种相对静态的结构图，城市中的开发区，商业区，居民区之间肯定会存在交通，经济，贸易的来往。俗话说无规矩不成方圆，城市中各个区域之间的商品，资金流动必然遵循一定的规律，不然整个城市就乱套了。类比到Java虚拟机，自然而然的就会产生出一个问题，现在Java虚拟机的内存区域都划分好了，但各个区域如果需要发生数据交换，交换的规范怎么定义，怎么保证数据的安全性和一致性。这些问题就需要JMM内存模型来解答了。</p><h2 id="JMM内存模型"><a href="#JMM内存模型" class="headerlink" title="JMM内存模型"></a>JMM内存模型</h2><p>JMM内存模型主要目标是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量这样底层细节。此处的变量与Java编程时所说的变量不一样，指包括了实例字段、静态字段和构成数组对象的元素，但是不包括局部变量与方法参数，后者是线程私有的，不会被共享。内存模型可以理解为在特定的操作协议下，对特定的内存或者高速缓存进行读写访问的过程抽象。在C/C++语言中直接使用物理硬件和操作系统内存模型，导致不同平台下并发访问出错。而JMM的出现，能够屏蔽掉各种硬件和操作系统的内存访问差异，实现平台一致性，是使得Java程序能够一次编写，到处运行的基石。逻辑上大致理解如下图：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/jmm.png" alt></p><p>在前面的文章中曾详细讲述了在物理机器中CPU和内存之间为了解决内存与处理器的运算能力之间的几个数量级差距的问题，在CPU和内存之间引入了几级高速缓存，而引入高速缓存又带来了缓存一致性的问题。同时为了尽可能的利益CPU中的逻辑运行单元，又引入了CPU的流水线机制和指令乱序执行机制来优化指令执行顺序。缓存一致性问题的解决方案之前说过MESI协议，但实际上除了MESI协议，还有MSI，MOSI及Dragon Protocol等。而指令乱序执行则通过as-if-serial语义保证。如果不同物理架构都使用相同的内存模型，也就没这么多事了，但不同架构（主流的两种架构有两种：x86架构和arm架构）下的物理机拥有不一样的物理内存模型，因此JMM就是对这些底层协议的操作细节进行封装和抽象，以保证JMM在不同架构下，对上层保持一致的视图模型。这对开发人员来说是一种福音，由于有了JMM的承诺，因此开发人员只需要按照JMM提供的内存模型来并发编程，遵循JMM的规则，JMM就能为我们提供代码顺序性、共享变量可见性的保证，从而得到预期的执行结果，而不需要考虑不同平台的兼容性问题。</p><h2 id="顺序一致性内存模型"><a href="#顺序一致性内存模型" class="headerlink" title="顺序一致性内存模型"></a>顺序一致性内存模型</h2><p>顺序一致性内存模型是一个被计算机科学家理想化了的理论参考模型，它为程序员提供了极强的内存可见性保证。顺序一致性内存模型有两大特性：</p><ul><li>一个线程中的所有操作必须按照程序的顺序来执行。</li><li>（不管程序是否同步）所有线程都只能看到一个单一的操作执行顺序。在顺序一致性内存模型中，每个操作都必须原子执行且立刻对所有线程可见。</li></ul><p>顺序一致性内存模型为开发者提供的视图如下：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/sxyzx.png" alt></p><p>概念上，顺序一致性模型有一个单一的全局内存，这个内存通过一个左右摆动的开关可以连接到任意一个线程。同时，每一个线程必须按程序的顺序来执行内存读/写操作。从上图我们可以看出，在任意时间点最多只能有一个线程可以连接到内存。当多个线程并发执行时，图中的开关装置能把所有线程的所有内存读/写操作串行化。为了更好的理解，下面我们通过两个示意图来对顺序一致性模型的特性做进一步的说明。假设有两个线程A和B并发执行。其中A线程有三个操作，它们在程序中的顺序是：A1-&gt;A2-&gt;A3。B线程也有三个操作，它们在程序中的顺序是：B1-&gt;B2-&gt;B3。假设这两个线程使用监视器来正确同步：A线程的三个操作执行后释放监视器，随后B线程获取同一个监视器。那么程序在顺序一致性模型中的执行效果将如下图所示：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/sx1.png" alt></p><p>现在我们再假设这两个线程没有做同步，下面是这个未同步程序在顺序一致性模型中的执行示意图：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/sx2.png" alt></p><p>未同步程序在顺序一致性模型中虽然整体执行顺序是无序的，但所有线程都只能看到一个一致的整体执行顺序。以上图为例，线程A和B看到的执行顺序都是：B1-&gt;A1-&gt;A2-&gt;B2-&gt;A3-&gt;B3。之所以能得到这个保证是因为顺序一致性内存模型中的每个操作必须立即对任意线程可见。</p><p>但是，在JMM中就没有这个保证。未同步程序在JMM中不但整体的执行顺序是无序的，而且所有线程看到的操作执行顺序也可能不一致。比如，在当前线程把写过的数据缓存在本地内存中，且还没有刷新到主内存之前，这个写操作仅对当前线程可见；从其他线程的角度来观察，会认为这个写操作根本还没有被当前线程执行。只有当前线程把本地内存中写过的数据刷新到主内存之后，这个写操作才能对其他线程可见。在这种情况下，当前线程和其它线程看到的操作执行顺序将不一致。</p><h2 id="JMM，处理器内存模型与顺序一致性内存模型之间的关系"><a href="#JMM，处理器内存模型与顺序一致性内存模型之间的关系" class="headerlink" title="JMM，处理器内存模型与顺序一致性内存模型之间的关系"></a>JMM，处理器内存模型与顺序一致性内存模型之间的关系</h2><p>JMM 是一个语言级的内存模型，处理器内存模型是硬件级的内存模型，顺序一致性内存模型是一个理论参考模型。下面是语言内存模型，处理器内存模型和顺序一致性内存模型的强弱对比示意图：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/jmmsj.png" alt></p><p>从上图我们可以看出：常见的 5 种处理器内存模型比常用的 3 中语言内存模型要弱，处理器内存模型和语言内存模型都比顺序一致性内存模型要弱。同处理器内存模型一样，越是追求执行性能的语言，内存模型设计的会越弱。</p><h2 id="JMM的设计"><a href="#JMM的设计" class="headerlink" title="JMM的设计"></a>JMM的设计</h2><p>站在JMM设计者的角度，在设计JMM时需要考虑两个关键因素:</p><p><strong>1.程序员对内存模型的使用：</strong>程序员希望内存模型易于理解、易于编程。程序员希望基于一个强内存模型来编写代码。</p><p><strong>2.编译器和处理器对内存模型的实现：</strong>编译器和处理器希望内存模型对它们的束缚越少越好，这样它们就可以做尽可能多的优化来提高性能。编译器和处理器希望实现一个弱内存模型。</p><p>由于这两个因素互相矛盾，所以JSR-133专家组在设计JMM时的核心目标就是找到一个好的平衡点：一方面要为程序员提供足够强的内存可见性保证；另一方面，对编译器和处理器的限制要尽可能的放松。另外还要一个特别有意思的事情就是关于重排序问题，更简单的说，重排序可以分为两类，JMM对这两种不同性质的重排序，采取了不同的策略，如下：</p><table><thead><tr><th>重排序类型</th><th>JMM的应对策略</th></tr></thead><tbody><tr><td>会改变程序执行结果的重排序</td><td>对于会改变程序执行结果的重排序，JMM要求编译器和处理器必须禁止这种重排序</td></tr><tr><td>不会改变程序执行结果的重排序</td><td>对于不会改变程序执行结果的重排序，JMM对编译器和处理器不做要求</td></tr></tbody></table><p>对于开发人员来说，JMM所处的位置：</p><p><img src="/2019/04/04/java-bing-fa-bian-cheng-jmm-yu-jsr133/jmm5.png" alt></p><h2 id="JMM的承诺"><a href="#JMM的承诺" class="headerlink" title="JMM的承诺"></a>JMM的承诺</h2><p>如果程序是正确同步的，程序的执行将具有顺序一致性（sequentially consistent），即程序的执行结果与该程序在顺序一致性内存模型中的执行结果相同，这对于开发者来说是一个极强的保证。这里的同步是指广义上的同步，包括对常用同步原语（lock，volatile和final）的正确使用。既然JMM为开发者们提供了一致的视图，那么JMM是如何保证一致性的呢。这里我们先来了解几个概念，即原子性，可见性，有序性。</p><h3 id="原子性（Atomicity）"><a href="#原子性（Atomicity）" class="headerlink" title="原子性（Atomicity）"></a>原子性（Atomicity）</h3><p>原子操作是指一个操作不会被线程调度机制打断，一旦开始，就一直运行到结束，中间不会有任何线程切换(context switch)。原子性可以保障读取到的某个属性的值是由一个线程写入的。 变量不会在同一时刻受到多个线程同时写入造成干扰。在Java中基本数据类型byte,short,int,float,boolean,char读写是原子操作，而对于32位系统的来说，long类型数据和double类型数据，它们的读写并非原子性的，如果在32位的JVM中对64位long 或double值的写操作是分成两次相邻的32位值写操作，在多线程的环境下，可能会有线程只读到了前32位，这种操作就是非原子性的，非原子性操作会受到多线程的干扰而产生结果混乱。但也不必太担心，因为读取到半个变量的情况比较少见，至少在目前的商用的虚拟机中，几乎都把64位的数据的读写操作作为原子操作来执行，因此对于这个问题不必太在意，知道这么回事即可。JMM保证的原子性变量操作包括read、load、assign、use、store、write。这六个操作针对的是变量的原子操作，如果应用场景需要一个更大范围的原子性保证，Java内存模型还提供了lock和unlock操作来满足这种需求。尽管虚拟机没有把lock和unlock操作直接开放给用户使用，但是却提供了更高层次的字节码指令monitorenter和monitorexit来隐式地使用这两个操作，这两个字节码指令反映到Java代码中就是同步块synchronized关键字，因此synchronized块之间的操作也具备原子性。JMM内存模型对主内存与工作内存之间的具体交互协议定义的八种操作，具体如下：</p><ol><li>lock（锁定）：作用于主内存变量，把一个变量标识为一条线程独占状态。</li><li>unlock（解锁）：作用于主内存变量，把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。</li><li>read（读取）：作用于主内存变量，把一个变量从主内存传输到线程的工作内存中，以便随后的 load 动作使用。</li><li>load（载入）：作用于工作内存变量，把 read 操作从主内存中得到的变量值放入工作内存的变量副本中。</li><li>use（使用）：作用于工作内存变量，把工作内存中的一个变量值传递给执行引擎，每当虚拟机遇到一个需要使用变量值的字节码指令时执行此操作。</li><li>assign（赋值）：作用于工作内存变量，把一个从执行引擎接收的值赋值给工作内存的变量，每当虚拟机遇到一个需要给变量进行赋值的字节码指令时执行此操作。</li><li>store（存储）：作用于工作内存变量，把工作内存中一个变量的值传递到主内存中，以便后续 write 操作。</li><li>write（写入）：作用于主内存变量，把 store 操作从工作内存中得到的值放入主内存变量中。</li></ol><h3 id="可见性（Visibility）"><a href="#可见性（Visibility）" class="headerlink" title="可见性（Visibility）"></a>可见性（Visibility）</h3><p>可见性就是指当一个线程修改了共享变量的值，其他线程能够立即得知这个修改。多线程环境下影响变量可见性的因素有三个，1.线程调度。2.工作内存和主内存没有及时刷新。3.指令重排序。Java内存模型是通过在变量修改后将新值同步回主内存，在变量读取前从主内存刷新变量值这种依赖主内存作为传递媒介的方式来实现可见性的，无论是普通变量还是volatile变量都是如此，普通变量与volatile变量的区别是volatile的特殊规则保证了新值能立即同步到主内存，以及每次使用前立即从主内存刷新。因此我们可以说volatile保证了多线程操作时变量的可见性，而普通变量则不能保证这一点。除了volatile之外，还有Synchronized，Lock，Final也是可以的。</p><ul><li><strong>Synchronized：</strong>在同步方法/同步块开始时（Monitor Enter）,使用共享变量时会从主内存中刷新变量值到工作内存中（即从主内存中读取最新值到线程私有的工作内存中），在同步方法/同步块结束时(Monitor Exit),会将工作内存中的变量值同步到主内存中去（即将线程私有的工作内存中的值写入到主内存进行同步）。</li><li><strong>Lock接口：</strong>Lock最常用的实现ReentrantLock(重入锁)来实现可见性：当我们在方法的开始位置执行lock.lock()方法，这和synchronized开始位置（Monitor Enter）有相同的语义，即使用共享变量时会从主内存中刷新变量值到工作内存中（即从主内存中读取最新值到线程私有的工作内存中），在方法的最后finally块里执行lock.unlock()方法，和synchronized结束位置（Monitor Exit）有相同的语义,即会将工作内存中的变量值同步到主内存中去（即将线程私有的工作内存中的值写入到主内存进行同步）。</li><li><strong>Final关键字：</strong>Final的可见性是指：被final修饰的字段在构造器中一旦初始化完成，并且构造器没有把this的引用传递出去（this引用逃逸是一件很危险的事情，其他线程有可能通过这个引用访问到初始化了一半的对象），那么在其他线程中就能看见final字段的值。可见性是保障多线程操作中数据一致性和结果正确性的基石，</li></ul><h3 id="有序性（Ordering）"><a href="#有序性（Ordering）" class="headerlink" title="有序性（Ordering）"></a>有序性（Ordering）</h3><p>有序性是指对于单线程的执行代码。JMM的有序性表现为：如果在本线程内观察本线程的操作，所有的操作都是有序的；如果在一个线程中观察另一个线程的操作，所有的操作都是无序的。前半句指的是单线程内保证串行语义执行的一致性（as-if-serial），后半句指的是指令重排序和普通变量的工作内存与主内存同步延迟的现象。指令重排分为三种：</p><ul><li>编译器优化的重排：编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</li><li>指令流水线的重排：处理器采用了指令级并行技术将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应的机器指令的执行顺序</li><li>内存系统的重排：由于处理器使用缓存和读写缓存冲区，这使得加载(load)和存储(store)操作看上去可能是在乱序执行，因为高速缓存的存在，导致内存与缓存的数据同步存在时间差。</li></ul><p><strong>1.as-if-serial语义</strong></p><p>不管怎么重排序，单线程下程序的执行结果不能被改变。编译器、runtime和处理器都必须遵守as-if-serial语义。为了遵守as-if-serial语义，编译器和处理器不会对存在数据依赖关系的操作做重排序，因为这种重排序会改变执行结果。一定注意，这里所说的数据依赖性仅针对单个处理器中执行的指令序列和单个线程中的代码执行操作，不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑。在 Java 里可以通过 volatile 关键字保证一定的有序性，还可以通过 synchronized、Lock 来保证有序性，因为 synchronized、Lock 保证了每一时刻只有一个线程执行同步代码相当于单线程执行，所以自然不会有有序性的问题；除此之外 Java 内存模型通过 happens-before 原则如果能推导出来两个操作的执行顺序就能先天保证有序性。</p><p><strong>2.happens-before 原则</strong></p><p>在JMM模型中除了靠sychronized和volatile关键字来保证原子性、可见性以及有序性外，JMM内部还定义一套happens-before 原则来保证多线程环境下两个操作间的原子性、可见性以及有序性。先行发生原则( happens-before )是JMM用来规定两个操作之间的偏序关系，这两个操作是可以跨线程的。happens-before的概念最初由Leslie Lamport在其一篇影响深远的论文（《Time，Clocks and the Ordering of Events in a Distributed System》）中提出，有兴趣的可以google一下。JSR-133使用happens-before的概念来指定两个操作之间的执行顺序。由于这两个操作可以在一个线程之内，也可以是在不同线程之间。因此，JMM可以通过happens-before关系向程序员提供跨线程的内存可见性保证。happens-before中确定了8条规则，如果如果两个操作之间的关系可以从下列规则推导出来说明两个操作是有序的。happens-before并不限定指令重排序，如果如果重排序之后的执行结果与按happens-before关系来执行的结果一致，那么JVM允许这种重排序。happens-before原则保证了前后两个操作间不会被重排序且后者对前者的内存是可见的。<strong>happens-before的八条规则:</strong></p><ol><li>程序次序规则：一个线程中的每个操作，happens-before于该线程中的任意后续操作(一个线程内保证语义的串行性)。</li><li>锁定规则：对一个锁的解锁，happens-before于随后对这个锁的加锁。</li><li>volatile变量规则：volatile变量的写操作happens-before于后面对这个变量的读操作。</li><li>传递规则：如果A happens-before B且Bhappens-before C，那么A happens-before C。</li><li>线程启动规则：Thread对象的start()方法happens-before于此线程的每个一动作。</li><li>线程中断规则：对线程interrupt()方法的调用happens-before于被中断线程的代码检测到中断事件的发生。</li><li>线程终结规则：线程中所有的操作都happens-before于线程的终止。</li><li>对象终结规则：一个对象的初始化完成happens-before于他的finalize()方法的开始。</li></ol><p>上面八条规则是对于Java语法层面的具体表现，对于happens-before的简单理解其实就两点。(1).  如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。这一点是最好理解的，从字面意思就能看出来。(2). 两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么这种重排序并不非法。也就是说，JMM允许这种重排序。换种说法，happens-before保证的是结果的一致性。</p><p><strong>3. as-if-serial   VS   happens-before</strong></p><ul><li>as-if-serial语义保证单线程内程序的执行结果不被改变，happens-before关系保证正确同步的多线程程序的执行结果不被改变。</li><li>as-if-serial语义给编写单线程程序的程序员创造了一个幻境：单线程程序是按程序的顺序来执行的。happens-before关系给编写正确同步的多线程程序的程序员创造了一个幻境：正确同步的多线程程序是按happens-before指定的顺序来执行的。</li><li>as-if-serial语义和happens-before这么做的目的，都是为了在不改变程序执行结果的前提下，尽可能地提高程序执行的并行度。</li></ul><h2 id="JSR-133-对旧内存模型的修补"><a href="#JSR-133-对旧内存模型的修补" class="headerlink" title="JSR-133 对旧内存模型的修补"></a>JSR-133 对旧内存模型的修补</h2><p>JSR-133 对 JDK5 之前的旧内存模型的修补主要有两个：</p><ul><li>增强 volatile 的内存语义。旧内存模型允许 volatile 变量与普通变量重排序。JSR-133 严格限制 volatile 变量与普通变量的重排序，使 volatile 的写 - 读和锁的释放 - 获取具有相同的内存语义。</li><li>增强 final 的内存语义。在旧内存模型中，多次读取同一个 final 变量的值可能会不相同。为此，JSR-133 为 final 增加了两个重排序规则。现在，final 具有了初始化安全性。</li></ul><p>JSR 133的目标包含了：</p><ul><li><p>保留已经存在的安全保证（像类型安全）以及强化其他的安全保证。例如，变量值不能凭空创建：线程观察到的每个变量的值必须是被其他线程合理的设置的。</p></li><li><p>正确同步的程序的语义应该尽量简单和直观。</p></li><li><p>应该定义未完成或者未正确同步的程序的语义，主要是为了把潜在的安全危害降到最低。</p></li><li><p>程序员应该能够自信的推断多线程程序如何同内存进行交互的。</p></li><li><p>能够在现在许多流行的硬件架构中设计正确以及高性能的JVM实现。</p></li><li><p>应该能提供 <em>安全地初始化</em>的保证。如果一个对象正确的构建了（意思是它的引用没有在构建的时候逸出，那么所有能够看到这个对象的引用的线程，在不进行同步的情况下，也将能看到在构造方法中中设置的final字段的值。</p></li><li><p>应该尽量不影响现有的代码。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java并发编程-cpu的流水线</title>
      <link href="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/"/>
      <url>/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/</url>
      
        <content type="html"><![CDATA[<p>作为程序员，CPU在我们的工作中扮演了核心角色，因此了解处理器内部的工作方式对程序员来说不无裨益。CPU是如何工作的呢？一条指令执行需要多长时间？当我们讨论某个新款处理器拥有12级流水线还是18级流水线，甚至是更深的31级流水线时，这到些都意味着什么呢？应用程序通常会将CPU看作是黑盒子。程序中的指令按照顺序依次进入CPU，执行完之后再按顺序依次从CPU中出来，而内部到底发生了什么，我们通常并不了解。对我们程序员来说，尤其是对做程序性能调优工作的程序员来说，学习CPU内部的细节非常必要。前文讲到过为了尽量利用CPU的资源，使用高速缓存来缓解内存工作速度远小于CPU工作速度的矛盾。那CPU本身对于效率的优化有哪些方式呢？本文仅从软件层面来了解一下CPU的优化手段，至于硬件层面不作阐述。CPU里存在两样优化速度的技术，分别是 ：指令流水线和指令乱序执行。</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/cpus.png" alt></p><a id="more"></a> <h2 id="CPU技术发展历史"><a href="#CPU技术发展历史" class="headerlink" title="CPU技术发展历史"></a>CPU技术发展历史</h2><p>从一个非常广的角度来说，X86处理器架构在近35年来并没有变化太多。虽然X86架构被附加了很多新功能，但是最初的设计（包括几乎所有最初的指令集）仍然基本上是完整保留的，即使在最新的处理器上仍然被支持。最初的8086处理器支持14个寄存器，这些寄存器在如今最新的处理器中仍然存在。这14个寄存器中，有4个是通用寄存器：AX，BX，CX和DX；有4个是段寄存器，段寄存器用来辅助指针的实现：代码段(CS)，数据段(DS)，扩展段(ES)和堆栈段(SS)；有4个是索引寄存器，用来指向内存地址：源引用(SI)，目的引用(DI)，基指针(BP)，栈指针(SP)；有1个寄存器包含状态位；最后是最重要的寄存器：指令指针(IP)。指令指针寄存器是一个拥有特殊功能的指针。指令指针的功能是指向将要运行的下一条指令。所有的X86处理器都按照相同的模式运行。首先，根据指令指针指向的地址取得下一条即将运行的指令并解析该指令（译码）。在译码完成后，会有一个指令的执行阶段。有些指令用来从内存读取数据或者向内存写数据，有些指令用来执行计算或者比较等工作。当指令执行完成后，这条指令会通过退出(retire)阶段并将指令指针修改为下一条指令。相较于现今的标准，最初的处理器设计显得太过简单。最初的8086处理器的执行过程可以简述为从当前指令指针取得指令，通过译码，执行最后退出，然后继续从指令指针指向的下一条指令处取得指令。新的处理器增加了新的功能，有些增加了新的指令，有些增加了新的寄存器。我将主要关注和本文主题有关系的改变，这些改变影响了CPU指令执行的流程。其他的一些变化比如虚拟内存或者并行处理虽然都很有意义而且有趣，但是并不在本文主题的范围内。</p><ul><li><p>1971年：世界上第一块微处理器4004在Intel公司诞生了。它出现的意义是划时代的，比起以前的CPU，4004显得很可怜，它是只有2300个晶体管4位CPU，功能相当有限，而且速度还很慢。</p></li><li><p>1978年：Intel公司首次生产出16位的微处理器命名为i8086，同时还生产出与之相配合的数学协处理器i8087，这两种芯片使用相互兼容的指令集。由于这些指令集应用于i8086和i8087，所以人们也把这些指令集统一称之为X86指令集。这就是X86指令集的来历。</p></li><li><p>1982年：指令缓存被加入到处理器中。通过指令缓存，处理器可以一次性从内存读取更多指令并放在指令缓存中，而不用每条指令都从内存中取。指令缓存仅有几个字节大小，只能容纳数条指令，但是因为消除了之后每次取指往返内存和处理器的时间，极大的提高的效率</p></li><li><p>1985年：386处理器引入了数据缓存，而且扩展了指令缓存的设计。数据访存请求通过一次性读取更多的数据放在数据缓存中，从而提升了性能。而且，数据缓存和指令缓存都从几个字节扩大到几千字节。</p></li><li><p>1989年：推出的i486处理器引入了五级流水线。这时，在CPU中不再仅运行一条指令，每一级流水线在同一时刻都运行着不同的指令。这个设计使得i486比同频率的386处理器性能提升了不止一倍。五级流水线中的取指阶段将指令从指令缓存中取出（i486中的指令缓存为8KB）；第二级为译码阶段，将取出的指令翻译为具体的功能操作；第三级为转址阶段，用来将内存地址和偏移进行转换；第四级为执行阶段，指令在该阶段真正执行运算；第五级为退出阶段，运算的结果被写回寄存器或者内存。由于处理器同时运行了多条指令，大大提升了程序运行的性能。</p></li><li><p>1993年：Intel推出了奔腾(Pentium)处理器。由于诉讼问题，Intel无法继续沿用原来的数字编号。因此，用奔腾替代了586作为新款处理器的代号。奔腾处理器相对i486处理器对流水线做出了更多修改。奔腾处理器架构增加了第二条独立的超标量流水线。主流水线工作方式类似于i486，第二条流水线则并行的运行一些较简单的指令，比如说定点算术，而且该流水线能更快的进行该运算。</p></li><li><p>1995年：Intel推出了奔腾Pro(Pentium Pro)处理器。和之前的处理器相比，奔腾Pro采用了完全不同的设计。该处理器采用了诸多新特性以提高性能，包括乱序(Out-of-Order, OOO)执行的部件以及猜测执行。流水线扩展到了12级，而且引入了“超标量流水线”的概念，使得许多指令可以被同时处理。我们稍后将详尽的介绍乱序执行的部件。</p></li><li><p>1995~2002年：乱序执行部件经过了数次重大改进。处理器中加入了更多的寄存器；单指令多数据(Single Instruction Multiple Data, or SIMD)的引入使得一条指令可以进行多组数据运算；现有的缓存变得更大而且引入了新的缓存；有些流水级被拆分成更多流水级，有些流水级被合并，使得更加适合实际的应用。这些改变对整体性能的提升有重要作用，但它们都没有从根本影响数据在处理器中的流动方式。</p></li><li><p>2002年：Intel发布奔腾4处理器引入了超线程技术。乱序执行部件的设计使得指令被执行的速度比处理器能够提供指令的速度更快。因此对于大部分应用，CPU的乱序执行部件在大部分时间处于空闲状态，甚至在高负载的情况下也不能充分利用。为了让指令流能充分的流入乱序执行部件，Intel加入了第二套前端部件（译注：在处理器结构中，前端是指取指，译码，寄存器重命名等模块，经过前端部件的处理后，指令等待发射进入乱序执行部件）。虽然实际上只有一个乱序执行部件，但对于操作系统来说，它能看到两个处理器。前端部件包含两组同样功能的X86寄存器，两个指令译码器根据两个指令指针指向的地址分别处理。所有的指令被一个共享的乱序执行部件执行，但对应用程序来说并不知情。当乱序执行部件执行完成，像之前一样退出流水线后，最终结果返回虚拟的两个处理器。</p></li><li><p>2006年：Intel发布了酷睿(Core)微架构。为了品牌效应，它被称做酷睿2（二总比一好）。令人惊讶的是，处理器频率不升反降，而且超线程也被去掉了。通过降低时钟频率，每一级流水线可以做更多工作。乱序执行部件也被扩展的更宽。各种不同的缓存和队列都相应做的更大。而且处理器被重新设计，以适应双核和四核的共享缓存结构。</p></li><li><p>2008年：Intel开始用酷睿i3, i5, i7的方式来命名新的处理器。新处理器重新引入了超线程。这三个系列的处理器主要区别在于内部缓存大小不同。</p></li></ul><h2 id="CPU指令流水线"><a href="#CPU指令流水线" class="headerlink" title="CPU指令流水线"></a>CPU指令流水线</h2><p>根据之前描述的基础，指令进入流水线，通过流水线处理，从流水线出来的过程，对于我们程序员来说，是比较直观的。对于CPU性能有以下公式：</p><p>处理器性能 = 主频 X IPC</p><p>由上述公式我们可以知道，提高CPU性能要么就提高主频，要么就提高IPC(CPU每一时钟周期内所执行的指令数量)，提升IPC有两种做法，一个是增加单核并行的度，一个是加多几个核。早期一些采用非常简单的指令集的电脑是采用单周期设计的，取指、解码、执行、写回都是放在同一个节拍（周期）内顺序完成此时的 CPI(每条指令执行时所花费的平均时钟周期数）基本上是 1，但是这样设计的效率很低：当取指的时候，其余工位都只能瞎瞪眼等开饭，这样的设计也被称作非流水线化执行。其执行图如下</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/cpu1.png" alt></p><p>因此也可得出一个结论，想要提供CPU的工作效率，就要让CPU在每个时钟周期内尽可能多的执行指令。I486拥有五级流水线。分别是：取指(Fetch)，译码(D1, main decode)，转址(D2, translate)，执行(EX, execute)，写回(WB)。某个指令可以在流水线的任何一级。在理想情况下，流水线级数越多，可同时流水执行的指令数越多，正比增长。这就是推出该问题的理论基础。并行度越大，在宏观上看其实就等效于每一条指令的执行速度都变快了。但现实不是这样理想的。流水的时候，会遇见各种冒险机制（某硬件不支持同时钟周期被多个资源访问，数据依赖或逻辑关系不被满足的情况，跳转指令等），造成流水设计的困难。下面是流水线工作的流程图</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/cpu.png" alt></p><p>流水线是将组合逻辑分割成多个小块，因为每段的关键路径变短了，所以能提高系统主频。同时能让任务以类似并行方式处理，提高硬件模块的利用率，提高系统频率，提高吞吐量。这里可能有些朋友会有疑问，流水线的级数是不是越高，CPU的利用率就越高呢？理想很丰满，现实很骨感。理论上流水线级数越多，每级所花的时间越短，时钟周期就可以设计的越短，指令速度越快，指令平均执行时间也就越短。但实际上，流水线越长，重叠执行的指令就越多，那么发生竞争冲突得可能性就越大，一般来说流水线越长，整体性能越差，而且还有前车之鉴。著名的奔腾四，就是因为流水线过长，而落得个高频低能的名声。而且，拜糟糕的奔腾四所赐， AMD 在那个时代全面超越了 intel，这也是历史上唯一的一小段 AMD 主营 CPU 在性能上完全超越 intel 主营 CPU 的年代。（这个年代持续得不长，就因为酷睿的出世而结束了。）流水线过长对性能没有帮助，只对提升主频有帮助。长流水线能够使你提升主频更容易，所以容易造就高频低能的芯片。另一方面，流水线技术是以空间换时间的技术，如果流水线过长，就需要更多的寄存器来保存流水线中产生的中间结果，对于芯片的制作成本也会有所提升。</p><table><thead><tr><th>主流处理器</th><th>流水线级数</th></tr></thead><tbody><tr><td>1993年，Pentium</td><td>5级</td></tr><tr><td>1995年，Pentium Pro</td><td>12级</td></tr><tr><td>1999年，ARM9</td><td>5级</td></tr><tr><td>2002年，ARM11</td><td>8级</td></tr><tr><td>2004年，Pentuim4(Prescott)</td><td>31级</td></tr><tr><td>2006年，Core2 Duo(Merom)</td><td>14级</td></tr><tr><td>2008年，Core i7(Nehalem)</td><td>16级</td></tr></tbody></table><h2 id="流水线的冒险思想"><a href="#流水线的冒险思想" class="headerlink" title="流水线的冒险思想"></a>流水线的冒险思想</h2><p>流水线技术之所以能提高性能 究其本质是利用了时间上的并行性，那它让原本应该先后执行的指令在时间上一定程度的并行起来，然而这也会带来一些冲突和矛盾，进而可能引发错误。流水线处理中，由于各个阶段的依赖关系、硬件资源的竞争等原因，会出现操作无法执行的情况。造成流水线故障的原因称为冒险。冒险分为三种：</p><ul><li>结构冒险：如果一条指令需要的硬件部件还在为之前的指令工作，而无法为这条指令提供服务，那就导致了结构冒险。（这里结构是指硬件当中的某个部件）</li><li>数据冒险：由于指令执行所需要的数据还未准备好所引起的冒险情况。当即将执行的指令依赖于还未处理完成的数据时，会导致指令无法立刻开始执行，引发数据冒险。</li><li>控制冒险：如果现在要执行哪条指令，是由之前指令的运行结果决定，而现在那条之前指令的结果还没产生，就导致了控制冒险。</li></ul><h2 id="分支预测"><a href="#分支预测" class="headerlink" title="分支预测"></a>分支预测</h2><p>虽然同一时间，流水线中执行了多条指令，但是分支判断带来的跳转，导致无法正确顺序地载入对应的跳转代码进流水线。如果没有分支预测器，处理器将会等待分支指令通过了指令流水线的执行阶段，才把下一条指令送入流水线的第一个阶段—取指令阶段（fetch stage）或者将后续流水线全部清空。这种技术叫做流水线停顿（pipeline stalled）或者流水线冒泡（pipeline bubbling）或者分支延迟间隙，这个非常影响流水线并行执行的效率。</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/branch.png" alt></p><p>为了解决上述问题，流水线中引入了分支预测器来完成分支预测机制。分支预测就是通过预测，把接下来最有可能执行的分支获取进入流水线，就像不存在对比较结果的依赖那样直接执行，这么一来就保持了指令的流畅执行，这也被称为Speculative Execution。不过这种通过预测获取进入流水线的分支终究只是预测分支，实际上不一定是执行这一分支，因此这部分指令的执行结果不应该从流水线中输出。在得到比较结果后，就能知道预测的分支是否为实际应该执行的分支，如果是，流水线中的预测分支指令就能继续执行下去，否则就需要把预测分支的指令排空，重新获取正确分支的指令进入流水线继续执行。 分支预测，可能的方法有很多种。如：分支判断可能的结果是A和B，最差的情况是永远将分支判断的A指令加入流水线，如果真实判断时是A，那就直接执行，如果是B那么再重新加入B也可以，效率能够提高。实际的分支预测中，可能存入很多种方法，也会有固件的模式（Pattern）来适应。如改进上术的分支预判，当有一次实际判断为B时，后面的全部就预判断为B。上面只是简单的介绍一下分支预测的最简单模式，实际现在CPU的分支预测越来越强大，适应的模式越来越多。像AMD的新款Ryzen处理器，已经使用神经网络的机器学习来强化分支预测了。 主流的分支预测器主要有两种：静态预测器（Static Predictor）和动态预测器(Dynamic Predictor)</p><ol><li>静态预测器：预测条件跳转不发生，因此总是顺序取下一条指令推测执行。仅当条件跳转指令被求值确实发生了跳转，则非顺序的代码地址被加载执行。另外一种，则预测条件跳转总会发生，因CPU而异。对于这种静态预测如果产生错误，则惩罚就是清空后续的流水线中的指令。</li><li>动态预测器：基于之前执行的分支信息，处理器对于正在执行的程序所做的决定。比如根据某个分支指令上次是否跳转来预测此次是否跳转。如果上次分支跳转了，则预测此次也会跳转。</li></ol><p>分支预测在很大程度上提高了流水线的运行效率，在明白了CPU的分支预测原理后，对于我们提高代码的运行效率也具有指导意义，通过动态分支预测器我们可以知道本次是否跳转是根据上次的结果来判断的，那么在编写代码时可以通过处理来提高判断的准确率。下面是一个Java例子，通过对一个无序数组和一个有序数组的分支处理，从结果可以看出对有序数组的处理时间明显小于无序数组的处理时间</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">randomTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">SortTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">randomTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> arraySize <span class="token operator">=</span> <span class="token number">32768</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>arraySize<span class="token punctuation">]</span><span class="token punctuation">;</span>        Random rnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> arraySize<span class="token punctuation">;</span> <span class="token operator">++</span>c<span class="token punctuation">)</span>            data<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> rnd<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arraySize<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    sum <span class="token operator">+=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">>=</span><span class="token number">64</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    sum <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    sum <span class="token operator">-=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"random time"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sum = "</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SortTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> arraySize <span class="token operator">=</span> <span class="token number">32768</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>arraySize<span class="token punctuation">]</span><span class="token punctuation">;</span>        Random rnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> arraySize<span class="token punctuation">;</span> <span class="token operator">++</span>c<span class="token punctuation">)</span>            data<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> rnd<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arraySize<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    sum <span class="token operator">+=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">>=</span><span class="token number">64</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    sum <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    sum <span class="token operator">-=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sort time"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sum = "</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行结果</p><pre><code>random time12355sum = -460681728sort time2490sum = -460681728</code></pre><p>这里把排序时间排除在外了，就算把排序时间算在内，得到的结果仍然是对于排序数组的处理时间仍然小于非排序数组的处理时间，结果如下</p><pre><code>random time12355sum = -460681728sort time7225sum = -460681728</code></pre><h2 id="指令的乱序执行"><a href="#指令的乱序执行" class="headerlink" title="指令的乱序执行"></a>指令的乱序执行</h2><p>在按序执行中，一旦遇到指令依赖的情况，流水线就会停滞，如果采用乱序执行，就可以跳到下一个非依赖指令并发布它。这样，执行单元就可以总是处于工作状态，把时间浪费减到最少。乱序执行是一种应用在高性能微处理器中来利用指令周期以避免特定类型的延迟消耗的范式。在这种范式中，处理器在一个由输入数据可用性所决定的顺序中执行指令，而不是由程序的原始数据所决定。在这种方式下，可以避免因为获取下一条程序指令所引起的处理器等待，提前处理下一条可以立即执行的指令。其实很多设计思想都来源于生活，只是应用到不同的领域，就有了它的专业术语，让不懂的人觉得很深奥很高大上，在搞明白怎么回事后，会发现其实也没那么难。举个生活中例子，假设晚上下班回家饿了，想煮碗面做宵夜。需要做以下操作：1.洗水锅，2.烧开水，3.煮面条，4.热菜，5，洗碗筷，6.吃面。其中比较耗时的操作就是烧开水了，如果按CPU的流水线顺序处理这些操作，那我们进行到第2步时就只能等水烧好然后才进去后面的步骤，这要做比较符合常规思维，但是太浪费资源了。因为后面的操作不依赖于前面操作的结果，因此我们完全可以在烧水的同时，把菜热好，把碗筷洗干净准备盛面。这就是CPU指令乱序执行</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/cm.png" alt></p><p>同理类比在CPU的一条流水线中，需要执行多条指令，比如有a,b,c三条指令组成的流水线，执行顺序是a-&gt;b-&gt;c，这三条指令在数据上没有依赖关系，其中b指令需要去主存中读取数据，c指令是为变量分配内存地址，我们知道在CPU在缓存未命中情况下去主存读取数据是比较慢的，因此b指令会占用比较长的时钟周期，而指令c只能干等，这会使程序的执行效率大打折扣。这时指令乱序就会发挥出它的作用了，因为b,c指令没有依赖关系，b,c指令执行顺序调换不会影响最终结果，所以CPU在执行b指令时先会向数据总线发起向主存中读数据的请求，在等待数据加载到CPU的高速缓存期间，会继续执行c指令（注意此时b指令并没有执行完，因为它还没有真正从主存中读到数据），然后再执行继续b指令，这时指令的执行顺序就变成了a-&gt;c-&gt;b。在理解了乱序执行，那么对编码有什么帮助吗？有的，对于开发人员来说，单例模式应该都不陌生，由于频繁创建对象比较浪费资源，就考虑将所有用到某个类的实例时，公用同一个实例，于是就有了单例模式，然而单例模式并不是想象的那么简单。单例模式写法有很多，在保证并发同步的单例模式中，有如下一种写法：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 若singleton为空，则加锁，再进一步判空</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 再判断一次是否为null</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//若为空，则创建一个新的实例</span>                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> Singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这种写法算是一个考虑比较周全的设计了 为了防止多线程调用产生多个实例，采用了同步锁 ，为了降低多线程竞争锁所带来的性能损耗，使用了两次判断，加锁位置得当，尽可能降低了锁对性能的影响 ，但是这个例子在单线程中没有任何问题，但在多线程中，如果出现指令乱序就会返回错误的结果。上面的单例模式中，出现问题的核心代码只有一行，就是第15行。即  <code>singleton = new Singleton();</code> 因为这行代码不是一个原子操作，他实际上包含三个操作：</p><ol><li>为对象 new Singleton() 分配内存空间</li><li>调用类 Singleton 的构造方法，初始化成员变量</li><li>将变量 singleton 的引用指向Singleton 对象的内存地址</li></ol><p>在这三步中，第2步依赖于第1步，但2和3并没有依赖关系，因此第2步和第3步可能会先指令乱序。即当CPU流水线执行第2步时，由于类的初始化需要的时间比较长，为避免流水线阻塞，CPU会先执行第3步，将singleton 先指向对象的地址，因此线程有可能得到一个不为null，但是构造不完全的对象（对于不完全的对象的理解：即全部变量的初始化没有执行完）。对于这种情况有两种解决方案：</p><p>方案一：使用volatile关键字，在java5以前，volatile原语不怎么强大，只能保证对象的可见性。但在java5之后，volatile语义加强了，被volatile修饰的对象，将禁止该对象上的读写指令重排序这样，就保证了线程B读对象时，已经初始化完全了</p><p>方案二：这也是官方比较推荐的一种方案，利用类加载机制来创建单例模式，不一样的是，它是在内部类里面去创建对象实例。这样的话，只要应用中不使用内部类，JVM就不会去加载这个单例类，也就不会创建单例对象</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHolder</span><span class="token punctuation">{</span>          <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token keyword">return</span> SingletonHolder<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  </code></pre><h2 id="as-if-serial语义"><a href="#as-if-serial语义" class="headerlink" title="as-if-serial语义"></a>as-if-serial语义</h2><p>as-if-serial语义的意思指：不管怎么重排序（编译器和处理器为了提高并行度），单线程程序的执行的结果不能被改变。编译器，runtime 和处理器都必须遵守as-if-serial语义。为了遵守as-if-serial语义，编译器和处理器不会对存在数据依赖关系的操作做重排序，因为这种重排序会改变执行结果。但是，如果操作之间不存在数据依赖关系，这些操作可能被编译器和处理器重排序。as-if-serial语义把单线程程序保护了起来，遵守as-if-serial语义的编译器，runtime 和处理器共同为编写单线程程序的程序员创建了一个幻觉：单线程程序是按程序的顺序来执行的（实际上没有依赖的指令会出现重排序，但最终结果与顺序执行的结果一致）。as-if-serial语义使单线程程序员无需担心重排序会 干扰他们，也无需担心内存可见性问题。</p><h2 id="内存屏障（Memory-Barrier-）"><a href="#内存屏障（Memory-Barrier-）" class="headerlink" title="内存屏障（Memory Barrier ）"></a>内存屏障（Memory Barrier ）</h2><p>内存屏障，又称内存栅栏，是一个CPU指令，它有如下特点：1.保证特定操作的执行顺序。2.影响某些数据（或者是某条指令的执行结果）的内存可见性。主要有两个指令：</p><ul><li>Store：将处理器缓存的数据刷新到内存中。</li><li>Load：将内存的数据拷贝到处理器的缓存中。</li></ul><p>编译器和CPU能够重排序指令，保证最终相同的结果，尝试优化性能。插入一条Memory Barrier会告诉编译器和CPU：不管什么指令都不能和这条Memory Barrier指令重排序。Memory Barrier所做的另外一件事是强制刷出各种CPU cache，如一个Write-Barrier（写入屏障）将刷出所有在Barrier之前写入 cache 的数据，因此，任何CPU上的线程都能读取到这些数据的最新版本。java内存模型volatile是基于Memory Barrier实现的。如果一个变量是volatile修饰的，JMM会在写入这个字段之后插进一个Write-Barrier指令，并在读这个字段之前插入一个Read-Barrier指令。这意味着，如果写入一个volatile变量，就可以保证：1.一个线程写入变量a后，任何线程访问该变量都会拿到最新值。2.在写入变量a之前的写入操作，其更新的数据对于其他线程也是可见的。因为Memory Barrier会刷出cache中的所有先前的写入。简单来说内存屏障（Memory Barrier，或内存栅栏，Memory Fence）就是从本地或工作内存到主存之间的拷贝动作。如下图：</p><p><img src="/2019/03/30/java-bing-fa-bian-cheng-cpu-de-liu-shui-xian/lsx.png" alt></p><p>上面三种颜色的箭头，就是跨越内存栅栏。在多线程并发过程中，仅当写操作线程先跨越内存栅栏而读线程后跨越内存栅栏的情况下，写操作线程所做的变更才对其他线程可见。内存屏障分为以下3类：</p><table><thead><tr><th>屏障名称</th><th>作用</th></tr></thead><tbody><tr><td>写屏障(store barrier)</td><td>所有在写屏障之前的所有执行，都要在该屏障之前执行，并发送缓存失效的信号<br>所有在写屏障之后的store指令，都必须在该屏障之前的指令执行完后再被执行</td></tr><tr><td>读屏障(load barrier)</td><td>所有在读屏障之后的load指令，都在读屏障之后执行</td></tr><tr><td>全屏障(Full Barrier)</td><td>所有在该屏障之前的store/load指令，都在该屏障之前被执行<br>所有在该屏障之后的的store/load指令，都在该屏障之后被执行</td></tr></tbody></table><ol><li>Store barrier，是x86的”<strong>sfence</strong>“指令，强制所有在store屏障指令之前的store指令，都在该store屏障指令执行之前被执行，并把store缓冲区的数据都刷到CPU缓存。这会使得程序状态对其它CPU可见，这样其它CPU可以根据需要介入。</li><li>Load barrier，是x86上的”<strong>ifence</strong>“指令，强制所有在load屏障指令之后的load指令，都在该load屏障指令执行之后被执行，并且一直等到load缓冲区被该CPU读完才能执行之后的load指令。这使得从其它CPU暴露出来的程序状态对该CPU可见，这之后CPU可以进行后续处理。</li><li>Full barrier，是x86上的”<strong>mfence</strong>“指令，复合了load和save屏障的功能。</li></ol><h3 id="原子指令和Software-Locks"><a href="#原子指令和Software-Locks" class="headerlink" title="原子指令和Software Locks"></a>原子指令和Software Locks</h3><p>原子指令，如x86上的”lock …” 指令是一个Full Barrier，执行时会锁住内存子系统来确保执行顺序，甚至跨多个CPU。Software Locks通常使用了内存屏障或原子指令来实现变量可见性和保持程序顺序。对应的在java内存模型的内存屏障分为以下4类：</p><ol><li>StoreStore Barriers：确保Store1数据对其他处理器可见(刷新到内存)，之前于Store2及所有后续存储指令的存储。</li><li>LoadStore Barriers：确保Load1数据装载之前于Store2及所有后续存储指令的存储。</li><li>StoreLoad Barriers：确保Store1数据对其他处理器可见(刷新到内存)之前于Load2及所有后续装载指令的装载。</li><li>LoadLoad Barriers：确保Load1数据的装载，之前于Load2及所有后续装载指令的装载。</li></ol><p>其中比较特殊的是StoreLoad Barriers会使该屏障之前的所有内存访问指令(装载和存储指令)完成之后才执行该屏障之后的内存访问指令，是一个”全能型”的屏障，它同时具有其他三个屏障的效果。内存屏障另一个作用是强制更新一次不同CPU的缓存。例如，一个写屏障会把这个屏障前写入的数据刷新到各个CPU的缓存(lazy型刷新, CPU监听数据总线将缓存数据标记为invalid，用到时再重内存中载入)，这样任何试图读取该数据的线程将得到最新值，而不用考虑到底是被哪个cpu核心或者哪颗CPU执行的。java中的volatile关键字正是使用了内存屏障。如果你的字段是volatile，Java内存模型将在写操作后插入一个写屏障指令，在读操作前插入一个读屏障指令。内存屏障作为另一个CPU级的指令，没有锁那样大的开销。内核并没有在多个线程间干涉和调度。但凡事都是有代价的。内存屏障的确是有开销的——编译器/cpu不能重排序指令，导致不可以尽可能地高效利用CPU，另外刷新缓存亦会有开销。所以不要以为用volatile代替锁操作就一点事都没有。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java并发编程-cpu的高速缓存</title>
      <link href="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/"/>
      <url>/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/</url>
      
        <content type="html"><![CDATA[<p>CPU缓存是CPU一个重要的组成部分，CPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，这种访问速度的显著差异，导致CPU可能会花费很长时间等待数据到来或把数据写入内存，基于此，现在CPU大多数情况下读写都不会直接访问内存（CPU都没有连接到内存的管脚），取而代之的是CPU缓存，CPU缓存是位于CPU与内存之间的临时存储器，它的容量比内存小得多但是交换速度却比内存快得多。而缓存中的数据是内存中的一小部分数据，但这一小部分是短时间内CPU即将访问的，当CPU调用大量数据时，就可先从缓存中读取，从而加快读取速度，提高CPU的利用率。CPU缓存一般直接跟CPU芯片集成或位于主板总线互连的独立芯片上。（现阶段的CPU缓存一般直接集成在CPU上）CPU往往需要重复处理相同的数据、重复执行相同的指令，如果这部分数据、指令CPU能在CPU缓存中找到，CPU就不需要从内存或硬盘中再读取数据、指令，从而减少了整机的响应时间。</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/cpus-cat.png" alt></p><a id="more"></a> <h2 id="CPU的三级缓存"><a href="#CPU的三级缓存" class="headerlink" title="CPU的三级缓存"></a>CPU的三级缓存</h2><h3 id="一级缓存（L1-Cache）"><a href="#一级缓存（L1-Cache）" class="headerlink" title="一级缓存（L1 Cache）"></a>一级缓存（L1 Cache）</h3><p>一级缓存这个名词出现应该是在Intel公司Pentium处理器时代把缓存开始分类的时候，一级缓存（Level 1 Cache）简称L1 Cache，位于CPU内核的旁边，是与CPU结合最为紧密的CPU缓存，也是历史上最早出现的CPU缓存。由于一级缓存的技术难度和制造成本最高，提高容量所带来的技术难度增加和成本增加非常大。一般来说，一级缓存可以分为一级数据缓存（Data Cache，D-Cache，L1d）和一级指令缓存(Instruction Cache，I-Cache，L1i)，分别用于存放数据和指令。两者可同时被CPU访问，减少了CPU多核心、多线程争用缓存造成的冲突，提高了处理器的效能。</p><h3 id="二级缓存（L2-Cache）"><a href="#二级缓存（L2-Cache）" class="headerlink" title="二级缓存（L2 Cache）"></a>二级缓存（L2 Cache）</h3><p>CPU未命中L1的情况下继续在L2寻求命中，L2 Cache（二级缓存）是CPU的第二层高速缓存，分内部和外部两种芯片。内部的芯片二级缓存运行速度与主频相同，而外部的二级缓存则只有主频的一半。L2高速缓存容量也会影响CPU的性能，原则是越大越好，现在家庭用CPU容量最大的是4MB，而服务器和工作站上用CPU的L2高速缓存普遍大于4MB，有的高达8MB或者19MB。</p><h3 id="三级缓存（L3-Cache）"><a href="#三级缓存（L3-Cache）" class="headerlink" title="三级缓存（L3 Cache）"></a>三级缓存（L3 Cache）</h3><p>三级缓存是为读取二级缓存后未命中的数据设计的—种缓存，在拥有三级缓存的CPU中，只有约5%的数据需要从内存中调用，这进一步提高了CPU的效率。L3 Cache（三级缓存），分为两种，早期的是外置，截止2012年都是内置的。而它的实际作用即是，L3缓存的应用可以进一步降低内存延迟，同时提升大数据量计算时处理器的性能。降低内存延迟和提升大数据量计算能力对游戏都很有帮助。而在服务器领域增加L3缓存在性能方面仍然有显著的提升。比方具有较大L3缓存的配置利用物理内存会更有效，故它比较慢的磁盘I/O子系统可以处理更多的数据请求。具有较大L3缓存的处理器提供更有效的文件系统缓存行为及较短消息和处理器队列长度。</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>CPU要读取一个数据时，首先从Cache中查找，如果找到就立即读取并送给CPU处理；如果没有找到，就用相对慢的速度从内存中读取并送给CPU处理，同时把这个数据所在的数据块调入Cache中，可以使得以后对整块数据的读取都从Cache中进行，不必再调用内存。正是这样的读取机制使CPU读取Cache的命中率非常高（大多数CPU可达90%左右），也就是说CPU下一次要读取的数据90%都在Cache中，只有大约10%需要从内存读取。这大大节省了CPU直接读取内存的时间，也使CPU读取数据时基本无需等待。总的来说，CPU读取数据的顺序是先Cache后内存（结构：CPU -&gt; cache -&gt; memory），缓存的容量远远小于主存，因此出现缓存不命中的情况在所难免，既然缓存不能包含CPU所需要的所有数据，那么缓存的存在真的有意义吗？CPU cache是肯定有它存在的意义的，至于CPU cache有什么意义，那就要看一下它的局部性原理了：</p><ul><li>时间局部性：如果某个数据被访问，那么在不久的将来它很可能再次被访问</li><li>空间局部性：如果某个数据被访问，那么与它相邻的数据很快也可能被访问</li></ul><p>为了保证CPU访问时有较高的命中率Cache中的内容应该按一定的算法替换，其计数器清零过程可以把一些频繁调用后再不需要的数据淘汰出Cache，提高Cache的利用率。在存在CPU三级缓存的计算机体系中，CPU与内存，缓存的关系就从单个CPU缓存演变成了三级缓存的架构了。</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/cpu1.png" alt></p><p>随着技术的不断更新，目前处理器中包含多个CPU处理器，对于多核CPU，优化操作系统任务调度算法是保证效率的关键。一般任务调度算法有全局队列调度和局部队列调度。前者是指操作系统维护一个全局的任务等待队列，当系统中有一个CPU核心空闲时，操作系统就从全局任务等待队列中选取就绪任务开始在此核心上执行。下面是Intel Core i7处理器的高速缓存的模型</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/cpus.png" alt></p><h3 id="缓存SRAM与内存DRAM的区别"><a href="#缓存SRAM与内存DRAM的区别" class="headerlink" title="缓存SRAM与内存DRAM的区别"></a>缓存SRAM与内存DRAM的区别</h3><p>内存的DRAM其实是SDRAM（同步动态随机储存器），是DRAM（Dynamic RAM，动态）的一种。DRAM只含一个晶体管和一个电容器，集成度非常高，可以轻松做出大容量（内存），但是因为靠电容器来储存信息，所以需要不断刷新补充电容器的电荷，否则内部的数据即会消失。充电放电之间的时间差导致了DRAM比SRAM的反应要缓慢得多。高速缓存基本上都是采用SRAM存储器，SRAM是英文Static RAM的缩写，它是一种具有静态存取功能的存储器，不需要刷新电路即能保存它内部存储的数据。但SRAM相比DRAM的复杂度就高了不止一点点，所以导致SRAM的集成度很低，也是前期CPU缓存不能集成进CPU内部也有这个原因。因此相同容量的DRAM内存可以设计为较小的体积，但是SRAM却需要很大的体积，这也是不能将缓存容量做得太大的重要原因。它的特点归纳如下：优点是节能、速度快、不需要刷新时间所以凸显其数据传输速度很快，缺点是集成度低、相同的容量体积较大、而且价格较高，只能少量用于关键性系统以提高效率。SRAM和DRAM的电路图大致如下：</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/rams0.png" alt></p><p>在一套完整的计算机体系中，一般会包含如下存储介质，它们分别是寄存器，高速缓存，内存，硬盘。它们的容量由小到大，访问速度由高到底，成本由高到低，体积则是由小到大。因此，寄存器，高速缓存等容易集成在CPU或是主板上，但是由于其成本高，所以不会大规模使用，而内存，硬盘成本较低，但体积大，不方便集成，所以可以作为外设，安装在主板上。这些存储介质的大小和访问速度大致如下图：</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/store.png" alt></p><h2 id="缓存一致性（MESI）"><a href="#缓存一致性（MESI）" class="headerlink" title="缓存一致性（MESI）"></a>缓存一致性（MESI）</h2><p>缓存一致性：在多核CPU中，内存中的数据会在多个核心中存在数据副本，某一个核心发生修改操作，就产生了数据不一致的问题。而一致性协议正是用于保证多个CPU cache之间缓存共享数据的一致。试想下面一个问题：</p><ol><li>Core 0读取了一个字节，根据局部性原理，它相邻的字节同样被被读入Core 0的缓存</li><li>Core 1做了上面同样的工作，这样Core 0与Core 1的缓存拥有同样的数据</li><li>Core 0修改了那个字节，被修改后，那个字节被写回Core 0的缓存，但是该信息并没有写回主存</li><li>Core 1访问该字节，由于Core 0并未将数据写回主存，数据不同步</li></ol><h3 id="缓存行"><a href="#缓存行" class="headerlink" title="缓存行"></a>缓存行</h3><p>在细说缓存一致性之前，先说一下缓存行的概念，高速缓存其实就是一组称之为缓存行(cache line)的固定大小的数据块，其大小是以突发读或者突发写周期的大小为基础的。它是CPU缓存中可分配的最小存储单元，大小32字节、64字节、128字节不等，这与CPU架构有关，通常来说是64字节。当从CPU从内存中取数据到cache中时，会一次取一个cacheline大小的内存大小到cache中，然后存进相应的cacheline中。总结来说就是一句话：CPU不是按字节访问内存，而是以64字节为单位的块(chunk)拿取，称为一个缓存行(cache line)。其结构如下</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/cache.png" alt></p><p>工作方式：当CPU从cache中读取数据的时候，会比较地址是否相同，如果相同则检查cache line的状态，再决定该数据是否有效，无效则从主存中获取数据，或者根据一致性协议发生一次cache-to–chache的数据推送；<br>工作效率：当CPU能够从cache中拿到有效数据的时候，消耗几个机器周期，如果发生cache miss（缓存未命中），则会消耗几十上百个机器周期；</p><h3 id="MESI"><a href="#MESI" class="headerlink" title="MESI"></a>MESI</h3><p>知道了缓存行的概念后，回到之前的问题，为了解决这个问题，CPU制造商制定了一个规则：当一个CPU修改缓存中的字节时，服务器中其他CPU会被通知，它们的缓存将视为无效。于是，在上面的情况下，Core 1发现自己的缓存中数据已无效，Core 0将立即把自己的数据写回主存，然后Core 1重新读取该数据，这个就是多级缓存-缓存一致性（MESI）。这协议用于保证多个CPU cache之间缓存共享数据的一致性。它定义了CacheLine的四种数据状态，而CPU对cache的四种操作可能会产生不一致的状态。因此缓存控制器监听到本地操作与远程操作的时候需要对地址一致的CacheLine状态做出一定的修改，从而保证数据在多个cache之间流转的一致性。这里肯定有人疑问，既然多个缓存会出现这些问题，那为什么不能让多个CPU共用一个缓存呢？当然是效率问题，如果多个CPU使用共用一个缓存，那么在每一个时钟或者指令周期，都只能有一个cpu通过缓存对内存进行操作，其他的cpu就进入了等待。流水线就产生了冒泡，会极大浪费硬件资源。所以引入多组缓存，并引入MESI协议使他们用起来的效果像只有一组缓存一样。</p><p>缓存一致性协议有多种，但是日常处理的大多数计算机设备都属于嗅探（snooping）协议，它的基本思想是：所有内存的传输都发生在一条共享的总线上，而所有的处理器都能看到这条总线：缓存本身是独立的，但是内存是共享资源，所有的内存访问都要经过仲裁（同一个指令周期中，只有一个CPU缓存可以对内存读写）。CPU缓存控制器不仅仅在内存传输的时候才与总线打交道，而是不停在嗅探总线上发生的数据交换，跟踪其他缓存在做什么。所以当一个缓存代表它所属的处理器去读写内存时，其它处理器都会得到通知，它们以此来使自己的缓存保持同步。只要某个处理器一写内存，其它处理器马上知道这块内存在它们的缓存段中已失效。ESI协议是当前最主流的缓存一致性协议，在MESI协议中，每个缓存行有4个状态，可用2个bit表示，它们分别是：</p><table><thead><tr><th>状态</th><th>描述</th><th>监听</th></tr></thead><tbody><tr><td>M（modify）</td><td>该Cache line有效，数据被修改了，和内存中的数据不一致，数据只存在于本Cache中。</td><td>缓存行必须时刻监听所有试图读该缓存行相对就主存的操作，这种操作必须在缓存将该缓存行写回主存并将状态变成S（共享）状态之前被延迟执行。</td></tr><tr><td>E（exclusive）</td><td>该Cache line有效，数据和内存中的数据一致，数据只存在于本Cache中。</td><td>缓存行也必须监听其它缓存读主存中该缓存行的操作，一旦有这种操作，该缓存行需要变成S（共享）状态。</td></tr><tr><td>S（shared）</td><td>该Cache line有效，数据和内存中的数据一致，数据存在于很多Cache中。</td><td>缓存行也必须监听其它缓存使该缓存行无效或者独享该缓存行的请求，并将该缓存行变成无效（Invalid）。</td></tr><tr><td>I（invalid）</td><td>该Cache line无效。</td><td>无</td></tr></tbody></table><p>只有当缓存行处于E或者M状态时，处理器是独占这个缓存行的。当处理器想写某个缓存行时，如果它没有独占权，它必须先发送一条”我要独占权”的请求给总线，这会通知其它处理器把它们拥有的同一缓存段的拷贝失效（如果有）。只有在获得独占权后，处理器才能开始修改数据—-并且此时这个处理器知道，这个缓存行只有一份拷贝，在我自己的缓存里，所以不会有任何冲突。反之，如果有其它处理器想读取这个缓存行（马上能知道，因为一直在嗅探总线），独占或已修改的缓存行必须先回到”共享”状态。如果是已修改的缓存行，那么还要先把内容回写到内存中。引起数据状态转换的CPU cache操作也有四种，因为所有CPU核的数据都会经过总线，因此这里其实对应的就是CPU在读取或写入数据时对总线的数据请求类型，分别如下：</p><table><thead><tr><th>操作</th><th>描述</th></tr></thead><tbody><tr><td>本地读取（Local read），简称LR</td><td>当前核读本地高速缓存中的数据</td></tr><tr><td>本地写入（Local write），简称LW</td><td>当前核将数据写到本地高速缓存中</td></tr><tr><td>远端读取（Remote read），简称RR</td><td>其他核将主内存中的数据读取到高速缓存中来</td></tr><tr><td>远端写入（Remote write），简称RW</td><td>其他核将高速缓存中的数据写回到主存里面去</td></tr></tbody></table><p>MESI示意图：</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/mesis.png" alt></p><h3 id="状态转换和cache操作"><a href="#状态转换和cache操作" class="headerlink" title="状态转换和cache操作"></a>状态转换和cache操作</h3><p>如上文内容所述，MESI协议中cache line数据状态有4种，引起数据状态转换的CPU cache操作也有4种，因此要理解MESI协议，就要将这16种状态转换的情况讨论清楚。初始场景：在最初的时候，所有CPU中都没有数据，某一个CPU发生读操作，此时必然发生cache miss，数据从主存中读取到当前CPU的cache，状态为E（独占，只有当前CPU有数据，且和主存一致），此时如果有其他CPU也读取数据，则状态修改为S（共享，多个CPU之间拥有相同数据，并且和主存保持一致），如果其中某一个CPU发生数据修改，那么该CPU中数据状态修改为M（拥有最新数据，和主存不一致，但是以当前CPU中的为准），其他拥有该数据的核心通过缓存控制器监听到remote write行文，然后将自己拥有的数据的cache line状态修改为I（失效，和主存中的数据被认为不一致，数据不可用应该重新获取）。</p><h5 id="1-Modify"><a href="#1-Modify" class="headerlink" title="1 . Modify"></a>1 . Modify</h5><p>场景：当前CPU中数据的状态是Modifiy，表示当前CPU中拥有最新数据，虽然主存中的数据和当前CPU中的数据不一致，但是以当前CPU中的数据为准；</p><ul><li>LR：此时如果发生local read，即当前CPU读数据，直接从cache中获取数据，拥有最新数据，因此状态不变；</li><li>LW：直接修改本地cache数据，修改后也是当前CPU拥有最新数据，因此状态不变；</li><li>RR：因为本地内存中有最新数据，当本地cache控制器监听到总线上有RR发生的时，必然是其他CPU发生了读主存的操作，此时为了保证一致性，当前CPU应该将数据写回主存，而随后的RR将会使得其他CPU和当前CPU拥有共同的数据，因此状态修改为S；</li><li>RW：当cache控制器监听到总线发生RW，当前CPU会将数据写回主存，因为随后的RW将会导致主存的数据修改，因此状态修改成I；</li></ul><h5 id="2-Exclusive"><a href="#2-Exclusive" class="headerlink" title="2 . Exclusive"></a>2 . Exclusive</h5><p>场景：当前CPU中的数据状态是exclusive，表示当前CPU独占数据（其他CPU没有数据），并且和主存的数据一致；</p><ul><li>LR：直接从本地cache中直接获取数据，状态不变；</li><li>LW：修改本地cache中的数据，状态修改成M（因为其他CPU中并没有该数据，不存在共享问题，因此不需要通知其他CPU修改cache line的状态为I）；</li><li>RR：本地cache中有最新数据，当cache控制器监听到总线上发生RR的时候，必然是其他CPU发生了读取主存的操作，而RR操作不会导致数据修改，因此两个CPU中的数据仍和主存中的数据一致，此时cache line状态修改为S；</li><li>RW：同RR，当cache控制器监听到总线发生RW，必然是其他CPU将最新数据写回到主存，此时为了保证缓存一致性，当前CPU的数据状态修改为I；</li></ul><h5 id="3-Shared"><a href="#3-Shared" class="headerlink" title="3 . Shared"></a>3 . Shared</h5><p>场景：当前CPU中的数据状态是shared，表示当前CPU和其他CPU共享数据，且数据在多个CPU之间一致、多个CPU之间的数据和主存一致；</p><ul><li>LR：直接从cache中读取数据，状态不变；</li><li>LW：发生本地写，并不会将数据立即写回主存，而是在稍后的一个时间再写回主存，因此为了保证缓存一致性，当前CPU的cache line状态修改为M，并通知其他拥有该数据的CPU该数据失效，其他CPU将cache line状态修改为I；</li><li>RR：状态不变，因为多个CPU中的数据和主存一致；</li><li>RW：当监听到总线发生了RW，意味着其他CPU发生了写主存操作，此时本地cache中的数据既不是最新数据，和主存也不再一致，因此当前CPU的cache line状态修改为I；</li></ul><h5 id="4-Invalid"><a href="#4-Invalid" class="headerlink" title="4 . Invalid"></a>4 . Invalid</h5><p>场景：当前CPU中的数据状态是invalid，表示当前CPU中是脏数据，不可用，其他CPU可能有数据、也可能没有数据；</p><ul><li>LR：因为当前CPU的cache line数据不可用，因此会发生读内存，此时的情形如下。<ol><li>如果其他CPU中无数据则状态修改为E；</li><li>如果其他CPU中有数据且状态为S或E则状态修改为S；</li><li>如果其他CPU中有数据且状态为M，那么其他CPU首先发生RW将M状态的数据写回主存并修改状态为S，随后当前CPU读取主存数据，也将状态修改为S；</li></ol></li><li>LW：因为当前CPU的cache line数据无效，因此发生LW会直接操作本地cache，此时的情形如下。<ol><li>如果其他CPU中无数据，则将本地cache line的状态修改为M；</li><li>如果其他CPU中有数据且状态为S或E，则修改本地cache，通知其他CPU将数据修改为I，当前CPU中的cache line状态修改为M；</li><li>如果其他CPU中有数据且状态为M，则其他CPU首先将数据写回主存，并将状态修改为I，当前CPU中的cache line转台修改为M；</li></ol></li><li>RR：监听到总线发生RR操作，表示有其他CPU读取内存，和本地cache无关，状态不变；</li><li>RW：监听到总线发生RW操作，表示有其他CPU写主存，和本地cache无关，状态不变；</li></ul><h3 id="java内存模型与硬件内存架构的关系"><a href="#java内存模型与硬件内存架构的关系" class="headerlink" title="java内存模型与硬件内存架构的关系"></a>java内存模型与硬件内存架构的关系</h3><p>学习和使用java语言的开发者，都不可避免的要回到JVM这个模型上来。然而JVM只是一个逻辑上的计算机架构模型，运行于它之上的java服务不可避免的要与底层的操作系统交互，那么JVM的内存模型与硬件的内存架构是怎么样的对应关系呢？本人在学习JVM时也常有这样的疑问，掌握了JVM的内存模型确实能帮助我们理解许多java开发方面的问题，但归根结底还是要驱动硬件工作的，下面就来探讨一下JVM与硬件上内存的关系。</p><h5 id="JVM内存模型"><a href="#JVM内存模型" class="headerlink" title="JVM内存模型"></a>JVM内存模型</h5><p>为了屏蔽各种硬件和操作系统内存的访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果，所以Java虚拟机规范中定义了Java内存模型（Java Memory Model简称JMM）。Java内存模型是一种规范，它定义了Java虚拟机与计算机内存是如何协同工作的。java内存模型的主要目的是定义程序中各个变量的访问规则，以及在必须时如何同步地访问共享变量，即在虚拟机中将变量存储到内存和从内存中取出变量这样的底层细节，JVM内存模型如下图</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/jvm.png" alt></p><ul><li>Head（堆）：java里的堆是一个运行时的数据区，堆是由垃圾回收机制来负责的。堆的优势是可以动态地分配内存大小，生存期也不必事先告诉编译器，因为它是在运行时动态分配内存的，而且Java的垃圾回收机制也会自动的收走那些不再使用的数据。但是它也有缺点，由于是运行时动态分配内存，因此它的存取速度相对要慢一些。</li><li>Stack（栈）：栈的优势是存取速度比堆要快，仅次于计算机里的寄存器，栈的数据是可以共享的。而栈的缺点则是存在栈中的数据的大小以及生存期必须是确定的，缺乏一些灵活性，所以栈中主要用来存储一些基本数据类型和引用数据类型。</li></ul><p>Java内存模型要求调用栈和本地变量存放在线程栈（Thread Stack）上，而对象则存放在堆上。一个本地变量也可能是指向一个对象的引用，这种情况下这个保存对象引用的本地变量是存放在线程栈上的，但是对象本身则是存放在堆上的。一个对象可能包含方法，而这些方法可能包含着本地变量，这些本地变量仍然是存放在线程栈上的。即使这些方法所属的对象是存放在堆上的。一个对象的成员变量，可能会随着所属对象而存放在堆上，不管这个成员变量是原始类型还是引用类型。静态成员变量则是随着类的定义一起存放在堆上。存放在堆上的对象，可以被持有这个对象的引用的线程访问。当一个线程可以访问某个对象时，它也可以访问该对象的成员变量。如果两个线程同时调用同一个对象上的同一个方法，那么它们都将会访问这个方法中的成员变量，但是每一个线程都拥有这个成员变量的私有拷贝。</p><h5 id="java内存模型和硬件内存架构之间的桥接"><a href="#java内存模型和硬件内存架构之间的桥接" class="headerlink" title="java内存模型和硬件内存架构之间的桥接"></a>java内存模型和硬件内存架构之间的桥接</h5><p>上面已经提到，Java内存模型与硬件内存架构之间存在差异。硬件内存架构没有区分线程栈和堆。对于硬件而言，所有的线程栈和堆都分布在主内存中。部分线程栈和堆可能有时候会出现在CPU缓存中和CPU内部的寄存器中。在java动态的内存模型中，分为主内存，和线程工作内存。主内存是所有的线程所共享的，工作内存是每个线程自己有一个，不是共享的。每个线程之间的共享变量存储在主内存里面，每个线程都有一个私有的本地内存，本地内存是Java内存模型的一个抽象的概念，并不是真实存在的。从一个更低的层次来说，主内存就是硬件的内存，而为了获取更好的运行速度，虚拟机及硬件系统可能会让工作内存优先存储于寄存器和高速缓存中。因此Java内存模型中的线程的工作内存（working memory）是cpu的寄存器和高速缓存的抽象描述。主内存则可理解为物理主存的抽象。而JVM的静态内存存储模型（JVM内存模型）只是一种对物理内存的划分而已，它只局限在物理内存，而且只局限在JVM进程中的的物理内存。</p><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/jvmcputer.png" alt></p><p>如果上图中的线程A和线程B要通信，必须经历两个步骤：</p><ol><li>首先线程A要把本地内存A中更新过的共享变量刷新到主内存里</li><li>然后线程B再到主内存中去读取线程A更新的共享变量，这样就完成了两个线程之间的通信了</li></ol><p>因此，多线程的环境下就会出现线程安全问题。例如我们要进行一个计数的操作：线程A在主内存中读取到了变量值为1，然后保存到本地内存A中进行累加。就在此时线程B并没有等待线程A把累加后的结果写入到主内存中再进行读取，而是在主内存中直接读取到了变量值为1，然后保存到本地内存B中进行累加。此时，两个线程之间的数据是不可见的，当两个线程同时把计算后的结果都写入到主内存中，就导致了计算结果是错误的。这种情况下，我们就需要采取一些同步的手段，确保在并发环境下，程序处理结果的准确性。</p><h5 id="多线程的三个特性"><a href="#多线程的三个特性" class="headerlink" title="多线程的三个特性"></a>多线程的三个特性</h5><p>1、原子性（Atomicity）<br>　　原子性是指一个原子操作在cpu中不可以暂停然后再调度，既不被中断操作，要不执行完成，要不就不执行。原子操作保证了原子性问题。</p><p>　　x++（包含三个原子操作）a.将变量x 值取出放在寄存器中 b.将将寄存器中的值+1 c.将寄存器中的值赋值给x</p><pre><code>由Java内存模型来直接保证的原子性变量操作包括read、load、use、assign、store和write六个，大致可以认为基础数据类型的访问和读写是具备原子性的。如果应用场景需要一个更大范围的原子性保证，Java内存模型还提供了lock和unlock操作来满足这种需求，尽管虚拟机未把lock与unlock操作直接开放给用户使用，但是却提供了更高层次的字节码指令monitorenter和monitorexit来隐匿地使用这两个操作，这两个字节码指令反映到Java代码中就是同步块---synchronized关键字，因此在synchronized块之间的操作也具备原子性。</code></pre><p>2、可见性(Visibility)</p><p>　　java 内存模型的主内存和工作内存，解决了可见性问题。<br>　　volatile赋予了变量可见——禁止编译器对成员变量进行优化，它修饰的成员变量在每次被线程访问时，都强迫从内存中重读该成员变量的值；而且，当成员变量发生变化时，强迫线程将变化值回写到共享内存，这样在任何时刻两个不同线程总是看到某一成员变量的同一个值，这就是保证了可见性。</p><pre><code>可见性就是指当一个线程修改了线程共享变量的值，其它线程能够立即得知这个修改。无论是普通变量还是volatile变量都是如此，普通变量与volatile变量的区别是volatile的特殊规则保证了新值能立即同步到主内存，以及每使用前立即从内存刷新。因为我们可以说volatile保证了线程操作时变量的可见性，而普通变量则不能保证这一点。</code></pre><p>3、有序性(Ordering)<br>　　Java内存模型中的程序天然有序性可以总结为一句话：如果在本线程内观察，所有操作都是有序的；如果在一个线程中观察另一个线程，所有操作都是无序的。前半句是指“线程内表现为串行语义”，后半句是指“指令重排序”现象和“工作内存主主内存同步延迟”现象。</p><h5 id="java内存模型定义同步的八种操作"><a href="#java内存模型定义同步的八种操作" class="headerlink" title="java内存模型定义同步的八种操作"></a>java内存模型定义同步的八种操作</h5><p> JLS定义了线程对主存的操作指令：lock，unlock，read，load，use，assign，store，write。这些行为是不可分解的原子操作，在使用上相互依赖，read-load从主内存复制变量到当前工作内存，use-assign执行代码改变共享变量值，store-write用工作内存数据刷新主存相关内容。</p><ul><li>read（读取）：作用于主内存变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</li><li>load（载入）：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中。</li><li>use（使用）：作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎，每当虚拟机遇到一个需要使用变量的值的字节码指令时将会执行这个操作。</li><li>assign（赋值）：作用于工作内存的变量，它把一个从执行引擎接收到的值赋值给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。</li><li>store（存储）：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作。</li><li>write（写入）：作用于主内存的变量，它把store操作从工作内存中一个变量的值传送到主内存的变量中。</li></ul><p><img src="/2019/03/24/java-bing-fa-bian-cheng-cpu-de-gao-su-huan-cun/jvmsc.png" alt></p><h5 id="java中的volatile关键字"><a href="#java中的volatile关键字" class="headerlink" title="java中的volatile关键字"></a>java中的volatile关键字</h5><p>定义为volatile类型的变量拥有两种语义：</p><ol><li>变量的修改对所有线程可见</li></ol><ul><li><p>线程中每次use变量时，都需要连续执行read-&gt;load-&gt;use几项操作，即所谓的每次使用都要从主内存更新变量值，这样其它线程的修改对该线程就是可见的。</p></li><li><p>线程每次assign变量时，都需要连续执行assign-&gt;store-&gt;write几项操作，即所谓每次更新完后都会回写到主内存，这样使得其它线程读到的都是最新数据。</p></li></ul><ol start="2"><li>禁止指令重排</li></ol><p>有了上面的理论基础，我们可以研究volatile关键字到底是如何实现的。首先写一段简单的代码：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> LazySingleton instance <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> LazySingleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span>             instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LazySingleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>将代码转换为汇编指令，在汇编指令的中我们可以找到如下信息</p><pre><code>0x0000000002931351: lock add dword ptr [rsp],0h ;*putstatic instance; - org.xrq.test.design.singleton.LazySingleton::getInstance@12 (line 13)</code></pre><p>之所以定位到这两行是因为这里结尾写明了line 13，line 13即volatile变量instance赋值的地方。后面的add dword ptr [rsp],0h都是正常的汇编语句，意思是将双字节的栈指针寄存器+0，这里的关键就是add前面的lock指令，观察加入volatile关键字和没有加入volatile关键字时所生成的汇编代码发现，加入volatile关键字时，会多出一个lock前缀指令lock前缀指令实际上相当于一个内存屏障（也成内存栅栏），内存屏障会提供3个功能：</p><ul><li><p>它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</p></li><li><p>它会强制将对缓存的修改操作立即写入主存；</p></li><li><p>如果是写操作，它会导致其他CPU中对应的缓存行无效。</p></li></ul><p>这里需注意虽然volatile关键字保证了变量对于线程的可见性，但并不保证线程安全。举个例子，线程1对变量进行读取操作之后，被阻塞了的话，并没有对变量值进行修改。然后虽然volatile能保证线程2对变量inc的值读取是从内存中读取的，但是线程1没有进行修改，所以线程2根本就不会看到修改的值。根源就在这里，而且volatile也无法保证对变量的任何操作都是原子性的。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并发编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聊聊运维监控</title>
      <link href="/2019/02/17/liao-liao-yun-wei-jian-kong/"/>
      <url>/2019/02/17/liao-liao-yun-wei-jian-kong/</url>
      
        <content type="html"><![CDATA[<p>最近在公司参与公司运维监控平台的建设，用到一些关于监控的第三方开源工具包，在此记录一下。说到运维监控，本人在公司就曾经历过一段痛苦的日子，在某个重要的日子，由于公司没有完善运维监控平台，为保障系统稳定。公司大部分的开发人员和售后全都扑在了服务器和服务状态的监测上，每天的工作就是手动检查上千台服务器和几千个服务的内存，磁盘，CPU使用情况，大概持续了一周左右。因为这些都是重复性的工作，我还记得当时有人提出用跑脚本的方式直接看结果。没想到我们的上级负责人竟然说：“不许使用脚本，这种重要时候我只相信人，不相信脚本”。此言一出，我真的是无力吐槽，人是会累的，机器不会累，竟然还只信人，不信机器。后来想想其实可以理解，他大概是太过紧张了，那段重要日子对于公司来说确实非常重要，出不得差错。不过在经历过那段黑暗的时间后，让我觉得，系统的运维监控必须要有，靠人力运维是一件高成本，低回报，费力不讨好的活。在未接触运维之前，我总认为开发就是一个项目的重中之重，一个优秀的开发者，一个精良的架构设计能使项目的工作事半功倍。但现在我觉得运维才是重点，因为任何一个项目的开发周期是远远小于它的维护周期的，如何低成本的保障系统长期稳定的运行才是最重要的，也是保证用户体验的重要手段  。特别是对于庞大复杂的系统，运维监控系统必不可少。一个成熟完善的运维系统能有效的监测公司服务器和业务系统的异常情况，并马上做出告警大大减小了问题排查的成本。后面公司也意识到了这一点，并开展了运维平台的建设工作，下面就是在工作中总结的一些关于监控开源工具包的使用，以及一些开源的运维监控组件的介绍。</p><p><img src="/2019/02/17/liao-liao-yun-wei-jian-kong/yw.png" alt></p><a id="more"></a> <h2 id="监控核心"><a href="#监控核心" class="headerlink" title="监控核心"></a>监控核心</h2><p>简单来说，监控系统就是一套解决应用、服务或系统故障发现、故障预警、故障定位，运行状态展示等多种功能融合一体的一个解决文案。也可以称之为一套系统。监控系统是整个运维环节，乃至整个产品生命周期中最重要的一环，事前及时预警发现故障，事后提供翔实的数据用于追查定位问题。监控系统作为一个成熟的运维产品，业界有很多开源的实现可供选择。当公司刚刚起步，业务规模较小，运维团队也刚刚建立的初期，选择一款开源的监控系统，是一个省时省力，效率最高的方案。之后，随着业务规模的持续快速增长，监控的对象也越来越多，越来越复杂。开源监控工具也非常多，主要如下</p><h3 id="老牌监控"><a href="#老牌监控" class="headerlink" title="老牌监控:"></a><strong>老牌监控:</strong></h3><p><strong>MRTG（Multi Route Trffic Grapher）：</strong>是一套可用来绘制网络流量图的软件，由瑞士奥尔滕的Tobias Oetiker与Dave Rand所开发，以GPL授权。<br>MRTG最好的版本是1995年推出的，用perl语言写成，可跨平台使用，数据采集用SNMP协议，MRTG将手机到的数据通过Web页面以GIF或者PNG格式绘制出图像。</p><p><strong>Grnglia：</strong>是一个跨平台的、可扩展的、高性能的分布式监控系统，如集群和网格。它基于分层设计，使用广泛的技术，用RRDtool存储数据。具有可视化界面，适合对集群系统的自动化监控。其精心设计的数据结构和算法使得监控端到被监控端的连接开销非常低。目前已经有成千上万的集群正在使用这个监控系统，可以轻松的处理2000个节点的集群环境。</p><p><strong>Cacti：</strong>（英文含义为仙人掌）是一套基于PHP、MySQL、SNMP和RRDtool开发的网络流量监测图形分析工具，它通过snmpget来获取数据使用RRDtool绘图，但使用者无须了解RRDtool复杂的参数。提供了非常强大的数据和用户管理功能，可以指定每一个用户能查看树状结构、主机设备以及任何一张图，还可以与LDAP结合进行用户认证，同时也能自定义模板。在历史数据展示监控方面，其功能相当不错。<br>Cacti通过添加模板，使不同设备的监控添加具有可复用性，并且具备可自定义绘图的功能，具有强大的运算能力（数据的叠加功能）</p><p><strong>Nagios：</strong>是一个企业级监控系统，可监控服务的运行状态和网络信息等，并能监视所指定的本地或远程主机状态以及服务，同时提供异常告警通知功能等。<br>Nagios可运行在Linux和UNIX平台上。同时提供Web界面，以方便系统管理人员查看网络状态、各种系统问题、以及系统相关日志等<br>Nagios的功能侧重于监控服务的可用性，能根据监控指标状态触发告警。<br>目前Nagios也占领了一定的市场份额，不过Nagios并没有与时俱进，已经不能满足于多变的监控需求，架构的扩展性和使用的便捷性有待增强，其高级功能集成在商业版Nagios XI中。</p><p><strong>Smokeping：</strong>主要用于监视网络性能，包括常规的ping、www服务器性能、DNS查询性能、SSH性能等。底层也是用RRDtool做支持，特点是绘制图非常漂亮，网络丢包和延迟用颜色和阴影来标示，支持将多张图叠放在一起，其作者还开发了MRTG和RRDtll等工具。 </p><p><strong>开源监控系统OpenTSDB：</strong>用Hbase存储所有时序（无须采样）的数据，来构建一个分布式、可伸缩的时间序列数据库。它支持秒级数据采集，支持永久存储，可以做容量规划，并很容易地接入到现有的告警系统里。<br>OpenTSDB可以从大规模的集群（包括集群中的网络设备、操作系统、应用程序）中获取相应的采集指标，并进行存储、索引和服务，从而使这些数据更容易让人理解，如Web化、图形化等。</p><h3 id="王牌监控"><a href="#王牌监控" class="headerlink" title="王牌监控"></a><strong>王牌监控</strong></h3><p><strong>Zabbix</strong>是一个分布式监控系统，支持多种采集方式和采集客户端，有专用的Agent代理，也支持SNMP、IPMI、JMX、Telnet、SSH等多种协议，它将采集到的数据存放到数据库，然后对其进行分析整理，达到条件触发告警。其灵活的扩展性和丰富的功能是其他监控系统所不能比的。相对来说，它的总体功能做的非常优秀。<br>从以上各种监控系统的对比来看，Zabbix都是具有优势的，其丰富的功能、可扩展的能力、二次开发的能力和简单易用的特点，读者只要稍加学习，即可构建自己的监控系统。</p><p><strong>OpenFalcon：</strong>是小米的开源监控系统，OpenFalcon是一款企业级、高可用、可扩展的开源监控解决方案，OpenFalcon的目标是做最开放、最好用的互联网企业级监控产品。</p><p><strong>OWL：</strong>是TalkingData公司推出的一款开源分布式监控系统<a href="https://github.com/TalkingData/owl" target="_blank" rel="noopener">OWL的github地址</a></p><h2 id="数据收集"><a href="#数据收集" class="headerlink" title="数据收集"></a>数据收集</h2><p>一般的监控系统的架构是在被监控的节点运行自己的监控Agent，作为嗅探器。按照用户自定义的方式实时采集监控数据，采集到数据后，就需要将数据提交到数据中心了，这里提交的方式有两种，一种是数据中心主动向各个Agent拉取监控数据，这样的好处是编程简单，但数据中心的压力会比较大。第二种是各个Agent主动上报数据，先将数据提交到消息队列，数据中心直接从消息队列拉取数据就行了。</p><p><strong>中心端主动拉取</strong>：就是由一个中心端定时的向采集端<code>按需拉取数据</code>。这种模式的优点在于可以按需拉取，不会有浪费。但是在这个模型中，中心承担了过大的压力。理论上性能会有很大的瓶颈。</p><p><img src="/2019/02/17/liao-liao-yun-wei-jian-kong/jk1.png" alt></p><p><strong>客户端主动上报</strong>：就是所有数据一视同仁，全都上报。一般来讲，会采用一个统一的proxy来收集，后边会考虑做多级的组件，或者加一层MQ等，都是可以考量的设计。整体来讲，如果预估监控数据的量比较大。还是建议采用自采集然后集中上报的模式。</p><p><img src="/2019/02/17/liao-liao-yun-wei-jian-kong/jk.png" alt></p><p>由于公司的运维平台需求不多，只是做一些服务器和服务的简单监控，所以公司建设的运维监控平台没有使用开源的组件，而是通过一些基本的手段来获取监控信息，并将收集到的监控信息存储到数据库，再做统计分析展示。架构方案则使用的是客户端主动上报的方式。我负载的就是基础数据采集部分的开发工作，对期间使用的技术，方案做一些记录。</p><h2 id="1-Linux监控命令"><a href="#1-Linux监控命令" class="headerlink" title="1. Linux监控命令"></a>1. Linux监控命令</h2><h3 id="1-top"><a href="#1-top" class="headerlink" title="(1) . top"></a>(1) . top</h3><p>top命令是最流行Unix/Linux的性能工具之一。它显示所有正在运行而且处于活动状态的实时进程， 而且会定期更新显示结果；它显示了CPU使用率，内存使用率，交换内存使用大小，调整缓存使用大小，缓冲区使用大小，进程PID， 使用的命令等信息。在终端执行top命令后，结果如下：</p><pre class=" language-shell"><code class="language-shell">[root@localhost ~]# toptop - 19:01:24 up 17 min,  3 users,  load average: 0.00, 0.04, 0.12Tasks: 162 total,   1 running, 161 sleeping,   0 stopped,   0 zombieCpu(s):  5.4%us,  3.3%sy,  0.0%ni, 87.8%id,  3.1%wa,  0.0%hi,  0.3%si,  0.0%stMem:   2940796k total,  2857996k used,    82800k free,    13044k buffersSwap:  2097144k total,        0k used,  2097144k free,  1041468k cached   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND  2236 root      20   0 2326m 955m  11m S  3.6 33.3   1:57.20 java   289 root      20   0     0    0    0 S  1.8  0.0   0:00.34 jbd2/sda2-8  2050 root      20   0  133m 4068 1564 S  1.8  0.1   0:00.09 nginx  2052 root      20   0  134m 6096 2700 S  1.8  0.2   0:01.03 nginx  9696 root      20   0 15032 1152  832 R  1.8  0.0   0:00.06 top</code></pre><p>这里信息比较多，各个参数的含义如下：</p><table><thead><tr><th>资源概况：top行</th><th></th></tr></thead><tbody><tr><td>19:01:24</td><td>系统当前时间，这里是24小时制</td></tr><tr><td>up 17 min</td><td>系统开机以后的运行时间，17分钟</td></tr><tr><td>3 users</td><td>系统用户登录在线数量，当前为3人</td></tr><tr><td>load average:0.00, 0.04, 0.12</td><td>load   average后面三个数分别是1分钟、5分钟、15分钟的负载情况</td></tr><tr><td><strong>运行任务概况：Tasks行</strong></td><td></td></tr><tr><td>162 total</td><td>系统当前的进程数，总共162个进程</td></tr><tr><td>1 running</td><td>正在运行的进程数，当前为1个</td></tr><tr><td>161 sleeping</td><td>睡眠中的进程数，当前睡眠数为161个</td></tr><tr><td>0 stopped</td><td>停止的进程数，当前为0个</td></tr><tr><td>0 zombie</td><td>僵尸进程，当前为0个</td></tr><tr><td><strong>CPU概况：Cpu(s)行</strong></td><td></td></tr><tr><td>5.4%us</td><td>用户空间占用CPU时间百分比。多核情况，这个数值表示占用的平均百分比</td></tr><tr><td>3.3%sy</td><td>内核空间占用CPU时间百分比，多核情况同上</td></tr><tr><td>0.0%ni</td><td>用户进程空间内改变过优先级的进程占用CPU时间百分比</td></tr><tr><td>87.8%id</td><td>空闲时间占用CPU百分比，当前为87.8%</td></tr><tr><td>3.1%wa</td><td>等待输入输出的CPU时间百分比</td></tr><tr><td>0.0%hi</td><td>CPU服务于硬件中断的CPU时间百分比</td></tr><tr><td>0.3%si</td><td>CPU服务于软件中断的CPU时间百分比</td></tr><tr><td>0.0%st</td><td>虚拟机占用百分比</td></tr><tr><td><strong>内存概况：Mem行</strong></td><td></td></tr><tr><td>2940796k total</td><td>内存总量，单位kb</td></tr><tr><td>2857996k used</td><td>内存使用大小，单位kb</td></tr><tr><td>82800k free</td><td>剩余的内存大小，单位kb</td></tr><tr><td>13044k buffers</td><td>用于缓冲的内存大小</td></tr><tr><td><strong>交换区概览：Swap行</strong></td><td></td></tr><tr><td>2097144k total</td><td>交换区总量</td></tr><tr><td>0k used</td><td>使用的交换区大小</td></tr><tr><td>2097144k free</td><td>空闲的交换区大小</td></tr><tr><td>1041468k cached</td><td>用于缓冲的交换区大小</td></tr><tr><td><strong>进程概况</strong></td><td></td></tr><tr><td>PID</td><td>进程ID，唯一标识</td></tr><tr><td>USER</td><td>进程所属用户</td></tr><tr><td>SWAP</td><td>进程使用的虚拟内存中,被换出的大小,单位kb.</td></tr><tr><td>CODE</td><td>可执行代码占用的物理内存大小,单位kb</td></tr><tr><td>DATA</td><td>可执行代码以外的部分(数据段+栈)占用的物理内存大小,单位kb</td></tr><tr><td>RES</td><td>进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</td></tr><tr><td>VIRT</td><td>进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</td></tr><tr><td>SHR</td><td>共享内存大小，意思是这一块内存空间可能也被其他应用程序使用。单位kb</td></tr><tr><td>%CPU</td><td>自上一次top刷新该进程占用CPU的时间百分比</td></tr><tr><td>%MEM</td><td>进程消耗内存百分比</td></tr><tr><td>TIME+</td><td>自进程开始以来，消耗CPU时间，单位1/100秒</td></tr><tr><td>S</td><td>进程状态: <strong>D:</strong>不可中断的睡眠状态;<strong>R:</strong>运行; <strong>S:</strong>睡眠; <strong>T:</strong>跟踪/停止; <strong>Z:</strong>僵尸进程</td></tr><tr><td>### (2) . free</td><td></td></tr></tbody></table><p>free命令可以显示Linux系统中空闲的、已用的物理内存及swap内存,及被内核使用的buffer。在Linux系统监控的工具中，free命令是最经常使用的命令之一。命令执行的结果如下：</p><pre class=" language-shell"><code class="language-shell">[root@localhost ~]# free -m             total       used       free     shared    buffers     cachedMem:          2871       2797         74          0         13        844-/+ buffers/cache:       1939        931Swap:         2047          0       2047</code></pre><p>下面是各个参数的含义：</p><table><thead><tr><th>参数</th><th>释义</th><th>数据说明</th></tr></thead><tbody><tr><td>total</td><td>内存总数，物理内存总数</td><td>总内存大小：2871 kb</td></tr><tr><td>used</td><td>已经使用的内存数</td><td>已使用内存：2797 kb</td></tr><tr><td>free</td><td>空闲的内存数</td><td>空闲内存大小：74 kb</td></tr><tr><td>shared</td><td>共享使用的物理内存大小</td><td>当前已废弃不用内存：0 kb</td></tr><tr><td>buffers Buffer</td><td>缓存内存数</td><td>缓存内存大小：13 kb</td></tr><tr><td>cached Page</td><td>缓存内存数</td><td>缓存内存大小：844 kb</td></tr><tr><td>-buffers/cache</td><td>应用使用内存数</td><td>公式：Mem行的used – buffers – cached</td></tr><tr><td>+buffers/cache</td><td>应用可用内存数</td><td>公式：Mem行的free + buffers + cached</td></tr><tr><td>Swap</td><td>交换分区，虚拟内存</td><td></td></tr></tbody></table><p>对内存来说，buffers/cached 都是属于被使用，所以它认为free只有74kb。我们通过free命令查看机器空闲内存时，会发现free的值很小。这主要是因为，在Linux系统中有这么一种思想，内存不用白不用，因此它尽可能的cache和buffer一些数据，以方便下次使用。但实际上这些内存也是可以立刻拿来给需要的进程使用的。弄清楚参数意义，才能更好的使用这些命令来帮助我们了解服务器状态，开发出更高质量的应用，以为Mem行free内存很少，是不是需要升级服务器内存等等。看内存够不够用重点是要看(-/+ buffers/cache)的free和used为主。可见-buffers/cache反映的是被程序实实在在吃掉的内存，而+buffers/cache反映的是可以挪用的内存总数。对应用程序来讲是(-/+ buffers/cach).buffers/cached 是等同可用的，因为buffer/cached是为了提高程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。这里还需要理解几个名词的含义</p><h4 id="buff-cache"><a href="#buff-cache" class="headerlink" title="buff/cache"></a><strong>buff/cache</strong></h4><p><strong>buffer</strong> 在操作系统中指 buffer cache， 中文一般翻译为 “缓冲区”。要理解缓冲区，必须明确另外两个概念：”扇区” 和 “块”。扇区是设备的最小寻址单元，也叫 “硬扇区” 或 “设备块”。块是操作系统中文件系统的最小寻址单元，也叫 “文件块” 或 “I/O 块”。每个块包含一个或多个扇区，但大小不能超过一个页面，所以一个页可以容纳一个或多个内存中的块。当一个块被调入内存时，它要存储在一个缓冲区中。buffer cache 只有块的概念而没有文件的概念，它只是把磁盘上的块直接搬到内存中而并不关心文件内容。每个缓冲区与一个块对应，它相当于是磁盘块在内存中的表示：</p><p><img src="/2019/02/17/liao-liao-yun-wei-jian-kong/yunwei1.png" alt></p><p><strong>cache</strong> 在操作系统中指 page cache，中文一般翻译为 “页高速缓存”。页高速缓存是内核实现的磁盘缓存。它主要用来减少对磁盘的 I/O 操作。具体地讲，是通过把磁盘中的数据缓存到物理内存中，把对磁盘的访问变为对物理内存的访问。页高速缓存缓存的是内存页面。<strong>缓存中的页来自对普通文件、块设备文件(这个指的就是 buffer cache 呀)和内存映射文件的读写</strong>。页高速缓存对普通文件的缓存我们可以这样理解：当内核要读一个文件(比如 /etc/hosts)时，会先检查这个文件的数据是不是已经在页高速缓存中了。如果在，就放弃访问磁盘，从内存中读取。这个行为称为缓存命中。如果数据不在缓存中，就是未命中缓存，此时内核就要调度块 I/O 操作从磁盘去读取数据。然后内核将读来的数据放入页高速缓存中。这种缓存的目标是文件系统可以识别的文件(比如 /etc/hosts)。页高速缓存对块设备文件的缓存就是在前面介绍的 buffer cahce。因为独立的磁盘块通过缓冲区也被存入了页高速缓存(缓冲区最终是由页高速缓存来承载的)。到这里我们应该搞清楚了：无论是缓冲区还是页高速缓存，它们的实现方式都是一样的。缓冲区只不过是一种概念上比较特殊的页高速缓存罢了。那么为什么 free 命令不直接称为 cache 而非要写成 buff/cache？ 这是因为缓冲区和页高速缓存的实现并非天生就是统一的。在 linux 内核 2.4 中才将它们统一。更早的内核中有两个独立的磁盘缓存：页高速缓存和缓冲区高速缓存。前者缓存页面，后者缓存缓冲区。当你知道了这些故事之后，输出中列的名称可能已经不再重要了。</p><h4 id="Swap"><a href="#Swap" class="headerlink" title="Swap"></a>Swap</h4><p>交换分区swap space 是磁盘上的一块区域，可以是一个分区，也可以是一个文件。所以具体的实现可以是 swap 分区也可以是 swap 文件。当系统物理内存吃紧时，Linux 会将内存中不常访问的数据保存到 swap 上，这样系统就有更多的物理内存为各个进程服务，而当系统需要访问 swap 上存储的内容时，再将 swap 上的数据加载到内存中，这就是常说的换出和换入。交换空间可以在一定程度上缓解内存不足的情况，但是它需要读写磁盘数据，所以性能不是很高。</p><p>现在的机器一般都不太缺内存，如果系统默认还是使用了 swap 是不是会拖累系统的性能？理论上是的，但实际上可能性并不是很大。并且内核提供了一个叫做 swappiness 的参数，用于配置需要将内存中不常用的数据移到 swap 中去的紧迫程度。这个参数的取值范围是 0～100，0 告诉内核尽可能的不要将内存数据移到 swap 中，也即只有在迫不得已的情况下才这么做，而 100 告诉内核只要有可能，尽量的将内存中不常访问的数据移到 swap 中。在 ubuntu 系统中，swappiness 的默认值是 60。如果我们觉着内存充足，可以在 /etc/sysctl.conf 文件中设置 swappiness的值</p><h3 id="（3）-vmstat"><a href="#（3）-vmstat" class="headerlink" title="（3）. vmstat"></a>（3）. vmstat</h3><pre class=" language-shell"><code class="language-shell">[root@localhost ~]# vmstat 2procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st 1  0      0  79492  50680 787836    0    0   248   136  206  268  4  3 91  2  0 0  0      0  79352  50680 787836    0    0     0     2  501  592  6  3 91  0  0</code></pre><p>这表示vmstat每2秒采集数据，一直采集。用来获得有关进程、虚存、页面交换空间及 CPU活动的信息。这些信息反映了系统的负载情况。这里有必要了解一下<strong>虚拟内存的运行原理：</strong>在系统中运行的每个进程都需要使用到内存，但不是每个进程都需要每时每刻使用系统分配的内存空间。当系统运行所需内存超过实际的物理内存，内核会释放某些进程所占用但未使用的部分或所有物理内存，将这部分资料存储在磁盘上直到进程下一次调用，并将释放出的内存提供给有需要的进程使用。在Linux内存管理中，主要是通过“调页Paging”和“交换Swapping”来完成上述的内存调度。调页算法是将内存中最近不常使用的页面换到磁盘上，把活动页面保留在内存中供进程使用。交换技术是将整个进程，而不是部分页面，全部交换到磁盘上。分页(Page)写入磁盘的过程被称作Page-Out，分页(Page)从磁盘重新回到内存的过程被称作Page-In。当内核需要一个分页时，但发现此分页不在物理内存中(因为已经被Page-Out了)，此时就发生了分页错误（Page Fault）。当系统内核发现可运行内存变少时，就会通过Page-Out来释放一部分物理内存。经管Page-Out不是经常发生，但是如果Page-out频繁不断的发生，直到当内核管理分页的时间超过运行程式的时间时，系统效能会急剧下降。这时的系统已经运行非常慢或进入暂停状态，这种状态亦被称作thrashing(颠簸)。下面解释一下各个参数的含义：</p><table><thead><tr><th>procs</th><th></th></tr></thead><tbody><tr><td>r</td><td>等待执行的任务数（当这个值超过了cpu个数，就会出现cpu瓶颈）</td></tr><tr><td>b</td><td>等待IO的进程数量</td></tr><tr><td><strong>memory</strong></td><td></td></tr><tr><td>swpd</td><td>虚拟的内存，单位kb</td></tr><tr><td>free</td><td>空闲内存大小</td></tr><tr><td>buff</td><td>已用的buff大小，对块设备的读写进行缓冲</td></tr><tr><td>cache</td><td>已用的cache大小，文件系统的cache</td></tr><tr><td>inact</td><td>非活跃内存大小</td></tr><tr><td>active</td><td>活跃的内存大小</td></tr><tr><td><strong>swap</strong></td><td></td></tr><tr><td>si</td><td>每秒从交换区写入内存的大小（单位：kb/s）</td></tr><tr><td>so</td><td>每秒从内存写到交换区的大小（单位：kb/s）</td></tr><tr><td><strong>io</strong></td><td></td></tr><tr><td>bi</td><td>每秒读取的块数（读磁盘），现在的Linux版本块的大小为1024bytes</td></tr><tr><td>bo</td><td>每秒写入的块数（写磁盘）</td></tr><tr><td><strong>system</strong></td><td></td></tr><tr><td>in</td><td>每秒中断数，包括时钟中断（in和cs值越大，会看到由内核消耗的cpu时间会越多）</td></tr><tr><td>cs</td><td>每秒上下文切换数（in和cs值越大，会看到由内核消耗的cpu时间会越多）</td></tr><tr><td><strong>cpu</strong></td><td></td></tr><tr><td>us</td><td>用户进程执行消耗cpu时间(user time)</td></tr><tr><td>sy</td><td>系统进程消耗cpu时间(system time)</td></tr><tr><td>id</td><td>空闲时间(包括IO等待时间)</td></tr><tr><td>wa</td><td>等待IO时间(Wa过高时，说明io等待比较严重，可能是由于磁盘大量随机访问造成的，也可能是磁盘的带宽出现瓶颈)</td></tr></tbody></table><h3 id="（4）-iostat"><a href="#（4）-iostat" class="headerlink" title="（4）. iostat"></a>（4）. iostat</h3><p><code>iostat</code>是I/O statistics（输入/输出统计）的缩写，iostat命令查看系统的IO请求数量、系统处理IO请求的耗时，进而分析进程与操作系统的交互过程中IO方面是否存在瓶颈。同时也会汇报出CPU使用情况。同<code>vmstat</code>一样，<code>iostat</code>也有一个弱点，就是它不能对某个进程进行深入分析，仅对系统的整体情况进行分析。<code>iostat</code>常用命令格式如下：</p><pre class=" language-shell"><code class="language-shell">iostat [参数] [时间] [次数]命令参数说明如下：-c 显示CPU使用情况-d 显示磁盘使用情况-k 以K为单位显示-m 以M为单位显示-N 显示磁盘阵列(LVM) 信息-n 显示NFS使用情况-p 可以报告出每块磁盘的每个分区的使用情况-t 显示终端和CPU的信息-x 显示详细信息</code></pre><p>执行<code>iostat -x</code>命令，会得到如下结果。如果command not found可通过yum 来安装，安装命令如下<code>yum install sysstat</code></p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# iostat -xLinux 3.10.0-693.el7.x86_64 (centos1)   2019年02月21日  _x86_64_        (2 CPU)avg-cpu:  %user   %nice %system %iowait  %steal   %idle           0.35    0.00    0.79    0.57    0.00   98.28Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %utilsda               0.02     0.44   19.01    4.90   581.91    79.51    55.33     0.08    3.42    2.26    7.95   0.84   2.01</code></pre><p>输出内容详解：</p><table><thead><tr><th>avg-cpu</th><th></th></tr></thead><tbody><tr><td>%user</td><td>CPU处在用户模式下的时间百分比</td></tr><tr><td>%nice</td><td>CPU处在带NICE值的用户模式下的时间百分比</td></tr><tr><td>%system</td><td>CPU处在系统模式下的时间百分比</td></tr><tr><td>%iowait</td><td>CPU等待输入输出完成时间的百分比</td></tr><tr><td>%steal</td><td>管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比</td></tr><tr><td>%idle</td><td>CPU空闲时间百分比</td></tr><tr><td><strong>Device</strong></td><td></td></tr><tr><td>rrqm/s</td><td>每秒进行 merge 的读操作数目。即 rmerge/s</td></tr><tr><td>wrqm/s</td><td>每秒进行 merge 的写操作数目。即 wmerge/s</td></tr><tr><td>r/s</td><td>每秒完成的读 I/O 设备次数。即 rio/s</td></tr><tr><td>w/s</td><td>每秒完成的写 I/O 设备次数。即 wio/s</td></tr><tr><td>rsec/s</td><td>每秒读扇区数。即 rsect/s</td></tr><tr><td>wsec/s</td><td>每秒写扇区数。即 wsect/s</td></tr><tr><td>rkB/s</td><td>每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。</td></tr><tr><td>wkB/s</td><td>每秒写K字节数。是 wsect/s 的一半。</td></tr><tr><td>avgrq-sz</td><td>平均每次设备I/O操作的数据大小 (扇区)。</td></tr><tr><td>avgqu-sz</td><td>平均I/O队列长度。</td></tr><tr><td>await</td><td>平均每次设备I/O操作的等待时间 (毫秒)。</td></tr><tr><td>r_await</td><td>每个读操作平均所需时间；不仅包括硬盘设备读操作时间，还包括了在kernel队列中的等待时间</td></tr><tr><td>w_await</td><td>每个写操作平均所需时间；不仅包括硬盘设备写操作时间，还包括了在kernel队列中的等待时间</td></tr><tr><td>svctm</td><td>平均每次设备I/O操作的服务时间 (毫秒)。</td></tr><tr><td>%util</td><td>一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比。如果该参数是100%表示设备已经接近满负荷运行了，该磁盘可能存在瓶颈</td></tr></tbody></table><p>说明：如果%iowait的值过高，表示硬盘存在I/O瓶颈，%idle值高，表示CPU较空闲，如果%idle值高但系统响应慢时，有可能是CPU等待分配内存，此时应加大内存容量。%idle值如果持续低于10，那么系统的CPU处理能力相对较低，表明系统中最需要解决的资源是CPU。如果 %util 接近 100%，说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。如果 svctm 比较接近 await，说明 I/O 几乎没有等待时间；如果 await 远大于 svctm，说明I/O 队列太长，io响应太慢，则需要进行必要优化。如果avgqu-sz比较大，也表示有大量io在等待。网上有个形象的比喻来理解这些属性：</p><ul><li>r/s+w/s 类似于交款人的总数</li><li>平均队列长度(avgqu-sz)类似于单位时间里平均排队人的个数</li><li>平均服务时间(svctm)类似于收银员的收款速度</li><li>平均等待时间(await)类似于平均每人的等待时间</li><li>平均I/O数据(avgrq-sz)类似于平均每人所买的东西多少</li><li>I/O 操作率 (%util)类似于收款台前有人排队的时间比例</li></ul><p>设备IO操作：总IO(io)/s = r/s(读) +w/s(写)</p><p>这些命令可在一定程度上，获取服务器当前的一些信息，可用作于参考。如果上面的命令不能满足业务需求，也可以自定义一些shell命令。但这些命令都是在Linux终端执行时才能看到这些信息，如果想通过java获取，就需要特定的工具包了。在java中jdk自带有工具类执行shell脚本，如下</p><pre class=" language-java"><code class="language-java">Runtime run <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Process process <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这两行代码只能在本地机器上执行shell命令，那如果想要远程连接Linux并执行shell命令，获取一些信息该怎么做呢，这里需要开源jar包的支持了，maven依赖如下</p><pre><code>        &lt;dependency&gt;            &lt;groupId&gt;ch.ethz.ganymed&lt;/groupId&gt;            &lt;artifactId&gt;ganymed-ssh2&lt;/artifactId&gt;            &lt;version&gt;262&lt;/version&gt;        &lt;/dependency&gt;</code></pre><p>在java中就可远程登陆Linux执行shell脚本，登陆代码如下</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 登录主机     * @return     *      登录成功返回Connection，否则返回null     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Connection <span class="token function">login</span><span class="token punctuation">(</span>String ip<span class="token punctuation">,</span>                                   String userName<span class="token punctuation">,</span>                                   String userPwd<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------linux连接开始--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Connection conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//连接</span>            <span class="token keyword">boolean</span> flg<span class="token operator">=</span>conn<span class="token punctuation">.</span><span class="token function">authenticateWithPassword</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> userPwd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//认证</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"=========登录是否成功========="</span><span class="token operator">+</span>flg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//如报错Authentication method password not supported by the server at this stage</span>            <span class="token comment" spellcheck="true">//需在服务器中 vi /etc/ssh/sshd_config，将PasswordAuthentication配置项改成yes，重启</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> conn<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>执行shell命令的方法如下</p><pre class=" language-java"><code class="language-java">     <span class="token comment" spellcheck="true">/**     * 远程执行shll脚本或者命令     * @param cmd     *      即将执行的命令     * @return     *      命令执行完后返回的结果值     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">execute</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">,</span>String cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>        String result<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>conn <span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>                Session session<span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//打开一个会话</span>                session<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//执行命令</span>                String DEFAULT_CODE <span class="token operator">=</span> <span class="token string">"UTF-8"</span><span class="token punctuation">;</span>                result<span class="token operator">=</span><span class="token function">processStdout</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DEFAULT_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"执行命令失败,链接conn:"</span><span class="token operator">+</span>conn<span class="token operator">+</span><span class="token string">",执行的命令："</span><span class="token operator">+</span>cmd<span class="token operator">+</span><span class="token string">"  "</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 解析脚本执行返回的结果集     * @param in 输入流对象     * @param charset 编码     * @return     *       以纯文本的格式返回     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">processStdout</span><span class="token punctuation">(</span>InputStream in<span class="token punctuation">,</span> String charset<span class="token punctuation">)</span><span class="token punctuation">{</span>        InputStream stdout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamGobbler</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        StringBuilder buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            BufferedReader br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>stdout<span class="token punctuation">,</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String line<span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token operator">=</span>br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="2-sigar"><a href="#2-sigar" class="headerlink" title="2 . sigar"></a>2 . sigar</h2><p>通过shell命令获取服务器信息比较直接但不通用，如果服务器既有Linux和Windows服务器，那么通过shell命令获取服务器信息就不好办了，这里介绍一下Sigar。sigar全名是System Information Gatherer And Reporter，Sigar是Hyperic-hq产品的基础包,是Hyperic HQ主要的数据收集组件。它用来从许多平台收集系统和处理信息。这些平台包括：Linux, Windows, Solaris, AIX, HP-UX, FreeBSD and Mac OSX。Sigar可以获得系统的如下介个方面的信息：</p><ol><li>操作系统的信息，包括：dataModel、cpuEndian、name、version、arch、machine、description、patchLevel、vendor、vendorVersion、vendorName、vendorCodeName</li><li>CPU信息，包括：基本信息（vendor、model、mhz、cacheSize）和统计信息（user、sys、idle、nice、wait）</li><li>内存信息，物理内存和交换内存的总数、使用数、剩余数；RAM的大小</li><li>进程信息，包括每个进程的内存、CPU占用数、状态、参数、句柄等。</li><li>文件系统信息，包括名称、容量、剩余数、使用数、分区类型等</li><li>网络接口信息，包括基本信息和统计信息。</li><li>网络路由和链接表信息</li></ol><p>Sigar.jar下载地址：<a href="http://sigar.hyperic.com/" target="_blank" rel="noopener">http://sigar.hyperic.com</a>，解压文件，把文件sigar.jar提取出来，放入到你自己的系统中。注意:Sigar为不同平台提供了不同的库文件.典型的:</p><table><thead><tr><th>平台</th><th>依赖库</th></tr></thead><tbody><tr><td>Linux</td><td>libsigar-amd64-linux.so<br>libsigar-x86-linux.so</td></tr><tr><td>Windows</td><td>sigar-amd64-winnt.dll<br>sigar-x86-winnt.dll</td></tr></tbody></table><p>到这里sigar的原理也就知道个大概了，就是通过java调用底层c++的类库来获取服务器信息的，因此需要将类库添加到jdk的环境变量中，以方便能加载到，但是这样程序移植起来就比较麻烦了，每次换台服务器就得重新配置类库的路径。可以自己写一个方法，将类库复制到服务器的临时文件夹中，再把这个路径加到java的path即可。</p><h3 id="3-ohsi"><a href="#3-ohsi" class="headerlink" title="3 . ohsi"></a>3 . ohsi</h3><p>ohsi是github上开源的工具包，其地址：<a href="https://github.com/oshi/oshi。maven依赖如下：" target="_blank" rel="noopener">https://github.com/oshi/oshi。maven依赖如下：</a></p><pre><code>         &lt;dependency&gt;            &lt;groupId&gt;com.github.oshi&lt;/groupId&gt;            &lt;artifactId&gt;oshi-core&lt;/artifactId&gt;            &lt;version&gt;3.13.0&lt;/version&gt;        &lt;/dependency&gt;</code></pre><p>取得 cpu信息 示例</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Options: ERROR > WARN > INFO > DEBUG > TRACE</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Initializing System..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SystemInfo si <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HardwareAbstractionLayer hal <span class="token operator">=</span> si<span class="token punctuation">.</span><span class="token function">getHardware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        OperatingSystem os <span class="token operator">=</span> si<span class="token punctuation">.</span><span class="token function">getOperatingSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------CPU信息获取-----------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Oshi<span class="token punctuation">.</span><span class="token function">printCpu</span><span class="token punctuation">(</span>hal<span class="token punctuation">.</span><span class="token function">getProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printCpu</span><span class="token punctuation">(</span>CentralProcessor processor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Uptime: "</span> <span class="token operator">+</span> FormatUtil<span class="token punctuation">.</span><span class="token function">formatElapsedSecs</span><span class="token punctuation">(</span>processor<span class="token punctuation">.</span><span class="token function">getSystemUptime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>                <span class="token string">"Context Switches/Interrupts: "</span> <span class="token operator">+</span> processor<span class="token punctuation">.</span><span class="token function">getContextSwitches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" / "</span> <span class="token operator">+</span> processor<span class="token punctuation">.</span><span class="token function">getInterrupts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> prevTicks <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getSystemCpuLoadTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU, IOWait, and IRQ ticks @ 0 sec:"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>prevTicks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Wait a second...</span>        Util<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ticks <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getSystemCpuLoadTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU, IOWait, and IRQ ticks @ 1 sec:"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> user <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>USER<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>USER<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> nice <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>NICE<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>NICE<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> sys <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> idle <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IDLE<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IDLE<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> iowait <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IOWAIT<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IOWAIT<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> irq <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IRQ<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>IRQ<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> softirq <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>SOFTIRQ<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>SOFTIRQ<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> steal <span class="token operator">=</span> ticks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>STEAL<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> prevTicks<span class="token punctuation">[</span>TickType<span class="token punctuation">.</span>STEAL<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> totalCpu <span class="token operator">=</span> user <span class="token operator">+</span> nice <span class="token operator">+</span> sys <span class="token operator">+</span> idle <span class="token operator">+</span> iowait <span class="token operator">+</span> irq <span class="token operator">+</span> softirq <span class="token operator">+</span> steal<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>                <span class="token string">"User: %.1f%% Nice: %.1f%% System: %.1f%% Idle: %.1f%% IOwait: %.1f%% IRQ: %.1f%% SoftIRQ: %.1f%% Steal: %.1f%%%n"</span><span class="token punctuation">,</span>                <span class="token number">100d</span> <span class="token operator">*</span> user <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> nice <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> sys <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> idle <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span>                <span class="token number">100d</span> <span class="token operator">*</span> iowait <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> irq <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> softirq <span class="token operator">/</span> totalCpu<span class="token punctuation">,</span> <span class="token number">100d</span> <span class="token operator">*</span> steal <span class="token operator">/</span> totalCpu<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"CPU load: %.1f%% (counting ticks)%n"</span><span class="token punctuation">,</span> processor<span class="token punctuation">.</span><span class="token function">getSystemCpuLoadBetweenTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"CPU load: %.1f%% (OS MXBean)%n"</span><span class="token punctuation">,</span> processor<span class="token punctuation">.</span><span class="token function">getSystemCpuLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> loadAverage <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getSystemLoadAverage</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU load averages:"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>loadAverage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">" N/A"</span> <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">" %.2f"</span><span class="token punctuation">,</span> loadAverage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token operator">+</span> <span class="token punctuation">(</span>loadAverage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">" N/A"</span> <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">" %.2f"</span><span class="token punctuation">,</span> loadAverage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token operator">+</span> <span class="token punctuation">(</span>loadAverage<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">" N/A"</span> <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">" %.2f"</span><span class="token punctuation">,</span> loadAverage<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// per core CPU</span>        StringBuilder procCpu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"CPU load per processor:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> load <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getProcessorCpuLoadBetweenTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">double</span> avg <span class="token operator">:</span> load<span class="token punctuation">)</span> <span class="token punctuation">{</span>            procCpu<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">" %.1f%%"</span><span class="token punctuation">,</span> avg <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>procCpu<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="4-snmp"><a href="#4-snmp" class="headerlink" title="4 . snmp"></a>4 . snmp</h2><p>SNMP是英文”Simple Network Management Protocol”的缩写，中文意思是”简单网络管理协议”。SNMP是一种简单网络管理协议，它属于TCP/IP五层协议中的应用层协议，用于网络管理的协议。SNMP主要用于网络设备的管理。由于SNMP协议简单可靠 ，受到了众多厂商的欢迎，成为了目前最为广泛的网管协议。SNMP协议主要由两大部分构成：SNMP管理站和SNMP代理。SNMP管理站是一个中心节点，负责收集维护各个SNMP元素的信息，并对这些信息进行处理，最后反馈给网络管理员；而SNMP代理是运行在各个被管理的网络节点之上，负责统计该节点的各项信息，并且负责与SNMP管理站交互，接收并执行管理站的命令，上传各种本地的网络信息。SNMP管理站和SNMP代理之间是松散耦合。他们之间的通信是通过UDP协议完成的。一般情况下，SNMP管理站通过UDP协议向SNMP代理发送各种命令，当SNMP代理收到命令后，返回SNMP管理站需要的参数。但是当SNMP代理检测到网络元素异常的时候，也可以主动向SNMP管理站发送消息，通告当前异常状况。使用snmp服务需要在Linux服务器上安装并启动snmpd服务。在java中同样提供了开源工具包使用snmpd服务，maven依赖如下</p><pre><code>        &lt;dependency&gt;            &lt;groupId&gt;org.snmp4j&lt;/groupId&gt;            &lt;artifactId&gt;snmp4j&lt;/artifactId&gt;            &lt;version&gt;1.10.1&lt;/version&gt;        &lt;/dependency&gt;</code></pre><p>代码使用实例如下</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">initSnmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 设置Agent方传输协议并打开监听</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>transport <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultUdpTransportMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            transport<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>snmp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            snmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Snmp</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>            snmp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getInfoByOidGet</span><span class="token punctuation">(</span>String ip<span class="token punctuation">,</span> String port<span class="token punctuation">,</span> String oid<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//1、初始化snmp,并开启监听</span>            <span class="token function">initSnmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//2、创建目标对象</span>            Target target <span class="token operator">=</span> <span class="token function">getTarget</span><span class="token punctuation">(</span>ip <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//3、创建报文</span>            PDU pdu <span class="token operator">=</span> <span class="token function">createPDU</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//4、发送报文，并获取返回结果</span>            ResponseEvent responseEvent <span class="token operator">=</span> snmp<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pdu<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>            PDU response <span class="token operator">=</span> responseEvent<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>response <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Vector vector <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getVariableBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>vector <span class="token operator">==</span> null <span class="token operator">||</span> vector<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    String str <span class="token operator">=</span> vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> str<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    </code></pre>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git的原理</title>
      <link href="/2019/02/14/git-de-yuan-li/"/>
      <url>/2019/02/14/git-de-yuan-li/</url>
      
        <content type="html"><![CDATA[<p>自工作起就一直使用Git，但一直没去真正了解Git的工作原理，实在惭愧。任何一个项目，团队协作非常重要，在互联网企业级开发中，没有个人英雄主义，一个人几乎不可能独立完成一个项目。因此当很多人共同协作去完成一个项目时，工作成果的维护是一个老大难的问题。Git就是为解决这个问题而生，Git最初是用于 Linux内核开发的版本控制工具。版本控制系统主要就是控制、协调各个版本的文件内容的一致性，这些文件包括文本、图片等等。早期SVN占据了绝大部分市场，而后来随着Git的出现，越来越多的人选择将它作为版本控制工具，社区也越来越强大。相较于SVN，最核心的区别是Git是分布式的VCS，换而言之，每一个你pull下来的Git仓库都是主仓库的一个分布式版本，仓库的内容完全一样，而SVN则不然，它需要一个中央版本库来进行集中控制。采用分布式模式的好处便是你不再依赖于网络，当有更改需要提交的时候而你又无法连接网络时，只需要把更改提交到本地的Git仓库，最后有网络的时候再把本地仓库和远程的主仓库进行同步即可。</p><p><img src="/2019/02/14/git-de-yuan-li/git.jpg" alt></p><a id="more"></a> <h3 id="1-基本原理"><a href="#1-基本原理" class="headerlink" title="1. 基本原理"></a>1. 基本原理</h3><p> Git 究竟是怎样的一个系统呢？ 若你理解了 Git 的思想和基本工作原理，用起来就会知其所以然，游刃有余。本质上，Git是一套内容寻址（content-addressable）文件系统，而和我们直接接触的Git界面，只不过是封装在其之上的一个应用层。这个关系颇有点类似于计算机网络中应用层和底层的关系。在Git中，那些和应用层相关的命令（也就是我们最常用的命令，如git commit、 git push等），我们称之为porcelain命令（瓷器之意，意为成品、高级命令）；而和底层相关的命令（几乎不会在日常中使用，如git hash-object、git update-index等），则称之为plumbing命令（管道之意，是连接git应用界面和git底层实现的一个管道，类似于shell，底层命令）。想要了解Git的底层原理，其实一种高效的学习方式，就是假设自己要设计一套版本管理系统，该怎么设计呢。在思考一定的程度后，再去学习Git的原理，一定会有所收获。在开始学习 Git 之前，我们先来了解一下Git的对象模型</p><h2 id="2-Git的对象模型"><a href="#2-Git的对象模型" class="headerlink" title="2. Git的对象模型"></a>2. Git的对象模型</h2><p>如果学过或使用过面向对象的语言，那么“对象”这个概念一定不会陌生，通常具有一些能完成指定功能的方法或者标识对象特征的属性。Git也具有对象，当然不能和面向对象中的对象等同，它也有自身的特征下面做一下介绍。在Git中一共有四种对象</p><ul><li><strong>Blob对象：</strong>这个对象最为简单，blob对象就是单纯存储数据，通常是文本内容。假如有一个readme.txt文件，那么它就会形成一个blob对象。Git会根据文件内容计算出一个hash值，以hash值作为文件索引存储在Git文件系统中。由于相同的文件内容的hash值是一样的，因此Git将同样内容的文件只会存储一次。</li><li><strong>Tree对象:</strong> 树结构最擅长的就是记录层级结构，刚好对应Git需要记录的文件目录结构。Tree对象可以指向其他Tree对象或者Blob对象。树对象可以看做是开发阶段源代码目录树的一次次快照，因此我们可以是用树对象作为源代码版本管理。但是，这里仍然有问题需要解决，即我们需要记住每个树对象的hash值，才能找到个阶段的源代码文件目录树。在源代码版本控制中，我们还需要知道谁提交了代码、什么时候提交的、提交的说明信息等。</li><li><strong>Commit提交对象：</strong>对于commit命令大家就比较熟悉了，实际上每进行一次commit提交就生成一个commit对象。在commit对象中就存储了提交人，提交时间以及一些备注信息。一个commit对象指向一个tree对象，提交是一步一步推进的，除了第一个commit，后续的commit都有parent父提交，如果是合并的提交，它有多个父提交。</li><li><strong>Tag标签对象：</strong>Git中的标签与分支类似，都是指向某一个commit提交对象的引用或者说指针。</li></ul><p>说了这么多，那么在使用master分支，把代码提交到本地仓库后，本地仓库中，git对象是怎么样的拓扑结构呢。我们看下图，会发现最终所有的对象都指向了HEAD。分支master指向的是一个最新提交的commit对象的ID，每个commit代表的是一次提交，这样设计就非常巧妙了，既然可以从任意提交开始建立一条历史追踪链，用一个文件指向这个链条的最新提交，那么这个文件就可以用于追踪整个提交历史了。</p><p><img src="/2019/02/14/git-de-yuan-li/git1.png" alt></p><h2 id="3-Git的目录结构"><a href="#3-Git的目录结构" class="headerlink" title="3. Git的目录结构"></a>3. Git的目录结构</h2><p>实际上我们Git的本地仓库就是一个文件夹。但是为什么这些文件夹就是Git仓库呢？这是因为Git在初始化的时候会生成一个.git的文件夹，而Git进行版本控制所需要的文件，则都放在这个文件夹中。git init命令相信大家都比较熟悉，使用这个命令就可以把本地文件夹初始化成为一个Git的本地仓库。然后在文件夹中会多出一个.git的文件，默认情况下.git文件夹是隐藏的。在设置中显示隐藏文件夹，就可以到里面一看究竟了。</p><p><img src="/2019/02/14/git-de-yuan-li/git2.png" alt></p><p>上图就是.git文件夹中的目录结构。下面来看一下每个目录的作用</p><ul><li><strong>config文件</strong>：该文件主要记录针对该项目的一些配置信息，这里将写入远程URL，比如你的邮箱、用户名等，通过git remote add命令增加的远程分支的信息就保存在这里；</li><li><strong>description文件</strong>：被gitweb (Github的原型)用来显示对repo的描述。</li><li><strong>hooks文件夹：</strong>这个目录存放一些shell脚本，主要定义了客户端或服务端钩子脚本，这些脚本主要用于在特定的命令和操作之前或者之后进行特定的处理。比如：当你把本地仓库push到服务器的远程仓库时，可以在服务器仓库的hooks文件夹下定义post_update脚本，在该脚本中可以通过脚本代码将最新的代码部署到服务器的web服务器上，从而将版本控制和代码发布无缝连接起来</li><li><strong>objects文件夹：</strong>所有的Git对象都会存放在这个目录中，对象的SHA1哈希值的前两位是文件夹名称，后38位作为对象文件名；</li><li><strong>HEAD文件：</strong>该文件指明了git branch（即当前分支）的结果，比如当前分支是master，则该文件就会指向master，但是并不是存储一个master字符串，而是分支在refs中的表示，例如ref: refs/heads/master。</li><li><strong>index文件：</strong>该文件保存了暂存区域的信息。该文件某种程度就是缓冲区（staging area），内容包括它指向的文件的时间戳、文件名、sha1值等；</li><li><strong>Refs文件夹</strong>：该文件夹存储指向数据（分支）的提交对象的指针。其中heads文件夹存储本地每一个分支最近一次commit的sha-1值（也就是commit对象的sha-1值），每个分支一个文件；remotes文件夹则记录你最后一次和每一个远程仓库的通信，Git会把你最后一次推送到这个remote的每个分支的值都记录在这个文件夹中；tag文件夹则是分支的别名，这里不需要对其有过多的了解；</li></ul><p>除此以外，.git目录下还有很多其他的文件和文件夹，这些文件和文件夹会额外支撑一些其他的功能，但是不是Git的核心部分，因此稍作了解即可。logs则记录了本地仓库和远程仓库的每一个分支的提交记录，即所有的commit对象（包括时间、作者等信息）都会被记录在这个文件夹中，因此这个文件夹中的内容是我们查看最频繁的，不管是Git log命令还是tortoiseGit的show log，都需要从该文件夹中获取提交日志；info文件夹保存了一份不希望在.gitignore 文件中管理的忽略模式的全局可执行文件，基本也用不上；COMMIT_EDITMSG文件则记录了最后一次提交时的注释信息。从以上的描述中我们可以发现，.git文件夹中包含了众多功能不一的文件夹和文件，这些文件夹和文件是描述Git仓库所必不可少的信息，不可以随意更改或删除；尤其需要注意的是，.git文件夹随着项目的演进，可能会变得越来越大，因为任何文件的任何一个变动，都需要Git在objects文件夹下将其重新存储为一个新的对象文件，因此如果一个文件非常大，那么你提交几次改动就会造成.git文件夹容量成倍增长。因此，.git文件夹更像是一本书，每一个版本的每一个变动都存储在这本书中，而且这本书还有一个目录，指明了不同的版本的变动内容存储在这本书的哪一页上，这就是Git的最基本的原理。</p><h2 id="4-常用的术语"><a href="#4-常用的术语" class="headerlink" title="4. 常用的术语"></a>4. 常用的术语</h2><h4 id="（1）暂存区"><a href="#（1）暂存区" class="headerlink" title="（1）暂存区"></a>（1）暂存区</h4><p>暂存区是一个文件，路径为： <code>.git/index</code>。它是一个二进制文件，但是我们可以使用命令来查看其中的内容。暂存区的使用场景是这样的，每当修改了一个或几个文件后，把它加入到暂存区，然后接着修改其他文件，改好后放入暂存区，循环反复。直到修改完毕，最后使用 commit 命令，将暂存区的内容永久保存到本地仓库。这个过程其实就是构建项目快照的过程，当我们提交时，git 会使用暂存区的这些信息生成tree对象，也就是项目快照，永久保存到数据库中。因此也可以说暂存区是用来构建项目快照的区域</p><h4 id="（2）分支"><a href="#（2）分支" class="headerlink" title="（2）分支"></a>（2）分支</h4><p>分支是一个很重要的概念，当我们有几个人开发人员同一个项目上，会为每个开发人员建立一个分支，这样各开发人员就能开发各自的代码版本而不被别人干扰。但这样做的有个麻烦的地方就是需要一个人做代码合并，这个角色一般会由项目经理一做，顺便可以做一下代码评审。一般小型项目开一个分支就够了，所有都在这个分支上开发。分支的实现其实很简单，我们可以先看一下 .git/HEAD 文件，它保存了当前的分支。</p><pre><code>cat .git/HEAD=&gt;ref: refs/heads/master</code></pre><p>其实这个 ref 表示的就是一个分支，它也是一个文件，我们可以继续看一下这个文件的内容：</p><pre><code>cat .git/refs/heads/master=&gt; 2b388d2c1c20998b6233ff47596b0c87ed3ed8f8</code></pre><p>可以看到分支存储了一个 object，我们可以使用 cat-file 命令继续查看该 object 的内容。</p><pre><code>git cat-file -p 2b388d2c1c20998b6233ff47596b0c87ed3ed8f8=&gt; tree 15f880be0567a8844291459f90e9d0004743c8d9=&gt; parent 3d885a272478d0080f6d22018480b2e83ec2c591=&gt; author Hehe Tan &lt;xiayule148@gmail.com&gt; 1460971725 +0800=&gt; committer Hehe Tan &lt;xiayule148@gmail.com&gt; 1460971725 +0800=&gt; =&gt; add branch paramter for rebase</code></pre><p>从上面的内容，我们知道了分支指向了一次提交。当我们提交新的commit，这个分支的指向只需要跟着更新就可以了，而创建分支仅仅是创建一个指针。</p><h2 id="5-Git常用命令详解"><a href="#5-Git常用命令详解" class="headerlink" title="5. Git常用命令详解"></a>5. Git常用命令详解</h2><p>以下对几个git命令进行介绍，重点在于对这些命令的基本使用的普及，包括：git clone、git commit、git reset、git reverse和git add。大多数情况下，我们在开发中小型项目的时候，如果团队成员不是很多，则只需要开一个分支就够了。在这种情况下，只要你操作规范，在push之前注意pull最新的代码，则基本不会出现比较严重的冲突或者问题，这时候以上命令基本都用不上，但是在多分支的情况下，我们可能会使用以上的命令来进行分支合并或者版本回退等，因此，我们有必要对这些命令做一个简单的了解，知道在什么时候去使用它们。</p><p><img src="/2019/02/14/git-de-yuan-li/git3.png" alt></p><p>在 git 中分为两种类型的命令，一种是完成底层工作的工具集，称为底层命令，另一种是对用户更友好的高层命令。一条高层命令，往往是由多条底层命令组成的。git常用的高层命令如下</p><p><img src="/2019/02/14/git-de-yuan-li/git5.png" alt></p><p>下面分别对一些常用命令加以说明</p><h3 id="Git-reset"><a href="#Git-reset" class="headerlink" title="Git reset"></a>Git reset</h3><p>在使用Git的过程中。某些时候，当你不小心改错了内容，或者错误地在本地commit了某些本不该提交的修改，我们就需要进行版本的回退。版本回退最常用的命令包括<code>git reset</code>和<code>git revert</code>。这两个命令允许我们在版本的历史之间穿梭。<code>git reset</code> 命令是用来将当前 branch 重置到另外一个 commit 的，这个动作可能同时影响到 index 以及 work directory。先举个例子，来一个感性的认识。现在有一个hotfix分支。</p><p><img src="/2019/02/14/git-de-yuan-li/git6.png" alt></p><p>在执行下面这两条命令让 hotfix分支向后回退两个提交。上图就是命令执行前后，分支状态的对比。</p><pre class=" language-shell"><code class="language-shell">git checkout hotfixgit reset HEAD~2</code></pre><p>hotfix 分支末端的两个提交现在变成了孤儿提交。下次 Git 执行垃圾回收的时候，这两个提交会被删除。如果你的提交还没有共享给别人，可以用<code>git reset</code>撤销这些提交。因此<code>git reset</code>的使用场景是在本地版本需要回退时使用（前提是没有推送到远程库）。回退前，用<code>git log</code>可以查看提交历史，以便确定要回退到哪个版本；要重返未来，用<code>git reflog</code>查看命令历史，以便确定要回到未来的哪个版本。</p><h3 id="Git-revert"><a href="#Git-revert" class="headerlink" title="Git revert"></a>Git revert</h3><p>Git revert用来撤销某次操作，此次操作之前和之后的commit和history都会保留，并且把这次撤销作为一次最新的提交。<code>git revert</code>是提交一个新的版本，将需要revert的版本的内容再反向修改回去，版本会递增，不影响之前提交的内容。虽然代码回退了，但是版本依然是向前的，所以，当你用revert回退之后，所有人pull之后，他们的代码也自动的回退了。Git revert和<code>git reset</code>都可以进行版本的回退，将工作区回退到历史的某个状态，二者有如下的区别：</p><ul><li><code>git revert</code>是用一次新的commit来回滚之前的commit，而git reset是直接删除指定的commit（并没有真正的删除，通过<code>git reflog</code>可以找回），这是二者最显著的区别；</li><li><code>git reset</code> 是把HEAD向后移动了一下，而<code>git revert</code>是HEAD继续前进，只是新的commit的内容和要revert的内容正好相反，能够抵消要被revert的内容；</li></ul><p>使用revert HEAD是撤销最近的一次提交，如果你最近一次提交是用revert命令产生的，那么你再执行一次，就相当于撤销了上次的撤销操作，换句话说，你连续执行两次revert HEAD命令，就跟没执行是一样的。git revert 命令的好处就是不会丢掉别人的提交，即使你撤销后覆盖了别人的提交，他更新代码后，可以在本地用 reset 向前回滚，找到自己的代码，然后拉一下分支，再回来合并上去就可以找回被你覆盖的提交了。</p><h3 id="Git-fork"><a href="#Git-fork" class="headerlink" title="Git fork"></a>Git fork</h3><p>Git fork不是一个Git命令，而是一种工作流。它不是使用单个服务端仓库作为中央代码基线，而让各个开发者都有一个服务端仓库。Fork工作流的主要优点在于贡献可以轻易地整合进项目，而不需要每个人都推送到单一的中央仓库。开发者推送到他们 自己的 服务端仓库，只有项目管理者可以推送到官方仓库。这使得管理者可以接受任何开发者的提交，却不需要给他们中央仓库的权限。结论是，这种分布式的工作流为大型、组织性强的团队（包括不可信的第三方）提供了安全的协作方式。它同时也是开源项目理想的工作流。</p><p><img src="/2019/02/14/git-de-yuan-li/git7.png" alt></p><h3 id="Git-Add-amp-Commit"><a href="#Git-Add-amp-Commit" class="headerlink" title="Git Add &amp; Commit"></a>Git Add &amp; Commit</h3><p>add 和 commit 应该可以说是我们使用频率最高的高层命令了。<code>git add</code>不加参数默认为将修改操作的文件和未跟踪新添加的文件添加到git系统的暂存区，注意不包括删除。每当将修改的文件加入到暂存区，git 都会根据文件的内容计算出 sha-1，并将内容转换成 blob，写入数据库。然后使用 sha-1 值更新该列表中的文件项。在暂存区的文件列表中，每一个文件名，都会对应一个sha-1值，用于指向文件的实际内容。最后提交的那一刻，git会将这个列表信息转换为项目的快照，也就是 tree 对象。写入数据库，并再构建一个commit对象，写入数据库。然后更新分支指向。</p><h3 id="Git-Conflicts"><a href="#Git-Conflicts" class="headerlink" title="Git Conflicts"></a>Git Conflicts</h3><p>在使用Git提交文件时，不可避免的会产生冲突。解决冲突成为我们必须要面对的事情，要解决冲突，首先要明白冲突是怎么产生的。下面就来了解一下Git中文件冲突是怎么来的</p><p><img src="/2019/02/14/git-de-yuan-li/git8.png" alt></p><p>图上的情况，并不是移动分支指针就能解决问题的，它需要一种合并策略。首先，需要明确的是谁和谁的合并，是 2，3 与 4，5，6的合并吗？说到分支，我们总会联想到线，就会认为是线的合并，这只是一种感性的认知。而事实上并不是这样的，真实合并的版本是 3 和 6。因为每一次提交都包含了项目完整的快照，即合并只是 tree 与 tree 的合并。我们可以先想一个简单的算法。用来比较3和6。但是我们还需要一个比较的标准，如果只是3和6比较，那么3与6相比，添加了一个文件，这无法确切表示当前的冲突状态。因此我们选取他们的两个分支的分歧点（merge base）作为参考点，也就是版本1，进行比较。首先把版本1、版本3、版本6中所有的文件做一个列表，然后依次遍历这个列表中的文件。现在我们拿列表中的一个文件进行举例。当版本3和版本6分别和版本1进行比较时会出现下面三种情况：</p><ul><li>版本1、版本3、版本6的 sha-1 值完全相同，这种情况表明没有冲突，可以正常合并</li><li>版本3或6至少一个与版本1状态相同（指的是sha-1值相同或都不存在），这种情况可以自动合并。比如版本1中存在一个文件，在版本3中没有对该文件进行修改，而版本6中删除了这个文件，则以版本6为准就可以了</li><li>版本3或版本6都与版本1的状态不同，情况复杂一些，自动合并策略很难生效，需要手动解决冲突了。</li></ul><h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h3><p>在解决完冲突后，我们可以将修改的内容提交为一个新的提交，这就是 merge。<code>git merge</code> 用来做分支合并，将其他分支中的内容合并到当前分支中。运行<code>git-merge</code>时含有大量的未commit文件很容易让你陷入困境，这将使你在冲突中难以回退。因此非常不鼓励在使用<code>git-merge</code>时存在未commit的文件，建议使用<code>git-stash</code>命令将这些未commit文件暂存起来，并在解决冲突以后使用<code>git stash pop</code>把这些未commit文件还原出来。</p><p><img src="/2019/02/14/git-de-yuan-li/git9.png" alt></p><p>可以看到 merge 是一种不修改分支历史提交记录的方式，这也是我们常用的方式。但是这种方式在某些情况下使用 起来不太方便，比如当我们创建了 pr、mr 或者 将修改补丁发送给管理者，管理者在合并操作中产生了冲突，还需要去解决冲突，这无疑增加了他人的负担，使用 rebase 可以解决这种问题。</p><h3 id="Rebase"><a href="#Rebase" class="headerlink" title="Rebase"></a>Rebase</h3><p>rebase在git中是一个非常有魅力的命令，使用得当会极大提高自己的工作效率；相反，如果乱用，会给团队中其他人带来麻烦。它的作用简要概括为：可以对某一段线性提交历史进行编辑、删除、复制、粘贴；因此，合理使用rebase命令可以使我们的提交历史干净、简洁！假设我们的分支结构如下：</p><p><img src="/2019/02/14/git-de-yuan-li/git10.png" alt></p><p>rebase 会把从 Merge Base 以来的所有提交，以补丁的形式一个一个重新达到目标分支上。这使得目标分支合并该分支的时候会直接 Fast Forward，即不会产生任何冲突。提交历史是一条线，这对强迫症患者可谓是一大福音。</p><p><img src="/2019/02/14/git-de-yuan-li/git11.png" alt></p><h3 id="Checkout"><a href="#Checkout" class="headerlink" title="Checkout"></a>Checkout</h3><p>对于 checkout，我们一般不会陌生。因为使用它的频率非常高，经常用来切换分支、或者切换到某一次提交。这里我们以切换分支为例，从 git 的工作区、暂存区、本地仓库分别来看 checkout 所做的事情。Checkout 前的状态如下：</p><p><img src="/2019/02/14/git-de-yuan-li/git12.png" alt></p><p>首先 checkout 找到目标提交（commit），目标提交中的快照也就是 tree 对象就是我们要检出的项目版本。<br>checkout 首先根据tree生成暂存区的内容，再根据 tree 与其包含的 blob 转换成我们的项目文件。然后修改 HEAD 的指向，表示切换分支。</p><p><img src="/2019/02/14/git-de-yuan-li/git13.png" alt></p><p>可以看到 checkout 并没有修改提交的历史记录。只是将对应版本的项目内容提取出来。</p><h3 id="stash"><a href="#stash" class="headerlink" title="stash"></a>stash</h3><p>有时，我们在一个分支上做了一些工作，修改了很多代码，而这时需要切换到另一个分支干点别的事。但又不想将只做了一半的工作提交。在曾经这样做过，将当前的修改做一次提交，message 填写 half of work，然后切换另一个分支去做工作，完成工作后，切换回来使用 reset —soft 或者是 commit amend。Git 为了帮我们解决这种需求，提供了 stash 命令。stash 将工作区与暂存区中的内容做一个提交，保存起来，然后使用reset hard选项恢复工作区与暂存区内容。我们可以随时使用 stash apply 将修改应用回来。<code>git stash</code>（git储藏）可用于以下情形：</p><ul><li>发现有一个类是多余的，想删掉它又担心以后需要查看它的代码，想保存它但又不想增加一个脏的提交。这时就可以考虑<code>git stash</code>。</li><li>使用git的时候，我们往往使用分支（branch）解决任务切换问题，例如，我们往往会建一个自己的分支去修改和调试代码, 如果别人或者自己发现原有的分支上有个不得不修改的bug，我们往往会把完成一半的代码<code>commit</code>提交到本地仓库，然后切换分支去修改bug，改好之后再切换回来。这样的话往往log上会有大量不必要的记录。其实如果我们不想提交完成一半或者不完善的代码，但是却不得不去修改一个紧急Bug，那么使用<code>git stash</code>就可以将你当前未提交到本地（和服务器）的代码推入到Git的栈中，这时候你的工作区间和上一次提交的内容是完全一样的，所以你可以放心的修Bug，等到修完Bug，提交到服务器上后，再使用<code>git stash apply</code>将以前一半的工作应用回来。</li><li>经常有这样的事情发生，当你正在进行项目中某一部分的工作，里面的东西处于一个比较杂乱的状态，而你想转到其他分支上进行一些工作。问题是，你不想提交进行了一半的工作，否则以后你无法回到这个工作点。解决这个问题的办法就是<code>git stash</code>命令。储藏(stash)可以获取你工作目录的中间状态——也就是你修改过的被追踪的文件和暂存的变更——并将它保存到一个未完结变更的堆栈中，随时可以重新应用。</li></ul><p>stash 实现思路将我们的修改提交到本地仓库，使用特殊的分支指针（.git/refs/stash）引用该提交，然后在恢复的时候，将该提交恢复即可。我们可以更进一步，看看 stash 做的提交是什么样的结构。</p><p><img src="/2019/02/14/git-de-yuan-li/git14.png" alt></p><p>当你多次使用git stash命令后，你的栈里将充满了未提交的代码，这时候你会对将哪个版本应用回来有些困惑，这时git stash list命令可以将当前的Git栈信息打印出来，你只需要将找到对应的版本号，例如使用 git stash apply stash@{1} 就可以将你指定版本号为stash@{1}的暂存内容取出来，当你将所有的栈都应用回来的时候，可以使用git stash clear来将栈清空。stash是本地的，不会通过<code>git push</code>命令上传到git server上。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web开发技术的演变</title>
      <link href="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/"/>
      <url>/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/</url>
      
        <content type="html"><![CDATA[<p>Web开发指的是网页系统开发，一说到网页，我想大概大部分人都会熟悉www，每次在浏览器中输入网址时，总会先输入www，这里其实是World Wide Web的简称，现在也简称Web，中文译为万维网。“万维网”和我们经常说的“互联网”是两个联系极其紧密但却不尽相同的概念，互联网就是指通过TCP/IP协议族互相连接在一起的计算机网络。而万维网是运行在互联网上的一个超大规模的分布式系统。Web设计初衷是一个静态信息资源发布媒介，通过超文本标记语言（HTML）描述信息资源，通过统一资源标识符（URI）定位信息资源，通过超文本转移协议（HTTP）请求信息资源。HTML、URL和HTTP三个规范构成了Web的核心体系结构，是支撑着Web运行的基石。</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/web.jpg" alt></p><a id="more"></a> <p>这样说太过专业化了，用简单的话说，打个比方：假设有100台计算机，这100台计算机可以分布在世界任何一个地方，无所谓。如果我想让这100台计算机相互通信，怎么办。那把这100台计算机用光纤相互连接起来吧，组成一个网路。到这还不行，这只是硬件上连接起来了，通信是可以通信了，但计算机们都不知道对方发的消息是什么意思，而且寻址也是一个问题。这时就需要一个通信协议了，然后TCP/IP就诞生了。有了这个协议后，100台计算机算是真正可以发送消息了，而Web就是建立在这个基础上的。再设想一下，现在1号计算机想获取99号计算机上磁盘上的一张图片，怎么办？这时URI就诞生了，URI作为统一资源标识符，专做这个事情。那么拿到资源后怎么展示就是HTML做的事情了，而计算机通信的协议就是通过HTTP协议了（HTTP协议是基于TCP协议的一个上层协议）。因此，大家开发的Web应用本质上就是将服务器中的资源提供的互联网中，成为Web这个全球超大规模分布式系统中的一部分。下面我就来扒一扒Web开发经历过哪些阶段。</p><h3 id="1-静态网页时代"><a href="#1-静态网页时代" class="headerlink" title="1. 静态网页时代"></a>1. 静态网页时代</h3><p>1994年，网景公司（Netscape）发布了Navigator浏览器0.9版。这是历史上第一个比较成熟的网络浏览器，轰动一时。但是，这个版本的浏览器只能用来浏览，不具备与访问者互动的能力。最初在浏览器中主要展现的是静态的文本或图像信息，即将网页的HTML代码编写好，然后将他放在服务器上通过浏览器访问这个静态的HTML文件。这个时期的技术处于较为原始阶段，没有Javascript，没有CSS的年代，写出的HTML给人的感觉就是一些文字堆砌在一起，没有美感，也不存在动态交互。只有GIF图片则第一次为HTML页面引入了动态元素。那时的网页大致长这个样子</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/web1.png" alt></p><p>此时的网景公司（Netscape）也苦于浏览器没有动态效果，因此急需一种脚本语言，后来网景公司开发出了一门新语言javascript，有了Javascript后用户就具备了与浏览器交互的能力。但是页面的画风太丑，一直被人们吐槽，因此大概在同时期又诞生了另一名语言CSS，专门负责定义HTMML的标签样式。1994年，W3C组织（<em>World WideWeb Consortium</em>）成立，CSS的创作成员全部成为了W3C的工作小组并且全力以赴负责研发CSS标准，层叠样式表的开发终于走上正轨，有越来越多的成员参与其中。Javascript与CSS两大前端语言诞生后，静态页面也可以像桌面应用程序那样美观和动态交互了，下面是苹果公司早期的主页</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/apple.jpg" alt></p><p>那时Web的工作原理也相对简单，就是浏览器请求服务器的静态HTML文件，然后服务器将静态文件返回给浏览器渲染成文本展示，其工作流程大致如下图</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/static.png" alt></p><h3 id="2-动态内容CGI时代"><a href="#2-动态内容CGI时代" class="headerlink" title="2. 动态内容CGI时代"></a>2. 动态内容CGI时代</h3><p> 随着业务发展，人们已经不仅仅满足于访问放在Web服务器上的静态文件，比如你想让访问者看到有多少其他访问者访问了这个网站呢，或者想让客户去填写这样一个表单，包含有姓名和邮件地址呢？要实现这样的功能，意味着客户端与服务端要进行数据交互，而且服务端还需要把用户数据永久的保存起来，这些功能是静态页面无法实现的。于是1993年CGI（Common Gateway Interface）出现了，Web上的动态信息服务开始蓬勃兴起。CGI定义了Web服务器与外部应用程序之间的通信接口标准，因此Web服务器可以通过CGI执行外部程序，让外部程序根据Web请求内容生成动态的内容。Perl因为跨操作系统和易于修改的特性成为CGI的主要编写语言。当然，CGI可以用任何支持标准输入输出和环境变量的语言编写，比如Shell脚本,C/C++语言，只要符合接口标准即可。比如你用C语言编写CGI程序，你把希望返回的HTML内容通过printf输出就可以发送给Web服务器，进而返回给用户。CGI应用程序运行在浏览器可以请求的服务器系统上，此时Web开发的架构大致如下图</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/CGI.png" alt></p><p>由于CGI执行时需要使用服务器CPU时间和内存。如果有成千上万的这种程序会同时运行，那会对服务器系统提出极高的要求。你要慎重考虑这个问题，以防止服务器系统崩溃。当时组织CGI/Perl这样的脚本代码太混乱了。CGI伸缩性不是太好(经常是为每个请求分配一个新的进程)，也不太安全(直接使用文件系统或者环境变量)，同时也没提供一种结构化的方式去构造动态应用程序。如果一个CGI脚本可以在每台计算机上做同样的事情；编写脚本就会变的很容易。不幸的是，CGI脚本依赖于服务器的操作系统，因此，对于非UNIX服务器来说，Prl（UNIX下编写脚本的一个常用工具）脚本毫无用处。这也是开发人员最痛苦的事情，这意味着同一个应用服务，需要根据不同的操作系统各自开发一套。所以，你必须定制安装你的CGI脚本。这也是后来基于 JVM 平台的语言流行的主要因素。</p><h3 id="3-模板引擎时代"><a href="#3-模板引擎时代" class="headerlink" title="3. 模板引擎时代"></a>3. 模板引擎时代</h3><h4 id="（1）PHP-ASP时代"><a href="#（1）PHP-ASP时代" class="headerlink" title="（1）PHP/ASP时代"></a>（1）PHP/ASP时代</h4><p>尽管CGI解决了网页动态数据的问题，但它的弊端也是越来越明显，依赖于操作系统，移植性差，HTML代码与服务端代码杂糅在一起不便于维护。为了处理更复杂的应用，人们在想能不能把HTML返回中固定的部分存起来（我们称之为模版），把动态的部分标记出来， Web请求处理的时候，程序先获取动态数据，再把模版读入进来，把动态数据填充进去，形成最终返回。举个例子，你通过页面搜索框搜索一个关键词，请求到达Web服务器，后台从数据库或是文件里拿到数据，然后把这些数据填充到返回结果的HTML模版中，返回给浏览器。但是这件事情自己来做显然太繁琐而且是重复劳动，于是1994年的时候，PHP诞生了，PHP可以把程序（动态内容）嵌入到HTML（模版）中去执行，不仅能更好的组织Web应用的内容，而且执行效率比CGI还更高。之后96年出现的ASP上也都可以看成是一种支持某种脚本语言编程，ASP使用VB语言的模版引擎。更重要的是，模板引擎的出现使得HTML代码和服务端代码分离开来，使得开发流程更加规范，逻辑更加清晰。而CSS允许开发者用外联的样式表来取代难以维护的内嵌样式，而不需要逐个去修改HTML元素，这让HTML页面更加容易创建和维护。此时，有了这些脚本语言，搭配上后端的数据库技术，Web更是开始大杀四方了，像电子商务这样的应用系统也可以通过Web技术来构建。Web已经从一个静态资源分享媒介真正变为了一个分布式的计算平台了。反过来看，你也应该知道，不是只有当今这些流行脚本语言可以写Web应用，C语言一样可以做这件事情。通过C语言来获取数据和渲染Web页面的例子在追求极致访问速度的互联网公司是非常常见的，但是脚本语言在开发效率上更胜一筹。</p><h4 id="（2）JSP-Servlet时代"><a href="#（2）JSP-Servlet时代" class="headerlink" title="（2）JSP/Servlet时代"></a>（2）JSP/Servlet时代</h4><p>Servlet是一个优秀的Web技术规范，Servlet 看起来像是通常的 Java 程序。Servlet 导入特定的属于 Java Servlet API 的包。因为是对象字节码，可动态地从网络加载，可以说 Servlet 对 Server 就如同 Applet对 Client 一样，但是，由于 Servlet 运行于 Server 中，它们并不需要一个图形用户界面。从这个角度讲，Servlet 也被称为 FacelessObject。由于前后端交互的问题，sun公司又发布了JSP，JSP全称是Java Server Pages，它和Servlet技术一样，都是sun公司定义的一种用于开发动态web资源的技术。JSP最大的特点在于，写jsp就像在写html，但它相比html而言，html只能为用户提供静态数据，而Jsp技术允许在页面中嵌套java代码，为用户提供动态数据。它的出现一改以前java开发人员需要在Servlet中自己将html代码 out.write 返回给前端的工作方式，而是直接在jsp中编写html代码，极大的方便了开发人员的使用。这时已经初见前端分离的雏形了。jsp出现后，美工可以把页面原型图画好，再交给前端工程师按照原型图将静态页面写出来，待静态页面写好后，再交给java开发工程师把html代码复制到jsp中，这时只需要把后端处理的值填到对应的jsp中即可。对于一个系统开发，人员可以明确分工，前端后端开发部分可以同时进行。这个时期后端架构图大致如下</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/JSP.png" alt></p><h3 id="4-JavaEE时代"><a href="#4-JavaEE时代" class="headerlink" title="4. JavaEE时代"></a>4. JavaEE时代</h3><p>Web开始广泛用于构建大型应用时，在分布式、安全性、事务性等方面的要求催生了J2EE(现在已更名为Java EE)平台在1999年的诞生，从那时开始为企业应用提供支撑平台的各种应用服务器也开始大行其道。Java Servlet、Java Server Pages (JSP)和Enterprise Java Bean (EJB )是Java EE中的核心规范，Servlet和JSP是运行在服务器端的Web组件。2000年随之而来的.net平台，其ASP.net构件化的Web开发方式以及Visual Stidio.net开发环境的强大支持，大大降低了开发企业应用的复杂度。ASP.Net第一次让程序员可以像拖拽组件来创建Windows Form程序那样来组件化地创建Web页面，Java平台后来出现的JSF也承袭了这一思想。两大平台在相互竞争和模仿中不断向前发展。EJB运行在服务器端的业务组件，是一种分布式组件技术J2EE里，除了Servlet外另一个重量级的规范就是EJB。EJB设计的来源是Corba技术，分布式对象技术在EJB规范中有完整的体现。Rod在著作中对EJB规范粗重庞大难用提出各种质疑，尤其是针对其强制分布的要求。我的观念是分布式支持没有错，现在EJB规范中对于Local和Remote的划分定义是正确的。开发人员应该一开始就需要了解接口粒度的划分，本地和远程接口是不同的。对于一般的小型应用，Servlet和EJB容器都在一个虚拟机中，本地接口是合理的，但对于大型企业应用和互联网级别应用，势必需要服务的远程划分和调用。所以早期的EJB，可以说一方面设计不完备，另一方面又过度设计。但EJB自从3以后完全脱胎换骨，成为设计良好的规范。大家有没有想过所谓企业应用和普通应用之间最大的差别是什么？我认为是用户数量级别的差异，导致前端设计方式，软件体系，后台数据库，缓存技术应用，有不同的设计理念和方式。用更技术化来说，就是可扩展性，高可用性，容灾能力以及数据的一致性。实际上这样的思维方式很好，因为企业应用追求的是稳定，所以在架构设计时一是要求效率，二是面向失败编程，即开发时首先不是想正常情况下应该怎么样，而是把所以有能异常的情况都考虑在里面，并为异常情况做好解决措施。从软件层面考虑，一个企业应用软件可能用户数并不太多，就企业中百来号人，但前后台的交互是长时间，多次会话交互的。JSF技术其实是借鉴了微软ASP.net，它们继承了传统IDE快速开发的思路，希望通过拖拽连接可以快速开发一个应用。页面上的组件，对应后台服务器的业务组件，在得到服务器请求之后，组件需要做一系列动作来完成解析，校验，模型重建，业务方法调用，页面渲染等步骤，这些必然有个较长的过程。复杂性，效率，和其他技术的融合，JSF技术从诞生起就被质疑不断，而且面对每个明星技术，都有些格格不入，比如Ajax出现了，而JSF要求的Post方式还需要重刷页面。但JSF一直在改进，越来越科学完善。如今，配合CDI，JSF是企业应用开发的首选技术之一，大家可以研究一下Oracle的应用产品和ADF开发框架。</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/J2EE.png" alt></p><h3 id="5-Web层框架百花齐放"><a href="#5-Web层框架百花齐放" class="headerlink" title="5. Web层框架百花齐放"></a>5. Web层框架百花齐放</h3><p>后端技术逐渐规范稳定后，为了提高工作效率避免重复造轮子。Web技术的发展开始了一段框架横飞的年代，各种辅助Web开发的技术框架层出不穷。虽然脚本语言大大提高了应用开发效率，但是试想一个复杂的大型Web应用，涉及到的Web页面多种多样，同时还管理着大量的后台数据，因此我们需要在架构层面上解决维护性和扩展性等问题。这个时候，MVC的概念被引入到Web开发中来了。2004年出现的Struts就是当时非常流行的Java Web开发的MVC框架。MVC早在1978年就作为Smalltalk的一种设计模式被提出来了，应用到Web应用上，模型Model用于封装与业务逻辑相关的数据和数据处理方法，视图View是数据的HTML展现，控制器Controller负责响应请求，协调Model和View。Model，View和Controller的分开，是一种典型的关注点分离的思想，不仅使得代码复用性和组织性更好，使得Web应用的配置性和灵活性更好。这是Spring MVC的示意图，典型的MVC架构。</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/MVC.png" alt></p><p>MVC的架构不仅仅是后端代码分层结构，由于各个层次相互解耦，因此用户可以根据业务场景合理选择各个层次的框架。例如View层可以使用jsp，thymeleaf。Model层可以使用mybatis，hibernate。Controller层可以使用Spring，Struts等等。也正是MVC的架构，使得各式各样的框架层出不穷。</p><h3 id="6-CSS，Jacascript"><a href="#6-CSS，Jacascript" class="headerlink" title="6.  CSS，Jacascript"></a>6.  CSS，Jacascript</h3><p>上面主要说了后端web技术的演变，随着后端技术的发展前端技术也在日新月异，如今前端网页开发与莽荒时代的静态网页相比，不仅有各种各样的UI框架，更是参考了后端技术，在前端也实现MVC的架构。下面就来看一看前端技术的演变。首先就是CSS和JS的诞生。javacript的诞生还有一段故事，前面说到网景公司开发的浏览器只能展示静态页面，因此网景公司想在浏览器端嵌入一种语言或是脚本，使得用户可以和浏览器做一些动态交互，从而提升用户的体验。当时网景公司有两个方案：一个是采用现有的语言，如Perl、Python、Tcl、Scheme等等，允许它们直接嵌入网页；另一个是发明一种全新的语言。高层对于两个方案一时难以决定，就在这时，发生了另外一件大事：1995年Sun公司将Oak语言改名为Java，正式向市场推出。Sun公司大肆宣传，许诺这种语言可以”一次编写，到处运行”，它看上去很可能成为未来的主宰。网景公司动了心，决定与Sun公司结成联盟。它不仅允许Java程序以applet（小程序）的形式，直接在浏览器中运行；甚至还考虑直接将Java作为脚本语言嵌入网页，只是因为这样会使HTML网页过于复杂，后来才不得不放弃。此时，34岁的系统程序员Brendan Eich登场了。1995年4月，网景公司录用了他。公司决定指派他作为新语言的开发者，并要求这个语言必须与java足够相似，但比java简单。但是，他对Java一点兴趣也没有。为了应付公司安排的任务，他只用10天时间就把Javascript设计出来了。（ps：与大神的差距，别人10天开发出一门语言，我10天能完全上手一门新技术就不错了:）由于设计时间太短，语言的一些细节考虑得不够严谨，导致后来很长一段时间，Javascript写出来的程序混乱不堪。谁也想不到如今世界排名前5五的Javascript竟是在10天内被开发出来的。随着HTML的成长，为了满足页面设计者的要求，HTML添加了很多显示功能。但是随着这些功能的增加，HTML变的越来越杂乱，而且HTML页面也越来越臃肿。于是CSS便诞生了。1994年哈坤·利提出了CSS的最初建议。而当时伯特·波斯正在设计一个名为Argo的浏览器，于是他们决定一起设计CSS。其实当时在互联网界已经有过一些统一样式表语言的建议了，但CSS是第一个含有“层叠”丰意的样式表语言。层叠样式表(英文全称：Cascading Style Sheets)是一种用来表现HTML（标准通用标记语言的一个应用）或XML（标准通用标记语言的一个子集）等文件样式的计算机语言。CSS不仅可以静态地修饰网页，还可以配合各种脚本语言动态地对网页各元素进行格式化。CSS 能够对网页中元素位置的排版进行像素级精确控制，支持几乎所有的字体字号样式，拥有对网页对象和模型样式编辑的能力。</p><h3 id="7-浏览器的魔术：AJAX"><a href="#7-浏览器的魔术：AJAX" class="headerlink" title="7. 浏览器的魔术：AJAX"></a>7. 浏览器的魔术：AJAX</h3><p>JavaScript最终被提交到欧洲计算机制造商协会(ECMA)，做为中立的ECMA开始了标准化脚本语言之路，并将其命名为ECMAScript。JavaScript可以响应浏览器端的用户事件，检测表单的正确性，动态修改DOM结构，因此可以减少与服务器端的通信开销，并且做出很酷的页面动态效果。2005年出现的AJAX这个概念使得JavaScript再次大放异彩。AJAX即“Asynchronous Javascript And XML”（异步的JavaScript和XML技术）。Ajax 不是一种新的编程语言，而是一种用于创建更好更快以及交互性更强的Web应用程序的技术。AJAX是一种已有技术的mashup，多种技术组合在一起形成了其特色和优势，早在1998年就已经开始有人使用。Google在地图和Gmail等产品中对这项技术的深入应用，以及AJAX这个吸引眼球的名字的提出，使其正式站在了聚光灯下，开始吸引无数人的目光。我们知道Web应用中用户提交表单时就向Web服务器发送一个请求，服务器接收并处理传来的表单，并返回一个新的网页。而前后两个页面中的往往大部分HTML代码是一样的，每次都返回整个页面内容是一种带宽资源的浪费。而AJAX应用仅向服务器发送并取回必须的数据，并在客户端采用JavaScript处理来自服务器响应，更新页面的局部信息。使用Ajax的最大优点，就是能在不更新整个页面的前提下维护数据。这使得Web应用程序更为迅捷地回应用户动作，并避免了在网络上发送那些没有改变的信息。对应用Ajax最主要的批评就是，它可能破坏浏览器的后退与加入收藏书签功能。在动态更新页面的情况下，用户无法回到前一个页面状态，这是因为浏览器仅能记下历史记录中的静态页面。一个被完整读入的页面与一个已经被动态修改过的页面之间的可能差别非常微妙；用户通常都希望单击后退按钮，就能够取消他们的前一次操作，但是在Ajax应用程序中，却无法这样做。不过开发者已想出了种种办法来解决这个问题。AJAX的出现，催生诸如EXTJS、EASYUI等一些基于JS的前端框架。大大提高了前端页面的开发效率。</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/ajax.png" alt></p><h3 id="8-前端MVC：Angular-React-Vue"><a href="#8-前端MVC：Angular-React-Vue" class="headerlink" title="8. 前端MVC：Angular/React/Vue"></a>8. 前端MVC：Angular/React/Vue</h3><p>这种模式下，前后端的分工非常清晰，前后端的关键协作点是 Ajax 接口，规定好交互接口后，前后端工程师就可以根据约定，分头开工，开发环境中通过Mock等方式进行测试，同时在特定时间节点进行前后端集成测试。但是，随着业务功能的愈发复杂，这种模式本质上和JSP时代的Web开发并无本质区别，只不过是将复杂的业务逻辑从JSP文件转移到了JavaScript文件中而已。现在，对于一个前端功能、交互复杂的业务，大量的逻辑处理使得javascript的代码量激增。很自然地，像服务端从JSP向MVC框架转换的过程一样，前端开发也出现了大量的MVC框架。通过MVC框架又衍生出了许多其它的架构，统称MV* ，最常见的是MVP与MVVM。总的来说，MV* 框架的提出是为了解决前端开发的复杂度，提供一套规则组织代码、分层，通过合理的组织和分层，前端的代码职责明确、清晰，便于开发与测试。目前比较优秀的前端MVC框架就是Angular.js，Vue.js和React.js。被尊为前端三大框架，下面分别介绍一下这几个框架。   </p><h4 id="（1）React"><a href="#（1）React" class="headerlink" title="（1）React"></a>（1）React</h4><p>React 起源于 Facebook 的内部项目，因为该公司对市场上所有 JavaScript MVC 框架，都不满意，就决定自己写一套，用来架设 Instagram 的网站。做出来以后，发现这套东西很好用，就在2013年5月开源了。由于 React 的设计思想极其独特，属于革命性创新，性能出众，代码逻辑却非常简单。所以，越来越多的人开始关注和使用，认为它可能是将来 Web 开发的主流工具。支持虚拟DOM（Virtual DOM）和组件化的开发。React<a href="https://react.docschina.org/" target="_blank" rel="noopener">官网</a>和github<a href="https://github.com/facebook/react/" target="_blank" rel="noopener">地址</a></p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/react.png" alt></p><h4 id="（2）-Angular"><a href="#（2）-Angular" class="headerlink" title="（2） Angular"></a>（2） Angular</h4><p>AngularJS 诞生于2009年，由Misko Hevery 等人创建，后为Google所收购。是一款优秀的前端JS框架，已经被用于Google的多款产品当中。AngularJS有着诸多特性，最为核心的是：MVC（Model–view–controller）、模块化、自动化双向数据绑定、语义化标签、依赖注入等等。AngularJS是协助搭建单页面工程（SPA）的开源前端框架。它通过MVC模式使得开发与测试变得更容易。并试图成为WEB应用中的一种端对端的解决方案。它将指导开发整个应用。Angular <a href="http://www.angularjs.net.cn/" target="_blank" rel="noopener">官网</a>和github<a href="https://github.com/angular/" target="_blank" rel="noopener">地址</a></p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/Angular.jpg" alt></p><h4 id="（3）-Vue"><a href="#（3）-Vue" class="headerlink" title="（3）  Vue"></a>（3）  Vue</h4><p>vue同时具备angular和react的优点,轻量级,api简单,文档齐全,简单强大,麻雀虽小五脏俱全，目前在github上众多的前端开源MVVM框架中vue拥有star最多。Vue是一个构建数据驱动的 web 界面的渐进式框架。Vue.js 的目标是通过尽可能简单的 API 实现响应的数据绑定和组合的视图组件。Vue.js 自身不是一个全能框架——它只聚焦于视图层。因此它非常容易学习，易于上手，非常容易与其它库或已有项目整合。另一方面，在与相关工具和支持库一起使用时，Vue.js 也能完美地驱动复杂的单页应用，其作者是尤雨溪是中国人。Vue<a href="https://cn.vuejs.org/" target="_blank" rel="noopener">官网</a>和github<a href="https://github.com/vuejs" target="_blank" rel="noopener">地址</a> </p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/vue.png" alt></p><p>前端有了MVC框架后，web开发就真正实现了前后端解耦，分离开发。至此web开发的架构图大致如下图</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/Frontend-MVC.png" alt></p><h3 id="9-JS在服务器端的逆袭：Node-JS"><a href="#9-JS在服务器端的逆袭：Node-JS" class="headerlink" title="9. JS在服务器端的逆袭：Node.JS"></a>9. JS在服务器端的逆袭：Node.JS</h3><p>各大浏览器的竞争，使其引擎的性能不断提升，至今Google V8引擎的性能已经足以运行大型Javascript程序。在V8之上加以网络、文件系统等内置模块，形成了如今的Node.js。随着Node.js的出现，JavaScript开始拥有在服务端运行的能力，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。 [1]  发布于2009年5月，由Ryan Dahl开发，实质是对Chrome V8引擎进行了封装。它的异步本质使得Node.js在处理I/O密集型业务中优势凸显，而大多Web业务中I/O性能都是瓶颈。eBay、Yahoo、甚至Microsoft Azure纷纷引入Node.js以提升性能。Node.js的package每天都有几千万的下载量。这对前端工程师来说可是一个好消息，精通JavaScript的他们也能够做服务端开发了！虽然现实中并不是这样美好（服务端开发涉及的不仅仅是语言层面），但一种新的开发模式也因此兴起：浏览器端处理展现层逻辑、而服务端Controller这一层以及相关的模板渲染、路由、数据接口以及Session/Cookie先关处理实际上交给了Nodejs来做。通过Nodejs, 意味着前后端很多代码可以复用（例如数据验证，业务逻辑）。但另一方面，JavaScript刚被引入到服务器端开发，其生态环境还未成熟，甚至大量的常用package主版本号都是0。长期用来实现页面逻辑，天生自由的JavaScript，在服务器端开发中，仍未形成统一的开发范型。不同开发原则和编码风格的应用，都将对Node.js项目的性能、可维护性产生重大影响。Node.js可以在不新增额外线程的情况下，依然可以对任务进行并发处理， Node.js是单线程的。它通过事件循环（event loop）来实现并发操作，对此，我们应该要充分利用这一点 ， 尽可能的避免阻塞操作，取而代之，多使用非阻塞操作。在几年的时间里，Node.JS逐渐发展成一个成熟的开发平台，吸引了许多开发者。有许多大型高流量网站都采用Node.JS进行开发，此外，开发人员还可以使用它来开发一些快速移动Web框架。</p><p><img src="/2019/01/21/web-kai-fa-ji-zhu-de-yan-bian/Node.png" alt></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>现在Web技术依然在快速发展，Web本身的基础规范也在不断完善，HTML5和CSS3引入了更多激动人心的特性。回顾Web的发展历史，从某个角度看，就是抽象层次不断提高的一个过程，更高的抽象层次屏蔽更低层的复杂性，从而提高开发效率。但任何技术框架都不是万能的，每当技术发展到一定程度，或是出现某些局限性的时候，就会有更优秀的技术出现来解决这些局限性。其实这是计算机技术发展的一个普遍规律，比如高级语言的出现屏蔽了汇编语言的复杂性，帮助我们更快速的编程，更多的关注代码和业务逻辑；数据库技术的出现使得我们无需关心物理存储和访问细节，简单的SQL语句就能搞定我们本来需要复杂且晦涩难懂的底层的代码才能完成的事情，更进一步，ORM框架使得我们通过一条语句调用一个类的一个方法就能方便就行数据操作。我们应该让自己的技术视野具备一定的高度和广度，看到一门技术的发展规律和发展历程，这是一种技术修养的体现，其实跟人文修养是一样的。同时也应该具有一定的深度，因为我们往往站在比较高的抽象层次，比如今天你写几行代码就能把数据库创建好，增删改查的功能也自动生成好了，现在很多程序员对重复造轮子的事嗤之以鼻，实现功能或是遇到难点也是百度直接照搬代码。重复造轮子确实降低了工作效率，在企业中当然会使用前人造好的轮子，但是作为技术人员如果只是知其然而不知其所以然，那么永远只是个勤劳的搬砖工。要成为高手需要你对底层的原理机制有更透彻的理解，真正遇到问题的时候才能抽丝剥茧迎刃而解。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring的前世今生</title>
      <link href="/2019/01/20/spring-de-qian-shi-jin-sheng/"/>
      <url>/2019/01/20/spring-de-qian-shi-jin-sheng/</url>
      
        <content type="html"><![CDATA[<p>相信java开发工程师对spring都不陌生，spring从2004年诞生至今已有10多年的历史，在企业级web服务开发领域举足轻重，也成为了每一个java开发工程师必须要掌握的一个框架。我从工作到现在使用spring有两年多，确也感觉到它不仅功能强大而且简单易上手，极大的降低了开发者的工作量。在感叹框架带给我的便捷之余，也不禁思考是什么样的人，在什么样的场景下开发出了spring这样强大的框架。在spring没有出现之前，java开发者们又是使用什么样的方式开发web应用系统的呢？现如今各种各样的上层框架层出不穷，但任何一个框架的诞生必定是解决了某些方面的问题。只有在了解了框架的来龙去脉能更好的明白它的优势与劣势，才能更清楚的在何种场景下使用它，否则永远只是个搬砖的小码农，本文就来聊一聊spring的前世今生。先奉上spring的<a href="http://spring.io/" target="_blank" rel="noopener">官网</a>，spring社区如今非常活跃，spring也已发展出一系列成熟的组件和解决方案，如spring boot，spring cloud等。</p><p><img src="/2019/01/20/spring-de-qian-shi-jin-sheng/spring1.png" alt></p><a id="more"></a> <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>Spring 框架可以说是 Java 开发人员使用的最流行的应用程序开发框架之一，Spring Boot为开发者带来了更好的开发体验。它目前由大量提供一系列服务的模块组成。包括模块容器，为构建横切关注点提供支持的面向切面编程（AOP），安全框架，数据存取框架。Spring Boot在运维方面做了很多工作，部署、监控、度量，无一不在其涉猎范围之内，结合Spring Cloud后还可以轻松地实现服务发现、服务降级等功能。它还自带了不少非功能性的特性，比如安全、网关、监控、内嵌服务器和外置配置，这些都让选择Spring Boot成为了一件顺理成章的事情。多年来 Spring 框架已变得足够成熟。几乎所有 Java 企业应用需要用到的基础组件都可以在 Spring 框架中找到。但在一个新应用中将所有需要的 Spring 组件整合并配置好并不容易。随着动态语言的流行(Ruby,Scala,Node)，Java的开发显得格外的笨重：繁多的配置，低下的开发效率，复杂的部署流程以及第三方技术集成难度大。相信做开发的朋友在使用spring mvc时都经历过被配置文件折磨过的黑暗岁月，当需要集成开源组件时总需要在配置文件中加入相关的配置信息，有些配置信息甚至还有依赖关系，如果配置信息的顺序添加的不对，会报一些莫名其妙的错误，很是让人头疼。在添加配置时有一堆繁琐的操作，这包括在maven 中设置依赖库，使用 xml、注解或 java 代码配置需要的 Spring Bean。Spring 开发者意识到这里的绝大多数工作是可以可以自动化的，于是Spring Boot 出现了！</p><h2 id="2-起源"><a href="#2-起源" class="headerlink" title="2. 起源"></a>2. 起源</h2><p>2002 年 ，Java EE 和 EJB 正是流行的时候，很多知名公司都是采用此技术方案进行项目开发。这时候有一个美国的小伙子认为 EJB 太过臃肿，并不是所有的项目都需要使用 EJB 这种大型框架，应该会有一种更好的方案来解决这个问题。这个聪明的小伙子是谁呢？他就是大名鼎鼎的 Rod Johnson（下图），额。。画风突变，现在已经是大叔了，Rod Johnson 在悉尼大学不仅获得了计算机学位，同时还获得了音乐学位，更令人吃惊的是在回到软件开发领域之前，他还获得了音乐学的博士学位。现在 Rod Johnson 已经离开了 Spring，成为了一个天使投资人，同时也是多个公司的董事，早已走上人生巅峰。</p><p><img src="/2019/01/20/spring-de-qian-shi-jin-sheng/rod.jpg" alt></p><p>2002 年 10 月，Rod Johnson 撰写了一本名为 《Expert One-on-One J2EE》 设计和开发的书。本书由 Wrox出版，介绍了当时 Java 企业应用程序开发的情况，并指出了 Java EE 和 EJB 组件框架中的存在的一些主要缺陷。在这本书中，他提出了一个基于普通 Java 类和依赖注入的更简单的解决方案。在书中，他展示了如何在不使用 EJB 的情况下构建高质量、可扩展的在线座位预留系统。为了构建应用程序，他编写了超过 30,000 行的基础结构代码，项目中的根包命名为 <code>com.interface21</code>，所以人们最初称这套开源框架为 interface21，这就是 Spring 的前身。一对一的 J2EE 设计和开发一炮而红。本书免费提供的大部分基础架构代码都是高度可重用的。即使在 15 年后，本书及其原则仍然与构建高质量的 Java Web 应用程序相关。</p><h2 id="3-Spring的诞生"><a href="#3-Spring的诞生" class="headerlink" title="3. Spring的诞生"></a>3. Spring的诞生</h2><p>在本书发布后不久，开发者 Juergen Hoeller 和 Yann Caroff 说服 Rod Johnson 创建一个基于基础结构代码的开源项目。Rod，Juergen 和 Yann 于 2003 年 2 月左右开始合作开发该项目 。并为新框架创造了“Spring”的名字。2003 年 6 月，Spring 2.0 在 Apache 2.0 许可下发布。2004 年 3 月，1.0 版发布。有趣的是，在1.0发布之前，spring 就被开发人员广泛采用。2004 年 8 月，Rod Johnson，Juergen Hoeller，Keith Donald 和Colin Sampaleanu 共同创立了一家专注于 Spring 咨询，培训和支持的公司 interface21。Yann Caroff 在早期离开了团队，Rod Johnson 在 2012 年离开，Juergen Hoeller 仍然是 Spring 开发团队的积极成员，据 Rod Johnson 介绍 ，Spring 是传统 J2EE 新的开始，随后 Spring 发展进入快车道。</p><ul><li>2004 年 03 月，1.0 版发布。</li><li>2006 年 10 月，2.0 版发布。</li><li>2007 年 11 月，更名为 SpringSource，同时发布了 Spring 2.5。</li><li>2009 年 12 月，Spring 3.0 发布。</li><li>2013 年 12 月，Pivotal 宣布发布 Spring 框架 4.0。</li><li>2017 年 09 月，Spring 5.0 发布。</li></ul><p>网上有一张图，清晰的展示了 Spring 发展：</p><p><img src="/2019/01/20/spring-de-qian-shi-jin-sheng/spring.jpg" alt></p><p><strong>(1) .</strong> 2004 年 1.0 版本发布，Spring 框架迅速发展。Spring 2.0 于 2006 年 10 月发布，到那时，Spring的下载量超过了 100 万。Spring 2.0 具有可扩展的 XML 配置功能，用于简化 XML 配置，支持 Java 5，额外的 IoC 容器扩展点，支持动态语言。</p><p><strong>(2) .</strong>  2007 年 11 月，在 Rod 领导下管理 Interface21 项目于更名为 SpringSource。同时发布了 Spring 2.5。Spring 2.5 中的主要新功能包括支持 Java 6 / Java EE 5，支持注释配置，classpath 中的组件自动检测和兼容 OSGi 的 bundle。</p><p><strong>(3) .</strong>  2007 年，SpringSource 从基准资本获得了 A 轮融资（1000万美元）。SpringSource 在此期间收购了多家公司，如Hyperic，G2One 等。2009年8月，SpringSource 以 4.2 亿美元被 VMWare 收购。SpringSource 在几周内收购了云代工厂，这是一家云 PaaS 提供商。2015 年，云代工厂转型成了非营利云代工厂。</p><p><strong>(4) .</strong>  2009 年 12 月，Spring 3.0 发布。Spring 3.0 具有许多重要特性，如重组模块系统，支持 Spring 表达式语言，基于 Java 的 bean 配置（JavaConfig），支持嵌入式数据库（如 HSQL，H2 和 Derby），模型验证/ REST 支持和对 Java EE 的支持。</p><p><strong>(5) .</strong>  2011 年和 2012 年发布了许多 3.x 系列的小版本。2012 年 7 月，Rod Johnson 离开了团队。2013 年 4月，VMware 和 EMC 通过 GE 投资创建了一家名为 Pivotal 的合资企业。所有的 Spring 应用项目都转移到了 Pivotal。</p><p><strong>(6) .</strong>  2013 年 12 月，Pivotal 宣布发布 Spring 框架 4.0。Spring 4.0 是 Spring 框架的一大进步，它包含了对Java 8 的全面支持，更高的第三方库依赖性（groovy 1.8+，ehcache 2.1+，hibernate 3.6+等），Java EE 7 支持，groovy DSL for bean 定义，对 websockets 的支持以及对泛型类型的支持作为注入 bean 的限定符。</p><p><strong>(7) .</strong>  2014 年至 2017 年期间发布了许多 Spring 框架 4.xx 系列版本。Spring 4.3.7 于 2017 年 3 月发布。Spring 4.3.8 于 2017 年 4 月发布，并成为 4.x 系列中的最后一个。Spring 框架的下一个延续的主要版本是在 5.0 版本展开。</p><h2 id="2-Spring-boot的诞生"><a href="#2-Spring-boot的诞生" class="headerlink" title="2. Spring boot的诞生"></a>2. Spring boot的诞生</h2><p>随着使用 Spring 进行开发的个人和企业越来越多，Spring 也慢慢从一个精巧简洁的小框架变成一个大而全的开源组件，Spring 的边界不断的进行扩充，到了后来 Spring 几乎可以做任何事情了，市面上主流的开源中间件都有 Spring 对应组件支持，这时的spring就像一个强大的粘黏剂，可以把人们想要的组件方便的组合在一起使用，但随着开源组件越来越多，业务系统业务越来越复杂，人们在享用 Spring 的这种便利之后，也遇到了一些问题。Spring 每集成一个开源软件，就需要增加一些基础配置，慢慢的随着人们开发的项目越来越庞大，往往需要集成开源组件也越来越多，因此后期使用 Spirng 开发大型项目需要引入大量的配置文件，太多的配置不仅难以理解，容易出错，而且难以维护。到了后来人们甚至称 Spring 为配置地狱。Spring 似乎也意识到了这些问题，急需有方案可以解决这些问题，这个时候微服务的概念也慢慢兴起，快速开发微小独立的应用变得更为急迫，Spring 刚好处在这么一个交叉点上，于 2013 年初开始的 Spring Boot 项目的研发，2014年4月，Spring Boot 1.0.0 发布。Spring Boot 诞生之初，就受到开源社区的持续关注，陆续有一些个人和企业尝试着使用了 Spring Boot，并迅速喜欢上了这款开源软件。直到2016年，在国内 Spring Boot 才被正真使用了起来，期间很多研究 Spring Boot 的开发者在网上写了大量关于 Spring Boot 的文章，同时有一些公司在企业内部进行了小规模的使用，并将使用经验分享了出来。从2016年到2018年，使用 Spring Boot 的企业和个人开发者越来越多。Spring Boot 不是为了取代 Spring ,Spring Boot 基于 Spring 开发，是为了让人们更容易的使用 Spring。看到 Spring Boot 的市场反应，Spring 官方也非常重视 Spring Boot 的后续发展，已经将 Spring Boot 作为公司最顶级的项目来推广，放到了官网上第一的位置，因此后续 Spring Boot 的持续发展也被看好。下面是spring boot从诞生到2018年的版本更新内容：</p><p><strong>Spring boot 1.1</strong>（2014 年 6 月） - 改进的模板支持，gemfire 支持，elasticsearch 和 apache solr 的自动配置。</p><p><strong>Spring Boot 1.2</strong>（2015 年 3 月） - 升级到 servlet 3.1 / tomcat 8 / jetty 9，spring 4.1 升级，支持 banner / jms / SpringBootApplication 注解。</p><p><strong>Spring Boot 1.3</strong>（2016 年 12 月） - Spring 4.2 升级，新的 spring-boot-devtools，用于缓存技术（ehcache，hazelcast，redis 和 infinispan）的自动配置以及完全可执行的 jar 支持。</p><p><strong>Spring boot 1.4</strong>（2017年1月） - spring 4.3 升级，支持 couchbase / neo4j，分析启动失败和RestTemplateBuilder。</p><p><strong>Spring boot 1.5</strong>（2017年2月） - 支持 kafka / ldap，第三方库升级，弃用 CRaSH 支持和执行器记录器端点以动态修改应用程序日志级别。</p><p><strong>Spring boot 2.0</strong>（2018 年 03 月）-基于 Java 8，支持 Java 9，支持 Quartz ，调度程序大大简化了安全自动配置，支持嵌入式 Netty</p><p>Spring Boot 简单性使 java 开发人员能够快速大规模地采用该项目。Spring Boot 可以说是在 Java 中开发基于 REST 的微服务 Web 应用程序的最快方法之一。也正是Pivotal 团队的开源精神，不断改进和维护着spring boot 才使得现在javaEE开发变得如此简单快捷。现在， Spring Boot让人人都能享受业内顶级公司的“福利”，站在巨人的肩膀之上，想想都让人觉得兴奋。</p>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HashMap的底层实现</title>
      <link href="/2019/01/02/hashmap-de-di-ceng-shi-xian/"/>
      <url>/2019/01/02/hashmap-de-di-ceng-shi-xian/</url>
      
        <content type="html"><![CDATA[<p>HashMap的底层实现相信是Java开发者们面试都会碰到的问题。它方便易用，在Java开发中使用频率非常高。它的实现原理包含很多知识点，所以当面试官问到你HashMap的时候可就要当心了，因为如果基本功不够扎实的话，很容易被带到沟里哦。以下暂时说jdk1.8的HashMap实现，我们都知道在数据结构中，物理存储的数据结构只有两种，即数组和链表，其余的如树，队列，栈等数据结构都是在它们的基础上逻辑抽象而来。它们各有优势，数组存储区域连续，查找快，增删慢，而链表存储区域离散，查找慢，增删快，因此各有各的应用场景。并没有一种既满足查找快也满足增删快的基本数据结构。那能不能把数组和链表组合在一起构成一种新的数据结构呢？HashMap就此诞生了，它的底层就是通过数组加链表组合的方式实现了查找快和增删快的统一。那么怎么样的组合才能使两者达到平衡呢？来看一下HashMap的实现细节</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/1.png" alt></p><p>在此之前我们先了解一下几种常用的数据结构，从图中也可以看出，它们是组成HashMap的基石。</p><p><strong>数组</strong>：数组指的就是一组相关类型的变量集合，并且这些变量彼此之间没有任何的关联。占用连续的内存空间存储数据，数组有下标，查询数据快，但是增删比较慢。</p><p><strong>链表：</strong>链表是一种线性表，不会占用连续的内存空间存储数据，而是每一个节点里存到下一个节点的指针。由于存储区间离散，因而占用内存比较宽松，链表查询比较慢，但是增删比较快；</p><p><strong>哈希：</strong>哈希是单词Hash的英译，也翻译为散列。把任意长度的输入，通过散列算法变换成固定长度的输出，该输出就是散列值</p><a id="more"></a> <h3 id="1-HashMap的实现"><a href="#1-HashMap的实现" class="headerlink" title="1.HashMap的实现"></a>1.HashMap的实现</h3><p>以下暂时说jdk1.8的HashMap实现，我们都知道在数据结构中，物理存储的数据结构只有两种，即数组和链表，其余的如树，队列，栈等数据结构都是在它们的基础上逻辑抽象而来。它们各有优势，数组存储区域连续，查找快，增删慢，而链表存储区域离散，查找慢，增删快，因此各有各的应用场景。并没有一种既满足查找快也满足增删快的基本数据结构。那能不能把数组和链表组合在一起构成一种新的数据结构呢？HashMap就此诞生了，它的底层就是通过数组加链表组合的方式实现了查找快和增删快的统一。那么怎么样的组合才能使两者达到平衡呢？下面我们来一探究竟，下图是HashMap实现的结构图。</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/2.png" alt></p><p>可以看出组成HashMap最基本的单元是Entry。图中紫色框的Entry构成数组，红色框中的Entry构成链表。当有新的Entry需要加入进来时，通过Entry的Key哈希后得到值和table数组的长度位与运算得到数组的下标。再遍历链表，通过equals方法逐个比较key，如果有相同的Key就覆盖,如果没有就追加到链表头部（<strong>HashMap并不会将元素放在链表的尾部，而是放在头部，这是为了避免尾部遍历[tail traversing]</strong>）。数组和链表就是通过这种方式的组合实现了查找和增删效率的平衡。其中Entry对象除了包含本身的Key和Value外还包含它指向的下一个Entry。在jdk1.8后，对HashMap做了优化，当链表长度不小于8时就将链表转化成红黑树，长度小于8时再转化为链表。既然红黑树能有效的提高查询速度（黑红树查找相当于二分查找），那为什么不一开始就把链表转化为红黑树，而是要在链表长度大于8时才做这样的处理呢？这里个人理解，红黑树固然能提高查询速度，但也带来了维护红黑树的成本。我们知道红黑树是一颗自平衡的二叉树，因此在插入数据时，有可能导致红黑树不平衡，这时需要翻转红黑树使它达到平衡状态。而8这个数字就是链表和数字在插入效率和查询效率上的折中处理，就如同HashMap的负载因子是0.75，而不是0.6或是0.8，是一个道理。在jdk源码中Entry的实现类如下</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// key的哈希值</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>        <span class="token keyword">final</span> K key<span class="token punctuation">;</span>        V value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 下一个Node，没有则为null</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//省略下面代码</span>    <span class="token punctuation">}</span></code></pre><p>在HashMap类中还定义了几个静态常量，这几个常量是一些很重要的属性，源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span>     <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">,</span> Cloneable<span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">/**     * HashMap的默认初始容量大小 16     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// aka 16</span>    <span class="token comment" spellcheck="true">/**     * HashMap的最大容量 2的30次方     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 负载因子，代表了table的填充度有多少，默认是0.75。当数组中的数据大于总长度的0.75倍时     * HashMap会自动扩容，默认扩容到原长度的两倍。为什么是两倍，而不是1.5倍，或是3倍。这个     * 2倍很睿智，后面会说到     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 默认阈值，当桶(bucket)上的链表长度大于这个值时会转成红黑树，put方法的代码里有用到     * 在jdk1.7中链表就是普通的单向链表，很多数据出现哈希碰撞导致这些数据集中在某一个哈希桶上，     * 因而导致链表很长，会出现效率问题，jdk1.8对此做了优化，默认当链表长度大于8时转化为红黑树     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 和上一个的阈值相对的阈值，当桶(bucket)上的链表长度小于这个值时红黑树退化成链表     */</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> UNTREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 用于快速失败，由于HashMap非线程安全，在对HashMap进行迭代时，如果期间其他线程的参与导致HashMap      * 的结构发生变化了（比如put，remove等操作），需要抛出异常ConcurrentModificationException     */</span>    <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>HashMap有两个有参构造器可以用来设置initialCapacity和loadFactor的值，即HashMap的初始容量和负载因子的值，如果不传参则都使用默认值。</p><h3 id="2-HashMap的几个重要方法"><a href="#2-HashMap的几个重要方法" class="headerlink" title="2.HashMap的几个重要方法"></a>2.HashMap的几个重要方法</h3><h4 id="（1）put方法"><a href="#（1）put方法" class="headerlink" title="（1）put方法"></a>（1）put方法</h4><p>废话不多说，直接上源码，下面所有方法我都加上了注释，以方便阅读理解</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> V <span class="token function">put</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>源码中put方法调用了putval方法，OK,接下来我们来看看putval操作的实现吧</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>               <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//table全局变量,存储链表头节点数组</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//如果table数组是空的，则创建一个头结点数据，默认长度是16</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//n是table长度,根据数组长度和key的哈希值，定位当前key在table中的下标位置,如果为空则新建一个node。不为空走else</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span> K k<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果新的key与table中索引处取出的头节点的key相等，且hash值一致，则把新的node替换掉旧的node</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            e <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//如果头节点不是空，且头节点的类型是树节点类型，则把当前节点插入当前头节点所在的树中(红黑树，防止链表过长，1.8的优化)</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//map的数据结构处理</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//遍历链表</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                如果当前节点的下一个节点为空，则把新节点插入到下一个节点                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//如果链表长度大于或等于8，则把链表转化为红黑树，重点转化方法(treeifyBin)</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// -1 for 1st</span>                    <span class="token comment" spellcheck="true">//此方法构建红黑树</span>                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//如果当前节点的key和hash均和待插入的节点相等，则退出循环，(注意此时e的值在前一个if时赋值过，因此当前的e值，就是链表中的当前节点值)</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                p <span class="token operator">=</span> e<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//如果老节点不是空，则将老节点的值替换为新值，并返回老的值</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// existing mapping for key</span>            V oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> null<span class="token punctuation">)</span>                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//此方法实现的逻辑,是把入参的节点放置在链表的尾部，但在HashMap中是空实现，在LinkedHashMap中有具体实现</span>            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//保证并发访问时，若HashMap内部结构发生变化，快速响应失败</span>    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//当table[]长度大于临界阈值，调用resize方法进行扩容</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//此方法在HashMap中是空方法，在LinkedHashMap中有实现</span>    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h4 id="2-treeify方法构建红黑树"><a href="#2-treeify方法构建红黑树" class="headerlink" title="(2) treeify方法构建红黑树"></a>(2) treeify方法构建红黑树</h4><p>此方法中比较重要的方法就是treefyBin方法了，此方法以当前节点为头节点，构建一个双向链表(双向链表：链表的一种，它的每个数据结点中都有两个指针，分别指向直接后继和直接前驱。所以，从双向链表中的任意一个结点开始，都可以很方便地访问它的前驱结点和后继结点</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> index<span class="token punctuation">;</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TREEIFY_CAPACITY<span class="token punctuation">)</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> hd <span class="token operator">=</span> null<span class="token punctuation">,</span> tl <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p <span class="token operator">=</span> <span class="token function">replacementTreeNode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>tl <span class="token operator">==</span> null<span class="token punctuation">)</span>                hd <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">;</span>                tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            tl <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> hd<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//以当前节点为根节点，构建一颗红黑树</span>            hd<span class="token punctuation">.</span><span class="token function">treeify</span><span class="token punctuation">(</span>tab<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>然后在这个方法中构建红黑树，jdk1.8对HashMap的优化核心也在于此方法，可以重点看看</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeify</span><span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">)</span> <span class="token punctuation">{</span>    TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> root <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义树的根节点</span>    <span class="token comment" spellcheck="true">//这里的this是通过hd.treeify(tab);方法调用的，因此this就是hd，而hd是table数组中某个值，也就是链表的头节点</span>    <span class="token comment" spellcheck="true">// 以下的代码就是从头节点开始遍历链表</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> next<span class="token punctuation">;</span> x <span class="token operator">!=</span> null<span class="token punctuation">;</span> x <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 遍历链表，x指向当前节点、next指向下一个节点</span>        next <span class="token operator">=</span> <span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>x<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 下一个节点</span>        x<span class="token punctuation">.</span>left <span class="token operator">=</span> x<span class="token punctuation">.</span>right <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置当前节点的左右节点为空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 如果还没有根节点</span>            x<span class="token punctuation">.</span>parent <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前节点的父节点设为空</span>            x<span class="token punctuation">.</span>red <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前节点的红色属性设为false（把当前节点设为黑色）</span>            root <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 根节点指向到当前节点</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 如果已经存在根节点了</span>            K k <span class="token operator">=</span> x<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取得当前链表节点的key</span>            <span class="token keyword">int</span> h <span class="token operator">=</span> x<span class="token punctuation">.</span>hash<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取得当前链表节点的hash值</span>            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> kc <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义key所属的Class</span>            <span class="token comment" spellcheck="true">//遍历红黑树</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p <span class="token operator">=</span> root<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 从根节点开始遍历，此遍历没有设置边界，只能从内部跳出</span>                <span class="token comment" spellcheck="true">// GOTO1</span>                <span class="token keyword">int</span> dir<span class="token punctuation">,</span> ph<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dir 标识方向（左右）、ph标识当前树节点的hash值</span>                K pk <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前树节点的key</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ph <span class="token operator">=</span> p<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">></span> h<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 如果当前树节点hash值 大于 当前链表节点的hash值</span>                    dir <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 标识当前链表节点会放到当前树节点的左侧</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ph <span class="token operator">&lt;</span> h<span class="token punctuation">)</span>                    dir <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 右侧</span>                <span class="token comment" spellcheck="true">/*                 * 如果两个节点的key的hash值相等，那么还要通过其他方式再进行比较                 * 如果当前链表节点的key实现了comparable接口，并且当前树节点和链表节点是相同Class的实例，那么通过comparable的方式再比较两者。                 * 如果还是相等，最后再通过 tieBreakOrder 比较一次                 */</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kc <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span>                <span class="token comment" spellcheck="true">//comparableClassFor返回键的类对象，该类必须实现Comparable接口，否则返回null</span>                            <span class="token punctuation">(</span>kc <span class="token operator">=</span> <span class="token function">comparableClassFor</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">||</span>                            <span class="token punctuation">(</span>dir <span class="token operator">=</span> <span class="token function">compareComparables</span><span class="token punctuation">(</span>kc<span class="token punctuation">,</span> k<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                    dir <span class="token operator">=</span> <span class="token function">tieBreakOrder</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">;</span>                TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> xp <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存当前树节点</span>                <span class="token comment" spellcheck="true">/*                 * 如果dir 小于等于0 ： 当前链表节点一定放置在当前树节点的左侧，但不一定是该树节点的左孩子，也可能是左孩子的右孩子 或者 更深层次的节点。                 * 如果dir 大于0 ： 当前链表节点一定放置在当前树节点的右侧，但不一定是该树节点的右孩子，也可能是右孩子的左孩子 或者 更深层次的节点。                 * 如果当前树节点不是叶子节点，那么最终会以当前树节点的左孩子或者右孩子 为 起始节点  再从GOTO1 处开始 重新寻找自己（当前链表节点）的位置                 * 如果当前树节点就是叶子节点，那么根据dir的值，就可以把当前链表节点挂载到当前树节点的左或者右侧了。                 * 挂载之后，还需要重新把树进行平衡。平衡之后，就可以针对下一个链表节点进行处理了。                 */</span>                 <span class="token comment" spellcheck="true">//如果dir等于-1则，插入到左树，如果是1则插入到右树</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span>dir <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>left <span class="token operator">:</span> p<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    x<span class="token punctuation">.</span>parent <span class="token operator">=</span> xp<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前链表节点 作为 当前树节点的子节点</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>                        xp<span class="token punctuation">.</span>left <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 作为左孩子</span>                    <span class="token keyword">else</span>                        xp<span class="token punctuation">.</span>right <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 作为右孩子</span>                    root <span class="token operator">=</span> <span class="token function">balanceInsertion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 重新平衡</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 把所有的链表节点都遍历完之后，最终构造出来的树可能经历多个平衡操作，根节点目前到底是链表的哪一个节点是不确定的</span>    <span class="token comment" spellcheck="true">// 因为我们要基于树来做查找，所以就应该把 tab[N] 得到的对象一定根节点对象，而目前只是链表的第一个节点对象，所以要做相应的处理。</span>    <span class="token function">moveRootToFront</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><h4 id="（3）resize方法对HashMap扩容"><a href="#（3）resize方法对HashMap扩容" class="headerlink" title="（3）resize方法对HashMap扩容"></a>（3）resize方法对HashMap扩容</h4><p>接下来看看扩容方法</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//oldCap---原hashMap的最大容量,oldThr---原hashMap的负载容量</span>    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            threshold <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//左移一位,就是将原来的容量翻倍，翻倍后的值小于2的30次方，大于原来的容量值</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span>                 oldCap <span class="token operator">>=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//原来的负载容量翻倍     </span>            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// double threshold</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// initial capacity was placed in threshold</span>        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">// zero initial threshold signifies using defaults</span>        newCap <span class="token operator">=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_LOAD_FACTOR <span class="token operator">*</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>MAXIMUM_CAPACITY <span class="token operator">?</span>                  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> null<span class="token punctuation">)</span>                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// preserve order</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> loHead <span class="token operator">=</span> null<span class="token punctuation">,</span> loTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> hiHead <span class="token operator">=</span> null<span class="token punctuation">,</span> hiTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">;</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>以上就是HashMpa中几个重要的方法，get方法相对来说比较简单就不做介绍了，当一个容量稍大的HashMap对象放在jvm中时，它数据的逻辑结构如下图</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap1.png" alt></p><p>其中白底的虚线框是数组，也可以说是哈希桶，当不同的数据经过哈希计算后被放到同一个哈希桶时（哈希碰撞）这些数据会以链表的方式组合在一起，也就是图中绿底框。当有相当多的数据出现哈希碰撞时，会导致这个链表很长，在使用get方法时，需要遍历链表，我们知道链表优势是增删快，查找慢，这样get方法效率会很低。因此在jdk1.8中对这里做了优化，当链表长度不小于8时就将链表转化成红黑树，长度小于8时再转化为链表。既然红黑树能有效的提高查询速度（黑红树查找相当于二分查找），那为什么不一开始就把链表转化为红黑树，而是要在链表长度大于8时才做这样的处理呢？这里个人理解，红黑树固然能提高查询速度，但也带来了维护红黑树的成本。我们知道红黑树是一颗自平衡的二叉树，因此在插入数据时，有可能导致红黑树不平衡，这时需要翻转红黑树使它达到平衡状态。而8这个数字就是链表和数字在插入效率和查询效率上的折中处理，就如同HashMap的负载因子是0.75，而不是0.6或是0.8，是一个道理。</p><h3 id="3-HashMap的扩容"><a href="#3-HashMap的扩容" class="headerlink" title="3 . HashMap的扩容"></a>3 . HashMap的扩容</h3><p>通过阅读源码，我们知道HashMap中数组的默认初始长度是16。但当数组中有数据的个数超过总数的0.75时，HashMap就会自动扩容。一旦扩容，就意味着，旧的HashMap中的Entry全部要迁移到新的HashMap中，也就是rehash。想一下如果是你做这件事，你会怎么做呢？我思考过这个问题，首先要把所有的Entry放到一起，然后遍历所有的Entry，出现哈希碰撞时，就把碰撞的数据组成链表。为什么要遍历所有的Entry，因为table[]的长度变成了原来的两倍，所以所有的Entry都需要通过哈希算法重新定位到新的哈希桶。这样做确实很直接，简单粗暴。但如果旧的HashMap中数据量非常大，这样做不但需要一个超大的数组暂存所有的Entry，而且HashMap的扩容将是一个巨大且低效率的 “工程” 。HashMap源码的编写者比我要睿智的多，我们来看看HashMap源码中扩容是怎么做的。其实这个问题的核心点在于哈希算法的设计。也就是Entry的key通过什么样的哈希算法定位到table中的位置。下面是jdk中的哈希算法</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> h<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>以及putval方法</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>                   <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//这里是定位Entry在table[]中的下标，其中n是table[]的长度</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>   <span class="token punctuation">}</span></code></pre><p>上面两个方法，第一个是hash算法，这个方法的作用是根据key计算哈希值，使结果尽量的离散，这样当数据很多时，数据才会尽可能均匀的分布在哈希桶中。而第二个方法中数组的长度与哈希值的与计算得到下标。然后就是最后一个巧妙的设计了，table[]扩容为原来的两倍。我们先来看以下两种情况，这里HashMap的长度是默认值16</p><p>1.key计算后的哈希值小于16</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/3.png" alt></p><p>2.key计算后的哈希值大于16</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/4.png" alt></p><p>图中的与运算就是源码中Entry确定table下标的代码，也就是上面putval代码的第七行 p = tab[i = (n - 1) &amp; hash] 这行代码的计算。从图中计算的结果可以看出，与运算保留了低位的值，去掉了高位的值。因此在hash值小于16的情况下，旧的Entry在重新定位到扩容后的新HashMap的table下标时，得到的下标值是一样的。而在hash值大于16的情况下，旧的Entry在重新定位到扩容后的新HashMap的table下标时，得到的下标值是不一样的。这说明在第一次HashMap扩容时，hash值大于16的Entry会迁移到新的位置，而小于16的Entry不需要迁移。这就保证了旧table已经散列良好的数据位置重新调换的频率。而每次扩容两倍更是保证了，每次变化的位数只有一位，如下图</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap4.png" alt></p><p>这样就可以使之前已经散列好的数组变动最小，这也是为什么扩容2倍的原因。到这里可以给HashMap的原理做个总结：<strong>HashMap由数组加链表组成的，数组是HashMap的哈希桶，链表则是为解决哈希碰撞而存在的，如果定位到的数组位置不含链表（即哈希桶中只有一个Entry）,那么对于查找，添加等操作很快，仅需一次寻址即可（数组根据下标寻址，速度很快）；如果定位到的数组包含链表，对于添加操作，其时间复杂度为O(n)，首先遍历链表，存在即覆盖，否则新增；对于查找操作来讲，也需遍历链表，然后通过key对象的equals方法逐一比较查找。所以，性能考虑，HashMap中的链表出现越少，性能就会越好。（其实也就是key的哈希值越离散，Entry就会尽可能的均匀分布，出现链表的概率也就越低）</strong></p><h3 id="4-重写equals和hashCode方法"><a href="#4-重写equals和hashCode方法" class="headerlink" title="4 . 重写equals和hashCode方法"></a>4 . 重写equals和hashCode方法</h3><p>这个问题相信很多初学java的朋友都碰到过。就是在使用自定义对象作为HashMap的key时，如果重写了equals，也一定要重写hashcode方法。首先来看个小例子，如果在类中重写了equals方法，但是不重写hashCode方法会出现什么样的问题</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String card<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Car</span><span class="token punctuation">(</span>String card<span class="token punctuation">,</span>String name<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>card<span class="token operator">=</span>card<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span>name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Car person <span class="token operator">=</span> <span class="token punctuation">(</span>Car<span class="token punctuation">)</span> o<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//两辆车，根据车牌判断是否相等</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>card<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//省略set和get方法</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        HashMap<span class="token operator">&lt;</span>Car<span class="token punctuation">,</span>String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Car car1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">"湘B2731"</span><span class="token punctuation">,</span><span class="token string">"本田"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>car1<span class="token punctuation">,</span><span class="token string">"张三的车"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Car car2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">"湘B2731"</span><span class="token punctuation">,</span><span class="token string">"本田"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结果---"</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>car2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>我定义了一个汽车类，重写了equals方法，通过判断两辆车的车牌号相等来判断是否为同一辆车，预期结果应该输出 张三的车 ，可实际结果却不是这样的，实际输出如下</p><pre><code>结果---null</code></pre><p>通过上面HashMap的原理，我们大概能明白其中的道理，是因为我们没有重写hashCode方法的原因，因为两个对象的哈希值不一样，导致定位到了HashMap的不同哈希桶中，因此没有get到值。但为什么hashCode会不相等呢。这需要搞清楚hashCode方法的原理。equals方法和hashCode方法都属于java基类Object类的方法，其中equals方法是用于比较两个值是否相等的。hashCode主要作用是为了配合基于散列的集合一起正常运行，这样的散列集合包括HashSet、HashMap以及HashTable，可以这么理解hashCode方法就是为了集合而生的。或许很多数人都会想到调用equals方法来逐个进行比较，这个方法确实可行。但是如果集合中已经存在成千上万条数据或者更多，如果采用equals方法遍历比较，效率必然是一个问题。此时hashCode方法的作用就体现出来了，当需要通过集合查找某条数据时，先调用这个对象的hashCode方法，得到对应的hashcode值。这样就把值的范围定位到一小片区域（即哈希桶）中，只要遍历这里面的数据就能找到这条数据了。说了这么多，那么hashCode是怎么计算而来的呢？有些朋友误以为默认情况下，hashCode返回的就是对象的存储地址，这种看法是不全面的，确实有些JVM在实现时是直接返回对象的存储地址，但是大多时候并不是这样，只能说与存储地址有一定关联。下面是HotSpot JVM中生成hash散列值的实现：</p><pre class=" language-c++"><code class="language-c++">static inline intptr_t get_next_hash(Thread * Self, oop obj) {  intptr_t value = 0 ;  if (hashCode == 0) {     // This form uses an unguarded global Park-Miller RNG,     // so it's possible for two threads to race and generate the same RNG.     // On MP system we'll have lots of RW access to a global, so the     // mechanism induces lots of coherency traffic.     value = os::random() ;  } else  if (hashCode == 1) {     // This variation has the property of being stable (idempotent)     // between STW operations.  This can be useful in some of the 1-0     // synchronization schemes.     intptr_t addrBits = intptr_t(obj) >> 3 ;     value = addrBits ^ (addrBits >> 5) ^ GVars.stwRandom ;  } else  if (hashCode == 2) {     value = 1 ;            // for sensitivity testing  } else  if (hashCode == 3) {     value = ++GVars.hcSequence ;  } else  if (hashCode == 4) {     value = intptr_t(obj) ;  } else {     // Marsaglia's xor-shift scheme with thread-specific state     // This is probably the best overall implementation -- we'll     // likely make this the default in future releases.     unsigned t = Self->_hashStateX ;     t ^= (t << 11) ;     Self->_hashStateX = Self->_hashStateY ;     Self->_hashStateY = Self->_hashStateZ ;     Self->_hashStateZ = Self->_hashStateW ;     unsigned v = Self->_hashStateW ;     v = (v ^ (v >> 19)) ^ (t ^ (t >> 8)) ;     Self->_hashStateW = v ;     value = v ;  }  value &= markOopDesc::hash_mask;  if (value == 0) value = 0xBAD ;  assert (value != markOopDesc::no_hash, "invariant") ;  TEVENT (hashCode: GENERATE) ;  return value;}</code></pre><p>该实现位于hotspot/src/share/vm/runtime/synchronizer.cpp文件下。到这里我们就能明白为什么只重写equals方法不行了，既然hashCode和对象内存地址有关系，那么上面那个例子中，在往HahsMap中set和get时，明显是两个不同的对象，因此肯定会得到不同的哈希值。当我们重写了hashCode方法后，就能得到预期的结果了。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String card<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Car</span><span class="token punctuation">(</span>String card<span class="token punctuation">,</span>String name<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>card<span class="token operator">=</span>card<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span>name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Objects<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> name<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Car person <span class="token operator">=</span> <span class="token punctuation">(</span>Car<span class="token punctuation">)</span> o<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//两辆车，根据车牌判断是否相等</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>card<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 省略get和set方法</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        HashMap<span class="token operator">&lt;</span>Car<span class="token punctuation">,</span>String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Car car1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">"湘B2731"</span><span class="token punctuation">,</span><span class="token string">"本田"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>car1<span class="token punctuation">,</span><span class="token string">"张三的车"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Car car2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">"湘B2731"</span><span class="token punctuation">,</span><span class="token string">"本田"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结果---"</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>car2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>实际输出结果</p><pre><code>结果---张三的车</code></pre><h3 id="5-HashMap的并发问题"><a href="#5-HashMap的并发问题" class="headerlink" title="5 . HashMap的并发问题"></a>5 . HashMap的并发问题</h3><p>HashMap是不能在并发场景下使用的，因为在HashMap的源码中，它的所有方法都没有同步处理。实际上只要是在堆中的对象，如果在多线程情况下使用而不做同步处理的话，都有可能导致数据不一致的问题。HashMap独特的数据结构还会带来另一个问题，这个问题在jdk1.8中得到了解决，但在jdk1.7中这个bug是很严重的存在，关于这个问题的解析，网上的博客也有很多，这里我也再回顾一下这个问题，权当复习，下面不做声明的话，默认都是说的jdk1.7的HashMap。</p><h4 id="1-jdk1-7中HashMap的并发问题"><a href="#1-jdk1-7中HashMap的并发问题" class="headerlink" title="1. jdk1.7中HashMap的并发问题"></a>1. jdk1.7中HashMap的并发问题</h4><p>大家都知道HashMap正常情况下哈希桶中的数据是一个单向链表，而并发情况下哈希桶中的链表有可能会形成一个环形链表。而一旦环形链表出现将会出现一个严重的问题，就是HashMap的get方法。我们知道在使用get时，首先会通过哈希算法定位到哈希桶，然后再通过equals方法遍历链表，获取key对象的值。问题就出现在这里，因为需要遍历链表，如果链表变成环形链表，这个遍历就会变成死循环。这个导致当前线程持续占用cpu资源，得不到释放，甚至会把cpu资源耗尽，是一个极其危险的情况。当另外一个线程get 到这个死循环的key的时候，这个线程也陷入死循环。最后结果是越来越多的线程死循环，最后导致服务器宕机。那么HashMap的环形链表是如何出现的呢？究其原因是因为它的扩容机制，即rehash。当table中的哈希桶超过HashMap默认的0.75时，会自动扩容，这个扩容在单线程下没有任何问题。而在多线程下问题就暴露出来了。那么来看看多线程场景下，环形链表是怎么出现的。下面是jdk1.7中的resize方法，这里省略了部分代码，直接看核心代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token keyword">int</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">{</span>    Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> oldTable <span class="token operator">=</span> table<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> oldTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//省略无关代码</span>    <span class="token comment" spellcheck="true">//创建一个新的Hash Table</span>    Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> newTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//将Old Hash Table上的数据迁移到New Hash Table上</span>    <span class="token function">transfer</span><span class="token punctuation">(</span>newTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    table <span class="token operator">=</span> newTable<span class="token punctuation">;</span>    threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>newCapacity <span class="token operator">*</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在resize方法中调用了transfer方法，transfer方法源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span>Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> newTable<span class="token punctuation">)</span><span class="token punctuation">{</span>    Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> src <span class="token operator">=</span> table<span class="token punctuation">;</span>    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> newTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//  从OldTable里摘一个元素出来，然后放到NewTable中</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> src<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e <span class="token operator">=</span> src<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            src<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">do</span> <span class="token punctuation">{</span>                Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ① &lt;--假设线程一执行到这里就被调度挂起了</span>                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>                e<span class="token punctuation">.</span>next <span class="token operator">=</span> newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>                e <span class="token operator">=</span> next<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上面代码中，外层的for循环遍历的是HashMap的table[]，即所有哈希桶，而里层的do…while循环遍历的是哈希桶中的链表。现在假设有两个线程在执行put方法时，都出现了HashMap的扩容。两个线程怎么同时出现需要扩容的情况呢，很简单。看addEntry方法源码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">int</span> bucketIndex<span class="token punctuation">)</span><span class="token punctuation">{</span>    Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>bucketIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>    table<span class="token punctuation">[</span>bucketIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//查看当前的size是否超过了我们设定的阈值threshold，如果超过，需要resize</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token operator">++</span> <span class="token operator">>=</span> threshold<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// ② &lt;--线程挂起</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>上面两方法的源码中，我分别标注了①和②两个断点。这两个点就是环形链表的形成的原因，为了方便分析，再假设服务器cpu为单核。在②处代码是关于HashMap是否需要扩容的判断，由于此方法没有加synchronized修饰。于是当线程1运行到②处时，线程判断当前的HashMap需要扩容，就在此时线程1被挂起（线程是操作系统调度的最小单元，是否被挂起，什么时候被挂起，什么时候继续运行，都是由操作系统的线程调度说了算）。这时线程2也运行到了②处，这时由于线程1被挂起了，HashMap实际上还没有进行扩容操作。因此线程2也判断当前的HashMap需要扩容。于是两个线程都会执行resize方法。如果此时线程2一鼓作气，将扩容操作全执行完倒也好了，大不了线程1再执行一遍扩容操作，两个线程也会相安无事。可事与愿违，两个线程是交替运行的。在代码①处再出现线程被挂起的情况，就会出现环形链表。下面拿几个数据，举例说明一下，首先来看一下正常情况下的rehash过程。我假设HashMap的table初始长度为2，现在由于要rehash扩容到4。HashMap中有一个长度为3的链表。同样的为了简化分析，这里哈希算法，仅仅只是用key值除以table的长度取余来定位哈希桶的位置，哈希桶0有一个key为2的Entry，哈希桶1有3个key为3,5,7的Entry组成的链表，数据结构如下</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap5.png" alt></p><h5 id="正常的rehash过程"><a href="#正常的rehash过程" class="headerlink" title="正常的rehash过程"></a>正常的rehash过程</h5><p>1.table[]的第二次循环，遍历哈希桶1，链表的第一次循环，此时e指向Entry&lt;3,B&gt;，next指向Entry&lt;5,C&gt;；</p><p>2.table[]的第二次循环，遍历哈希桶1，链表的第二次循环，此时e指向Entry&lt;5,C&gt;，next指向Entry&lt;7,D&gt;；</p><p>3.table[]的第二次循环，遍历哈希桶1，链表的第三次循环，此时e指向Entry&lt;7,D&gt;，next指向null；为了便于理解，下图简单的描述了正常的rehash过程</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap9.png" alt></p><h5 id="并发的rehash过程"><a href="#并发的rehash过程" class="headerlink" title="并发的rehash过程"></a>并发的rehash过程</h5><p>假设线程2已经完成了对hashMap的扩容，那么线程1和线程2的状态分别如下（再强调一下出现环链的前置条件是两个线程同时读到了原HashMap的值，都准备扩容）</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap10.png" alt></p><p>这个时刻线程2完成rehash过程，有图不难看出，新的HashMap已经是由两条链表有值了，然后由于操作系统的调度，线程2挂起，线程1继续执行rehash过程。这时线程1拿到的新的HashMap已经是线程1rehash完成之后的HashMap，里面是有值的。我们来看线程1进行rehash的第一步</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap12.png" alt></p><p>在链表的第一次循环时，取下原链表的Entry&lt;3,B&gt;值，经过hash算法得到插入新HashMap的第三个下标，由于会采用头节点插入法，因此会得到Entry&lt;3,B&gt; 指向 Entry&lt;7,D&gt;，而此链表中原本就存在Entry&lt;3,B&gt;，且链表结构为Entry&lt;7,D&gt;指向Entry&lt;3,B&gt;。所以就出现了 Entry&lt;3,B&gt; 指向 Entry&lt;7,D&gt; 指向 Entry&lt;3,B&gt;。环形链表就这样出现了，上图实际上应该是这样子的</p><p><img src="/2019/01/02/hashmap-de-di-ceng-shi-xian/hashMap13.png" alt></p><p>我们知道正常rehash流程线程拿到是是一个新的全空的HashMap，而在并发情况下，线程1是在线程2进行了全部或者部分rehash基础上，对新的HashMap进行rehash，而且扩容时操作同一个链表导致了环形链表的出现。环形链表一旦出现将导致get方法出现问题，因为get方法时会遍历链表去找到对应的key。假设某个key经过hash需要去遍历3链表，而恰巧3链表中没有这个key，那么get方法就一直在遍历这个链表break不掉了。在jdk1.8中修复了这个问题，使用了两个局部链表进行扩容不会出现哈希环。但jdk1.8中HashMap仍然不可在并发场景下使用，因为HashMap的put方法在并发下会出现丢数据的问题。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对于HashMap的并发问题，有几种解决办法。1. 使用HashTable，这个类是线程安全的。但HashTable源码好像只是在方法上加上了synchronize方法，而synchronize 属于重量级锁，对效率损耗是比较大的。2. 使用jdk1.8中的ConcurrentHashMap，这个类实现了更高级的线程安全，且使用分段锁，在并发下也可有很高的吞吐量，推荐使用。对于HashMap的原理解析就到这吧，如有纰漏，望指正。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows安装docker</title>
      <link href="/2018/10/01/windows-an-zhuang-docker/"/>
      <url>/2018/10/01/windows-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的Linux机器上 。同时docker也可以安装在mac和windows系统上，本文记录的是docker在windows 10上的安装。docker是一种虚拟化技术，因此要安装docker，需要做的第一件事情就是要开启cpu的虚拟化。然后便是去docker的<a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">官方网站下载</a>。</p><p><img src="/2018/10/01/windows-an-zhuang-docker/docker5.png" alt></p><p>官网网速可能较慢，可使用<a href="https://pan.baidu.com/s/1vShpqzDjgdPYLTJTLhLVWA" target="_blank" rel="noopener">网盘下载</a>，密码：nvt2</p><a id="more"></a> <h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>安装过程比较简单，下载好docker toolbox后，全部默认安装即可。安装完成后会多出三个图标</p><p><img src="/2018/10/01/windows-an-zhuang-docker/dockertool.png" alt></p><p>注意查看Docker Quickstart Terminal的属性</p><p><img src="/2018/10/01/windows-an-zhuang-docker/docker1.png" alt></p><p>这里红框中的属性需配置为本地的 git 安装路径，否则将无法启动，然后双击Docker Quickstart Terminal便可运行docker。</p><p><img src="/2018/10/01/windows-an-zhuang-docker/docker.png" alt></p><h3 id="2-CRT连接Docker"><a href="#2-CRT连接Docker" class="headerlink" title="2. CRT连接Docker"></a>2. CRT连接Docker</h3><p>使用crt连接也比较简单，ip就是运行Docker Quickstart Terminal上面显示的ip。我的是192.168.99.100。用户名和密码分别是：docker/tcuser</p><p><img src="/2018/10/01/windows-an-zhuang-docker/docker2.png" alt></p><h3 id="3-Docker的更新"><a href="#3-Docker的更新" class="headerlink" title="3. Docker的更新"></a>3. Docker的更新</h3><p>如果有新版本的docker发布时，应该对本机的docker进行更新 。否则很可能会影响一些功能的继续使用 ，对本机的docker进行更新可以安装下述方式：  (1). 打开Docker Quickstart Terminal终端  。(2). 输入命令：docker-machine upgrade default</p><p><img src="/2018/10/01/windows-an-zhuang-docker/docker3.png" alt></p><h3 id="3-Docker中的常用命令"><a href="#3-Docker中的常用命令" class="headerlink" title="3. Docker中的常用命令"></a>3. Docker中的常用命令</h3><pre><code>## 查看本机imagesdocker images## 查看本机正在运行的containerdocker ps  ## 显示所有创建的容器docker ps -a## 从dockerhub上pull 镜像docker pull 镜像名称## 通过image运行container## -v 作用是目录挂载。这里 /c/Users/docker是宿主机的目录，对应的是本机的 C://Users/docker文件夹。必须是绝对路径## -p 作用是端口映射docker run -it --rm --name myTest -p 8888:8888 -v /c/Users/docker:/root/opt/workspace -v /c/Users/docker:/root/data## 删除某个容器docker rm 容器id</code></pre>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS搭建Spark集群</title>
      <link href="/2018/08/12/centos-da-jian-spark-ji-qun/"/>
      <url>/2018/08/12/centos-da-jian-spark-ji-qun/</url>
      
        <content type="html"><![CDATA[<p>Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎。 是 加州大学伯克利分校的AMP实验室所开发的类似Hadoop MapReduce的通用并行框架 。拥有Hadoop MapReduce所具有的优点；但不同于MapReduce的是——Job中间输出结果可以保存在内存中，从而不再需要读写HDFS，因此Spark能更好地适用于数据挖掘与机器学习等需要迭代的MapReduce的算法。 Spark 是在 Scala 语言中实现的，它将 Scala 用作其应用程序框架。与 Hadoop 不同，Spark 和 Scala 能够紧密集成，其中的 Scala 可以像操作本地集合对象一样轻松地操作分布式数据集。 尽管创建 Spark 是为了支持分布式数据集上的迭代作业，但是实际上它是对 Hadoop 的补充，Spark 是一个通用引擎，可用它来完成各种各样的运算，包括 SQL 查询、文本处理、机器学习等 。本文主要记录使用CentOS搭建Spark集群。</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark.png" alt></p><a id="more"></a> <h3 id="1-准备"><a href="#1-准备" class="headerlink" title="1 . 准备"></a>1 . 准备</h3><p>1.准备三台Centos虚拟机，信息如下</p><table><thead><tr><th>ip</th><th>OS</th><th>说明</th></tr></thead><tbody><tr><td>192.168.31.135</td><td>CentOS 7</td><td>Master</td></tr><tr><td>192.168.31.136</td><td>CentOS 7</td><td>Worker</td></tr><tr><td>192.168.31.137</td><td>CentOS 7</td><td>Worker</td></tr></tbody></table><p>2 . Java，去Oracle下载，注意Hadoop所要求的JAVA版本（java环境配置可参考之前zookeper集群搭建博客，这里不赘述）</p><p>3 . Hadoop，参考上一篇Hadoop集群搭建博文</p><p>4 . Scala ，去官网下载。下载地址：<a href="https://www.scala-lang.org/download/" target="_blank" rel="noopener">scala官网</a></p><p>5 . Spark，去官网下载。下载地址：</p><h3 id="2-安装scala"><a href="#2-安装scala" class="headerlink" title="2 . 安装scala"></a>2 . 安装scala</h3><p>进入官网来到下载页面</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/scala.png" alt></p><p>注意scala是运行于java虚拟机之上的，因此安装scala之前必须先配置好java环境。同时下载时注意对java的版本要求，例如上图中可得scala.2.12.6版本必须要求 java 8以上的版本。到此页面后拉至底部</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/scala1.png" alt></p><p>我们需要的是Linux版本，所以选择第一个支持Unix系统的下载即可。在服务器创建好文件夹</p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# cd /user[root@centos1 user]# lldrwxr-xr-x. 6 root root 59 8月   8 22:54 hadoopdrwxr-xr-x. 3 root root 25 4月  12 08:00 javadrwxr-xr-x. 3 root root 26 8月   7 22:21 scaladrwxr-xr-x. 3 root root 39 8月  10 23:15 sparkdrwxr-xr-x. 5 root root 60 4月  12 20:50 zookeeper</code></pre><p>将压缩包上传至 /user/scala目录下，使用解压命令解压。待解压完成后需要配置环境变量，使用如下命令编辑系统配置文件</p><pre><code>vi /etc/profile</code></pre><p>在最后加入scala的环境变量</p><pre><code>export SCALA_HOME=/user/scala/scala-2.12.6export PATH=$PATH:$SCALA_HOME/bin</code></pre><p>配置完成后，使用下面的命令使配置生效</p><pre><code>source /etc/profile</code></pre><p>然后能通过命令查看的scala版本，能进入scala shell表示配置成功</p><pre class=" language-shell"><code class="language-shell">[root@centos1 user]# scala -versionScala code runner version 2.12.6 -- Copyright 2002-2018, LAMP/EPFL and Lightbend, Inc.[root@centos1 user]# scalaWelcome to Scala 2.12.6 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_45).Type in expressions for evaluation. Or try :help.scala> </code></pre><h3 id="3-下载Spark"><a href="#3-下载Spark" class="headerlink" title="3 . 下载Spark"></a>3 . 下载Spark</h3><p>进入官网来到下载页面</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark1.png" alt></p><p>注意Spark依赖Hadoop，在选择Spark版本时，要注意它对Hadoop的版本要求。例如上图中Spark-2.3.1对Hadoop的版本要求是2.7以上。选择完合适的版本后即可下载压缩包。下载完成把压缩包上传至服务器目录解压。</p><pre><code>tar zxvf spark-2.3.1-bin-hadoop2.7.tgz</code></pre><h3 id="4-配置环境变量"><a href="#4-配置环境变量" class="headerlink" title="4 . 配置环境变量"></a>4 . 配置环境变量</h3><p>编辑系统配置文件</p><pre><code>vi /etc/profile</code></pre><p>在底部加入spark的安装目录，如下</p><pre><code>export SPARK_HOME=/user/spark/spark-2.3.1-bin-hadoop2.7export PATH=$PATH:$SPARK_HOME/bin</code></pre><p>保存退出后使用source命令使配置生效，同时通过spark-shell查看是否配置成功。如果出现如下界面表示已配置成功</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark2.png" alt></p><h3 id="5-配置Spark环境"><a href="#5-配置Spark环境" class="headerlink" title="5 . 配置Spark环境"></a>5 . 配置Spark环境</h3><p>进入spark安装目录，编辑spark-env.sh文件。没有该文件则新建一份</p><pre><code>[root@node1 ~]# cd /user/spark/spark-2.3.1-bin-hadoop2.7/conf[root@node1 ~]# cp spark-env.sh.template spark-env.sh[root@node1 ~]# vim spark-env.shexport JAVA_HOME=/user/java/jdk1.8.0_45export SCALA_HOME=/user/scala/scala-2.12.6export HADOOP_HOME=/user/hadoop/hadoop-2.8.4export HADOOP_CONF_DIR=/user/hadoop/hadoop-2.8.4/etc/hadoopexport SPARK_MASTER_IP=192.168.31.135export SPARK_WORKER_MEMORY=1gexport SPARK_WORKER_CORES=2export SPARK_WORKER_INSTANCES=1</code></pre><p>属性解释</p><table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>JAVA_HOME</td><td>Java安装目录</td></tr><tr><td>SCALA_HOME</td><td>Scala安装目录</td></tr><tr><td>HADOOP_HOME</td><td>hadoop安装目录</td></tr><tr><td>HADOOP_CONF_DIR</td><td>hadoop集群的配置文件的目录</td></tr><tr><td>SPARK_MASTER_IP</td><td>spark集群的Master节点的ip地址</td></tr><tr><td>SPARK_WORKER_MEMORY</td><td>每个worker节点能够最大分配给exectors的内存大小</td></tr><tr><td>SPARK_WORKER_CORES</td><td>每个worker节点所占有的CPU核数目</td></tr><tr><td>SPARK_WORKER_INSTANCES</td><td>每台机器上开启的worker节点的数目</td></tr></tbody></table><p>配置slaves文件，在文件底部加入work节点的Ip吗，内容如下</p><pre class=" language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true"># A Spark Worker will be started on each of the machines listed below.</span><span class="token comment" spellcheck="true"># localhost</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>31<span class="token punctuation">.</span>136192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>31<span class="token punctuation">.</span>137</code></pre><p>上述SCALA_HOME，SPARK_HOME，spark-env.sh，slaves文件的配置，可复制一份发送给所有Worker节点。不需更改，与Master节点保持完全一致。</p><h3 id="6-启动Spark"><a href="#6-启动Spark" class="headerlink" title="6  . 启动Spark"></a>6  . 启动Spark</h3><p>先启动Hadoop，进入 /user/hadoop/hadoop-2.8.4/sbin 目录执行 start-all.sh 脚本</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark3.png" alt></p><p>再启动Spark，进入 /user/spark/spark/spark-2.3.1-bin-hadoop2.7/sbin 目录执行 start-all.sh 脚本</p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark5.png" alt></p><p>spark已经成功启动完成，可通过jps命令查看状态</p><pre class=" language-shell"><code class="language-shell">[root@centos1 sbin]# jps1632 ResourceManager1321 NameNode1916 Master1996 Jps</code></pre><p>可看到有Master进程，同时可访问Web UI网址：<a href="http://192.168.31.135:8080/" target="_blank" rel="noopener">http://192.168.31.135:8080/</a> </p><p><img src="/2018/08/12/centos-da-jian-spark-ji-qun/spark4.png" alt></p><p>至此Spark集群搭建已经全部完成，下篇博客，将使用官方的单词计数例子，在自己搭建的集群上跑一跑</p>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> 实践 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS搭建Hadoop集群</title>
      <link href="/2018/08/11/centos-da-jian-hadoop-ji-qun/"/>
      <url>/2018/08/11/centos-da-jian-hadoop-ji-qun/</url>
      
        <content type="html"><![CDATA[<p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构。 Hadoop实现了一个分布式文件系统（Hadoop Distributed File System），简称HDFS。HDFS有高容错性的特点，并且设计用来部署在低廉的（low-cost）硬件上 。Hadoop的框架最核心的设计就是：HDFS和MapReduce。HDFS为海量的数据提供了存储，则MapReduce为海量的数据提供了计算。 通俗的理解就是我们计算的数据量超过了单机处理的能力，于是使用多台机器并行处理计算数据，但并行处理数据会存在各种问题，例如怎么给每个节点分派任务，怎么使各个节点算力达到均衡，在部分节点任务失败时如何恢复。这些便Hadoop帮我们解决的问题，简而言之，Hadoop是一个计算框架，并行处理计算模型。本文主要记录使用虚拟机搭建Hadoop集群过程。Hadoop有几种部署模式，分别是本地模式，伪分布式模式，完全分布式。其中本地模式和伪分布式模式都是在本地运行，其算力使用的是本机资源，并不是真正的并行计算，完全作体验之用，且过程也相对简单，不做介绍。本文记录的是完全分布式搭建过程。</p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop.png" alt></p><a id="more"></a> <h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1 . 准备工作"></a>1 . 准备工作</h3><p>1.准备三台Centos虚拟机，信息如下</p><table><thead><tr><th>ip</th><th>OS</th><th>说明</th></tr></thead><tbody><tr><td>192.168.31.135</td><td>CentOS 7</td><td>nameNode</td></tr><tr><td>192.168.31.136</td><td>CentOS 7</td><td>dataNode</td></tr><tr><td>192.168.31.137</td><td>CentOS 7</td><td>dataNode</td></tr></tbody></table><p>2 . JAVA，去Oracle下载，注意Hadoop所要求的JAVA版本（java环境配置可参考之前zookeper集群搭建博客，这里不赘述）</p><p>3 . Hadoop，一般YARN被集成在这里面</p><h3 id="2-下载Hadoop"><a href="#2-下载Hadoop" class="headerlink" title="2 . 下载Hadoop"></a>2 . 下载Hadoop</h3><p>进入hadoop官网下载tar包，下载地址：<a href="http://www.apache.org/dyn/closer.cgi/hadoop/common/" target="_blank" rel="noopener">Hadoop官网</a></p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop1.png" alt></p><p>如图，选择http下载</p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop2.png" alt></p><p>这里有很多hadoop的版本，选择一个下载即可。</p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop3.png" alt></p><p>选择tar.gz包下载</p><h3 id="3-解压-amp-环境变量配置"><a href="#3-解压-amp-环境变量配置" class="headerlink" title="3 . 解压&amp;环境变量配置"></a>3 . 解压&amp;环境变量配置</h3><p>首先在主节点上创建比要的文件夹</p><pre class=" language-powershell"><code class="language-powershell">mkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoopmkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoop<span class="token operator">/</span>tmpmkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoop<span class="token operator">/</span><span class="token keyword">var</span>mkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoop<span class="token operator">/</span>dfsmkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoop<span class="token operator">/</span>dfs<span class="token operator">/</span>namemkdir  <span class="token operator">/</span>user<span class="token operator">/</span>hadoop<span class="token operator">/</span>dfs<span class="token operator">/</span><span class="token keyword">data</span></code></pre><p>将下载好的tar包上传到 /user/hadoop 目录，并执行解压命令</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# tar zxvf hadoop-2.8.4.tar.gz</code></pre><p>待解压完成后，执行下面命令配置环境变量</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# vi /etc/profile</code></pre><p>在底部加入以下配置</p><pre class=" language-shell"><code class="language-shell">#hadoopexport HADOOP_HOME=/user/hadoop/hadoop-2.8.4export PATH=$PATH:$HADOOP_HOME/bin</code></pre><p>保存后，执行以下命令使修改生效</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# source /etc/profile</code></pre><p>然后执行以下命令，如果出现如下提示则说明配置成功</p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# hadoop -helpUsage: hadoop [--config confdir] [COMMAND | CLASSNAME]  CLASSNAME            run the class named CLASSNAME or  where COMMAND is one of:  fs                   run a generic filesystem user client  version              print the version  jar <jar>            run a jar file                       note: please use "yarn jar" to launch                             YARN applications, not this command.  checknative [-a|-h]  check native hadoop and compression libraries availability  distcp <srcurl> <desturl> copy file or directories recursively  archive -archiveName NAME -p <parent path> <src>* <dest> create a hadoop archive  classpath            prints the class path needed to get the                       Hadoop jar and the required libraries  credential           interact with credential providers  daemonlog            get/set the log level for each daemon  trace                view and modify Hadoop tracing settingsMost commands print help when invoked w/o parameters.</code></pre><h3 id="4-Hadoop配置"><a href="#4-Hadoop配置" class="headerlink" title="4 . Hadoop配置"></a>4 . Hadoop配置</h3><p>进入到hadoop安装目录</p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# cd /user/hadoop/hadoop-2.8.4/etc/hadoop/</code></pre><h3 id="一-hadoop-env-sh"><a href="#一-hadoop-env-sh" class="headerlink" title="一 . hadoop-env.sh"></a>一 . <strong>hadoop-env.sh</strong></h3><p>使用vi编辑</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# vi hadoop-env.sh</code></pre><p>配置JAVA_HOME</p><pre class=" language-shell"><code class="language-shell"># The only required environment variable is JAVA_HOME.  All others are# optional.  When running a distributed configuration it is best to# set JAVA_HOME in this file, so that it is correctly defined on# remote nodes.# The java implementation to use.#export JAVA_HOME=${JAVA_HOME}export JAVA_HOME=/user/java/jdk1.8.0_45# The jsvc implementation to use. Jsvc is required to run secure datanodes</code></pre><h3 id="二-yarn-env-sh"><a href="#二-yarn-env-sh" class="headerlink" title="二 . yarn-env.sh"></a>二 . <strong>yarn-env.sh</strong></h3><p>使用vi编辑</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# vi yarn-env.sh</code></pre><p>配置JAVA_HOME</p><pre class=" language-shell"><code class="language-shell"># some Java parameters# export JAVA_HOME=/home/y/libexec/jdk1.6.0/export JAVA_HOME=/user/java/jdk1.8.0_45if [ "$JAVA_HOME" != "" ]; then  #echo "run java in $JAVA_HOME"  JAVA_HOME=$JAVA_HOMEfi</code></pre><h3 id="三-slaves"><a href="#三-slaves" class="headerlink" title="三 . slaves"></a>三 . <strong>slaves</strong></h3><p>使用vi编辑</p><pre class=" language-shell"><code class="language-shell"> [root@centos1 hadoop]# vi slaves </code></pre><p>注释掉文件中原本的localhost，加入dataNode的节点配置。节点配置可以配置ip也可配置主机名。如果配置主机名，则需要在hosts文件中配置主机和ip的映射关系。这里我配置的是ip</p><pre class=" language-shell"><code class="language-shell">#localhost192.168.31.136192.168.31.137</code></pre><h3 id="四-配置文件介绍"><a href="#四-配置文件介绍" class="headerlink" title="四 . 配置文件介绍"></a>四 . 配置文件介绍</h3><p>在hadoop集群中，需要配置的文件主要包括四个，分别是core-site.xml、hdfs-site.xml、mapred-site.xml和yarn-site.xml，这四个文件分别是对不同组件的配置参数，主要内容如下表所示： </p><table><thead><tr><th>文件名称</th><th>作用对象</th><th>配置说明</th></tr></thead><tbody><tr><td>core-site.xml</td><td>集群全局参数</td><td>定义系统级别的参数 ， 如HDFS  URL的临时目录等</td></tr><tr><td>hdfs-site.xml</td><td>HDFS参数</td><td>定义nameNode存放位置、文件副本的个数、文件读取权限等</td></tr><tr><td>mapred-site.xml</td><td>Mapreduce参数</td><td>reduce任务的默认个数、任务所能够使用内存的默认上下限等</td></tr><tr><td>yarn-site.xml</td><td>Yarn参数</td><td>ResourceManager，NodeManager 通信端口，web监控端口等</td></tr></tbody></table><p>下面详细介绍各个配置文件的配置。</p><h3 id="五-core-site-xml"><a href="#五-core-site-xml" class="headerlink" title="五 . core-site.xml"></a>五 . <strong>core-site.xml</strong></h3><p>配置信息如下，其中tmp目录已经在步骤(2)中创建好，如果没有请自行创建</p><pre class=" language-xml-dtd"><code class="language-xml-dtd"><configuration>    <property>        <name>hadoop.tmp.dir</name>        <value>/user/hadoop/tmp</value>        <description>Abase for other temporary directories.</description>    </property>    <property>        <name>fs.defaultFS</name>        <value>hdfs://192.168.31.135:9000/</value>    </property></configuration></code></pre><p>属性解释</p><table><thead><tr><th>属性名</th><th>属性值</th><th>属性说明</th></tr></thead><tbody><tr><td>fs.defaultFS</td><td>hdfs://192.168.31.135:9000/</td><td>文件系统主机和端口，需配置nameNode的IP地址</td></tr><tr><td>io.file.buffer.size</td><td>4096</td><td>流文件的缓冲区大小，不配置则为默认值4096</td></tr><tr><td>hadoop.tmp.dir</td><td>/user/hadoop/tmp</td><td>临时文件夹，需提前创建好文件夹</td></tr></tbody></table><h3 id="六-hdfs-site-xml"><a href="#六-hdfs-site-xml" class="headerlink" title="六 . hdfs-site.xml"></a>六 . <strong>hdfs-site.xml</strong></h3><p>配置信息如下，其中tmp目录已经在步骤(2)中创建好，如果没有请自行创建</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.admin.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:9001<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.name.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/user/hadoop/dfs/name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Path on the local filesystem where theNameNode stores the namespace and transactions logs persistently.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.data.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/user/hadoop/dfs/data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Comma separated list of paths on the localfilesystem of a DataNode where it should store its blocks.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.replication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.permissions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>need not permissions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>属性解释</p><table><thead><tr><th>属性名</th><th>属性值</th><th>属性说明</th></tr></thead><tbody><tr><td>yarn.resourcemanager.admin.address</td><td>192.168.31.135:9001</td><td>Hdfs对应的Http服务器地址和端口，需配置nameNode的IP地址</td></tr><tr><td>dfs.name.dir</td><td>/user/hadoop/dfs/name</td><td>nameNode数据在本地文件系统的位置</td></tr><tr><td>dfs.data.dir</td><td>/user/hadoop/dfs/data</td><td>dataNode 储数据块时存储在本地文件系统的位置</td></tr><tr><td>dfs.replication</td><td>1</td><td>数据块副本数量，默认为3</td></tr><tr><td>dfs.permissions</td><td>false</td><td>是否在HDFS中开启权限检查</td></tr></tbody></table><h3 id="七-mapred-site-xml"><a href="#七-mapred-site-xml" class="headerlink" title="七 . mapred-site.xml"></a>七 . <strong>mapred-site.xml</strong></h3><p>配置信息如下，其中tmp目录已经在步骤(2)中创建好，如果没有请自行创建</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapred.job.tracker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:49001<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapred.local.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/user/hadoop/var<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>mapreduce.framework.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>yarn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>属性解释</p><table><thead><tr><th>属性名</th><th>属性值</th><th>属性说明</th></tr></thead><tbody><tr><td>mapred.job.tracker</td><td>192.168.31.135:49001</td><td>指定的是job.tracker的地址，没有设置这个参数的话，默认是local，即job会进行本地运行。</td></tr><tr><td>mapreduce.framework.name</td><td>yarn</td><td>取值local，classic或yarn其中之一，如果不是yarn，则不会使用YARN集群来实现资源的分配</td></tr><tr><td>mapred.local.dir</td><td>/user/hadoop/var</td><td>mapred做本地计算所使用的文件夹，可以配置多块硬盘，逗号分隔</td></tr></tbody></table><h3 id="八-yarn-site-xml"><a href="#八-yarn-site-xml" class="headerlink" title="八 . yarn-site.xml"></a>八 . <strong>yarn-site.xml</strong></h3><p>配置信息如下，其中tmp目录已经在步骤(2)中创建好，如果没有请自行创建</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- Site specific YARN configuration properties --></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>The address of the applications manager interface in the RM.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:8032<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>The address of the scheduler interface.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.scheduler.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:8030<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>The http address of the RM web application.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.webapp.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:8088<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.resource-tracker.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:8031<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>The address of the RM admin interface.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.resourcemanager.admin.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>192.168.31.135:8033<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.nodemanager.aux-services<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>mapreduce_shuffle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.nodemanager.auxservices.mapreduce.shuffle.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>org.apache.hadoop.mapred.ShuffleHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.scheduler.maximum-allocation-mb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>2048<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>discription</span><span class="token punctuation">></span></span>every node memery size(MB) default is 8182MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>discription</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.nodemanager.resource.memory-mb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>2048<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.nodemanager.vmem-check-enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>属性解释</p><table><thead><tr><th>属性名</th><th>属性值</th><th>属性说明</th></tr></thead><tbody><tr><td>yarn.resourcemanager.address</td><td>192.168.31.135:8032</td><td>ResourceManager 提供给客户端访问的地址。客户端通过该地址向RM提交应用程序，杀死应用程序等</td></tr><tr><td>yarn.resourcemanager.scheduler.address</td><td>192.168.31.135:8030</td><td>ResourceManager提供给ApplicationMaster的访问地址。ApplicationMaster通过该地址向RM申请资源、释放资源等</td></tr><tr><td>yarn.resourcemanager.resource-tracker.address</td><td>192.168.31.135:8031</td><td>ResourceManager 提供给NodeManager的地址。NodeManager通过该地址向RM汇报心跳，领取任务等</td></tr><tr><td>yarn.resourcemanager.admin.address</td><td>192.168.31.135:8033</td><td>ResourceManager 提供给管理员的访问地址。管理员通过该地址向RM发送管理命令等</td></tr><tr><td>yarn.resourcemanager.webapp.address</td><td>192.168.31.135:8088</td><td>ResourceManager对web 服务提供地址。用户可通过该地址在浏览器中查看集群各类信息</td></tr><tr><td>yarn.nodemanager.aux-services</td><td>mapreduce_shuffle</td><td>通过此配置项，用户可以自定义一些服务，例如Map-Reduce的shuffle功能就是采用这种方式实现的，这样就可以在NodeManager上扩展自己的服务。</td></tr><tr><td>yarn.scheduler.maximum-allocation-mb</td><td>2048</td><td>每个container向RM申请内存的最大值，单位MB。申请值大于此值，将最多得到此值内存。</td></tr><tr><td>yarn.nodemanager.resource.memory-mb</td><td>2048</td><td>NodeManager上可以用于container申请的物理内存大小，单位MB。</td></tr></tbody></table><h3 id="5-配置ssh免密登录"><a href="#5-配置ssh免密登录" class="headerlink" title="5 . 配置ssh免密登录"></a>5 . 配置ssh免密登录</h3><p>因为Hadoop需要通过SSH登录到各个节点进行操作，以免以后集群运算时，频繁提示输入密码。在三个节点上输入如下命令生成秘钥</p><pre class=" language-powershell"><code class="language-powershell"><span class="token namespace">[root@centos1 ~]</span><span class="token comment" spellcheck="true"># ssh-keygen -t rsa</span><span class="token namespace">[root@centos2 ~]</span><span class="token comment" spellcheck="true"># ssh-keygen -t rsa</span><span class="token namespace">[root@centos3 ~]</span><span class="token comment" spellcheck="true"># ssh-keygen -t rsa</span></code></pre><p>然后一直按回车，直到生成完成。如下图</p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop4.png" alt></p><p>将两个从节点slave1与slave2上的id_rsa.pub用scp命令发送给master</p><pre class=" language-shell"><code class="language-shell">[root@centos2 ~]# scp ~/.ssh/id_rsa.pub root@192.168.31.135:~/.ssh/id_rsa.pub.slave1[root@centos3 ~]# scp ~/.ssh/id_rsa.pub root@192.168.31.135:~/.ssh/id_rsa.pub.slave2</code></pre><p>在master上，将所有公钥加到用于认证的公钥文件authorized_keys中</p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# cat ~/.ssh/id_rsa.pub* >> ~/.ssh/authorized_keys </code></pre><p>然后将公钥文件authorized_keys分发给每台slave </p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# scp ~/.ssh/authorized_keys root@192.168.31.135:~/.ssh/[root@centos1 ~]# scp ~/.ssh/authorized_keys root@192.168.31.136:~/.ssh/</code></pre><p>最后在每台主机上，用SSH命令，检验下是否能免密码登录</p><h3 id="6-从节点配置"><a href="#6-从节点配置" class="headerlink" title="6 . 从节点配置"></a>6 . 从节点配置</h3><p>从节点配置文件跟主节点保持一致，不需要修改。在步骤(3)中配置了<strong>hadoop-env.sh</strong> ，<strong>yarn-env.sh</strong> ，<strong>slaves</strong> ，<strong>core-site.xml</strong> ，<strong>hdfs-site.xml</strong> ，<strong>mapred-site.xml</strong> ，<strong>yarn-site.xml</strong> 。把这些配置文件原封不动的复制到从节点的 /user/hadoop/hadoop-2.8.4/etc/hadoop/ 目录下即可</p><h3 id="7-启动Hadoop"><a href="#7-启动Hadoop" class="headerlink" title="7 . 启动Hadoop"></a>7 . 启动Hadoop</h3><p>启动操作都在nameNode上完成，启动之前首先将nameNode格式化，执行下面的命令，格式化nameNode</p><pre class=" language-shell"><code class="language-shell">[root@centos1 hadoop]# cd hadoop-2.8.4/bin/[root@centos1 bin]# ./hadoop namenode –format</code></pre><p>结果如下，则表示格式化成功</p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop5.png" alt></p><p>再进入sbin目录，启动Hadoop</p><pre class=" language-shell"><code class="language-shell">[root@centos1 sbin]# ./start-all.sh</code></pre><p>出现如下结果表示启动成功</p><pre class=" language-shell"><code class="language-shell">[root@centos1 ~]# cd /user/hadoop/hadoop-2.8.4/sbin/[root@centos1 sbin]# ./start-all.sh This script is Deprecated. Instead use start-dfs.sh and start-yarn.shStarting namenodes on [centos1]centos1: starting namenode, logging to /user/hadoop/hadoop-2.8.4/logs/hadoop-root-namenode-centos1.out192.168.31.136: starting datanode, logging to /user/hadoop/hadoop-2.8.4/logs/hadoop-root-datanode-centos2.out192.168.31.137: starting datanode, logging to /user/hadoop/hadoop-2.8.4/logs/hadoop-root-datanode-centos3.outStarting secondary namenodes [0.0.0.0]0.0.0.0: starting secondarynamenode, logging to /user/hadoop/hadoop-2.8.4/logs/hadoop-root-secondarynamenode-centos1.outstarting yarn daemonsstarting resourcemanager, logging to /user/hadoop/hadoop-2.8.4/logs/yarn-root-resourcemanager-centos1.out192.168.31.137: starting nodemanager, logging to /user/hadoop/hadoop-2.8.4/logs/yarn-root-nodemanager-centos3.out192.168.31.136: starting nodemanager, logging to /user/hadoop/hadoop-2.8.4/logs/yarn-root-nodemanager-centos2.out</code></pre><p>也可通过 jps 命令查询状态 ，nameNode上结果</p><pre class=" language-shell"><code class="language-shell">[root@centos1 sbin]# jps10902 Jps10281 NameNode10478 SecondaryNameNode10638 ResourceManager</code></pre><p>dataNode上结果</p><pre class=" language-shell"><code class="language-shell">[root@centos2 ~]# jps10437 Jps10300 NodeManager10191 DataNode</code></pre><p>本地打开 <a href="http://192.168.31.135:50070" target="_blank" rel="noopener">http://192.168.31.135:50070</a> </p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop6.png" alt></p><p>本地打开 <a href="http://192.168.31.135:8088/cluster" target="_blank" rel="noopener">http://192.168.31.135:8088/cluster</a> </p><p><img src="/2018/08/11/centos-da-jian-hadoop-ji-qun/hadoop7.png" alt></p><p>至此，Hadoop集群搭建完毕，并且成功启动。</p>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实践 </tag>
            
            <tag> hadoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS搭建zookeeper集群</title>
      <link href="/2018/08/05/centos-da-jian-zookeeper-ji-qun/"/>
      <url>/2018/08/05/centos-da-jian-zookeeper-ji-qun/</url>
      
        <content type="html"><![CDATA[<p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，也是Hadoop和Hbase的重要组件 。ZooKeeper的选主过程是以Fast Paxos算法为基础的。前面我有文章写过Paxos算法，Paxos 算法存在活锁的问题，即当有多个proposer交错提交时，有可能互相排斥导致没有一个proposer能提交成功，而Fast Paxos对Paxos进行了优化。通过选举产生一个leader (领导者)，只有leader才能提交proposer，具体算法可见Fast Paxos 。因此，要想弄懂ZooKeeper首先得对Fast Paxos有所了解 。因为此算法的特性，所以要求Zookeeper集群的节点数最好为奇数个，而且算法保证如果集群中Leader宕机，只要剩余节点在总节点数的半数以上，就会重新选主，继续对外提供服务。也正是由于这个原因，使得Zookeeper是一个高效的分布式协调服务，可以提供配置信息管理、命名、分布式同步、集群管理、数据库切换等服务，被广泛应用于分布式应用场景中。本人在工作中也使用了很久，故此记录一下。</p><a id="more"></a> <p>首先准备环境：三个虚拟机，jdk1.8。</p><table><thead><tr><th>ip地址</th><th>系统</th></tr></thead><tbody><tr><td>192.168.31.135</td><td>CentOS 7</td></tr><tr><td>192.168.31.136</td><td>CentOS 7</td></tr><tr><td>192.168.31.137</td><td>CentOS 7</td></tr></tbody></table><h3 id="1-JDK安装"><a href="#1-JDK安装" class="headerlink" title="1 . JDK安装"></a>1 . JDK安装</h3><p>(1) . jdk 1.8下载地址：<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">jdk-8u181-linux-x64.tar.gz</a> 。进入官网后选择Linux 64位下载</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/jdk.png" alt></p><p>创建一个用户文件夹</p><pre class=" language-shell"><code class="language-shell">mkdir /user/java</code></pre><p>将要下载好的jdk包上传到这个目录下，然后进入到这个目录执行如下命令</p><pre class=" language-shell"><code class="language-shell">tar -zxvf jdk-8u181-linux-x64.tar.gz</code></pre><p>解压缩包后 /user/java 会多出一个 jdk1.8.0_181文件夹。</p><p>(2) . 配置环境变量</p><p>使用vi命令编辑profile文件即可。如下</p><pre class=" language-shell"><code class="language-shell">vi /etc/profile</code></pre><p>下拉直文件底部，然后添加如下内容</p><pre class=" language-shell"><code class="language-shell">JAVA_HOME=/user/java/jdk1.8.0_181PATH=$JAVA_HOME/bin:$PATHCLASSPATH=.:$JAVA_HOME/jre/lib/ext:$JAVA_HOME/lib/tools.jarexport PATH JAVA_HOME CLASSPATH</code></pre><p>然后保存退出。为验证是否安装成功，可输入两个命令 javac，java -version。在输入javac出现如下信息，而不是出现<strong>command not found</strong> 。</p><pre class=" language-shell"><code class="language-shell">[root@centos1 java]# javac用法: javac <options> <source files>其中, 可能的选项包括:  -g                         生成所有调试信息  -g:none                    不生成任何调试信息  -g:{lines,vars,source}     只生成某些调试信息  -nowarn                    不生成任何警告  -verbose                   输出有关编译器正在执行的操作的消息  -deprecation               输出使用已过时的 API 的源位置  -classpath <路径>            指定查找用户类文件和注释处理程序的位置  -cp <路径>                   指定查找用户类文件和注释处理程序的位置  -sourcepath <路径>           指定查找输入源文件的位置  -bootclasspath <路径>        覆盖引导类文件的位置  -extdirs <目录>              覆盖所安装扩展的位置  -endorseddirs <目录>         覆盖签名的标准路径的位置  -proc:{none,only}          控制是否执行注释处理和/或编译。  -processor <class1>[,<class2>,<class3>...] 要运行的注释处理程序的名称; 绕过默认的搜索进程  -processorpath <路径>        指定查找注释处理程序的位置  -parameters                生成元数据以用于方法参数的反射  -d <目录>                    指定放置生成的类文件的位置  -s <目录>                    指定放置生成的源文件的位置  -h <目录>                    指定放置生成的本机标头文件的位置  -implicit:{none,class}     指定是否为隐式引用文件生成类文件  -encoding <编码>             指定源文件使用的字符编码  -source <发行版>              提供与指定发行版的源兼容性  -target <发行版>              生成特定 VM 版本的类文件  -profile <配置文件>            请确保使用的 API 在指定的配置文件中可用  -version                   版本信息  -help                      输出标准选项的提要  -A关键字[=值]                  传递给注释处理程序的选项  -X                         输出非标准选项的提要  -J<标记>                     直接将 <标记> 传递给运行时系统  -Werror                    出现警告时终止编译  @<文件名>                     从文件读取选项和文件名</code></pre><p>然后再输入 java -version 出现如下信息则表示jdk已安装成功</p><pre class=" language-shell"><code class="language-shell">[root@centos1 java]# java -versionjava version "1.8.0_181"Java(TM) SE Runtime Environment (build 1.8.0_45-b14)Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02, mixed mode)</code></pre><h3 id="2-Zookeeper下载"><a href="#2-Zookeeper下载" class="headerlink" title="(2) . Zookeeper下载"></a>(2) . Zookeeper下载</h3><p>下载地址：<a href="http://apache.fayea.com/zookeeper/" target="_blank" rel="noopener">zookeeper</a> 。如下图</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/zookeeper1.png" alt></p><p>选择合适的版本，这里我下载的是3.4.10。点击即可下载</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/zookeeper2.png" alt></p><p>也可在CentOS中通过shell命令下载。命令如下</p><pre class=" language-shell"><code class="language-shell">wget http://mirrors.cnnic.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</code></pre><p>通过如下镜像网址，可选择合适的版本下载</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/zookeeper3.png" alt></p><p>下载完成后将tar包放到 /user/zookeeper下，此目录可自行定义</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/zookeeper4.png" alt></p><p>进入到该目录，解压缩</p><pre class=" language-shell"><code class="language-shell">tar -zxvf zookeeper-3.4.10.tar.gz</code></pre><p>再定义两个目录用于存放日志和数据</p><p><img src="/2018/08/05/centos-da-jian-zookeeper-ji-qun/zookeeper5.png" alt></p><p>图中3.3.6是我之前安装的版本。具体命令如下</p><pre class=" language-shell"><code class="language-shell">mkdir zkdata #存放快照日志mkdir zkdatalog#存放事物日志</code></pre><h3 id="3-修改配置文件"><a href="#3-修改配置文件" class="headerlink" title="(3) . 修改配置文件"></a>(3) . 修改配置文件</h3><p>进入到zookeeper的解压目录中，找到conf目录，查看</p><pre class=" language-shell"><code class="language-shell">[root@centos1 /]# cd /user/zookeeper/zookeeper-3.3.6/conf[root@centos1 conf]# ll-rw-rw-r--. 1 1000 1000  535 7月  29 2012 configuration.xsl-rw-rw-r--. 1 1000 1000 1698 7月  29 2012 log4j.properties-rw-r--r--. 1 root root  550 4月  12 23:10 zoo.cfg-rw-rw-r--. 1 1000 1000  380 7月  29 2012 zoo_sample.cfg</code></pre><p>zoo_sample.cfg  这个文件是官方给我们的zookeeper的样板文件，给他复制一份命名为zoo.cfg，zoo.cfg是官方指定的文件命名规则。 这里我已经创建好了。zoo.cfg中配置信息如下</p><pre class=" language-hxml"><code class="language-hxml"># The number of milliseconds of each ticktickTime=2000# The number of ticks that the initial# synchronization phase can takeinitLimit=10# The number of ticks that can pass between# sending a request and getting an acknowledgementsyncLimit=5# the directory where the snapshot is stored.dataDir=/user/zookeeper/zkdata# the port at which the clients will connectclientPort=2181# log dirdataLogDir=/user/zookeeper/zkdatalog# ip settingserver.1=192.168.31.135:2888:3888server.2=192.168.31.136:2888:3888server.3=192.168.31.137:2888:3888</code></pre><p>配置文件属性解释</p><pre class=" language-hxml"><code class="language-hxml">#tickTime：这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。#initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒#syncLimit：这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是5*2000=10秒#dataDir：快照日志的存储路径#dataLogDir：事物日志的存储路径，如果不配置这个那么事物日志会默认存储到dataDir制定的目录，这样会严重影响zk的性能，当zk吞吐量较大的时候，产生的事物日志、快照日志太多#clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。修改他的端口改大点#server.1=192.168.31.135:2888:3888这个1是服务器的标识也可以是其他的数字， 表示这个是第几号服务器，用来标识服务器，这个标识要写到快照目录下面myid文件里。192.168.31.135为集群里的IP地址，第一个端口是master和slave之间的通信端口，默认是2888，第二个端口是leader选举的端口，集群刚启动的时候选举或者leader挂掉之后进行新的选举的端口默认是3888</code></pre><p>这个配置需要在每个zookeeper节点上配置，接下来在每个节点上分别创建myid文件 </p><pre class=" language-shell"><code class="language-shell">#server1echo "1" > /opt/zookeeper/zkdata/myid#server2echo "2" > /opt/zookeeper/zkdata/myid#server3echo "3" > /opt/zookeeper/zkdata/myid</code></pre><p>注意这里的1,2,3一定要和zoo.cfg配置文件中保持一致。</p><h3 id="4-日志配置"><a href="#4-日志配置" class="headerlink" title="(4) . 日志配置"></a>(4) . 日志配置</h3><p>作为开发人员，日志对于我们来说重要性不言而喻了，一旦出现问题首先就要去查看日志。那么zookeeper的日志配置在哪呢。同样在conf下有个log4j.properties文件。内容如下</p><pre class=" language-hxml"><code class="language-hxml">[root@centos1 conf]# cat log4j.properties ## ZooKeeper Logging Configuration## Format is "<default threshold> (, <appender>)+# DEFAULT: console appender only#日志级别log4j.rootLogger=INFO, CONSOLE# Example with rolling log file#log4j.rootLogger=DEBUG, CONSOLE, ROLLINGFILE# Example with rolling log file and tracing#log4j.rootLogger=TRACE, CONSOLE, ROLLINGFILE, TRACEFILE## Log INFO level and above messages to the console#log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppenderlog4j.appender.CONSOLE.Threshold=INFOlog4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayoutlog4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n## Add ROLLINGFILE to rootLogger to get log file output#    Log DEBUG level and above messages to a log filelog4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppenderlog4j.appender.ROLLINGFILE.Threshold=DEBUGlog4j.appender.ROLLINGFILE.File=zookeeper.log# Max log file size of 10MBlog4j.appender.ROLLINGFILE.MaxFileSize=10MB# uncomment the next line to limit number of backup files#log4j.appender.ROLLINGFILE.MaxBackupIndex=10log4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayoutlog4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n## Add TRACEFILE to rootLogger to get log file output#    Log DEBUG level and above messages to a log filelog4j.appender.TRACEFILE=org.apache.log4j.FileAppenderlog4j.appender.TRACEFILE.Threshold=TRACElog4j.appender.TRACEFILE.File=zookeeper_trace.loglog4j.appender.TRACEFILE.layout=org.apache.log4j.PatternLayout### Notice we are including log4j's NDC here (%x)log4j.appender.TRACEFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L][%x] - %m%n</code></pre><p>我们写代码时往往也会配置log4j ，因此会与zookeeper共用log4j的配置文件。所以需要修改这个配置文件，如下</p><pre class=" language-hxml"><code class="language-hxml"># Define some default values that can be overridden by system propertieszookeeper.root.logger=INFO, CONSOLE  #日志级别zookeeper.console.threshold=INFO  #使用下面的console来打印日志zookeeper.log.dir=.    #日志打印到哪里，就是在zoo.cfg中配置的路径zookeeper.log.file=zookeeper.logzookeeper.log.threshold=DEBUGzookeeper.tracelog.dir=.zookeeper.tracelog.file=zookeeper_trace.log## ZooKeeper Logging Configuration## Format is "<default threshold> (, <appender>)+# DEFAULT: console appender only#日志级别#log4j.rootLogger=INFO, CONSOLElog4j.rootLogger=${zookeeper.root.logger}# Example with rolling log file#log4j.rootLogger=DEBUG, CONSOLE, ROLLINGFILE# Example with rolling log file and tracing#log4j.rootLogger=TRACE, CONSOLE, ROLLINGFILE, TRACEFILE## Log INFO level and above messages to the console#log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppenderlog4j.appender.CONSOLE.Threshold=INFOlog4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayoutlog4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n## Add ROLLINGFILE to rootLogger to get log file output#    Log DEBUG level and above messages to a log filelog4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppenderlog4j.appender.ROLLINGFILE.Threshold=DEBUGlog4j.appender.ROLLINGFILE.File=zookeeper.log# Max log file size of 10MBlog4j.appender.ROLLINGFILE.MaxFileSize=10MB# uncomment the next line to limit number of backup files#log4j.appender.ROLLINGFILE.MaxBackupIndex=10log4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayoutlog4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n## Add TRACEFILE to rootLogger to get log file output#    Log DEBUG level and above messages to a log filelog4j.appender.TRACEFILE=org.apache.log4j.FileAppenderlog4j.appender.TRACEFILE.Threshold=TRACElog4j.appender.TRACEFILE.File=zookeeper_trace.loglog4j.appender.TRACEFILE.layout=org.apache.log4j.PatternLayout### Notice we are including log4j's NDC here (%x)log4j.appender.TRACEFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L][%x] - %m%n</code></pre><p>修改完成后，会发现日志文件输出目录不起作用。需修改zkEnv.sh 脚本，如下</p><pre class=" language-shell"><code class="language-shell">[root@centos1 conf]# cat /user/zookeeper/zookeeper-3.3.6/bin/zkEnv.sh#!/bin/sh# Licensed to the Apache Software Foundation (ASF) under one or more# contributor license agreements.  See the NOTICE file distributed with# this work for additional information regarding copyright ownership.# The ASF licenses this file to You under the Apache License, Version 2.0# (the "License"); you may not use this file except in compliance with# the License.  You may obtain a copy of the License at##     http://www.apache.org/licenses/LICENSE-2.0## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an "AS IS" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.# This script should be sourced into other zookeeper# scripts to setup the env variables# We use ZOOCFGDIR if defined,# otherwise we use /etc/zookeeper# or the conf directory that is# a sibling of this script's directoryif [ "x$ZOOCFGDIR" = "x" ]then    if [ -d "/etc/zookeeper" ]    then        ZOOCFGDIR="/etc/zookeeper"    else        ZOOCFGDIR="$ZOOBINDIR/../conf"    fifiif [ "x$ZOOCFG" = "x" ]then    ZOOCFG="zoo.cfg"fiZOOCFG="$ZOOCFGDIR/$ZOOCFG"if [ -e "$ZOOCFGDIR/java.env" ]then    . "$ZOOCFGDIR/java.env"fiif [ "x${ZOO_LOG_DIR}" = "x" ]then    ZOO_LOG_DIR="."fiif [ "x${ZOO_LOG4J_PROP}" = "x" ]then    ZOO_LOG4J_PROP="INFO,CONSOLE"fiif [ "$JAVA_HOME" != "" ]; then  JAVA="$JAVA_HOME/bin/java"else  JAVA=javafi#add the zoocfg dir to classpathCLASSPATH="$ZOOCFGDIR:$CLASSPATH"for i in "$ZOOBINDIR"/../src/java/lib/*.jardo    CLASSPATH="$i:$CLASSPATH"done#make it work in the releasefor i in "$ZOOBINDIR"/../lib/*.jardo    CLASSPATH="$i:$CLASSPATH"done#make it work in the releasefor i in "$ZOOBINDIR"/../zookeeper-*.jardo    CLASSPATH="$i:$CLASSPATH"done#make it work for developersfor d in "$ZOOBINDIR"/../build/lib/*.jardo   CLASSPATH="$d:$CLASSPATH"done#make it work for developersCLASSPATH="$ZOOBINDIR/../build/classes:$CLASSPATH"case "`uname`" in    CYGWIN*) cygwin=true ;;    *) cygwin=false ;;esacif $cygwinthen    CLASSPATH=`cygpath -wp "$CLASSPATH"`fi#echo "CLASSPATH=$CLASSPATH"</code></pre><p>找到配置ZOO_LOG_DIR以及ZOO_LOG4J_PROP的位置(大概在Line50，Line55) 。修改如下</p><pre class=" language-shell"><code class="language-shell">if [ "x${ZOO_LOG_DIR}" = "x" ]then    #配置zookeeper日志输出存放路径    ZOO_LOG_DIR="/home/xxx/zookeeper-2181/logs"fiif [ "x${ZOO_LOG4J_PROP}" = "x" ]then    #配置日志输出级别,这里把几个级别一并配上    ZOO_LOG4J_PROP="INFO,CONSOLE,ROLLINGFILE,TRACEFILE"fi</code></pre><p>这样zookeeper的日志配置就完成了。</p><h3 id="5-启动Zookeeper"><a href="#5-启动Zookeeper" class="headerlink" title="(5) . 启动Zookeeper"></a>(5) . 启动Zookeeper</h3><p>执行如下命令</p><pre class=" language-shell"><code class="language-shell">#进入到Zookeeper的bin目录下cd /user/zookeeper/zookeeper-3.3.6/bin#启动服务（3台都需要操作）./zkServer.sh start</code></pre><p>查看服务状态</p><pre class=" language-shell"><code class="language-shell">./zkServer.sh status</code></pre><p>通过该命令能看到如下信息则表示zookeeper已经成功启动</p><pre class=" language-shell"><code class="language-shell">#192.168.31.136[root@centos2 bin]# ./zkServer.sh statusJMX enabled by defaultUsing config: /user/zookeeper/zookeeper-3.3.6/bin/../conf/zoo.cfgMode: leader</code></pre><pre class=" language-shell"><code class="language-shell">#192.168.31.135[root@centos3 bin]# ./zkServer.sh statusJMX enabled by defaultUsing config: /user/zookeeper/zookeeper-3.3.6/bin/../conf/zoo.cfgMode: follower</code></pre><h3 id="6-常见问题"><a href="#6-常见问题" class="headerlink" title="(6) . 常见问题"></a>(6) . 常见问题</h3><p>执行 ./zkServer.sh start 命令未出现异常，但是在执行./zkServer.sh status 命令时报</p><pre class=" language-shell"><code class="language-shell">./zkServer.sh statusIt is probably not running</code></pre><p>可去bin目录吗，执行cat zookeeper.out查看日志</p><p>(1) . 错误信息：<strong>没有找到主机路由</strong> </p><p>该错误是没有关闭防火墙导致的，关闭即可。CentOS中防火墙程序主要是firewall和iptables，CentOS7中firewall服务已经默认安装好了，而iptables服务需要安装，CentOS中 iptables通过控制端口来控制服务，而firewalld则是通过控制协议来控制端口 。命令如下：</p><pre class=" language-shell"><code class="language-shell">yum  install  iptabes-services</code></pre><p><strong>firewall 相关的操作</strong></p><pre class=" language-shell"><code class="language-shell">#查看防火墙状态firewall-cmd    --state#关闭防火墙systemctl  stop   firewalld.service#开启防火墙systemctl  start   firewalld.service#禁止开机启动启动防火墙systemctl   disable   firewalld.service</code></pre><p><strong>iptables 相关的操作</strong></p><pre class=" language-shell"><code class="language-shell">#开启iptables防火墙systemctl  start  iptables.service#重启iptables防火墙systemctl  restart  iptables.service#关闭iptables防火墙systemctl  stop  iptables.service#查看iptables防火墙状态systemctl  status  iptables.service</code></pre><p>至此zookeeper安装启动全部完成，可以愉快的玩耍了。</p>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实践 </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VMware中安装CentOS 7</title>
      <link href="/2018/08/04/vmware-zhong-an-zhuang-centos7/"/>
      <url>/2018/08/04/vmware-zhong-an-zhuang-centos7/</url>
      
        <content type="html"><![CDATA[<p>Linux是一个诞生于网络、成长于网络且成熟于网络的奇特的免费的操作系统，用户可以通过网络或其他途径免费获得 并可以任意修改其源代码，是一个基于POSIX和UNIX的多用户、多任务、支持多线程和多CPU的操作系统。它能运行主要的UNIX工具软件、应用程序和网络协议。它支持32位和64位硬件。Linux支持多用户，各个用户对于自己的文件设备有自己特殊的权利，保证了各用户之间互不影响。 Linux继承了Unix以网络为核心的设计思想，是一个性能稳定的多用户网络操作系统。 正是由于它开放源代码，因此来自全世界的大批知名的、不知名的电脑黑客、编程人员参与了Linux的修改、编写工作，程序员可以根据自己的兴趣和灵感对其进行改变，这让Linux吸收了无数程序员的精华，不断壮大 。因此出现了很多Linux的发行版本，主要的几个发行版本有Fedora  ，Debian ，Ubuntu ，Red Hat ，Centos 。其中人气最高的就是Ubuntu 和Red Hat系列了，Ubuntu是一个以桌面应用为主的Linux操作系统，中文译作乌班图 。而Red Hat Linux是公共环境中表现上佳的服务器。它拥有自己的公司，能向用户提供一套完整的服务，这使得它特别适合在公共网络中使用 。而Centos则是<a href="https://baike.baidu.com/item/RHEL" target="_blank" rel="noopener">RHEL</a>（Red Hat Enterprise Linux）源代码再编译的产物，而且在RHEL的基础上修正了不少已知的 Bug ，相对于其他 Linux 发行版，其稳定性值得信赖。 </p><a id="more"></a> <p>平时如果想玩Centos又没有多余的电脑配置怎么办呢？这里虚拟机就派上用场了，可以在windows上安装虚拟机，然后再虚拟机中安装Linux操作系统即可。需要注意的是安装虚拟机需要电脑开启虚拟化技术，否则就会有问题的哦，开启虚拟化需要进入电脑的BIOS。不同的主板厂商BIOS界面略有区别，可自己根据个人的电脑型号百度一下如何开启虚拟化。</p><h3 id="1-安装VMware"><a href="#1-安装VMware" class="headerlink" title="1 . 安装VMware"></a>1 . 安装VMware</h3><p>首先去官网下载VMware，这里我下载的是最新版本VMware 14。下载地址： <a href="https://my.vmware.com/web/vmware/details?downloadGroup=WKST-1412-WIN&productId=686&rPId=23138" target="_blank" rel="noopener">VMware Workstation 14.1.2 Pro for Windows</a>。如下图</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/vmware.png" alt></p><p>选择产品下载，然后可以去百度找个秘钥破解即可(作为天朝的一员，这个技能应该信手拈来了)。下载好后，安装过程除了文件安装路径，其余都可以选择默认安装。</p><h3 id="2-下载Centos-7"><a href="#2-下载Centos-7" class="headerlink" title="2 . 下载Centos 7"></a>2 . 下载Centos 7</h3><p>同样去Centos的官网下载，下载地址：<a href="https://www.centos.org/download/" target="_blank" rel="noopener">Centos</a>。进入官网后会来到如下界面</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos1.png" alt></p><p>这里有几个版本，当然你可以选择你喜欢的版本下载，点击下面的More download choices可以选择更多的版本下载。题外话，这里发现Centos还支持Docker的下载方式，容器化正在成为一种趋势。这里选择Minimal IOS下载，这个版本是迷你版，不包含桌面只提供一些基本功能。</p><h3 id="3-创建虚拟机"><a href="#3-创建虚拟机" class="headerlink" title="3 . 创建虚拟机"></a>3 . 创建虚拟机</h3><p>(1) . 启动虚拟机后， 首先，点击创建新的虚拟机。出现下图所示，选择典型类型的配置，点击下一步： </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos2.png" alt></p><p>(2) . 此处选择第三个选项：稍后安装操作系统。然后点击下一步</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos3.png" alt></p><p>(3) . 选择Linux，版本选择Centos 7 64位，然后点击下一步</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos4.png" alt></p><p>(4) . 设置虚拟机的名称以及安装路径</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos5.png" alt></p><p>(5) . 默认20G即可，虚拟磁盘拆分成多个文件。点击下一步 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos6.png" alt></p><p>(6) . 点击自定义硬件，进行虚拟机硬件配置</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos7.png" alt></p><p>然后会来到如下界面，内存和CPU设置可根据个人需求设置，光驱此处选择使用ISO映像文件，选择我们已下载ISO的存储路径；其他配置项均默认即可，设置好后，点击关闭按钮。 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos8.png" alt></p><p>到这里，我们的虚拟机硬件配置就已经完成了，点击完成。</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos9.png" alt></p><p>下面开始安装操作系统。 </p><h3 id="4-安装CentOS"><a href="#4-安装CentOS" class="headerlink" title="4 . 安装CentOS"></a>4 . 安装CentOS</h3><p>(1) . 点击“开启此虚拟机” </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos10.png" alt></p><p>进入如下界面： </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos11.png" alt></p><p>可选择第一项，install Centos开始安装系统，然后就耐心等待吧 </p><p>(2) . 选择语言，我们这里将鼠标拉到页面底部，选择中文，点击继续。</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos12.png" alt></p><p>(3) .  在设置首页，向下滑动至系统选项，选择安装位置 (D)</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos13.png" alt></p><p>选中磁盘，点击“我要配置分区”后，点击完成 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos14.png" alt></p><p>(4) . 在手动分区页面，进行如下设置 。点击加号按钮，弹出选择挂载点框，首先添加一个swap分区，容量输入2048，点击添加挂载点。 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos15.png" alt></p><p>同样方法，再次点击加号，添加根分区，挂载点选择/，大小输入可用空间容量即可（粉红按钮里显示的，比如输入16GB），点击添加挂载点。最后，再添加一个/boot分区，将添加的3个分区的设备类型都设置为标准分区 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos16.png" alt></p><p>点击左上角的完成按钮，会弹出一个页面，点击接收更改即可 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos17.png" alt></p><p>(5) . 配置网络和主机名 ，设置页面，点击网络和主机名</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos18.png" alt></p><p>由于我们的网络是NAT模式，它会通过DHCP自动获取IP，我们把网络开启，点击左上角完成 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos19.png" alt></p><p>返回设置页面后，点击右下角的开始安装即可 </p><p>(6) . 设置用户名和密码 。点击root密码，进行root用户的密码设置 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos20.png" alt></p><p>如果密码太简单会提示我们，并且需要点击二次完成。</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos21.png" alt></p><p>(7) . 密码设置完成后，等待安装 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos22.png" alt></p><p> 安装完成后，需要重启，然后会来到登录界面，输入刚刚填写的账号密码即可登录 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos23.png" alt></p><h3 id="5-联网设置"><a href="#5-联网设置" class="headerlink" title="5 . 联网设置"></a>5 . 联网设置</h3><p>由于安装的是CentOS7 Minimal版。当输入ifconfig时，会报错。是因为Minimal版没有ifconfig的组件，需要手动安装下面首先安装ifconfig，注意此时需设置为NAT模式连接，如设置成桥接模式，将无法联网，也就无法下载东西了。在终端输入yum search ifconfig，出现如下界面。</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos24.png" alt></p><p>这里得到包名为：net-tools.x86_64，然后通过 yum  install  net-tools.x86_64 命令下载包。这里只是举例，包名以通过上面的命令实际得到的包名为准。输入下载命令后界面如下</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos25.png" alt></p><p>安装过程中，默认输入y，回车。直到安装完成</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos26.png" alt></p><p>此时输入ifconfig便可查看本地ip了</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos27.png" alt></p><h3 id="6-使用CRT连接CentOS"><a href="#6-使用CRT连接CentOS" class="headerlink" title="6 . 使用CRT连接CentOS"></a>6 . 使用CRT连接CentOS</h3><p>SecureCRT是一款支持SSH（SSH1和SSH2）的终端仿真程序，简单地说是Windows下登录UNIX或Linux服务器主机的软件，类似的软件还有Xshell。当前是NAT模式联网，不方便使用CRT工具连接Centos，下面我们设置使用桥接模式，然后使用CRT连接Centos </p><p>(1)  首先查看物理机ip ，注意是物理机ip。可打开windows的终端查看，按win+R键，输入cmd打开终端然后输入ipconfig即可查看ip信息</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos28.png" alt></p><p>找到物理网卡对应的ip信息，其余是虚拟网卡，无需关心，其中ip地址，子网掩码，默认网关记下来 这是我们需要用的东西 </p><p>(2) . 然后进入物理机查看网卡使用情况 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos29.png" alt></p><p>一定是物理机的网卡，前面以V开头的都是虚拟网卡，无需关心。记住这个网卡名称 ，然后到VMware上面的导航栏中选择编辑 &gt; 虚拟网络编辑器 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos30.png" alt></p><p>点击更改设置，会出现如下界面</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos31.png" alt></p><p>选中VMnet0,桥接到  选中物理机上使用的网卡名称，点击确定。然后设置虚拟机的网络适配器，选中桥接模式</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos32.png" alt></p><p>(3) . 然后进入Centos，查询当前的mac地址，并记下mac地址 </p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos33.png" alt></p><p>然后进入/etc/sysconfig/network-scripts目录vi第一个文件</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos34.png" alt></p><p>首先修改两个属性BOOTPROTO=static，ONBOOT=yes</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos35.png" alt></p><p>然后添加一些属性，如图</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos36.png" alt></p><p>具体如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#设置我想用的静态ip地址，要和物理主机在同一网段，但又不能相同。</span>IPADDR=192.168.31.77　　<span class="token comment" spellcheck="true">#子网掩码，和物理主机一样就可以了。</span>NETMASK=255.255.255.0  <span class="token comment" spellcheck="true">#网关和物理主机一样</span>GETWAY=192.168.31.1   <span class="token comment" spellcheck="true">#DNS，写谷歌的地址就可以了。</span>DNS1=8.8.8.8　　　　　　<span class="token comment" spellcheck="true">#通过ifconfig查到的mac地址</span>HWADDR=00<span class="token punctuation">:</span>0c<span class="token punctuation">:</span>29<span class="token punctuation">:</span>22<span class="token punctuation">:</span>05<span class="token punctuation">:</span>4c</code></pre><p>然后通过命令 service network restart 重启网卡，然后在物理机上ping虚拟机ip</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos37.png" alt></p><p>这样物理机已经和Centos实现通信，然后打开CRT，输入Centos的ip</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos38.png" alt></p><p>输入Centos登录的账号密码</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos39.png" alt></p><p>点击确定，已经连上虚拟机</p><p><img src="/2018/08/04/vmware-zhong-an-zhuang-centos7/centos40.png" alt></p><p>这样我们在使用Centos系统时，可以直接使用CRT工具连接，强大方便。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实践 </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>长连接的负载均衡</title>
      <link href="/2018/07/28/chang-lian-jie-de-fu-zai-jun-heng/"/>
      <url>/2018/07/28/chang-lian-jie-de-fu-zai-jun-heng/</url>
      
        <content type="html"><![CDATA[<p>​    最近公司培训，讲到了有关于长连接的负载均衡解决方案，确有体会，故此记录一下。在之前做负载均衡一般针对的是短连接，短连接的场景在实际应用中非常普遍。浏览器中大部分的请求都是短连接，例如用户登录，注册。商城的订单，付款等功能都属于短连接。短连接的特点就是无状态，连接时间短，长则三四秒，短则几毫秒。短连接的负载均衡很容易解决，开源中间件也比较多,例如nginx，F5等。而长连接的负载均衡解决方案则比较少了，主要原因是长连接相对于短连接来说应用面比较窄。一般是定制化需求会使用长连接。而生活中长连接作为普遍的应用就是直播系统了，近几年直播这种娱乐方式也越来越受到年轻人的喜爱，虎牙，斗鱼等直播平台如雨后春笋般涌现。我所在的公司主要从事安防行业，其中最为普遍的业务是摄像头的录像，在城市中每个街头，小区，公交地铁上的摄像头都会接入到公安体系中，其中录像不但能实时播放而且还会保存到服务器中，方便公安人员破案时可以随时查看录像。由于摄像机是24小时录像的，所以在这种场景下摄像机是使用长连接，而且一旦摄像机和某个服务器节点建立连接，就会长期和这个服务器保持着连接。一个城市的摄像头成千上万，后台不但需要考虑并发，还要考虑负载均衡。传统的负载均衡算法如轮询，哈希，随机等算法并不适用于长连接的一些业务场景。这里长连接可比作一个持续进行的任务，那么长连接的负载均衡就是每个任务的资源调度，最终使每个节点上的资源，均匀的分布在这些任务上。</p><a id="more"></a> <h3 id="1-长连接的特点"><a href="#1-长连接的特点" class="headerlink" title="1.长连接的特点"></a>1.长连接的特点</h3><p>由于业务场景不同，长连接的特点也不一样。不同的业务场景会有各种各样的特点，需要做定制化需求的开发，这里例举的摄像机长连接特点：</p><p>1.每个长连接任务的时间长，短则几天，长则几个月。并且长期占用服务器的资源。<br>2.每个长连接任务消耗的资源不一样。以摄像机为例，不同规格的摄像机像素不一样。有标清，高清，超清之分。对应的就是流量带宽的区别，有2M，4M，8M之分。因此每个长连接任务占用的资源大小不一样的。<br>3.长连接任务启动时，初始化较慢，例如需要做认证，或是请求一些接口来获取数据。这样会导致做负载均衡时，并不能实时获取到节点的负载情况，出现几秒钟的延时。</p><p>在这些特点下如何做负载均衡呢？短连接的负载均衡算法轮询，哈希，随机，平均负载。如果这些算法能不能直接应用于长连接的业务场景，会出现哪些问题呢？我们先从最简单的特点开始，逐渐递进的去思考这个问题，从无到有的推导出一个针对这些特点的负载均衡算法。上面三个特点以下简称特点一，特点二，特点三。</p><h4 id="1，满足特点一，不考虑特点二，三。"><a href="#1，满足特点一，不考虑特点二，三。" class="headerlink" title="1，满足特点一，不考虑特点二，三。"></a>1，满足特点一，不考虑特点二，三。</h4><p>这种情景下长连接任务只是时间长，但每个长连接任务消耗资源大小一样，启动时无延时。这种场景是最为简单也是最理想的场景，在这种场景下轮询，哈希，随机算法都适用。因为每个任务大小一样，当任务数量够多时就能保证任务是平均分配到节点上的，从而保证了每个节点的负载基本一致，这些算法都能使服务器节点达到较为均匀的负载状态，这种情况根短连接的情况差不多，只是任务时间长一些。如下图</p><p><img src="/2018/07/28/chang-lian-jie-de-fu-zai-jun-heng/clj1.png" alt></p><h4 id="2，满足特点一，二，不考虑特点三"><a href="#2，满足特点一，二，不考虑特点三" class="headerlink" title="2，满足特点一，二，不考虑特点三"></a>2，满足特点一，二，不考虑特点三</h4><p>这种场景下任务启动时没有延时。但由于每个任务大小不一样轮询，哈希，随机就也就不再适应了。因为这几种算法适用于请求数量很大，任务大小差别不大的情况。也就是样本数足够大，样本基本一致才能保证这些样本均匀的分布在节点上。但也仅仅只是保证了每个节点上的样本数量均匀分布，倘若每个样本的所占用的资源不一样。那么这种均匀分配实际并不会使服务器的节点能够均匀的负载，达不到负载均衡的效果。那么这样的场景下，只平均负载的算法能够适用与这种场景。平均负载算法是在每次派发任务时，会收到节点反馈过来的负载情况，然后根据每个节点的负载情况，选择负载最小的节点派发任务。下面以图来说明这两种情况，如下图</p><p><img src="/2018/07/28/chang-lian-jie-de-fu-zai-jun-heng/clj2.png" alt></p><p>从图上可知，有任务a,b,c分别对应三个摄像机。任务a是2M流量，任务b是4M流量，任务c是8M流量，假设每个节点配置都一样，满载时为100。很明显如果使用轮询节点c的负载肯定会大，这样实际上集群负载并不均衡。但如果使用平均负载，那么负载均衡器在派发任务时会根据节点的负载情况去分发任务，这样最终效果肯定是要比轮询好的</p><h4 id="3，满足特点一，二，三"><a href="#3，满足特点一，二，三" class="headerlink" title="3，满足特点一，二，三"></a>3，满足特点一，二，三</h4><p>其实在前面两个特点下，我们忽略了一个重要问题。就是可信度问题，也就是特点三带来的问题。在分布式环境中，节点之间通信是不可靠。如果由于网络波动，或是业务场景导致负载均衡器在得到节点反馈过来的负载信息时，这个负载信息可能是存在几秒钟的延时。实际上得到的并不是当前的实时负载情况，而是几秒钟之前的负载情况。如下图：</p><p><img src="/2018/07/28/chang-lian-jie-de-fu-zai-jun-heng/clj3.png" alt></p><p>这样会存在一个极大的隐患。假设有1000个请求过来了。根据平均负载的算法得到节点a的负载最低。那么请求理应分发到节点a上，但是由于反馈过来的负载信息是存在延时的，于是在两三秒内得到的结果都是节点a负载最低，那么这1000个请求可能会全部被分发到节点a上。这种现象被称为扎堆效应。这种情况的结果就是节点a扛不住压力宕机。那么由此可见平均负载算法也不适用了。</p><h3 id="2-平均负载算法的改进-一"><a href="#2-平均负载算法的改进-一" class="headerlink" title="2.平均负载算法的改进(一)"></a>2.平均负载算法的改进(一)</h3><p>从上面几种场景可以看出，平均负载算法还是适用性是非常强的，而在第三种场景下如果能得到一个可信度较高的节点当前负载情况，那么就可以继续沿用平均负载算法。那么该如何得到可信的节点负载呢，由前面的分析可知得到的节点负载之所以不可信是因为存在延时，那么我们可以记录节点前三秒，或者是前五秒的每秒节点负载，在<br>把这些节点负载取平均值作为节点的当前负载。公式如下<br>$$<br>m=(m4+m3+m2+m1+m0)/5<br>$$<br>m表示当前负载 ，m4,m3,m2,m1,m0分别表示4,3,2,1,0秒前的负载，对于存在延时的系统，这样做法就能在一定程度上得到较为可靠节点的负载情况。但仍然不够准确，在实际生产环境中仍然会出现不均衡的情况，究其原因是因为对前5秒的数据取平均，但实际上，这样计算是不合理的，难道5秒以前的数据和1秒以前的数据对当前结果的影响还是一样的吗？显然不是，应该认为越靠近当前时间的负载值可信度就越高，越远离当前时间的负载值可信度就越低。这样才会越接近于实际。所以上面的公式应该是这样的<br>$$<br>m= 0.36<em>m0+0.28</em>m1+0.20<em>m2+0.12</em>m3+0.04*m4<br>$$<br>其中m0离当前时间最近，认为m0的可信度最高，所以给了36%的权重，而m4离当前时间最远，可信度最低，所以给了4%的权重。当然这里的权重应根据实际情况或经验设置值，根据这个公式算出的当前节点的负载值更能反应出节点的真实负载情况</p><h3 id="3-平均负载算法的改进-二"><a href="#3-平均负载算法的改进-二" class="headerlink" title="3.平均负载算法的改进(二)"></a>3.平均负载算法的改进(二)</h3><p>上面两个公式是在得到几秒内的负载值然后计算出加权平均值确能在一定程度上反应节点的负载情况，但是这个种方法需要多次记录节点的负载信息，还比较麻烦。那有没有更好的方法呢，答案是有的，其实只需记录上一秒的节点负载情况，然后再获取当前节点负载，在这段时间段内对节点内，节点负载对时间取积分即可。这个方法是根据自动控制原理中的PID算法得到的那么上面节点负载的计算公式可得如下<br>$$<br>m=m0+\frac{\int_0^t{(m0-m1)*t},{\rm d}t}{D}<br>$$<br>公式中m表示计算得到的负载值，m0表示当前获取到的节点负载，m1表示上一秒获取到的节点负载，参数D是可信度系数，表示上一秒的节点负载值对当前负载值的影响程度，越大表示影响越小，这个值可根据实际情况设置。这样既只需要维护上一秒的节点负载值，减小了成本，又能得到相对准确的当前节点负载值。</p><h3 id="4-负载均衡健康状态"><a href="#4-负载均衡健康状态" class="headerlink" title="4.负载均衡健康状态"></a>4.负载均衡健康状态</h3><p>负载均衡的健康状态如何定义呢？如果任务均匀的分布在各个节点上，就称集群的负载均衡状态是健康的，否则就是亚健康或者说是不健康的。在前面，我们衡量集群各个节点的负载情况时，总是以节点已经负载的量去评定的，例如集群有3个节点，每个节点的满载量为100，当前每个节点放负载为40，那么就可以认为集群达到了比较均匀的负载均衡状态。但这是理想状态，实际生活中，集群的节点配置是不可能完全相同的，有些节点可能是后加入的那配置可能会高一些，有些节点是之前用了好几年的，为了节省成本继续利用起来配置自然会点一些，所以集群各个节点是完全不一样的。如下图所示a,b,c三个节点，a节点放满载量为60，b节点的满载量为140，c节点的满载量为100，这样如继续以节点已负载的量去衡量的话，假设当前每个节点放负载仍为40，就会得到如下的情况</p><table><thead><tr><th>节点</th><th>节点a</th><th>节点b</th><th>节点c</th></tr></thead><tbody><tr><td>负载状态</td><td>40/60</td><td>40/140</td><td>40/100</td></tr></tbody></table><p>这样明显可以看出节点b还有很大的富余，因此通过节点当前的负载量，去判断集群的负载均衡状态是不科学的，这里可以换一种思路，以每个节点的剩余量作为衡量标准，这样上面那个例子中，节点a的富余是20，节点b的富余是100，节点c的富余是60，这样得到的就是如下的情况</p><table><thead><tr><th>节点</th><th>节点a</th><th>节点b</th><th>节点c</th></tr></thead><tbody><tr><td>富余量</td><td>20</td><td>100</td><td>60</td></tr></tbody></table><p>在负载均衡服务器派发任务时，不再是以节点负载最小的节点作为派发对象，而是以节点富余最大的节点作为派发对象，这样就能使节点的负载尽可能的均衡。这里衍生出一个公式可计算集群负载均衡的状态，首先计算出集群各个节点的负载富余的平均值<br>$$<br>n=\frac{(n0+n1+n2)}3<br>$$<br>然后求方差<br>$$<br>y=(n0-n)^2+(n1-n)^2+(n2-n)^2<br>$$<br>这样计算得到的方差结果，如果结果越小则说明集群负载越均衡，状态越健康，越大则说明越不均衡，集群的负载均衡处于一个相对不健康的状态</p>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大数据生态圈</title>
      <link href="/2018/07/15/da-shu-ju-sheng-tai-quan/"/>
      <url>/2018/07/15/da-shu-ju-sheng-tai-quan/</url>
      
        <content type="html"><![CDATA[<p>现今的社会是一个高速发展的社会，科技发达，信息流通，人们之间的交流越来越密切，生活也越来越方便，大数据就是这个高科技时代的产物。创办人马云来台演讲中就提到，未来的时代将不是IT时代，而是DT的时代，DT就是Data Technology数据科技，显示大数据对于阿里巴巴集团来说举足轻重。 有人把数据比喻为蕴藏能量的煤矿。煤炭按照性质有焦煤、无烟煤、肥煤、贫煤等分类，而露天煤矿、深山煤矿的挖掘成本又不一样。与此类似，大数据并不在“大”，而在于“有用”。价值含量、挖掘成本比数量更为重要。对于很多行业而言，如何利用这些大规模数据是赢得竞争的关键。 大数据包括结构化、半结构化和非结构化数据，非结构化数据越来越成为数据的主要部分。 其主要来源是人们多样化的社交方式，由于生活水平的提高，人们也越来越在乎精神层面的享受。例如抖音短视频，QQ微信的视频通话。语音通话，网易云音乐，各色各样的直播平台，这些终端产生的用户数据大都是非结构化数据。在这些数据中蕴含着巨大的财富，现在的中国有10多亿人口，超一半的网民。这样巨大的市场，可以说是得用户者得天下。很多APP都会有推荐功能，这其实就是大数据的一个应用场景，由于用户的历史数据就代表着用户的喜好习惯行为。所以如果获得用户的数据，并通过大数据的分析就可以把APP打造出一款很懂用户的APP，牢牢的抓住用户的心，从而抓住整个市场。</p><p>大数据本身是个很宽泛的概念，就数据而言，大数据是指数据量已经大到单机处理不了的尺度。大数据一般是指处理PB级别以上的数据。PB是个什么概念的单位呢？1 TB= 1,024 GB ；1 PB = 1,024 TB ；1 EB = 1,024 PB  由这个单位换算可以看出PB级的数据是很大的，对个人而言，数据量基本就在GB级别。处理这些海量数据当然也不能使用传统的手段。在大数据领域，有一系列组件专门用来处理大数据，例如Spark，Hadoop等。下面就来认识一下大数据组件的生态圈吧</p><a id="more"></a> <h3 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h3><p>Hadoop的开源子项目，是一个分布式的文件存储系统，基于流数据模式访问和处理超大文件的需求而开发的，可以运行于廉价的商用服务器上。它所具有的高容错、高可靠、高可扩展性、高吞吐率等特征，能够在集群出现名字节点故障，数据节点故障和节点网络断开等故障的情况下也能可靠地存储数据，为超大数据集（Large Data Set）的应用处理带来了很多便利。通俗的讲，它就充当着windows上的资源管理器角色，管理着硬盘上的所有资源。只不过在分布式系统中，hdfs管理的是所有节点上的硬盘文件资源。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/hdfs.png" alt></p><h3 id="Hbase"><a href="#Hbase" class="headerlink" title="Hbase"></a>Hbase</h3><p>是一个高可靠性、高性能、面向列、可伸缩的数据库，依赖HDFS，底层数据最终是存储在HDFS上。利用HBase技术可在廉价商用服务器上搭建起大规模结构化存储集群。HBase是面向列的数据库，列式存储，其数据在表中是按照某列存储的，这样在查询只需要少数几个字段的时候，能大大减少读取的数据量。提供权限控制，支持独立检索，和多种过滤器。HBase单表可以有上百亿行、百万列，数据矩阵横向和纵向两个维度所支持的数据量级都非常具有弹性。类比于windows系统的话，Hbase相当于windows上的数据库，例如Mysql，不同之处在于HBase是分布式的，它提供的是所有节点上的数据查询服务，还有一点不同之处是Hbase是Nosql。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/hbase.png" alt></p><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><p>它是一个分布式多用户能力的全文搜索引擎。Elasticsearch使用Lucene作为内部引擎，但是，你没法直接用Lucene，必须自己写代码去调用它的接口。而ElasticSearch提供了 REST API 的操作接口，开箱即用。这使得Elasticsearch的上手非常简单。而且它附带了很多非常合理的默认值，这让初学者很好地避免一上手就要面对复杂的理论。能够实现近实时（NRT）搜索，稳定、可靠、安装方便。性能不错、可以水平扩展、文档也相当齐全。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/elasticSearch.jpeg" alt></p><h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><p>Kafka是一种高吞吐量的分布式发布订阅消息系统，最初由Linkedin公司开发，后捐献给Apache软件基金会并成为了Apache的等级项目。它由Scala和Java编写。高吞吐，低延时和高可扩展性的特点使得它成为市场上主流的消息队列中间件，它的最大的特性就是可以实时的处理大量数据以满足各种需求场景：比如基于hadoop的批处理系统、低延迟的实时系统、storm/Spark流式处理引擎、访问日志，消息服务等等</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/kafka.jpg" alt></p><h3 id="Flume"><a href="#Flume" class="headerlink" title="Flume"></a>Flume</h3><p>Flume是由Cloudera软件公司提供的一个分布式，可靠地，用户高效收集，聚合，移动大量数据的可用系统服务，后与2009年被捐赠了apache软件基金会，成为hadoop相关组件之一。它有着基于流动数据技术的简单灵活架构。具有健壮性和容错性，使用可调节的可靠机制以及多种容灾和恢复机制。使用可扩展数据模型，运行在线分析应用。</p><h3 id="Sqoop"><a href="#Sqoop" class="headerlink" title="Sqoop"></a>Sqoop</h3><p>是一个用来将Hadoop和关系型数据库中的数据相互转移的工具，主要用于在Hadoop(Hive)与传统的数据库间进行数据的传递。可以将一个关系型数据库（例如 ： MySQL ,Oracle ,Postgres等）中的数据导进到Hadoop的HDFS中，也可以将HDFS的数据导进到关系型数据库中。Sqoop专为大数据批量传输设计，能够分割数据集并创建Hadoop任务来处理每个区块。</p><h3 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h3><p>是建立在 Hadoop 上的数据仓库基础构架。它提供了一系列的工具，可以用来进行数据提取转化加载（ETL），这是一种可以存储、查询和分析存储在 Hadoop 中的大规模数据的机制。可以将结构化的数据文件映射为一张数据库表，并提供简单的sql查询功能，可以将sql语句转换为MapReduce任务进行运行。也正因如此，Hive在执行SQL时会有较高的延时，不适合那些需要低延迟的应用。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/hive.png" alt></p><h3 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h3><p>是一种编程模型，用于大规模数据集（大于1TB）的并行运算。概念”Map（映射）”和”Reduce（归约）”，是它们的主要思想，都是从函数式编程语言里借来的，还有从矢量编程语言里借来的特性。MapReduce将复杂的、运行于大规模集群上的并行计算过程高度地抽象到了两个函数：Map和Reduce，降低了开发人员分布式编程的学习成本，不需要掌握分布式并行编程细节，也可以很容易把自己的程序运行在分布式系统上，完成海量数据的计算。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/mapreduce.jpg" alt></p><h3 id="Spark"><a href="#Spark" class="headerlink" title="Spark"></a>Spark</h3><p>Spark是一个围绕速度、易用性和复杂分析构建的大数据处理框架。Spark是UC是专为大规模数据处理而设计的快速通用的计算引擎。Spark是UC Berkeley AMP lab (加州大学伯克利分校的AMP实验室)所开源的类似于Hadoop MapReduce的通用并行框架，并于2010年成为Apache的开源项目之一。Spark，拥有Hadoop MapReduce所具有的优点；但不同于MapReduce的是——Job中间输出结果可以保存在内存中，从而不再需要读写HDFS。由于这种特性Spark衍生出自己的生态圈，下面介绍一下Spark的生态圈</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/spark.jpg" alt></p><h3 id="Spark-Core"><a href="#Spark-Core" class="headerlink" title="Spark Core"></a>Spark Core</h3><p>Spark最基础与最核心的功能；尤其是定义RDD的API、操作以及这两者上的动作。其他Spark的库都是构建在RDD和Spark Core之上的</p><h3 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h3><p>提供通过Apache Hive的SQL变体Hive查询语言（HiveQL）与Spark进行交互的API。每个数据库表被当做一个RDD，Spark SQL查询被转换为Spark操作。实际上就是底层执行引擎的改变。之前Hive的执行引擎是MapReduce，而Spark SQL则使用Spark作为SQL的执行引擎。</p><h3 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h3><p>对实时数据流进行处理和控制。Spark Streaming允许程序能够像普通RDD一样处理实时数据。实际上Spark Streaming并不是真正意义上的实时处理，而是微批处理。所谓微批处理，就是短时间内的批处理。但只要这个时间短到我们可以接受的范围，就可以认为是实时处理。因此Spark Streaming有一个重要的参数就是batchTime。这个参数是用来设置批处理的时间间隔。一般对于实时性不是特别高的场景，这个参数会设置为30秒左右</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/sprakstreaming.png" alt></p><h3 id="Spark-MLlib"><a href="#Spark-MLlib" class="headerlink" title="Spark MLlib"></a>Spark MLlib</h3><p>一个常用机器学习算法库，算法被实现为对RDD的Spark操作。这个库包含可扩展的学习算法，机器学习是一门设计概率论、统计学、逼近论、凸分析、算法复杂度理论等多领域的交叉学科。MLlib目前已经提供了基础统计、分析、回归、决策树、随机森林、朴素贝叶斯、保序回归、协同过滤等需要对大量数据集进行迭代的操作。</p><h3 id="Spark-GraphX"><a href="#Spark-GraphX" class="headerlink" title="Spark GraphX"></a>Spark GraphX</h3><p>Spark提供的分布式图计算框架。控制图、并行图操作和计算的一组算法和工具的集合。GraphX主要遵循整体同步并行（bulk Synchronous parallel，BSP）计算模式下的Pregel模型实现。GraphX扩展了RDD API，包含控制图、创建子图、访问路径上所有顶点的操作。封装了最短路径，网页排名，连接组件，三角关系统计等算法的实现，用户可以选择使用。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/graphx.png" alt></p><h3 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h3><p>是一个分布式的资源管理系统，用以提高分布式的集群环境下的资源利用率，这些资源包括内存、IO、网络、磁盘等。其产生的原因是最初为了解决原MapReduce框架的不足。如今已发展成一个通用资源管理系统，可为上层应用提供统一的资源管理和调度，它的引入为集群在利用率、资源统一管理和数据共享等方面带来了巨大好处。</p><h3 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h3><p>是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，可以提供配置信息管理、命名、分布式同步、集群管理、数据库切换等服务。它不适合用来存储大量信息，可以用来存储一些配置、发布与订阅等少量信息。</p><h3 id="Oozie"><a href="#Oozie" class="headerlink" title="Oozie"></a>Oozie</h3><p>是一个工作流引擎服务器，用于运行hadoop map/reduce和hive等任务工作流。以action为基本单位，可以将多个action构成一个DAG图的模式运行。其实本质上它的底层原理是通过将xml语言转换成mapreduce程序来做，但只是在集中map端做处理，避免shuffle的过程。</p><h3 id="Mesos"><a href="#Mesos" class="headerlink" title="Mesos"></a>Mesos</h3><p>负责集群资源的分配， Mesos能够管理每台机器的CPU、内存、存储以及其它计算资源由设备（物理或虚拟）中抽象出来，形成一个池的逻辑概念，让你像操纵单个资源池一样来操纵整个数据中心。 Mesos 是一个集群管理器，提供了有效的、跨分布式应用或框架的资源隔离和共享，在Mesos上可以运行Spark， Storm， Hadoop等大数据组件</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/mesos.png" alt></p><h3 id="Ambari"><a href="#Ambari" class="headerlink" title="Ambari"></a>Ambari</h3><p>Ambari是Hortonworks开源的Hadoop平台的管理软件，具备Hadoop组件的安装、管理、运维等基本功能，提供Web UI进行可视化的集群管理，简化了大数据平台的安装、使用难度。Ambari已支持大多数Hadoop组件，包括HDFS、MapReduce、Hive、Pig、 Hbase、Zookeeper、Sqoop和Hcatalog等。Apache Ambari 支持HDFS、MapReduce、Hive、Pig、Hbase、Zookeepr、Sqoop和Hcatalog等的集中管理。也是5个顶级hadoop管理工具之一。</p><p><img src="/2018/07/15/da-shu-ju-sheng-tai-quan/ambari.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>paxos算法</title>
      <link href="/2018/07/14/paxos-suan-fa/"/>
      <url>/2018/07/14/paxos-suan-fa/</url>
      
        <content type="html"><![CDATA[<p>Paxos算法是莱斯利·兰伯特（Leslie Lamport，就是 LaTeX 中的”La”，此人现在在微软研究院）于1990年提出的一种基于消息传递且具有高度容错特性的一致性算法。 Paxos算法应用非常广泛，目前在Google的Chubby、MegaStore、Spanner等系统中得到了应用，Hadoop中的ZooKeeper中实现数据的一致性也是基于Paxos算法。根据 CAP 理论，一个分布式集群中网络分区必然会出现，这样就会出现脑裂的情况，所谓脑裂，就是由于网络分区的出现，一个集群被分割为多个互不通信的小集群，小集群中由于没有Leader，会自主选择master节点，造成原本的集群会同时存在多个master节点。 而 paxos 算法有效的杜绝了脑裂现象，并在 C 和 A 之间保留了较好的均衡性。因此paxos算法的重要性不言而喻了，但Paxos 算法号称史上最晦涩难懂的算法，而原版论文也是让人难以理解 。经过一段时间学习，对 Paxos 有了一些理解，在这里总结一下。paxos算法的学习最好的资料就是作者发表的三篇论文，分别是Fast Paxos，Paxos made simple和The Part-Time Parliament。另外还有一个被称为有史以来学习paxos最好的地方的英文网站，百度网盘地址如下：</p><p>Fast Paxos：链接: <a href="https://pan.baidu.com/s/1Eaxpvh5AqUNyxySPAOrwYQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1Eaxpvh5AqUNyxySPAOrwYQ</a> 密码: ij5v</p><p>Paxos made simple：链接: <a href="https://pan.baidu.com/s/1rBjQ4rXnBWO1hXdOllGguw" target="_blank" rel="noopener">https://pan.baidu.com/s/1rBjQ4rXnBWO1hXdOllGguw</a> 密码: k7fj</p><p>The Part-Time Parliament：链接: <a href="https://pan.baidu.com/s/18SZs710g_VAPoM1wbijHnQ" target="_blank" rel="noopener">https://pan.baidu.com/s/18SZs710g_VAPoM1wbijHnQ</a> 密码: ww4w</p><p>英文学习网址：<a href="http://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Paxos_%28computer_science%29">Paxos (computer science)</a> </p><p><img src="/2018/07/14/paxos-suan-fa/paxos.jpg" alt></p><a id="more"></a> <h3 id="1-Paxos算法"><a href="#1-Paxos算法" class="headerlink" title="1 . Paxos算法"></a>1 . Paxos算法</h3><h4 id="1-1-Paxos算法的角色"><a href="#1-1-Paxos算法的角色" class="headerlink" title="1.1 Paxos算法的角色"></a>1.1 Paxos算法的角色</h4><p><strong>Client</strong>：客户端，发起请求并等待返回。 </p><p><strong>Proposer</strong>:提案发起者，处理客户端请求，将客户端的请求发送给Acceptor，并接收Acceptor返回的信息</p><p><strong>Acceptor</strong>:提案决策者，负责处理接收到的提案，决策提议通过还是拒绝，并把信息返回给Proposer</p><p><strong>Learner</strong>：当有同一个提案的值被超过一半的Acceptor采纳并发送消息给Learner时，Learner学习该提案值。 </p><p>其实最核心的角色就两个，分别是Proposer 和 acceptor。</p><h4 id="2-2-Paxos算法流程"><a href="#2-2-Paxos算法流程" class="headerlink" title="2.2 Paxos算法流程"></a>2.2 Paxos算法流程</h4><p>简单来说Paxos 是一个经典的两阶段提交（2PC）</p><h5 id="2-2-1、第一阶段-Prepare"><a href="#2-2-1、第一阶段-Prepare" class="headerlink" title="2.2.1、第一阶段 Prepare"></a>2.2.1、第一阶段 Prepare</h5><p>Proposer 发送提案，发送提前前需生成生成全局唯一且递增的提案 ID（Proposalid，以高位时间戳 + 低位机器 IP 可以保证唯一性和递增性），向 Paxos 集群的所有机器发送 PrepareRequest请求，这里无需携带提案内容，只携带 Proposalid 即可。Acceptor在接收到Proposer发来的提案后需要做几件事情，总结来说就是：两个承诺，一个应答 。</p><p>两个承诺：</p><ul><li>第一，不再应答 Proposalid 小于当前请求的 PrepareRequest。</li><li>第二，不再应答 Proposalid 小于当前请求的 AcceptRequest 。</li></ul><p>一个应答：</p><ul><li>返回自己已经采纳的提案中 Proposalid 最大的那个提案的内容，如果没有则返回空值;。</li></ul><h5 id="2-2-2、第二阶段-Accept"><a href="#2-2-2、第二阶段-Accept" class="headerlink" title="2.2.2、第二阶段 Accept"></a>2.2.2、第二阶段 Accept</h5><p>经过第一阶段，Proposer会收到Acceptor的应答。这时Proposer也需要做几件事情。总结来说就是：三个判断，一个请求。注意只有应答数过半才会发送AcceptRequest 请求。</p><p>两个判断：</p><ul><li>第一，判断收到的Acceptor的应答数量超过总数的一半，如果没有超过一半则直接进入第一阶段的流程，继续发送提案。如果超过一半，则进入第二个判断。</li><li>第二，判断所有返回Acceptor的应答中是否存在已经采纳的提案，如果不存在则自己决定提案值，如果存在提案值则进入第三个判断。</li><li>第三，判断应答的所有提案中，是否存在数量超过一半的提案，如果存在则选中这个过半数的提案值，如果不存在则在所有Acceptor的应答中选中Proposalid最大的提案值。</li></ul><p>一个请求：</p><ul><li>发送AcceptRequest 请求，将决定的提案值发送给Acceptor，然后会得到Acceptor的应答，根据应答数量再走第二阶段的流程。</li></ul><p>Learner学习被选定的Value值（也就是提案值）。假设集群中有M个Acceptor，N个Learner，那么Learner学习的策略有三种方案：</p><ul><li>Acceptor接受一个提案，就将该提案发送给所有Learner。优点是Learner能快速获取被选定的Value值，缺点是通信次数为：M*N</li><li>Acceptor接受一个提案，就将该提案发送给主Learner，主Learner再发送给其他的Learner。优点是通信次数只有：M+N，缺点是主Learner会出现单点故障，而且主Learner怎么选举来的也是个问题。</li><li>Acceptor接受一个提案，就将提案发送给多个Learner，也就是一个Learner集合。再由这个Learner集合发送给剩下的Learner。优点是综合了方案一和方案二，减少了通信次数的同时提高了可靠性。缺点是网络通信更复杂。</li></ul><p>可以看出Paxos的关键所在是Proposer的决策，在收到Acceptor的应答后，会选出应答中最新的决策，然后服从该决策，后者认同前者，最后Acceptor接受的同一个提议的数量会越来越多，最终超过一半，达成一致，否则整个决策过程永无止境 。在分布式系统中，上面提到的几种角色并不需要在不同节点上，实际上一个节点既可以是Proposer，也可以是Acceptor只是各自对应的端口不一样就行了，zookeeper就是这样做的。上面两个阶段是分开描述的，可能不便于理解整个连贯的流程。下面以生活中的实际场景来模拟一下paxos算法的流程。</p><h3 id="2-通俗理解"><a href="#2-通俗理解" class="headerlink" title="2 . 通俗理解"></a>2 . 通俗理解</h3><p>相信大家都参与过班级中竞选班长的场景。班长竞选流程一般是首先竞选者上台演讲，演讲结束后，大家同意投票，比如没人写个小纸条，在纸条上，我想选谁当班长就写他的名字。最后由老师或是一个同学数纸条上的名字数最多的人当选班长。这种方式其实就是数据共享的方式，因为所有人的小纸条都聚集在了一起，最后只要数这些小纸条就行了。但Paxos算法不是这种场景 ，Paxos算法的场景对应一种分布式场景。假设这个班级有20个人要竞选一名班长，而这20个同学不在教室，而各自在家且这20个同学相互不能通信如何完成班长的选举。为了完成班长的选举，他们请来了隔壁班的5位同学，且这5位同学也不能相互通信。但20位同学中的每个人都可以自由的和隔壁班的这5位同学通信，现假设他们通信的方式为短信，隔壁班的5位同学称他们为队长，20位同学为队员。下面宣布选举开始！</p><p>首先队员的第一件事就是与至少3个队长取得联系（超过队长人数的一半，为什么要超过人数的一半，后面我会解释），于是队员们开始疯狂的给5位队长发短信，队员发送信息时，会把当前的信息的发送时间一起发过去，这个时候队员仅仅只是为了与队长取得联系，并不会把班长竞选人的名单发送过去。队长会收到来自20名队员的短信，面对大量的短信，队长的做法是倾听最新的声音，于是队长只回复信息中发送时间最新的队员。这里队长如果接受过队员的班长人选提议，就会把那个提议回复给这个队员，如果没有接受过提议，就会回复队员：“我还没有班长人选的名字，快告诉我你要选谁当班长”。这时队员a在接收到队长的回复后，并不会马上就把自己的班长人选发送给队长。队员a首先会判断我收到的队长回复人数有没有超过一半，如果没有那我就继续发申请，联系队长。如果超过了一半就看看班长回复的信息中，是不是已经有一些班长人选的名单了，如果没有，那么队员a想选赵六当班长，就会把赵六发送给所有队长。如果有了那么队员a会服从队长的班长人选，队员会归纳队长返回的信息，可能会出现下面两种情况，第一种情况：</p><p>队长a的信息：班长人选名字是张三，时间是6分钟前；</p><p>队长b的信息：班长人选名字是张三，时间是4分钟前；</p><p>队长c的信息：班长人选名字是张三，时间是3分钟前；</p><p>队长d的信息：班长人选名字是李四，时间是1分钟前；</p><p>队长e的信息：没有班长人选，时间是1分钟前；</p><p>如果出现了这种情况，那就别扯了，说明整个决定过程已经达成一致了，张三已经当选班长，队员a也选张三做班长。这里还会出现第二种情况，就是决定过程还没有达成一致，收到的信息如下：</p><p>队长a的信息：班长人选名字是李四，时间是3分钟前；</p><p>队长b的信息：班长人选名字是李三，时间是5分钟前；</p><p>队长c的信息：没有班长人选，时间是1分钟前；</p><p>没有收到队长d和队长e的信息</p><p>这时队员a就会选择队长a的班长人选名字，即李四，并把这个名字发送给所有队长，告诉他们李四就是我想要选的班长。</p><p>从这面的逻辑可以看出，一旦某个时刻有半数以上队长同意了一个班长人选比如张三，紧跟着后面的队员b继续发短信时，如果和队长们获得联系，说明队员b收到了来自半数以上队长发过来的消息，那么队员b必然会收到至少一个队长给他发的张三的这个结果，于是队员b也会顶这个最新的班长人选，不会更改。其他队员也是一样，因为最终都会与队长取得联系，而此时队长最新的人选是张三，于是会有越来越多的人支持张三，最终达成一致，张三当选班长。这里就是paxos算法的根基，因为每个队员必须受到半数以上的回复才能参与班长人选的提议，虽然每个队员受到回复的队长可能不一样，但是因为超过半数，所以他们必然有一个交集，两个交集必然有一个共同的提议。因此最终肯定能达成一致。光这样说有些难以理解，来举个栗子，看下图：</p><p><img src="/2018/07/14/paxos-suan-fa/paxos1.png" alt></p><p>如果队员不需要受到过半的回复就可以进入第二阶段参与班长人选的提议，如上图中，队员a收到两位队长的回复分别是队长a的班长人选12点01分的张三，队长b的12点03分的李四，队员b收到三位队长的回复分别是12点10分的王五，12点07分的赵六，12点05分的孙七。那么根据前面的逻辑，队员a会选李四当班长，队员b会选王五当班长，然后再把信息发给队长们。由于两个队员收到的回复没有交集，因此他们两个的班长人选名字永远都不可能相同，队长们的信息永远是不一致的，所以永远都不可能有班长人选的名字超过半数。这样会导致选举过程永无止境，陷入死循环。而如果队员必须收到半数以上的回复才能参与提议，情况会变成什么样的呢？，看下图：</p><p><img src="/2018/07/14/paxos-suan-fa/paxos2.png" alt></p><p>这个图中两名队员都收到了过半的队长回复，由图可以很明显的看出，队员a和队员收到的回复中是存在交集的，根据前面的逻辑队员a会选王五当班长，队员b会选王五当班长。队员们会把自己选择的班长人选名单发送给队长们，于是在所有队长那里王五都成了最新的班长人选，所以队长都会接受。在接下来其他队员与队长们取得联系后返回的班长人选中必然包含王五，这样支持王五的人会越来越多，最终达成一致。</p><p>有人可能会疑问，虽然只是举个例子，但这里为什么只考虑队员a和队员b的情况，万一其他队员得到的信息能使选举最终达成一致呢？这里下意识的用了万一这个词，仔细想想这个词又不得不用，因为刚刚这个例子就出现导致队长们无法使选举达成一致的情况，那谁又能保证其他队员收到的信息能使队长们最终达成一致呢。我们要的结果是队长们最终肯定能达成一致，而不是万一能达成一致。因此，队员们必须受到半数以上的回复才能并参与提议，才能实现最终的一致性。用数学上的说法就是，只有保证了这个约束条件才保证了paxos算法是一个收敛函数。把例子和理论对应一下，在竞选班长的例子中的队长就相当于paxos算法种的Acceptor，而队员就相当于Proposer和Learner。在选举过程中，队员既会提交选举的提案，也会根据队长返回的信息来学习被选中的人选。</p><p>在分布式系统中，一致性的问题一直是个拦路虎。Paxos解决这一问题利用的是选举，少数服从多数的思想，只要2N+1个节点中，有N个（不包含N）以上同意了某个决定，则认为系统达到了一致，并且按照Paxos原则，最终理论上也达到了一致，不会再改变。这样的话，客户端不必与所有服务器通信，选择与大部分通信即可；也无需服务器都全部处于工作状态，有一些服务器挂掉，只有保证半数以上存活着，整个过程也能持续下去，容错性相当好。因此，说ZooKeeper 要部署奇数个节点也是有道理的。另外谈到Paxos时，还会涉及到拜占庭将军问题，拜占庭将军问题指的是在存在消息丢失的不可靠信道上试图通过消息传递的方式达到一致性是不可能的。注意拜占庭将军问题中描述的不可靠信道是指信息可能会丢失，也可能会被篡改。Paxos本身就是利用消息传递方式解决一致性问题的，所以它的假定是信道必须可靠，这里的可靠，主要指信息可以丢失，但不会被篡改。</p>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式系统 </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客个性化配置</title>
      <link href="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/"/>
      <url>/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/</url>
      
        <content type="html"><![CDATA[<p>博客搭建好后，总会有一些个性化的想法。比如做网站的访问量统计，文章评论系统，文章分享功能，或是在博客主页放一个音乐播放器，让别人进来浏览博客的同时，还伴随着动听的音乐。大部分博客主题都兼容这些功能，只不过需要自己去配置。下面是我做个性化博客配置时踩的坑，供大家参考参考。</p><h3 id="1-访问量统计"><a href="#1-访问量统计" class="headerlink" title="1 . 访问量统计"></a>1 . 访问量统计</h3><p>访问量统计功能可以用<strong>百度的站长统计</strong>、<strong>leancloud</strong>，还有<strong>不蒜子</strong>，这里我用的不蒜子，主要原因是它很简单易用，不需要注册账号什么的。不蒜子官网：<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener">http://busuanzi.ibruce.info/</a></p><h4 id="1-引入不蒜子"><a href="#1-引入不蒜子" class="headerlink" title="(1) . 引入不蒜子"></a>(1) . 引入不蒜子</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>这段代码可以写在footer.ejs里或者header.ejs里或者layout.ejs里，因为是 js 文件，所有推荐放在 html 文档的末尾处加载。这里我放在/themes/yilia/layout/_partial/footer.ejs中。</p><h4 id="2-添加站点访问量"><a href="#2-添加站点访问量" class="headerlink" title="(2) . 添加站点访问量"></a>(2) . 添加站点访问量</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>busuanzi_container_site_uv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   本站访客数<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>busuanzi_value_site_uv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>人次<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span></code></pre><a id="more"></a> <p>这段代码是用来显示访客数的，可根据个人喜好放在合适的位置即可。我放在了footer.ejs 中。运行的效果如下图</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/fangke.png" alt></p><p>计算访问量的方法有两种，我用的是uv的方式，大家自行选择即可。</p><p>算法a：pv的方式，单个用户连续点击n篇文章，记录n次访问量。 </p><p>算法b：uv的方式，单个用户连续点击n篇文章，只记录1次访客数。 </p><h4 id="4-添加文章访问量"><a href="#4-添加文章访问量" class="headerlink" title="(4) . 添加文章访问量"></a>(4) . 添加文章访问量</h4><p>文章的访问量显示在文章里面，所以在article.ejs里加上文章访问量的标签： </p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>busuanzi_container_page_pv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   阅读量：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>busuanzi_value_page_pv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span></code></pre><p>这里加个判断，如果是首页不显示该文章的访问量，下面这段代码添加在/themes/yilia/layout/_partial/article.ejs的header的日期后面： </p><pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>index <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>        <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"archive-article-date"</span><span class="token operator">></span>            阅读量 <span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">"busuanzi_value_page_pv"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span></code></pre><h3 id="2-文章分享功能"><a href="#2-文章分享功能" class="headerlink" title="2 . 文章分享功能"></a>2 . 文章分享功能</h3><p>yilia主题中已经集成了文章的分享插件，直接配置即可。但是在使用微信分享的时候发现那个二维码图片出不来。报参数错误，于是换了一个接口。下面分享四个非常方便的微信分享功能的二维码生成连接</p><pre class=" language-javascript"><code class="language-javascript">说明：把url<span class="token operator">=</span>或data<span class="token operator">=</span>后面的网址改成你的，四种任选一。http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>pan<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>share<span class="token operator">/</span>qrcode<span class="token operator">?</span>w<span class="token operator">=</span><span class="token number">150</span><span class="token operator">&amp;</span>h<span class="token operator">=</span><span class="token number">150</span><span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>lanyes<span class="token punctuation">.</span>orghttp<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>b<span class="token punctuation">.</span>bshare<span class="token punctuation">.</span>cn<span class="token operator">/</span>barCode<span class="token operator">?</span>site<span class="token operator">=</span>weixin<span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>lanyes<span class="token punctuation">.</span>orghttp<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>s<span class="token punctuation">.</span>jiathis<span class="token punctuation">.</span>com<span class="token operator">/</span>qrcode<span class="token punctuation">.</span>php<span class="token operator">?</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>lanyes<span class="token punctuation">.</span>orghttp<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>kuaizhan<span class="token punctuation">.</span>com<span class="token operator">/</span>common<span class="token operator">/</span>encode<span class="token operator">-</span>png<span class="token operator">?</span>large<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>data<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>lanyes<span class="token punctuation">.</span>orghttp<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>k780<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">88</span><span class="token operator">/</span><span class="token operator">?</span>app<span class="token operator">=</span>qr<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&amp;</span>data<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>54admin<span class="token punctuation">.</span>net<span class="token operator">&amp;</span>level<span class="token operator">=</span>L<span class="token operator">&amp;</span>size<span class="token operator">=</span><span class="token number">6</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>qrserver<span class="token punctuation">.</span>com<span class="token operator">/</span>v1<span class="token operator">/</span>create<span class="token operator">-</span>qr<span class="token operator">-</span>code<span class="token operator">/</span><span class="token operator">?</span>size<span class="token operator">=</span>150x150<span class="token operator">&amp;</span>data<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>54admin<span class="token punctuation">.</span>net </code></pre><p>然后修改 yilia/layout/_partial/post/share.ejs中的代码，将微信分享 img 标签中的连接改成上面中的一个链接即可</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>page-modal wx-share js-wx-box<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close js-modal-close<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon icon-close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>扫一扫，分享到微信<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wx-qrcode<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%- <span class="token punctuation">'</span>qrcode<span class="token punctuation">'</span> in locals ? qrcode(sUrl) : <span class="token punctuation">'</span>http://qr.liantu.com/api.php?text<span class="token punctuation">=</span><span class="token punctuation">'</span> + sUrl  %<span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>微信分享二维码<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre><h3 id="3-在博客中使用数学公式"><a href="#3-在博客中使用数学公式" class="headerlink" title="3 . 在博客中使用数学公式"></a>3 . 在博客中使用数学公式</h3><p>在用markdown写技术文档时，免不了会碰到数学公式。常用的Markdown编辑器都会集成 MathJax插件，用来渲染文档中的类Latex格式书写的数学公式，但有些主题可能使用默认插件，导致公式渲染出现各种问题，其原因是因为Hexo默认使用”hexo-renderer-marked”引擎渲染网页，该引擎会把一些特殊的markdown符号转换为相应的html标签，比如在markdown语法中，下划线’_’代表斜体，有特殊的含义，存在语义冲突。 渲染引擎会处理为<code>&lt;em&gt;</code>标签  。这样一来，我们写的MathJax公式就被错误渲染了，也就没办法正确显示出来。 解决办法也比较简单，更换Hexo的markdown渲染引擎 。</p><pre><code>npm uninstall hexo-renderer-marked --savenpm install hexo-renderer-kramed --save</code></pre><p>执行上面两个命令即可，先卸载原来的渲染引擎，再安装新的。 这样能解决大部分公式的问题，但但是个别行内公式还会出现渲染出错 因为hexo-renderer-kramed引擎也有语义冲突的问题。接下来到博客根目录下，找到node_modules\kramed\lib\rules\inline.js，把第11行的escape变量的值做相应的修改： </p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//  escape: /^\\([\\`*{}\[\]()#$+\-.!_>])/,</span>  escape<span class="token punctuation">:</span> <span class="token regex">/^\\([`*\[\]()#$+\-.!_>])/</span><span class="token punctuation">,</span></code></pre><p>把第20行的em变量也要做相应的修改 </p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//  em: /^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</span>  em<span class="token punctuation">:</span> <span class="token regex">/^\*((?:\*\*|[\s\S])+?)\*(?!\*)/</span><span class="token punctuation">,</span></code></pre><p>这样问题就完美解决了，然后在主题的_config.yml 配置文件中开启mathjax ，把mathjax 设置为true</p><pre><code>mathjax: true</code></pre><p>同时在文章的Front-matter里打开mathjax开关 </p><pre><code>title: date: 2018-07-28 08:11:02mathjax: truetags:</code></pre><p>这里设置是只有在用到公式的页面才会有，没用到公式就不需要设置。这样不需要渲染数学公式的页面的访问速度就不会受到影响了。 </p><p>更多关于在Markdown中使用数学公式的用法参考链接：<a href="https://www.zybuluo.com/codeep/note/163962" target="_blank" rel="noopener">https://www.zybuluo.com/codeep/note/163962</a></p><h3 id="4-评论系统"><a href="#4-评论系统" class="headerlink" title="4 . 评论系统"></a>4 . 评论系统</h3><p>第三方评论系统很多，例如多说，畅言等。多说，网易云跟贴都已经下线 ，目前可用的评论系统大概有 ：</p><p><a href="https://www.hypercomments.com/" target="_blank" rel="noopener">HyperComments </a>：来自俄罗斯的评论系统，目前只支持谷歌账号登录，国内有万里长城阻隔，翻墙注意安全 ！</p><p><a href="https://livere.com/" target="_blank" rel="noopener">来必力 </a>：来自韩国，使用邮箱注册 。这个还可以，本来打算用这个的</p><p><a href="https://github.com/xCss/Valine" target="_blank" rel="noopener">Valine </a>：基于Leancloud的极简风评论系统 </p><p><a href="http://changyan.kuaizhan.com/" target="_blank" rel="noopener">畅言 </a>：国产，符合大部分国人的风格和需求，但是安装需要备案号 ，比较麻烦</p><p><a href="https://gitalk.github.io/" target="_blank" rel="noopener">gitalk</a>：一个基于 Github Issue 和 Preact 开发的评论插件，博客的评论就是github上对应repository的Issue</p><p>最后经过对比，最终选择了gitalk。样式美观，功能也比较实用，评论支持Markdown 语法。</p><p><strong>引用</strong></p><p>官方提供了两种方式的引用</p><ul><li>links</li></ul><pre class=" language-html"><code class="language-html">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- or --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/gitalk/dist/gitalk.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/gitalk/dist/gitalk.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><ul><li>npm install</li></ul><pre class=" language-python"><code class="language-python">npm i <span class="token operator">-</span><span class="token operator">-</span>save gitalk<span class="token keyword">import</span> <span class="token string">'gitalk/dist/gitalk.css'</span><span class="token keyword">import</span> Gitalk <span class="token keyword">from</span> <span class="token string">'gitalk'</span></code></pre><p><strong>注册OAuth application</strong></p><p>既然使用github的issue，那么肯定要得到github的授权，这步操作就是做这个事情。如果没有需先去注册，注册地址：<a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">Register a new OAuth application</a>  。</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blogtalk.png" alt></p><p>注册后来到如下界面</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blogtalk1.png" alt></p><p>在这里会得到Client ID和Client Secret两个值，这两个值是后面需要用到的。</p><p><strong>配置</strong></p><p>进入yilia主题的文件路径，打开 /yilia/layout_partial/目录下的article.ejs文件。拉至底部，可以发现原作者已经为我们集成了很多评论系统，如下</p><pre class=" language-jsp"><code class="language-jsp"><% if (!index && post.comments){ %>  <% if (theme.duoshuo){ %>  <%- partial('post/duoshuo', {      key: post.slug,      title: post.title,      url: config.url+url_for(post.path)    }) %>  <% } %>  <% if (theme.wangyiyun){ %>  <%- partial('post/wangyiyun', {      key: post.slug,      title: post.title,      url: config.url+url_for(post.path)    }) %>  <% } %></code></pre><p>在 &lt;% if (!index &amp;&amp; post.comments){ %&gt; 的下一行加入gitalk的初始化代码，如下所示</p><pre class=" language-jsp"><code class="language-jsp"><% if (!index && post.comments){ %>  <!--  评论插件 -->  <% if (theme.gitalk.enable){ %>    <div class="gitalk" style="padding: 0 40px;">      <div id="gitalk-container"></div>         <link rel='stylesheet' href="/blog/gitalk/gitalk.css">      <script src="/blog/gitalk/gitalk.min.js"></script>       <script src="/blog/gitalk/md5.min.js"></script>      <script type="text/javascript">          var gitalk = new Gitalk({            clientID:  '<%=theme.gitalk.clientID%>',             clientSecret: '<%=theme.gitalk.clientSecret%>',            repo: '<%=theme.gitalk.repo%>',             id: md5(location.pathname),            owner: '<%=theme.gitalk.owner%>',             admin: '<%=theme.gitalk.admin%>',             distractionFreeMode: <%=theme.gitalk.distractionFreeMode%>,          })          gitalk.render('gitalk-container')      </script>    </div>  <% } %>  <% if (theme.duoshuo){ %>  <%- partial('post/duoshuo', {      key: post.slug,      title: post.title,      url: config.url+url_for(post.path)    }) %>  <% } %>  <% if (theme.wangyiyun){ %>  <%- partial('post/wangyiyun', {      key: post.slug,      title: post.title,      url: config.url+url_for(post.path)    }) %>  <% } %></code></pre><p>这里我为了简单，直接把代码放这里了。实际可以像作者一样，在post文件夹下新建一个gitalk.ejs文件，把这段代码，然后通过引用的方式引入进来。然后就是最后一步了，还需要在主题的 _config.xml 文件下加入gitalk的配置属性。如下</p><pre class=" language-js"><code class="language-js">#<span class="token number">6</span> Gitalkgitalk<span class="token punctuation">:</span>   #用来做启用判断可以不用  enable<span class="token punctuation">:</span> <span class="token boolean">true</span>     #your clientID，在github注册得到  clientID<span class="token punctuation">:</span> 848f5278f2459aaa9a50    #your clientSecret 在github注册得到  clientSecret<span class="token punctuation">:</span> <span class="token string">'db9688596567c9ba2786f5ba635395562e0df353'</span>    #存储你评论 issue 的 Github 仓库名（建议直接用 GitHub Page 的仓库名）  repo<span class="token punctuation">:</span> <span class="token string">'blog'</span>  #github用户名  owner<span class="token punctuation">:</span> <span class="token string">'lushunjian'</span>    #这个仓库的管理员，可以有多个，用数组表示，一般写自己  admin<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'lushunjian'</span><span class="token punctuation">]</span>  #无干扰模式开启  distractionFreeMode<span class="token punctuation">:</span> <span class="token boolean">true</span>  #页面的唯一标识，gitalk 会根据这个标识自动创建的issue的标签<span class="token punctuation">,</span>我们使用页面的相对路径作为标识  id<span class="token punctuation">:</span> <span class="token string">'window.location.pathname'</span></code></pre><p>更多属性设置，可进入官方查看。至此评论系统配置完毕，启动看一下效果</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blogtalk3.png" alt></p><p>这里需要登录一下，对gitalk进行初始化，每篇文章都需如此。初始化完成后，会在github对应的仓库中创建队应的issues</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blogtalk2.png" alt></p><p>此时再看博客效果如下图</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blogtalk4.png" alt></p><h3 id="5-添加萌宠"><a href="#5-添加萌宠" class="headerlink" title="5. 添加萌宠"></a>5. 添加萌宠</h3><p>这个功能比较适合女生吧，可以在博客页面中添加可爱的妹纸或者是萌宠，作者提供了很多模型，移动鼠标时萌宠也会跟着鼠标转头，没事可以逗一逗。插件使用比较简单，通过以下命令直接获取就行了</p><pre><code>npm install --save hexo-helper-live2d</code></pre><p>然后在主题的配置文件 _config.yml 中添加以下配置属性</p><pre><code>live2d:  enable: true  scriptFrom: local  model:      #这里配置你想用的模型    use: live2d-widget-model-wanko    display:      #居左或是居右显示    position: right    #模型宽高    width: 150    height: 300  mobile:    show: true</code></pre><p>更多模型选择可以作者的github地址：<a href="https://github.com/xiazeyu/live2d-widget-models" target="_blank" rel="noopener">模型</a></p><h3 id="6-使用第三方图床，缩短图片加载时间"><a href="#6-使用第三方图床，缩短图片加载时间" class="headerlink" title="6. 使用第三方图床，缩短图片加载时间"></a>6. 使用第三方图床，缩短图片加载时间</h3><p>在博客中难免会频繁的使用图片，但是如果图片过多的放在github上，由于github服务器在国外，国内访问会导致页面加载异常缓慢，当然解决的办法也是很多的。就是图片放在国内的服务器上，这里选择方式就很多了，可以把图片单独放在专门的云服务上，也可托管在第三方平台上如七牛等。这里介绍我自己使用的一种方式，简单免费。我们知道在国外github比较有名气，但是由于网速和它禁用百度爬虫的问题，许多程序员会选用gitee作为在国内的代码托管平台，gitee可以说就是国内的github。功能也大多相同，gitee也提供了静态文件的访问服务。因此实际上我们直接可以之间把博客搭建在gitee上。这是一种一劳永逸的办法，而且还可以被百度爬虫爬到哦。由于本人比较懒，暂时没有迁移。github除了图片加载较慢外，其他到是还可以接受，所以我们可以只把图片放在gitee上，然后在github的文章中引用gitee上的图片，问题就完美的解决了。</p><h4 id="（1）-在gitee上创建一个项目"><a href="#（1）-在gitee上创建一个项目" class="headerlink" title="（1）. 在gitee上创建一个项目"></a>（1）. 在gitee上创建一个项目</h4><p>点击右上角头像图标右边的加号，选择新建仓库，仓库名字自己定义好</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blog20.png" alt></p><h4 id="（2）-开启pages服务"><a href="#（2）-开启pages服务" class="headerlink" title="（2）. 开启pages服务"></a>（2）. 开启pages服务</h4><p>创建完项目后，进入项目点击服务，选择gitee pages</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/bolg1.png" alt></p><p>在开启pages服务时，注意要勾选强制使用HTTPS，因为github在访问HTTP文件时会报错，导致访问出错。开启gitee pages服务后，上面会提示你网站地址。通过这个地址就可以访问到这个项目中的静态文件了。</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/bolg2.png" alt></p><h4 id="（3）-图片的访问"><a href="#（3）-图片的访问" class="headerlink" title="（3）. 图片的访问"></a>（3）. 图片的访问</h4><p>开启好gitee pages服务后，我们可以直接在浏览器中输入网站地址。例如我的是 <a href="https://lsjlsjlsj.gitee.io/photo。通过这个网址访问到的是项目根路径下的文件，假如我要访问文件夹中的图片该怎么写呢？举个例子，我的项目下有个img文件夹，我想访问img中的一张图片怎么做" target="_blank" rel="noopener">https://lsjlsjlsj.gitee.io/photo。通过这个网址访问到的是项目根路径下的文件，假如我要访问文件夹中的图片该怎么写呢？举个例子，我的项目下有个img文件夹，我想访问img中的一张图片怎么做</a></p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blog4.png" alt></p><p>进入到img文件夹中，假设我要访问11.jpg</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blog5.png" alt></p><p>直接在浏览器中加上图片相对于根路径的相对路径就可以了。<a href="https://lsjlsjlsj.gitee.io/photo/img/11.jpg" target="_blank" rel="noopener">https://lsjlsjlsj.gitee.io/photo/img/11.jpg</a> ，可以在浏览器中打开看看，如果能打开就是能正常访问了。</p><p><img src="/2018/07/08/bo-ke-ge-xing-hua-pei-zhi/blog6.png" alt></p><p>这样在使用github写博客，或者制作博客相册时，便可引用gitee中的图片作为图床。解决github博客页面因为图片加载过慢的问题</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 其他 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一致性哈希</title>
      <link href="/2018/07/07/yi-zhi-xing-ha-xi/"/>
      <url>/2018/07/07/yi-zhi-xing-ha-xi/</url>
      
        <content type="html"><![CDATA[<p>​    最近几天研究了下一致性哈希算法，总算是搞明白它是怎么一回事了，这里记录一下自己的理解。一致性哈希算法主要是针对分布式缓存系统的算法。要想搞清楚一致性哈希的的优缺点，那就必须从它的发应用场景说起，也就是为什么分布式缓存中要使用一致性哈希算法，传统的做法有什么缺点，会带来什么问题。首先来看一下传统的做法，我们知道缓存在大型的应用系统中的地位是很重要的，它能有效的减少数据库的访问次数，从而减少IO提高系统的反应速度，得到较好的用户体验。因此一般应用系统都会使用Redis或者Memcached等中间件做缓存。而在数据量比较大的情况下，一台缓存服务器往往是不足以扛住大数据量的压力，所以会搭建一个缓存服务器的集群。缓存数据就会由原来在一台服务器上变为分布在一个缓存集群上，那数据怎么才能均匀的分布在集群中的节点上呢。又该怎么快速去定位待查询的数据在哪台缓存服务器上呢。</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi.jpg" alt></p><a id="more"></a> <h3 id="1-实际场景"><a href="#1-实际场景" class="headerlink" title="1 . 实际场景"></a>1 . 实际场景</h3><p>现在假设有三台缓存服务器节点，当有查询请求来时，首先会去缓存中查找数据，最简单的做法就是轮询三个节点，然后找到待查询的数据，如果数据没找到就到数据库中去查询，这种做法是大多数人最直观的做法。但这种做法的效率很低，需要去轮询服务器，不利于横向拓展。因此就出现了哈希算法去定位服务器，假设有4条数据，那么这4条数据是怎么分布在缓存中的呢？传统的取模哈希算法相对简单，就是用数据的key对服务器的个数取模，在这个例子中再假设4条数据的key分别是1,2,3,4。服务器的编号分别是A,B,C。那么数据1，数据4是在节点B上，数据2在节点C上，数据3在节点A上。如下图所示：</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/mode.png" alt></p><p>这里数据取模后的值为0,1,2对应于服务器A,B,C。在查询数据的时候，就能快速的得到这条数据所在的服务器编号，从而大大提高了查询速度。这种方式比起前一种方式优势明显，但在实际环境中却有很大的问题，因为我们忽略了一个问题，那就是这是一个分布式环境。分布式环境中最让人头疼的问题就是环境是不稳定的，随时都有可能会有节点宕机，在刚刚那个例子中，如果有一个节点挂机，数据分布会是怎么样的，假设节点C宕机，还剩下节点A,B在正常运行。此时服务器数量是2，那么数据的分布应该是这样的，数据2和数据4在节点A上，数据1和数据3在节点B上，如下图</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/mode1.png" alt></p><p>由此可见，大部分数据都被重新定位到新的服务器上了。这种情况会带来一个很大的隐患，就是当系统运行时，某个缓存节点突然宕机，查询数据时，首先会去缓存中查找这条数据，如果这些数据刚好在这个宕机的节点上，导致没有查到数据，故只能去数据库查询数据。由于短时间内大量的数据缓存在同一时间失效，数据库将面临大量的IO请求，此时应用系统和数据库都面临着巨大的压力。如果由于大量请求导致应用服务器的某个节点宕机，这些请求又会负载到其他服务节点，巨大的请求量同样会导致其他服务节点宕机，。最终导致雪崩式的宕机，拖垮整个系统。如果发生这种情况，那可能是灾难性的。因此要尽量避免这种情况的发生。这种情况在架构设计时应该考虑到采取一定的方式应对。这里就不做深入讨论了，同样在应用系统用户量增加的时候，缓存集群可能不足以支撑查询压力，因而需要增加缓存节点来提高系统的性能。如果往缓存集群中动态的增加一个节点同样会导致类似的情况，大部分的数据需要重新定位。因此需要一种更好的算法去解决这个问题，一致性哈希算法就应运而生了。</p><h3 id="2-一致性Hash概述"><a href="#2-一致性Hash概述" class="headerlink" title="2 . 一致性Hash概述"></a>2 . 一致性Hash概述</h3><p>一致性哈希把数据映射到0到2^32次方个哈希桶的空间，形成一个哈希环。通俗的理解，就是在一个圆环有很多个整数点，这些点从0开始，一直到2的32次方结束，然后通过哈希算法将缓存服务器映射到这个环上。那么在刚刚那个例子中服务器A,B,C映射到哈希环上会是什么样子呢？一般我们使用服务器的ip地址，作为哈希的key值，（这个key值可以自己定义，前面的例子中是使用的服务器编号），通过 <strong>Hash(服务器ip)%2^32</strong> 得到哈希值，那么3个服务器节点通过哈希算法计算后，在哈希环上是这样分布的</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi.png" alt></p><p>当有数据请求时，一致性哈希是怎么存储数据的呢？这需要在数据存储的时候，把数据的id作为哈希的key值，以同样的公式计算出哈希值，即通过 <strong>Hash(数据id)%2^32</strong> 公式得到哈希值，这里假设有6条数据，在哈希环得到如下的数据分布图。</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/yizhixinghaxi.png" alt></p><p>这里数据的分布和前面通过取模方式区别比较大，前面的方式数据id取模后，会直接得到服务器节点的编号（因为取模后的值就是服务器的编号），于是便确定到这条数据在哪个节点上。而一致性哈希计算出哈希值后，数据离散的分布在整个哈希环上，通过哈希值还不能确认这条数据分布在哪个节点上。这里还需要一个约定，就是沿顺时针或是逆时针方向，数据会被存储到这个方向上遇到的第一个节点中。例如上图中，沿顺时针方向走，数据1,2遇到的第一个节点是节点B，所以数据1,2会被存储在节点B上，同理数据3,4存储在节点C上，数据5,6存储在节点A上。一致性哈希就是通过这种方式定位数据的。</p><h3 id="3-一致性哈希的优点"><a href="#3-一致性哈希的优点" class="headerlink" title="3 . 一致性哈希的优点"></a>3 . 一致性哈希的优点</h3><p>在前面的阐述中通过简单的取模方式，如果服务器数量发生变化，容易引发集群的雪崩。那么一致性哈希能很好的解决这个问题吗？再来模拟一遍服务节点数量发生变化的情况下，一致性哈希会是怎样的结果。</p><h4 id="1-节点宕机"><a href="#1-节点宕机" class="headerlink" title="(1) . 节点宕机"></a>(1) . 节点宕机</h4><p>上图中假设节点C宕机了，那么数据的分布是变成什么样的呢。由于哈希算法跟节点数量没有关系，那么数据在哈希环上的位置不会改变。于是可得的如下图的数据分布图</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi1.png" alt></p><p>沿顺时针方向走，可得数据1,2存储在节点B上，而数据3,4,5,6都存储在节点A上。通过和正常情况下的数据分布比较，可以看出来，在节点C宕机的情况下，只有节点C上的数据需要迁移。而其他数据都不会受到影响。</p><h4 id="2-节点加入"><a href="#2-节点加入" class="headerlink" title="(2) . 节点加入"></a>(2) . 节点加入</h4><p>如果集群想动态的增加一个缓存节点，以提升性能，那么在一致性哈希下，集群会受到什么影响呢？现在假设在数据3和数据4之间增加一个节点x，数据分布会得到如下图的效果。</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi2.png" alt></p><p>从图中可以看出，除了数据3会被迁移到节点x以外，其他数据都不会受到影响。通过和节点宕机的情况下比较还可以知道，增加节点时，需要迁移的数据比节点宕机时要少。而且集群节点越多，受影响的数据占比就越少，这说明一致性哈希比较适用于集群的横向扩展。</p><h3 id="3-数据倾斜"><a href="#3-数据倾斜" class="headerlink" title="3 . 数据倾斜"></a>3 . 数据倾斜</h3><p>在前面的讨论中，服务器是被均匀的映射在哈希环上了，但是理想很丰满，现实很骨感。实际映射到哈希环上的节点并不如我们想象的那么美好，而往往是下面这般模样</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi3.png" alt></p><p>很明显，如果节点在哈希环上分配不均匀，那么节点A负载的数据量将远远大于节点B，节点C。这可能导致节点A由于承受较大的负载而宕机，如果节点A宕机，那么数据量会积压到节点B上，然后节点B宕机，然后节点C，然后雪崩了。这种情况叫做哈希环的倾斜，这些专业名称总会不明白的人望而生畏，其实不过是给一件简单的事情起了个名字。那么哈希环倾斜的问题该怎么解决呢？</p><h3 id="4-虚拟节点"><a href="#4-虚拟节点" class="headerlink" title="4 . 虚拟节点"></a>4 . 虚拟节点</h3><p>从上面的图可以看出，如果哈希函数本身没问题的话，出现哈希环倾斜的原因，是因为节点。如果节点数足够多的话，就可以让节点尽可能离散的分布在哈希环上。但实际情况中，就只有3个节点怎么办呢？一致性哈希算法种使用虚拟节点解决了这个问题。理解起来也简单，就是节点数不够多嘛，那么通过虚拟出足够多的节点，不就能让节点均匀的分布在哈希环上了吗。那么虚拟节点是怎么得到的呢，既然是虚拟节点，那说白了就是个假节点，是通过实际节点复制而来的。说专业点就叫做虚拟，比如把节点A虚拟出两个节点叫节点A-1，节点A-2。同样节点B和节点C也各虚拟两个节点那么就会得到如下的分布图了</p><p><img src="/2018/07/07/yi-zhi-xing-ha-xi/haxi5.png" alt></p><p>这样在哈希环上，节点就是均匀分布的，很好的解决了由于节点分布不均匀而带来的数据倾斜问题。这里节点A-1和节点A-2是节点A虚拟出的两个节点，那么实际上存储在节点A-1和节点A-2上的数据是存储在物理节点A上的。如果虚拟节点在哈希环上分布还是不均匀，可以继续虚拟出更多的节点。虚拟节点越多，节点在哈希环上就会分布的越均匀，哈希环倾斜带来的影响也会越小。</p><p>一致性哈希基本解决了在P2P环境中最为关键的问题——如何在动态的网络拓扑中分布存储和路由。每个节点仅需维护少量相邻节点的信息，并且在节点加入/退出集群时，仅有相关的少量节点参与到拓扑的维护中。所有这一切使得一致性哈希成为第一个实用的DHT算法。 </p>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式系统 </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Http请求中转</title>
      <link href="/2018/06/30/http-qing-qiu-zhong-zhuan/"/>
      <url>/2018/06/30/http-qing-qiu-zhong-zhuan/</url>
      
        <content type="html"><![CDATA[<p>​    在工作中碰到需要在服务端中转Http请求的需求，一般的请求其实问题不大，用apache的HttpClient 提供的jar包即可解决问题，但是带文件上传的请求中转，遇到了一些小麻烦，在此记录一下。</p><p>业务场景是这样的，由于是做系统升级，升级的同时不影响老版本的使用，同时又不和新版本的代码耦合，所以做了一个适配模块，这个模块是个单独的项目。在前端请求新版本系统时会先进入新版本系统的拦截器中，在拦截器中判断该请求是调用新版本的系统接口还是老版本的系统接口，如果调用老版本系统接口，就会先走适配模块，在适配模块中调用老系统的接口。整个流程大致如下图：</p><p><img src="/2018/06/30/http-qing-qiu-zhong-zhuan/work.png" alt></p><p>在适配器中使用了apache的HttpClient包，而在拦截器中使用的是jdk自带的java.net.URL类。因此两种方式我都会提供，此外还可以通过java.net.socket类实现Http请求，这几种种方式大同小异，只是HttpClient做了一下封装。最重要的还是要对Http请求协议有比较全面的认识，然后模拟出一个符合协议标准的请求报文就可以像浏览器那样模拟Http请求了。</p><a id="more"></a> <h3 id="1-Http请求报文"><a href="#1-Http请求报文" class="headerlink" title="1 . Http请求报文"></a>1 . Http请求报文</h3><p>通过Fiddler抓包工具，可以抓取网络请求，查看请求信息，下面是我抓取的Get和Post请求的请求报文</p><h4 id="1-Get请求"><a href="#1-Get请求" class="headerlink" title="(1) . Get请求"></a>(1) . Get请求</h4><pre><code>GET http://localhost:8081/test?name=111 HTTP/1.1Host: localhost:8081Connection: keep-aliveUpgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8Accept-Encoding: gzip, deflate, brAccept-Language: zh-CN,zh;q=0.9</code></pre><h4 id="2-Post请求"><a href="#2-Post请求" class="headerlink" title="(2) . Post请求"></a>(2) . Post请求</h4><pre><code>POST http://localhost:8081/upload HTTP/1.1cache-control: no-cachePostman-Token: 9316956c-b2a9-43a0-9a5c-87a4f5eead7dUser-Agent: PostmanRuntime/6.3.2Accept: */*Host: localhost:8081accept-encoding: gzip, deflatecontent-type: multipart/form-data; boundary=--------------------------535635233106673687621220content-length: 355Connection: keep-alive----------------------------535635233106673687621220Content-Disposition: form-data; name=&quot;name&quot;lsj----------------------------535635233106673687621220Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test.txt&quot;Content-Type: text/plain     ļ  ϴ      ݣ 2333333     д 㶫  ----------------------------535635233106673687621220--</code></pre><p>大部分属性大致看一下也能明白它的含义，需要注意的是Post请求中content-type是multipart/form-data时，必须指定boundary，这是属性是参数的分隔符。明白请求报文的格式后，只需中拼凑出这样格式相同的报文头就可以了。</p><h3 id="2-响应报文"><a href="#2-响应报文" class="headerlink" title="2 . 响应报文"></a>2 . 响应报文</h3><pre><code>HTTP/1.1 200X-Application-Context: application:8081Content-Type: text/html;charset=UTF-8Content-Length: 3Date: Sun, 01 Jul 2018 00:27:47 GMT111</code></pre><h3 id="3-模拟客户端请求"><a href="#3-模拟客户端请求" class="headerlink" title="3 . 模拟客户端请求"></a>3 . 模拟客户端请求</h3><p>下面使用了3种方式模拟客户端请求</p><h4 id="1-HttpCilent"><a href="#1-HttpCilent" class="headerlink" title="(1) . HttpCilent"></a>(1) . HttpCilent</h4><p>需要用到apache的两个jar包</p><pre class=" language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.5.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpmime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.5.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>客户端代码如下：</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 模拟客户端表单提交     * */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span>String url<span class="token punctuation">)</span><span class="token punctuation">{</span>        CloseableHttpClient client <span class="token operator">=</span> HttpClientBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HttpPost post <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置请求头</span>        post<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Accept-Language"</span><span class="token punctuation">,</span><span class="token string">"zh-CN,zh;q=0.8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//设置参数</span>            <span class="token comment" spellcheck="true">//文件附件</span>            MultipartEntityBuilder mEntityBuilder <span class="token operator">=</span> MultipartEntityBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addBinaryBody</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//其他参数，类似表单的Input</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addTextBody</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"lsj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addTextBody</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            post<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>mEntityBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            CloseableHttpResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>            HttpEntity entity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String data <span class="token operator">=</span> EntityUtils<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e1<span class="token punctuation">)</span><span class="token punctuation">{</span>            e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span><span class="token punctuation">{</span>                client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span><span class="token punctuation">{</span>                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h4 id="2-URL"><a href="#2-URL" class="headerlink" title="(2) . URL"></a>(2) . URL</h4><p>URL的方式需要自己去拼接请求报文的格式</p><pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">/**     * 模拟在客户端表单提交     * */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span>File file<span class="token punctuation">,</span> String urlPath<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 1.创建URL对象</span>            URL url <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 2.构建附件输入流</span>            <span class="token comment" spellcheck="true">// io文件对象转为输入流</span>            InputStream fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 3.模拟表单中普通input的数据</span>            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"lsj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//核心方法------发送请求---------</span>            InputStream responseStream <span class="token operator">=</span> <span class="token function">sendUrlRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>fileInputStream<span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//打印响应数据</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>responseStream <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 将字节流包装成字符流</span>                InputStreamReader inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>responseStream<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 创建一个输入缓冲区对象，将要输入的字符流对象传入</span>                BufferedReader bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span>                String line<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 创建缓冲字符对象</span>                StringBuilder stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 打印响应数据</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"请求异常 ! "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/**     * 请求地址     * url     *     * 请求中的附件     * fileInputStream     * */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> InputStream <span class="token function">sendUrlRequest</span><span class="token punctuation">(</span>URL url<span class="token punctuation">,</span>InputStream fileInputStream<span class="token punctuation">,</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> dataMap<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 获取连接对象</span>            URLConnection connection <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置请求类型 "GET", "POST", "HEAD", "OPTIONS", "PUT", "DELETE", "TRACE"</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>HttpURLConnection<span class="token punctuation">)</span> connection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置连接超时时间</span>            connection<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//设置读取超时时间</span>            connection<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置允许输入流输入数据到本机</span>            connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置允许输出流输出数据到服务器</span>            connection<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置不使用缓存</span>            connection<span class="token punctuation">.</span><span class="token function">setUseCaches</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置请求头参数</span>            connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Accept-Charset"</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置请求参数中的内容类型为multipart/form-data,设置请求内容的分割线为******</span>            connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"multipart/form-data;boundary="</span> <span class="token operator">+</span> BOUNDARY<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 从连接对象中获取输出流</span>            OutputStream outputStream <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 实例化数据输出流对象，将输出流传入</span>            DataOutputStream dataOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 表单中的普通数据，写入到输出流对象-----------------------------开始</span>            <span class="token comment" spellcheck="true">// 获取表单中上传控件之外的控件数据，写入到输出流对象（根据抓包的内容格式拼凑字符串）；</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> dataMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    String key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 键，相当于表单提交中Input的name属性</span>                    String value <span class="token operator">=</span> dataMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 值，相当于表单提交中Input的输入值</span>                    dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>PREFIX <span class="token operator">+</span> BOUNDARY <span class="token operator">+</span> NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 像请求体中写分割线，就是前缀+分界线+换行</span>                    dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition: form-data;name="</span> <span class="token operator">+</span> key <span class="token operator">+</span> NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 空行，一定不能少，键和值之间有一个固定的换行</span>                    dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>URLEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将值写入,设置编码</span>                    dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 换行</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 表单中的普通数据，写入到输出流对象-----------------------------结束</span>            <span class="token comment" spellcheck="true">// 表单中上传附件的数据，写入到输出流对象-----------------------------开始</span>            <span class="token comment" spellcheck="true">// 向数据输出流中写出分割符</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>PREFIX <span class="token operator">+</span> BOUNDARY <span class="token operator">+</span> NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 向数据输出流中写出文件参数名与文件名</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition:form-data;name=file;filename=abc.txt"</span>  <span class="token operator">+</span> NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 向数据输出流中写出结束标志， 重要！！不要忘了</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 定义缓冲区大小</span>            <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 定义字节数组对象，用来读取缓冲区数据</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 定义一个整形变量，用来存放当前读取到的文件长度</span>            <span class="token keyword">int</span> length <span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 循环从文件输出流中读取1024字节的数据，将每次读取的长度赋值给length变量，直到文件读取完毕，值为-1结束循环</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 向数据输出流中写出数据</span>                dataOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 每写出完成一个完整的文件流后，需要向数据输出流中写出结束标志符</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 关闭文件输入流</span>            fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 表单中上传附件的数据，写入到输出流对象-----------------------------结束</span>            <span class="token comment" spellcheck="true">// 向数据输出流中写出分隔符</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>PREFIX <span class="token operator">+</span> BOUNDARY <span class="token operator">+</span> PREFIX <span class="token operator">+</span> NEWLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 刷新数据输出流</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 依次关流，先开后关原则</span>            fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dataOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 从连接对象中获取字节输入流，即response，response中的数据以流的形式返回</span>            <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h4 id="3-Socket"><a href="#3-Socket" class="headerlink" title="(3) . Socket"></a>(3) . Socket</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        Socket socket<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            String para <span class="token operator">=</span> <span class="token string">"name=abc&amp;age=22"</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> length <span class="token operator">=</span> para<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8081</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            BufferedWriter wr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"UTF8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            InputStream ins <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            StringBuffer sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"POST /test  HTTP/1.1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 注意\r\n为回车换行</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Accept-Language: zh-cn\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Connection: Keep-Alive\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Host:localhost\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Length:"</span><span class="token operator">+</span>length<span class="token operator">+</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Type: application/x-www-form-urlencoded\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 接收Web服务器返回HTTP响应包</span>            wr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            wr<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            BufferedReader rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String line<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> rd<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>这里一定要注意的是Content-Length的计算，因为在HTTP协议中，如果你的长度计算错误，那么服务器就会一直在等待读取，导致请求超时。 </p><h3 id="4-在服务端中转Http请求"><a href="#4-在服务端中转Http请求" class="headerlink" title="4 . 在服务端中转Http请求"></a>4 . 在服务端中转Http请求</h3><p>上面的代码只是模拟客户端发送http请求，而如果需要在服务端请求第三方的接口，并把接口返回的数据再返回到前台，方式就稍微有点区别。主要的区别就是对返回的输入流的处理，只要把返回的输入流复制到当前请求的response的输出流中即可，代码如下：</p><h4 id="1-HttpCilent-1"><a href="#1-HttpCilent-1" class="headerlink" title="(1) . HttpCilent"></a>(1) . HttpCilent</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * 模拟在服务端中转请求     *     * request 当前请求的Request对象     * response 当前请求的Response对象     * forWardUrlPath 要请求的url     * */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span>MultipartFile multipartFile<span class="token punctuation">,</span> String forWardUrlPath <span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span><span class="token punctuation">{</span>        CloseableHttpClient client <span class="token operator">=</span> HttpClientBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HttpPost post <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>forWardUrlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//文件附件</span>            MultipartEntityBuilder mEntityBuilder <span class="token operator">=</span> MultipartEntityBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 附件名称</span>            String fileName <span class="token operator">=</span> multipartFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addBinaryBody</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span>  multipartFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ContentType<span class="token punctuation">.</span>APPLICATION_OCTET_STREAM<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//其他参数，类似表单的Input</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addTextBody</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"lsj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mEntityBuilder<span class="token punctuation">.</span><span class="token function">addTextBody</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            post<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>mEntityBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            CloseableHttpResponse forWardResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//获取返回的输入流</span>            InputStream inputStream <span class="token operator">=</span> forWardResponse<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//将返回的数据输入流，写到当请请求response的输出流中</span>            <span class="token function">forWardStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h4 id="2-URL-1"><a href="#2-URL-1" class="headerlink" title="(2) . URL"></a>(2) . URL</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * 模拟在服务端中转请求     *     * request 当前请求的Request对象     * response 当前请求的Response对象     * forWardUrlPath 要请求的url     * */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fileUploadForWard</span><span class="token punctuation">(</span>String forWardUrlPath<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> dataMap<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 1.创建URL对象</span>            URL url <span class="token operator">=</span>  URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>forWardUrlPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 2.通过HttpServletRequest 获取到上传的附件</span>            Part part <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPart</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 构建附件输入流</span>            <span class="token comment" spellcheck="true">// 也可通过 MultipartFile 对象，通过该对象的 getInputStream()方法获得附件的输入流</span>            InputStream fileInputStream <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 3.模拟表单中普通input的数据,可通过request获取</span>            dataMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"lsj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//核心方法------发送请求---------</span>            InputStream responseStream <span class="token operator">=</span> <span class="token function">sendUrlRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>fileInputStream<span class="token punctuation">,</span>dataMap<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>responseStream <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 这里把返回的inputStream写入到response输出流中</span>                <span class="token function">forWardStream</span><span class="token punctuation">(</span>responseStream<span class="token punctuation">,</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"请求异常 !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CAP理论</title>
      <link href="/2018/06/20/cap-li-lun/"/>
      <url>/2018/06/20/cap-li-lun/</url>
      
        <content type="html"><![CDATA[<p>​    使用了一段时间的Hbase，一直没有时间去了解它的理论基础。最近在看分布式的一些原理，其中最著名的分布式理论就是CAP理论，CAP理论是分布式系统的基石，CAP是Consistency（一致性）。 Availability（可用性）。Partition tolerance（分区容错性） 三个单词的首字母缩写。下面是百度百科上的解释。</p><p>● 一致性（C）：所有的节点上的数据时刻保持同步 </p><p>● 可用性（A）：每个请求都能接受到一个响应，无论响应成功或失败 </p><p>● 分区容错性（P）：系统应该能持续提供服务，即使系统内部有消息丢失（分区） </p><p>CAP理论在互联网界有着广泛的知名度，一般系统架构师会把其作为衡量系统设计的准则。大家都非常清楚地理解了CAP：任何分布式系统在可用性、一致性、分区容错性方面，不能兼得，最多只能得其二，所谓鱼和熊掌不可兼得。因此，任何分布式系统的设计只是在三者中实现其中的两者。</p><p><img src="/2018/06/20/cap-li-lun/cap.jpg" alt></p><a id="more"></a> <h3 id="1-发展"><a href="#1-发展" class="headerlink" title="1 . 发展"></a>1 . 发展</h3><p>​    所有理论都是从实际的经验中总结出来的，因此从实际的业务场景中去学习这些理论的原理也是最容易理解的。CAP理论的诞生也是技术发展的必然，在单机应用系统时代，一个系统会使用单节点的服务器做数据库，考虑的成本一般会使用开源中间件比如mysql。用户数据都存储在这台服务器上，开始一切都运转得很好，但随着用户的增长，突然有一天这台服务器挂了（宕机），导致mysql数据库不能对外提供服务了。虽然工程师能很快的修复了问题，但造成了不好的用户体验，究其原因是因为数据库在一台服务器上，会有单点故障的隐患。于是出现了把应用系统或是数据部署在多个节点上来避免单点故障的做法，提高了系统的可用性但是也会带来一系列问题，2000年，Eric Brewer教授在PODC的研讨会上提出了一个猜想：一致性、可用性和分区容错性三者无法在分布式系统中被同时满足，并且最多只能满足其中两个！ 这个猜想首次把一致性、可用性和分区容错三个因素提炼出来作为系统设计的重要特征，断言用此三者可以划分所有的分布式系统，并指明这三个特征之间的不可能性关系。Brewer猜想比单纯的“低延迟和顺序一致性不能被同时满足”的结论更具体，对实际系统的构建也更具有可操作性！ 于是就有了CAP理论，CAP的出现仿佛是一盏明灯，它揭露了分布式系统的本质，并给出了设计的准则，而这正是1985年以来人们正在寻找的东西！所以CAP在当时的影响力是非常大的！ </p><h3 id="2-解释"><a href="#2-解释" class="headerlink" title="2 . 解释"></a>2 . 解释</h3><h4 id="1-数据一致性"><a href="#1-数据一致性" class="headerlink" title="(1) . 数据一致性"></a>(1) . 数据一致性</h4><p>由于在分布式系统中数据是存储在不同节点上的，必然就会带来数据一致性的问题，在集群中数据的一致性是指数据副本的一致性，与关系型数据库中强调的数据一致性是有区别的。在关系数据库中，数据的一致性是指事务开始之前和事务结束以后，数据库的完整性约束没有被破坏。这是说数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性 。而分布式系统中的一致性是指，数据副本之间的一致性，对于一个将数据副本分布在不同分布式节点上的系统来说，如果对第一个节点的数据进行了更新操作并且更新成功后，却没有使得第二个节点上的数据得到相应的更新，于是在对第二个节点的数据进行读取操作时，获取的依然是老数据（或称为脏数据），这就是典型的分布式数据不一致的情况。在分布式系统中，如果能够做到针对一个数据项的更新操作执行成功后，用户都可以读取到其最新的值，那么 这样的系统就可以被认为具有强一致性，而在集群中一致性也是相对而言的。</p><ul><li><p>强一致性：这是最符合人的本能感官的，它要求数据写入后，立马能读到最新的数据，但对于分布式系统而言实现起来往往对系统的性能影响很大</p></li><li><p>弱一致性：这种一致性级别是指系统在写入成功后，不承诺立即可以读到写入的值，，但会尽可能地保证到某个时间级别（比如秒级别）后，数据能够达到一致状态</p></li><li><p>最终一致性：这其实也是弱一致性，算是弱一致性的一个特例，也是目前分布式系统中被广泛使用的一致性原则。它不保证数据多长时间能够达到一致性的状态，但保证无论多久数据最终能够达到一致性。</p><p>在实际工程实践中，最终一致性存在以下五类主要变种。</p><h5 id="a-因果一致性："><a href="#a-因果一致性：" class="headerlink" title="a.因果一致性："></a>a.因果一致性：</h5><p>​        因果一致性是指，如果进程A在更新完某个数据项后通知了进程B，那么进程B之后对该数据项的访问都应该能够获取到进程A更新后的最新值，并且如果进程B要对该数据项进行更新操作的话，务必基于进程A更新后的最新值，即不能发生丢失更新情况。与此同时，与进程A无因果关系的进程C的数据访问则没有这样的限制。</p><h5 id="b-读己之所写："><a href="#b-读己之所写：" class="headerlink" title="b.读己之所写："></a>b.读己之所写：</h5><p>​        读己之所写是指，进程A更新一个数据项之后，它自己总是能够访问到更新过的最新值，而不会看到旧值。也就是说，对于单个数据获取者而言，其读取到的数据一定不会比自己上次写入的值旧。因此，读己之所写也可以看作是一种特殊的因果一致性。</p><h5 id="c-会话一致性："><a href="#c-会话一致性：" class="headerlink" title="c.会话一致性："></a>c.会话一致性：</h5><p>​        会话一致性将对系统数据的访问过程框定在了一个会话当中：系统能保证在同一个有效的会话中实现“读己之所写”的一致性，也就是说，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。</p><h5 id="d-单调读一致性："><a href="#d-单调读一致性：" class="headerlink" title="d.单调读一致性："></a>d.单调读一致性：</h5><p>​        单调读一致性是指如果一个进程从系统中读取出一个数据项的某个值后，那么系统对于该进程后续的任何数据访问都不应该返回更旧的值。</p><h5 id="e-单调写一致性："><a href="#e-单调写一致性：" class="headerlink" title="e.单调写一致性："></a>e.单调写一致性：</h5><p>​         单调写一致性是指，一个系统需要能够保证来自同一个进程的写操作被顺序地执行。</p><p>最终一致性并不是只有那些大型分布式系统的专属，许多现代的关系型数据库都采用了最终一致性模型。主要体现在数据库的主从热备，读写分离等场景，大多都会采用同步和异步方式来实现主备数据复制技术。在同步方式中，数据的同步通常是写在一个事务中，因此在事务完成后，主备数据库的数据就会达到一致。而在异步方式中，备库的更新往往存在延时，这取决于网络IO的时间，如果时间过长或者甚至在日志传输过程中出现异常导致无法及时将事务应用到备库上，那么很显然，从备库中读取的的数据是旧的，因此就出现了不一致的情况。无论是采用多次重试，关系型数据库还是能搞保证最终数据达到一致——这就是系统提供最终一致性保证的经典案例。 </p></li></ul><h4 id="2-可用性"><a href="#2-可用性" class="headerlink" title="(2) . 可用性"></a>(2) . 可用性</h4><p>  可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。这里的重点是”有限时间内”和”返回结果”。”有限时间内”是指，对于用户的一个操作请求，系统必须能够在指定的时间内返回对 应的处理结果，比如一秒或是五秒，如果超过了这个时间范围，那么系统就被认为是不可用的。另外，”有限的时间内”是指系统设计之初就设计好的运行指标，通常不同系统之间有很 大的不同，无论如何，对于用户请求，系统必须存在一个合理的响应时间，否则用户便会对系统感到失望。”返回结果”是可用性的另一个非常重要的指标，它要求系统在完成对用户请求的处理后，返回一个正常的响应结果。即成功或失败，而不是一个让用户感到困惑的返回结果。</p><h4 id="3-分区容忍性"><a href="#3-分区容忍性" class="headerlink" title="(3) . 分区容忍性"></a>(3) . 分区容忍性</h4><p>这个词单从字面上有点难以理解它的意思，我的理解：在分布式系统中会出现一些局部小集群，这些局部网络的节点与集群中正常的节点不能通信，导致数据出现不一致的情况。举个例子，假设100个节点的集群，其中有20个节点由于网络波动或是其它原因，导致这20个节点不能与另外的80个节点通信，我们称这20个节点是一个局部小集群（专业术语称之为网络分区，实际情况集群可能出现多个网络分区）。由于不能通信导致，用户在向集群中存储数据时，这20节点不能同步集群的数据而出现数据不一致的情况。分区容忍性描述的就是这种情况，所谓容忍性就是在设计集群时，容忍或是不容忍出现这种情况，如果不容忍是牺牲了可用性，因为集群一旦出现网络分区，则意味着集群必须实现数据的一致性，这会使得集群一直等待，直到集群中那20个节点数据同步完成，这个等待的时间也是不确定的，意味着牺牲了集群的可用性。如果容忍出现这种情况，容忍的程度是多大，而且需要采取一定的策略在那20个节点正常通信后，完成集群的数据同步，这里则是牺牲了数据的一致性，而提高了集群的可性。</p><h3 id="3-分布式环境的各种问题"><a href="#3-分布式环境的各种问题" class="headerlink" title="3 . 分布式环境的各种问题"></a>3 . 分布式环境的各种问题</h3><h4 id="1、网络分区"><a href="#1、网络分区" class="headerlink" title="1、网络分区"></a>1、网络分区</h4><p>当网络由于发生异常或波动情况，导致分布式系统中部分节点之间的网络延时不断增大，导致整个集群节点中，只有部分节点之间能够正常通信，而另一些节点则不能，我们将这个现象称为网络分区。当网络分区出现时，对集群的数据一致性，数据的事物处理，造成了非常大的挑战</p><h4 id="2、节点故障"><a href="#2、节点故障" class="headerlink" title="2、节点故障"></a>2、节点故障</h4><p>节点故障则是分布式环境下另一个比较常见的问题，指的是组成分布式系统的服务器节点出现的宕机或”假死”现象，通常根据经验来说，每个节点都有可能出现故障，并且每天都在发生</p><h4 id="3、三态"><a href="#3、三态" class="headerlink" title="3、三态"></a>3、三态</h4><p>在传统单机系统中，应用程序处理请求只有两种状态，要么成功，要么失败。而在集群中则多了一种状态超时，而且超时是一个非常普遍的现象，出现超时现象，通常有以下两种情况<br>（1）由于网络原因，该请求并没有被成功地发送到接收方，而是在发送过程中就发生了消息丢失现象<br>（2）该请求成功地被接收方接收后，进行了处理，但是在将响应反馈给发送方的过程中，发生了消息丢失现象<br>当出现这样的超时现象时，网络通信的发起方是无法确定当前请求是否被成功处理。因而在集群设计之初就必须假定集群中节点是不稳定的，网络是不可靠的，这样才能设计出一个良好的分布式系统，在很多分布式框架中如Kafka,Zookeeper都有类似情况的处理方式，值得借鉴。</p><h3 id="4-CAP的权衡"><a href="#4-CAP的权衡" class="headerlink" title="4 . CAP的权衡"></a>4 . CAP的权衡</h3><table><thead><tr><th>选择</th><th>说明</th></tr></thead><tbody><tr><td>CA</td><td>放弃分区容错性，加强一致性和可用性，就是传统的单机数据库的选择</td></tr><tr><td>AP</td><td>放弃强一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择，如NOSQL</td></tr><tr><td>CP</td><td>放弃可用性，追求一致性和分区容错性</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 分布式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>虚拟机指令集</title>
      <link href="/2018/06/10/xu-ni-ji-zhi-ling-ji/"/>
      <url>/2018/06/10/xu-ni-ji-zhi-ling-ji/</url>
      
        <content type="html"><![CDATA[<p>​    Java虚拟机既然是一台虚拟的计算机，那必有一套完善指令集，指令由一个字节长度，代表某种特定操作含义的操作码构成。这里在最初接触计算机的时候，我是有一些疑问的。例如为什么计算机都有它的指令集，这些指令是怎么被CPU执行的。由于我当初学的是电子科学，包含模电数电，单片机等内容，其中单片机就是一个小型的片上系统，随着学习的深入这些疑问自然就迎刃而解了。我谈一下自己的理解，也顺便做一下记录。</p><p>​    对于CPU而言它只认识0和1，对应的是数字电路中的高低电平，实现原理是把MOS管当做开关使用，MOS管是一种半导体晶体管，主要成分硅（这也是美国硅谷这个名字的由来吧）。通过MOS管可以实现各种寄存器，累加器，计数器，与非门，或非门等逻辑门电路。每一条指令都是特定的门电路组成的，门电路是CPU的基本工作单元，数以亿计的门电路才造就了CPU的强大运算能力，这些门电路输入是一位或多位二进制数，输出也是一位或多位二进制数。在最早的计算机上，程序员需要将0101这种二进制代码给CPU计算，这里的二进制代码会控制CPU进行加减乘除或者逻辑运算，对应于在MOS管上的状态就是开和关，这种二进制代码也叫机器语言，是计算机能直接读懂的语言。但是这对于程序员来说简直是噩梦，一个小小的计算功能，用机器语言来编写需要写一大串0和1。最关键的是这些0和1代码代表什么意思也非常难以记忆，开发成本很大。于是科学家们用了一种高级的语言来代替它 ，然后汇编语言诞生了，汇编语言更接近人类自然语言的习惯。然后再做一个编译器工具帮我们把汇编语言翻译成机器语言就行了。    </p><a id="more"></a> <p>​    那么问题来了，编译器按照什么规则来翻译汇编代码呢？答案就是指令集，指令集是由设计CPU的生产厂商给出。CPU指令集是描述CPU能实现什么功能的一个集合, 就是描述”CPU能使用哪些机器码”的集合。指令集的作用, 就是告诉程序员或者说编译器, 汇编一定要有什么格式. 支持什么指令, 指令带什么限制条件, 用什么操作数, 用什么地址, 都是指令集规范的内容, 要是写错了, 就无法翻译成机器码。不同的CPU生产厂商产生了不同的指令集，Intel阵营的8086指令集，ARM阵营的RISC指令集。不同阵营，其对应的汇编语言也是不一样的。 </p><h3 id="1-JVM的指令集"><a href="#1-JVM的指令集" class="headerlink" title="1 . JVM的指令集"></a>1 . JVM的指令集</h3><p>​    前面说了那么多，都是为这里做铺垫。作为一个Java程序员怎么能不认识虚拟机的指令集，指令集不仅可以帮我们看懂字节码文件，同时也有助于理解JVM的运行原理。我总结了一下JVM的指令集，主要分为以下几种类型的指令。</p><h4 id="1-空指令"><a href="#1-空指令" class="headerlink" title="(1) . 空指令"></a>(1) . 空指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x00</td><td>nop</td><td>什么都不做</td></tr></tbody></table><p>nop指令相信接触过汇编语言的都知道，它什么都不做但是占用一个指令周期的时间。指令周期的时间不是固定的，不同的指令其指令周期时间不同，一个指令周期由如干个机器周期组成，每个机器周期能完成一项基本操作，比如取指令、存储器读、存储器写等。而机器周期又由如干个时钟周期组成，在一个时钟周期内，CPU只能完成一个最基本的动作，一个时钟周期的时间计算也比较简单，例如CPU的频率是2.7GHz，这里要注意换算单位，频率单位1GHz =1000MHz，1MHz就是1百万赫兹，所以频率为2.7GHz的CPU。一个时钟周期为 1/2700000000 秒 。 显然，时钟频率越高，CPU的工作速度就越快，这也是我们购买CPU时的一个重要指标。 </p><h4 id="2-基本数据类型的取值和存储指令"><a href="#2-基本数据类型的取值和存储指令" class="headerlink" title="(2) . 基本数据类型的取值和存储指令"></a>(2) . 基本数据类型的取值和存储指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x01</td><td>aconst_null</td><td>将null推送至栈顶</td></tr><tr><td>0x02</td><td>iconst_m1</td><td>将int型-1推送至栈顶</td></tr><tr><td>0x0i（i=3,4,5,6,7,8）</td><td>iconst_j（j=0,1,2,3,4,5）</td><td>将int型 j 推送至栈顶</td></tr><tr><td>0x0i（i=9,a）</td><td>lconst_j（j=0,1）</td><td>将long型 j 推送至栈顶</td></tr><tr><td>0x0i（i=b,c,d）</td><td>fconst_j（j=0,1,2）</td><td>将float型 j 推送至栈顶</td></tr><tr><td>0x0i（ie,f）</td><td>dconst_j（j=0,1）</td><td>将double型 j 推送至栈顶</td></tr><tr><td>0x10</td><td>bipush</td><td>将单字节常量(-127~128)推送至栈顶</td></tr><tr><td>0x11</td><td>sipush</td><td>将短整型常量(-32768~32767)推至栈顶</td></tr><tr><td>0x12</td><td>ldc</td><td>将int,float,String常量从常量池中推至栈顶</td></tr><tr><td>0x13</td><td>ldc_w</td><td>将int,float,String常量从常量池中推至栈顶(宽索引)</td></tr><tr><td>0x14</td><td>ldc2_w</td><td>将long,double常量从常量池中推至栈顶(宽索引)</td></tr><tr><td>0x15</td><td>iload</td><td>将指定的int型局部变量推至栈顶</td></tr><tr><td>0x16</td><td>lload</td><td>将指定的long型局部变量推至栈顶</td></tr><tr><td>0x17</td><td>fload</td><td>将指定的float型局部变量推至栈顶</td></tr><tr><td>0x18</td><td>dload</td><td>将指定的double型局部变量推至栈顶</td></tr><tr><td>0x1i（i=a,b,c,d）</td><td>iload_j（j=0,1,2,3）</td><td>将第 j 个int型的局部变量推至栈顶</td></tr><tr><td>0x1i（i=e,f）</td><td>lload_j（j=0,1）</td><td>将第 j 个long 型局部变量推至栈顶</td></tr><tr><td>0x2i（i=0,1）</td><td>lload_j（j=3,4）</td><td>将第 j 个long 型局部变量推至栈顶</td></tr><tr><td>0x2i（i=2,3,4,5）</td><td>fload_j（j=0,1,2,3）</td><td>将第 j 个float 型局部变量推至栈顶</td></tr><tr><td>0x2i（i=6,7,8,9）</td><td>dload_j（j=0,1,2,3）</td><td>将第 j 个double 型局部变量推至栈顶</td></tr><tr><td>0x36</td><td>istore</td><td>将栈顶 int 型数值存入指定的本地变量</td></tr><tr><td>0x37</td><td>lstore</td><td>将栈顶 long 型数值存入指定的本地变量</td></tr><tr><td>0x39</td><td>dstore</td><td>将栈顶 dloat 型数值存入指定的本地变量</td></tr><tr><td>0x38</td><td>fstore</td><td>将栈顶 float 型数值存入指定的本地变量</td></tr><tr><td>0x3i（i=b,c,d,e）</td><td>istore_j（j=0,1,2,3）</td><td>将栈顶 int 型数值存入第 j 个本地变量</td></tr><tr><td>0x3f</td><td>lstore_0</td><td>将栈顶 long 型数值存入第 0 个本地变量</td></tr><tr><td>0x4i（i=0,1,2）</td><td>lstore_j（j=1,2,3）</td><td>将栈顶 long 型数值存入第 j 个本地变量</td></tr><tr><td>0x4i（i=3,4,5,6）</td><td>fstore_j（j=0,1,2,3）</td><td>将栈顶 float 型数值存入第 j 个本地变量</td></tr><tr><td>0x4i（i=7,8,9,a）</td><td>dstore_j（j=0,1,2,3）</td><td>将栈顶 double 型数值存入第 j 个本地变量</td></tr><tr><td>0xc4</td><td>wide</td><td>扩展本地变量的宽度</td></tr></tbody></table><p>总的概括来说就是  </p><p>将一个本地变量加载到操作数栈的指令有 </p><pre><code>iload、iload_&lt;n&gt;、lload、lload_&lt;n&gt;、fload、fload_&lt;n&gt;、dload、dload_&lt;n&gt;、aload、aload_&lt;n&gt;</code></pre><p>将一个数值从操作数栈存储到本地变量表的指令由</p><pre><code>istore、istore_&lt;n&gt;、lstore、lstore_&lt;n&gt;、fstore、fstore_&lt;n&gt;、dstore、dstore_&lt;n&gt;、astore、astore_&lt;n&gt;</code></pre><p>将一个常量加载到操作数栈的指令有  </p><pre><code>bipush、sipush、ldc、ldc_w、ldc2_w、aconst_null、iconst_m1、iconst_&lt;i&gt;、lconst_&lt;l&gt;、fconst_&lt;f&gt;、dconst_&lt;d&gt;</code></pre><p>扩充局部变量表的访问索引的指令 </p><pre><code>wide</code></pre><p>这里要注意的是随着数值取值范围的改变，指令会随之改变。例如当int取值<strong>-1~5</strong>采用iconst指令，取值<strong>-128~127</strong>采用bipush指令，取值<strong>-32768~32767</strong>采用sipush指令，取值<strong>-2147483648~2147483647</strong>采用 ldc 指令 </p><h4 id="3-引用数据类型的取值与存储操作"><a href="#3-引用数据类型的取值与存储操作" class="headerlink" title="(3) . 引用数据类型的取值与存储操作"></a>(3) . 引用数据类型的取值与存储操作</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x19</td><td>aload</td><td>将指定的引用数据类型本地变量推至栈顶</td></tr><tr><td>0x2i（i=a,b,c,d）</td><td>aload_j（j=0,1,2,3）</td><td>将第 j 个引用类型本地变量推至栈顶</td></tr><tr><td>0x2e</td><td>iaload</td><td>将int型数组指定的索引的值推至栈顶</td></tr><tr><td>0x2f</td><td>laload</td><td>将long型数组指定的索引的值推至栈顶</td></tr><tr><td>0x30</td><td>faload</td><td>将float型数组指定的索引的值推至栈顶</td></tr><tr><td>0x31</td><td>daload</td><td>将double型数组指定的索引的值推至栈顶</td></tr><tr><td>0x32</td><td>aaload</td><td>将引用数据类型数组指定的索引的值推至栈顶</td></tr><tr><td>0x33</td><td>baload</td><td>将boolean或byte型数组指定的索引的值推至栈顶</td></tr><tr><td>0x34</td><td>caload</td><td>将char型数组指定的索引的值推至栈顶</td></tr><tr><td>0x35</td><td>saload</td><td>将short型数组指定的索引的值推至栈顶</td></tr><tr><td>0x3a</td><td>astore</td><td>将栈顶的引用型数值存入指定的本地变量</td></tr><tr><td>0x4i（i=b,c,d,e）</td><td>astore_j（j=0,1,2,3）</td><td>将栈顶引用型数值存入第 j 个本地变量</td></tr><tr><td>0x4f</td><td>iastore</td><td>将栈顶 int 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x50</td><td>lastore</td><td>将栈顶 long 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x51</td><td>fastore</td><td>将栈顶 float 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x52</td><td>dastore</td><td>将栈顶 double 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x53</td><td>aastore</td><td>将栈顶引用型数值存入指定数组的指定索引位置</td></tr><tr><td>0x54</td><td>bastore</td><td>将栈顶boolean或byte型数值存入指定数组的指定索引位置</td></tr><tr><td>0x55</td><td>castore</td><td>将栈顶 char 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x56</td><td>sastore</td><td>将栈顶 short 型数值存入指定数组的指定索引位置</td></tr><tr><td>0x57</td><td>pop</td><td>将栈顶弹出（数值不能是 long 或 double类型）</td></tr><tr><td>0xbb</td><td>new</td><td>创建一个对象，并将其压入栈顶</td></tr><tr><td>0xbc</td><td>newarray</td><td>创建一个基本数据类型（如int,char）的数组，并将其引用的值压入栈顶</td></tr><tr><td>0xbd</td><td>anewarray</td><td>创建一个引用型数组（如类，接口，数组），并将其引用的值压入栈顶</td></tr><tr><td>0xc5</td><td>multianewarray</td><td>创建指定类型和指定维度的多维数组，并将其引用值压入栈顶</td></tr><tr><td>0xbe</td><td>arraylength</td><td>获取数组长度值并压入栈顶</td></tr><tr><td>0xc0</td><td>checkcast</td><td>校验类型转换，校验未通过抛出ClassCastException</td></tr><tr><td>0xc1</td><td>instanceof</td><td>校验对象是否是指定的类的实例，如果是，则将1压入栈顶，否则将0压入栈顶</td></tr><tr><td>0xb2</td><td>getstatic</td><td>获取指定类的静态域，并将其值压人栈顶</td></tr><tr><td>0xb3</td><td>putstatic</td><td>为指定的类的静态域赋值</td></tr><tr><td>0xb4</td><td>getfield</td><td>获取指定类的实例域，并将其压入栈顶</td></tr><tr><td>0xb5</td><td>putfield</td><td>为指定类的实例域赋值</td></tr></tbody></table><p>这里总结概括一下，创建实例的指令</p><pre><code>new</code></pre><p>创建数组对象以及获取数组长度的指令</p><pre><code>newarray、anewarray、multianewarray、arraylength</code></pre><p>访问类字段（static字段就是类变量）和实例字段（非static字段就是实例变量）指令</p><pre><code>getfield、putfield、getstatic、putstatic</code></pre><p>把一个数组中指定索引处的值加载到操作数栈的指令 </p><pre><code>baload、caload、saload、iaload、laload、faload、daload、aaload</code></pre><p>将一个操作数栈的值储存到数组中指定索引处的指令 </p><pre><code>bastore、castore、sastore、iastore、fastore、dastore、aastore</code></pre><p>检查类实例类型的指令 </p><pre><code>instanceof、checkcast</code></pre><p>虽然实例和数组都是对象，但是虚拟机对实例和数组实例的创建与操作使用了不同的字节码指令 </p><h4 id="4-操作数栈管理指令"><a href="#4-操作数栈管理指令" class="headerlink" title="(4) . 操作数栈管理指令"></a>(4) . 操作数栈管理指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x57</td><td>pop</td><td>将栈顶弹出（数值不能是 long 或 double类型）</td></tr><tr><td>0x58</td><td>pop2</td><td>将栈顶一个（对于 long 或double类型）或两个（非 long 或double类型）数值弹出</td></tr><tr><td>0x59</td><td>dup</td><td>复制栈顶数值并将复制值压入栈顶</td></tr><tr><td>0x5a</td><td>dup_x1</td><td>复制栈顶数值并将两个复制值压入栈顶</td></tr><tr><td>0x5f</td><td>swap</td><td>将栈最顶端的两数值互换（数值不能是 long 或 double类型）</td></tr><tr><td>0x5b</td><td>dup_x2</td><td>复制栈顶数值并将三个（或两个）复制值压入栈顶</td></tr><tr><td>0x5c</td><td>dup2</td><td>复制栈顶一个(对于 long 或double类型)或两个(非 long 或double类型)值并压栈</td></tr><tr><td>0x5d</td><td>dup2_x1</td><td>dup_x1 指令的双倍版本</td></tr><tr><td>x05e</td><td>dup2_x2</td><td>dup_x2 指令的双倍版本</td></tr></tbody></table><h4 id="5-控制转移指令"><a href="#5-控制转移指令" class="headerlink" title="(5) . 控制转移指令"></a>(5) . 控制转移指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x99</td><td>ifeq</td><td>当栈顶int型数值等于0时跳转</td></tr><tr><td>0x9a</td><td>ifnq</td><td>当栈顶int型数值不等于0时跳转</td></tr><tr><td>0x9b</td><td>iflt</td><td>当栈顶int型数值小于0时跳转</td></tr><tr><td>0x9c</td><td>ifge</td><td>当栈顶int型数值小于或等于0时跳转</td></tr><tr><td>0x9d</td><td>ifgt</td><td>当栈顶int型数值大于0时跳转</td></tr><tr><td>0x9e</td><td>ifle</td><td>当栈顶int型数值小于或等于0时跳转</td></tr><tr><td>0x9f</td><td>if_icmpeq</td><td>比较栈顶两个int型数值的大小，结果等于0时跳转</td></tr><tr><td>0xa0</td><td>if_icmpne</td><td>比较栈顶两个int型数值的大小，结果不等于0时跳转</td></tr><tr><td>0xa1</td><td>if_icmplt</td><td>比较栈顶两个int型数值的大小，结果小于0时跳转</td></tr><tr><td>0xa2</td><td>if_icmpge</td><td>比较栈顶两个int型数值的大小，结果大于或等于0时跳转</td></tr><tr><td>0xa3</td><td>if_icmpgt</td><td>比较栈顶两个int型数值的大小，结果大于0时跳转</td></tr><tr><td>0xa4</td><td>if_icmple</td><td>比较栈顶两个int型数值的大小，结果小于或等于0时跳转</td></tr><tr><td>x0a5</td><td>if_acmpeq</td><td>比较栈顶两个引用型数值，结果相等时跳转</td></tr><tr><td>0xa6</td><td>if_acmpne</td><td>比较栈顶两个引用型数值，结果不相等时跳转</td></tr><tr><td>0xa7</td><td>goto</td><td>无条件跳转</td></tr><tr><td>0xa8</td><td>jsr</td><td>跳转至指定的16位offset位置，并将jsr的下一条指令地址压入栈顶</td></tr><tr><td>0xa9</td><td>ret</td><td>返回至本地变量指定的index的指令位置（一般与 jsr 或 jsr_w联合使用）</td></tr><tr><td>0xaa</td><td>tableswitch</td><td>用于switch条件跳转，case值连续（可变长度指令）</td></tr><tr><td>0xab</td><td>lookupswitch</td><td>用于switch条件跳转，case值不连续（可变长度指令）</td></tr><tr><td>0xc6</td><td>ifnull</td><td>为null时跳转</td></tr><tr><td>0xc7</td><td>ifnonull</td><td>不为null时跳转</td></tr><tr><td>oxc8</td><td>goto_w</td><td>无条件跳转（宽索引）</td></tr><tr><td>0xc9</td><td>jsr_w</td><td>跳转至指定32位offset位置，并将jsr_w的下一条指令地址压入栈顶</td></tr></tbody></table><p>条件分支 </p><pre><code>ifeq、iflt、ifle、ifne、ifgt、ifge、ifnull、ifnonnull、if_icmpeq、if_icmpne、if_icmplt、 if_icmpgt、if_icmple、if_icmpge、if_acmpeq、if_acmpne</code></pre><p>复合条件分支 </p><pre><code>tableswitch、lookupswitch</code></pre><p>无条件分支 </p><pre><code>goto、goto_w、jsr、jsr_w、ret</code></pre><p>Java条件分支比较包括三种类型值的比较，int类型，reference 类型，null 值。而其它boolean 类型、byte 类型、char 类型和 short 类型的条件分支比较操作，都使用 int 类型的比较指令来完成，而对于 long 类型、float 类型和 double 类型的条件分支比较操作，则会先执行相应类型的比较运算指令，运算指令会返回一个整型值到操作数栈中，随后再执行 int 类型的条件分支比较操作来完成整个分支跳转。由于各种类型的比较最终都会转化为 int 类型的比较操作，所以Java 虚拟机提供了非常丰富的 int类型的条件分支指令。另外所有 int 类型的条件分支转移指令进行的都是有符号的比较操作。</p><h4 id="6-线程同步"><a href="#6-线程同步" class="headerlink" title="(6) . 线程同步"></a>(6) . 线程同步</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0xc2</td><td>monitorenter</td><td>获得对象的锁，用于同步方法或同步代码块</td></tr><tr><td>0xc3</td><td>monitorexit</td><td>释放对象的锁，用于同步方法或同步代码块</td></tr></tbody></table><p>Java 虚拟机可以支持方法级的同步和方法内一段代码块的同步，这两种同步结构都是使用监视器 （monitor）来支持实现的。</p><p>方法级的同步是隐式，即无需通过字节码指令来控制的，它实现在方法调用和返回操作之中。虚拟机可以从方法常量池中的方法表结构（method_info Structure）中的 ACC_SYNCHRONIZED 访问标志区分一个方法是否同步方法。当方法调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先持有管程，然后再执行方法，最后再方法完成（无论是正常完成还是非正常完成）时释放管程。在方法执行期间，执行线程持有了管程，其他任何线程都无法再获得同一个管程。如果一个同步方法执行期间抛出了异常，并且在方法内部无法处理此异常，那这个同步方法所持有的管程将在异常抛到同步方法之外时自动释放</p><h4 id="7-运算指令"><a href="#7-运算指令" class="headerlink" title="(7) . 运算指令"></a>(7) . 运算指令</h4><table><thead><tr><th>字节码</th><th>助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x60</td><td>iadd</td><td>将栈顶两个 int 型数值相加并将结果压入栈顶</td></tr><tr><td>0x61</td><td>ladd</td><td>将栈顶两个 long 型数值相加并将结果压入栈顶</td></tr><tr><td>0x62</td><td>fadd</td><td>将栈顶两个 float 型数值相加并将结果压入栈顶</td></tr><tr><td>0x63</td><td>dadd</td><td>将栈顶两个 double 型数值相加并将结果压入栈顶</td></tr><tr><td>0x64</td><td>isub</td><td>将栈顶两个 int 型数值相减并将结果压入栈顶</td></tr><tr><td>0x65</td><td>lsub</td><td>将栈顶两个 long 型数值相减并将结果压入栈顶</td></tr><tr><td>0x66</td><td>fsub</td><td>将栈顶两个 float 型数值相减并将结果压入栈顶</td></tr><tr><td>0x67</td><td>dsub</td><td>将栈顶两个 double 型数值相减并将结果压入栈顶</td></tr><tr><td>0x68</td><td>imul</td><td>将栈顶两个 int 型数值相乘并将结果压入栈顶</td></tr><tr><td>x069</td><td>lmul</td><td>将栈顶两个 long 型数值相乘并将结果压入栈顶</td></tr><tr><td>0x6a</td><td>fmul</td><td>将栈顶两个 float 型数值相乘并将结果压入栈顶</td></tr><tr><td>0x6b</td><td>dmul</td><td>将栈顶两个 double 型数值相乘并将结果压入栈顶</td></tr><tr><td>0x6c</td><td>idiv</td><td>将栈顶两个 int 型数值相除并将结果压入栈顶</td></tr><tr><td>0x6d</td><td>ldiv</td><td>将栈顶两个 long 型数值相除并将结果压入栈顶</td></tr><tr><td>0x6e</td><td>fdiv</td><td>将栈顶两个 float 型数值相除并将结果压入栈顶</td></tr><tr><td>0x6f</td><td>ddiv</td><td>将栈顶两个 double 型数值相除并将结果压入栈顶</td></tr><tr><td>0x70</td><td>irem</td><td>将栈顶两个int 型数值作取模运算并将结果压入栈顶</td></tr><tr><td>0x71</td><td>lrem</td><td>将栈顶两个long 型数值作取模运算并将结果压入栈顶</td></tr><tr><td>0x72</td><td>frem</td><td>将栈顶两个float 型数值作取模运算并将结果压入栈顶</td></tr><tr><td>0x73</td><td>drem</td><td>将栈顶两个double 型数值作取模运算并将结果压入栈顶</td></tr><tr><td>0x74</td><td>ineg</td><td>将栈顶两个int 型数值取负并将结果压入栈顶</td></tr><tr><td>0x75</td><td>lneg</td><td>将栈顶两个long 型数值取负并将结果压入栈顶</td></tr><tr><td>0x76</td><td>fneg</td><td>将栈顶两个float 型数值取负并将结果压入栈顶</td></tr><tr><td>0x77</td><td>dneg</td><td>将栈顶两个double 型数值取负并将结果压入栈顶</td></tr><tr><td>0x78</td><td>ishl</td><td>将 int 型数值取左移指定位数并将结果压入栈顶</td></tr><tr><td>0x79</td><td>lshl</td><td>将 long 型数值取左移指定位数并将结果压入栈顶</td></tr><tr><td>0x7a</td><td>ishr</td><td>将 int 型数值（带符号）取右移指定位数并将结果压入栈顶</td></tr><tr><td>0x7b</td><td>lshr</td><td>将 long 型数值（带符号）取右移指定位数并将结果压入栈顶</td></tr><tr><td>0x7c</td><td>iushr</td><td>将 int 型数值（无符号）取右移指定位数并将结果压入栈顶</td></tr><tr><td>0x7d</td><td>lushr</td><td>将 long 型数值（无符号）取右移指定位数并将结果压入栈顶</td></tr><tr><td>0x7e</td><td>iand</td><td>将栈顶两 int 型数值作 按位与 并将结果压入栈顶</td></tr><tr><td>0x7f</td><td>land</td><td>将栈顶两 long 型数值作 按位与 并将结果压入栈顶</td></tr><tr><td>0x80</td><td>ior</td><td>将栈顶两 int 型数值作 按位或 并将结果压入栈顶</td></tr><tr><td>0x81</td><td>lor</td><td>将栈顶两 long 型数值作 按位或 并将结果压入栈顶</td></tr><tr><td>0x82</td><td>ixor</td><td>将栈顶两 int 型数值作 按位异或 并将结果压入栈顶</td></tr><tr><td>0x83</td><td>lxor</td><td>将栈顶两 long 型数值作 按位异或 并将结果压入栈顶</td></tr><tr><td>0x84</td><td>iinc</td><td>将指定int 型数值增加指定值（如 i++，i–，j += 1等）</td></tr><tr><td>0x94</td><td>lcmp</td><td>比较栈顶两long型数值大小，并将结果（1，0，-1）压入栈顶</td></tr><tr><td>0x95</td><td>fcmpl</td><td>比较栈顶两float型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将-1压入栈顶</td></tr><tr><td>0x96</td><td>fcmpg</td><td>比较栈顶两 float 型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将1压入栈顶</td></tr><tr><td>0x97</td><td>dcmpl</td><td>比较栈顶两double 型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将-1压入栈顶</td></tr><tr><td>0x98</td><td>dcmpg</td><td>比较栈顶两 double 型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将1压入栈顶</td></tr></tbody></table><p>概括来说就是下面这几种分类</p><p>加法指令：iadd、ladd、fadd、dadd<br>减法指令：isub、lsub、fsub、dsub<br>乘法指令：imul、lmul、fmul、dmul<br>除法指令：idiv、ldiv、fdiv、ddiv<br>求余指令：irem、lrem、frem、drem<br>取反指令：ineg、lneg、fneg、dneg<br>位移指令：ishl、ishr、iushr、lshl、lshr、lushr<br>按位或指令：ior、lor<br>按位与指令：iand、land<br>按位异或指令：ixor、lxor<br>局部变量自增指令：iinc<br>比较指令：dcmpg、dcmpl、fcmpg、fcmpl、lcmp </p><p>Java 虚拟机没有明确规定整型数据溢出的情况，但是规定了在处理整型数据时，只有除法指令（idiv 和 ldiv）以及求余指令（irem 和 lrem）出现除数为零时会导致虚拟机抛出异常，如果发生了这种情况，虚拟机将会抛出 ArithmeitcException 异常。 例如下面的代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> num <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE <span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//获得int的最大值</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num = "</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num+1 = "</span><span class="token operator">+</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num+2 = "</span><span class="token operator">+</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>得到的结果</p><pre><code>num = 2147483647num+1 = -2147483648num+2 = -2147483647</code></pre><p>这段代码获取了int型数据的最大值，并在最大值的基础上进行了加法运算，程序不会报错，但结果和预期却截然相反，其原因就是整型数据出现了溢出。</p><p>Java 虚拟机在处理浮点数运算时，不会抛出任何运行时异常，当一个操作产生溢出时，将会使用有符号的无穷大来表示，如果某个操作结果没有明确的数学定义的话，将会时候 NaN 值来表示。所有使用 NaN 值作为操作数的算术操作，结果都会返回 NaN 。</p><h4 id="8-类型转换指令"><a href="#8-类型转换指令" class="headerlink" title="(8) . 类型转换指令"></a>(8) . 类型转换指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0x85</td><td>i2l</td><td>将栈顶 int 型数值强制转换成 long 型数值并将结果压入栈顶</td></tr><tr><td>0x86</td><td>i2f</td><td>将栈顶 int 型数值强制转换成 float 型数值并将结果压入栈顶</td></tr><tr><td>0x87</td><td>i2d</td><td>将栈顶 int 型数值强制转换成 double 型数值并将结果压入栈顶</td></tr><tr><td>0x88</td><td>l2i</td><td>将栈顶 long 型数值强制转换成 int 型数值并将结果压入栈顶</td></tr><tr><td>0x89</td><td>l2f</td><td>将栈顶 long 型数值强制转换成 float 型数值并将结果压入栈顶</td></tr><tr><td>0x8a</td><td>l2d</td><td>将栈顶 long 型数值强制转换成 double 型数值并将结果压入栈顶</td></tr><tr><td>0x8b</td><td>f2i</td><td>将栈顶 float 型数值强制转换成 int 型数值并将结果压入栈顶</td></tr><tr><td>0x8c</td><td>f2l</td><td>将栈顶 float 型数值强制转换成 long 型数值并将结果压入栈顶</td></tr><tr><td>0x8d</td><td>f2d</td><td>将栈顶 float 型数值强制转换成 double 型数值并将结果压入栈顶</td></tr><tr><td>0x8e</td><td>d2i</td><td>将栈顶 double 型数值强制转换成 int 型数值并将结果压入栈顶</td></tr><tr><td>0x8f</td><td>d2l</td><td>将栈顶 double 型数值强制转换成 long 型数值并将结果压入栈顶</td></tr><tr><td>0x90</td><td>d2f</td><td>将栈顶 double 型数值强制转换成 float 型数值并将结果压入栈顶</td></tr><tr><td>0x91</td><td>i2b</td><td>将栈顶 int 型数值强制转换成 byte 型数值并将结果压入栈顶</td></tr><tr><td>0x92</td><td>i2c</td><td>将栈顶 int 型数值强制转换成 char 型数值并将结果压入栈顶</td></tr><tr><td>0x93</td><td>i2s</td><td>将栈顶 int 型数值强制转换成 short 型数值并将结果压入栈顶</td></tr></tbody></table><p>这里需要注意的是强制转换可能会丢失精度的问题</p><h4 id="9-方法调用与返回指令"><a href="#9-方法调用与返回指令" class="headerlink" title="(9) . 方法调用与返回指令"></a>(9) . 方法调用与返回指令</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0xb6</td><td>invokevirtual</td><td>调用实例方法</td></tr><tr><td>0xb7</td><td>invokespecial</td><td>调用超类构造方法，实例初始化方法，私有方法</td></tr><tr><td>0xb8</td><td>invokestatic</td><td>调用静态方法</td></tr><tr><td>0xb9</td><td>invokeinterface</td><td>调用接口方法</td></tr><tr><td>0xba</td><td>invokedynamic</td><td>调用动态方法</td></tr><tr><td>0xac</td><td>ireturn</td><td>从当前方法返回 int</td></tr><tr><td>0xad</td><td>lreturn</td><td>从当前方法返回 long</td></tr><tr><td>0xae</td><td>freturn</td><td>从当前方法返回 float</td></tr><tr><td>0xaf</td><td>dreturn</td><td>从当前方法返回 double</td></tr><tr><td>0xb1</td><td>areturn</td><td>从当前方法返回对象引用</td></tr></tbody></table><p>invokevirtual 指令用于调用对象的实例方法，根据对象的实际类型进行分派（虚方法分派），这也是 Java 语言中最常见的方法分派方式。 返回类型中 ，返回类型为boolean、byte、char、short 和 int 类型时都通过ireturn指令实现。</p><h4 id="10-异常"><a href="#10-异常" class="headerlink" title="(10) . 异常"></a>(10) . 异常</h4><table><thead><tr><th>字节码</th><th>指令助记符</th><th>指令含义</th></tr></thead><tbody><tr><td>0xbf</td><td>athrow</td><td>将栈顶的异常抛出</td></tr></tbody></table><h3 id="2-如何通过class文件查看指令代码"><a href="#2-如何通过class文件查看指令代码" class="headerlink" title="2 . 如何通过class文件查看指令代码"></a>2 . 如何通过class文件查看指令代码</h3><p>这个方法通过一个指令即可，以windows系统为例，首先打开windows的终端，然后进入到.class文件所在的目录，通过 javap -c 文件名 即可查看指令代码。例如下面的代码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> m2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> m0 <span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a1 <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a2 <span class="token operator">=</span> <span class="token number">32768</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> k1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> k2 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        Integer ii <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span><span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Test<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">int</span> x <span class="token operator">=</span> m<span class="token operator">/</span>n<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>然后通过打开终端</p><p><img src="/2018/06/10/xu-ni-ji-zhi-ling-ji/jvmcode1.png" alt></p><p>回车之后就可以看到指令代码了，具体结果如下</p><pre><code>F:\workSpace\ideaSpace\busted\out\production\busted\com\lsj\test&gt;javap -c TestCompiled from &quot;Test.java&quot;public class com.lsj.test.Test {  public com.lsj.test.Test();    Code:       0: aload_0       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V       4: return  public static void main(java.lang.String[]);    Code:       0: iconst_m1       1: istore_1       2: iconst_5       3: istore_2       4: iconst_2       5: istore_3       6: bipush        6       8: istore        4      10: sipush        128      13: istore        5      15: ldc           #2                  // int 32768      17: istore        6      19: lconst_1      20: lstore        7      22: ldc2_w        #3                  // long 5l      25: lstore        9      27: dconst_1      28: dstore        11      30: new           #5                  // class java/lang/Integer      33: dup      34: bipush        8      36: invokespecial #6                  // Method java/lang/Integer.&quot;&lt;init&gt;&quot;:(I)V      39: astore        13      41: ldc           #7                  // class com/lsj/test/Test      43: dup      44: astore        14      46: monitorenter      47: iload         4      49: iload_3      50: idiv      51: istore        15      53: aload         14      55: monitorexit      56: goto          67      59: astore        16      61: aload         14      63: monitorexit      64: aload         16      66: athrow      67: goto          87      70: astore        14      72: aload         14      74: invokevirtual #9                  // Method java/lang/NullPointerException.printStackTrace:()V      77: goto          87      80: astore        14      82: aload         14      84: invokevirtual #11                 // Method java/lang/Exception.printStackTrace:()V      87: return    Exception table:       from    to  target type          47    56    59   any          59    64    59   any          41    67    70   Class java/lang/NullPointerException          41    67    80   Class java/lang/Exception}</code></pre><p>通过指令代码就能看到java代码编译之后每一步究竟做了什么事情了，也方便我们去解决问题。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo和Github搭建个人博客</title>
      <link href="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/"/>
      <url>/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/</url>
      
        <content type="html"><![CDATA[<p>​    作为一个纯种程序猿，怎么能没有自己的博客呢。每每看大牛的博客时总是充满敬畏的同时，也想拥有一个属于自己的博客，一方面记录自己在技术上的问题和心得体会，另一方面也是记录着自己从菜鸟到大牛的成长经历。话不多说，下面来一起搭建一个自己的个人博客吧。为了让小白和非猿类也能看明白，本篇搭建流程将尽可能详细，猿类朋友可跳过部分中间步骤，首先搭建个人博客方式主要分为三种。</p><p>​    1 . 自己购买服务器，然后编写前后台代码，将项目部署在服务器上给别人访问。</p><p>​    2 . 在博客平台上注册账号，通过平台来撰写博客。如博客园，CSDN，简书等。</p><p>​    3 . 使用hexo生成静态网页并托管在免费的github平台上，开启GitHub Page即可。</p><p>方案一：成本太高，对技术要求也较高，而且对于小白来说难度太大不推荐。方案二：这也是一种选择，而且很多大牛不只有自己的个人博客，而且在各大平台上都有自己的博客，成本低，只是个性化设置不够灵活，但不失为一个不错的选择。方案三：很多基于git的代码托管平台都提供静态网页服务，例如 Github，Gitlab，Gitee（码云）等，这些平台都可以和Hexo配合搭建个人博客，使用这种方式的好处是博客主题，布局，样式，域名全部可以私人订制，对于喜欢个性化的朋友是一个绝佳的选择，而且只需通过几个步骤即可拥有自己的个人博客。下面我记录了一下我个人使用 Hexo+Github的方式搭建个人博客的具体方法，同时今天也是Github被微软收购的日子，祝愿Github能越来越好 !</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github.jpeg" alt></p><a id="more"></a> <h3 id="1-安装git"><a href="#1-安装git" class="headerlink" title="1. 安装git"></a>1. 安装git</h3><p>git是一个分布式的代码版本控制工具，可以有效、高速的处理从很小到非常大的项目版本管理 。首先下载git，直接去git官网下载git，下载地址：<a href="https://git-scm.com/downloads" target="_blank" rel="noopener">https://git-scm.com/downloads</a> </p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/git1.png" alt></p><p>选择Windows平台下载即可。</p><p>接下来是安装，如果不熟悉git的直接可以傻瓜式安装，全部默认设置，一路next即可。下载完成后，双击安装程序“Git-2.10.2-64-bit.exe”，显示截图如下 </p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/git2.png" alt></p><p>然后点击next</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/git3.png" alt></p><p>然后都是默认设置，一路next。直至最后结束。这样，你的git就安装好了 。我们通过cmd的方式验证一下，按快捷键win+R然后输入cmd打开windows的终端</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/cmd0.png" alt></p><p>然后在终端中输入 git version 回车即可看到git的版本号，说明git已经安装好了，如图</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/cmd1.png" alt></p><h3 id="2-安装node-js"><a href="#2-安装node-js" class="headerlink" title="2 . 安装node.js"></a>2 . 安装node.js</h3><p>Node.js是一个Javascript运行环境，发布于2009年5月 ，实质是对Chrome V8引擎进行了封装。 下载地址为官方网站：<a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">https://nodejs.org/en/download/</a> 打开如下图：</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/nodejs0.png" alt></p><p>选择windows平台下载，然后就是一路next。最后可通过终端验证是否安装成功，同样通过win+R打开windows的终端 输入 node -v</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/nodejs1.png" alt></p><p>出现版本号信息说明已经安装成功</p><h3 id="3-安装Hexo"><a href="#3-安装Hexo" class="headerlink" title="3 . 安装Hexo"></a>3 . 安装Hexo</h3><p>这个步骤相对来说就很简单了，在桌面空白处点击鼠标右键，点击Git Bash Here，输入npm命令即可安装 ，安装命令：npm install hexo-cli -g </p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo1.png" alt></p><p>如果半天没反应，耐心等待一会。然后是安装发布到github的插件，命令：npm install hexo-deployer-git –save </p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo2.png" alt></p><p>然后就是等待安装完成即可。</p><h3 id="4-初始化Hexo"><a href="#4-初始化Hexo" class="headerlink" title="4 . 初始化Hexo"></a>4 . 初始化Hexo</h3><p>新建一个Hexo工作目录，文件名可随便定义</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo4.png" alt></p><p>进入到这个目录，然后右键点击 Git Bash Here，然后在窗口中输入 hexo init </p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo5.png" alt></p><p>这个过程可能会比较漫长，请耐心等待即可。完成后文件夹会多出很多文件，如下图</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo6.png" alt></p><p>这里介绍一些我们需要关注的文件。</p><p>1 . node_modules文件夹是hexo安装插件的地方，</p><p>2 . source文件夹是放markdown文件的地方，也就是说我们写博客的markdown是放在这个目录下</p><p>3 . themes是下载博客主题的地方</p><p>4 . _config.yml是博客的配置文件</p><p>下面介绍一下_config.yml因为后面跟这个文件打交道的地方比较频繁，如图</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo7.png" alt></p><p>还有个需要关注的地方，如下图，不是软件行业的朋友，可能对github的项目地址可能没有概念，没关系，这里后面我会再讲到，这里先有个印象，因为发布到github时，这里需要配github的项目地址</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo8.png" alt></p><p>到此，hexo初始化完成，下面可以在本地运行看看效果了。在刚刚那个目录下执行 hexo g 生成静态文件，然后再执行hexo s 启动hexo</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo10.png" alt></p><p>可以看到hexo已经成功运行起来了，同时还告诉了我们运行网址，复制这个网址在浏览器打开</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo11.png" alt></p><p>到这一步，恭喜你。博客已经完美的在本地运行起来了。这个是hexo的默认主题，喜欢个性化的朋友，可自行去百度下载自己想要的主题。注意这里Hexo中有两个_ config.yml文件，一个是在Hexo主目录下的_ config.yml，一个是在/themes/主题名/ 下的_ config.yml。其中主目录下的_ config.yml主要设置博客相关的属性配置，而主题下的_ config.yml主要配置主题相关的属性配置。</p><h3 id="5-创建github项目"><a href="#5-创建github项目" class="headerlink" title="5 . 创建github项目"></a>5 . 创建github项目</h3><p>首先需要先注册一个github账号，这个就不解释了。跟注册QQ号码是一样的，只不过注册页面全是英文，所以考验英语水平的时候到了 ！这里假设你已经拥有了一个github账号，然后需先创建一个项目</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github1.png" alt></p><p>点击New repository 然后会来到如下的页面</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github2.png" alt></p><p>这里需要注意的是项目名称中 github.io前面的那部分名称 一定要和你的github名字一样，其余都默认。然后点击Create repository。创建完成会来到如下界面</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github4.png" alt></p><p>需要注意的就是上面红框里的地址，这个就是项目的git地址，选HTTPS的方式即可。<strong>这个地址要配置在前面提到过的hexo根路径的_config.yml文件的中项目地址。</strong></p><p>然后点击右边的Settings，会来到如下界面</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github5.png" alt></p><p>往下找到GitHub Pages，这里如果项目名称就是github的用户名，默认就是master branch。例如我这里就默认为None，这种情况下选择master branch然后保存即可，如果master branch是不可选的状态，选择下面一行有个Choose a theme的按钮，选择一个主题就可以开启GitHub Pages了。然后点击Save。</p><p>接下来配置github的SSH密钥 ，在Hexo初始化的目录下，右键点击Git Bash Here。首先配置git的个人信息</p><p>1、设置Git的user name和email：(如果是第一次的话) </p><pre><code>git config --global user.name &quot;xiaobai&quot;git config --global user.email &quot;xiaobai@163.com&quot;</code></pre><p>这两个值对应于在注册github时的用户名和邮箱，写好之后回车即可。</p><p>2、生成密钥 </p><pre><code>ssh-keygen -t rsa -C &quot;xiaobai@163.com&quot;</code></pre><p>中途停顿需要你设置密码，建议个人使用不需要设置密码，省的麻烦，直接回车即可。</p><p>3、保存到github中</p><p>通过下面的命令，把刚刚生成好的密钥复制出来</p><pre><code>clip &lt; ~/.ssh/id_rsa.pub </code></pre><p>然后，到github界面点击Settings</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github6.png" alt></p><p>然后选择SSH and GPG keys，点击New SSH keys，在Title中给密钥写个名字，然后把密钥粘贴在Key中，最后点击Add SSH Key</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github7.png" alt></p><p>到此已经全部配置完毕，在Hexo目录下右键Git Bash Here，然后通过命令</p><pre><code>hexo d</code></pre><p>发布项目到github吧，发布完成后可通过查看项目中的Settings查看发布路径，如下图</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github15.png" alt></p><p>可能会遇到的问题：</p><p>​    1 . 在平常写博客中肯定会引用到图片资源，如果使用绝对路径，发布上去肯定会找不到图片资源，使用相对路径，也会因为经过Hexo的编译，使得路径发生了变化，还是会找不到图片资源。这里需要借助Hexo的一个插件，通过命令</p><pre><code>npm install hexo-asset-image --save</code></pre><p>此外还需把hexo路径下的post_asset_folder 属性设置为true</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo12.png" alt></p><p>稍等片刻，待这个插件下载好后再通过</p><pre><code>hexo n &quot;xxx&quot;</code></pre><p>命令生成博客时，在/source/_posts 路径下会发现在生成xxx.md文件的同时，也生成了一个同名的xxx文件夹，然后在xxx.md中想引入图片时，先把图片复制到xxx这个文件夹中，然后只需要在xxx.md中按照markdown的格式引入图片：</p><pre><code>![你想输入的替代文字](xxx/图片名.jpg)</code></pre><p>这样就能解决图片资源的问题。</p><p>​    2 . 使用 hexo d 命令报 ERROR Deployer not found: git ，原因是没有安装 hexo 发布到git的插件。在git终端中输入 npm install –save hexo-deployer-git 命令等待插件下载完成即可。</p><h3 id="6-如何使用自定义首页"><a href="#6-如何使用自定义首页" class="headerlink" title="6 . 如何使用自定义首页"></a>6 . 如何使用自定义首页</h3><p>在做完上面五个步骤后，博客已经能正常访问了。但是爱折腾的朋友可能仍不满足，想自定义一个首页，打开博客时先到首页，然后再跳到博客主页。本人在搭博客时也想这样做，踩了不少坑，在此也分享一下。这里需要再建立一个github项目，名字随便起，可以起成blog，这里我做测试起名为test。</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github17.png" alt></p><p>同时开启Github Pages，如果起名为blog，这时blog项目的网页预览功能的网址会是 <a href="https://xxx.github.io/blog，然后在" target="_blank" rel="noopener">https://xxx.github.io/blog，然后在</a> _ config.yml的相关配置</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo14.png" alt></p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo8.png" alt></p><p>发布路径写成这个项目的github项目地址，在主题中的 _ config.yml跟路径配置为</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/hexo19.png" alt></p><p>重薪把现在的博客部署在新的github项目上，而原来的 xxx.github.io 的项目中只需留下index.html 页面，例如我的博客。</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github18.png" alt></p><p>在index.html中就可以随意定义自己喜欢的样式，主题，开启装逼模式。而仅仅只需留下一个 a 链接跳向刚刚创建的新项目的博客预览地址即可</p><p><img src="/2018/06/03/hexo-github-da-jian-ge-ren-bo-ke/github19.png" alt></p><p>当然如果看着 <a href="https://xxx.github.io" target="_blank" rel="noopener">https://xxx.github.io</a> 这个域名不爽，也可以使用自己的域名，这就需要花钱了，方法也比较简单。可以自行百度，这里就不做介绍了。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 其他 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一杯Java 不加糖</title>
      <link href="/2018/06/03/java-xu-ni-ji/"/>
      <url>/2018/06/03/java-xu-ni-ji/</url>
      
        <content type="html"><![CDATA[<p>​    Java是一门面向对象的编程语言，在编程语言排行榜中常年排行前三，由于语言的优势和特点如今已经成为开发中最流行最受欢迎的编程语言，特别是在后台服务器开发领域，由于其跨平台性和庞大的生态圈，几乎没有其他语言能够撼动它的霸主地位。Java发展也是相当迅速，如今已经到Java 10 了，吸收了其他语言的一些优势和特点，融入了很多新的特性 。Java主要分为三个方向：</p><p><strong>Java SE</strong>：Java Standard Edition，即Java标准版，也是Java技术的核心，是学习 Java ME和 Java EE的基础。用于开发和部署桌面、服务器的Java应用程序 ，也就是C/S架构开发。</p><p><strong>Java EE</strong>：Java Enterprise Edition，即Java企业版，Java EE 是在 Java SE 的基础上构建的，它提供Web 服务、管理和通信 API ，是java技术应用最广泛的领域。主要用于B/S架构开发。</p><p><strong>Java ME</strong>：Java Mirco Edition，即Java微型版，Java ME是对 Java SE 进行了精简，以提高运行效率，主要针对小型设备，移动设备以及嵌入式设备而构建，不过在移动设备上，现在基本已经被安卓代替了。</p><p>Java虚拟机是整个java平台的基石，是java技术实现硬件无关和操作系统无关的关键环节，是java语言生成极小体积的编译代码的运行平台，是保护用户机器免受恶意代码侵袭的保护屏障。可以说JVM就是整个java体系的核心，在java中碰到的绝大部分问题都可以在JVM中找到答案。</p><a id="more"></a> <h2 id="一-什么是JVM"><a href="#一-什么是JVM" class="headerlink" title="一 . 什么是JVM"></a>一 . 什么是JVM</h2><p>​    想要弄清楚什么是java虚拟机，首先就得搞清楚计算机的虚拟化技术。虚拟化是将计算机的各种实体资源，CPU、网络、内存及磁盘等，予以抽象，然后使用软件的方式重新定义划分资源。相信做IT的都玩过VMware，在VMware中可以装多个虚拟机，多个虚拟机共享一台物理机硬件资源。实际上，软硬件资源并没有增加，只是提高了硬件的利用率，并且各个应用程序可以在各个独立的空间（客户机操作系统）内运行而互不影响。有了虚拟化之后，由于的应用程序由相应的客户机操作系统管理，且多个客户操作系统可以独立于主机的操作系统，运行在同一个硬件上，不需要适配硬件的特定体系结构。这通常通过增加一个虚拟化层来实现，该虚拟化层称为hypervisor或VMM(Virtual Machine Monitor 虚拟机监视器)</p><p>虚拟化层可以在不同层面对硬件资源进行抽象，如下图所示：</p><table><thead><tr><th>级别</th><th>例子</th></tr></thead><tbody><tr><td>应用程序级</td><td>JVM</td></tr><tr><td>操作系统级</td><td>Docker</td></tr><tr><td>硬件抽象级</td><td>VMware</td></tr></tbody></table><p>从上图可以看出 JVM 是在应用程序级别的虚拟化，实际上 JVM（Java虚拟机）是一种抽象化的计算机，它有自己的指令集和执行引擎，通过在实际的计算机上仿真模拟计算机架构（如处理器、堆栈、寄存器等，相应的指令系统）来实现的。目的是为构建在其上运行的应用程序（java程序）提供一个运行环境。JVM可以解读指令代码并与操作系统进行交互。这种设计使得Java程序只需生成在Java虚拟机上运行的目标代码（字节码），就可以在多种平台上不加修改地运行，这也是Java 最具吸引力的特性之一。</p><h2 id="二-JVM的作用"><a href="#二-JVM的作用" class="headerlink" title="二 . JVM的作用"></a>二 . JVM的作用</h2><p>​    JVM将自身定位应用程序和底层平台之间。底层平台是指操作系统（OS）和硬件。操作系统和硬件体系结构在不同的机器上可能不同，但是同一段Java程序可以不用做任何的代码修改就能在不同的机器上运行。也就是说java的 JVM 屏蔽了应用程序与底层平台的相关性，对外暴露出标准和规范。实际上JVM并不关心.class文件是由哪种编译器编译而成，只要符合.class文件的文件格式，就能在 JVM 中运行。下面来列举一下除了java之外的运行在JVM之上的比较流行的编程语言。</p><table><thead><tr><th></th><th>Groovy</th><th>JRuby</th><th>Scala</th><th>Fantom</th><th>Jython</th></tr></thead><tbody><tr><td>特点</td><td>面向对象</td><td>面向对象</td><td>多范式</td><td>面向对象</td><td>多范式</td></tr><tr><td>平台</td><td>JVM</td><td>JVM</td><td>JVM</td><td>JVM，CLR</td><td>JVM</td></tr><tr><td>执行速度</td><td>良好</td><td>良好</td><td>优秀</td><td>非常好</td><td>一般</td></tr><tr><td>与java的兼容性</td><td>优秀</td><td>优秀</td><td>优秀</td><td>良好</td><td>优秀</td></tr></tbody></table><p>​    这些.class文件实际上包含了半编译的代码——字节码。之所以称之为半编译，是因为字节码并不像C/C++编译器编译的二进制文件一样可以直接执行。字节码要先被输入到JVM中，再通过 JVM 调用底层操作系统。所以字节码包含了JVM的指令、符号表和其他的辅助信息。实际上不管何种语言，能根据JVM的语法和结构约束编译生成字节码的编译器，都可以在 JVM 上执行。虽然java编译器生成的.class文件是平台独立的，但 JVM 与特定平台相关的，如下图所示。</p><p><img src="/2018/06/03/java-xu-ni-ji/jvm.png" alt></p><h2 id="三-JVM，JRE，JDK的联系"><a href="#三-JVM，JRE，JDK的联系" class="headerlink" title="三 . JVM，JRE，JDK的联系"></a>三 . JVM，JRE，JDK的联系</h2><p>​    JVM是JRE的一部分，JRE是我们安装运行Java程序的最基本运行环境。它和java类库以及运行java程序所需要的其他组件一起组成了JVM的一个实现。所以如果想运行java程序，只需安装JRE就够了。而JDK是JRE的超集，JDK是java开发工具包，里面包含了JRE，也包含了java编译器，调试器以及其他相关的java程序开发工具类。当我们需要开发和编译java源码时就需要用到JDK。</p><p>​    Java提供了Java虚拟机规范来让我们对JVM的工作原理有一个完整的认识。你可以从这里得到概念性知识，并开发一个自己的JVM；但这并不是一个简单的工作。现在市场上已经有很多JVM了。众多JVM产品中最有名的莫过于现在Oracle公司的HotSpot。后续章节中将深入探讨 JVM 的工作原理，如果没有特别说明，探讨的都是Oracle公司的HotSpot虚拟机。 </p><h2 id="四-JVM的源码"><a href="#四-JVM的源码" class="headerlink" title="四 . JVM的源码"></a>四 . JVM的源码</h2><p>​    在平常使用Java开发的过程中，我们写好代码然后再写一个main函数就可以把程序跑起来，一切是那么的简单，自然而然。但是好奇的朋友可能会去想 java 的 JVM 到底是怎么工作的，为什么main函数只能那么写？为什么运行main函数程序就能跑起来？为什么我们不能定义自己的main函数？在启动main函数的时候 JVM 底层到底发生了什么？</p><p>首先第一个问题，main函数的格式必须是 pubic static void main(String[] args) 吗？其实还有一种大同小异的写法，就是 public static void main(String…args) 。其余写法 JVM 都无法识别，会导致 JVM 找不到主函数而无法启动，那么其余几个关键字为什么要这么写？</p><p>​    1 . 为什么是public，因为java程序是通过jvm虚拟机调用的，所以main()函数要是想被调用，必须是public</p><p>​    2 . 为什么是static ，main函数是所有程序的入口，也就是main被调用时没有任何对象创建，不通过对象调用某一方法，只有将该方法定义为静态方法，所以main方法是一个静态方法，需要static修饰。</p><p>​    3 . 为什么是void，main函数对于 JVM 的调用来说，已经是最底层。由它调用的方法的返回值已经没有任何地方可去，因此，main方法返回值为空，即需用void修饰</p><p>​    4 .  为什么需要String[]参数，这其实是由于 jvm 驱动的源码决定的。</p><pre><code>mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, &quot;main&quot;, &quot;([Ljava/lang/String;)V&quot;);  </code></pre><p>启动时会直接去找指定类名，指定参数类型的main函数。这句源码决定了，不写参数会导致找不到main函数。</p><h3 id="（1）-openJDK源码下载"><a href="#（1）-openJDK源码下载" class="headerlink" title="（1）. openJDK源码下载"></a>（1）. openJDK源码下载</h3><p>​    OK，上述的第一个问题解决，其余的问题只能去 HotSpot 的源码中去寻找答案了。在安装jdk时，就已经安装了jvm，jdk中的jvm是 jdk1.8.0_121\jre\bin\server下jvm.dll ，但本身并不开源，只能通过openJDK来查看jdk的源码，这里可以通过官网下载。飞机票：<a href="http://download.java.net/openjdk/jdk8，官方下载网速较慢，故附上百度网盘：链接" target="_blank" rel="noopener">http://download.java.net/openjdk/jdk8，官方下载网速较慢，故附上百度网盘：链接</a>: <a href="https://pan.baidu.com/s/1ezWqQ_30n0FEhKFRVMshIg" target="_blank" rel="noopener">https://pan.baidu.com/s/1ezWqQ_30n0FEhKFRVMshIg</a> 密码: nbni。</p><p>​    这里还要提及的一点就是openJDK和Oracle/Sun JDK的区别，OpenJDK原是SunMicrosystems公司为Java平台构建的Java开发环境（JDK）的开源版本，并于2009年4月15日正式发布OpenJDK，后来甲骨文在 2010 年收购SunMicrosystem之后接管了这个项目。 Oracle/Sun JDK里面包含的JVM是HotSpotVM，HotSpot VM只有非常少量的功能没有在OpenJDK里，那部分在Oracle内部的代码库里。这些私有部分都不涉及JVM的核心功能。所以说，Oracle/Sun JDK与OpenJDK其实使用的是同一个代码库。值得注意的是，Oracle JDK只发布二进制安装包，而OpenJDK只发布源码。</p><p>下载完openJDK，解压得到目录结构如下图</p><p><img src="/2018/06/03/java-xu-ni-ji/openJDK_home.png" alt></p><p>下面对OpenJDK目录结构做个解释</p><pre><code>|——openjdk |    |—— corba                                不流行的多语言、分布式通讯接口 |    |—— hotspot                                 Java 虚拟机 |    |—— jaxp                                XML 处理 |    |—— jaxws                                一组 XML web services 的 Java API |    |—— jdk                                     java 开发工具包 |         |—— src |              |——                            针对操作系统的部分 |               |—— share                         与平台无关的实现|                    |—— classes             Java 的实现,Java的lang包就这个目录下|                    |—— native               C++ 的实现。JNI库，java中native关键字由它实现|                    |—— back|                    |—— instrument|                    |—— javavm|                    |—— npt|                    |—— transport                     |    |—— langtools                            Java 语言工具 |    |—— nashorn                                 JVM 上的 JavaScript 运行时</code></pre><p>下面对各个文件夹解释</p><h5 id="corba"><a href="#corba" class="headerlink" title="corba"></a>corba</h5><p>​    全称 Common Object Request Broker Architecture，通用对象请求代理架构，是基于 对象-服务 机制设计得。内置了跨语言调用和分布式通讯接口，目前，通用的远程过程调用协议是 <strong>SOAP</strong>（Simple Object Access Protocol，简单对象访问协议），消息格式是 XML-RPC（存在 Json-RPC）</p><h5 id="hotspot"><a href="#hotspot" class="headerlink" title="hotspot"></a>hotspot</h5><p>​    全称 Java HotSpot Performance Engine，是 Java 虚拟机的一个实现，包含了服务器版和桌面应用程序版。利用 JIT 及自适应优化技术（自动查找性能热点并进行动态优化）来提高性能。使用 <code>java -version</code> 可以查看 Hotspot 的版本。</p><h5 id="jaxp"><a href="#jaxp" class="headerlink" title="jaxp"></a>jaxp</h5><p>​    全称 Java API for XML Processing，处理 XML 的Java API，是 Java XML 程序设计的应用程序接口之一，它提供解析和验证XML文档的能力。<br>jaxp 提供了处理 xml 文件的三种接口：</p><ul><li>DOM 接口（文档对象模型解析），位于 <code>\openjdk\jaxp\src\org\w3c\dom</code></li><li>SAX 接口（xml 简单 api 解析），位于 <code>\openjdk\jaxp\src\org\xml\sax</code></li><li>StAX 接口（xml 流 api），位于 <code>\openjdk\jaxp\src\javax\xml</code></li></ul><p>除了解析接口，JAXP还提供了XSLT接口用来对XML文档进行数据和结构的转换</p><h5 id="Jaxws"><a href="#Jaxws" class="headerlink" title="Jaxws"></a>Jaxws</h5><p>​    全称 Java API for Web Services，JAX-WS 允许开发者选择 RPC-oriented（面向 RPC） 或者 message-oriented（消息通信，erlang 使用的就是消息通信，不过 Java 内存模型是内存共享）来实现自己的web services。</p><p>通过 Web Services 提供的环境，可以实现 Java 与其他编程语言的交互（事实上就是 thrift 所做的，任何一种语言都可以通过 Web Services 实现与其他语言的通信，客户端用一种语言，服务器端可以用其他语言）</p><h5 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h5><p>​    主要关注       <code>\jdk\src\share</code>  路径下的包，classes包 Java 的实现,我们熟悉的Java.lang包就这个目录下,nativs是本地方法库，当java需要调用native方法时，就需要用到这下面的文件。back、instrument、javavm、npt、transport 几个部分都是 C++ 代码，是实现 java 的基础部分。</p><h5 id="nashorn"><a href="#nashorn" class="headerlink" title="nashorn"></a>nashorn</h5><p>​    Nashorn 项目的目的是基于 Java 在 JVM 上实现一个轻量级高性能的 JavaScript 运行环境。从Rhino而来, 是JRE 8里的JavaScript引擎, 基于 JSR 规范，Java 程序员可在 Java 程序中嵌入 JavaScript 代码</p><p>以上目录中，我们关注的是hotspot，打开hotspot目录，其中目录结构如下</p><pre><code>├─agent                            Serviceability Agent的客户端实现├─make                             用来build出HotSpot的Makefile文件├─src                              HotSpot VM的源代码│  ├─cpu                         CPU相关代码（汇编器、模板解释器、ad文件、部分runtime函数在这里实现）│  ├─os                             操作系相关代码│  ├─os_cpu                         操作系统+CPU处理器类型的代码│  └─share                          平台无关的共通代码│      ├─tools                        工具│      │  ├─hsdis                      反汇编插件│      │  ├─IdealGraphVisualizer       将server编译器的中间代码可视化的工具│      │  ├─launcher                   启动程序“java”│      │  ├─LogCompilation             将-XX:+LogCompilation输出的日志（hotspot.log）整理成更容易阅读的格式的工具│      │  └─ProjectCreator             生成Visual Studio的project文件的工具│      └─vm                            HotSpot VM的核心代码，这里面的功能模块构成了虚拟机的内核│          ├─adlc                       平台描述文件（上面的cpu或os_cpu里的*.ad文件）的编译器│          ├─asm                        汇编器接口│          ├─c1                         client编译器（又称“C1编译器”）│          ├─ci                         动态编译器的公共服务/从动态编译器到VM的接口│          ├─classfile                  类文件的处理（包括类加载和系统符号表等）│          ├─code                       动态生成的代码的管理│          ├─compiler                   从VM调用动态编译器的接口│          ├─gc_implementation          GC的实现│          │  ├─concurrentMarkSweep      Concurrent Mark Sweep GC的实现│          │  ├─g1                       Garbage-First GC的实现（不使用老的分代式GC框架）│          │  ├─parallelScavenge    ParallelScavenge GC的实现（serverVM默认不使用老的分代式GC框架）│          │  ├─parNew                   ParNew GC的实现│          │  └─shared                   GC的共通实现│          ├─gc_interface               GC的接口│          ├─interpreter          解释器，包括“模板解释器”（官方版在用）和“C++解释器”（官方版不在用）│          ├─libadt                     一些抽象数据结构│          ├─memory                     内存管理相关（老的分代式GC框架也在这里）│          ├─oops                       HotSpot VM的对象系统的实现│          ├─opto                       server编译器（又称“C2”或“Opto”）│          ├─prims                      HotSpot VM的对外接口，包括部分标准库的native部分和JVMTI实现│          ├─runtime                    运行时支持库（包括线程管理、编译器调度、锁、反射等）│          ├─services                   主要是用来支持JMX之类的管理功能的接口│          ├─shark                      基于LLVM的JIT编译器（官方版里没有使用）│          └─utilities                  内部工具类和公共函数└─test                                     Java实现的测试用例</code></pre><p>(hotspot各个目录的作用参考博客：<a href="https://www.cnblogs.com/dennyzhangdd/p/6734933.html" target="_blank" rel="noopener">https://www.cnblogs.com/dennyzhangdd/p/6734933.html</a>)</p><h3 id="（2）-启动java的main函数时到底发生了什么？"><a href="#（2）-启动java的main函数时到底发生了什么？" class="headerlink" title="（2）. 启动java的main函数时到底发生了什么？"></a>（2）. 启动java的main函数时到底发生了什么？</h3><p>​    当我们要启动java的main函数时，首先需要创建一个 JVM实例 。我们都知道main函数是程序入口，那么启动 JVM 实例也是需要入口 main函数。那么 JVM 的启动入口在哪呢 ? 在 openjdk\hotspot\src\share\tools\launcher路径下，有一个 java.c 文件，这个文件中的main函数就是 JVM 的启动入口，整个过程大致分为以下几步</p><p>​    1、创建运行环境<br>​    2、设置虚拟机参数<br>​    3、设置线程栈大小<br>​    4、执行Java main方法</p><p>启动java的main函数时，首先会执行 JVM 的main函数，通过C语言实现，源码如下</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> <span class="token operator">*</span>jarfile <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>classname <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>main_class <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>    InvocationFunctions ifn<span class="token punctuation">;</span>    jlong start<span class="token punctuation">,</span> end<span class="token punctuation">;</span>    <span class="token keyword">char</span> jrepath<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">,</span> jvmpath<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> original_argv <span class="token operator">=</span> argv<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"_JAVA_LAUNCHER_DEBUG"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        _launcher_debug <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----_JAVA_LAUNCHER_DEBUG----\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>由于main函数比较长，不方便全部贴出，可自行下载源码查看，下面主要分析一下main函数中几个重要的步骤</p><h5 id="创建运行环境"><a href="#创建运行环境" class="headerlink" title="创建运行环境"></a>创建运行环境</h5><p>源码如下</p><pre class=" language-c"><code class="language-c"><span class="token function">CreateExecutionEnvironment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argv<span class="token punctuation">,</span>                           jrepath<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>jrepath<span class="token punctuation">)</span><span class="token punctuation">,</span>                           jvmpath<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>jvmpath<span class="token punctuation">)</span><span class="token punctuation">,</span>                           original_argv<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在main函数中调用创建环境的函数，这个函数是在openjdk\hotspot\src\os\windows\launcher的java_md.c文件中声明的（windows版本），源码如下</p><pre class=" language-c++"><code class="language-c++">voidCreateExecutionEnvironment(int *_argc,                           char ***_argv,                           char jrepath[],                           jint so_jrepath,                           char jvmpath[],                           jint so_jvmpath,                           char **original_argv) {#ifndef GAMMA   char * jvmtype;    /* Find out where the JRE is that we will be using. */    if (!GetJREPath(jrepath, so_jrepath)) {        ReportErrorMessage("Error: could not find Java SE Runtime Environment.",                           JNI_TRUE);        exit(2);    }    /* Do this before we read jvm.cfg */    EnsureJreInstallation(jrepath);    /* Find the specified JVM type */    if (ReadKnownVMs(jrepath, (char*)GetArch(), JNI_FALSE) < 1) {        ReportErrorMessage("Error: no known VMs. (check for corrupt jvm.cfg file)",                           JNI_TRUE);        exit(1);    }    jvmtype = CheckJvmType(_argc, _argv, JNI_FALSE);    jvmpath[0] = '\0';    if (!GetJVMPath(jrepath, jvmtype, jvmpath, so_jvmpath)) {        char * message=NULL;        const char * format = "Error: no `%s' JVM at `%s'.";        message = (char *)JLI_MemAlloc((strlen(format)+strlen(jvmtype)+                                    strlen(jvmpath)) * sizeof(char));        sprintf(message,format, jvmtype, jvmpath);        ReportErrorMessage(message, JNI_TRUE);        exit(4);    }    /* If we got here, jvmpath has been correctly initialized. */#else  /* ifndef GAMMA */    /*     * gamma launcher is simpler in that it doesn't handle VM flavors, data     * model, etc. Assuming everything is set-up correctly     * all we need to do here is to return correct path names. See also     * GetJVMPath() and GetApplicationHome().     */  {    if (!GetJREPath(jrepath, so_jrepath) ) {       ReportErrorMessage("Error: could not find Java SE Runtime Environment.",                          JNI_TRUE);       exit(2);    }    if (!GetJVMPath(jrepath, NULL, jvmpath, so_jvmpath)) {       char * message=NULL;       const char * format = "Error: no JVM at `%s'.";       message = (char *)JLI_MemAlloc((strlen(format)+                                       strlen(jvmpath)) * sizeof(char));       sprintf(message, format, jvmpath);       ReportErrorMessage(message, JNI_TRUE);       exit(4);    }  }#endif  /* ifndef GAMMA */}</code></pre><p>概括来说CreateExecutionEnvironment函数主要做了两件事情：</p><p>1.根据当前JRE环境的路径和系统版本寻找 jvm.cfg 文件，文件在 jdk 安装路径 jdk1.8.0_77\jre\lib\amd64\jvm.cfg 下，需要通过这个文件判断 JVM 的类型。</p><p>2.根据第一步确定的 JVM 类型，找到对应的 JVM.dll 文件。</p><p>执行完CreateExecutionEnvironment后，回到main函数，然后调用LoadJavaVM函数去加载 jvm.dll 文件，初始化虚拟机中的函数调用，即通过JVM中的方法调用JVM.dll文件中定义的函数，装载jvm.dll动态连接库（java.exe是java class文件的执行程序，但实际上java.exe程序只是一个执行的外壳。它会装载jvm.dll（windows下），这个动态连接库才是java虚拟机的实际操作处理所在。java.exe程序只负责查找和装载jvm.dll动态库，并调用它进行class文件执行处理）</p><h5 id="设置虚拟机参数"><a href="#设置虚拟机参数" class="headerlink" title="设置虚拟机参数"></a>设置虚拟机参数</h5><p>加载完 jvm.dll 后就是虚拟机的各种参数设置</p><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*     *  Parse command line options; if the return value of     *  ParseArguments is false, the program should exit.     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseArguments</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jarfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>classname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">,</span> jvmpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">exit</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* Override class path if -jar flag was specified */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>jarfile <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">SetClassPath</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* set the -Dsun.java.command pseudo property */</span>    <span class="token function">SetJavaCommandLineProp</span><span class="token punctuation">(</span>classname<span class="token punctuation">,</span> jarfile<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Set the -Dsun.java.launcher pseudo property */</span>    <span class="token function">SetJavaLauncherProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* set the -Dsun.java.launcher.* platform properties */</span>    <span class="token function">SetJavaLauncherPlatformProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里主要关注ParseArguments方法，在上图的第5行。这个方法的主要作用就是调用AddOption将虚拟机的参数保存到 JavaVMOption 中 ，后续 Arguments 类会对 JavaVMOption 数据进行再次处理，并验证参数的合理性。主要的实现方法有两个</p><p><strong>Arguments::parse_each_vm_init_arg</strong>  方法负责处理经过解析过的JavaVMOption数据，这个方法使用C++实现，定义在openjdk\hotspot\src\share\vm\runtime路径下的arguments.cpp中，源码如下</p><pre class=" language-c"><code class="language-c"> <span class="token comment" spellcheck="true">// -Xmn for compatibility with other JVM vendors</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">"-Xmn"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      julong long_initial_eden_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      ArgsRange errcode <span class="token operator">=</span> <span class="token function">parse_memory_size</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token operator">&amp;</span>long_initial_eden_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode <span class="token operator">!=</span> arg_in_range<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"Invalid initial eden size: %s\n"</span><span class="token punctuation">,</span> option<span class="token operator">-></span>optionString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">describe_range_error</span><span class="token punctuation">(</span>errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> JNI_EINVAL<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> MaxNewSize<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintx<span class="token punctuation">)</span>long_initial_eden_size<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> NewSize<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintx<span class="token punctuation">)</span>long_initial_eden_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// -Xms</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">"-Xms"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      julong long_initial_heap_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      ArgsRange errcode <span class="token operator">=</span> <span class="token function">parse_memory_size</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token operator">&amp;</span>long_initial_heap_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode <span class="token operator">!=</span> arg_in_range<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"Invalid initial heap size: %s\n"</span><span class="token punctuation">,</span> option<span class="token operator">-></span>optionString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">describe_range_error</span><span class="token punctuation">(</span>errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> JNI_EINVAL<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> InitialHeapSize<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintx<span class="token punctuation">)</span>long_initial_heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// Currently the minimum size and the initial heap sizes are the same.</span>      <span class="token function">set_min_heap_size</span><span class="token punctuation">(</span>InitialHeapSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// -Xmx</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">"-Xmx"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      julong long_max_heap_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      ArgsRange errcode <span class="token operator">=</span> <span class="token function">parse_memory_size</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token operator">&amp;</span>long_max_heap_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode <span class="token operator">!=</span> arg_in_range<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"Invalid maximum heap size: %s\n"</span><span class="token punctuation">,</span> option<span class="token operator">-></span>optionString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">describe_range_error</span><span class="token punctuation">(</span>errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> JNI_EINVAL<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> MaxHeapSize<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintx<span class="token punctuation">)</span>long_max_heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Xmaxf</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">"-Xmaxf"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">int</span> maxf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>maxf <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> maxf <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"Bad max heap free percentage size: %s\n"</span><span class="token punctuation">,</span>                    option<span class="token operator">-></span>optionString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> JNI_EINVAL<span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> MaxHeapFreeRatio<span class="token punctuation">,</span> maxf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Xminf</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">"-Xminf"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">int</span> minf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>minf <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> minf <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"Bad min heap free percentage size: %s\n"</span><span class="token punctuation">,</span>                    option<span class="token operator">-></span>optionString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> JNI_EINVAL<span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">FLAG_SET_CMDLINE</span><span class="token punctuation">(</span>uintx<span class="token punctuation">,</span> MinHeapFreeRatio<span class="token punctuation">,</span> minf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span></code></pre><p>这里只列出几个常用的参数：<br>​    1、<strong>-Xmn</strong>：设置新生代的大小NewSize和MaxNewSize；</p><p>​    2、<strong>-Xms</strong>：设置堆的初始值InitialHeapSize，也是堆的最小值；</p><p>​    3、<strong>-Xmx</strong>：设置堆的MaxHeapSize，堆的最大值；</p><p>​    4、<strong>-Xminf and -Xmaxf</strong> ：GC（垃圾回收）之后可用空间的最小值最大值</p><p><strong>Arguments::check_gc_consistency</strong>  此方法主要用来验证GC策略的合理性，不合理的GC 策略将会导致 JVM 无法启动，并抛出错误信息，源码如下</p><pre class=" language-c"><code class="language-c">bool Arguments<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">check_gc_consistency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  bool status <span class="token operator">=</span> true<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Ensure that the user has not selected conflicting sets</span>  <span class="token comment" spellcheck="true">// of collectors. [Note: this check is merely a user convenience;</span>  <span class="token comment" spellcheck="true">// collectors over-ride each other so that only a non-conflicting</span>  <span class="token comment" spellcheck="true">// set is selected; however what the user gets is not what they</span>  <span class="token comment" spellcheck="true">// may have expected from the combination they asked for. It's</span>  <span class="token comment" spellcheck="true">// better to reduce user confusion by not allowing them to</span>  <span class="token comment" spellcheck="true">// select conflicting combinations.</span>  uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>UseSerialGC<span class="token punctuation">)</span>                       i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>UseConcMarkSweepGC <span class="token operator">||</span> UseParNewGC<span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>UseParallelGC <span class="token operator">||</span> UseParallelOldGC<span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>UseG1GC<span class="token punctuation">)</span>                           i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token string">"Conflicting collector combinations in option list; "</span>                <span class="token string">"please refer to the release notes for the combinations "</span>                <span class="token string">"allowed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    status <span class="token operator">=</span> false<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> status<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>java有四种类型的垃圾处理器：</p><p><strong>串行垃圾回收器（Serial Garbage Collector）</strong></p><p>Yong区和Old区：通过JVM参数 <strong>-XX:+UseSerialGC</strong> 可以使用串行垃圾回收器</p><p>​    串行垃圾回收器，对于单处理器系统真是绝佳上选，它为单线程环境设计，只使用一个单独的线程进行垃圾回收，通过冻结所有应用程序线程进行工作。冻结应用线程可能会导致应用程序卡顿，而出现不好的用户体验，因此这种垃圾回收器不适用于服务器环境。</p><p><strong>并发标记扫描垃圾回收器（CMS Garbage Collector）</strong></p><p>Yong 区：通过JVM参数  <strong>XX:+USeParNewGC</strong> 打开并发标记扫描垃圾回收器</p><p> Old 区：通过JVM参数  <strong>-XX:+UseConcMarkSweepGC</strong> 打开并发标记扫描垃圾回收器</p><p>​    CMS（-XX：+ UseConcMarkSweepGC）收集器在年老代中使用，专门收集那些在主要回收中不可能到达的年老对象。CMS 是以牺牲吞吐量为代价来获得最短回收停顿时间的垃圾回收器。对于要求服务器响应速度的应用上，这种垃圾回收器非常适合。CMS采用的基础算法是：标记—清除。</p><p><strong>并行垃圾回收器（Parallel Garbage Collector）</strong></p><p>Yong 区：通过JVM参数 <strong>-XX:+UseParallelGC</strong> 打开并行垃圾回收器</p><p>Old区：通过JVM参数 <strong>-XX:+UseParallelOldGC</strong> 控制</p><p>​    它是JVM的默认垃圾回收器。与串行垃圾回收器不同，它使用多线程并发进行垃圾回收。但相似的是，当执行垃圾回收的时候它也会冻结所有的应用程序线程，它的最大的优点就是它使用多个线程来扫描及压缩堆。它的缺点就是不管执行的是minor GC还是full GC它都会暂停应用线程。</p><p><strong>G1垃圾回收器（G1 Garbage Collector）</strong></p><p>Yong区和Old区：通过JVM参数 <strong>-XX:+UseG1GC</strong> 使用G1垃圾回收器</p><p>​    它在JDK 7update 4中首次引入，适用于堆内存很大（大于4G）的情况，他将堆内存分割成不同的区域，大小从1MB到32MB不等，并使用多个线程并发的对其进行垃圾回收</p><p>这里对 JVM 垃圾回收器的简要用法介绍，后续会详细说明。这里需要注意的是，从源码可以看到 JVM 的垃圾回收器如果相互之间混合使用会导致验证不通过，也就是说，JVM 中有些垃圾回收器是互斥的，不能同时使用。因此在设置GC调优参数时，需要留心。</p><h5 id="设置线程栈大小"><a href="#设置线程栈大小" class="headerlink" title="设置线程栈大小"></a>设置线程栈大小</h5><pre class=" language-c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span>threadStackSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">struct</span> JDK1_1InitArgs args1_1<span class="token punctuation">;</span>      <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>args1_1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>args1_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      args1_1<span class="token punctuation">.</span>version <span class="token operator">=</span> JNI_VERSION_1_1<span class="token punctuation">;</span>      ifn<span class="token punctuation">.</span><span class="token function">GetDefaultJavaVMInitArgs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* ignore return value */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>args1_1<span class="token punctuation">.</span>javaStackSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         threadStackSize <span class="token operator">=</span> args1_1<span class="token punctuation">.</span>javaStackSize<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>​    Java程序中，每个线程都有自己的Stack Space(堆栈)，常见的递归调用时压入Stack Frame(栈帧)。当递归调用太深的时候，就有可能耗尽Stack Space，导致抛出StackOverflow的异常。可通过参数JVM启动参数 <strong>-Xss</strong>  设置线程栈的大小</p><h5 id="调用-java-main方法"><a href="#调用-java-main方法" class="headerlink" title="调用 java main方法"></a>调用 java main方法</h5><pre class=" language-c"><code class="language-c"><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* Create a new thread to create JVM and invoke main method */</span>      <span class="token keyword">struct</span> JavaMainArgs args<span class="token punctuation">;</span>      args<span class="token punctuation">.</span>argc <span class="token operator">=</span> argc<span class="token punctuation">;</span>      args<span class="token punctuation">.</span>argv <span class="token operator">=</span> argv<span class="token punctuation">;</span>      args<span class="token punctuation">.</span>jarfile <span class="token operator">=</span> jarfile<span class="token punctuation">;</span>      args<span class="token punctuation">.</span>classname <span class="token operator">=</span> classname<span class="token punctuation">;</span>      args<span class="token punctuation">.</span>ifn <span class="token operator">=</span> ifn<span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token function">ContinueInNewThread</span><span class="token punctuation">(</span>JavaMain<span class="token punctuation">,</span> threadStackSize<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>总算到这一步了，在上面一系列关于 JVM 的参数设置工作完成后，在java.c文件中 main函数的结尾处就会调用 java的main方法了。要调用 java的main方法，首先要找到 java的 main函数所在的类。其中主要的实现就是JavaMain方法了，下面来看一下它的源码</p><pre class=" language-c"><code class="language-c">    <span class="token keyword">if</span> <span class="token punctuation">(</span>jarfile <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mainClassName <span class="token operator">=</span> <span class="token function">GetMainClassName</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mainClassName <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">"Failed to load Main-Class manifest "</span>                                <span class="token string">"attribute from\n%s"</span><span class="token punctuation">;</span>          message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>                                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>          messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>          <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        classname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>classname <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mainClass <span class="token operator">=</span> <span class="token function">LoadClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>mainClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* exception occured */</span>            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">"Could not find the main class: %s. Program will exit."</span><span class="token punctuation">;</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>            message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span>                                            <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>            messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>            <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      mainClassName <span class="token operator">=</span> <span class="token function">NewPlatformString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>mainClassName <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">"Failed to load Main Class: %s"</span><span class="token punctuation">;</span>        message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>                                   <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>        messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      classname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>classname <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      mainClass <span class="token operator">=</span> <span class="token function">LoadClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>mainClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* exception occured */</span>        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">"Could not find the main class: %s.  Program will exit."</span><span class="token punctuation">;</span>        <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span>                                        <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>JavaMain方法比较长，如要查看完整代码，自行下载源码，这里我只贴出关键部分的代码。上面这个代码就是查找mainClassName的代码，也就是获得主函数的类名。通过源码最外层的 if…else 可以知道有两种方式去获得主函数的类名，一种是通过jar包中的META-INF/MANIFEST.MF文件中指定的主函数类，去获得主类名。另一种方式是直接通过类名，这种方式需要在启动的时候指定主类名。在获得主类名后，就是去获取主类里的main方法了。源码如下</p><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* Get the application's main method */</span>    mainID <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span>                                       <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mainID <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          message <span class="token operator">=</span> <span class="token string">"No main method found in specified class."</span><span class="token punctuation">;</span>          messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Make sure the main method is public */</span>        jint mods<span class="token punctuation">;</span>        jmethodID mid<span class="token punctuation">;</span>        jobject obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ToReflectedMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span>                                                mainID<span class="token punctuation">,</span> JNI_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> obj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* exception occurred */</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mid <span class="token operator">=</span>          <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>                              <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token string">"getModifiers"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallIntMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mods <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* if (!Modifier.isPublic(mods)) ... */</span>            message <span class="token operator">=</span> <span class="token string">"Main method not public."</span><span class="token punctuation">;</span>            messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>从源码中可以看出，在获得主函数后，还对主函数做了一些校验，其中包括主函数的名字，参数，确保主函数是public修饰的等。随后就是执行主函数了，源码如下</p><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* Invoke main method. */</span>    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span> mainID<span class="token punctuation">,</span> mainArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>至此 JVM 启动全部完成了，接下来就会进入 java 的主函数执行具体业务代码。概括来说 JVM 启动主要包括几个步骤 1. 通过jvm.cfg加载 jvm.dll 文件 创建 JVM环境。2. 设置 JVM 参数，主要就是 GC 策略的设置以及分代堆内存的设置，线程栈大小的设置。3 . 找到 java的主类，运行java main函数。</p><p><img src="/2018/06/03/java-xu-ni-ji/jvmStart.png" alt></p><p>上图大致描述了 JVM 启动的主要步骤，仅做参考。</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM的类加载</title>
      <link href="/2018/06/02/jvm-de-lei-jia-zai/"/>
      <url>/2018/06/02/jvm-de-lei-jia-zai/</url>
      
        <content type="html"><![CDATA[<p>JVM的类加载机制</p><p>​    整体来看，JVM体系分为三个部分：类加载器（Class Loader），运行时数据区（Runtime Data Area），和执行引擎（Execution Engine）,这里主要探讨一下 JVM 的类加载器</p><h2 id="一-类的生命周期"><a href="#一-类的生命周期" class="headerlink" title="一 . 类的生命周期"></a>一 . 类的生命周期</h2><p>​    先通过一个图对类加载流程有个整体认识，如下图</p><p><img src="/2018/06/02/jvm-de-lei-jia-zai/pic1.png" alt></p><p>类从被加载到虚拟机内存中开始，直到卸载出内存为止，它的整个生命周期包括了：<strong>加载、验证、准备、解析、初始化、使用和卸载</strong>这7个阶段。其中，<strong>验证、准备和解析这三个部分统称为连接（linking）</strong>。</p><p>其中，加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班的“开始”（仅仅指的是开始，而非执行或者结束，因为这些阶段通常都是互相交叉的混合进行，通常会在一个阶段执行的过程中调用或者激活另一个阶段），而解析阶段则不一定（它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定。</p><a id="more"></a> <h3 id="1-加载"><a href="#1-加载" class="headerlink" title="1. 加载"></a>1. 加载</h3><p>​    加载是类加载的第一阶段，在加载阶段虚拟机需完成以下三件事</p><p>​             1、 通过一个类的全限定名来获取定义此类的二进制字节流。</p><p>​         2、将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构</p><p>​             3、 在Java堆中生成一个代表这个类的java.lang.Class对象，作为方法区这些数据的访问入口。</p><p>​    加载阶段既可以使用系统提供的类加载器在完成，也可以由用户自定义的类加载器来完成。这一动作是放在Java虚拟机外部去实现的，以便让应用程序自己决定如何获取所需的类。虚拟机规范并没有指明二进制字节流一定要从一个.class文件获取，也就是根本没有指明二进制字节流从哪里获取、怎样获取。这种开放的形式使得Java在很多领域得到充分运用，例如：</p><p>​          1、从ZIP包中读取，成为JAR，WAR格式的基础</p><p>​          2、从网络中获取，典型的应用就是Applet</p><p>​          3、运行时生成，典型的就是动态代理技术 </p><p>​          4、有其他文件生成，典型例子的就是jsp，由jsp文件生成对应的Class类 </p><p>​    加载阶段与连接阶段的部分内容(如一部分字节码文件格式验证动作)是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始。加载阶段完成后，虚拟机外部的 二进制字节流就按照虚拟机所需的格式存储在方法区之中，而且在Java堆中也创建一个java.lang.Class类的对象，这样便可以通过该对象访问方法区中的这些数据。</p><p>这里有个需要注意的地方，对于后面理解类锁和对象锁至关重要。什么是Class对象？为了方便理解可看下图：</p><p><img src="/2018/06/02/jvm-de-lei-jia-zai/classloader.png" alt></p><p>虚拟机为每种类的数据结构管理一个独一无二的Class对象。也就是说，每个类有且只有一个Class对象。运行程序时，Java虚拟机(JVM)首先检查是否所要加载的类对应的Class对象是否已经加载。如果没有加载，JVM就会根据类名查找.class文件，并在堆中生成类的Class对象。<strong>所有的类都是在对其第一次使用时，动态加载到JVM中的（并不是启动时全部加载到内存中，而是懒加载）。</strong>当程序创建第一个对类的静态成员的引用时，就会加载这个类。使用new创建类对象的时候也会被当作对类的静态成员的引用。<strong>因此java程序程序在它开始运行之前并非被完全加载，其各个类都是在必需时才加载的。</strong>这一点与许多传统语言都不同。动态加载使能的行为，在诸如C++这样的静态加载语言中是很难或者根本不可能复制的，其中类的Class对象就负责生成类的具体实例对象。再来说一说静态方法和非静态方法同步锁的问题。</p><p>​    非静态同步方法用的是同一把锁——实例对象本身，当多个线程操作堆中的同一个实例对象的同步非静态方法时，持有的是该这个实例对象的锁，其他线程想要执行这个实例对象的其余同步非静态方法时，需等待持有该对象锁的线程释放对象锁。</p><p>​        静态同步方法用的也是同一把锁——类对象本身，当多个线程操作同一个类的同步静态方法时，线程持有的是这个类对象的锁，也就是类的Class对象的锁，其他线程想要执行同一个类的其余同步静态方法时，需等待持有该对象锁的线程释放对象锁。</p><p>注意：多线程可以同时操作一个类的非静态同步方法和静态同步方法，因为他们的锁对象不一样，不会互斥。线程部分后续会详细讨论，这里做简要说明。</p><h3 id="2-连接"><a href="#2-连接" class="headerlink" title="2. 连接"></a>2. 连接</h3><h5 id="（1）-验证"><a href="#（1）-验证" class="headerlink" title="（1）. 验证"></a>（1）. 验证</h5><p>​    验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。</p><p>​       Java语言本身是相对安全的语言。但是，Class文件并不一定是由Java源码编译而来，可以使用任何途径，包括用十六进制编辑器(如UltraEdit)直接编写。如果直接编写了有害的“代码”(字节流)，而虚拟机在加载该Class时不进行检查的话，就有可能危害到虚拟机或程序的安全。</p><p>​      不同的虚拟机，对类验证的实现可能有所不同，但大致都会完成下面四个阶段的验证：文件格式验证、元数据验证、字节码验证和符号引用验证。</p><p>​       1、文件格式验证，是要验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。如验证魔数是否0xCAFEBABE；主、次版本号是否正在当前虚拟机处理范围之内；常量池的常量中是否有不被支持的常量类型。该验证阶段的主要目的是保证输入的字节流能正确地解析并存储于方法区中，经过这个阶段的验证后，字节流才会进入内存的方法区中存储，所以后面的三个验证阶段都是基于方法区的存储结构进行的。</p><p>​       2、元数据验证，是对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求。可能包括的验证如：这个类是否有父类；这个类的父类是否继承了不允许被继承的类；如果这个类不是抽象类，是否实现了其父类或接口中要求实现的所有方法……</p><p>​       3、字节码验证，主要工作是进行数据流和控制流分析，保证被校验类的方法在运行时不会做出危害虚拟机安全的行为。如果一个类方法体的字节码没有通过字节码验证，那肯定是有问题的；但如果一个方法体通过了字节码验证，也不能说明其一定就是安全的。</p><p>​       4、符号引用验证，发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在“解析阶段”中发生。验证符号引用中通过字符串描述的权限定名是否能找到对应的类；在指定类中是否存在符合方法字段的描述符及简单名称所描述的方法和字段；符号引用中的类、字段和方法的访问性(private、protected、public、default)是否可被当前类访问</p><h5 id="（2）-准备"><a href="#（2）-准备" class="headerlink" title="（2）. 准备"></a>（2）. 准备</h5><p>​    为类的静态变量分配内存，并将其初始化为默认值。准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。但有几点需要注意：</p><p>​    1、这时候进行内存分配的仅包括类变量（static），而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在Java堆中</p><p>​        2、这里所设置的初始值通常情况下是数据类型默认的零值（如0、0L、null、false等），而不是被在Java代码中被显式地赋予的值。</p><p>举个例子：public static int value=123; 在准备阶段value初始值为0 。在初始化阶段才会变为123 。但是需要注意的是，public static final int value=123; 在准备阶段value就会直接被赋值为123，当使用类名点final修饰的静态变量时，不会执行类的初始化。下面用代码来说明一下。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//静态变量</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String str<span class="token operator">=</span> <span class="token string">"666"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//静态常量</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String str1<span class="token operator">=</span> <span class="token string">"666"</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"类初始化"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>当引用类的静态变量时</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Car<span class="token punctuation">.</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>得到的结果：</p><pre><code>类初始化666</code></pre><p>结果很明显，引用静态变量，会先初始化类。</p><p>当引用类的静态常量是</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Car<span class="token punctuation">.</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>得到的结果：</p><pre><code>666</code></pre><p>结果在引用类的final修饰的静态常量时，类不会初始化</p><h5 id="（3）-解析"><a href="#（3）-解析" class="headerlink" title="（3）. 解析"></a>（3）. 解析</h5><pre><code> 解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。</code></pre><p>​       符号引用（Symbolic Reference）：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。符号引用与虚拟机实现的内存布局无关，引用的目标并不一定已经加载到内存中。</p><p>​       直接引用（Direct Reference）：直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的，如果有了直接引用，那么引用的目标必定已经在内存中存在。</p><h3 id="3-初始化"><a href="#3-初始化" class="headerlink" title="3 . 初始化"></a>3 . 初始化</h3><p>初始化，为类的静态变量赋予正确的初始值，JVM负责对类进行初始化，主要对类变量进行初始化。这个阶段会对static变量赋值，public static int value=123; 在准备阶段value初始值为0 。在这个阶段就会被赋值为123。此外还会执行类的静态代码块 。</p><p>Java虚拟机规范中严格规定了<strong>有且只有六种情况必须对类进行初始化</strong>：</p><p>– 创建类的实例，也就是new的方式</p><p>– 访问某个类或接口的静态变量，或者对该静态变量赋值</p><p>– 调用类的静态方法</p><p>– 反射（如Class.forName(“com.lsj.Car”)）</p><p>– 初始化某个类的子类，则其父类也会被初始化</p><p>– Java虚拟机启动时被标明为启动类的类（也就是包含main函数），虚拟机会首先初始化这个类</p><h3 id="4-卸载"><a href="#4-卸载" class="headerlink" title="4 . 卸载"></a>4 . 卸载</h3><p>​    类的生命周期和Class对象是否被引用有关，当代表类的Class对象不再被引用时，Class对象就会结束生命周期，类在方法区内的数据也会被卸载。因此，<strong>一个类何时结束生命周期，取决于代表它的Class对象何时结束生命周期</strong>。由Java虚拟机自带的类加载器所加载的类，在虚拟机的生命周期中，始终不会被卸载，而用户自定义的类加载器是可以被卸载的</p><h2 id="二-类加载流程"><a href="#二-类加载流程" class="headerlink" title="二 . 类加载流程"></a>二 . 类加载流程</h2><p>​    JVM的类加载机制采用的是双亲委派模型：当某个类需要被加载时，它自己的类加载器首先不会自己去加载，而是把这个工作委托自己的父加载器，直到最顶层的类加载器也无法加载此类时，才会尝试自己去加载此类。双亲委派模型如下图所示：</p><p><img src="/2018/06/02/jvm-de-lei-jia-zai/classLoader_1.png" alt></p><p>先来看一个例子：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        ClassLoader loader <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><pre><code>sun.misc.Launcher$AppClassLoader@18b4aac2sun.misc.Launcher$ExtClassLoader@1540e19dnull</code></pre><p>首先说明一下三个类加载器的作用</p><p><strong>Bootstrap ClassLoader</strong> ：</p><p>​    启动类加载器主要加载核心类库，加载的是%JAVA_HOME%\jre\lib下的jar包，采用native code实现，是JVM的一部分，底层由C++实现，源码在 JVM 的内核中，当 JVM 启动后，随之会启动Bootstrap ClassLoader。无法被java代码直接引用。在 JVM 启动时指定-Xbootclasspath来改变Bootstrap ClassLoader加载目录</p><p><strong>Extention ClassLoader</strong>：</p><p>​    扩展类加载器加载目录%JAVA_HOME%\jre\lib\ext目录下的jar包,可通过-D java.ext.dirs属性改变加载目录</p><p><strong>Application ClassLoader</strong>：</p><p>​    加载应用程序中classpath里指定的所有类</p><p>​    从运行结果可以看出加载Test类的类加载器是AppClassLoader，它的父加载器是ExtClassLoader，但是ExtClassLoader父加载器却不是Bootstrap ClassLoader，此外不要被这种父子关系误导，查看AppClassLoader和ExtClassLoader的源码时，你会发他们几个根本没有继承关系，也就是说应用类加载器AppClassLoader不是通过extend关键字继承ExtClassLoader，为什么AppClassLoader的getParent()方法得到的是ExtClassLoader呢？它们两个到底又是什么关系？这还得从源码中寻找答案</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> URLStreamHandlerFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Launcher<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Launcher launcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Launcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String bootClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"sun.boot.class.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> ClassLoader loader<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> URLStreamHandler fileHandler<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Launcher <span class="token function">getLauncher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> launcher<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Launcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Launcher<span class="token punctuation">.</span>ExtClassLoader var1<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            var1 <span class="token operator">=</span> Launcher<span class="token punctuation">.</span>ExtClassLoader<span class="token punctuation">.</span><span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">"Could not create extension class loader"</span><span class="token punctuation">,</span> var10<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>loader <span class="token operator">=</span> Launcher<span class="token punctuation">.</span>AppClassLoader<span class="token punctuation">.</span><span class="token function">getAppClassLoader</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">"Could not create application class loader"</span><span class="token punctuation">,</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExtClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AppClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></code></pre><p>​    首先得从这个类开始，为了方面阅读，省略了部分代码，从源码可以看出ExtClassLoader和AppClassLoader是以静态内部类的形式声明的。而Launcher是创建类加载器的启动类。从Launcher构造函数中可以看出，首先会创建ExtClassLoader，然后会创建AppClassLoader，然后将AppClassLoader设置为线程上下文类加载器。这里我需要关注的是上面代码的21行，this.loader = Launcher.AppClassLoader.getAppClassLoader(var1)；这行代码的getAppClassLoader方法是创建AppClassLoader，同时将var1作为参数传了进去。通过代码发现var1其实就是前面创建的ExtClassLoader。那么就得看看getAppClassLoader方法做了什么事情了。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AppClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> URLClassPath ucp <span class="token operator">=</span> SharedSecrets<span class="token punctuation">.</span><span class="token function">getJavaNetAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURLClassPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> ClassLoader <span class="token function">getAppClassLoader</span><span class="token punctuation">(</span><span class="token keyword">final</span> ClassLoader var0<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>            <span class="token keyword">final</span> String var1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.class.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> var1 <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> Launcher<span class="token punctuation">.</span><span class="token function">getClassPath</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>ClassLoader<span class="token punctuation">)</span>AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token operator">&lt;</span>Launcher<span class="token punctuation">.</span>AppClassLoader<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> Launcher<span class="token punctuation">.</span>AppClassLoader <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    URL<span class="token punctuation">[</span><span class="token punctuation">]</span> var1x <span class="token operator">=</span> var1 <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> Launcher<span class="token punctuation">.</span><span class="token function">pathToURLs</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Launcher<span class="token punctuation">.</span>AppClassLoader</span><span class="token punctuation">(</span>var1x<span class="token punctuation">,</span> var0<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">AppClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> var1<span class="token punctuation">,</span> ClassLoader var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> Launcher<span class="token punctuation">.</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>ucp<span class="token punctuation">.</span><span class="token function">initLookupCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java">  <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExtClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> Launcher<span class="token punctuation">.</span>ExtClassLoader <span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>            <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> var0 <span class="token operator">=</span> <span class="token function">getExtDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span>Launcher<span class="token punctuation">.</span>ExtClassLoader<span class="token punctuation">)</span>AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token operator">&lt;</span>Launcher<span class="token punctuation">.</span>ExtClassLoader<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">public</span> Launcher<span class="token punctuation">.</span>ExtClassLoader <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>                        <span class="token keyword">int</span> var1 <span class="token operator">=</span> var0<span class="token punctuation">.</span>length<span class="token punctuation">;</span>                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var2 <span class="token operator">&lt;</span> var1<span class="token punctuation">;</span> <span class="token operator">++</span>var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            MetaIndex<span class="token punctuation">.</span><span class="token function">registerDirectory</span><span class="token punctuation">(</span>var0<span class="token punctuation">[</span>var2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Launcher<span class="token punctuation">.</span>ExtClassLoader</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token punctuation">(</span>IOException<span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token function">ExtClassLoader</span><span class="token punctuation">(</span>File<span class="token punctuation">[</span><span class="token punctuation">]</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">getExtURLs</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ClassLoader<span class="token punctuation">)</span>null<span class="token punctuation">,</span> Launcher<span class="token punctuation">.</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>            SharedSecrets<span class="token punctuation">.</span><span class="token function">getJavaNetAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURLClassPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initLookupCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token punctuation">}</span></code></pre><p>​    上面是AppClassLoader和ExtClassLoader类的源码，在这两个类中并没有getParent()方法，这个先放一边。我们继续关注AppClassLoader的getAppClassLoader方法，在这个方法中唯一的的参数就是var0，而这个var0就是传进来的ExtClassLoader，最后这个传给了AppClassLoader的构造方法。而在构造方法中又传给了父类的构造方法中。而ExtClassLoader的构造方法中也是调用父类的构造方法，但与AppClassLoader调用父类构造方法不同的是，它的第二个参数传的是null。接下来继续看父类的源码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">URLClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">SecureClassLoader</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* The search path for classes and resources */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> URLClassPath ucp<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* The context to be used when loading classes and resources */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> AccessControlContext acc<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">URLClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">,</span>                          URLStreamHandlerFactory factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// this is to make the stack depth consistent with 1.1</span>        SecurityManager security <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            security<span class="token punctuation">.</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        acc <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ucp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLClassPath</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>在AppClassLoader构造方法中super(var1, var2, Launcher.factory);调用的是父类的构造，如上代码，在这个构造中，parent参数又传给了父类，继续刨根问底，看看SecureClassLoader的源码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecureClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/*     * If initialization succeed this is set to true and security checks will     * succeed. Otherwise the object is not initialized and the object is     * useless.     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> initialized<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token function">SecureClassLoader</span><span class="token punctuation">(</span>ClassLoader parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// this is to make the stack depth consistent with 1.1</span>        SecurityManager security <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            security<span class="token punctuation">.</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></code></pre><p>SecureClassLoader的构造函数中parent参数继续传给了父类。再来看看SecureClassLoader的父类ClassLoader的源码</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// The parent class loader for delegation</span>    <span class="token comment" spellcheck="true">// Note: VM hardcoded the offset of this field, thus all new fields</span>    <span class="token comment" spellcheck="true">// must be added *after* it.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ClassLoader parent<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">ClassLoader</span><span class="token punctuation">(</span>Void unused<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ParallelLoaders<span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            parallelLockMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            domains <span class="token operator">=</span>                Collections<span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>ProtectionDomain<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            assertionLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// no finer-grained lock; lock on the classloader instance</span>            parallelLockMap <span class="token operator">=</span> null<span class="token punctuation">;</span>            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            domains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            assertionLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token function">ClassLoader</span><span class="token punctuation">(</span>ClassLoader parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token function">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@CallerSensitive</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ClassLoader <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> null<span class="token punctuation">)</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        SecurityManager sm <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Check access to the parent class loader</span>            <span class="token comment" spellcheck="true">// If the caller's class loader is same as this class loader,</span>            <span class="token comment" spellcheck="true">// permission check is performed.</span>            <span class="token function">checkClassLoaderPermission</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> Reflection<span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> parent<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>通过源码可以发现ClassLoader中有三个构造函数其中两个protected修饰，而另外一个是private修饰的私有构造方法，是在SecureClassLoader的构造函数中的super(parent);代码调用的是ClassLoader的protected的有参构造方法，而在这个方法中调用了私有构造方法，在私有构造方法中，一路从传过来的parent变量被赋值给了一个静态常量。而且getParent()也在这个类中，这个方法返回的就是parent常量。</p><p>​    到这里一切都明白了，当它的子类调用getParent()方法时，实际上返回的是这个parent常量，这个常量是子类构造方法中传进来的。而Launcher创建类加载器时，先创建了ExtClassLoader，这个类的构造函数中parent属性传的是null，因此它调用getParent()得到的是null，创建AppClassLoader，这个类的构造是把ExtClassLoader作为parent属性传给父类，因此它调用getParent()得到的是ExtClassLoader。这几个类的类图如下</p><p>​    <img src="/2018/06/02/jvm-de-lei-jia-zai/classloaderextend.png" alt></p><p>那Bootstrap ClassLoader和ExtClassLoader又是什么关系呢，我们来看一下双亲委派模型的源码</p><pre class=" language-java"><code class="language-java">   <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>        <span class="token keyword">throws</span> ClassNotFoundException    <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// First, check if the class has already been loaded</span>            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">long</span> t0 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// ClassNotFoundException thrown if class not found</span>                    <span class="token comment" spellcheck="true">// from the non-null parent class loader</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// If still not found, then invoke findClass in order</span>                    <span class="token comment" spellcheck="true">// to find the class.</span>                    <span class="token keyword">long</span> t1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// this is the defining class loader; record the stats</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> c<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>这个方法在ClassLoader类中，因此parent就是子加载器创建时指定的父加载器。通过这段核心代码。很容易就能明白了双亲委派的类加载流程。首先通过parent去加载Class，如果parent为null，则由Bootstrap ClassLoader去加载Class。</p><h2 id="三-自定义类加载器"><a href="#三-自定义类加载器" class="headerlink" title="三 . 自定义类加载器"></a>三 . 自定义类加载器</h2><p>​    jdk自带的三大类加载器都是加载特定目录下的资源文件。但有时我们有些特定的需求，比如我想从某个特定的磁盘或者是网络上加载.class文件，为了安全考虑还会对.class文件加密，然后再解密加载进 JVM 中。要想做到这些，只有自定义ClassLoader了。自定义类加载器三步曲</p><ol><li>继承ClassLoader抽象类。</li><li>重写findClass() 方法。</li><li>在 findClass() 方法中调用 defineClass() 。</li></ol><p>说明： findClass()方法中通过IO找到.class文件， findClass()会把.class文件二进制内容转换成Class对象。自定义的ClassLoader如果不指定parent，那么默认parent就是AppClassLoader。</p><p>下面来看一个例子，编写一个测试类，生成.class文件，并把.class文件放在 E:\test 目录下（这里我写了两个）</p><p>Car测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lsj<span class="token punctuation">.</span>test<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2018/4/22 18:36 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//静态变量</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String str<span class="token operator">=</span> <span class="token string">"666"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//静态常量</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String str1<span class="token operator">=</span> <span class="token string">"666"</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"类初始化"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"时速300码!!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Person测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lsj<span class="token punctuation">.</span>test<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2018/5/2 22:52 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello Word!!!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>然后编写自定义的类加载器，代码如下：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String filePath<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyClassLoader</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{</span>        filePath <span class="token operator">=</span> path<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">findClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            FileInputStream is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>            ByteArrayOutputStream bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> len <span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> is<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最后编写测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        MyClassLoader diskLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token string">"F:\\test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//加载class文件</span>            Class <span class="token class-name">c</span> <span class="token operator">=</span> diskLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.lsj.test.Car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Class <span class="token class-name">p</span> <span class="token operator">=</span> diskLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.lsj.test.Person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                Object obj1 <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//强转成Car对象</span>                Car car <span class="token operator">=</span> <span class="token punctuation">(</span>Car<span class="token punctuation">)</span> obj1<span class="token punctuation">;</span>                car<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//强转成Person对象</span>                Object obj2 <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Person person <span class="token operator">=</span> <span class="token punctuation">(</span>Person<span class="token punctuation">)</span> obj2<span class="token punctuation">;</span>                person<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最后的测试结果如下：</p><pre><code>类初始化时速300码!!!!!!Hello Word!!!!!!!</code></pre><p>在测试类中分别调用了Car的 run() 方法和Person的 say() 方法，执行结果和预期一样。这里需要注意的是在调用ClassLoder的loadClass方法时，需要指定类的全包路径。</p><p>​    刚刚说道可以把class文件加密后再在代码中解密在进行加载。首先需要编写一个加密的工具类，这里我用的就是最简单的异或，我们都知道一个数字经过两次异或后得到的结果就是它自己。加密工具类代码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lsj<span class="token punctuation">.</span>classloader<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @Auther: Lushunjian * @Date: 2018/5/2 23:15 * @Description: */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EncryptFileUtil</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span><span class="token punctuation">{</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            FileInputStream fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> b1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//每一个byte异或一个数字4</span>                fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b <span class="token operator">^</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这里我把class文件经过异或加密后生成了.txt文件。在加载时，先把文件解密，在进行类加载。下面是自定义解密的ClassLoader类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoaderCode</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String filePath<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyClassLoaderCode</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{</span>        filePath <span class="token operator">=</span> path<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">findClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            FileInputStream is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>            ByteArrayOutputStream bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> len <span class="token punctuation">;</span>            <span class="token keyword">byte</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> is<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//解密</span>                b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>len <span class="token operator">^</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>然后是测试类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        MyClassLoader diskLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token string">"F:\\test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        MyClassLoaderCode diskLoaderCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClassLoaderCode</span><span class="token punctuation">(</span><span class="token string">"F:\\test\\Car.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//加载class文件</span>            Class <span class="token class-name">c</span> <span class="token operator">=</span> diskLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.lsj.classloader.Car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Class <span class="token class-name">cs</span> <span class="token operator">=</span> diskLoaderCode<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.lsj.classloader.Car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Class <span class="token class-name">p</span> <span class="token operator">=</span> diskLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.lsj.classloader.Person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class文件加载成对象"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//强转成Car对象</span>                Object obj1 <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Car car <span class="token operator">=</span> <span class="token punctuation">(</span>Car<span class="token punctuation">)</span> obj1<span class="token punctuation">;</span>                car<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//强转成Person对象</span>                Object obj2 <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Person person <span class="token operator">=</span> <span class="token punctuation">(</span>Person<span class="token punctuation">)</span> obj2<span class="token punctuation">;</span>                person<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//强转成Car对象</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"经过加密的class文件加载对象"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Object objs <span class="token operator">=</span> cs<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Car cars <span class="token operator">=</span> <span class="token punctuation">(</span>Car<span class="token punctuation">)</span> objs<span class="token punctuation">;</span>                cars<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>得到的结果</p><pre><code>class文件加载成对象类初始化时速300码!!!!!!Hello Word!!!!!!!经过加密的class文件加载对象时速300码!!!!!!</code></pre>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
